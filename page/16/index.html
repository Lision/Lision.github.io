<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>èŠå®…</title>
  <meta name="description" content="ç¾éº—çš„å¤ªé™½ç…§å¸¸å‡èµ· è‹¦ç—›çš„äººå€‘ä¾èˆŠæ­‡æ–¯åº•è£" />
  <meta name="keywords" content="ios,objective-c,swift,python,javascript,otaku,lision" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="æ•²ä»£ç çš„ï¼Œæ¯”è¾ƒå®…çš„å†…ç§">
<meta property="og:type" content="website">
<meta property="og:title" content="èŠå®…">
<meta property="og:url" content="https://lision.me/page/16/index.html">
<meta property="og:site_name" content="èŠå®…">
<meta property="og:description" content="æ•²ä»£ç çš„ï¼Œæ¯”è¾ƒå®…çš„å†…ç§">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Lision">
<meta property="article:tag" content="ios,objective-c,swift,python,javascript,otaku,lision">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  

	<script src="https://use.typekit.net/eyf3hir.js"></script>
  <script>try{Typekit.load({ async: false });}catch(e){}</script>
  
<link rel="stylesheet" href="/style.css">

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
  
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=" + "UA-118743071-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-118743071-1');
</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>

  <script>setLoadingBarProgress(20)</script>
  
  <div id="site-wrapper">
    
    <header id="header">
	<div id="header-wrapper" class="clearfix">
		<a id="logo" href="/">
			<img src="/images/logo.png" />
			<span id="site-desc">
			  otaku's self-cultivation
      </span>
		</a>
		<button id="site-nav-switch">
	    <span class="icon icon-menu"></span>
	  </button>
	</div>
	<aside id="site-menu">
  	<nav>
  		
        <a href="/" class="nav-home nav">
          é¦–é¡µ
        </a>
      
        <a href="/archives" class="nav-archives nav">
          å½’æ¡£
        </a>
      
        <a target="_blank" rel="noopener" href="https://github.com/Lision" class="nav-about nav">
          å…³äº
        </a>
      
    </nav>
	</aside>
</header>
    <script>setLoadingBarProgress(40);</script>
    
    <main id="main" role="main">
      





<section class="post-list">
	
    <article class="post ">

  
  <h2 class="title">
    <a href="/yymodel0x02/">
      æ­ç§˜ YYModel çš„é­”æ³• 0x02
    </a>
  </h2>
  
  <time>
    11æœˆ 19, 2017
  </time>
  <section class="content">
	  <img src="/yymodel0x02/design_model_0x02.jpg" class="">
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨ä¸Šæ–‡<a href="https://lision.me/yymodel_x01/">ã€Šæ­ç§˜ YYModel çš„é­”æ³•ï¼ˆä¸Šï¼‰ã€‹</a> ä¸­ä¸»è¦å‰–æäº† <a target="_blank" rel="noopener" href="https://github.com/ibireme/YYModel">YYModel</a> çš„æºç ç»“æ„ï¼Œå¹¶ä¸”åˆ†äº«äº† YYClassInfo ä¸ NSObject+YYModel å†…éƒ¨æœ‰è¶£çš„å®ç°ç»†èŠ‚ã€‚</p>
<p>ç´§æ¥ä¸Šç¯‡ï¼Œæœ¬æ–‡å°†è§£è¯» YYModel å…³äº JSON æ¨¡å‹è½¬æ¢çš„æºç ï¼Œæ—¨åœ¨æ­ç§˜ JSON æ¨¡å‹è‡ªåŠ¨è½¬æ¢é­”æ³•ã€‚</p>
<h2 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h2><ul>
<li>JSON ä¸ Model ç›¸äº’è½¬æ¢</li>
<li>æ€»ç»“</li>
</ul>
<h2 id="JSON-ä¸-Model-ç›¸äº’è½¬æ¢"><a href="#JSON-ä¸-Model-ç›¸äº’è½¬æ¢" class="headerlink" title="JSON ä¸ Model ç›¸äº’è½¬æ¢"></a>JSON ä¸ Model ç›¸äº’è½¬æ¢</h2><p>JSON(JavaScript Object Notation) æ˜¯ä¸€ç§è½»é‡çº§çš„æ•°æ®äº¤æ¢æ ¼å¼ï¼Œå®ƒæ˜“äºäººä»¬é˜…è¯»å’Œç¼–å†™ï¼ŒåŒæ—¶ä¹Ÿæ˜“äºæœºå™¨è§£æå’Œç”Ÿæˆã€‚å®ƒæ˜¯åŸºäº <a target="_blank" rel="noopener" href="http://www.crockford.com/javascript/">JavaScript Programming Language</a>, <a target="_blank" rel="noopener" href="http://www.ecma-international.org/publications/files/ECMA-ST/Ecma-262.pdf">Standard ECMA-262 3rd Edition - December 1999</a> çš„ä¸€ä¸ªå­é›†ã€‚JSON é‡‡ç”¨å®Œå…¨ç‹¬ç«‹äºè¯­è¨€çš„æ–‡æœ¬æ ¼å¼ï¼Œä½†æ˜¯ä¹Ÿä½¿ç”¨äº†ç±»ä¼¼äº C è¯­è¨€å®¶æ—çš„ä¹ æƒ¯ï¼ˆåŒ…æ‹¬C, C++, C#, Java, JavaScript, Perl, Pythonç­‰ï¼‰ã€‚è¿™äº›ç‰¹æ€§ä½¿ JSON æˆä¸ºç†æƒ³çš„æ•°æ®äº¤æ¢è¯­è¨€ï¼Œç‚¹å‡» <a target="_blank" rel="noopener" href="https://www.json.org/json-zh.html">è¿™é‡Œ</a> äº†è§£æ›´å¤šå…³äº JSON çš„ä¿¡æ¯ã€‚</p>
<p>Model æ˜¯ <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1">é¢å‘å¯¹è±¡ç¼–ç¨‹</a>ï¼ˆObject Oriented Programmingï¼Œç®€ç§° OOPï¼‰ç¨‹åºè®¾è®¡æ€æƒ³ä¸­çš„å¯¹è±¡ï¼ŒOOP æŠŠå¯¹è±¡ä½œä¸ºç¨‹åºçš„åŸºæœ¬å•å…ƒï¼Œä¸€ä¸ªå¯¹è±¡åŒ…å«äº†æ•°æ®å’Œæ“ä½œæ•°æ®çš„å‡½æ•°ã€‚ä¸€èˆ¬æˆ‘ä»¬ä¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚æ¥åˆ›å»ºå¯¹è±¡ï¼Œåœ¨ä¸€äº›è®¾è®¡æ¨¡å¼ä¸­ï¼ˆå¦‚ MVC ç­‰ï¼‰å¯¹è±¡ä¸€èˆ¬ä½œä¸ºæ¨¡å‹ï¼ˆModelï¼‰ï¼Œå³å¯¹è±¡å»ºæ¨¡ã€‚</p>
<p>JSON ä¸ Model ç›¸äº’è½¬æ¢æŒ‰è½¬æ¢æ–¹å‘åˆ†ä¸ºä¸¤ç§ï¼š</p>
<ul>
<li>JSON to Model</li>
<li>Model to JSON</li>
</ul>
<img src="/yymodel0x02/switch.jpg" class="">
<h3 id="JSON-to-Model"><a href="#JSON-to-Model" class="headerlink" title="JSON to Model"></a>JSON to Model</h3><p>æˆ‘ä»¬ä» YYModel çš„æ¥å£å¼€å§‹è§£è¯»ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)yy_modelWithJSON:(<span class="type">id</span>)json &#123;</span><br><span class="line">    <span class="comment">// å°† json è½¬ä¸ºå­—å…¸ dic</span></span><br><span class="line">    <span class="built_in">NSDictionary</span> *dic = [<span class="keyword">self</span> _yy_dictionaryWithJSON:json];</span><br><span class="line">    <span class="comment">// å†é€šè¿‡ dic å¾—åˆ° model å¹¶è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> yy_modelWithDictionary:dic];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æ¥å£æŠŠ JSON è½¬ Model å¾ˆç®€å•çš„åˆ†ä¸ºäº†ä¸¤ä¸ªå­ä»»åŠ¡ï¼š</p>
<ul>
<li>JSON to NSDictionary</li>
<li>NSDictionary to Model</li>
</ul>
<img src="/yymodel0x02/j2d2m.jpg" class="">
<h4 id="JSON-to-NSDictionary"><a href="#JSON-to-NSDictionary" class="headerlink" title="JSON to NSDictionary"></a>JSON to NSDictionary</h4><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ <code>_yy_dictionaryWithJSON</code> æ˜¯æ€ä¹ˆå°† json è½¬ä¸º NSDictionary çš„ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSDictionary</span> *)_yy_dictionaryWithJSON:(<span class="type">id</span>)json &#123;</span><br><span class="line">    <span class="comment">// å…¥å‚åˆ¤ç©º</span></span><br><span class="line">    <span class="keyword">if</span> (!json || json == (<span class="type">id</span>)kCFNull) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSDictionary</span> *dic = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSData</span> *jsonData = <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// æ ¹æ® json çš„ç±»å‹å¯¹åº”æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> ([json isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯ NSDictionary ç±»åˆ™ç›´æ¥èµ‹å€¼</span></span><br><span class="line">        dic = json;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([json isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯ NSString ç±»åˆ™ç”¨ UTF-8 ç¼–ç è½¬ NSData</span></span><br><span class="line">        jsonData = [(<span class="built_in">NSString</span> *)json dataUsingEncoding : <span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([json isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯ NSData åˆ™ç›´æ¥èµ‹å€¼ç»™ jsonData</span></span><br><span class="line">        jsonData = json;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// jsonData ä¸ä¸º nilï¼Œåˆ™è¡¨ç¤ºä¸Šé¢çš„ 2ã€3 æƒ…å†µä¸­çš„ä¸€ç§</span></span><br><span class="line">    <span class="keyword">if</span> (jsonData) &#123;</span><br><span class="line">        <span class="comment">// åˆ©ç”¨ NSJSONSerialization æ–¹æ³•å°† jsonData è½¬ä¸º dic</span></span><br><span class="line">        dic = [<span class="built_in">NSJSONSerialization</span> JSONObjectWithData:jsonData options:kNilOptions error:<span class="literal">NULL</span>];</span><br><span class="line">        <span class="comment">// åˆ¤æ–­è½¬æ¢ç»“æœ </span></span><br><span class="line">        <span class="keyword">if</span> (![dic isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) dic = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> dic;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯æ ¹æ®å…¥å‚çš„ç±»å‹åˆ¤æ–­å¦‚ä½•å°†å…¶è½¬ä¸º NSDictionary ç±»å‹å¹¶è¿”å›ã€‚</p>
<p>å…¶ä¸­ <code>kCFNull</code> æ˜¯ CoreFoundation ä¸­ CFNull çš„å•ä¾‹å¯¹è±¡ã€‚å¦‚åŒ Foundation æ¡†æ¶ä¸­çš„ NSNull ä¸€æ ·ï¼ŒCFNull æ˜¯ç”¨æ¥è¡¨ç¤ºé›†åˆå¯¹è±¡ä¸­çš„ç©ºå€¼ï¼ˆä¸å…è®¸ä¸º NULLï¼‰ã€‚CFNull å¯¹è±¡æ—¢ä¸å…è®¸è¢«åˆ›å»ºä¹Ÿä¸å…è®¸è¢«é”€æ¯ï¼Œè€Œæ˜¯é€šè¿‡å®šä¹‰ä¸€ä¸ª CFNull å¸¸é‡ï¼Œå³ <code>kCFNull</code>ï¼Œåœ¨éœ€è¦ç©ºå€¼æ—¶ä½¿ç”¨ã€‚</p>
<blockquote>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<br>The CFNull opaque type defines a unique object used to represent null values in collection objects (which donâ€™t allow NULL values). CFNull objects are neither created nor destroyed. Instead, a single CFNull constant objectâ€”<a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/corefoundation/kcfnull">kCFNull</a>â€”is defined and is used wherever a null value is needed.</p>
</blockquote>
<p>NSJSONSerialization æ˜¯ç”¨äºå°† JSON å’Œç­‰æ•ˆçš„ Foundation å¯¹è±¡ä¹‹é—´ç›¸äº’è½¬æ¢çš„å¯¹è±¡ã€‚å®ƒåœ¨ iOS 7 ä»¥åŠ macOS 10.9ï¼ˆåŒ…å« iOS 7 å’Œ macOS 10.9ï¼‰ä¹‹åæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>ä»£ç ä¸­å°† NSString è½¬ä¸º NSData ç”¨åˆ°äº† NSUTF8StringEncodingï¼Œå…¶ä¸­ç¼–ç ç±»å‹å¿…é¡»å±äº JSON è§„èŒƒä¸­åˆ—å‡ºçš„ 5 ç§æ”¯æŒçš„ç¼–ç ç±»å‹ï¼š</p>
<ul>
<li>UTF-8</li>
<li>UTF-16LE</li>
<li>UTF-16BE</li>
<li>UTF-32LE</li>
<li>UTF-32BE</li>
</ul>
<p>è€Œç”¨äºè§£æçš„æœ€é«˜æ•ˆçš„ç¼–ç æ˜¯ UTF-8 ç¼–ç ï¼Œæ‰€ä»¥ä½œè€…è¿™é‡Œä½¿ç”¨ NSUTF8StringEncodingã€‚</p>
<blockquote>
<p>å®˜æ–¹æ³¨é‡Šï¼š<br>The data must be in one of the 5 supported encodings listed in the JSON specification: UTF-8, UTF-16LE, UTF-16BE, UTF-32LE, UTF-32BE. The data may or may not have a BOM. The most efficient encoding to use for parsing is UTF-8, so if you have a choice in encoding the data passed to this method, use UTF-8.</p>
</blockquote>
<h4 id="NSDictionary-to-Model"><a href="#NSDictionary-to-Model" class="headerlink" title="NSDictionary to Model"></a>NSDictionary to Model</h4><p>ç°åœ¨æˆ‘ä»¬è¦ä» <code>yy_modelWithJSON</code> æ¥å£ä¸­æ¢ç©¶ <code>yy_modelWithDictionary</code> æ˜¯å¦‚ä½•å°† NSDictionary è½¬ä¸º Model çš„ã€‚</p>
<p>æ•²é»‘æ¿ï¼åšå¥½å‡†å¤‡ï¼Œè¿™ä¸€å°èŠ‚ä»‹ç»çš„ä»£ç æ˜¯ YYModel çš„ç²¾åå“¦~ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)yy_modelWithDictionary:(<span class="built_in">NSDictionary</span> *)dictionary &#123;</span><br><span class="line">    <span class="comment">// å…¥å‚æ ¡éªŒ</span></span><br><span class="line">    <span class="keyword">if</span> (!dictionary || dictionary == (<span class="type">id</span>)kCFNull) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (![dictionary isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä½¿ç”¨å½“å‰ç±»ç”Ÿæˆä¸€ä¸ª _YYModelMeta æ¨¡å‹å…ƒç±»</span></span><br><span class="line">    Class cls = [<span class="keyword">self</span> <span class="keyword">class</span>];</span><br><span class="line">    _YYModelMeta *modelMeta = [_YYModelMeta metaWithClass:cls];</span><br><span class="line">    <span class="comment">// è¿™é‡Œ _hasCustomClassFromDictionary ç”¨äºæ ‡è¯†æ˜¯å¦éœ€è¦è‡ªå®šä¹‰è¿”å›ç±»</span></span><br><span class="line">    <span class="comment">// å±äºæ¨¡å‹è½¬æ¢é™„åŠ åŠŸèƒ½ï¼Œå¯ä»¥ä¸ç”¨æŠ•å…¥å¤ªå¤šå…³æ³¨</span></span><br><span class="line">    <span class="keyword">if</span> (modelMeta-&gt;_hasCustomClassFromDictionary) &#123;</span><br><span class="line">        cls = [cls modelCustomClassForDictionary:dictionary] ?: cls;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è°ƒç”¨ yy_modelSetWithDictionary ä¸ºæ–°å»ºçš„ç±»å®ä¾‹ one èµ‹å€¼ï¼Œèµ‹å€¼æˆåŠŸåˆ™è¿”å› one</span></span><br><span class="line">    <span class="built_in">NSObject</span> *one = [cls new];</span><br><span class="line">    <span class="comment">// æ‰€ä»¥è¿™ä¸ªå‡½æ•°ä¸­æˆ‘ä»¬åº”è¯¥æŠŠæ³¨æ„åŠ›é›†ä¸­åœ¨ yy_modelSetWithDictionary</span></span><br><span class="line">    <span class="keyword">if</span> ([one yy_modelSetWithDictionary:dictionary]) <span class="keyword">return</span> one;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç ä¸­æ ¹æ® <code>_hasCustomClassFromDictionary</code> æ ‡è¯†åˆ¤æ–­æ˜¯å¦éœ€è¦è‡ªå®šä¹‰è¿”å›æ¨¡å‹çš„ç±»å‹ã€‚è¿™æ®µä»£ç å±äº YYModel çš„é™„åŠ åŠŸèƒ½ï¼Œä¸ºäº†ä¸ä½¿å¤§å®¶åˆ†å¿ƒï¼Œè¿™é‡Œä»…åšç®€å•ä»‹ç»ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬è¦åœ¨ JSON è½¬ Model çš„è¿‡ç¨‹ä¸­æ ¹æ®æƒ…å†µåˆ›å»ºä¸åŒç±»å‹çš„å®ä¾‹ï¼Œåˆ™å¯ä»¥åœ¨ Model ä¸­å®ç°æ¥å£ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">nullable</span> Class)modelCustomClassForDictionary:(<span class="built_in">NSDictionary</span> *)dictionary;</span><br></pre></td></tr></table></figure>
<p>æ¥æ»¡è¶³éœ€æ±‚ã€‚å½“æ¨¡å‹å…ƒåˆå§‹åŒ–æ—¶ä¼šæ£€æµ‹å½“å‰æ¨¡å‹ç±»æ˜¯å¦å¯ä»¥å“åº”ä¸Šé¢çš„æ¥å£ï¼Œå¦‚æœå¯ä»¥å“åº”åˆ™ä¼šæŠŠ <code>_hasCustomClassFromDictionary</code> æ ‡è¯†ä¸º YESï¼Œæ‰€ä»¥ä¸Šé¢æ‰ä¼šå‡ºç°è¿™äº›ä»£ç ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (modelMeta-&gt;_hasCustomClassFromDictionary) &#123;</span><br><span class="line">    cls = [cls modelCustomClassForDictionary:dictionary] ?: cls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å˜›~ æˆ‘è§‰å¾—è¿™äº›é™„åŠ çš„ä¸œè¥¿åœ¨é˜…è¯»æºç æ—¶å¾ˆå¤§ç¨‹åº¦ä¸Šä¼šåˆ†æ•£æˆ‘ä»¬çš„æ³¨æ„åŠ›ï¼Œè¿™æ¬¡å…ˆè¯¦ç»†çš„è®²è§£ä¸€ä¸‹ï¼Œä»¥åé‡åˆ°ç±»ä¼¼çš„ä»£ç æˆ‘ä»¬ä¼šç•¥è¿‡ï¼Œå†…éƒ¨çš„å®ç°å¤§éƒ½ä¸ä¸Šè¿°æ¡ˆä¾‹åŸç†ç›¸åŒï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±ç ”ç©¶å“ˆã€‚</p>
<p>æˆ‘ä»¬åº”è¯¥æŠŠæ³¨æ„åŠ›é›†ä¸­åœ¨ <code>yy_modelSetWithDictionary</code> ä¸Šï¼Œè¿™ä¸ªå‡½æ•°ï¼ˆå…¶å®ä¹Ÿæ˜¯ NSObject+YYModel æš´éœ²çš„æ¥å£ï¼‰æ˜¯æ ¹æ®å­—å…¸åˆå§‹åŒ–æ¨¡å‹çš„å®ç°æ–¹æ³•ã€‚å®ƒçš„ä»£ç æ¯”è¾ƒé•¿ï¼Œå¦‚æœä¸æƒ³çœ‹å¯ä»¥è·³è¿‡ï¼Œåœ¨åé¢æœ‰è§£é‡Šã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)yy_modelSetWithDictionary:(<span class="built_in">NSDictionary</span> *)dic &#123;</span><br><span class="line">    <span class="comment">// å…¥å‚æ ¡éªŒ</span></span><br><span class="line">    <span class="keyword">if</span> (!dic || dic == (<span class="type">id</span>)kCFNull) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">if</span> (![dic isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¹æ®è‡ªèº«ç±»ç”Ÿæˆ _YYModelMeta æ¨¡å‹å…ƒç±»</span></span><br><span class="line">    _YYModelMeta *modelMeta = [_YYModelMeta metaWithClass:object_getClass(<span class="keyword">self</span>)];</span><br><span class="line">    <span class="comment">// å¦‚æœæ¨¡å‹å…ƒç±»é”®å€¼æ˜ å°„æ•°é‡ä¸º 0 åˆ™ return NOï¼Œè¡¨ç¤ºæ„å»ºå¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (modelMeta-&gt;_keyMappedCount == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¿½ç•¥ï¼Œè¯¥æ ‡è¯†å¯¹åº” modelCustomWillTransformFromDictionary æ¥å£</span></span><br><span class="line">    <span class="keyword">if</span> (modelMeta-&gt;_hasCustomWillTransformFromDictionary) &#123;</span><br><span class="line">        <span class="comment">// è¯¥æ¥å£ç±»ä¼¼ modelCustomTransformFromDictionary æ¥å£ï¼Œä¸è¿‡æ˜¯åœ¨æ¨¡å‹è½¬æ¢ä¹‹å‰è°ƒç”¨çš„</span></span><br><span class="line">        dic = [((<span class="type">id</span>&lt;YYModel&gt;)<span class="keyword">self</span>) modelCustomWillTransformFromDictionary:dic];</span><br><span class="line">        <span class="keyword">if</span> (![dic isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ¨¡å‹è®¾ç½®ä¸Šä¸‹æ–‡ ModelSetContext</span></span><br><span class="line">    ModelSetContext context = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    context.modelMeta = (__bridge <span class="type">void</span> *)(modelMeta);</span><br><span class="line">    context.model = (__bridge <span class="type">void</span> *)(<span class="keyword">self</span>);</span><br><span class="line">    context.dictionary = (__bridge <span class="type">void</span> *)(dic);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ¨¡å‹å…ƒé”®å€¼æ˜ å°„æ•°é‡ä¸ JSON æ‰€å¾—å­—å…¸çš„æ•°é‡å…³ç³»</span></span><br><span class="line">    <span class="keyword">if</span> (modelMeta-&gt;_keyMappedCount &gt;= <span class="built_in">CFDictionaryGetCount</span>((<span class="built_in">CFDictionaryRef</span>)dic)) &#123;</span><br><span class="line">        <span class="comment">// ä¸€èˆ¬æƒ…å†µä¸‹ä»–ä»¬çš„æ•°é‡ç›¸ç­‰</span></span><br><span class="line">        <span class="comment">// ç‰¹æ®Šæƒ…å†µæ¯”å¦‚æœ‰çš„å±æ€§å…ƒä¼šæ˜ å°„å­—å…¸ä¸­çš„å¤šä¸ª key</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä¸ºå­—å…¸ä¸­çš„æ¯ä¸ªé”®å€¼å¯¹è°ƒç”¨ ModelSetWithDictionaryFunction</span></span><br><span class="line">        <span class="comment">// è¿™å¥è¯æ˜¯æ ¸å¿ƒä»£ç ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å°±æ˜¯é  ModelSetWithDictionaryFunction é€šè¿‡å­—å…¸è®¾ç½®æ¨¡å‹</span></span><br><span class="line">        <span class="built_in">CFDictionaryApplyFunction</span>((<span class="built_in">CFDictionaryRef</span>)dic, ModelSetWithDictionaryFunction, &amp;context);</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ¨¡å‹ä¸­æ˜¯å¦å­˜åœ¨æ˜ å°„ keyPath çš„å±æ€§å…ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (modelMeta-&gt;_keyPathPropertyMetas) &#123;</span><br><span class="line">            <span class="comment">// ä¸ºæ¯ä¸ªæ˜ å°„ keyPath çš„å±æ€§å…ƒæ‰§è¡Œ ModelSetWithPropertyMetaArrayFunction</span></span><br><span class="line">            <span class="built_in">CFArrayApplyFunction</span>((<span class="built_in">CFArrayRef</span>)modelMeta-&gt;_keyPathPropertyMetas,</span><br><span class="line">                                 <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, <span class="built_in">CFArrayGetCount</span>((<span class="built_in">CFArrayRef</span>)modelMeta-&gt;_keyPathPropertyMetas)),</span><br><span class="line">                                 ModelSetWithPropertyMetaArrayFunction,</span><br><span class="line">                                 &amp;context);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ¨¡å‹ä¸­æ˜¯å¦å­˜åœ¨æ˜ å°„å¤šä¸ª key çš„å±æ€§å…ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (modelMeta-&gt;_multiKeysPropertyMetas) &#123;</span><br><span class="line">            <span class="comment">// ä¸ºæ¯ä¸ªæ˜ å°„å¤šä¸ª key çš„å±æ€§å…ƒæ‰§è¡Œ ModelSetWithPropertyMetaArrayFunction</span></span><br><span class="line">            <span class="built_in">CFArrayApplyFunction</span>((<span class="built_in">CFArrayRef</span>)modelMeta-&gt;_multiKeysPropertyMetas,</span><br><span class="line">                                 <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, <span class="built_in">CFArrayGetCount</span>((<span class="built_in">CFArrayRef</span>)modelMeta-&gt;_multiKeysPropertyMetas)),</span><br><span class="line">                                 ModelSetWithPropertyMetaArrayFunction,</span><br><span class="line">                                 &amp;context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// æ¨¡å‹å…ƒé”®å€¼æ˜ å°„æ•°é‡å°‘ï¼Œåˆ™è®¤ä¸ºä¸å­˜åœ¨æ˜ å°„å¤šä¸ª key çš„å±æ€§å…ƒ</span></span><br><span class="line">        <span class="comment">// ç›´æ¥ä¸ºæ¯ä¸ª modelMeta å±æ€§å…ƒæ‰§è¡Œ ModelSetWithPropertyMetaArrayFunction</span></span><br><span class="line">        <span class="built_in">CFArrayApplyFunction</span>((<span class="built_in">CFArrayRef</span>)modelMeta-&gt;_allPropertyMetas,</span><br><span class="line">                             <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, modelMeta-&gt;_keyMappedCount),</span><br><span class="line">                             ModelSetWithPropertyMetaArrayFunction,</span><br><span class="line">                             &amp;context);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¿½ç•¥ï¼Œè¯¥æ ‡è¯†å¯¹åº”æ¥å£ modelCustomTransformFromDictionary</span></span><br><span class="line">    <span class="keyword">if</span> (modelMeta-&gt;_hasCustomTransformFromDictionary) &#123;</span><br><span class="line">        <span class="comment">// è¯¥æ¥å£ç”¨äºå½“é»˜è®¤ JSON è½¬ Model ä¸é€‚åˆæ¨¡å‹å¯¹è±¡æ—¶åšé¢å¤–çš„é€»è¾‘å¤„ç†</span></span><br><span class="line">        <span class="comment">// æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªæ¥å£æ¥éªŒè¯æ¨¡å‹è½¬æ¢çš„ç»“æœ</span></span><br><span class="line">        <span class="keyword">return</span> [((<span class="type">id</span>&lt;YYModel&gt;)<span class="keyword">self</span>) modelCustomTransformFromDictionary:dic];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç å·²ç»æ³¨æ˜å¿…è¦ä¸­æ–‡æ³¨é‡Šï¼Œå…³äºä¸¤å¤„è‡ªå®šä¹‰æ‰©å±•æ¥å£æˆ‘ä»¬ä¸å†å¤šè¯´ï¼Œç”±äºä»£ç æ¯”è¾ƒé•¿æˆ‘ä»¬å…ˆæ¥æ¢³ç†ä¸€ä¸‹ <code>yy_modelSetWithDictionary</code> ä¸»è¦åšäº†å“ªäº›äº‹ï¼Ÿ</p>
<ul>
<li>å…¥å‚æ ¡éªŒ</li>
<li>åˆå§‹åŒ–æ¨¡å‹å…ƒä»¥åŠæ˜ å°„è¡¨æ ¡éªŒ</li>
<li>åˆå§‹åŒ–æ¨¡å‹è®¾ç½®ä¸Šä¸‹æ–‡ <code>ModelSetContext</code></li>
<li>ä¸ºå­—å…¸ä¸­çš„æ¯ä¸ªé”®å€¼å¯¹è°ƒç”¨ <code>ModelSetWithDictionaryFunction</code></li>
<li>æ£€éªŒè½¬æ¢ç»“æœ</li>
</ul>
<p>æ¨¡å‹è®¾ç½®ä¸Šä¸‹æ–‡ <code>ModelSetContext</code> å…¶å®å°±æ˜¯ä¸€ä¸ªåŒ…å«æ¨¡å‹å…ƒï¼Œæ¨¡å‹å®ä¾‹ä»¥åŠå¾…è½¬æ¢å­—å…¸çš„ç»“æ„ä½“ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="type">void</span> *modelMeta;  <span class="comment">///&lt; æ¨¡å‹å…ƒ</span></span><br><span class="line">    <span class="type">void</span> *model;      <span class="comment">///&lt; æ¨¡å‹å®ä¾‹ï¼ŒæŒ‡å‘è¾“å‡ºçš„æ¨¡å‹</span></span><br><span class="line">    <span class="type">void</span> *dictionary; <span class="comment">///&lt; å¾…è½¬æ¢å­—å…¸</span></span><br><span class="line">&#125; ModelSetContext;</span><br></pre></td></tr></table></figure>
<p>å¤§å®¶è‚¯å®šéƒ½æ³¨æ„åˆ°äº† <code>ModelSetWithDictionaryFunction</code> å‡½æ•°ï¼Œä¸è®ºèµ°å“ªæ¡é€»è¾‘åˆ†æ”¯ï¼Œæœ€åéƒ½æ˜¯è°ƒç”¨è¿™ä¸ªå‡½æ•°æŠŠå­—å…¸çš„ keyï¼ˆkeypathï¼‰å¯¹åº”çš„ value å–å‡ºå¹¶èµ‹å€¼ç»™ Model çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ¥çœ‹çœ‹è¿™ä¸ªå‡½æ•°çš„å®ç°ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å­—å…¸é”®å€¼å¯¹å»ºæ¨¡</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">void</span> ModelSetWithDictionaryFunction(<span class="keyword">const</span> <span class="type">void</span> *_key, <span class="keyword">const</span> <span class="type">void</span> *_value, <span class="type">void</span> *_context) &#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°å…¥å‚ä¸Šä¸‹æ–‡</span></span><br><span class="line">    ModelSetContext *context = _context;</span><br><span class="line">    <span class="comment">// å–å‡ºä¸Šä¸‹æ–‡ä¸­æ¨¡å‹å…ƒ</span></span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> _YYModelMeta *meta = (__bridge _YYModelMeta *)(context-&gt;modelMeta);</span><br><span class="line">    <span class="comment">// æ ¹æ®å…¥å‚ _key ä»æ¨¡å‹å…ƒä¸­å–å‡ºæ˜ å°„è¡¨å¯¹åº”çš„å±æ€§å…ƒ</span></span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> _YYModelPropertyMeta *propertyMeta = [meta-&gt;_mapper objectForKey:(__bridge <span class="type">id</span>)(_key)];</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°å¾…èµ‹å€¼æ¨¡å‹</span></span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> <span class="type">id</span> model = (__bridge <span class="type">id</span>)(context-&gt;model);</span><br><span class="line">    <span class="comment">// éå† propertyMetaï¼Œç›´åˆ° propertyMeta-&gt;_next == nil</span></span><br><span class="line">    <span class="keyword">while</span> (propertyMeta) &#123;</span><br><span class="line">        <span class="comment">// å½“å‰éå†çš„ propertyMeta æœ‰ setter æ–¹æ³•ï¼Œåˆ™è°ƒç”¨ ModelSetValueForProperty èµ‹å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (propertyMeta-&gt;_<span class="keyword">setter</span>) &#123;</span><br><span class="line">            <span class="comment">// æ ¸å¿ƒæ–¹æ³•ï¼Œæ‹å‡ºæ¥è®²</span></span><br><span class="line">            ModelSetValueForProperty(model, (__bridge __<span class="keyword">unsafe_unretained</span> <span class="type">id</span>)_value, propertyMeta);</span><br><span class="line">        &#125;</span><br><span class="line">        propertyMeta = propertyMeta-&gt;_next;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ModelSetWithDictionaryFunction</code> å‡½æ•°çš„å®ç°é€»è¾‘å°±æ˜¯å…ˆé€šè¿‡æ¨¡å‹è®¾ç½®ä¸Šä¸‹æ–‡æ‹¿åˆ°å¸¦èµ‹å€¼æ¨¡å‹ï¼Œä¹‹åéå†å½“å‰çš„å±æ€§å…ƒï¼ˆç›´åˆ° propertyMeta-&gt;_next == nilï¼‰ï¼Œæ‰¾åˆ° <code>setter</code> ä¸ä¸ºç©ºçš„å±æ€§å…ƒé€šè¿‡ <code>ModelSetValueForProperty</code> æ–¹æ³•èµ‹å€¼ã€‚</p>
<p><code>ModelSetValueForProperty</code> å‡½æ•°æ˜¯ä¸ºæ¨¡å‹ä¸­çš„å±æ€§èµ‹å€¼çš„å®ç°æ–¹æ³•ï¼Œä¹Ÿæ˜¯æ•´ä¸ª YYModel çš„æ ¸å¿ƒä»£ç ã€‚åˆ«ç´§å¼ ï¼Œè¿™ä¸ªå‡½æ•°å†™å¾—å¾ˆå‹å¥½çš„ï¼Œä¹Ÿå°± 300 å¤šè¡Œè€Œå·² ğŸ˜œï¼ˆæ— å…³ç´§è¦çš„å†…å®¹æˆ‘ä¼šå°½é‡å¿½ç•¥æ‰ï¼‰ï¼Œä¸è¿‡å¿½ç•¥çš„å¤ªå¤šä¼šå½±å“ä»£ç é˜…è¯»çš„è¿ç»­æ€§ï¼Œå¦‚æœå«Œé•¿å¯ä»¥ä¸çœ‹ï¼Œæ–‡ç« åé¢ä¼šæ€»ç»“ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å®ç°é€»è¾‘ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">void</span> ModelSetValueForProperty(__<span class="keyword">unsafe_unretained</span> <span class="type">id</span> model,</span><br><span class="line">                                     __<span class="keyword">unsafe_unretained</span> <span class="type">id</span> value,</span><br><span class="line">                                     __<span class="keyword">unsafe_unretained</span> _YYModelPropertyMeta *meta) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå±æ€§æ˜¯ä¸€ä¸ª CNumberï¼Œå³è¾“å…¥ intã€uintâ€¦â€¦</span></span><br><span class="line">    <span class="keyword">if</span> (meta-&gt;_isCNumber) &#123;</span><br><span class="line">        <span class="comment">// è½¬ä¸º NSNumber ä¹‹åèµ‹å€¼</span></span><br><span class="line">        <span class="built_in">NSNumber</span> *num = YYNSNumberCreateFromID(value);</span><br><span class="line">        <span class="comment">// è¿™é‡Œ ModelSetNumberToProperty å°è£…äº†ç»™å±æ€§å…ƒèµ‹å€¼ NSNumber çš„æ“ä½œ</span></span><br><span class="line">        ModelSetNumberToProperty(model, num, meta);</span><br><span class="line">        <span class="keyword">if</span> (num) [num <span class="keyword">class</span>]; <span class="comment">// hold the number</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (meta-&gt;_nsType) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå±æ€§å±äº nsTypeï¼Œå³ NSStringã€NSNumberâ€¦â€¦</span></span><br><span class="line">        <span class="keyword">if</span> (value == (<span class="type">id</span>)kCFNull) &#123; <span class="comment">// ä¸ºç©ºï¼Œåˆ™èµ‹å€¼ nilï¼ˆé€šè¿‡å±æ€§å…ƒ _setter æ–¹æ³•ä½¿ç”¨ objc_msgSend å°† nil èµ‹å€¼ï¼‰</span></span><br><span class="line">            ((<span class="type">void</span> (*)(<span class="type">id</span>, SEL, <span class="type">id</span>))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, meta-&gt;_<span class="keyword">setter</span>, (<span class="type">id</span>)<span class="literal">nil</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// ä¸ä¸ºç©º</span></span><br><span class="line">            <span class="keyword">switch</span> (meta-&gt;_nsType) &#123;</span><br><span class="line">                <span class="comment">// NSString æˆ– NSMutableString</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSString:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSMutableString: &#123;</span><br><span class="line">                    <span class="comment">// å¤„ç†å¯èƒ½çš„ value ç±»å‹ï¼šNSStringï¼ŒNSNumberï¼ŒNSDataï¼ŒNSURLï¼ŒNSAttributedString</span></span><br><span class="line">                    <span class="comment">// å¯¹åº”çš„åˆ†æ”¯å°±æ˜¯æŠŠ value è½¬ä¸º NSString æˆ–è€… NSMutableStringï¼Œä¹‹åè°ƒç”¨ setter èµ‹å€¼</span></span><br><span class="line">                    ...</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// NSValueï¼ŒNSNumber æˆ– NSDecimalNumber</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSValue:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSNumber:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSDecimalNumber: &#123;</span><br><span class="line">                    <span class="comment">// å¯¹å±æ€§å…ƒçš„ç±»å‹åˆ†æƒ…å†µèµ‹å€¼ï¼ˆä¸­é—´å¯èƒ½ä¼šæ¶‰åŠåˆ°ç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼‰</span></span><br><span class="line">                    ...</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="comment">// NSData æˆ– NSMutableData</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSData:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSMutableData: &#123;</span><br><span class="line">                    <span class="comment">// å¯¹å±æ€§å…ƒçš„ç±»å‹åˆ†æƒ…å†µèµ‹å€¼ï¼ˆä¸­é—´å¯èƒ½ä¼šæ¶‰åŠåˆ°ç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼‰</span></span><br><span class="line">                    ...</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="comment">// NSDate</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSDate: &#123;</span><br><span class="line">                    <span class="comment">// è€ƒè™‘å¯èƒ½çš„ value ç±»å‹ï¼šNSDate æˆ– NSString</span></span><br><span class="line">                    <span class="comment">// è½¬æ¢ä¸º NSDate ä¹‹åèµ‹å€¼</span></span><br><span class="line">                    ...</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="comment">// NSURL</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSURL: &#123;</span><br><span class="line">                    <span class="comment">// è€ƒè™‘å¯èƒ½çš„ value ç±»å‹ï¼šNSURL æˆ– NSString</span></span><br><span class="line">                    <span class="comment">// è½¬æ¢ä¸º NSDate ä¹‹åèµ‹å€¼ï¼ˆè¿™é‡Œå¯¹ NSString çš„é•¿åº¦åˆ¤æ–­æ˜¯å¦èµ‹å€¼ nilï¼‰</span></span><br><span class="line">                    ...</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="comment">// NSArray æˆ– NSMutableArray</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSArray:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSMutableArray: &#123;</span><br><span class="line">                    <span class="comment">// å¯¹å±æ€§å…ƒçš„æ³›å‹åˆ¤æ–­</span></span><br><span class="line">                    <span class="keyword">if</span> (meta-&gt;_genericCls) &#123; <span class="comment">// å¦‚æœå­˜åœ¨æ³›å‹</span></span><br><span class="line">                        <span class="built_in">NSArray</span> *valueArr = <span class="literal">nil</span>;</span><br><span class="line">                        <span class="comment">// value æ‰€å± NSArray åˆ™ç›´æ¥èµ‹å€¼ï¼Œå¦‚æœæ‰€å± NSSet ç±»åˆ™è½¬ä¸º NSArray</span></span><br><span class="line">                        <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) valueArr = value;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSSet</span> <span class="keyword">class</span>]]) valueArr = ((<span class="built_in">NSSet</span> *)value).allObjects;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// éå†åˆšæ‰é€šè¿‡ value è½¬æ¢æ¥çš„ valueArr</span></span><br><span class="line">                        <span class="keyword">if</span> (valueArr) &#123;</span><br><span class="line">                            <span class="built_in">NSMutableArray</span> *objectArr = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">                            <span class="keyword">for</span> (<span class="type">id</span> one <span class="keyword">in</span> valueArr) &#123;</span><br><span class="line">                                <span class="comment">// é‡åˆ° valueArr ä¸­çš„å…ƒç´ å±äºæ³›å‹ç±»ï¼Œç›´æ¥åŠ å…¥ objectArr</span></span><br><span class="line">                                <span class="keyword">if</span> ([one isKindOfClass:meta-&gt;_genericCls]) &#123;</span><br><span class="line">                                    [objectArr addObject:one];</span><br><span class="line">                                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([one isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                                    <span class="comment">// é‡åˆ° valueArr ä¸­çš„å…ƒç´ æ˜¯å­—å…¸ç±»ï¼Œ</span></span><br><span class="line">                                    Class cls = meta-&gt;_genericCls;</span><br><span class="line">                                    <span class="comment">// å¿½ç•¥</span></span><br><span class="line">                                    <span class="keyword">if</span> (meta-&gt;_hasCustomClassFromDictionary) &#123;</span><br><span class="line">                                        cls = [cls modelCustomClassForDictionary:one];</span><br><span class="line">                                        <span class="keyword">if</span> (!cls) cls = meta-&gt;_genericCls; <span class="comment">// for xcode code coverage</span></span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="comment">// è¿˜è®°å¾—æˆ‘ä»¬ç›´æ¥çš„èµ·ç‚¹ yy_modelSetWithDictionaryï¼Œå°†å­—å…¸è½¬æ¨¡å‹</span></span><br><span class="line">                                    <span class="comment">// æˆ‘è§‰å¾—è¿™åº”è¯¥ç®—æ˜¯ä¸€ä¸ªé—´æ¥é€’å½’è°ƒç”¨</span></span><br><span class="line">                                    <span class="comment">// å¦‚æœè®¾è®¡å‡ºçš„æ¨¡å‹æ˜¯æ— é™é€’å½’ï¼ˆä»å‰æœ‰åº§å±±ï¼Œå±±ä¸Šæœ‰åº§åº™çš„æ•…äº‹ï¼‰ï¼Œé‚£ä¹ˆè‚¯å®šä¼šæ…¢</span></span><br><span class="line">                                    <span class="built_in">NSObject</span> *newOne = [cls new];</span><br><span class="line">                                    [newOne yy_modelSetWithDictionary:one];</span><br><span class="line">                                    <span class="comment">// è½¬åŒ–æˆåŠŸæœºä¹ŸåŠ å…¥ objectArr</span></span><br><span class="line">                                    <span class="keyword">if</span> (newOne) [objectArr addObject:newOne];</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// æœ€åå°†å¾—åˆ°çš„ objectArr èµ‹å€¼ç»™å±æ€§</span></span><br><span class="line">                            ((<span class="type">void</span> (*)(<span class="type">id</span>, SEL, <span class="type">id</span>))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, meta-&gt;_<span class="keyword">setter</span>, objectArr);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// æ²¡æœ‰æ³›å‹ï¼Œå˜›~ åˆ¤æ–­ä¸€ä¸‹ value çš„å¯èƒ½æ‰€å±ç±»å‹ NSArray æˆ– NSSet</span></span><br><span class="line">                        <span class="comment">// è½¬æ¢èµ‹å€¼ï¼ˆæ¶‰åŠ mutableï¼‰</span></span><br><span class="line">                        ...</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// NSDictionary æˆ– NSMutableDictionary</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSDictionary:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSMutableDictionary: &#123;</span><br><span class="line">                    <span class="comment">// è·Ÿä¸Šé¢æ•°ç»„çš„å¤„ç†è¶…ç›¸ä¼¼ï¼Œæ³›å‹çš„é—´æ¥é€’å½’ä»¥åŠæ— æ³›å‹çš„ç±»å‹è½¬æ¢ï¼ˆmutable çš„å¤„ç†ï¼‰</span></span><br><span class="line">                    ...</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="comment">// NSSet æˆ– NSMutableSet</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSSet:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSMutableSet: &#123;</span><br><span class="line">                    <span class="comment">// è·Ÿä¸Šé¢æ•°ç»„çš„å¤„ç†è¶…ç›¸ä¼¼ï¼Œæ³›å‹çš„é—´æ¥é€’å½’ä»¥åŠæ— æ³›å‹çš„ç±»å‹è½¬æ¢ï¼ˆmutable çš„å¤„ç†ï¼‰</span></span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// å±æ€§å…ƒä¸å±äº CNumber å’Œ nsType </span></span><br><span class="line">        <span class="type">BOOL</span> isNull = (value == (<span class="type">id</span>)kCFNull);</span><br><span class="line">        <span class="keyword">switch</span> (meta-&gt;_type &amp; YYEncodingTypeMask) &#123;</span><br><span class="line">            <span class="comment">// id</span></span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeObject: &#123;</span><br><span class="line">                <span class="keyword">if</span> (isNull) &#123; <span class="comment">// ç©ºï¼Œèµ‹å€¼ nil</span></span><br><span class="line">                    ((<span class="type">void</span> (*)(<span class="type">id</span>, SEL, <span class="type">id</span>))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, meta-&gt;_<span class="keyword">setter</span>, (<span class="type">id</span>)<span class="literal">nil</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:meta-&gt;_cls] || !meta-&gt;_cls) &#123;</span><br><span class="line">                    <span class="comment">// å±æ€§å…ƒä¸ value ä»å±äºåŒä¸€ä¸ªç±»ï¼Œåˆ™ç›´æ¥èµ‹å€¼</span></span><br><span class="line">                    ((<span class="type">void</span> (*)(<span class="type">id</span>, SEL, <span class="type">id</span>))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, meta-&gt;_<span class="keyword">setter</span>, (<span class="type">id</span>)value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                    <span class="comment">// å˜›~ value ä»å±äº </span></span><br><span class="line">                    <span class="built_in">NSObject</span> *one = <span class="literal">nil</span>;</span><br><span class="line">                    <span class="comment">// å¦‚æœå±æ€§å…ƒæœ‰ getter æ–¹æ³•ï¼Œåˆ™é€šè¿‡ getter è·å–åˆ°å®ä¾‹</span></span><br><span class="line">                    <span class="keyword">if</span> (meta-&gt;_<span class="keyword">getter</span>) &#123;</span><br><span class="line">                        one = ((<span class="type">id</span> (*)(<span class="type">id</span>, SEL))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, meta-&gt;_<span class="keyword">getter</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (one) &#123;</span><br><span class="line">                        <span class="comment">// ç”¨ yy_modelSetWithDictionary è¾“å‡ºåŒ–å±æ€§å®ä¾‹å¯¹è±¡</span></span><br><span class="line">                        [one yy_modelSetWithDictionary:value];</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Class cls = meta-&gt;_cls;</span><br><span class="line">                        <span class="comment">// ç•¥è¿‡</span></span><br><span class="line">                        <span class="keyword">if</span> (meta-&gt;_hasCustomClassFromDictionary) &#123;</span><br><span class="line">                            cls = [cls modelCustomClassForDictionary:value];</span><br><span class="line">                            <span class="keyword">if</span> (!cls) cls = meta-&gt;_genericCls; <span class="comment">// for xcode code coverage</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// ç”¨ yy_modelSetWithDictionary è¾“å‡ºåŒ–å±æ€§å®ä¾‹å¯¹è±¡ï¼Œèµ‹å€¼</span></span><br><span class="line">                        one = [cls new];</span><br><span class="line">                        [one yy_modelSetWithDictionary:value];</span><br><span class="line">                        ((<span class="type">void</span> (*)(<span class="type">id</span>, SEL, <span class="type">id</span>))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, meta-&gt;_<span class="keyword">setter</span>, (<span class="type">id</span>)one);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Class</span></span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeClass: &#123;</span><br><span class="line">                <span class="keyword">if</span> (isNull) &#123; <span class="comment">// ç©ºï¼Œèµ‹å€¼(Class)NULLï¼Œç”±äº Class å…¶å®æ˜¯ C è¯­è¨€å®šä¹‰çš„ç»“æ„ä½“ï¼Œæ‰€ä»¥ä½¿ç”¨ NULL</span></span><br><span class="line">                    <span class="comment">// å…³äº nilï¼ŒNilï¼ŒNULLï¼ŒNSNullï¼ŒkCFNull çš„æ¨ªå‘æ¯”è¾ƒï¼Œæˆ‘ä¼šå•ç‹¬æ‹å‡ºæ¥åœ¨ä¸‹é¢ä»‹ç»</span></span><br><span class="line">                    ((<span class="type">void</span> (*)(<span class="type">id</span>, SEL, Class))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, meta-&gt;_<span class="keyword">setter</span>, (Class)<span class="literal">NULL</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// åˆ¤æ–­ value å¯èƒ½çš„ç±»å‹ NSString æˆ–åˆ¤æ–­ class_isMetaClass(object_getClass(value))</span></span><br><span class="line">                    <span class="comment">// å¦‚æœæ»¡è¶³æ¡ä»¶åˆ™èµ‹å€¼</span></span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// SEL</span></span><br><span class="line">            <span class="keyword">case</span>  YYEncodingTypeSEL: &#123;</span><br><span class="line">                <span class="comment">// åˆ¤ç©ºï¼Œèµ‹å€¼(SEL)NULL</span></span><br><span class="line">                <span class="comment">// å¦åˆ™è½¬æ¢ç±»å‹ SEL sel = NSSelectorFromString(value); ç„¶åèµ‹å€¼</span></span><br><span class="line">                ...</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="comment">// block</span></span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeBlock: &#123;</span><br><span class="line">                <span class="comment">// åˆ¤ç©ºï¼Œèµ‹å€¼(void (^)())NULL</span></span><br><span class="line">                <span class="comment">// å¦åˆ™åˆ¤æ–­ç±»å‹ [value isKindOfClass:YYNSBlockClass()] ä¹‹åèµ‹å€¼</span></span><br><span class="line">                ...</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// structã€unionã€char[n]ï¼Œå…³äº union å…±åŒä½“æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·± googleï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹</span></span><br><span class="line">            <span class="comment">// union å…±åŒä½“ï¼Œç±»ä¼¼ struct çš„å­˜åœ¨ï¼Œä½†æ˜¯ union æ¯ä¸ªæˆå‘˜ä¼šç”¨åŒä¸€ä¸ªå­˜å‚¨ç©ºé—´ï¼Œåªèƒ½å­˜å‚¨æœ€åä¸€ä¸ªæˆå‘˜çš„ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeStruct:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeUnion:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeCArray: &#123;</span><br><span class="line">                <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSValue</span> <span class="keyword">class</span>]]) &#123; </span><br><span class="line">                    <span class="comment">// æ¶‰åŠ Type Encodings</span></span><br><span class="line">                    <span class="keyword">const</span> <span class="type">char</span> *valueType = ((<span class="built_in">NSValue</span> *)value).objCType;</span><br><span class="line">                    <span class="keyword">const</span> <span class="type">char</span> *metaType = meta-&gt;_info.typeEncoding.UTF8String;</span><br><span class="line">                    <span class="comment">// æ¯”è¾ƒ valueType ä¸ metaType æ˜¯å¦ç›¸åŒï¼Œç›¸åŒï¼ˆstrcmp(a, b) è¿”å› 0ï¼‰åˆ™èµ‹å€¼</span></span><br><span class="line">                    <span class="keyword">if</span> (valueType &amp;&amp; metaType &amp;&amp; strcmp(valueType, metaType) == <span class="number">0</span>) &#123;</span><br><span class="line">                        [model setValue:value forKey:meta-&gt;_name];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// void* æˆ– char*</span></span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypePointer:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeCString: &#123;</span><br><span class="line">                <span class="keyword">if</span> (isNull) &#123; <span class="comment">// åˆ¤ç©ºï¼Œèµ‹å€¼(void *)NULL</span></span><br><span class="line">                    ((<span class="type">void</span> (*)(<span class="type">id</span>, SEL, <span class="type">void</span> *))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, meta-&gt;_<span class="keyword">setter</span>, (<span class="type">void</span> *)<span class="literal">NULL</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSValue</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                    <span class="comment">// æ¶‰åŠ Type Encodings</span></span><br><span class="line">                    <span class="built_in">NSValue</span> *nsValue = value;</span><br><span class="line">                    <span class="keyword">if</span> (nsValue.objCType &amp;&amp; strcmp(nsValue.objCType, <span class="string">&quot;^v&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                        ((<span class="type">void</span> (*)(<span class="type">id</span>, SEL, <span class="type">void</span> *))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, meta-&gt;_<span class="keyword">setter</span>, nsValue.pointerValue);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¢ ğŸ˜“ æˆ‘æ˜¯çœŸçš„å·²ç»å¿½ç•¥æ‰å¾ˆå¤šä»£ç äº†ï¼Œæ²¡åŠæ³•è¿˜æ˜¯æœ‰ç‚¹é•¿ã€‚å…¶å®ä»£ç é€»è¾‘è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œåªæ˜¯æ¨¡å‹èµ‹å€¼æ¶‰åŠçš„ç¼–ç ç±»å‹ç­‰çç¢é€»è¾‘æ¯”è¾ƒå¤šå¯¼è‡´ä»£ç é‡æ¯”è¾ƒå¤§ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥æ€»ç»“ä¸€ä¸‹æ ¸å¿ƒä»£ç çš„å®ç°é€»è¾‘ã€‚</p>
<ul>
<li>æ ¹æ®å±æ€§å…ƒç±»å‹åˆ’åˆ†ä»£ç é€»è¾‘</li>
<li>å¦‚æœå±æ€§å…ƒæ˜¯ CNumber ç±»å‹ï¼Œå³ intã€uint ä¹‹ç±»ï¼Œåˆ™ä½¿ç”¨ <code>ModelSetNumberToProperty</code> èµ‹å€¼</li>
<li>å¦‚æœå±æ€§å…ƒå±äº NSType ç±»å‹ï¼Œå³ NSStringã€NSNumber ä¹‹ç±»ï¼Œåˆ™æ ¹æ®ç±»å‹è½¬æ¢ä¸­å¯èƒ½æ¶‰åŠåˆ°çš„å¯¹åº”ç±»å‹åšé€»è¾‘åˆ¤æ–­å¹¶èµ‹å€¼ï¼ˆå¯ä»¥å»ä¸Šé¢ä»£ç ä¸­æŸ¥çœ‹å…·ä½“å®ç°é€»è¾‘ï¼‰</li>
<li>å¦‚æœå±æ€§å…ƒä¸å±äº CNumber å’Œ NSTypeï¼Œåˆ™çŒœæµ‹ä¸º idï¼ŒClassï¼ŒSELï¼ŒBlockï¼Œstructã€unionã€char[n]ï¼Œvoid<em> æˆ– char</em> ç±»å‹å¹¶ä¸”åšå‡ºç›¸åº”çš„è½¬æ¢å’Œèµ‹å€¼</li>
</ul>
<p>å˜›~ å…¶å®ä¸Šé¢çš„ä»£ç é™¤äº†é•¿ä»¥å¤–é€»è¾‘è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œæ€»ç»“èµ·æ¥å°±æ˜¯æ ¹æ®å¯èƒ½å‡ºç°çš„ç±»å‹å»åšå‡ºå¯¹åº”çš„é€»è¾‘æ“ä½œï¼Œå»ºè®®å„ä½æœ‰æ—¶é—´è¿˜æ˜¯å»è¯»ä¸‹æºç ï¼Œå°¤å…¶æ˜¯è‡ªå·±é¡¹ç›®ä¸­ç”¨åˆ° YYModel çš„åŒå­¦ã€‚ç›¸ä¿¡çœ‹å®Œä¹‹åä¼šå¯¹ YYModel å±æ€§èµ‹å€¼ä¸€æ¸…äºŒæ¥šï¼Œè¿™æ ·åœ¨ä½¿ç”¨ YYModel çš„æ—¥å¸¸ä¸­å‡ºç°ä»»ä½•é—®é¢˜éƒ½å¯ä»¥å¿ƒä¸­æœ‰æ•°ï¼Œæ”¹èµ·ä»£ç è‡ªç„¶å¦‚æœ‰ç¥åŠ©å“ˆã€‚</p>
<p>é¢â€¦è€ƒè™‘åˆ° NSDictionary to Model çš„æ•´ä¸ªè¿‡ç¨‹ä»£ç é‡ä¸å°ï¼Œæˆ‘èŠ±äº†ä¸€äº›æ—¶é—´å°†å…¶é€»è¾‘æ€»ç»“å½’çº³ä¸ºä¸€å¼ å›¾ï¼š</p>
<img src="/yymodel0x02/d2m.png" class="">
<p>å¸Œæœ›å¯ä»¥å°½è‡ªå·±çš„åŠªåŠ›è®©æ–‡ç« çš„è¡¨è¿°å˜å¾—æ›´ç›´ç™½ã€‚</p>
<h3 id="Model-to-JSON"><a href="#Model-to-JSON" class="headerlink" title="Model to JSON"></a>Model to JSON</h3><img src="/yymodel0x02/m2j.jpg" class="">
<p>ç›¸æ¯”äº JSON to Model æ¥è¯´ï¼ŒModel to JSON æ›´ç®€å•ä¸€äº›ã€‚å…¶ä¸­å› ä¸º NSJSONSerialization åœ¨å¯¹ JSON çš„è½¬æ¢æ—¶åšäº†ä¸€äº›è§„å®šï¼š</p>
<ul>
<li>é¡¶çº§å¯¹è±¡æ˜¯ NSArray æˆ–è€… NSDictionary ç±»å‹</li>
<li>æ‰€æœ‰çš„å¯¹è±¡éƒ½æ˜¯ NSString, NSNumber, NSArray, NSDictionary, æˆ– NSNull çš„å®ä¾‹</li>
<li>æ‰€æœ‰å­—å…¸ä¸­çš„ key éƒ½æ˜¯ä¸€ä¸ª NSString å®ä¾‹</li>
<li>Numbers æ˜¯é™¤å»æ— ç©·å¤§å’Œ NaN çš„å…¶ä»–è¡¨ç¤º</li>
</ul>
<blockquote>
<p>Note: ä¸Šæ–‡å‡ºè‡ª <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/foundation/nsjsonserialization">NSJSONSerialization å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
</blockquote>
<p>çŸ¥é“äº†è¿™ä¸€ç‚¹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä» YYModel çš„ Model to JSON æ¥å£ <code>yy_modelToJSONObject</code> å¤„å¼€å§‹è§£è¯»æºç äº†ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">id</span>)yy_modelToJSONObject &#123;</span><br><span class="line">    <span class="comment">// é€’å½’è½¬æ¢æ¨¡å‹åˆ° JSON</span></span><br><span class="line">    <span class="type">id</span> jsonObject = ModelToJSONObjectRecursive(<span class="keyword">self</span>);</span><br><span class="line">    <span class="keyword">if</span> ([jsonObject isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> jsonObject;</span><br><span class="line">    <span class="keyword">if</span> ([jsonObject isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> jsonObject;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å˜›~ ä¸€å…± 4 è¡Œä»£ç ï¼Œåªéœ€è¦å…³æ³¨ä¸€ä¸‹ç¬¬ä¸€è¡Œä»£ç ä¸­çš„ <code>ModelToJSONObjectRecursive</code> æ–¹æ³•ï¼Œ<code>Objective-C</code> çš„è¯­è¨€ç‰¹æ€§å†³å®šäº†ä»å‡½æ•°åç§°å³å¯æ— éœ€æ³¨é‡Šçœ‹æ‡‚ä»£ç ï¼Œè¿™ä¸ªæ–¹æ³•ä»åå­—ä¸Šå°±å¯ä»¥ get åˆ°å®ƒæ˜¯é€šè¿‡é€’å½’æ–¹æ³•ä½¿ Model è½¬æ¢ä¸º JSON çš„ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€’å½’è½¬æ¢æ¨¡å‹åˆ° JSONï¼Œå¦‚æœè½¬æ¢å¼‚å¸¸åˆ™è¿”å› nil</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">id</span> ModelToJSONObjectRecursive(<span class="built_in">NSObject</span> *model) &#123;</span><br><span class="line">    <span class="comment">// åˆ¤ç©ºæˆ–è€…å¯ä»¥ç›´æ¥è¿”å›çš„å¯¹è±¡ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (!model || model == (<span class="type">id</span>)kCFNull) <span class="keyword">return</span> model;</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> model;</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSNumber</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> model;</span><br><span class="line">    <span class="comment">// å¦‚æœ model ä»å±äº NSDictionary</span></span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå¯ä»¥ç›´æ¥è½¬æ¢ä¸º JSON æ•°æ®ï¼Œåˆ™è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> ([<span class="built_in">NSJSONSerialization</span> isValidJSONObject:model]) <span class="keyword">return</span> model;</span><br><span class="line">        <span class="built_in">NSMutableDictionary</span> *newDic = [<span class="built_in">NSMutableDictionary</span> new];</span><br><span class="line">        <span class="comment">// éå† model çš„ key å’Œ value</span></span><br><span class="line">        [((<span class="built_in">NSDictionary</span> *)model) enumerateKeysAndObjectsUsingBlock:^(<span class="built_in">NSString</span> *key, <span class="type">id</span> obj, <span class="type">BOOL</span> *stop) &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *stringKey = [key isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]] ? key : key.description;</span><br><span class="line">            <span class="keyword">if</span> (!stringKey) <span class="keyword">return</span>;</span><br><span class="line">            <span class="comment">// é€’å½’è§£æ value </span></span><br><span class="line">            <span class="type">id</span> jsonObj = ModelToJSONObjectRecursive(obj);</span><br><span class="line">            <span class="keyword">if</span> (!jsonObj) jsonObj = (<span class="type">id</span>)kCFNull;</span><br><span class="line">            newDic[stringKey] = jsonObj;</span><br><span class="line">        &#125;];</span><br><span class="line">        <span class="keyword">return</span> newDic;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœ model ä»å±äº NSSet</span></span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSSet</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœèƒ½å¤Ÿç›´æ¥è½¬æ¢ JSON å¯¹è±¡ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="comment">// å¦åˆ™éå†ï¼ŒæŒ‰éœ€è¦é€’å½’è§£æ</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœèƒ½å¤Ÿç›´æ¥è½¬æ¢ JSON å¯¹è±¡ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="comment">// å¦åˆ™éå†ï¼ŒæŒ‰éœ€è¦é€’å½’è§£æ</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¯¹ NSURL, NSAttributedString, NSDate, NSData åšç›¸åº”å¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSURL</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> ((<span class="built_in">NSURL</span> *)model).absoluteString;</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSAttributedString</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> ((<span class="built_in">NSAttributedString</span> *)model).string;</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSDate</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> [YYISODateFormatter() stringFromDate:(<span class="type">id</span>)model];</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨ [model class] åˆå§‹åŒ–ä¸€ä¸ªæ¨¡å‹å…ƒ</span></span><br><span class="line">    _YYModelMeta *modelMeta = [_YYModelMeta metaWithClass:[model <span class="keyword">class</span>]];</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜ å°„è¡¨ä¸ºç©ºï¼Œåˆ™ä¸åšè§£æç›´æ¥è¿”å› nil</span></span><br><span class="line">    <span class="keyword">if</span> (!modelMeta || modelMeta-&gt;_keyMappedCount == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚ï¼Œä½¿ç”¨ __unsafe_unretained æ¥é¿å…åœ¨ä¸‹é¢éå† block ä¸­ç›´æ¥ä½¿ç”¨ result æŒ‡é’ˆé€ æˆçš„ä¸å¿…è¦ retain ä¸ release å¼€é”€</span></span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *result = [[<span class="built_in">NSMutableDictionary</span> alloc] initWithCapacity:<span class="number">64</span>];</span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> <span class="built_in">NSMutableDictionary</span> *dic = result;</span><br><span class="line">    <span class="comment">// éå†æ¨¡å‹å…ƒå±æ€§æ˜ å°„å­—å…¸</span></span><br><span class="line">    [modelMeta-&gt;_mapper enumerateKeysAndObjectsUsingBlock:^(<span class="built_in">NSString</span> *propertyMappedKey, _YYModelPropertyMeta *propertyMeta, <span class="type">BOOL</span> *stop) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœéå†å½“å‰å±æ€§å…ƒæ²¡æœ‰ getter æ–¹æ³•ï¼Œè·³è¿‡</span></span><br><span class="line">        <span class="keyword">if</span> (!propertyMeta-&gt;_<span class="keyword">getter</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="type">id</span> value = <span class="literal">nil</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœå±æ€§å…ƒå±äº CNumberï¼Œå³å…¶ type æ˜¯ intã€floatã€double ä¹‹ç±»çš„</span></span><br><span class="line">        <span class="keyword">if</span> (propertyMeta-&gt;_isCNumber) &#123;</span><br><span class="line">            <span class="comment">// ä»å±æ€§ä¸­åˆ©ç”¨ getter æ–¹æ³•å¾—åˆ°å¯¹åº”çš„å€¼</span></span><br><span class="line">            value = ModelCreateNumberFromProperty(model, propertyMeta);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propertyMeta-&gt;_nsType) &#123; <span class="comment">// å±æ€§å…ƒå±äº nsTypeï¼Œå³ NSString ä¹‹ç±»</span></span><br><span class="line">            <span class="comment">// åˆ©ç”¨ getter æ–¹æ³•æ‹¿åˆ° value</span></span><br><span class="line">            <span class="type">id</span> v = ((<span class="type">id</span> (*)(<span class="type">id</span>, SEL))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, propertyMeta-&gt;_<span class="keyword">getter</span>);</span><br><span class="line">            <span class="comment">// å¯¹æ‹¿åˆ°çš„ value é€’å½’è§£æ</span></span><br><span class="line">            value = ModelToJSONObjectRecursive(v);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ ¹æ®å±æ€§å…ƒçš„ type åšç›¸åº”å¤„ç†</span></span><br><span class="line">            <span class="keyword">switch</span> (propertyMeta-&gt;_type &amp; YYEncodingTypeMask) &#123;</span><br><span class="line">                <span class="comment">// idï¼Œéœ€è¦é€’å½’è§£æï¼Œå¦‚æœè§£æå¤±è´¥åˆ™è¿”å› nil</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeObject: &#123;</span><br><span class="line">                    <span class="type">id</span> v = ((<span class="type">id</span> (*)(<span class="type">id</span>, SEL))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, propertyMeta-&gt;_<span class="keyword">getter</span>);</span><br><span class="line">                    value = ModelToJSONObjectRecursive(v);</span><br><span class="line">                    <span class="keyword">if</span> (value == (<span class="type">id</span>)kCFNull) value = <span class="literal">nil</span>;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// Classï¼Œè½¬ NSStringï¼Œè¿”å› Class åç§°</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeClass: &#123;</span><br><span class="line">                    Class v = ((Class (*)(<span class="type">id</span>, SEL))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, propertyMeta-&gt;_<span class="keyword">getter</span>);</span><br><span class="line">                    value = v ? <span class="built_in">NSStringFromClass</span>(v) : <span class="literal">nil</span>;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// SELï¼Œè½¬ NSStringï¼Œè¿”å›ç»™å®š SEL çš„å­—ç¬¦ä¸²è¡¨ç°å½¢å¼</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeSEL: &#123;</span><br><span class="line">                    SEL v = ((SEL (*)(<span class="type">id</span>, SEL))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, propertyMeta-&gt;_<span class="keyword">getter</span>);</span><br><span class="line">                    value = v ? <span class="built_in">NSStringFromSelector</span>(v) : <span class="literal">nil</span>;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœ value è¿˜æ˜¯æ²¡èƒ½è§£æï¼Œåˆ™è·³è¿‡</span></span><br><span class="line">        <span class="keyword">if</span> (!value) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å½“å‰å±æ€§å…ƒæ˜¯ KeyPath æ˜ å°„ï¼Œå³ a.b.c ä¹‹ç±»</span></span><br><span class="line">        <span class="keyword">if</span> (propertyMeta-&gt;_mappedToKeyPath) &#123;</span><br><span class="line">            <span class="built_in">NSMutableDictionary</span> *superDic = dic;</span><br><span class="line">            <span class="built_in">NSMutableDictionary</span> *subDic = <span class="literal">nil</span>;</span><br><span class="line">            <span class="comment">// _mappedToKeyPath æ˜¯ a.b.c æ ¹æ® &#x27;.&#x27; æ‹†åˆ†æˆçš„å­—ç¬¦ä¸²æ•°ç»„ï¼Œéå† _mappedToKeyPath</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>, max = propertyMeta-&gt;_mappedToKeyPath.count; i &lt; max; i++) &#123;</span><br><span class="line">                <span class="built_in">NSString</span> *key = propertyMeta-&gt;_mappedToKeyPath[i];</span><br><span class="line">                <span class="comment">// éå†åˆ°ç»“å°¾</span></span><br><span class="line">                <span class="keyword">if</span> (i + <span class="number">1</span> == max) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœç»“å°¾çš„ key ä¸º nilï¼Œåˆ™ä½¿ç”¨ value èµ‹å€¼</span></span><br><span class="line">                    <span class="keyword">if</span> (!superDic[key]) superDic[key] = value;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// ç”¨ subDic æ‹¿åˆ°å½“å‰ key å¯¹åº”çš„å€¼</span></span><br><span class="line">                subDic = superDic[key];</span><br><span class="line">                <span class="comment">// å¦‚æœ subDic å­˜åœ¨</span></span><br><span class="line">                <span class="keyword">if</span> (subDic) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœ subDic ä»å±äº NSDictionary</span></span><br><span class="line">                    <span class="keyword">if</span> ([subDic isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                        <span class="comment">// å°† subDic çš„ mutable ç‰ˆæœ¬èµ‹å€¼ç»™ superDic[key]</span></span><br><span class="line">                        subDic = subDic.mutableCopy;</span><br><span class="line">                        superDic[key] = subDic;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// å°† NSMutableDictionary èµ‹å€¼ç»™ superDic[key]</span></span><br><span class="line">                    <span class="comment">// æ³¨æ„è¿™é‡Œä½¿ç”¨ subDic é—´æ¥èµ‹å€¼æ˜¯æœ‰åŸå› çš„ï¼ŒåŸå› å°±åœ¨ä¸‹é¢</span></span><br><span class="line">                    subDic = [<span class="built_in">NSMutableDictionary</span> new];</span><br><span class="line">                    superDic[key] = subDic;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// superDic æŒ‡å‘ subDicï¼Œè¿™æ ·åœ¨éå† _mappedToKeyPath æ—¶å³å¯é€å±‚è§£æ</span></span><br><span class="line">                <span class="comment">// è¿™å°±æ˜¯ä¸Šé¢å…ˆæŠŠ subDic è½¬ä¸º NSMutableDictionary çš„åŸå› </span></span><br><span class="line">                superDic = subDic;</span><br><span class="line">                subDic = <span class="literal">nil</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸æ˜¯ KeyPath åˆ™æ£€æµ‹ dic[propertyMeta-&gt;_mappedToKey]ï¼Œå¦‚æœä¸º nil åˆ™èµ‹å€¼ value</span></span><br><span class="line">            <span class="keyword">if</span> (!dic[propertyMeta-&gt;_mappedToKey]) &#123;</span><br><span class="line">                dic[propertyMeta-&gt;_mappedToKey] = value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¿½ç•¥ï¼Œå¯¹åº” modelCustomTransformToDictionary æ¥å£</span></span><br><span class="line">    <span class="keyword">if</span> (modelMeta-&gt;_hasCustomTransformToDictionary) &#123;</span><br><span class="line">        <span class="comment">// ç”¨äºåœ¨é»˜è®¤çš„ Model è½¬ JSON è¿‡ç¨‹ä¸é€‚åˆå½“å‰ Model ç±»å‹æ—¶æä¾›è‡ªå®šä¹‰é¢å¤–è¿‡ç¨‹</span></span><br><span class="line">        <span class="comment">// ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•æ¥éªŒè¯è½¬æ¢ç»“æœ</span></span><br><span class="line">        <span class="type">BOOL</span> suc = [((<span class="type">id</span>&lt;YYModel&gt;)model) modelCustomTransformToDictionary:dic];</span><br><span class="line">        <span class="keyword">if</span> (!suc) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¢â€¦ä»£ç è¿˜æ˜¯æœ‰äº›é•¿ï¼Œä¸è¿‡ç›¸æ¯”äºä¹‹å‰ JSON to Model æ–¹å‘ä¸Šç”± <code>yy_modelSetWithDictionary</code>ï¼Œ<code>ModelSetWithDictionaryFunction</code> å’Œ <code>ModelSetValueForProperty</code> ä¸‰ä¸ªæ–¹æ³•æ„æˆçš„é—´æ¥é€’å½’æ¥è¯´ç®—æ˜¯éå¸¸ç®€å•äº†ï¼Œé‚£ä¹ˆæ€»ç»“ä¸€ä¸‹ä¸Šé¢çš„ä»£ç é€»è¾‘ã€‚</p>
<ul>
<li>åˆ¤æ–­å…¥å‚ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶å¯ä»¥ç›´æ¥è¿”å›</li>
<li>å¦‚æœ Model ä»å±äº NSTypeï¼Œåˆ™æ ¹æ®ä¸åŒçš„ç±»å‹åšé€»è¾‘å¤„ç†</li>
<li>å¦‚æœä¸Šé¢æ¡ä»¶ä¸è¢«æ»¡è¶³ï¼Œåˆ™ç”¨ Model çš„ Class åˆå§‹åŒ–ä¸€ä¸ªæ¨¡å‹å…ƒ _YYModelMeta</li>
<li>åˆ¤æ–­æ¨¡å‹å…ƒçš„æ˜ å°„å…³ç³»ï¼Œéå†æ˜ å°„è¡¨æ‹¿åˆ°å¯¹åº”é”®å€¼å¯¹å¹¶å­˜å…¥å­—å…¸ä¸­å¹¶è¿”å›</li>
</ul>
<blockquote>
<p>Note: è¿™é‡Œæœ‰ä¸€ä¸ªæ€§èƒ½ä¼˜åŒ–çš„ç»†èŠ‚ï¼Œç”¨ <code>__unsafe_unretained</code> ä¿®é¥°çš„ dic æŒ‡å‘æˆ‘ä»¬æœ€åè¦ return çš„ NSMutableDictionary *resultï¼Œçœ‹ä½œè€…çš„æ³¨é‡Šï¼š<code>// avoid retain and release in block</code> æ˜¯ä¸ºäº†é¿å…ç›´æ¥ä½¿ç”¨ <code>result</code> åœ¨åé¢éå†æ˜ å°„è¡¨çš„ä»£ç å—ä¸­ä¸å¿…è¦çš„ retain å’Œ release æ“ä½œä»¥èŠ‚çœå¼€é”€ã€‚</p>
</blockquote>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul>
<li>æ–‡ç« ç´§æ¥ä¸Šæ–‡<a href="https://lision.me/yymodel_x01/">ã€Šæ­ç§˜ YYModel çš„é­”æ³•ï¼ˆä¸Šï¼‰ã€‹</a>ä¸­å¯¹ YYModel ä»£ç ç»“æ„çš„è®²è§£åå°†é‡ç‚¹æ”¾åˆ°äº†å¯¹ JSON æ¨¡å‹ç›¸äº’è½¬æ¢çš„å®ç°é€»è¾‘ä¸Šã€‚</li>
<li>ä» JSON æ¨¡å‹çš„è½¬æ¢æ–¹å‘ä¸Šåˆ’åˆ†ï¼Œå°† YYModel çš„ JSON æ¨¡å‹è½¬æ¢è¿‡ç¨‹æ­£åæ–¹å‘å‰–ææ­ç§˜ï¼Œå¸Œæœ›å¯ä»¥è§£å¼€å¤§å®¶å¯¹ JSON æ¨¡å‹è‡ªåŠ¨è½¬æ¢çš„ç–‘æƒ‘ã€‚</li>
</ul>
<p>æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜ <a href="https://lision.me/">https://lision.me/</a>ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ <a href="https://lision.me/">ä¸ªäººåšå®¢</a> ä¸­æ›´æ–°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš <a target="_blank" rel="noopener" href="https://weibo.com/lisioncode">@Lision</a> è”ç³»æˆ‘~</p>
<p>å¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~</p>


    
    
    
	  <div class="tags">
      <a class="tag-none-link" href="/tags/yykit/" rel="tag">yykit</a><a class="tag-none-link" href="/tags/yymodel/" rel="tag">yymodel</a>
	  </div>
    

  </section>
</article>
  
</section>


  <nav id="page-nav">
    
    <a class="prev" rel="prev" href="/page/15/">
      <span class="icon icon-chevron-left"></span>
      <span class="text">Previous</span>
    </a>
    
    
    <a class="next" rel="next" href="/page/17/">
      <span class="text">Next</span>
      <span class="icon icon-chevron-right"></span>
    </a>
    
  </nav>
  

      <script>setLoadingBarProgress(60);</script>
    </main>
    
    <footer id="footer" class="clearfix">
  
  
	<div class="search">
	  <script>
      (function() {
        var cx = '001858749347000340533:drswradlp64';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
	</div>
	

	<div class="social-wrapper">
  	
      
        <a href="mailto:lisionmail@gmail.com" class="social email"
          target="_blank" rel="external">
          <span class="icon icon-email"></span>
        </a>
      
        <a href="https://github.com/Lision" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="https://twitter.com/LisionChat" class="social twitter"
          target="_blank" rel="external">
          <span class="icon icon-twitter"></span>
        </a>
      
        <a href="https://weibo.com/lisioncode" class="social sina-weibo"
          target="_blank" rel="external">
          <span class="icon icon-sina-weibo"></span>
        </a>
      
    
  </div>
  
  <div>Theme <span class="codename">Typescript</span> designed by <a href="http://rakugaki.me/" target="_blank">Art Chen</a>.</div>
  <div>&copy; <a href="/">èŠå®…</a></div>
  
</footer>


    <script>setLoadingBarProgress(80);</script>
    
  </div>

  
<script>
  var disqus_shortname = 'lision-me';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>




<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>window.jQuery || document.write('<script src="/js/jquery.min.js"><\/script>')</script>


<script src="/js/jquery.fitvids.js"></script>

<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "AIzaSyAMIoydL742ROhE6lLk9n3hT0pZwbrXD_I";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "001858749347000340533:drswradlp64";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "google";
</script>

<script src="/js/search.js"></script>


<script src="/js/app.js"></script>



  <script>setLoadingBarProgress(100);</script>
  
</body>
</html>
