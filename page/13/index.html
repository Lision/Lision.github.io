<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>èŠå®…</title>
  <meta name="description" content="ç¾éº—çš„å¤ªé™½ç…§å¸¸å‡èµ· è‹¦ç—›çš„äººå€‘ä¾èˆŠæ­‡æ–¯åº•è£" />
  <meta name="keywords" content="ios,objective-c,swift,python,javascript,otaku,lision" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="æ•²ä»£ç çš„ï¼Œæ¯”è¾ƒå®…çš„å†…ç§">
<meta property="og:type" content="website">
<meta property="og:title" content="èŠå®…">
<meta property="og:url" content="https://lision.me/page/13/index.html">
<meta property="og:site_name" content="èŠå®…">
<meta property="og:description" content="æ•²ä»£ç çš„ï¼Œæ¯”è¾ƒå®…çš„å†…ç§">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Lision">
<meta property="article:tag" content="ios,objective-c,swift,python,javascript,otaku,lision">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  

	<script src="https://use.typekit.net/eyf3hir.js"></script>
  <script>try{Typekit.load({ async: false });}catch(e){}</script>
  
<link rel="stylesheet" href="/style.css">

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
  
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=" + "UA-118743071-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-118743071-1');
</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>

  <script>setLoadingBarProgress(20)</script>
  
  <div id="site-wrapper">
    
    <header id="header">
	<div id="header-wrapper" class="clearfix">
		<a id="logo" href="/">
			<img src="/images/logo.png" />
			<span id="site-desc">
			  otaku's self-cultivation
      </span>
		</a>
		<button id="site-nav-switch">
	    <span class="icon icon-menu"></span>
	  </button>
	</div>
	<aside id="site-menu">
  	<nav>
  		
        <a href="/" class="nav-home nav">
          é¦–é¡µ
        </a>
      
        <a href="/archives" class="nav-archives nav">
          å½’æ¡£
        </a>
      
        <a target="_blank" rel="noopener" href="https://github.com/Lision" class="nav-about nav">
          å…³äº
        </a>
      
    </nav>
	</aside>
</header>
    <script>setLoadingBarProgress(40);</script>
    
    <main id="main" role="main">
      





<section class="post-list">
	
    <article class="post ">

  
  <h2 class="title">
    <a href="/aspects/">
      ä» Aspects æºç ä¸­æˆ‘å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ
    </a>
  </h2>
  
  <time>
    1æœˆ 17, 2018
  </time>
  <section class="content">
	  <img src="/aspects/aspects.jpg" class="">
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Aspect-oriented_programming">AOP (Aspect-oriented programming)</a> è¯‘ä¸º â€œé¢å‘åˆ‡é¢ç¼–ç¨‹â€ï¼Œæ˜¯é€šè¿‡é¢„ç¼–è¯‘æ–¹å¼å’Œè¿è¡ŒæœŸåŠ¨æ€ä»£ç†å®ç°ç¨‹åºåŠŸèƒ½ç»Ÿä¸€ç»´æŠ¤çš„ä¸€ç§æŠ€æœ¯ã€‚åˆ©ç”¨ AOP å¯ä»¥å¯¹ä¸šåŠ¡é€»è¾‘çš„å„ä¸ªéƒ¨åˆ†è¿›è¡Œéš”ç¦»ï¼Œä»è€Œä½¿å¾—ä¸šåŠ¡é€»è¾‘å„éƒ¨åˆ†ä¹‹é—´çš„è€¦åˆåº¦é™ä½ï¼Œæé«˜ç¨‹åºçš„å¯é‡ç”¨æ€§ï¼ŒåŒæ—¶æé«˜äº†å¼€å‘çš„æ•ˆç‡ã€‚</p>
<p>Emmmmmâ€¦AOP ç›®å‰æ˜¯è¾ƒä¸ºçƒ­é—¨çš„ä¸€ä¸ªè¯é¢˜ï¼Œå°½ç®¡ä½ ä¹Ÿè®¸æ²¡æœ‰å¬è¯´è¿‡å®ƒï¼Œä½†æ˜¯ä½ çš„é¡¹ç›®ä¸­å¯èƒ½å·²ç»æ¸—å…¥äº†å®ƒï¼Œä¾‹å¦‚ï¼šç”¨æˆ·ç»Ÿè®¡ï¼ˆä¸æ·»åŠ ä¸€è¡Œä»£ç å³å®ç°å¯¹æ‰€æœ‰ ViewController çš„è·Ÿè¸ªæ—¥å¿—ï¼‰ã€‚</p>
<p>å¯¹äº iOS å¼€å‘è€…è€Œè¨€ï¼Œæ— å¤–ä¹ Swift å’Œ Objective-C ä¸¤ç§ä¸»æµå¼€å‘è¯­è¨€ï¼š</p>
<ul>
<li>Swift å—é™äº ABI å°šæœªç¨³å®šï¼ŒåŠ¨æ€æ€§ä¾èµ– <code>dynamic</code> ä¿®é¥°ç¬¦ï¼Œåœ¨ Runtime æ²¡æœ‰ç•™ç»™æˆ‘ä»¬å¤ªå¤šçš„å‘æŒ¥ç©ºé—´ï¼ˆå‰å‡ æ—¥æ–°å¢äº† <code>swift-5.0-branch</code> åˆ†æ”¯ï¼Œå†™è¿™ç¯‡æ–‡ç« æ—¶çœ‹äº†ä¸€çœ¼ <code>181 commits behind master</code> ğŸ˜‚ï¼‰ã€‚</li>
<li>Objective-C åœ¨åŠ¨æ€æ€§ä¸Šç›¸å¯¹ Swift å…·æœ‰æ— é™å¤§çš„ä¼˜åŠ¿ï¼Œè¿™å‡ å¹´ Objective-C Runtime ç›¸å…³æ–‡ç« å¤šå¦‚ç‰›æ¯›ï¼Œç›¸ä¿¡ç°åœ¨çš„ iOSer éƒ½å…·å¤‡ä¸€å®šçš„ Runtime ç›¸å…³çŸ¥è¯†ã€‚</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/steipete/Aspects">Aspects</a> ä½œä¸º Objective-C è¯­è¨€ç¼–å†™çš„ AOP åº“ï¼Œé€‚ç”¨äº iOS å’Œ Mac OS Xï¼Œä½¿ç”¨ä½“éªŒç®€å•æ„‰å¿«ï¼Œå·²ç»åœ¨ GitHub æ‘˜å¾— 5k+ Starã€‚Aspects å†…éƒ¨å®ç°æ¯”è¾ƒå¥å…¨ï¼Œè€ƒè™‘åˆ°äº† Hook å®‰å…¨æ–¹é¢å¯èƒ½å‘ç”Ÿçš„ç§ç§é—®é¢˜ï¼Œéå¸¸å€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚</p>
<blockquote>
<p>Note: æœ¬æ–‡å†…å¼•ç”¨ Aspects æºç ç‰ˆæœ¬ä¸º v1.4.2ï¼Œè¦æ±‚è¯»è€…å…·å¤‡ä¸€å®šçš„ Runtime çŸ¥è¯†ã€‚</p>
</blockquote>
<h2 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h2><ul>
<li>AOP ç®€ä»‹</li>
<li>Aspects ç®€ä»‹</li>
<li>Aspects ç»“æ„å‰–æ</li>
<li>Aspects æ ¸å¿ƒä»£ç å‰–æ</li>
<li>ä¼˜ç§€ AOP åº“åº”è¯¥å…·å¤‡çš„ç‰¹è´¨</li>
<li>æ€»ç»“</li>
</ul>
<h2 id="AOP-ç®€ä»‹"><a href="#AOP-ç®€ä»‹" class="headerlink" title="AOP ç®€ä»‹"></a>AOP ç®€ä»‹</h2><img src="/aspects/aop.jpg" class="">
<blockquote>
<p>åœ¨<strong>è¿è¡Œæ—¶ï¼ŒåŠ¨æ€åœ°</strong>å°†ä»£ç åˆ‡å…¥åˆ°ç±»çš„æŒ‡å®šæ–¹æ³•ã€æŒ‡å®šä½ç½®ä¸Šçš„ç¼–ç¨‹æ€æƒ³å°±æ˜¯é¢å‘åˆ‡é¢çš„ç¼–ç¨‹ã€‚</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Aspect-oriented_programming">AOP (Aspect-oriented programming)</a>ï¼Œå³ â€œé¢å‘åˆ‡é¢ç¼–ç¨‹â€ æ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œæˆ–è€…è¯´æ˜¯ä¸€ç§ç¼–ç¨‹æ€æƒ³ï¼Œå®ƒè§£å†³äº† <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Object-oriented_programming">OOP (Object-oriented programming)</a> çš„å»¶ä¼¸é—®é¢˜ã€‚</p>
<h3 id="ä»€ä¹ˆæ—¶å€™éœ€è¦ä½¿ç”¨-AOP"><a href="#ä»€ä¹ˆæ—¶å€™éœ€è¦ä½¿ç”¨-AOP" class="headerlink" title="ä»€ä¹ˆæ—¶å€™éœ€è¦ä½¿ç”¨ AOP"></a>ä»€ä¹ˆæ—¶å€™éœ€è¦ä½¿ç”¨ AOP</h3><p>å…‰æ˜¯ç»™ä¸ªæ¦‚å¿µå¯èƒ½åˆæ¬¡æ¥è§¦ AOP çš„äººè¿˜æ˜¯æ— æ³• Get åˆ°å…¶ä¸­å¾®ç§’ï¼Œæ‹¿æˆ‘ä»¬å‰è¨€ä¸­ä¸¾çš„ä¾‹å­ğŸŒ°ï¼Œå‡è®¾éšç€æˆ‘ä»¬æ‰€åœ¨çš„å…¬å¸é€æ­¥å‘å±•ï¼Œä¹‹å‰ç¬¬ä¸‰æ–¹çš„ç”¨æˆ·é¡µé¢ç»Ÿè®¡å·²ç»ä¸èƒ½æ»¡è¶³éœ€æ±‚äº†ï¼Œå…¬å¸è¦æ±‚å®ç°ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±çš„ç”¨æˆ·é¡µé¢ç»Ÿè®¡ã€‚</p>
<p>å˜›~ æˆ‘ä»¬æ¥ç†ä¸€ä¸‹ OOP æ€æƒ³ä¸‹è¯¥æ€ä¹ˆåŠï¼Ÿ</p>
<ul>
<li>ä¸€ä¸ªç†Ÿæ‚‰ OOP æ€æƒ³çš„ç¨‹åºçŒ¿ä¼šç†æ‰€åº”å½“çš„æƒ³åˆ°è¦æŠŠç”¨æˆ·é¡µé¢ç»Ÿè®¡è¿™ä¸€ä»»åŠ¡æ”¾åˆ° ViewController ä¸­ï¼›</li>
<li>è€ƒè™‘åˆ°ä¸€ä¸ªä¸ªçš„æ‰‹åŠ¨æ·»åŠ ç»Ÿè®¡ä»£ç è¦æ­»äººï¼ˆè€Œä¸”è¿˜ä¼šæ¼ï¼Œä»¥åæ–°å¢ ViewController ä¹Ÿè¦æ‰‹åŠ¨åŠ ï¼‰ï¼Œäºæ˜¯æƒ³åˆ°äº† OOP æ€æƒ³ä¸­çš„ç»§æ‰¿ï¼›</li>
<li>ä¸å·§ç”±äºé¡¹ç›®ä¹…è¿œï¼Œæ‰€æœ‰çš„ ViewController éƒ½æ˜¯ç›´æ¥ç»§æ‰¿è‡ªç³»ç»Ÿç±» UIViewControllerï¼ˆç¬‘ï¼‰ï¼Œæ­¤æ—¶é€‰æ‹©æŠ½ä¸€ä¸ªé¡¹ç›® RootViewControllerï¼Œæ›¿æ¢æ‰€æœ‰ ViewController ç»§æ‰¿ RootViewControllerï¼›</li>
<li>ç„¶ååœ¨ RootViewController çš„ <code>viewWillAppear:</code> å’Œ <code>viewWillDisappear:</code> æ–¹æ³•åŠ å…¥æ—¶é—´ç»Ÿè®¡ä»£ç ï¼Œè®°å½• ViewController ä»¥åŠ Router ä¼ å‚ã€‚</li>
</ul>
<p>ä½ ä¼šæƒ³ï¼Œæ˜æ˜ OOP ä¹Ÿèƒ½è§£å†³é—®é¢˜æ˜¯ä¸æ˜¯ï¼Ÿä¸è¦æ€¥ï¼Œå†å‡è®¾ä½ ä»¬å…¬å¸æœ‰å¤šä¸ª Appï¼Œä½ è¢«æŠ½è°ƒè‡³åŸºç¡€æŠ€æœ¯ç»„ä¸“é—¨ç»™è¿™äº› App å†™<strong>é€šç”¨</strong>ç»„ä»¶ï¼Œè¦æŠŠä¹‹å‰å®ç°è¿‡çš„ç”¨æˆ·é¡µé¢ç»Ÿè®¡é‡æ–°ä»¥<strong>é€šç”¨</strong>çš„å½¢å¼å®ç°ï¼Œæä¾›ç»™ä½ ä»¬å…¬å¸æ‰€æœ‰çš„ App ä½¿ç”¨ã€‚</p>
<p>MMPï¼Œä½¿ç”¨æ ‡å‡† OOP æ€æƒ³è²Œä¼¼æ— è§£å•Šâ€¦è¿™ä¸ªæ—¶å€™å°±æ˜¯ AOP çš„ç”¨æ­¦ä¹‹åœ°äº†ã€‚</p>
<p>è¿™é‡Œç®€å•ç»™ä¸ªæ€è·¯ï¼šHook UIViewController çš„ <code>viewWillAppear:</code> å’Œ <code>viewWillDisappear:</code> æ–¹æ³•ï¼Œåœ¨åŸæ–¹æ³•æ‰§è¡Œä¹‹åè®°å½•éœ€è¦ç»Ÿè®¡çš„ä¿¡æ¯ä¸ŠæŠ¥å³å¯ã€‚</p>
<blockquote>
<p>Note: ç®€å•é€šè¿‡ Method Swizzling æ¥ Hook ä¸æ˜¯ä¸å¯ä»¥ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šå®‰å…¨éšæ‚£ï¼</p>
</blockquote>
<h2 id="Aspects-ç®€ä»‹"><a href="#Aspects-ç®€ä»‹" class="headerlink" title="Aspects ç®€ä»‹"></a>Aspects ç®€ä»‹</h2><img src="/aspects/aspects_logo.jpg" class="">
<p><a target="_blank" rel="noopener" href="https://github.com/steipete/Aspects">Aspects</a> æ˜¯ä¸€ä¸ªä½¿ç”¨èµ·æ¥ç®€å•æ„‰å¿«çš„ AOP åº“ï¼Œä½¿ç”¨ Objective-C ç¼–å†™ï¼Œé€‚ç”¨äº iOS ä¸ Mac OS Xã€‚</p>
<blockquote>
<p>Aspects å†…éƒ¨å®ç°è€ƒè™‘åˆ°äº†å¾ˆå¤š Hook å¯èƒ½å¼•å‘çš„é—®é¢˜ï¼Œç¬”è€…åœ¨çœ‹æºç çš„è¿‡ç¨‹ä¸­æŠ çš„æ¯”è¾ƒç»†ï¼ŒçœŸçš„æ˜¯å—ç›ŠåŒªæµ…ã€‚</p>
</blockquote>
<p>Aspects ç®€å•æ˜“ç”¨ï¼Œä½œè€…é€šè¿‡åœ¨ <code>NSObject (Aspects)</code> åˆ†ç±»ä¸­æš´éœ²å‡ºçš„ä¸¤ä¸ªæ¥å£åˆ†åˆ«æä¾›äº†å¯¹å®ä¾‹å’Œ Class çš„ Hook å®ç°ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">Aspects</span>)</span></span><br><span class="line"></span><br><span class="line">+ (<span class="type">id</span>&lt;AspectToken&gt;)aspect_hookSelector:(SEL)selector</span><br><span class="line">                      withOptions:(AspectOptions)options</span><br><span class="line">                       usingBlock:(<span class="type">id</span>)block</span><br><span class="line">                            error:(<span class="built_in">NSError</span> **)error;</span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>&lt;AspectToken&gt;)aspect_hookSelector:(SEL)selector</span><br><span class="line">                      withOptions:(AspectOptions)options</span><br><span class="line">                       usingBlock:(<span class="type">id</span>)block</span><br><span class="line">                            error:(<span class="built_in">NSError</span> **)error;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>Aspects æ”¯æŒå®ä¾‹ Hookï¼Œç›¸è¾ƒå…¶ä»– Objective-C AOP åº“è€Œè¨€å¯æ“ä½œç²’åº¦æ›´å°ï¼Œé€‚åˆçš„åœºæ™¯æ›´åŠ å¤šæ ·åŒ–ã€‚ä½œä¸ºä½¿ç”¨è€…æ— éœ€è¿›è¡Œæ›´å¤šçš„æ“ä½œå³å¯ Hook æŒ‡å®šå®ä¾‹æˆ–è€… Class çš„æŒ‡å®š SELï¼ŒAspectOptions å‚æ•°å¯ä»¥æŒ‡å®š Hook çš„ç‚¹ï¼Œä»¥åŠæ˜¯å¦æ‰§è¡Œä¸€æ¬¡ä¹‹åå°±æ’¤é”€ Hookã€‚</p>
<h2 id="Aspects-ç»“æ„å‰–æ"><a href="#Aspects-ç»“æ„å‰–æ" class="headerlink" title="Aspects ç»“æ„å‰–æ"></a>Aspects ç»“æ„å‰–æ</h2><img src="/aspects/aspects_struct.png" class="">
<p>Emmmmmâ€¦å°½ç®¡ Aspects åªæœ‰ä¸åˆ°åƒè¡Œçš„æºç ï¼Œä½†æ˜¯å…¶å†…éƒ¨å®ç°è€ƒè™‘åˆ°äº†å¾ˆå¤š Hook ç›¸å…³çš„å®‰å…¨é—®é¢˜å’Œå…¶ä»–ç»†èŠ‚ï¼Œå¯¹æ¯”å…¶ä»– Objective-C AOP å¼€æºé¡¹ç›®æ¥è¯´ Aspects æ›´ä¸ºå¥å…¨ï¼Œæ‰€ä»¥æˆ‘è‡ªå·±åœ¨æ‰’ Aspects æºç æ—¶ä¹Ÿçœ‹çš„æ¯”è¾ƒä»”ç»†ã€‚</p>
<h3 id="Aspects-å†…éƒ¨ç»“æ„"><a href="#Aspects-å†…éƒ¨ç»“æ„" class="headerlink" title="Aspects å†…éƒ¨ç»“æ„"></a>Aspects å†…éƒ¨ç»“æ„</h3><p>Aspects å†…éƒ¨å®šä¹‰äº†ä¸¤ä¸ªåè®®ï¼š</p>
<ul>
<li>AspectToken - ç”¨äºæ³¨é”€ Hook</li>
<li>AspectInfo - åµŒå…¥ Hook ä¸­çš„ Block é¦–ä½å‚æ•°</li>
</ul>
<p>æ­¤å¤– Aspects å†…éƒ¨è¿˜å®šä¹‰äº† 4 ä¸ªç±»ï¼š</p>
<ul>
<li>AspectInfo - åˆ‡é¢ä¿¡æ¯ï¼Œéµå¾ª AspectInfo åè®®</li>
<li>AspectIdentifier - åˆ‡é¢ IDï¼Œ<strong>åº”è¯¥</strong>éµå¾ª AspectToken åè®®ï¼ˆä½œè€…æ¼æ‰äº†ï¼Œå·²æ PRï¼‰</li>
<li>AspectsContainer - åˆ‡é¢å®¹å™¨</li>
<li>AspectTracker - åˆ‡é¢è·Ÿè¸ªå™¨</li>
</ul>
<p>ä»¥åŠä¸€ä¸ªç»“æ„ä½“ï¼š</p>
<ul>
<li>AspectBlockRef - å³ <code>_AspectBlock</code>ï¼Œå……å½“å†…éƒ¨ Block</li>
</ul>
<p>å¦‚æœä½ æ‰’ä¸€éæºç ï¼Œè¿˜ä¼šå‘ç°ä¸¤ä¸ªå†…éƒ¨é™æ€å…¨å±€å˜é‡ï¼š</p>
<ul>
<li><code>static NSMutableDictionary *swizzledClassesDict;</code></li>
<li><code>static NSMutableSet *swizzledClasses;</code></li>
</ul>
<p>ç°åœ¨ä½ ä¹Ÿè®¸è¿˜ä¸èƒ½ç†è§£ä¸ºä»€ä¹ˆè¦å®šä¹‰è¿™ä¹ˆå¤šä¸œè¥¿ï¼Œåˆ«æ€¥~ æˆ‘ä»¬åé¢éƒ½ä¼šåˆ†æåˆ°ã€‚</p>
<h3 id="Aspects-åè®®"><a href="#Aspects-åè®®" class="headerlink" title="Aspects åè®®"></a>Aspects åè®®</h3><p>æŒ‰ç…§ä¸Šé¢åˆ—å‡ºçš„é¡ºåºï¼Œå…ˆæ¥ä»‹ç»ä¸€äº› Aspects å£°æ˜çš„åè®®ã€‚</p>
<h4 id="AspectToken"><a href="#AspectToken" class="headerlink" title="AspectToken"></a>AspectToken</h4><p>AspectToken åè®®æ—¨åœ¨è®©ä½¿ç”¨è€…å¯ä»¥çµæ´»çš„æ³¨é”€ä¹‹å‰æ·»åŠ è¿‡çš„ Hookï¼Œå†…éƒ¨è§„å®šéµå®ˆæ­¤åè®®çš„å¯¹è±¡é¡»å®ç° <code>remove</code> æ–¹æ³•ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// ä¸é€æ˜çš„ Aspect Tokenï¼Œç”¨äºæ³¨é”€ Hook</span></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">AspectToken</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// æ³¨é”€ä¸€ä¸ª aspect.</span></span><br><span class="line"><span class="comment">/// è¿”å› YES è¡¨ç¤ºæ³¨é”€æˆåŠŸï¼Œå¦åˆ™è¿”å› NO</span></span><br><span class="line">- (<span class="type">BOOL</span>)remove;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h4 id="AspectInfo"><a href="#AspectInfo" class="headerlink" title="AspectInfo"></a>AspectInfo</h4><p>AspectInfo åè®®æ—¨åœ¨è§„èŒƒå¯¹ä¸€ä¸ªåˆ‡é¢ï¼Œå³ aspect çš„ Hook å†…éƒ¨ä¿¡æ¯çš„çº°æ¼ï¼Œæˆ‘ä»¬åœ¨ Hook æ—¶æ·»åŠ åˆ‡é¢çš„ Block ç¬¬ä¸€ä¸ªå‚æ•°å°±éµå®ˆæ­¤åè®®ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// AspectInfo åè®®æ˜¯æˆ‘ä»¬å—è¯­æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚</span></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">AspectInfo</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// å½“å‰è¢« Hook çš„å®ä¾‹</span></span><br><span class="line">- (<span class="type">id</span>)instance;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// è¢« Hook æ–¹æ³•çš„åŸå§‹ invocation</span></span><br><span class="line">- (<span class="built_in">NSInvocation</span> *)originalInvocation;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// æ‰€æœ‰æ–¹æ³•å‚æ•°ï¼ˆè£…ç®±ä¹‹åçš„ï¼‰æƒ°æ€§æ‰§è¡Œ</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)arguments;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: è£…ç®±æ˜¯ä¸€ä¸ªå¼€é”€æ˜‚è´µæ“ä½œï¼Œæ‰€ä»¥ç”¨åˆ°å†å»æ‰§è¡Œã€‚</p>
</blockquote>
<h3 id="Aspects-å†…éƒ¨ç±»"><a href="#Aspects-å†…éƒ¨ç±»" class="headerlink" title="Aspects å†…éƒ¨ç±»"></a>Aspects å†…éƒ¨ç±»</h3><p>æ¥ç€åè®®ï¼Œæˆ‘ä»¬ä¸‹é¢è¯¦ç»†ä»‹ç»ä¸€ä¸‹ Aspects çš„å†…éƒ¨ç±»ã€‚</p>
<h4 id="AspectInfo-1"><a href="#AspectInfo-1" class="headerlink" title="AspectInfo"></a>AspectInfo</h4><blockquote>
<p>Note: AspectInfo åœ¨è¿™é‡Œæ˜¯ä¸€ä¸ª Classï¼Œå…¶éµå®ˆä¸Šæ–‡ä¸­è®²åˆ°çš„ AspectInfo åè®®ï¼Œä¸è¦æ··æ·†ã€‚</p>
</blockquote>
<p>AspectInfo ç±»å®šä¹‰ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AspectInfo</span> : <span class="title">NSObject</span> &lt;<span class="title">AspectInfo</span>&gt;</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>)initWithInstance:(__<span class="keyword">unsafe_unretained</span> <span class="type">id</span>)instance invocation:(<span class="built_in">NSInvocation</span> *)invocation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">unsafe_unretained</span>, <span class="keyword">readonly</span>) <span class="type">id</span> instance;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span> *arguments;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSInvocation</span> *originalInvocation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: å…³äºè£…ç®±ï¼Œå¯¹äºæä¾›ä¸€ä¸ª NSInvocation å°±å¯ä»¥æ‹¿åˆ°å…¶ <code>arguments</code> è¿™ä¸€ç‚¹ä¸Šï¼ŒReactiveCocoa å›¢é˜Ÿæä¾›äº†å¾ˆå¤§è´¡çŒ®ï¼ˆç»†èŠ‚è§ Aspects å†…éƒ¨ NSInvocation åˆ†ç±»ï¼‰ã€‚</p>
</blockquote>
<p>AspectInfo æ¯”è¾ƒç®€å•ï¼Œå‚è€ƒ ReactiveCocoa å›¢é˜Ÿæä¾›çš„ NSInvocation å‚æ•°é€šç”¨æ–¹æ³•å¯å°†å‚æ•°è£…ç®±ä¸º NSValueï¼Œç®€å•æ¥è¯´ AspectInfo æ‰®æ¼”äº†ä¸€ä¸ªæä¾› Hook ä¿¡æ¯çš„è§’è‰²ã€‚</p>
<h4 id="AspectIdentifier"><a href="#AspectIdentifier" class="headerlink" title="AspectIdentifier"></a>AspectIdentifier</h4><p>AspectIdentifier ç±»å®šä¹‰ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AspectIdentifier</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)identifierWithSelector:(SEL)selector object:(<span class="type">id</span>)object options:(AspectOptions)options block:(<span class="type">id</span>)block error:(<span class="built_in">NSError</span> **)error;</span><br><span class="line"></span><br><span class="line">- (<span class="type">BOOL</span>)invokeWithInfo:(<span class="type">id</span>&lt;AspectInfo&gt;)info;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) SEL selector;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="type">id</span> block;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMethodSignature</span> *blockSignature;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="type">id</span> object;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) AspectOptions options;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: AspectIdentifier å®é™…ä¸Šæ˜¯æ·»åŠ åˆ‡é¢çš„ Block çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå…¶åº”è¯¥éµå¾ª AspectToken åè®®ï¼Œäº‹å®ä¸Šä¹Ÿçš„ç¡®å¦‚æ­¤ï¼Œå…¶æä¾›äº† <code>remove</code> æ–¹æ³•çš„å®ç°ã€‚</p>
</blockquote>
<p>AspectIdentifier å†…éƒ¨éœ€è¦æ³¨æ„çš„æ˜¯ç”±äºä½¿ç”¨ Block æ¥å†™ Hook ä¸­æˆ‘ä»¬åŠ çš„æ–™ï¼Œè¿™é‡Œç”Ÿæˆäº† <code>blockSignature</code>ï¼Œåœ¨ AspectIdentifier åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ä¼šå»åˆ¤æ–­ <code>blockSignature</code> ä¸å…¥å‚ <code>object</code> çš„ <code>selector</code> å¾—åˆ°çš„ <code>methodSignature</code> çš„å…¼å®¹æ€§ï¼Œå…¼å®¹æ€§åˆ¤æ–­æˆåŠŸæ‰ä¼šé¡ºåˆ©åˆå§‹åŒ–ã€‚</p>
<h4 id="AspectsContainer"><a href="#AspectsContainer" class="headerlink" title="AspectsContainer"></a>AspectsContainer</h4><p>AspectsContainer ç±»å®šä¹‰ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AspectsContainer</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)addAspect:(AspectIdentifier *)aspect withOptions:(AspectOptions)injectPosition;</span><br><span class="line">- (<span class="type">BOOL</span>)removeAspect:(<span class="type">id</span>)aspect;</span><br><span class="line">- (<span class="type">BOOL</span>)hasAspects;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (atomic, <span class="keyword">copy</span>) <span class="built_in">NSArray</span> *beforeAspects;</span><br><span class="line"><span class="keyword">@property</span> (atomic, <span class="keyword">copy</span>) <span class="built_in">NSArray</span> *insteadAspects;</span><br><span class="line"><span class="keyword">@property</span> (atomic, <span class="keyword">copy</span>) <span class="built_in">NSArray</span> *afterAspects;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>AspectsContainer ä½œä¸ºåˆ‡é¢çš„å®¹å™¨ç±»ï¼Œ<strong>å…³è”</strong>æŒ‡å®šå¯¹è±¡çš„æŒ‡å®šæ–¹æ³•ï¼Œå†…éƒ¨æœ‰ä¸‰ä¸ªåˆ‡é¢é˜Ÿåˆ—ï¼Œåˆ†åˆ«å®¹çº³å…³è”æŒ‡å®šå¯¹è±¡çš„æŒ‡å®šæ–¹æ³•ä¸­ç›¸å¯¹åº” AspectOption çš„ Hookï¼š</p>
<ul>
<li><code>NSArray *beforeAspects;</code> - AspectPositionBefore</li>
<li><code>NSArray *insteadAspects;</code> - AspectPositionInstead</li>
<li><code>NSArray *afterAspects;</code> - AspectPositionAfter</li>
</ul>
<p>ä¸ºä»€ä¹ˆè¦è¯´å…³è”å‘¢ï¼Ÿå› ä¸º AspectsContainer æ˜¯åœ¨ NSObject åˆ†ç±»ä¸­é€šè¿‡ AssociatedObject æ–¹æ³•ä¸å½“å‰è¦ Hook çš„ç›®æ ‡å…³è”åœ¨ä¸€èµ·çš„ã€‚</p>
<blockquote>
<p>Note: å…³è”ç›®æ ‡æ˜¯ Hook ä¹‹åçš„ Selectorï¼Œå³ <code>aliasSelector</code>ï¼ˆåŸå§‹ SEL åç§°åŠ  <code>aspects_</code> å‰ç¼€å¯¹åº”çš„ SELï¼‰ã€‚</p>
</blockquote>
<h4 id="AspectTracker"><a href="#AspectTracker" class="headerlink" title="AspectTracker"></a>AspectTracker</h4><p>AspectTracker ç±»å®šä¹‰ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AspectTracker</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>)initWithTrackedClass:(Class)trackedClass parent:(AspectTracker *)parent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Class trackedClass;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableSet</span> *selectorNames;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) AspectTracker *parentEntry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>AspectTracker ä½œä¸ºåˆ‡é¢è¿½è¸ªå™¨ï¼ŒåŸç†å¤§è‡´å¦‚ä¸‹ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add the selector as being modified.</span></span><br><span class="line">currentClass = klass;</span><br><span class="line">AspectTracker *parentTracker = <span class="literal">nil</span>;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    AspectTracker *tracker = swizzledClassesDict[currentClass];</span><br><span class="line">    <span class="keyword">if</span> (!tracker) &#123;</span><br><span class="line">        tracker = [[AspectTracker alloc] initWithTrackedClass:currentClass parent:parentTracker];</span><br><span class="line">        swizzledClassesDict[(<span class="type">id</span>&lt;<span class="built_in">NSCopying</span>&gt;)currentClass] = tracker;</span><br><span class="line">    &#125;</span><br><span class="line">    [tracker.selectorNames addObject:selectorName];</span><br><span class="line">    <span class="comment">// All superclasses get marked as having a subclass that is modified.</span></span><br><span class="line">    parentTracker = tracker;</span><br><span class="line">&#125;<span class="keyword">while</span> ((currentClass = class_getSuperclass(currentClass)));</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: èªæ˜çš„ä½ åº”è¯¥å·²ç»æ³¨æ„åˆ°äº†å…¨å±€å˜é‡ <code>swizzledClassesDict</code> ä¸­çš„ <code>value</code> å¯¹åº”ç€ AspectTracker æŒ‡é’ˆã€‚</p>
</blockquote>
<p>å˜›~ å°±æ˜¯è¯´ AspectTracker æ˜¯ä»ä¸‹è€Œä¸Šè¿½è¸ªï¼Œæœ€åº•å±‚çš„ <code>parentEntry</code> ä¸º <code>nil</code>ï¼Œçˆ¶ç±»çš„ <code>parentEntry</code> ä¸ºå­ç±»çš„ <code>tracker</code>ã€‚</p>
<h3 id="Aspects-å†…éƒ¨ç»“æ„ä½“"><a href="#Aspects-å†…éƒ¨ç»“æ„ä½“" class="headerlink" title="Aspects å†…éƒ¨ç»“æ„ä½“"></a>Aspects å†…éƒ¨ç»“æ„ä½“</h3><h4 id="AspectBlockRef"><a href="#AspectBlockRef" class="headerlink" title="AspectBlockRef"></a>AspectBlockRef</h4><p>AspectBlockRefï¼Œå³ <code>struct _AspectBlock</code>ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _AspectBlock &#123;</span><br><span class="line">	__unused Class isa;</span><br><span class="line">	AspectBlockFlags flags;</span><br><span class="line">	__unused <span class="type">int</span> reserved;</span><br><span class="line">	<span class="type">void</span> (__unused *invoke)(<span class="keyword">struct</span> _AspectBlock *block, ...);</span><br><span class="line">	<span class="keyword">struct</span> &#123;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span> reserved;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span> size;</span><br><span class="line">		<span class="comment">// requires AspectBlockFlagsHasCopyDisposeHelpers</span></span><br><span class="line">		<span class="type">void</span> (*<span class="keyword">copy</span>)(<span class="type">void</span> *dst, <span class="keyword">const</span> <span class="type">void</span> *src);</span><br><span class="line">		<span class="type">void</span> (*dispose)(<span class="keyword">const</span> <span class="type">void</span> *);</span><br><span class="line">		<span class="comment">// requires AspectBlockFlagsHasSignature</span></span><br><span class="line">		<span class="keyword">const</span> <span class="type">char</span> *signature;</span><br><span class="line">		<span class="keyword">const</span> <span class="type">char</span> *layout;</span><br><span class="line">	&#125; *descriptor;</span><br><span class="line">	<span class="comment">// imported variables</span></span><br><span class="line">&#125; *AspectBlockRef;</span><br></pre></td></tr></table></figure>
<p>Emmmmmâ€¦æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œå¤§å®¶åº”è¯¥æ¯”è¾ƒçœ¼ç†Ÿå§ã€‚</p>
<blockquote>
<p>Note: <code>__unused</code> å®å®šä¹‰å®é™…ä¸Šæ˜¯ <code>__attribute__((unused))</code> GCC å®šè¯­ï¼Œæ—¨åœ¨å‘Šè¯‰ç¼–è¯‘å™¨â€œå¦‚æœæˆ‘æ²¡æœ‰åœ¨åé¢ä½¿ç”¨åˆ°è¿™ä¸ªå˜é‡ä¹Ÿåˆ«è­¦å‘Šæˆ‘â€ã€‚</p>
</blockquote>
<p>å˜›~ æƒ³èµ·ä¹‹å‰è‡ªå·±æŒ–çš„å‘è¿˜æ²¡æœ‰å¡«ï¼Œäº‹å®ä¸Šè‡ªå·±ä¹Ÿä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™å¡«ï¼ˆç¬‘ï¼‰ï¼š</p>
<ul>
<li>ä¹‹å‰æŒ–å‘è¯´è¦å†™ä¸€ç¯‡æ–‡ç« è®°å½•ä¸€äº›é˜…è¯»æºç æ—¶å‘ç°çš„ä»£ç ä¹¦å†™æŠ€å·§</li>
<li>ä¹‹å‰æŒ–å‘è¯´è¦å°è£…ä¸€ä¸ª WKWebView ç»™ç¾¤é‡Œçš„å…„å¼Ÿå‚è€ƒ</li>
</ul>
<p>ä¸è¦æ€¥~ ä½ ç§ä¼¦å®¶ä¸æ˜¯éƒ½è®°å¾—å˜›ï¼ˆè‡³äºä»€ä¹ˆæ—¶å€™å¡«å‘å˜›å°±â€¦å’³å’³ï¼‰</p>
<h3 id="Aspects-é™æ€å…¨å±€å˜é‡"><a href="#Aspects-é™æ€å…¨å±€å˜é‡" class="headerlink" title="Aspects é™æ€å…¨å±€å˜é‡"></a>Aspects é™æ€å…¨å±€å˜é‡</h3><h4 id="static-NSMutableDictionary-swizzledClassesDict"><a href="#static-NSMutableDictionary-swizzledClassesDict" class="headerlink" title="static NSMutableDictionary *swizzledClassesDict;"></a><code>static NSMutableDictionary *swizzledClassesDict;</code></h4><p><code>static NSMutableDictionary *swizzledClassesDict;</code> åœ¨ Aspects ä¸­æ‰®æ¼”ç€å·²æ··å†™ç±»å­—å…¸çš„è§’è‰²ï¼Œå…¶å†…éƒ¨ç»“æ„åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Class : AspectTracker *&gt;</span><br></pre></td></tr></table></figure>
<p>Aspects å†…éƒ¨æä¾›äº†ä¸“é—¨è®¿é—®è¿™ä¸ªå…¨å±€å­—å…¸çš„æ–¹æ³•ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">NSMutableDictionary</span> *aspect_getSwizzledClassesDict() &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSMutableDictionary</span> *swizzledClassesDict;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> pred;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;pred, ^&#123;</span><br><span class="line">        swizzledClassesDict = [<span class="built_in">NSMutableDictionary</span> new];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> swizzledClassesDict;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå…¨å±€å˜é‡å¯ä»¥ç®€å•ç†è§£ä¸ºè®°å½•æ•´ä¸ª Hook å½±å“çš„ Class åŒ…å«å…¶ SuperClass çš„è¿½è¸ªè®°å½•çš„å…¨å±€å­—å…¸ã€‚</p>
<h4 id="static-NSMutableSet-swizzledClasses"><a href="#static-NSMutableSet-swizzledClasses" class="headerlink" title="static NSMutableSet *swizzledClasses;"></a><code>static NSMutableSet *swizzledClasses;</code></h4><p><code>static NSMutableSet *swizzledClasses;</code> åœ¨ Aspects ä¸­æ‹…å½“è®°å½•å·²æ··å†™ç±»çš„è§’è‰²ï¼Œå…¶å†…éƒ¨ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">NSStringFromClass</span>(Class)&gt;</span><br></pre></td></tr></table></figure>
<p>Aspects å†…éƒ¨æä¾›ä¸€ä¸ªç”¨äºä¿®æ”¹è¿™ä¸ªå…¨å±€å˜é‡å†…å®¹çš„æ–¹æ³•ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">void</span> _aspect_modifySwizzledClasses(<span class="type">void</span> (^block)(<span class="built_in">NSMutableSet</span> *swizzledClasses)) &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSMutableSet</span> *swizzledClasses;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> pred;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;pred, ^&#123;</span><br><span class="line">        swizzledClasses = [<span class="built_in">NSMutableSet</span> new];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">@synchronized</span>(swizzledClasses) &#123;</span><br><span class="line">        block(swizzledClasses);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: æ³¨æ„ <code>@synchronized(swizzledClasses)</code>ã€‚</p>
</blockquote>
<p>è¿™ä¸ªå…¨å±€å˜é‡è®°å½•äº† <code>forwardInvocation:</code> è¢«æ··å†™çš„çš„ç±»åç§°ã€‚</p>
<blockquote>
<p>Note: æ³¨æ„åœ¨ç”¨é€”ä¸Šä¸ <code>static NSMutableDictionary *swizzledClassesDict;</code> åŒºåˆ†ç†è§£ã€‚</p>
</blockquote>
<h2 id="Aspects-æ ¸å¿ƒä»£ç å‰–æ"><a href="#Aspects-æ ¸å¿ƒä»£ç å‰–æ" class="headerlink" title="Aspects æ ¸å¿ƒä»£ç å‰–æ"></a>Aspects æ ¸å¿ƒä»£ç å‰–æ</h2><img src="/aspects/aspects_core.png" class="">
<p>å˜›~ Aspects çš„æ•´ä½“å®ç°ä»£ç ä¸è¶…è¿‡ä¸€åƒè¡Œï¼Œè€Œä¸”è€ƒè™‘çš„æƒ…å†µä¹Ÿæ¯”è¾ƒå…¨é¢ï¼Œéå¸¸å€¼å¾—å¤§å®¶èŠ±æ—¶é—´å»è¯»ä¸€ä¸‹ï¼Œè¿™é‡Œæˆ‘åªå‡†å¤‡ç»™å‡ºè‡ªå·±å¯¹å…¶æ ¸å¿ƒä»£ç çš„ç†è§£ã€‚</p>
<h3 id="Hook-Class-amp-amp-Hook-Instance"><a href="#Hook-Class-amp-amp-Hook-Instance" class="headerlink" title="Hook Class &amp;&amp; Hook Instance"></a>Hook Class &amp;&amp; Hook Instance</h3><p>Aspects ä¸å…‰æ”¯æŒ Hook Class è¿˜æ”¯æŒ Hook Instanceï¼Œè¿™æä¾›äº†æ›´å°ç²’åº¦çš„æ§åˆ¶ï¼Œé…åˆ Hook çš„æ’¤é”€åŠŸèƒ½å¯ä»¥æ›´åŠ çµæ´»ç²¾å‡†çš„åšæˆ‘ä»¬æƒ³åšçš„äº‹~</p>
<p>Aspects ä¸ºäº†èƒ½åŒºåˆ« Class å’Œ Instance çš„é€»è¾‘ï¼Œå®ç°äº†åä¸º <code>aspect_hookClass</code> çš„æ–¹æ³•ï¼Œæˆ‘è®¤ä¸ºå…¶ä¸­çš„å®ç°å€¼å¾—æˆ‘ç”¨ä¸€éƒ¨åˆ†ç¯‡å¹…æ¥å•ç‹¬è®²è§£ï¼Œä¹Ÿè§‰å¾—è¯»è€…ä»¬æœ‰å¿…è¦èŠ±ç‚¹æ—¶é—´ç†è§£è¿™é‡Œçš„å®ç°é€»è¾‘ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Class aspect_hookClass(<span class="built_in">NSObject</span> *<span class="keyword">self</span>, <span class="built_in">NSError</span> **error) &#123;</span><br><span class="line">    <span class="comment">// æ–­è¨€ self</span></span><br><span class="line">    <span class="built_in">NSCParameterAssert</span>(<span class="keyword">self</span>);</span><br><span class="line">    <span class="comment">// class</span></span><br><span class="line">    Class statedClass = <span class="keyword">self</span>.class;</span><br><span class="line">    <span class="comment">// isa</span></span><br><span class="line">    Class baseClass = object_getClass(<span class="keyword">self</span>);</span><br><span class="line">    <span class="built_in">NSString</span> *className = <span class="built_in">NSStringFromClass</span>(baseClass);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å·²ç»å­ç±»åŒ–è¿‡äº†</span></span><br><span class="line">    <span class="keyword">if</span> ([className hasSuffix:AspectsSubclassSuffix]) &#123;</span><br><span class="line">        <span class="keyword">return</span> baseClass;</span><br><span class="line">        <span class="comment">// æˆ‘ä»¬æ··å†™äº†ä¸€ä¸ª class å¯¹è±¡ï¼Œè€Œéä¸€ä¸ªå•ç‹¬çš„ object</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (class_isMetaClass(baseClass)) &#123;</span><br><span class="line">        <span class="comment">// baseClass æ˜¯å…ƒç±»ï¼Œåˆ™ self æ˜¯ Class æˆ– MetaClassï¼Œæ··å†™ self</span></span><br><span class="line">        <span class="keyword">return</span> aspect_swizzleClassInPlace((Class)<span class="keyword">self</span>);</span><br><span class="line">        <span class="comment">// å¯èƒ½æ˜¯ä¸€ä¸ª KVO&#x27;ed classã€‚æ··å†™å°±ä½ã€‚ä¹Ÿè¦æ··å†™ meta classesã€‚</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (statedClass != baseClass) &#123;</span><br><span class="line">        <span class="comment">// å½“ .class å’Œ isa æŒ‡å‘ä¸åŒçš„æƒ…å†µï¼Œæ··å†™ baseClass</span></span><br><span class="line">        <span class="keyword">return</span> aspect_swizzleClassInPlace(baseClass);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŠ¨æ€åˆ›å»ºå­ç±»</span></span><br><span class="line">    <span class="comment">// æ‹¼æ¥å­ç±»åç¼€ AspectsSubclassSuffix</span></span><br><span class="line">    <span class="keyword">const</span> <span class="type">char</span> *subclassName = [className stringByAppendingString:AspectsSubclassSuffix].UTF8String;</span><br><span class="line">    <span class="comment">// å°è¯•ç”¨æ‹¼æ¥åç¼€çš„åç§°è·å– isa</span></span><br><span class="line">    Class subclass = objc_getClass(subclassName);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰¾ä¸åˆ° isaï¼Œä»£è¡¨è¿˜æ²¡æœ‰åŠ¨æ€åˆ›å»ºè¿‡è¿™ä¸ªå­ç±»</span></span><br><span class="line">    <span class="keyword">if</span> (subclass == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ª class pairï¼ŒbaseClass ä½œä¸ºæ–°ç±»çš„ superClassï¼Œç±»åä¸º subclassName</span></span><br><span class="line">        subclass = objc_allocateClassPair(baseClass, subclassName, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (subclass == <span class="literal">nil</span>) &#123; <span class="comment">// è¿”å› nilï¼Œå³åˆ›å»ºå¤±è´¥</span></span><br><span class="line">            <span class="built_in">NSString</span> *errrorDesc = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;objc_allocateClassPair failed to allocate class %s.&quot;</span>, subclassName];</span><br><span class="line">            AspectError(AspectErrorFailedToAllocateClassPair, errrorDesc);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ··å†™ forwardInvocation:</span></span><br><span class="line">        aspect_swizzleForwardInvocation(subclass);</span><br><span class="line">        <span class="comment">// subClass.class = statedClass</span></span><br><span class="line">        aspect_hookedGetClass(subclass, statedClass);</span><br><span class="line">        <span class="comment">// subClass.isa.class = statedClass</span></span><br><span class="line">        aspect_hookedGetClass(object_getClass(subclass), statedClass);</span><br><span class="line">        <span class="comment">// æ³¨å†Œæ–°ç±»</span></span><br><span class="line">        objc_registerClassPair(subclass);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¦†ç›– isa</span></span><br><span class="line">    object_setClass(<span class="keyword">self</span>, subclass);</span><br><span class="line">    <span class="keyword">return</span> subclass;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: å…¶å®è¿™é‡Œçš„éš¾ç‚¹å°±åœ¨äºå¯¹ <code>.class</code> å’Œ <code>object_getClass</code> çš„åŒºåˆ†ã€‚</p>
</blockquote>
<ul>
<li><code>.class</code> å½“ target æ˜¯ Instance åˆ™è¿”å› Classï¼Œå½“ target æ˜¯ Class åˆ™è¿”å›è‡ªèº«</li>
<li><code>object_getClass</code> è¿”å› <code>isa</code> æŒ‡é’ˆçš„æŒ‡å‘</li>
</ul>
<blockquote>
<p>Note: åŠ¨æ€åˆ›å»ºä¸€ä¸ª Class çš„å®Œæ•´æ­¥éª¤ä¹Ÿæ˜¯æˆ‘ä»¬åº”è¯¥æ³¨æ„çš„ã€‚</p>
</blockquote>
<ul>
<li>objc_allocateClassPair</li>
<li>class_addMethod</li>
<li>class_addIvar</li>
<li>objc_registerClassPair</li>
</ul>
<p>å˜›~ éš¾ç‚¹å’Œé‡ç‚¹éƒ½è®²å®Œäº†ï¼Œå¤§å®¶ç»“åˆæ³¨é‡Šç†è§£å…¶ä¸­çš„é€»è¾‘åº”è¯¥æ²¡ä»€ä¹ˆå›°éš¾äº†ï¼Œæœ‰ä»€ä¹ˆé—®é¢˜å¯ä»¥æ‰¾æˆ‘ä¸€èµ·äº¤æµ~</p>
<h3 id="Hook-çš„å®ç°"><a href="#Hook-çš„å®ç°" class="headerlink" title="Hook çš„å®ç°"></a>Hook çš„å®ç°</h3><p>åœ¨ä¸Šé¢ <code>aspect_hookClass</code> æ–¹æ³•ä¸­ï¼Œä¸ä»…ä»…æ˜¯è¿”å›ä¸€ä¸ªè¦ Hook çš„ Classï¼ŒæœŸé—´è¿˜åšäº†ä¸€äº›ç»†èŠ‚æ“ä½œï¼Œä¸è®ºæ˜¯ Class è¿˜æ˜¯ Instanceï¼Œéƒ½ä¼šè°ƒç”¨ <code>aspect_swizzleForwardInvocation</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ²¡ä»€ä¹ˆéš¾ç‚¹ï¼Œç®€å•è´´ä¸€ä¸‹ä»£ç è®©å¤§å®¶æœ‰ä¸ªå°è±¡ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">void</span> aspect_swizzleForwardInvocation(Class klass) &#123;</span><br><span class="line">    <span class="comment">// æ–­è¨€ klass</span></span><br><span class="line">    <span class="built_in">NSCParameterAssert</span>(klass);</span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰ methodï¼Œreplace å®é™…ä¸Šä¼šåƒæ˜¯ class_addMethod ä¸€æ ·</span></span><br><span class="line">    IMP originalImplementation = class_replaceMethod(klass, <span class="keyword">@selector</span>(forwardInvocation:), (IMP)__ASPECTS_ARE_BEING_CALLED__, <span class="string">&quot;v@:@&quot;</span>);</span><br><span class="line">    <span class="comment">// æ‹¿åˆ° originalImplementation è¯æ˜æ˜¯ replace è€Œä¸æ˜¯ addï¼Œæƒ…å†µå°‘è§</span></span><br><span class="line">    <span class="keyword">if</span> (originalImplementation) &#123;</span><br><span class="line">        <span class="comment">// æ·»åŠ  AspectsForwardInvocationSelectorName çš„æ–¹æ³•ï¼ŒIMP ä¸ºåŸç”Ÿ forwardInvocation:</span></span><br><span class="line">        class_addMethod(klass, <span class="built_in">NSSelectorFromString</span>(AspectsForwardInvocationSelectorName), originalImplementation, <span class="string">&quot;v@:@&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    AspectLog(<span class="string">@&quot;Aspects: %@ is now aspect aware.&quot;</span>, <span class="built_in">NSStringFromClass</span>(klass));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„æ–¹æ³•å°±æ˜¯æŠŠè¦ Hook çš„ç›®æ ‡ Class çš„ <code>forwardInvocation:</code> æ··å†™äº†ï¼Œæ··å†™ä¹‹å <code>forwardInvocation:</code> çš„å…·ä½“å®ç°åœ¨ <code>__ASPECTS_ARE_BEING_CALLED__</code> ä¸­ï¼Œé‡Œé¢èƒ½çœ‹åˆ° invoke æ ‡è¯†ä½çš„ä¸åŒæ˜¯å¦‚ä½•å®ç°çš„ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„å®ç°ç»†èŠ‚ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®å®šä¹‰ï¼Œä»¥ä¾¿äºæˆ‘ä»¬æœ‰ä¸€ä¸ªæ›´æ˜æ™°çš„ stack trace</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> aspect_invoke(aspects, info) \</span></span><br><span class="line"><span class="meta">for (AspectIdentifier *aspect in aspects) &#123;\</span></span><br><span class="line"><span class="meta">    [aspect invokeWithInfo:info];\</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (aspect.options &amp; AspectOptionAutomaticRemoval) &#123; \</span></span><br><span class="line"><span class="meta">        aspectsToRemove = [aspectsToRemove?:@[] arrayByAddingObject:aspect]; \</span></span><br><span class="line"><span class="meta">    &#125; \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">void</span> __ASPECTS_ARE_BEING_CALLED__(__<span class="keyword">unsafe_unretained</span> <span class="built_in">NSObject</span> *<span class="keyword">self</span>, SEL selector, <span class="built_in">NSInvocation</span> *invocation) &#123;</span><br><span class="line">    <span class="comment">// __unsafe_unretained NSObject *self ä¸è§£é‡Šäº†</span></span><br><span class="line">    <span class="comment">// æ–­è¨€ self, invocation</span></span><br><span class="line">    <span class="built_in">NSCParameterAssert</span>(<span class="keyword">self</span>);</span><br><span class="line">    <span class="built_in">NSCParameterAssert</span>(invocation);</span><br><span class="line">    <span class="comment">// ä» invocation å¯ä»¥æ‹¿åˆ°å¾ˆå¤šä¸œè¥¿ï¼Œæ¯”å¦‚ originalSelector</span></span><br><span class="line">    SEL originalSelector = invocation.selector;</span><br><span class="line">    <span class="comment">// originalSelector åŠ å‰ç¼€å¾—åˆ° aliasSelector</span></span><br><span class="line">    SEL aliasSelector = aspect_aliasForSelector(invocation.selector);</span><br><span class="line">    <span class="comment">// ç”¨ aliasSelector æ›¿æ¢ invocation.selector</span></span><br><span class="line">    invocation.selector = aliasSelector;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Instance çš„å®¹å™¨</span></span><br><span class="line">    AspectsContainer *objectContainer = objc_getAssociatedObject(<span class="keyword">self</span>, aliasSelector);</span><br><span class="line">    <span class="comment">// Class çš„å®¹å™¨</span></span><br><span class="line">    AspectsContainer *classContainer = aspect_getContainerForClass(object_getClass(<span class="keyword">self</span>), aliasSelector);</span><br><span class="line">    AspectInfo *info = [[AspectInfo alloc] initWithInstance:<span class="keyword">self</span> invocation:invocation];</span><br><span class="line">    <span class="built_in">NSArray</span> *aspectsToRemove = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Before hooks.</span></span><br><span class="line">    aspect_invoke(classContainer.beforeAspects, info);</span><br><span class="line">    aspect_invoke(objectContainer.beforeAspects, info);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instead hooks.</span></span><br><span class="line">    <span class="type">BOOL</span> respondsToAlias = <span class="literal">YES</span>;</span><br><span class="line">    <span class="keyword">if</span> (objectContainer.insteadAspects.count || classContainer.insteadAspects.count) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæœ‰ä»»ä½• insteadAspects å°±ç›´æ¥æ›¿æ¢äº†</span></span><br><span class="line">        aspect_invoke(classContainer.insteadAspects, info);</span><br><span class="line">        aspect_invoke(objectContainer.insteadAspects, info);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123; <span class="comment">// å¦åˆ™æ­£å¸¸æ‰§è¡Œ</span></span><br><span class="line">        <span class="comment">// éå† invocation.target åŠå…¶ superClass æ‰¾åˆ°å®ä¾‹å¯ä»¥å“åº” aliasSelector çš„ç‚¹ invoke</span></span><br><span class="line">        Class klass = object_getClass(invocation.target);</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((respondsToAlias = [klass instancesRespondToSelector:aliasSelector])) &#123;</span><br><span class="line">                [invocation invoke];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">while</span> (!respondsToAlias &amp;&amp; (klass = class_getSuperclass(klass)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// After hooks.</span></span><br><span class="line">    aspect_invoke(classContainer.afterAspects, info);</span><br><span class="line">    aspect_invoke(objectContainer.afterAspects, info);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰ hookï¼Œåˆ™æ‰§è¡ŒåŸå§‹å®ç°ï¼ˆé€šå¸¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (!respondsToAlias) &#123;</span><br><span class="line">        invocation.selector = originalSelector;</span><br><span class="line">        SEL originalForwardInvocationSEL = <span class="built_in">NSSelectorFromString</span>(AspectsForwardInvocationSelectorName);</span><br><span class="line">        <span class="comment">// å¦‚æœå¯ä»¥å“åº” originalForwardInvocationSELï¼Œè¡¨ç¤ºä¹‹å‰æ˜¯ replace method è€Œé add method</span></span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span> respondsToSelector:originalForwardInvocationSEL]) &#123;</span><br><span class="line">            ((<span class="type">void</span>( *)(<span class="type">id</span>, SEL, <span class="built_in">NSInvocation</span> *))objc_msgSend)(<span class="keyword">self</span>, originalForwardInvocationSEL, invocation);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            [<span class="keyword">self</span> doesNotRecognizeSelector:invocation.selector];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç§»é™¤ aspectsToRemove é˜Ÿåˆ—ä¸­çš„ AspectIdentifierï¼Œæ‰§è¡Œ remove</span></span><br><span class="line">    [aspectsToRemove makeObjectsPerformSelector:<span class="keyword">@selector</span>(remove)];</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> aspect_invoke</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: <code>aspect_invoke</code> å®å®šä¹‰çš„ä½œç”¨åŸŸã€‚</p>
</blockquote>
<ul>
<li>ä»£ç å®ç°å¯¹åº”äº† Hook çš„ AspectOptions å‚æ•°çš„ Beforeï¼ŒInstead å’Œ Afterã€‚</li>
<li><code>aspect_invoke</code> ä¸­ <code>aspectsToRemove</code> æ˜¯ä¸€ä¸ª NSArrayï¼Œé‡Œé¢å®¹çº³ç€éœ€è¦è¢«é”€æˆ·çš„ Hookï¼Œå³ AspectIdentifierï¼ˆä¹‹åä¼šè°ƒç”¨ <code>remove</code> ç§»é™¤ï¼‰ã€‚</li>
<li>éå† invocation.target åŠå…¶ superClass æ‰¾åˆ°å®ä¾‹å¯ä»¥å“åº” aliasSelector çš„ç‚¹ invoke å®ç°ä»£ç ã€‚</li>
</ul>
<h3 id="Block-Hook"><a href="#Block-Hook" class="headerlink" title="Block Hook"></a>Block Hook</h3><p>Aspects è®©æˆ‘ä»¬åœ¨æŒ‡å®š Class æˆ– Instance çš„ç‰¹å®š Selector æ‰§è¡Œæ—¶ï¼Œæ ¹æ® AspectOptions æ’å…¥æˆ‘ä»¬è‡ªå·±çš„ Block åš Hookï¼Œè€Œè¿™ä¸ª Block å†…éƒ¨æœ‰æˆ‘ä»¬æƒ³è¦çš„æœ‰å…³äºå½“å‰ Target å’Œ Selector çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Aspects æ˜¯æ€ä¹ˆåŠåˆ°çš„ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)invokeWithInfo:(<span class="type">id</span>&lt;AspectInfo&gt;)info &#123;</span><br><span class="line">    <span class="built_in">NSInvocation</span> *blockInvocation = [<span class="built_in">NSInvocation</span> invocationWithMethodSignature:<span class="keyword">self</span>.blockSignature];</span><br><span class="line">    <span class="built_in">NSInvocation</span> *originalInvocation = info.originalInvocation;</span><br><span class="line">    <span class="built_in">NSUInteger</span> numberOfArguments = <span class="keyword">self</span>.blockSignature.numberOfArguments;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åæ‰§ã€‚æˆ‘ä»¬å·²ç»åœ¨ hook æ³¨å†Œçš„æ—¶å€™æ£€æŸ¥è¿‡äº†ï¼Œï¼ˆä¸è¿‡è¿™é‡Œæˆ‘ä»¬è¿˜è¦æ£€æŸ¥ï¼‰ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (numberOfArguments &gt; originalInvocation.methodSignature.numberOfArguments) &#123;</span><br><span class="line">        AspectLogError(<span class="string">@&quot;Block has too many arguments. Not calling %@&quot;</span>, info);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// block çš„ `self` å°†ä¼šæ˜¯ AspectInfoã€‚å¯é€‰çš„ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (numberOfArguments &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        [blockInvocation setArgument:&amp;info atIndex:<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç®€å†å‚æ•°åˆ†é…å†…å­˜ argBuf ç„¶åä» originalInvocation å– argument èµ‹å€¼ç»™ blockInvocation</span></span><br><span class="line">    <span class="type">void</span> *argBuf = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> idx = <span class="number">2</span>; idx &lt; numberOfArguments; idx++) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="type">char</span> *type = [originalInvocation.methodSignature getArgumentTypeAtIndex:idx];</span><br><span class="line">		<span class="built_in">NSUInteger</span> argSize;</span><br><span class="line">		<span class="built_in">NSGetSizeAndAlignment</span>(type, &amp;argSize, <span class="literal">NULL</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// reallocf ä¼˜ç‚¹ï¼Œå¦‚æœåˆ›å»ºå†…å­˜å¤±è´¥ä¼šè‡ªåŠ¨é‡Šæ”¾ä¹‹å‰çš„å†…å­˜ï¼Œè®²ç©¶</span></span><br><span class="line">		<span class="keyword">if</span> (!(argBuf = reallocf(argBuf, argSize))) &#123;</span><br><span class="line">            AspectLogError(<span class="string">@&quot;Failed to allocate memory for block invocation.&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">		[originalInvocation getArgument:argBuf atIndex:idx];</span><br><span class="line">		[blockInvocation setArgument:argBuf atIndex:idx];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰§è¡Œ</span></span><br><span class="line">    [blockInvocation invokeWithTarget:<span class="keyword">self</span>.block];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é‡Šæ”¾ argBuf</span></span><br><span class="line">    <span class="keyword">if</span> (argBuf != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        free(argBuf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€ƒè™‘ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li><code>[blockInvocation setArgument:&amp;info atIndex:1];</code> ä¸ºä»€ä¹ˆè¦åœ¨ç´¢å¼• 1 å¤„æ’å…¥å‘¢ï¼Ÿ</li>
<li><code>for (NSUInteger idx = 2; idx &lt; numberOfArguments; idx++)</code> ä¸ºä»€ä¹ˆè¦ä»ç´¢å¼• 2 å¼€å§‹éå†å‚æ•°å‘¢ï¼Ÿ</li>
</ul>
<p>å˜›~ å¦‚æœä½ å¯¹ Block çš„ Runtime ç»“æ„ä»¥åŠæ‰§è¡Œè¿‡ç¨‹ä¸‹æ–­ç‚¹ç ”ç©¶ä¸€ä¸‹å°±å…¨éƒ½æ˜ç™½äº†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦æœ‰ç–‘é—®å¯ä»¥è”ç³»æˆ‘ï¼ˆä¸çœŸæ­£å‹¤å¥‹å¥½å­¦çš„äººäº¤æµåˆæœ‰è°ä¼šä¸ä¹æ„å‘¢ï¼Ÿç¬‘~ï¼‰</p>
<h2 id="ä¼˜ç§€-AOP-åº“åº”è¯¥å…·å¤‡çš„ç‰¹è´¨"><a href="#ä¼˜ç§€-AOP-åº“åº”è¯¥å…·å¤‡çš„ç‰¹è´¨" class="headerlink" title="ä¼˜ç§€ AOP åº“åº”è¯¥å…·å¤‡çš„ç‰¹è´¨"></a>ä¼˜ç§€ AOP åº“åº”è¯¥å…·å¤‡çš„ç‰¹è´¨</h2><img src="/aspects/aspects_rank.jpg" class="">
<ul>
<li>è‰¯å¥½çš„ä½¿ç”¨ä½“éªŒ</li>
<li>å¯æ§ç²’åº¦å°</li>
<li>ä½¿ç”¨ Block åš Hook</li>
<li>æ”¯æŒæ’¤é”€ Hook</li>
<li>å®‰å…¨æ€§</li>
</ul>
<h3 id="è‰¯å¥½çš„ä½¿ç”¨ä½“éªŒ"><a href="#è‰¯å¥½çš„ä½¿ç”¨ä½“éªŒ" class="headerlink" title="è‰¯å¥½çš„ä½¿ç”¨ä½“éªŒ"></a>è‰¯å¥½çš„ä½¿ç”¨ä½“éªŒ</h3><p>Aspects ä½¿ç”¨ NSObject + Categroy çš„æ–¹å¼æä¾›æ¥å£ï¼Œéå¸¸å·§å¦™çš„æ¶µç›–äº† Instance å’Œ Classã€‚</p>
<p>Aspects æä¾›çš„æ¥å£ä¿æŒé«˜åº¦ä¸€è‡´ï¼ˆæœ¬ç€<strong>æ˜“ç”¨ï¼Œç®€å•ï¼Œæ–¹ä¾¿</strong>çš„åŸåˆ™è®¾è®¡æ¥å£å’Œæ•´ä¸ªæ¡†æ¶çš„å®ç°ä¼šè®©ä½ çš„å¼€æºé¡¹ç›®æ›´å®¹æ˜“è¢«äººä»¬æ¥çº³å’Œä½¿ç”¨ï¼‰ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="type">id</span>&lt;AspectToken&gt;)aspect_hookSelector:(SEL)selector</span><br><span class="line">                      withOptions:(AspectOptions)options</span><br><span class="line">                       usingBlock:(<span class="type">id</span>)block</span><br><span class="line">                            error:(<span class="built_in">NSError</span> **)error;</span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>&lt;AspectToken&gt;)aspect_hookSelector:(SEL)selector</span><br><span class="line">                      withOptions:(AspectOptions)options</span><br><span class="line">                       usingBlock:(<span class="type">id</span>)block</span><br><span class="line">                            error:(<span class="built_in">NSError</span> **)error;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: å…¶å®æ¥å£è¿™é‡Œå¯¹äº <code>block</code> çš„å‚æ•°è‡ªåŠ¨è¡¥å…¨å¯ä»¥æ›´è¿›ä¸€æ­¥ï¼Œä¸è¿‡ Aspects å½“åˆæ˜¯æ²¡æœ‰åŠæ³•åšåˆ°çš„ï¼Œå•ä»æ¥å£è®¾è®¡è¿™å—å·²ç»å¾ˆä¼˜ç§€äº†ã€‚</p>
</blockquote>
<h3 id="å¯æ§ç²’åº¦å°"><a href="#å¯æ§ç²’åº¦å°" class="headerlink" title="å¯æ§ç²’åº¦å°"></a>å¯æ§ç²’åº¦å°</h3><p>Aspects ä¸ä»…æ”¯æŒå¤§éƒ¨åˆ† AOP æ¡†æ¶åº”è¯¥åšåˆ°çš„å¯¹äº Class çš„ Hookï¼Œè¿˜æ”¯æŒç²’åº¦æ›´å°çš„ Instance Hookï¼Œè€Œå…¶åœ¨å†…éƒ¨å®ç°ä¸­ä¸ºäº†æ”¯æŒ Instance Hook æ‰€åšçš„ä»£ç ä¹Ÿéå¸¸å€¼å¾—æˆ‘ä»¬å‚è€ƒå’Œå­¦ä¹ ï¼ˆå·²åœ¨ä¸Šæ–‡ <strong>Aspects æ ¸å¿ƒä»£ç å‰–æ</strong> å¤„å•ç‹¬åˆ†æï¼‰ã€‚</p>
<p>ä¸ºä½¿ç”¨è€…æä¾›æ›´ä¸ºè‡ªç”±çš„ Hook æ–¹å¼ä»¥è¾¾åˆ°æ›´åŠ ç²¾å‡†çš„æ§åˆ¶æ˜¯æ¯ä¸ªä½¿ç”¨è€…ä¹äºè§åˆ°çš„äº‹ã€‚</p>
<h3 id="ä½¿ç”¨-Block-åš-Hook"><a href="#ä½¿ç”¨-Block-åš-Hook" class="headerlink" title="ä½¿ç”¨ Block åš Hook"></a>ä½¿ç”¨ Block åš Hook</h3><p>Aspects ä½¿ç”¨ Block æ¥åš Hook åº”è¯¥è€ƒè™‘åˆ°äº†å¾ˆå¤šä¸œè¥¿ï¼Œæ”¯æŒä½¿ç”¨è€…é€šè¿‡åœ¨ Block ä¸­è·å–åˆ°ç›¸å…³çš„ä¿¡æ¯ï¼Œä¹¦å†™è‡ªå·±é¢å¤–çš„æ“ä½œå°±å¯ä»¥å®ç° Hook éœ€æ±‚ã€‚</p>
<h3 id="æ”¯æŒæ’¤é”€-Hook"><a href="#æ”¯æŒæ’¤é”€-Hook" class="headerlink" title="æ”¯æŒæ’¤é”€ Hook"></a>æ”¯æŒæ’¤é”€ Hook</h3><p>Aspects è¿˜æ”¯æŒæ’¤é”€ä¹‹å‰åšçš„ Hook ä»¥åŠå·²æ··å†™çš„ Methodï¼Œä¸ºäº†å®ç°è¿™ä¸ªåŠŸèƒ½ Aspects è®¾è®¡äº†å…¨å±€å®¹å™¨ï¼ŒæŠŠ Hook å’Œæ··å†™ç”¨å…¨å±€å®¹å™¨åšè®°å½•ï¼Œè®©ä¸€åˆ‡éƒ½å¯ä»¥å¤åŸï¼Œè¿™ä¸æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„å—ï¼Ÿ</p>
<h3 id="å®‰å…¨æ€§"><a href="#å®‰å…¨æ€§" class="headerlink" title="å®‰å…¨æ€§"></a>å®‰å…¨æ€§</h3><p>å˜›~ æˆ‘ä»¬åœ¨å­¦ä¹  Runtime çš„æ—¶å€™ï¼Œå°±åº”è¯¥çœ‹åˆ°è¿‡ä¸å°‘æ–‡ç« è®²è§£ Method Swizzling è¦æ³¨æ„çš„å®‰å…¨æ€§é—®é¢˜ï¼Œç”±äºç”¨åˆ°äº†å¤§é‡ Runtime æ–¹æ³•ï¼ŒåŠ ä¸Š AOP æ˜¯é¢å‘æ•´ä¸ªåˆ‡é¢çš„ï¼Œæ‰€ä»¥ä¸€å•å‘ç°é—®é¢˜å°±ä¼šæ¯”è¾ƒä¸¥é‡ï¼Œæ¶‰åŠçš„é¢ä¼šæ¯”è¾ƒå¹¿ï¼Œè€Œä¸”éš¾ä»¥è°ƒè¯•ã€‚</p>
<blockquote>
<p>Note: æˆ‘ä»¬ä¸èƒ½å› ä¸ºå®¹æ˜“é€ æˆé—®é¢˜å°±å¯ä»¥å›é¿ Method Swizzlingï¼Œå°±å¥½æ¯”å¤§å­¦è€å¸ˆè®²åˆ°é€’å½’æ—¶å¼ºè°ƒå®¹æ˜“å¼•èµ·å¾ªç¯è°ƒç”¨ï¼Œå¾ˆå¤šäººå°±åœ¨å†…å¿ƒå›é¿ä½¿ç”¨é€’å½’ï¼Œç”šè‡³äºéå¸¸é€‚åˆä½¿ç”¨é€’å½’æ¥å†™çš„ç®—æ³•é¢˜ï¼ˆè¿™é‡ŒæŒ‡é€’å½’æ¥å†™ä¼šæ˜“è¯»å†™ã€æ˜“ç»´æŠ¤ï¼‰åªä¼šç”¨å¤æ‚çš„æ–¹å¼æ¥æ€è€ƒã€‚</p>
</blockquote>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul>
<li>æ–‡ç« ç®€å•ä»‹ç»äº† AOP çš„æ¦‚å¿µï¼Œå¸Œæœ›èƒ½ç»™å„ä½è¯»è€…å¯¹ AOP æ€æƒ³çš„ç†è§£æä¾›å¾®è–„çš„å¸®åŠ©ã€‚</li>
<li>æ–‡ç« ç³»ç»Ÿçš„å‰–æäº† Aspects å¼€æºåº“çš„å†…éƒ¨ç»“æ„ï¼Œå¸Œæœ›èƒ½è®©å¤§å®¶åœ¨æµè§ˆ Aspects æºç æ—¶å¿«é€Ÿå®šä½ä»£ç ä½ç½®ï¼Œæ‰¾åˆ°æ ¸å¿ƒå†…å®¹ã€‚</li>
<li>æ–‡ç« é‡ç‚¹åˆ†æäº† Aspects çš„æ ¸å¿ƒä»£ç ï¼Œæç‚¼äº†ä¸€äº›ç¬”è€…è®¤ä¸ºå€¼å¾—æ³¨æ„çš„ç‚¹ï¼Œä½†æ„¿å¯ä»¥åœ¨å¤§å®¶æ‰’æºç æ—¶æä¾›ä¸€äº›æŒ‡å¼•ã€‚</li>
<li>æ–‡ç« ç»“å°¾æ€»ç»“äº† Aspects ä½œä¸ºä¸€ä¸ªæ¯”è¾ƒä¼˜ç§€çš„ AOP æ‰€å…·å¤‡çš„ä¸€äº›ç‰¹è´¨ã€‚</li>
</ul>
<p>æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜ <a href="https://lision.me/">https://lision.me/</a>ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ <a href="https://lision.me/">ä¸ªäººåšå®¢</a> ä¸­æ›´æ–°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš <a target="_blank" rel="noopener" href="https://weibo.com/lisioncode">@Lision</a> è”ç³»æˆ‘~</p>
<p>å¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~</p>


    
    
    
	  <div class="tags">
      <a class="tag-none-link" href="/tags/aop/" rel="tag">aop</a><a class="tag-none-link" href="/tags/hook/" rel="tag">hook</a>
	  </div>
    

  </section>
</article>
  
</section>


  <nav id="page-nav">
    
    <a class="prev" rel="prev" href="/page/12/">
      <span class="icon icon-chevron-left"></span>
      <span class="text">Previous</span>
    </a>
    
    
    <a class="next" rel="next" href="/page/14/">
      <span class="text">Next</span>
      <span class="icon icon-chevron-right"></span>
    </a>
    
  </nav>
  

      <script>setLoadingBarProgress(60);</script>
    </main>
    
    <footer id="footer" class="clearfix">
  
  
	<div class="search">
	  <script>
      (function() {
        var cx = '001858749347000340533:drswradlp64';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
	</div>
	

	<div class="social-wrapper">
  	
      
        <a href="mailto:lisionmail@gmail.com" class="social email"
          target="_blank" rel="external">
          <span class="icon icon-email"></span>
        </a>
      
        <a href="https://github.com/Lision" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="https://twitter.com/LisionChat" class="social twitter"
          target="_blank" rel="external">
          <span class="icon icon-twitter"></span>
        </a>
      
        <a href="https://weibo.com/lisioncode" class="social sina-weibo"
          target="_blank" rel="external">
          <span class="icon icon-sina-weibo"></span>
        </a>
      
    
  </div>
  
  <div>Theme <span class="codename">Typescript</span> designed by <a href="http://rakugaki.me/" target="_blank">Art Chen</a>.</div>
  <div>&copy; <a href="/">èŠå®…</a></div>
  
</footer>


    <script>setLoadingBarProgress(80);</script>
    
  </div>

  
<script>
  var disqus_shortname = 'lision-me';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>




<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>window.jQuery || document.write('<script src="/js/jquery.min.js"><\/script>')</script>


<script src="/js/jquery.fitvids.js"></script>

<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "AIzaSyAMIoydL742ROhE6lLk9n3hT0pZwbrXD_I";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "001858749347000340533:drswradlp64";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "google";
</script>

<script src="/js/search.js"></script>


<script src="/js/app.js"></script>



  <script>setLoadingBarProgress(100);</script>
  
</body>
</html>
