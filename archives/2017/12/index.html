<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>Archives: 2017/12 | èŠå®…</title>
  <meta name="description" content="ç¾éº—çš„å¤ªé™½ç…§å¸¸å‡èµ· è‹¦ç—›çš„äººå€‘ä¾èˆŠæ­‡æ–¯åº•è£" />
  <meta name="keywords" content="ios,objective-c,swift,python,javascript,otaku,lision" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="æ•²ä»£ç çš„ï¼Œæ¯”è¾ƒå®…çš„å†…ç§">
<meta property="og:type" content="website">
<meta property="og:title" content="èŠå®…">
<meta property="og:url" content="https://lision.me/archives/2017/12/index.html">
<meta property="og:site_name" content="èŠå®…">
<meta property="og:description" content="æ•²ä»£ç çš„ï¼Œæ¯”è¾ƒå®…çš„å†…ç§">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Lision">
<meta property="article:tag" content="ios,objective-c,swift,python,javascript,otaku,lision">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  

	<script src="https://use.typekit.net/eyf3hir.js"></script>
  <script>try{Typekit.load({ async: false });}catch(e){}</script>
  
<link rel="stylesheet" href="/style.css">

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
  
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=" + "UA-118743071-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-118743071-1');
</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>

  <script>setLoadingBarProgress(20)</script>
  
  <div id="site-wrapper">
    
    <header id="header">
	<div id="header-wrapper" class="clearfix">
		<a id="logo" href="/">
			<img src="/images/logo.png" />
			<span id="site-desc">
			  otaku's self-cultivation
      </span>
		</a>
		<button id="site-nav-switch">
	    <span class="icon icon-menu"></span>
	  </button>
	</div>
	<aside id="site-menu">
  	<nav>
  		
        <a href="/" class="nav-home nav">
          é¦–é¡µ
        </a>
      
        <a href="/archives" class="nav-archives nav">
          å½’æ¡£
        </a>
      
        <a target="_blank" rel="noopener" href="https://github.com/Lision" class="nav-about nav">
          å…³äº
        </a>
      
    </nav>
	</aside>
</header>
    <script>setLoadingBarProgress(40);</script>
    
    <main id="main" role="main">
      
	


	<section class="page-header archive">
    <h1>- <span>2017.12</span> -</h1>
  </section>




<section class="post-list">
	
    <article class="post ">

  
  <h2 class="title">
    <a href="/webview_javascript_bridge/">
      æ·±å…¥å‰–æ WebViewJavascriptBridge
    </a>
  </h2>
  
  <time>
    12æœˆ 23, 2017
  </time>
  <section class="content">
	  <img src="/webview_javascript_bridge/merry_ch.jpg" class="">
<p>Emmmmmâ€¦è¿™ç¯‡æ–‡ç« å‘å¸ƒå‡ºæ¥å¯èƒ½æ­£é€¢åœ£è¯èŠ‚ğŸ„ï¼ŒMerry Christmas!</p>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Web é¡µé¢ä¸­çš„ JS ä¸ iOS Native å¦‚ä½•äº¤äº’æ˜¯æ¯ä¸ª iOS çŒ¿å¿…é¡»æŒæ¡çš„æŠ€èƒ½ã€‚è€Œ JS å’Œ iOS Native å°±å¥½æ¯”ä¸¤å—æ²¡æœ‰äº¤é›†çš„å¤§é™†ï¼Œå¦‚æœæƒ³è¦ä½¿å®ƒä»¬ç›¸äº’é€šä¿¡å°±å¿…é¡»è¦å»ºç«‹ä¸€åº§â€œæ¡¥æ¢â€ã€‚</p>
<p><strong>æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœé¡¹ç›®ç»„è®©ä½ å»é€ è¿™åº§â€œæ¡¥â€ï¼Œå¦‚ä½•æ‰èƒ½åšåˆ°æ—¢ä¼˜é›…åˆå®ç”¨ï¼Ÿ</strong></p>
<p>æœ¬æ–‡å°†ç»“åˆ WebViewJavascriptBridge æºç é€æ­¥å¸¦å¤§å®¶æ‰¾åˆ°ç­”æ¡ˆã€‚</p>
<p><a target="_blank" rel="noopener" href="https://github.com/marcuswestin/WebViewJavascriptBridge">WebViewJavascriptBridge</a> æ˜¯ç››åå·²ä¹…çš„ JSBridge åº“ï¼Œæ—©åœ¨ 2011 å¹´å°±è¢«ä½œè€… <a target="_blank" rel="noopener" href="https://github.com/marcuswestin">Marcus Westin</a> å‘å¸ƒåˆ° GitHubï¼Œç›´åˆ°ç°åœ¨ä½œè€…è¿˜åœ¨ç§¯æç»´æŠ¤ä¸­ï¼Œç›®å‰è¯¥é¡¹ç›®å·²æ”¶è·è¿‘ 1w star å’¯ï¼Œå…¶æºç éå¸¸å€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚</p>
<p>WebViewJavascriptBridge çš„ä»£ç é€»è¾‘æ¸…æ™°ï¼Œé£æ ¼è‰¯å¥½ï¼ŒåŠ ä¸Šè‡ªèº«ä»£ç é‡æ¯”è¾ƒå°ä½¿å¾—å…¶æºç é˜…è¯»éå¸¸è½»æ¾ï¼ˆå¯èƒ½éœ€è¦ä¸€äº› JS åŸºç¡€ï¼‰ã€‚æ›´åŠ éš¾èƒ½å¯è´µçš„æ˜¯å®ƒä»…ä½¿ç”¨äº†å°‘é‡ä»£ç å°±å®ç°äº†å¯¹äº Mac OS X çš„ WebView ä»¥åŠ iOS å¹³å°çš„ UIWebView å’Œ WKWebView ä¸‰ç§ç»„ä»¶çš„å®Œç¾æ”¯æŒã€‚</p>
<p>æˆ‘å¯¹ WebViewJavascriptBridge çš„è¯„ä»·æ˜¯<strong>å°è€Œç¾</strong>ï¼Œè¿™ç±»å°è€Œç¾çš„æºç éå¸¸åˆ©äºæˆ‘ä»¬å¯¹å…¶å®ç°æ€æƒ³çš„å­¦ä¹ ï¼ˆæœ¬æ–‡åˆ†æ WebViewJavascriptBridge æºç ç‰ˆæœ¬ä¸º v6.0.3ï¼‰ã€‚</p>
<p>å…³äº iOS ä¸ JS çš„åŸç”Ÿäº¤äº’çŸ¥è¯†ï¼Œä¹‹å‰æˆ‘æœ‰å†™è¿‡ä¸€ç¯‡æ–‡ç« <a href="https://lision.me/ios-native-js/">ã€ŠiOS ä¸ JS äº¤äº’å¼€å‘çŸ¥è¯†æ€»ç»“ã€‹</a>ï¼Œæ–‡ç« é™¤äº†ä»‹ç» JavaScriptCore åº“ä»¥åŠ UIWebView å’Œ WKWebView ä¸ JS åŸç”Ÿäº¤äº’çš„æ–¹æ³•ä¹‹å¤–è¿˜æå¸¦æåˆ°äº† <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Hybrid">Hybrid</a> çš„å‘å±•ç®€å²ï¼Œæ–‡æœ«è¿˜æä¾›äº†ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://github.com/Lision/HybridCameraDemo">JS é€šè¿‡ Native è°ƒç”¨ iOS è®¾å¤‡æ‘„åƒå¤´çš„ Demo</a>ã€‚</p>
<p>æ‰€ä»¥è¿™ç¯‡æ–‡ç« ä¸ä¼šå†æŠŠé‡ç‚¹æ”¾åœ¨ iOS ä¸ JS çš„åŸç”Ÿäº¤äº’äº†ï¼Œæœ¬æ–‡æ—¨åœ¨ä»‹ç» <a target="_blank" rel="noopener" href="https://github.com/marcuswestin/WebViewJavascriptBridge">WebViewJavascriptBridge</a> çš„è®¾è®¡æ€è·¯å’Œå®ç°åŸç†ï¼Œå¯¹ iOS ä¸ JS åŸç”Ÿäº¤äº’çŸ¥è¯†æ„Ÿå…´è¶£çš„åŒå­¦æ¨èå»é˜…è¯»ä¸Šé¢æåˆ°çš„æ–‡ç« ï¼Œåº”è¯¥ä¼šæœ‰ç‚¹å„¿å¸®åŠ©ï¼ˆç¬‘ï¼‰ã€‚</p>
<h2 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h2><ul>
<li>WebViewJavascriptBridge ç®€ä»‹</li>
<li>WebViewJavascriptBridge &amp;&amp; WKWebViewJavascriptBridge æ¢ç©¶</li>
<li>WebViewJavascriptBridgeBase - JS è°ƒç”¨ Native å®ç°åŸç†å‰–æ</li>
<li>WebViewJavascriptBridge_JS - Native è°ƒç”¨ JS å®ç°è§£è¯»</li>
<li>WebViewJavascriptBridge çš„â€œæ¡¥æ¢ç¾å­¦â€</li>
<li>æ–‡ç« æ€»ç»“</li>
</ul>
<h2 id="WebViewJavascriptBridge-ç®€ä»‹"><a href="#WebViewJavascriptBridge-ç®€ä»‹" class="headerlink" title="WebViewJavascriptBridge ç®€ä»‹"></a>WebViewJavascriptBridge ç®€ä»‹</h2><img src="/webview_javascript_bridge/bridge.png" class="">
<p>WebViewJavascriptBridge æ˜¯ç”¨äºåœ¨ WKWebViewï¼ŒUIWebView å’Œ WebView ä¸­çš„ Obj-C å’Œ JavaScript ä¹‹é—´å‘é€æ¶ˆæ¯çš„ iOS / OSX æ¡¥æ¥å™¨ã€‚</p>
<p>æœ‰è®¸å¤šä¸é”™çš„é¡¹ç›®éƒ½æœ‰ä½¿ç”¨ WebViewJavascriptBridgeï¼Œè¿™é‡Œç®€å•åˆ—ä¸€éƒ¨åˆ†ï¼ˆç¬‘ï¼‰ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.messenger.com/">Facebook Messenger</a></li>
<li><a target="_blank" rel="noopener" href="https://www.facebook.com/paper">Facebook Paper</a></li>
<li><a target="_blank" rel="noopener" href="http://www.stayelsewhere.com/">ELSEWHERE</a></li>
<li>â€¦ &amp; many more!</li>
</ul>
<p>å…³äº WebViewJavascriptBridge çš„å…·ä½“ä½¿ç”¨æ–¹æ³•è¯¦è§å…¶ <a target="_blank" rel="noopener" href="https://github.com/marcuswestin/WebViewJavascriptBridge">GitHub é¡µé¢</a>ã€‚</p>
<p>åœ¨è¯»å®Œ WebViewJavascriptBridge çš„æºç ä¹‹åæˆ‘å°†å…¶åˆ’åˆ†ä¸ºä¸‰ä¸ªå±‚çº§ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">å±‚çº§</th>
<th style="text-align:center">æºæ–‡ä»¶</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">æ¥å£å±‚</td>
<td style="text-align:center">WebViewJavascriptBridge &amp;&amp; WKWebViewJavascriptBridge</td>
</tr>
<tr>
<td style="text-align:center">å®ç°å±‚</td>
<td style="text-align:center">WebViewJavascriptBridgeBase</td>
</tr>
<tr>
<td style="text-align:center">JS å±‚</td>
<td style="text-align:center">WebViewJavascriptBridge_JS</td>
</tr>
</tbody>
</table>
<p>å…¶ä¸­ WebViewJavascriptBridge &amp;&amp; WKWebViewJavascriptBridge ä½œä¸ºæ¥å£å±‚ä¸»è¦è´Ÿè´£æä¾›æ–¹ä¾¿çš„æ¥å£ï¼Œéšè—å®ç°ç»†èŠ‚ï¼Œå…¶å®ç°ç»†èŠ‚éƒ½æ˜¯é€šè¿‡å®ç°å±‚ WebViewJavascriptBridgeBase å»åšçš„ï¼Œè€Œ WebViewJavascriptBridge_JS ä½œä¸º JS å±‚å…¶å®å­˜å‚¨äº†ä¸€æ®µ JS ä»£ç ï¼Œåœ¨éœ€è¦çš„æ—¶å€™æ³¨å…¥åˆ°å½“å‰ WebView ç»„ä»¶ä¸­ï¼Œæœ€ç»ˆå®ç° Native ä¸ JS çš„äº¤äº’ã€‚</p>
<h2 id="WebViewJavascriptBridge-amp-amp-WKWebViewJavascriptBridge-æ¢ç©¶"><a href="#WebViewJavascriptBridge-amp-amp-WKWebViewJavascriptBridge-æ¢ç©¶" class="headerlink" title="WebViewJavascriptBridge &amp;&amp; WKWebViewJavascriptBridge æ¢ç©¶"></a>WebViewJavascriptBridge &amp;&amp; WKWebViewJavascriptBridge æ¢ç©¶</h2><img src="/webview_javascript_bridge/golden_bridge.jpeg" class="">
<p>WebViewJavascriptBridge å’Œ WKWebViewJavascriptBridge ä½œä¸ºæ¥å£å±‚åˆ†åˆ«å¯¹åº”äº UIWebView å’Œ WKWebView ç»„ä»¶ï¼Œæˆ‘ä»¬æ¥ç®€å•çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªæ–‡ä»¶æš´éœ²å‡ºçš„ä¿¡æ¯ï¼š</p>
<p>WebViewJavascriptBridge æš´éœ²ä¿¡æ¯ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WebViewJavascriptBridge</span> : <span class="title">WVJB_WEBVIEW_DELEGATE_INTERFACE</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)bridgeForWebView:(<span class="type">id</span>)webView; <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)bridge:(<span class="type">id</span>)webView; <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)enableLogging; <span class="comment">// å¼€å¯æ—¥å¿—</span></span><br><span class="line">+ (<span class="type">void</span>)setLogMaxLength:(<span class="type">int</span>)length; <span class="comment">// è®¾ç½®æ—¥å¿—æœ€å¤§é•¿åº¦</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)registerHandler:(<span class="built_in">NSString</span>*)handlerName handler:(WVJBHandler)handler; <span class="comment">// æ³¨å†Œ handler (Native)</span></span><br><span class="line">- (<span class="type">void</span>)removeHandler:(<span class="built_in">NSString</span>*)handlerName; <span class="comment">// åˆ é™¤ handler (Native)</span></span><br><span class="line">- (<span class="type">void</span>)callHandler:(<span class="built_in">NSString</span>*)handlerName data:(<span class="type">id</span>)data responseCallback:(WVJBResponseCallback)responseCallback; <span class="comment">// è°ƒç”¨ handler (JS)</span></span><br><span class="line">- (<span class="type">void</span>)setWebViewDelegate:(<span class="type">id</span>)webViewDelegate; <span class="comment">// è®¾ç½® webViewDelegate</span></span><br><span class="line">- (<span class="type">void</span>)disableJavscriptAlertBoxSafetyTimeout; <span class="comment">// ç¦ç”¨ JS AlertBox çš„å®‰å…¨æ—¶é•¿æ¥åŠ é€Ÿæ¶ˆæ¯ä¼ é€’ï¼Œä¸æ¨èä½¿ç”¨</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>WKWebViewJavascriptBridge æš´éœ²ä¿¡æ¯ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Emmmmm...è¿™é‡Œåº”è¯¥ä¸éœ€è¦æˆ‘æ³¨é‡Šäº†å§</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WKWebViewJavascriptBridge</span> : <span class="title">NSObject</span>&lt;<span class="title">WKNavigationDelegate</span>, <span class="title">WebViewJavascriptBridgeBaseDelegate</span>&gt;</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)bridgeForWebView:(<span class="built_in">WKWebView</span>*)webView;</span><br><span class="line">+ (<span class="type">void</span>)enableLogging;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)registerHandler:(<span class="built_in">NSString</span>*)handlerName handler:(WVJBHandler)handler;</span><br><span class="line">- (<span class="type">void</span>)removeHandler:(<span class="built_in">NSString</span>*)handlerName;</span><br><span class="line">- (<span class="type">void</span>)callHandler:(<span class="built_in">NSString</span>*)handlerName data:(<span class="type">id</span>)data responseCallback:(WVJBResponseCallback)responseCallback;</span><br><span class="line">- (<span class="type">void</span>)reset;</span><br><span class="line">- (<span class="type">void</span>)setWebViewDelegate:(<span class="type">id</span>)webViewDelegate;</span><br><span class="line">- (<span class="type">void</span>)disableJavscriptAlertBoxSafetyTimeout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: <code>disableJavscriptAlertBoxSafetyTimeout</code> æ–¹æ³•æ˜¯é€šè¿‡ç¦ç”¨ JS ç«¯ AlertBox çš„å®‰å…¨æ—¶é•¿æ¥åŠ é€Ÿç½‘æ¡¥æ¶ˆæ¯ä¼ é€’çš„ã€‚å¦‚æœæƒ³ä½¿ç”¨é‚£ä¹ˆéœ€è¦å’Œå‰ç«¯çº¦å®šå¥½ï¼Œå¦‚æœç¦ç”¨ä¹‹åå‰ç«¯ JS ä»£ç ä»æœ‰è°ƒç”¨ AlertBox ç›¸å…³ä»£ç ï¼ˆalert, confirm, æˆ– promptï¼‰åˆ™ç¨‹åºå°†è¢«æŒ‚èµ·ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•æ˜¯ä¸å®‰å…¨çš„ï¼Œå¦‚æ— ç‰¹æ®Šéœ€æ±‚ç¬”è€…ä¸æ¨èä½¿ç”¨ã€‚</p>
</blockquote>
<p>å¯ä»¥çœ‹å¾—å‡ºæ¥è¿™ä¸¤ä¸ªæ–‡ä»¶æš´éœ²å‡ºçš„æ¥å£å‡ ä¹ä¸€è‡´ï¼Œå…¶ä¸­ WebViewJavascriptBridge ä¸­ä½¿ç”¨äº†å®å®šä¹‰ <code>WVJB_WEBVIEW_DELEGATE_INTERFACE</code> æ¥åˆ†åˆ«é€‚é… iOS å’Œ Mac OS X å¹³å°çš„ UIWebView å’Œ WebView ç»„ä»¶éœ€è¦å®ç°çš„ä»£ç†æ–¹æ³•ã€‚</p>
<h3 id="WebViewJavascriptBridge-ä¸­çš„å®å®šä¹‰"><a href="#WebViewJavascriptBridge-ä¸­çš„å®å®šä¹‰" class="headerlink" title="WebViewJavascriptBridge ä¸­çš„å®å®šä¹‰"></a>WebViewJavascriptBridge ä¸­çš„å®å®šä¹‰</h3><p>å…¶å® WebViewJavascriptBridge ä¸­ä¸ºäº†é€‚é… iOS å’Œ Mac OS X å¹³å°çš„ UIWebView å’Œ WebView ç»„ä»¶ä½¿ç”¨äº†ä¸€ç³»åˆ—çš„å®å®šä¹‰ï¼Œå…¶æºç æ¯”è¾ƒç®€å•ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> defined __MAC_OS_X_VERSION_MAX_ALLOWED</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_PLATFORM_OSX</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_WEBVIEW_TYPE WebView</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_WEBVIEW_DELEGATE_TYPE NSObject<span class="string">&lt;WebViewJavascriptBridgeBaseDelegate&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_WEBVIEW_DELEGATE_INTERFACE NSObject<span class="string">&lt;WebViewJavascriptBridgeBaseDelegate, WebPolicyDelegate&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined __IPHONE_OS_VERSION_MAX_ALLOWED</span></span><br><span class="line">    <span class="meta">#import <span class="string">&lt;UIKit/UIWebView.h&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_PLATFORM_IOS</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_WEBVIEW_TYPE UIWebView</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_WEBVIEW_DELEGATE_TYPE NSObject<span class="string">&lt;UIWebViewDelegate&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_WEBVIEW_DELEGATE_INTERFACE NSObject<span class="string">&lt;UIWebViewDelegate, WebViewJavascriptBridgeBaseDelegate&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>åˆ†åˆ«æ ¹æ®æ‰€åœ¨å¹³å°ä¸åŒå®šä¹‰äº† <code>WVJB_WEBVIEW_TYPE</code>ï¼Œ<code>WVJB_WEBVIEW_DELEGATE_TYPE</code> ä»¥åŠåˆšæ‰æåˆ°çš„ <code>WVJB_WEBVIEW_DELEGATE_INTERFACE</code> å®å®šä¹‰ï¼Œå¹¶ä¸”åˆ†åˆ«å®šä¹‰äº† <code>WVJB_PLATFORM_OSX</code> å’Œ <code>WVJB_PLATFORM_IOS</code> ä¾¿äºä¹‹åçš„å®ç°æºç åŒºåˆ†å½“å‰å¹³å°æ—¶ä½¿ç”¨ï¼Œä¸‹é¢çš„ <code>supportsWKWebView</code> å®å®šä¹‰ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> (__MAC_OS_X_VERSION_MAX_ALLOWED &gt; __MAC_10_9 || __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= __IPHONE_7_1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> supportsWKWebView</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>åœ¨å¼•å…¥å¤´æ–‡ä»¶çš„æ—¶å€™å¯ä»¥é€šè¿‡è¿™ä¸ª <code>supportsWKWebView</code> å®çµæ´»å¼•å…¥æ‰€éœ€çš„å¤´æ–‡ä»¶ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebViewJavascriptBridge.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined supportsWKWebView</span></span><br><span class="line"><span class="meta">#import <span class="string">&lt;WebKit/WebKit.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// WebViewJavascriptBridge.m</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(supportsWKWebView)</span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;WKWebViewJavascriptBridge.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h3 id="WebViewJavascriptBridge-çš„å®ç°åˆ†æ"><a href="#WebViewJavascriptBridge-çš„å®ç°åˆ†æ" class="headerlink" title="WebViewJavascriptBridge çš„å®ç°åˆ†æ"></a>WebViewJavascriptBridge çš„å®ç°åˆ†æ</h3><p>æˆ‘ä»¬æ¥ç€çœ‹ä¸€ä¸‹ WebViewJavascriptBridge çš„å®ç°éƒ¨åˆ†ï¼Œé¦–å…ˆä»å†…éƒ¨å˜é‡ä¿¡æ¯çœ‹èµ·ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> __has_feature(objc_arc_weak)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_WEAK __weak</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_WEAK __unsafe_unretained</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">WebViewJavascriptBridge</span> </span>&#123;</span><br><span class="line">    WVJB_WEAK WVJB_WEBVIEW_TYPE* _webView; <span class="comment">// bridge å¯¹åº”çš„ WebView ç»„ä»¶</span></span><br><span class="line">    WVJB_WEAK <span class="type">id</span> _webViewDelegate; <span class="comment">// ç»™ WebView ç»„ä»¶è®¾ç½®çš„ä»£ç†ï¼ˆéœ€è¦çš„è¯ï¼‰</span></span><br><span class="line">    <span class="type">long</span> _uniqueId; <span class="comment">// å”¯ä¸€æ ‡è¯†ï¼ŒEmmmmm...ä½†æ˜¯æˆ‘å‘ç°æ²¡åµç”¨ï¼Œåªæœ‰ _base ä¸­çš„ _uniqueId æ‰æœ‰ç”¨</span></span><br><span class="line">    WebViewJavascriptBridgeBase *_base; <span class="comment">// ä¸Šæ–‡è¯´è¿‡ï¼Œåº•å±‚å®ç°å…¶å®éƒ½æ˜¯ WebViewJavascriptBridgeBase åœ¨åš</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šæ–‡æåˆ° WebViewJavascriptBridge å’Œ WKWebViewJavascriptBridge çš„ .h æ–‡ä»¶æš´éœ²æ¥å£ä¿¡æ¯éå¸¸ç›¸ä¼¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦ä¸è¦çœ‹çœ‹ WKWebViewJavascriptBridge çš„å†…éƒ¨å˜é‡ä¿¡æ¯å‘¢ï¼Ÿ</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ³¨é‡Šå‚è§ WebViewJavascriptBridge å°±å¥½</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">WKWebViewJavascriptBridge</span> </span>&#123;</span><br><span class="line">    __<span class="keyword">weak</span> <span class="built_in">WKWebView</span>* _webView;</span><br><span class="line">    __<span class="keyword">weak</span> <span class="type">id</span>&lt;<span class="built_in">WKNavigationDelegate</span>&gt; _webViewDelegate;</span><br><span class="line">    <span class="type">long</span> _uniqueId;</span><br><span class="line">    WebViewJavascriptBridgeBase *_base;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å˜›~ è¿™ä¿©è´§ç®€ç›´æ˜¯ä¸€ä¸ªå¦ˆç”Ÿçš„ã€‚å…¶å®è¿™æ˜¯ä½œè€…æ•…æ„ä¸ºä¹‹ï¼Œå› ä¸ºä½œè€…æƒ³å¯¹å¤–æä¾›ä¸€å¥—æ¥å£ï¼Œå³ WebViewJavascriptBridgeï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ WebViewJavascriptBridge å°±å¯ä»¥è‡ªåŠ¨æ ¹æ®ç»‘å®šçš„ WebView ç»„ä»¶çš„ä¸åŒç”Ÿæˆä¸ä¹‹å¯¹åº”çš„ JSBridge å®ä¾‹ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)bridge:(<span class="type">id</span>)webView &#123;</span><br><span class="line"><span class="comment">// å¦‚æœæ”¯æŒ WKWebView</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined supportsWKWebView</span></span><br><span class="line">    <span class="comment">// éœ€è¦å…ˆåˆ¤æ–­å½“å‰å…¥å‚ webView æ˜¯å¦ä»å±äº WKWebView</span></span><br><span class="line">    <span class="keyword">if</span> ([webView isKindOfClass:[<span class="built_in">WKWebView</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="comment">// è¿”å› WKWebViewJavascriptBridge å®ä¾‹</span></span><br><span class="line">        <span class="keyword">return</span> (WebViewJavascriptBridge*) [<span class="built_in">WKWebViewJavascriptBridge</span> bridgeForWebView:webView];</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰å…¥å‚ webView æ˜¯å¦ä»å±äº WebViewï¼ˆMac OS Xï¼‰æˆ–è€… UIWebViewï¼ˆiOSï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> ([webView isKindOfClass:[WVJB_WEBVIEW_TYPE <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="comment">// è¿”å› WebViewJavascriptBridge å®ä¾‹</span></span><br><span class="line">        WebViewJavascriptBridge* bridge = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">        [bridge _platformSpecificSetup:webView];</span><br><span class="line">        <span class="keyword">return</span> bridge;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æŠ›å‡º BadWebViewType å¼‚å¸¸å¹¶è¿”å› nil</span></span><br><span class="line">    [<span class="built_in">NSException</span> raise:<span class="string">@&quot;BadWebViewType&quot;</span> format:<span class="string">@&quot;Unknown web view type.&quot;</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ä»£ç ï¼Œå®ç°å¹¶ä¸å¤æ‚ã€‚å¦‚æœæ”¯æŒ WKWebView çš„è¯ï¼ˆ<code>#if defined supportsWKWebView</code>ï¼‰åˆ™å»åˆ¤æ–­å½“å‰ç»‘å®šçš„ WebView ç»„ä»¶æ˜¯å¦ä»å±äº WKWebViewï¼Œè¿™æ ·å¯ä»¥è¿”å› WKWebViewJavascriptBridge å®ä¾‹ï¼Œå¦åˆ™è¿”å› WebViewJavascriptBridge å®ä¾‹ï¼Œæœ€åå¦‚æœå…¥å‚ <code>webView</code> çš„ç±»å‹ä¸æ»¡è¶³åˆ¤æ–­æ¡ä»¶åˆ™æŠ›å‡º <code>BadWebViewType</code> å¼‚å¸¸ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªå…³äº <code>_webViewDelegate</code> çš„å°ç»†èŠ‚ï¼Œæœ¬æ¥ä¸æ‰“ç®—è®²çš„ï¼Œä½†æ˜¯è¿˜æ˜¯æä¸€ä¸‹å§ï¼ˆå›§ï¼‰ã€‚å…¶å®åœ¨ WebViewJavascriptBridge ä»¥åŠ WKWebViewJavascriptBridge çš„åˆå§‹åŒ–å®ç°è¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠå½“å‰ WebView ç»„ä»¶çš„ä»£ç†ç»‘å®šä¸ºè‡ªå·±ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebViewJavascriptBridge</span></span><br><span class="line">- (<span class="type">void</span>) _platformSpecificSetup:(WVJB_WEBVIEW_TYPE*)webView &#123;</span><br><span class="line">    _webView = webView;</span><br><span class="line">    _webView.delegate = <span class="keyword">self</span>;</span><br><span class="line">    _base = [[WebViewJavascriptBridgeBase alloc] init];</span><br><span class="line">    _base.delegate = <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WKWebViewJavascriptBridge</span></span><br><span class="line">- (<span class="type">void</span>) _setupInstance:(<span class="built_in">WKWebView</span>*)webView &#123;</span><br><span class="line">    _webView = webView;</span><br><span class="line">    _webView.navigationDelegate = <span class="keyword">self</span>;</span><br><span class="line">    _base = [[WebViewJavascriptBridgeBase alloc] init];</span><br><span class="line">    _base.delegate = <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: æ›¿æ¢ç»„ä»¶çš„ä»£ç†å°†å…¶ä»£ç†ç»‘å®šä¸º bridge è‡ªå·±æ˜¯å› ä¸º WebViewJavascriptBridge çš„å®ç°åŸç†ä¸Šæ˜¯åˆ©ç”¨æˆ‘ä¹‹å‰çš„æ–‡ç« <a href="https://lision.me/ios-native-js/">ã€ŠiOS ä¸ JS äº¤äº’å¼€å‘çŸ¥è¯†æ€»ç»“ã€‹</a>ä¸­è®²è¿‡çš„å‡ Request æ–¹æ³•å®ç°çš„ï¼Œæ‰€ä»¥éœ€è¦ç›‘å¬ WebView ç»„ä»¶çš„ä»£ç†æ–¹æ³•è·å–åŠ è½½ä¹‹å‰çš„ Request.URL å¹¶åšå¤„ç†ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ WebViewJavascriptBridge æä¾›äº†ä¸€ä¸ªæ¥å£ <code>setWebViewDelegate:</code> å­˜å‚¨äº†ä¸€ä¸ªé€»è¾‘ä¸Šçš„ <code>_webViewDelegate</code>ï¼Œè¿™ä¸ª <code>_webViewDelegate</code> ä¹Ÿéœ€è¦éµå¾ª WebView ç»„ä»¶çš„ä»£ç†åè®®ï¼Œè¿™æ ·åœ¨ WebViewJavascriptBridge å†…éƒ¨ä¸åŒçš„ä»£ç†æ–¹æ³•ä¸­åšå®Œ bridge è¦åšçš„äº‹æƒ…åªæœ‰å°±ä¼šå†å»è°ƒç”¨ <code>_webViewDelegate</code> å¯¹åº”çš„ä»£ç†æ–¹æ³•ï¼Œå…¶å®å¯ä»¥ç†è§£ä¸º WebViewJavascriptBridge å¯¹å½“å‰ WebView ç»„ä»¶çš„ä»£ç†åšäº† hookã€‚</p>
</blockquote>
<p>å¯¹äº WebViewJavascriptBridge ä¸­æš´éœ²çš„åˆå§‹åŒ–ä»¥å¤–çš„æ‰€æœ‰æ¥å£ï¼Œå…¶å†…éƒ¨å®ç°éƒ½æ˜¯é€šè¿‡ WebViewJavascriptBridgeBase æ¥å®ç°çš„ã€‚è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯<strong>å³ä½¿ WebViewJavascriptBridge å› ä¸ºç»‘å®šäº† WKWebView è¿”å›äº† WKWebViewJavascriptBridge å®ä¾‹ï¼Œåªè¦æ¥å£ä¸€è‡´ï¼Œå¯¹ JSBridge å‘é€ç›¸åŒçš„æ¶ˆæ¯ï¼Œå°±ä¼šæœ‰ç›¸åŒçš„å®ç°ï¼ˆéƒ½æ˜¯ç”± WebViewJavascriptBridgeBase ç±»å®ç°çš„ï¼‰</strong>ã€‚</p>
<h2 id="WebViewJavascriptBridgeBase-JS-è°ƒç”¨-Native-å®ç°åŸç†å‰–æ"><a href="#WebViewJavascriptBridgeBase-JS-è°ƒç”¨-Native-å®ç°åŸç†å‰–æ" class="headerlink" title="WebViewJavascriptBridgeBase - JS è°ƒç”¨ Native å®ç°åŸç†å‰–æ"></a>WebViewJavascriptBridgeBase - JS è°ƒç”¨ Native å®ç°åŸç†å‰–æ</h2><img src="/webview_javascript_bridge/pier.jpg" class="">
<p>ä½œä¸º WebViewJavascriptBridge çš„å®ç°å±‚ï¼ŒWebViewJavascriptBridgeBase çš„å‘½åä¹Ÿå¯ä»¥ä½“ç°å‡ºå…¶æ˜¯ä½œä¸ºæ•´åº§â€œæ¡¥æ¢â€æ¡¥å¢©ä¸€èˆ¬çš„å­˜åœ¨ï¼Œæˆ‘ä»¬è¿˜æ˜¯æŒ‰ç…§è€è§„çŸ©å…ˆçœ‹ä¸€ä¸‹ WebViewJavascriptBridgeBase.h æš´éœ²çš„ä¿¡æ¯ï¼Œå¥½å¯¹å…¶æœ‰ä¸€ä¸ªæ•´ä½“çš„å°è±¡ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">void</span> (^WVJBResponseCallback)(<span class="type">id</span> responseData); <span class="comment">// å›è°ƒ block</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">void</span> (^WVJBHandler)(<span class="type">id</span> data, WVJBResponseCallback responseCallback); <span class="comment">// æ³¨å†Œçš„ Handler block</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NSDictionary</span> WVJBMessage; <span class="comment">// æ¶ˆæ¯ç±»å‹ - å­—å…¸</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">WebViewJavascriptBridgeBaseDelegate</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line">- (<span class="built_in">NSString</span>*) _evaluateJavascript:(<span class="built_in">NSString</span>*)javascriptCommand;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WebViewJavascriptBridgeBase</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="type">id</span> &lt;WebViewJavascriptBridgeBaseDelegate&gt; delegate; <span class="comment">// ä»£ç†ï¼ŒæŒ‡å‘æ¥å£å±‚ç±»ï¼Œç”¨ä»¥ç»™å¯¹åº”æ¥å£ç»‘å®šçš„ WebView ç»„ä»¶å‘é€æ‰§è¡Œ JS æ¶ˆæ¯</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSMutableArray</span>* startupMessageQueue; <span class="comment">// å¯åŠ¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯ä»¥ç†è§£ä¸ºå­˜æ”¾ WVJBMessage</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSMutableDictionary</span>* responseCallbacks; <span class="comment">// å›è°ƒ blocks å­—å…¸ï¼Œå­˜æ”¾ WVJBResponseCallback ç±»å‹çš„ block</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSMutableDictionary</span>* messageHandlers; <span class="comment">// å·²æ³¨å†Œçš„ handlers å­—å…¸ï¼Œå­˜æ”¾ WVJBHandler ç±»å‹çš„ block</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) WVJBHandler messageHandler; <span class="comment">// æ²¡åµç”¨</span></span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)enableLogging; <span class="comment">// å¼€å¯æ—¥å¿—</span></span><br><span class="line">+ (<span class="type">void</span>)setLogMaxLength:(<span class="type">int</span>)length; <span class="comment">// è®¾ç½®æ—¥å¿—æœ€å¤§é•¿åº¦</span></span><br><span class="line">- (<span class="type">void</span>)reset; <span class="comment">// å¯¹åº” WKJSBridge çš„ reset æ¥å£</span></span><br><span class="line">- (<span class="type">void</span>)sendData:(<span class="type">id</span>)data responseCallback:(WVJBResponseCallback)responseCallback handlerName:(<span class="built_in">NSString</span>*)handlerName; <span class="comment">// å‘é€æ¶ˆæ¯ï¼Œå…¥å‚ä¾æ¬¡æ˜¯å‚æ•°ï¼Œå›è°ƒ blockï¼Œå¯¹åº” JS ç«¯æ³¨å†Œçš„ HandlerName</span></span><br><span class="line">- (<span class="type">void</span>)flushMessageQueue:(<span class="built_in">NSString</span> *)messageQueueString; <span class="comment">// åˆ·æ–°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ ¸å¿ƒä»£ç </span></span><br><span class="line">- (<span class="type">void</span>)injectJavascriptFile; <span class="comment">// æ³¨å…¥ JS</span></span><br><span class="line">- (<span class="type">BOOL</span>)isWebViewJavascriptBridgeURL:(<span class="built_in">NSURL</span>*)url; <span class="comment">// åˆ¤å®šæ˜¯å¦ä¸º WebViewJavascriptBridgeURL</span></span><br><span class="line">- (<span class="type">BOOL</span>)isQueueMessageURL:(<span class="built_in">NSURL</span>*)urll; <span class="comment">// åˆ¤å®šæ˜¯å¦ä¸ºé˜Ÿåˆ—æ¶ˆæ¯ URL</span></span><br><span class="line">- (<span class="type">BOOL</span>)isBridgeLoadedURL:(<span class="built_in">NSURL</span>*)urll; <span class="comment">// åˆ¤å®šæ˜¯å¦ä¸º bridge è½½å…¥ URL</span></span><br><span class="line">- (<span class="type">void</span>)logUnkownMessage:(<span class="built_in">NSURL</span>*)url; <span class="comment">// æ‰“å°æ”¶åˆ°æœªçŸ¥æ¶ˆæ¯ä¿¡æ¯</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)webViewJavascriptCheckCommand; <span class="comment">// JS bridge æ£€æµ‹å‘½ä»¤</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)webViewJavascriptFetchQueyCommand; <span class="comment">// JS bridge è·å–æŸ¥è¯¢å‘½ä»¤</span></span><br><span class="line">- (<span class="type">void</span>)disableJavscriptAlertBoxSafetyTimeout; <span class="comment">// ç¦ç”¨ JS AlertBox å®‰å…¨æ—¶é•¿ä»¥è·å–å‘é€æ¶ˆæ¯é€Ÿåº¦æå‡ï¼Œä¸å»ºè®®ä½¿ç”¨ï¼Œç†ç”±è§ä¸Šæ–‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>å˜›~ ä» .h æ–‡ä»¶ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•´ä¸ª WebViewJavascriptBridgeBase æ‰€æš´éœ²å‡ºæ¥çš„ä¿¡æ¯ï¼Œå±æ€§å±‚é¢ä¸Šéœ€è¦å¯¹ä»¥ä¸‹ 4 ä¸ªå±æ€§åŠ æ·±å°è±¡ï¼Œä¹‹ååˆ†æå®ç°çš„è¿‡ç¨‹ä¸­ä¼šå¸¦å…¥è¿™äº›å±æ€§ï¼š</p>
<ul>
<li><code>id &lt;WebViewJavascriptBridgeBaseDelegate&gt; delegate</code> ä»£ç†ï¼Œå¯ä»¥é€šè¿‡ä»£ç†è®©å½“å‰ bridge ç»‘å®šçš„ WebView ç»„ä»¶æ‰§è¡Œ JS ä»£ç </li>
<li><code>NSMutableArray* startupMessageQueue;</code> å¯åŠ¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå­˜æ”¾ Obj-C å‘é€ç»™ JS çš„æ¶ˆæ¯ï¼ˆå¯ä»¥ç†è§£ä¸ºå­˜æ”¾ <code>WVJBMessage</code> ç±»å‹ï¼‰</li>
<li><code>NSMutableDictionary* responseCallbacks;</code> å›è°ƒ blocks å­—å…¸ï¼Œå­˜æ”¾ <code>WVJBResponseCallback</code> ç±»å‹çš„ block</li>
<li><code>NSMutableDictionary* messageHandlers;</code> Obj-C ç«¯å·²æ³¨å†Œçš„ handlers å­—å…¸ï¼Œå­˜æ”¾ <code>WVJBHandler</code> ç±»å‹çš„ block</li>
</ul>
<p>Emmmmmâ€¦æ¥å£å±‚é¢çœ‹ä¸€ä¸‹æ³¨é‡Šå°±å¥½äº†ï¼Œåé¢åˆ†æå®ç°çš„æ—¶å€™ä¼šæå¸¦è®²è§£ä¸€äº›æ¥å£ï¼Œå‰©ä¸‹ä¸€äº›è·Ÿå®ç°æ— å…³çš„æ¥å£å†…å®¹æ„Ÿå…´è¶£çš„åŒå­¦æ¨èè‡ªå·±æ‰’æºç å“ˆã€‚</p>
<p>æˆ‘ä»¬åœ¨å¯¹ WebViewJavascriptBridgeBase æ•´ä½“æœ‰äº†ä¸€ä¸ªåˆå§‹å°è±¡ä¹‹åå°±å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªé¡µé¢ï¼Œç®€å•çš„åµŒå…¥ä¸€äº› JS è·‘ä¸€éæµç¨‹ï¼Œåœ¨ä¸­é—´ä¸‹æ–­ç‚¹æ‰’æºç ï¼Œè¿™æ ·æˆ‘ä»¬å¯¹äº Native ä¸ JS çš„äº¤äº’æµç¨‹å°±å¯ä»¥ä¸€æ¸…äºŒæ¥šäº†ã€‚</p>
<p><strong>ä¸‹é¢æ¨¡æ‹Ÿä¸€é JS é€šè¿‡ WebViewJavascriptBridge è°ƒç”¨ Native åŠŸèƒ½çš„æµç¨‹åˆ†æ WebViewJavascriptBridgeBase çš„ç›¸å…³å®ç°</strong>ï¼ˆè€ƒè™‘ç°åœ¨çš„æ—¶é—´ç‚¹å†³å®šä»¥ WKWebView ä¸ºä¾‹è®²è§£ï¼Œå³é’ˆå¯¹ WKWebViewJavascriptBridge æºç è®²è§£ï¼‰ï¼š</p>
<h3 id="1-ç›‘å¬å‡-Request-å¹¶æ³¨å…¥-WebViewJavascriptBridge-JS-å†…çš„-JS-ä»£ç "><a href="#1-ç›‘å¬å‡-Request-å¹¶æ³¨å…¥-WebViewJavascriptBridge-JS-å†…çš„-JS-ä»£ç " class="headerlink" title="1.ç›‘å¬å‡ Request å¹¶æ³¨å…¥ WebViewJavascriptBridge_JS å†…çš„ JS ä»£ç "></a>1.ç›‘å¬å‡ Request å¹¶æ³¨å…¥ WebViewJavascriptBridge_JS å†…çš„ JS ä»£ç </h3><p>ä¸Šæ–‡è¯´åˆ° WebViewJavascriptBridge çš„å®ç°å…¶å®æœ¬è´¨ä¸Šæ˜¯åˆ©ç”¨äº†æˆ‘ä¹‹å‰çš„æ–‡ç« <a href="https://lision.me/ios-native-js/">ã€ŠiOS ä¸ JS äº¤äº’å¼€å‘çŸ¥è¯†æ€»ç»“ã€‹</a>ä¸­è®²è¿‡çš„å‡ Request æ–¹æ³•å®ç°çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä»ç›‘å¬å‡ Request å¼€å§‹è®²èµ·å§ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WKNavigationDelegate åè®®æ–¹æ³•ï¼Œç”¨äºç›‘å¬ Request å¹¶å†³å®šæ˜¯å¦å…è®¸å¯¼èˆª</span></span><br><span class="line">- (<span class="type">void</span>)webView:(<span class="built_in">WKWebView</span> *)webView decidePolicyForNavigationAction:(<span class="built_in">WKNavigationAction</span> *)navigationAction decisionHandler:(<span class="type">void</span> (^)(<span class="built_in">WKNavigationActionPolicy</span>))decisionHandler &#123;</span><br><span class="line">    <span class="comment">// webView æ ¡éªŒ</span></span><br><span class="line">    <span class="keyword">if</span> (webView != _webView) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">    <span class="built_in">NSURL</span> *url = navigationAction.request.URL;</span><br><span class="line">    __<span class="keyword">strong</span> <span class="keyword">typeof</span>(_webViewDelegate) strongDelegate = _webViewDelegate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¸å¿ƒä»£ç </span></span><br><span class="line">    <span class="keyword">if</span> ([_base isWebViewJavascriptBridgeURL:url]) &#123; <span class="comment">// åˆ¤å®š WebViewJavascriptBridgeURL</span></span><br><span class="line">        <span class="keyword">if</span> ([_base isBridgeLoadedURL:url]) &#123; <span class="comment">// åˆ¤å®š BridgeLoadedURL</span></span><br><span class="line">            <span class="comment">// æ³¨å…¥ JS ä»£ç </span></span><br><span class="line">            [_base injectJavascriptFile];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([_base isQueueMessageURL:url]) &#123; <span class="comment">// åˆ¤å®š QueueMessageURL</span></span><br><span class="line">            <span class="comment">// åˆ·æ–°æ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">            [<span class="keyword">self</span> <span class="built_in">WKFlushMessageQueue</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è®°å½•æœªçŸ¥ bridge msg æ—¥å¿—</span></span><br><span class="line">            [_base logUnkownMessage:url];</span><br><span class="line">        &#125;</span><br><span class="line">        decisionHandler(<span class="built_in">WKNavigationActionPolicyCancel</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è°ƒç”¨ _webViewDelegate å¯¹åº”çš„ä»£ç†æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (strongDelegate &amp;&amp; [strongDelegate respondsToSelector:<span class="keyword">@selector</span>(webView:decidePolicyForNavigationAction:decisionHandler:)]) &#123;</span><br><span class="line">        [_webViewDelegate webView:webView decidePolicyForNavigationAction:navigationAction decisionHandler:decisionHandler];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        decisionHandler(<span class="built_in">WKNavigationActionPolicyAllow</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: ä¹‹å‰è¯´è¿‡ WebViewJavascriptBridge ä¼š hook ç»‘å®šçš„ WebView çš„ä»£ç†æ–¹æ³•ï¼Œè¿™ä¸€ç‚¹ WKWebViewJavascriptBridge ä¹Ÿä¸€æ ·ï¼Œåœ¨åŠ å…¥è‡ªå·±çš„ä»£ç ä¹‹åä¼šåˆ¤æ–­æ˜¯å¦æœ‰ <code>_webViewDelegate</code> å“åº”è¿™ä¸ªä»£ç†æ–¹æ³•ï¼Œå¦‚æœæœ‰åˆ™è°ƒç”¨ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬è¿˜æ˜¯æŠŠæ³¨æ„åŠ›æ”¾åˆ°æ³¨é‡Šä¸­æ ¸å¿ƒä»£ç çš„ä½ç½®ï¼Œé‡Œé¢ä¼šå…ˆåˆ¤æ–­å½“å‰ url æ˜¯å¦ä¸º bridge urlï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç›¸å…³å®å®šä¹‰</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> kOldProtocolScheme @<span class="string">&quot;wvjbscheme&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> kNewProtocolScheme @<span class="string">&quot;https&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> kQueueHasMessage   @<span class="string">&quot;__wvjb_queue_message__&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> kBridgeLoaded      @<span class="string">&quot;__bridge_loaded__&quot;</span></span></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/marcuswestin/WebViewJavascriptBridge">WebViewJavascriptBridge GitHub é¡µé¢</a> çš„ä½¿ç”¨æ–¹æ³•ä¸­ç¬¬ 4 æ­¥æ˜ç¡®æŒ‡å‡ºè¦å¤åˆ¶ç²˜è´´ <code>setupWebViewJavascriptBridge</code> æ–¹æ³•åˆ°å‰æ®µ JS ä¸­ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹è¿™æ®µ JS æ–¹æ³•æºç ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupWebViewJavascriptBridge</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">WebViewJavascriptBridge</span>) &#123; <span class="keyword">return</span> <span class="title function_">callback</span>(<span class="title class_">WebViewJavascriptBridge</span>); &#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">WVJBCallbacks</span>) &#123; <span class="keyword">return</span> <span class="variable language_">window</span>.<span class="property">WVJBCallbacks</span>.<span class="title function_">push</span>(callback); &#125;</span><br><span class="line">	<span class="variable language_">window</span>.<span class="property">WVJBCallbacks</span> = [callback];</span><br><span class="line">	<span class="comment">// åˆ›å»ºä¸€ä¸ª iframe</span></span><br><span class="line">	<span class="keyword">var</span> <span class="title class_">WVJBIframe</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;iframe&#x27;</span>);</span><br><span class="line">	<span class="comment">// è®¾ç½® iframe ä¸ºä¸æ˜¾ç¤º</span></span><br><span class="line">	<span class="title class_">WVJBIframe</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">	<span class="comment">// å°† iframe çš„ src ç½®ä¸º &#x27;https://__bridge_loaded__&#x27;</span></span><br><span class="line">	<span class="title class_">WVJBIframe</span>.<span class="property">src</span> = <span class="string">&#x27;https://__bridge_loaded__&#x27;</span>;</span><br><span class="line">	<span class="comment">// å°† iframe åŠ å…¥åˆ° document.documentElement</span></span><br><span class="line">	<span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="title function_">appendChild</span>(<span class="title class_">WVJBIframe</span>);</span><br><span class="line">	<span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="title function_">removeChild</span>(<span class="title class_">WVJBIframe</span>) &#125;, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ªä¸æ˜¾ç¤ºçš„ iframe å¹¶å°†å…¶ src ç½®ä¸º <code>https://__bridge_loaded__</code>ï¼Œä¸ä¸Šæ–‡ä¸­ <code>kBridgeLoaded</code> å®å®šä¹‰ä¸€è‡´ï¼Œå³ç”¨äº <code>isBridgeLoadedURL:</code> æ–¹æ³•ä¸­åˆ¤å®šå½“å‰ url æ˜¯å¦ä¸º BridgeLoadedURLã€‚</p>
<blockquote>
<p>Note: å‡ Request çš„å‘èµ·æœ‰ä¸¤ç§æ–¹å¼ï¼Œ-1:<code>location.href</code> -2:<code>iframe</code>ã€‚é€šè¿‡ <code>location.href</code> æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚æœ JS å¤šæ¬¡è°ƒç”¨åŸç”Ÿçš„æ–¹æ³•ä¹Ÿå°±æ˜¯ <code>location.href</code> çš„å€¼å¤šæ¬¡å˜åŒ–ï¼ŒNative ç«¯åªèƒ½æ¥å—åˆ°æœ€åä¸€æ¬¡è¯·æ±‚ï¼Œå‰é¢çš„è¯·æ±‚ä¼šè¢«å¿½ç•¥æ‰ï¼Œæ‰€ä»¥è¿™é‡Œ WebViewJavascriptBridge é€‰æ‹©ä½¿ç”¨ iframeï¼Œåé¢ä¸å†è§£é‡Šã€‚</p>
</blockquote>
<p>å› ä¸ºåŠ å…¥äº† src ä¸º <code>https://__bridge_loaded__</code> çš„ iframe å…ƒç´ ï¼Œæˆ‘ä»¬ä¸Šé¢æˆªè· url çš„ä»£ç†æ–¹æ³•å°±ä¼šæ‹¿åˆ°ä¸€ä¸ª <code>https://__bridge_loaded__</code> çš„ urlï¼Œç”±äº https æ»¡è¶³åˆ¤å®š WebViewJavascriptBridgeURLï¼Œå°†ä¼šè¿›å…¥æ ¸å¿ƒä»£ç åŒºåŸŸæ¥ç€ä¼šè¢«åˆ¤å®šä¸º BridgeLoadedURL æ‰§è¡Œæ³¨å…¥ JS ä»£ç çš„æ–¹æ³•ï¼Œå³ <code>[_base injectJavascriptFile];</code>ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)injectJavascriptFile &#123;</span><br><span class="line">    <span class="comment">// è·å–åˆ° WebViewJavascriptBridge_JS çš„ä»£ç </span></span><br><span class="line">    <span class="built_in">NSString</span> *js = WebViewJavascriptBridge_js();</span><br><span class="line">    <span class="comment">// å°†è·å–åˆ°çš„ js é€šè¿‡ä»£ç†æ–¹æ³•æ³¨å…¥åˆ°å½“å‰ç»‘å®šçš„ WebView ç»„ä»¶</span></span><br><span class="line">    [<span class="keyword">self</span> _evaluateJavascript:js];</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰å·²æœ‰æ¶ˆæ¯é˜Ÿåˆ—åˆ™éå†å¹¶åˆ†å‘æ¶ˆæ¯ï¼Œä¹‹åæ¸…ç©ºæ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.startupMessageQueue) &#123;</span><br><span class="line">        <span class="built_in">NSArray</span>* queue = <span class="keyword">self</span>.startupMessageQueue;</span><br><span class="line">        <span class="keyword">self</span>.startupMessageQueue = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">id</span> queuedMessage <span class="keyword">in</span> queue) &#123;</span><br><span class="line">            [<span class="keyword">self</span> _dispatchMessage:queuedMessage];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œç¬¬ä¸€æ­¥äº¤äº’å·²å®Œæˆã€‚å…³äº WebViewJavascriptBridge_JS å†…éƒ¨çš„ JS ä»£ç æˆ‘ä»¬æ”¾åˆ°åé¢çš„ç« èŠ‚è§£è¯»ï¼Œç°åœ¨å¯ä»¥ç®€å•ç†è§£ä¸º WebViewJavascriptBridge åœ¨ JS ç«¯çš„å…·ä½“å®ç°ä»£ç ã€‚</p>
<h3 id="2-JS-ç«¯è°ƒç”¨-callHandler-æ–¹æ³•ä¹‹å-Native-ç«¯ç©¶ç«Ÿæ˜¯å¦‚ä½•å“åº”çš„ï¼Ÿ"><a href="#2-JS-ç«¯è°ƒç”¨-callHandler-æ–¹æ³•ä¹‹å-Native-ç«¯ç©¶ç«Ÿæ˜¯å¦‚ä½•å“åº”çš„ï¼Ÿ" class="headerlink" title="2.JS ç«¯è°ƒç”¨ callHandler æ–¹æ³•ä¹‹å Native ç«¯ç©¶ç«Ÿæ˜¯å¦‚ä½•å“åº”çš„ï¼Ÿ"></a>2.JS ç«¯è°ƒç”¨ <code>callHandler</code> æ–¹æ³•ä¹‹å Native ç«¯ç©¶ç«Ÿæ˜¯å¦‚ä½•å“åº”çš„ï¼Ÿ</h3><p><a target="_blank" rel="noopener" href="https://github.com/marcuswestin/WebViewJavascriptBridge">WebViewJavascriptBridge GitHub é¡µé¢</a> ä¸­æŒ‡å‡º JS ç«¯çš„æ“ä½œæ–¹å¼ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setupWebViewJavascriptBridge</span>(<span class="keyword">function</span>(<span class="params">bridge</span>) &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* Initialize your app here */</span></span><br><span class="line"></span><br><span class="line">	bridge.<span class="title function_">registerHandler</span>(<span class="string">&#x27;JS Echo&#x27;</span>, <span class="keyword">function</span>(<span class="params">data, responseCallback</span>) &#123;</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;JS Echo called with:&quot;</span>, data)</span><br><span class="line">		<span class="title function_">responseCallback</span>(data)</span><br><span class="line">	&#125;)</span><br><span class="line">	bridge.<span class="title function_">callHandler</span>(<span class="string">&#x27;ObjC Echo&#x27;</span>, &#123;<span class="string">&#x27;key&#x27;</span>:<span class="string">&#x27;value&#x27;</span>&#125;, <span class="keyword">function</span> <span class="title function_">responseCallback</span>(<span class="params">responseData</span>) &#123;</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;JS received response:&quot;</span>, responseData)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çŸ¥é“ JS ç«¯è°ƒç”¨ <code>setupWebViewJavascriptBridge</code> æ–¹æ³•ä¼šèµ°æˆ‘ä»¬åˆšæ‰åˆ†æè¿‡çš„ç¬¬ä¸€æ­¥ï¼Œå³ç›‘å¬å‡ Request å¹¶æ³¨å…¥ WebViewJavascriptBridge_JS å†…çš„ JS ä»£ç ã€‚é‚£ä¹ˆå½“ JS ç«¯è°ƒç”¨ <code>bridge.callHandler</code> æ—¶ï¼ŒNative ç«¯ç©¶ç«Ÿæ˜¯å¦‚ä½•åšå‡ºå“åº”çš„å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬éœ€è¦å…ˆç¨å¾®è§£è¯»ä¸€ä¸‹ä¹‹å‰æ³¨å…¥çš„ WebViewJavascriptBridge_JS ä¸­çš„ JS ä»£ç ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨ iOS handlerï¼Œå‚æ•°æ ¡éªŒä¹‹åè°ƒç”¨ _doSend å‡½æ•°</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">callHandler</span>(<span class="params">handlerName, data, responseCallback</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable language_">arguments</span>.<span class="property">length</span> == <span class="number">2</span> &amp;&amp; <span class="keyword">typeof</span> data == <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">		responseCallback = data;</span><br><span class="line">		data = <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="title function_">_doSend</span>(&#123; <span class="attr">handlerName</span>:handlerName, <span class="attr">data</span>:data &#125;, responseCallback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœ‰å›è°ƒï¼Œåˆ™è®¾ç½® message[&#x27;callbackId&#x27;] ä¸ responseCallbacks[callbackId]</span></span><br><span class="line"><span class="comment">// å°† msg åŠ å…¥ sendMessageQueue æ•°ç»„ï¼Œè®¾ç½® messagingIframe.src</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_doSend</span>(<span class="params">message, responseCallback</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> (responseCallback) &#123;</span><br><span class="line">		<span class="keyword">var</span> callbackId = <span class="string">&#x27;cb_&#x27;</span>+(uniqueId++)+<span class="string">&#x27;_&#x27;</span>+<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line">		responseCallbacks[callbackId] = responseCallback;</span><br><span class="line">		message[<span class="string">&#x27;callbackId&#x27;</span>] = callbackId;</span><br><span class="line">	&#125;</span><br><span class="line">	sendMessageQueue.<span class="title function_">push</span>(message);</span><br><span class="line">	messagingIframe.<span class="property">src</span> = <span class="variable constant_">CUSTOM_PROTOCOL_SCHEME</span> + <span class="string">&#x27;://&#x27;</span> + <span class="variable constant_">QUEUE_HAS_MESSAGE</span>;</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line"><span class="comment">// scheme ä½¿ç”¨ https ä¹‹åé€šè¿‡ host åšåŒ¹é…</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">CUSTOM_PROTOCOL_SCHEME</span> = <span class="string">&#x27;https&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">QUEUE_HAS_MESSAGE</span> = <span class="string">&#x27;__wvjb_queue_message__&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ° JS ç«¯çš„ä»£ç ä¸­æœ‰ <code>callHandler</code> å‡½æ•°çš„å®ç°ï¼Œå…¶å†…éƒ¨å°†å…¥å‚ <code>handlerName</code> ä»¥åŠ <code>data</code> ä»¥å­—å…¸å½¢å¼ä½œä¸ºå‚æ•°è°ƒç”¨ <code>_doSend</code> æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>_doSend</code> æ–¹æ³•çš„å®ç°ï¼š</p>
<ul>
<li><code>_doSend</code> æ–¹æ³•å†…éƒ¨ä¼šå…ˆåˆ¤æ–­å…¥å‚ä¸­æ˜¯å¦æœ‰å›è°ƒ</li>
<li>å¦‚æœæœ‰å›è°ƒåˆ™æ ¹æ®è§„åˆ™ç”Ÿæˆ <code>callbackId</code> å¹¶ä¸”å°†å›è°ƒ block ä¿å­˜åˆ° <code>responseCallbacks</code> å­—å…¸ï¼ˆå›§~ JS ä¸å«å­—å…¸çš„ï¼Œæˆ‘æ˜¯ä¸ºäº† iOS è¯»è€…çœ‹ç€æ–¹ä¾¿ï¼‰ï¼Œä¹‹åç»™æ¶ˆæ¯ä¹ŸåŠ å…¥ä¸€ä¸ªé”®å€¼å¯¹ä¿å­˜åˆšæ‰ç”Ÿæˆçš„ <code>callbackId</code></li>
<li>ä¹‹åç»™ <code>sendMessageQueue</code> é˜Ÿåˆ—åŠ å…¥ <code>message</code></li>
<li>å°† <code>messagingIframe.src</code> è®¾ç½®ä¸º <code>https://__wvjb_queue_message__</code></li>
</ul>
<p>å¥½ï¼Œç‚¹åˆ°ä¸ºæ­¢ï¼Œå¯¹äº WebViewJavascriptBridge_JS å†…çš„ JS ç«¯å…¶ä»–æºç æˆ‘ä»¬æ”¾ç€åé¢çœ‹ã€‚æ³¨æ„è¿™é‡ŒåŠ å…¥äº†ä¸€ä¸ª src ä¸º <code>https://__wvjb_queue_message__</code> çš„ <code>messagingIframe</code>ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªä¸å¯è§çš„ iframeã€‚è¿™æ · Native ç«¯ä¼šæ”¶åˆ°ä¸€ä¸ª url ä¸º <code>https://__wvjb_queue_message__</code> çš„ requestï¼Œå›åˆ°ç¬¬ 1 æ­¥ä¸­è·å–åˆ°å‡çš„ request ä¹‹åä¼šè¿›è¡Œå„é¡¹åˆ¤å®šï¼Œè¿™æ¬¡ä¼šæ»¡è¶³ <code>[_base isQueueMessageURL:url]</code> çš„åˆ¤å®šè°ƒç”¨ Native çš„ <code>WKFlushMessageQueue</code> æ–¹æ³•ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)<span class="built_in">WKFlushMessageQueue</span> &#123;</span><br><span class="line">    <span class="comment">// æ‰§è¡Œ WebViewJavascriptBridge._fetchQueue(); æ–¹æ³•</span></span><br><span class="line">    [_webView evaluateJavaScript:[_base webViewJavascriptFetchQueyCommand] completionHandler:^(<span class="built_in">NSString</span>* result, <span class="built_in">NSError</span>* error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error != <span class="literal">nil</span>) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;WebViewJavascriptBridge: WARNING: Error when trying to fetch data from WKWebView: %@&quot;</span>, error);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨</span></span><br><span class="line">        [_base flushMessageQueue:result];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)webViewJavascriptFetchQueyCommand &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;WebViewJavascriptBridge._fetchQueue();&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯è§ Native ç«¯ä¼šåœ¨åˆ·æ–°é˜Ÿåˆ—ä¸­è°ƒç”¨ JS ç«¯çš„ <code>WebViewJavascriptBridge._fetchQueue();</code> æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ JS ç«¯æ­¤æ–¹æ³•çš„å…·ä½“å®ç°ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–é˜Ÿåˆ—ï¼Œåœ¨ iOS ç«¯åˆ·æ–°æ¶ˆæ¯é˜Ÿåˆ—æ—¶ä¼šè°ƒç”¨æ­¤å‡½æ•°</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_fetchQueue</span>(<span class="params"></span>) &#123;</span><br><span class="line">   <span class="comment">// å°† sendMessageQueue è½¬ä¸º JSON æ ¼å¼</span></span><br><span class="line">	<span class="keyword">var</span> messageQueueString = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(sendMessageQueue);</span><br><span class="line">	<span class="comment">// é‡ç½® sendMessageQueue</span></span><br><span class="line">	sendMessageQueue = [];</span><br><span class="line">	<span class="comment">// è¿”å› JSON æ ¼å¼çš„ </span></span><br><span class="line">	<span class="keyword">return</span> messageQueueString;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•ä¼šæŠŠå½“å‰ JS ç«¯ <code>sendMessageQueue</code> æ¶ˆæ¯é˜Ÿåˆ—ä»¥ JSON çš„å½¢å¼è¿”å›ï¼Œè€Œ Native ç«¯ä¼šè°ƒç”¨ <code>[_base flushMessageQueue:result];</code> å°†æ‹¿åˆ°çš„ JSON å½¢å¼æ¶ˆæ¯é˜Ÿåˆ—ä½œä¸ºå‚æ•°è°ƒç”¨ <code>flushMessageQueue:</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯æ•´ä¸ªæ¡†æ¶ Native ç«¯çš„ç²¾åæ‰€åœ¨ï¼Œå°±æ˜¯ç¨å¾®æœ‰ç‚¹é•¿ï¼ˆç¬‘ï¼‰ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)flushMessageQueue:(<span class="built_in">NSString</span> *)messageQueueString &#123;</span><br><span class="line">    <span class="comment">// æ ¡éªŒ messageQueueString</span></span><br><span class="line">    <span class="keyword">if</span> (messageQueueString == <span class="literal">nil</span> || messageQueueString.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;WebViewJavascriptBridge: WARNING: ObjC got nil while fetching the message queue JSON from webview. This can happen if the WebViewJavascriptBridge JS is not currently present in the webview, e.g if the webview just loaded a new page.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† messageQueueString é€šè¿‡ NSJSONSerialization è§£ä¸º messages å¹¶éå†</span></span><br><span class="line">    <span class="type">id</span> messages = [<span class="keyword">self</span> _deserializeMessageJSON:messageQueueString];</span><br><span class="line">    <span class="keyword">for</span> (WVJBMessage* message <span class="keyword">in</span> messages) &#123;</span><br><span class="line">        <span class="comment">// ç±»å‹æ ¡éªŒ</span></span><br><span class="line">        <span class="keyword">if</span> (![message isKindOfClass:[WVJBMessage <span class="keyword">class</span>]]) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;WebViewJavascriptBridge: WARNING: Invalid %@ received: %@&quot;</span>, [message <span class="keyword">class</span>], message);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="keyword">self</span> _log:<span class="string">@&quot;RCVD&quot;</span> json:message];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å°è¯•å– responseIdï¼Œå¦‚å–åˆ°åˆ™è¡¨æ˜æ˜¯å›è°ƒï¼Œä» _responseCallbacks å–åŒ¹é…çš„å›è°ƒ block æ‰§è¡Œ</span></span><br><span class="line">        <span class="built_in">NSString</span>* responseId = message[<span class="string">@&quot;responseId&quot;</span>];</span><br><span class="line">        <span class="keyword">if</span> (responseId) &#123; <span class="comment">// å–åˆ° responseId</span></span><br><span class="line">            WVJBResponseCallback responseCallback = _responseCallbacks[responseId];</span><br><span class="line">            responseCallback(message[<span class="string">@&quot;responseData&quot;</span>]);</span><br><span class="line">            [<span class="keyword">self</span>.responseCallbacks removeObjectForKey:responseId];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// æœªå–åˆ° responseIdï¼Œåˆ™è¡¨æ˜æ˜¯æ­£å¸¸çš„ JS callHandler è°ƒç”¨ iOS</span></span><br><span class="line">            WVJBResponseCallback responseCallback = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="comment">// å°è¯•å– callbackIdï¼Œç¤ºä¾‹ cb_1_1512035076293</span></span><br><span class="line">            <span class="comment">// å¯¹åº” JS ä»£ç  var callbackId = &#x27;cb_&#x27;+(uniqueId++)+&#x27;_&#x27;+new Date().getTime();</span></span><br><span class="line">            <span class="built_in">NSString</span>* callbackId = message[<span class="string">@&quot;callbackId&quot;</span>];</span><br><span class="line">            <span class="keyword">if</span> (callbackId) &#123; <span class="comment">// å–åˆ° callbackIdï¼Œè¡¨ç¤º js ç«¯å¸Œæœ›åœ¨è°ƒç”¨ iOS native ä»£ç åæœ‰å›è°ƒ</span></span><br><span class="line">                responseCallback = ^(<span class="type">id</span> responseData) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (responseData == <span class="literal">nil</span>) &#123;</span><br><span class="line">                        responseData = [<span class="built_in">NSNull</span> null];</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// å°† callbackId ä½œä¸º msg çš„ responseId å¹¶è®¾ç½® responseDataï¼Œæ‰§è¡Œ _queueMessage</span></span><br><span class="line">                    WVJBMessage* msg = @&#123; <span class="string">@&quot;responseId&quot;</span>:callbackId, <span class="string">@&quot;responseData&quot;</span>:responseData &#125;;</span><br><span class="line">                    <span class="comment">// _queueMessage å‡½æ•°ä¸»è¦æ˜¯æŠŠ msg è½¬ä¸º JSON æ ¼å¼ï¼Œå†…å« responseId = callbackId</span></span><br><span class="line">                    <span class="comment">// JS ç«¯è°ƒç”¨ WebViewJavascriptBridge._handleMessageFromObjC(&#x27;msg_JSON&#x27;); å…¶ä¸­ &#x27;msg_JSON&#x27; å°±æ˜¯ JSON æ ¼å¼çš„ msg</span></span><br><span class="line">                    [<span class="keyword">self</span> _queueMessage:msg];</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// æœªå–åˆ° callbackId</span></span><br><span class="line">                responseCallback = ^(<span class="type">id</span> ignoreResponseData) &#123;</span><br><span class="line">                    <span class="comment">// Do nothing</span></span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å°è¯•ä»¥ handlerName è·å– iOS ç«¯ä¹‹å‰æ³¨å†Œè¿‡çš„ handler</span></span><br><span class="line">            WVJBHandler handler = <span class="keyword">self</span>.messageHandlers[message[<span class="string">@&quot;handlerName&quot;</span>]];</span><br><span class="line">            <span class="keyword">if</span> (!handler) &#123; <span class="comment">// æ²¡æ³¨å†Œè¿‡ï¼Œåˆ™è·³è¿‡æ­¤ msg</span></span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@&quot;WVJBNoHandlerException, No handler for message from JS: %@&quot;</span>, message);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è°ƒç”¨å¯¹åº”çš„ handlerï¼Œä»¥ message[@&quot;data&quot;] ä¸ºå…¥å‚ï¼Œä»¥ responseCallback ä¸ºå›è°ƒ</span></span><br><span class="line">            handler(message[<span class="string">@&quot;data&quot;</span>], responseCallback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å˜›~ <code>flushMessageQueue:</code> æ–¹æ³•ä½œä¸ºæ•´ä¸ª Native ç«¯çš„æ ¸å¿ƒï¼Œæœ‰ç‚¹é•¿æ˜¯å¯ä»¥ç†è§£çš„ã€‚æˆ‘ä»¬ç®€å•ç†ä¸€ä¸‹å®ƒçš„å®ç°æ€è·¯ï¼š</p>
<ul>
<li>å…¥å‚æ ¡éªŒ</li>
<li>å°† JSON å½¢å¼çš„å…¥å‚è½¬æ¢ä¸º Native å¯¹è±¡ï¼Œå³æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™é‡Œé¢æ¶ˆæ¯ç±»å‹æ˜¯ä¹‹å‰å®šä¹‰è¿‡çš„ WVJBMessageï¼Œå³å­—å…¸</li>
<li>å¦‚æœæ¶ˆæ¯ä¸­å«æœ‰ â€œresponseIdâ€ åˆ™è¡¨æ˜æ˜¯ä¹‹å‰ Native è°ƒç”¨çš„ JS æ–¹æ³•å›è°ƒè¿‡æ¥çš„æ¶ˆæ¯ï¼ˆå› ä¸º JS ç«¯å’Œ Native ç«¯å®ç°é€»è¾‘æ˜¯å¯¹ç­‰çš„ï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹ä¸æ˜ç™½çš„å¯ä»¥å‚è€ƒä¸‹é¢çš„åˆ†æï¼‰</li>
<li>å¦‚æœæ¶ˆæ¯ä¸­ä¸å« â€œresponseIdâ€ åˆ™è¡¨æ˜æ˜¯ JS ç«¯é€šè¿‡ <code>callHandler</code> å‡½æ•°æ­£å¸¸è°ƒç”¨ Native ç«¯è¿‡æ¥çš„æ¶ˆæ¯</li>
<li>å°è¯•è·å–æ¶ˆæ¯ä¸­çš„ â€œcallbackIdâ€ï¼Œå¦‚æœ JS æœ¬æ¬¡æ¶ˆæ¯éœ€è¦ Native å“åº”ä¹‹åå›è°ƒæ‰ä¼šæœ‰è¿™ä¸ªé”®å€¼ï¼Œå…·ä½“å‚è§ä¸Šæ–‡ä¸­ JS ç«¯ <code>_doSend</code> éƒ¨åˆ†æºç åˆ†æã€‚å¦‚å–åˆ° â€œcallbackIdâ€ åˆ™éœ€ç”Ÿæˆä¸€ä¸ªå›è°ƒ blockï¼Œå›è°ƒ block å†…éƒ¨å°† â€œcallbackIdâ€ ä½œä¸º msg çš„ â€œresponseIdâ€ æ‰§è¡Œ <code>_queueMessage</code> å°†æ¶ˆæ¯å‘é€ç»™ JS ç«¯ï¼ˆJS ç«¯å¤„ç†æ¶ˆæ¯é€»è¾‘ä¸ Native ç«¯ä¸€è‡´ï¼Œæ‰€ä»¥ä¸Šé¢ä½¿ç”¨ â€œresponseIdâ€ åˆ¤æ–­å½“å‰æ¶ˆæ¯æ˜¯å¦ä¸ºå›è°ƒæ–¹æ³•ä¼ é€’è¿‡æ¥çš„æ¶ˆæ¯æ˜¯å¾ˆå®¹æ˜“ç†è§£çš„ï¼‰</li>
<li>å°è¯•ä»¥æ¶ˆæ¯ä¸­çš„ â€œhandlerNameâ€ ä» <code>messageHandlers</code>ï¼ˆä¸Šæ–‡æåˆ°è¿‡ï¼Œæ˜¯ä¿å­˜ Native ç«¯æ³¨å†Œè¿‡çš„ handler çš„å­—å…¸ï¼‰å–åˆ°å¯¹åº”çš„ handler blockï¼Œå¦‚æœå–åˆ°åˆ™æ‰§è¡Œä»£ç å—ï¼Œå¦åˆ™æ‰“å°é”™è¯¯æ—¥å¿—</li>
</ul>
<blockquote>
<p>Note: è¿™ä¸ªæ¶ˆæ¯å¤„ç†çš„æ–¹æ³•è™½ç„¶é•¿ï¼Œä½†æ˜¯é€»è¾‘æ¸…æ™°ï¼Œè€Œä¸”æœ‰æ•ˆçš„è§£å†³äº† JS ä¸ Native ç›¸äº’è°ƒç”¨çš„è¿‡ç¨‹ä¸­å‚æ•°ä¼ é€’çš„é—®é¢˜ï¼ˆåŒ…æ‹¬å›è°ƒï¼‰ï¼Œæ­¤å¤– JS ç«¯çš„æ¶ˆæ¯å¤„ç†é€»è¾‘ä¸ Native ç«¯ä¿æŒä¸€è‡´ï¼Œå®ç°äº†é€»è¾‘å¯¹ç§°ï¼Œéå¸¸å€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚</p>
</blockquote>
<h2 id="WebViewJavascriptBridge-JS-Native-è°ƒç”¨-JS-å®ç°è§£è¯»"><a href="#WebViewJavascriptBridge-JS-Native-è°ƒç”¨-JS-å®ç°è§£è¯»" class="headerlink" title="WebViewJavascriptBridge_JS - Native è°ƒç”¨ JS å®ç°è§£è¯»"></a>WebViewJavascriptBridge_JS - Native è°ƒç”¨ JS å®ç°è§£è¯»</h2><img src="/webview_javascript_bridge/javascript.jpg" class="">
<p>Emmmmmâ€¦è¿™ä¸€ç« èŠ‚ä¸»è¦è®² JS ç«¯æ³¨å…¥çš„ä»£ç ï¼Œå³ WebViewJavascriptBridge_JS ä¸­çš„ JS æºç ã€‚ç”±äºæˆ‘æ²¡åšè¿‡å‰æ®µï¼Œèƒ½åŠ›ä¸è¶³ï¼Œæ°´å¹³æœ‰é™ï¼Œå¯èƒ½æœ‰è°¬è¯¯å¸Œæœ›å„ä½è¯»è€…å‘ç°çš„è¯åŠæ—¶æŒ‡æ­£ï¼Œæ„Ÿæ¿€ä¸å°½ã€‚é¢„è­¦ï¼Œç”±äº JS ç«¯å’Œä¸Šæ–‡åˆ†æè¿‡çš„ Native ç«¯é€»è¾‘å¯¹ç§°ä¸”ä¸Šæ–‡å·²ç»åˆ†æè¿‡éƒ¨åˆ† JS ç«¯çš„å‡½æ•°ï¼Œæ‰€ä»¥ä¸‹é¢çš„ JS æºç æ²¡æœ‰å¦åšæ‹†åˆ†ï¼Œä¸ºé¿å…è¢«å¤§æ®µ JS ä»£ç ç³Šè„¸ä¸æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç›´æ¥çœ‹ä»£ç åé¢çš„æ€»ç»“ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// window.WebViewJavascriptBridge æ ¡éªŒï¼Œé¿å…é‡å¤</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">WebViewJavascriptBridge</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‡’åŠ è½½ window.onerrorï¼Œç”¨äºæ‰“å° error æ—¥å¿—</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="variable language_">window</span>.<span class="property">onerror</span>) &#123;</span><br><span class="line">		<span class="variable language_">window</span>.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params">msg, url, line</span>) &#123;</span><br><span class="line">			<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;WebViewJavascriptBridge: ERROR:&quot;</span> + msg + <span class="string">&quot;@&quot;</span> + url + <span class="string">&quot;:&quot;</span> + line);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// window.WebViewJavascriptBridge å£°æ˜</span></span><br><span class="line">	<span class="variable language_">window</span>.<span class="property">WebViewJavascriptBridge</span> = &#123;</span><br><span class="line">		<span class="attr">registerHandler</span>: registerHandler,</span><br><span class="line">		<span class="attr">callHandler</span>: callHandler,</span><br><span class="line">		<span class="attr">disableJavscriptAlertBoxSafetyTimeout</span>: disableJavscriptAlertBoxSafetyTimeout,</span><br><span class="line">		<span class="attr">_fetchQueue</span>: _fetchQueue,</span><br><span class="line">		<span class="attr">_handleMessageFromObjC</span>: _handleMessageFromObjC</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å˜é‡å£°æ˜</span></span><br><span class="line">	<span class="keyword">var</span> messagingIframe; <span class="comment">// æ¶ˆæ¯ iframe</span></span><br><span class="line">	<span class="keyword">var</span> sendMessageQueue = []; <span class="comment">// å‘é€æ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">	<span class="keyword">var</span> messageHandlers = &#123;&#125;; <span class="comment">// JS ç«¯æ³¨å†Œçš„æ¶ˆæ¯å¤„ç† handlers å­—å…¸ï¼ˆå›§ï¼ŒJS å…¶å®å«å¯¹è±¡ï¼‰</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// scheme ä½¿ç”¨ https ä¹‹åé€šè¿‡ host åšåŒ¹é…</span></span><br><span class="line">	<span class="keyword">var</span> <span class="variable constant_">CUSTOM_PROTOCOL_SCHEME</span> = <span class="string">&#x27;https&#x27;</span>;</span><br><span class="line">	<span class="keyword">var</span> <span class="variable constant_">QUEUE_HAS_MESSAGE</span> = <span class="string">&#x27;__wvjb_queue_message__&#x27;</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">var</span> responseCallbacks = &#123;&#125;; <span class="comment">// JS ç«¯å­˜æ”¾å›è°ƒçš„å­—å…¸</span></span><br><span class="line">	<span class="keyword">var</span> uniqueId = <span class="number">1</span>; <span class="comment">// å”¯ä¸€æ ‡ç¤ºï¼Œç”¨äºå›è°ƒæ—¶ç”Ÿæˆ callbackId</span></span><br><span class="line">	<span class="keyword">var</span> dispatchMessagesWithTimeoutSafety = <span class="literal">true</span>; <span class="comment">// é»˜è®¤å¯ç”¨å®‰å…¨æ—¶é•¿</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡ç¦ç”¨ AlertBoxSafetyTimeout æ¥æé€Ÿç½‘æ¡¥æ¶ˆæ¯ä¼ é€’</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">disableJavscriptAlertBoxSafetyTimeout</span>(<span class="params"></span>) &#123;</span><br><span class="line">		dispatchMessagesWithTimeoutSafety = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒ iOS é€»è¾‘ï¼Œæ³¨å†Œ handler å…¶å®æ˜¯å¾€ messageHandlers å­—å…¸ä¸­æ’å…¥å¯¹åº” name çš„ block</span></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">registerHandler</span>(<span class="params">handlerName, handler</span>) &#123;</span><br><span class="line">		messageHandlers[handlerName] = handler;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// è°ƒç”¨ iOS handlerï¼Œå‚æ•°æ ¡éªŒä¹‹åè°ƒç”¨ _doSend å‡½æ•°</span></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">callHandler</span>(<span class="params">handlerName, data, responseCallback</span>) &#123;</span><br><span class="line">	    <span class="comment">// å¦‚æœå‚æ•°åªæœ‰ä¸¤ä¸ªä¸”ç¬¬äºŒä¸ªå‚æ•°ç±»å‹ä¸º functionï¼Œåˆ™è¡¨ç¤ºæ²¡æœ‰å‚æ•°ä¼ é€’ï¼Œå³ data ä¸ºç©º</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="variable language_">arguments</span>.<span class="property">length</span> == <span class="number">2</span> &amp;&amp; <span class="keyword">typeof</span> data == <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">			responseCallback = data;</span><br><span class="line">			data = <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// å°† handlerName å’Œ data ä½œä¸º msg å¯¹è±¡å‚æ•°è°ƒç”¨ _doSend å‡½æ•°</span></span><br><span class="line">		<span class="title function_">_doSend</span>(&#123; <span class="attr">handlerName</span>:handlerName, <span class="attr">data</span>:data &#125;, responseCallback);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// _doSend å‘ Native ç«¯å‘é€æ¶ˆæ¯</span></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">_doSend</span>(<span class="params">message, responseCallback</span>) &#123;</span><br><span class="line">	    <span class="comment">// å¦‚æœ‰å›è°ƒï¼Œåˆ™è®¾ç½® message[&#x27;callbackId&#x27;] ä¸ responseCallbacks[callbackId]</span></span><br><span class="line">		<span class="keyword">if</span> (responseCallback) &#123;</span><br><span class="line">			<span class="keyword">var</span> callbackId = <span class="string">&#x27;cb_&#x27;</span>+(uniqueId++)+<span class="string">&#x27;_&#x27;</span>+<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line">			responseCallbacks[callbackId] = responseCallback;</span><br><span class="line">			message[<span class="string">&#x27;callbackId&#x27;</span>] = callbackId;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// å°† msg åŠ å…¥ sendMessageQueue æ•°ç»„ï¼Œè®¾ç½® messagingIframe.src</span></span><br><span class="line">		sendMessageQueue.<span class="title function_">push</span>(message);</span><br><span class="line">		messagingIframe.<span class="property">src</span> = <span class="variable constant_">CUSTOM_PROTOCOL_SCHEME</span> + <span class="string">&#x27;://&#x27;</span> + <span class="variable constant_">QUEUE_HAS_MESSAGE</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–é˜Ÿåˆ—ï¼Œåœ¨ iOS ç«¯åˆ·æ–°æ¶ˆæ¯é˜Ÿåˆ—æ—¶ä¼šè°ƒç”¨æ­¤å‡½æ•°</span></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">_fetchQueue</span>(<span class="params"></span>) &#123;</span><br><span class="line">	    <span class="comment">// å†…éƒ¨å°†å‘é€æ¶ˆæ¯é˜Ÿåˆ— sendMessageQueue è½¬ä¸º JSON æ ¼å¼å¹¶è¿”å›</span></span><br><span class="line">		<span class="keyword">var</span> messageQueueString = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(sendMessageQueue);</span><br><span class="line">		sendMessageQueue = [];</span><br><span class="line">		<span class="keyword">return</span> messageQueueString;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// iOS ç«¯ _dispatchMessage å‡½æ•°ä¼šè°ƒç”¨æ­¤å‡½æ•°</span></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">_handleMessageFromObjC</span>(<span class="params">messageJSON</span>) &#123;</span><br><span class="line">	    <span class="comment">// è°ƒåº¦ä» Native ç«¯è·å–åˆ°çš„æ¶ˆæ¯</span></span><br><span class="line">        <span class="title function_">_dispatchMessageFromObjC</span>(messageJSON);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¸å¿ƒä»£ç ï¼Œè°ƒåº¦ä» Native ç«¯è·å–åˆ°çš„æ¶ˆæ¯ï¼Œé€»è¾‘ä¸ Native ç«¯ä¸€è‡´</span></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">_dispatchMessageFromObjC</span>(<span class="params">messageJSON</span>) &#123;</span><br><span class="line">		<span class="comment">// åˆ¤æ–­æœ‰æ²¡æœ‰ç¦ç”¨ AlertBoxSafetyTimeoutï¼Œæœ€ç»ˆä¼šè°ƒç”¨ _doDispatchMessageFromObjC å‡½æ•°</span></span><br><span class="line">		<span class="keyword">if</span> (dispatchMessagesWithTimeoutSafety) &#123;</span><br><span class="line">			<span class="built_in">setTimeout</span>(_doDispatchMessageFromObjC);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			 <span class="title function_">_doDispatchMessageFromObjC</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// è§£æ msgJSON å¾—åˆ° msg</span></span><br><span class="line">		<span class="keyword">function</span> <span class="title function_">_doDispatchMessageFromObjC</span>(<span class="params"></span>) &#123;</span><br><span class="line">			<span class="keyword">var</span> message = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(messageJSON);</span><br><span class="line">			<span class="keyword">var</span> messageHandler;</span><br><span class="line">			<span class="keyword">var</span> responseCallback;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// å¦‚æœæœ‰ responseIdï¼Œåˆ™è¯´æ˜æ˜¯å›è°ƒï¼Œå–å¯¹åº”çš„ responseCallback æ‰§è¡Œï¼Œä¹‹åé‡Šæ”¾</span></span><br><span class="line">			<span class="keyword">if</span> (message.<span class="property">responseId</span>) &#123;</span><br><span class="line">				responseCallback = responseCallbacks[message.<span class="property">responseId</span>];</span><br><span class="line">				<span class="keyword">if</span> (!responseCallback) &#123;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="title function_">responseCallback</span>(message.<span class="property">responseData</span>);</span><br><span class="line">				<span class="keyword">delete</span> responseCallbacks[message.<span class="property">responseId</span>];</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123; <span class="comment">// æ²¡æœ‰ responseIdï¼Œåˆ™è¡¨ç¤ºæ­£å¸¸çš„ iOS call handler è°ƒç”¨ js</span></span><br><span class="line">				<span class="comment">// å¦‚ msg åŒ…å« callbackIdï¼Œè¯´æ˜ iOS ç«¯éœ€è¦å›è°ƒï¼Œåˆå§‹åŒ–å¯¹åº”çš„ responseCallback</span></span><br><span class="line">				<span class="keyword">if</span> (message.<span class="property">callbackId</span>) &#123;</span><br><span class="line">					<span class="keyword">var</span> callbackResponseId = message.<span class="property">callbackId</span>;</span><br><span class="line">					responseCallback = <span class="keyword">function</span>(<span class="params">responseData</span>) &#123;</span><br><span class="line">						<span class="title function_">_doSend</span>(&#123; <span class="attr">handlerName</span>:message.<span class="property">handlerName</span>, <span class="attr">responseId</span>:callbackResponseId, <span class="attr">responseData</span>:responseData &#125;);</span><br><span class="line">					&#125;;</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// ä» messageHandlers æ‹¿åˆ°å¯¹åº”çš„ handler æ‰§è¡Œ</span></span><br><span class="line">				<span class="keyword">var</span> handler = messageHandlers[message.<span class="property">handlerName</span>];</span><br><span class="line">				<span class="keyword">if</span> (!handler) &#123;</span><br><span class="line">				    <span class="comment">// å¦‚æœªå–åˆ°å¯¹åº”çš„ handler åˆ™æ‰“å°é”™è¯¯æ—¥å¿—</span></span><br><span class="line">					<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;WebViewJavascriptBridge: WARNING: no handler for message from ObjC:&quot;</span>, message);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="title function_">handler</span>(message.<span class="property">data</span>, responseCallback);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// messagingIframe çš„å£°æ˜ï¼Œç±»å‹ iframeï¼Œæ ·å¼ä¸å¯è§ï¼Œsrc è®¾ç½®</span></span><br><span class="line">	messagingIframe = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;iframe&#x27;</span>);</span><br><span class="line">	messagingIframe.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">	messagingIframe.<span class="property">src</span> = <span class="variable constant_">CUSTOM_PROTOCOL_SCHEME</span> + <span class="string">&#x27;://&#x27;</span> + <span class="variable constant_">QUEUE_HAS_MESSAGE</span>;</span><br><span class="line">	<span class="comment">// messagingIframe åŠ å…¥ document.documentElement ä¸­</span></span><br><span class="line">	<span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="title function_">appendChild</span>(messagingIframe);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å†Œ disableJavscriptAlertBoxSafetyTimeout handlerï¼ŒNative å¯ä»¥é€šè¿‡ç¦ç”¨ AlertBox çš„å®‰å…¨æ—¶é•¿æ¥åŠ é€Ÿæ¡¥æ¥æ¶ˆæ¯</span></span><br><span class="line">	<span class="title function_">registerHandler</span>(<span class="string">&quot;_disableJavascriptAlertBoxSafetyTimeout&quot;</span>, disableJavscriptAlertBoxSafetyTimeout);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">setTimeout</span>(_callWVJBCallbacks, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">_callWVJBCallbacks</span>(<span class="params"></span>) &#123;</span><br><span class="line">		<span class="keyword">var</span> callbacks = <span class="variable language_">window</span>.<span class="property">WVJBCallbacks</span>;</span><br><span class="line">		<span class="keyword">delete</span> <span class="variable language_">window</span>.<span class="property">WVJBCallbacks</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;callbacks.<span class="property">length</span>; i++) &#123;</span><br><span class="line">			callbacks[i](<span class="title class_">WebViewJavascriptBridge</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JS ç«¯å’Œ Native ç«¯é€»è¾‘ä¸€è‡´ï¼Œä¸Šé¢çš„ä»£ç å·²ç»åŠ å…¥äº†è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šï¼Œä¸Šæ–‡åœ¨å¯¹äºâ€œWebViewJavascriptBridgeBase - JS è°ƒç”¨ Native å®ç°åŸç†å‰–æâ€ç« èŠ‚çš„åˆ†æè¿‡ç¨‹ä¸­ä¸ºäº†èµ°é€šæ•´ä¸ªè°ƒç”¨çš„é€»è¾‘å·²ç»å¯¹éƒ¨åˆ† JS ç«¯ä»£ç è¿›è¡Œäº†åˆ†æï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•çš„æ¢³ç†ä¸€ä¸‹ JS ç«¯æ ¸å¿ƒä»£ç  <code>_doDispatchMessageFromObjC</code> å‡½æ•°çš„é€»è¾‘ï¼š</p>
<ul>
<li>å°† messageJSON ä½¿ç”¨ JSON è§£æå‡ºæ¥</li>
<li>å°è¯•å–è§£æåˆ°çš„æ¶ˆæ¯ä¸­çš„ responseIdï¼Œå¦‚æœæœ‰å–åˆ°åˆ™è¯´æ˜æ˜¯ Native ç«¯å“åº” JS ç«¯ä¹‹åé€šè¿‡å›è°ƒå‘ JS ç«¯å‘å‡ºçš„æ¶ˆæ¯ï¼Œç”¨ responseId å– responseCallbacks ä¸­å¯¹åº”çš„å›è°ƒå“åº” blockï¼Œæ‰¾åˆ°åæ‰§è¡Œè¯¥ block ä¹‹ååˆ é™¤</li>
<li>å¦‚æœæ²¡å–åˆ° responseId åˆ™è¡¨ç¤ºè¿™æ¡æ¶ˆæ¯æ˜¯ Native ç«¯é€šè¿‡ <code>callHandler:data:responseCallback:</code> æ­£å¸¸è°ƒç”¨ JS æ³¨å†Œçš„ handler å‘é€è¿‡æ¥çš„æ¶ˆæ¯ï¼ˆè¿™é‡Œçš„æ­£å¸¸æ˜¯é’ˆå¯¹å›è°ƒè€Œè¨€ï¼‰</li>
<li>å¦‚æœå½“å‰çš„æ¶ˆæ¯æœ‰ callbackId åˆ™è¡¨æ˜ Native ç«¯éœ€è¦ JS ç«¯å“åº”æœ¬æ¬¡æ¶ˆæ¯ä¹‹åå›è°ƒåé¦ˆï¼Œç”Ÿæˆä¸€ä¸ª responseCallback ä½œä¸ºå›è°ƒ block (JS ç«¯æ˜¯ function) ï¼Œå…¶å†…éƒ¨ä½¿ç”¨ <code>_doSend</code> æ–¹æ³•ä¼ é€’ä¸€ä¸ªå¸¦æœ‰ responseId çš„æ¶ˆæ¯ç»™ Native ç«¯ï¼Œè¡¨æ˜æ­¤æ¡æ¶ˆæ¯æ˜¯ä¹‹å‰çš„å›è°ƒæ¶ˆæ¯</li>
<li>æœ€åæŒ‰ç…§è§£æåˆ°çš„æ¶ˆæ¯ä¸­ handlerName ä» messageHandlersï¼Œå³ JS ç«¯æ³¨å†Œè¿‡çš„ handlers ä¸­æ‰¾åˆ°ä¸åç§°å¯¹åº”çš„å¤„ç†å‡½æ•°æ‰§è¡Œï¼Œå¦‚æœæ²¡æ‰¾åˆ°åˆ™æ‰“å°é™„å¸¦ç›¸å…³ä¿¡æ¯çš„é”™è¯¯æ—¥å¿—</li>
</ul>
<p>å˜›~ å¯¹æ¯”ä¸€ä¸‹ Native ç«¯çš„æ ¸å¿ƒä»£ç  <code>flushMessageQueue:</code> çœ‹ä¸€ä¸‹ï¼Œå¾ˆå®¹æ˜“å‘ç°ä¸¤ç«¯çš„å¤„ç†å®ç°æ˜¯é€»è¾‘å¯¹ç§°çš„ã€‚</p>
<h2 id="WebViewJavascriptBridge-çš„â€œæ¡¥æ¢ç¾å­¦â€"><a href="#WebViewJavascriptBridge-çš„â€œæ¡¥æ¢ç¾å­¦â€" class="headerlink" title="WebViewJavascriptBridge çš„â€œæ¡¥æ¢ç¾å­¦â€"></a>WebViewJavascriptBridge çš„â€œæ¡¥æ¢ç¾å­¦â€</h2><img src="/webview_javascript_bridge/bridge_beautiful.jpg" class="">
<p>åœ¨æ€»ç»“ WebViewJavascriptBridge çš„â€œæ¡¥æ¢ç¾å­¦â€ä¹‹å‰è¯·å†å›é¡¾ä¸€ä¸‹ WebViewJavascriptBridge çš„å·¥ä½œæµï¼š</p>
<ul>
<li>JS ç«¯åŠ å…¥ src ä¸º <code>https://__bridge_loaded__</code> çš„ iframe</li>
<li>Native ç«¯æ£€æµ‹åˆ° Requestï¼Œæ£€æµ‹å¦‚æœæ˜¯ <code>__bridge_loaded__</code> åˆ™é€šè¿‡å½“å‰çš„ WebView ç»„ä»¶æ³¨å…¥ WebViewJavascriptBridge_JS ä»£ç </li>
<li>æ³¨å…¥ä»£ç æˆåŠŸä¹‹åä¼šåŠ å…¥ä¸€ä¸ª messagingIframeï¼Œå…¶ src ä¸º <code>https://__wvjb_queue_message__</code></li>
<li>ä¹‹åä¸è®ºæ˜¯ Native ç«¯è¿˜æ˜¯ JS ç«¯éƒ½å¯ä»¥é€šè¿‡ <code>registerHandler</code> æ–¹æ³•æ³¨å†Œä¸€ä¸ªä¸¤ç«¯çº¦å®šå¥½çš„ HandlerName çš„å¤„ç†ï¼Œä¹Ÿéƒ½å¯ä»¥é€šè¿‡ <code>callHandler</code> æ–¹æ³•é€šè¿‡çº¦å®šå¥½çš„ HandlerName è°ƒç”¨å¦ä¸€ç«¯çš„å¤„ç†ï¼ˆä¸¤ç«¯å¤„ç†æ¶ˆæ¯çš„å®ç°é€»è¾‘å¯¹ç§°ï¼‰</li>
</ul>
<p>å˜›~ æ‰€ä»¥æˆ‘ä»¬å¾ˆå®¹æ˜“åˆ—ä¸¾å‡º WebViewJavascriptBridge æ‰€å…·æœ‰çš„â€œç¾å­¦â€ï¼š</p>
<ul>
<li>éšæ€§é€‚é…</li>
<li>æ¥å£å¯¹ç­‰</li>
<li>é€»è¾‘å¯¹ç§°</li>
</ul>
<p>æˆ‘ä»¬ç»“åˆæœ¬æ–‡å±•å¼€æ¥è¯´ä¸€ä¸‹ä¸Šé¢çš„â€œç¾å­¦â€çš„å…·ä½“å®ç°ã€‚</p>
<h3 id="éšæ€§é€‚é…"><a href="#éšæ€§é€‚é…" class="headerlink" title="éšæ€§é€‚é…"></a>éšæ€§é€‚é…</h3><p>WebViewJavascriptBridge ä¸»è¦æ˜¯ä½œä¸º Mac OS X å’Œ iOS ç«¯ï¼ˆNative ç«¯ï¼‰ä¸ JS ç«¯ç›¸äº’é€šä¿¡ï¼Œäº’ç›¸è°ƒç”¨çš„æ¡¥æ¢ã€‚å¯¹äº Mac OS X å’Œ iOS ä¸¤ç§å¹³å°åŒ…å«çš„ä¸‰ç§ WebView åŠŸèƒ½ç»„ä»¶è€Œè¨€ï¼ŒWebViewJavascriptBridge åšäº†éšæ€§é€‚é…ï¼Œå³ä»…ç”¨ä¸€å¥—ä»£ç å³å¯ç»‘å®šä¸åŒå¹³å°çš„ WebView ç»„ä»¶å®ç°åŒæ ·åŠŸèƒ½çš„ JS é€šä¿¡åŠŸèƒ½ï¼Œè¿™ä¸€ç‚¹éå¸¸æ–¹ä¾¿ã€‚</p>
<h3 id="æ¥å£å¯¹ç­‰"><a href="#æ¥å£å¯¹ç­‰" class="headerlink" title="æ¥å£å¯¹ç­‰"></a>æ¥å£å¯¹ç­‰</h3><p>WebViewJavascriptBridge å¯¹äº JS ç«¯å’Œ Native ç«¯è®¾è®¡äº†å¯¹ç­‰çš„æ¥å£ï¼Œä¸è®ºæ˜¯ JS ç«¯è¿˜æ˜¯ Native ç«¯ï¼Œæ³¨å†Œæœ¬ç«¯çš„å“åº”å¤„ç†éƒ½æ˜¯ç”¨ <code>registerHandler</code> æ¥å£ï¼Œè°ƒç”¨å¦ä¸€ç«¯ï¼ˆç»™å¦ä¸€ç«¯å‘æ¶ˆæ¯ï¼‰éƒ½æ˜¯ç”¨ <code>callHandler</code> æ¥å£ã€‚</p>
<p>è¿™æ ·åšæ˜¯éå¸¸åˆç†çš„ï¼Œå› ä¸ºä¸è®ºæ˜¯ JS ç«¯è¿˜æ˜¯ Native ç«¯ï¼Œä½œä¸ºé€šä¿¡çš„åŒæ–¹å°±é€šä¿¡æœ¬èº«è€Œè¨€æ˜¯å¤„äºå¯¹ç­‰çš„åœ°ä½çš„ã€‚è¿™å°±å¥½æ¯”ä¸€åº§å¤§æ¡¥è¿æ¥ä¸¤å—é™†åœ°ï¼Œä¸¤åœ°ç”¨å¤§æ¡¥ç›¸äº’è¿è¾“è´§ç‰©å¹¶æ¥æ”¶èµ„æºï¼Œä¸¤å—é™†åœ°åœ¨å¤§æ¡¥çš„è¿è¾“ä½¿ç”¨è¿‡ç¨‹ä¸­é€»è¾‘ä¸Šä¹Ÿæ˜¯åœ°ä½å¯¹ç­‰çš„ã€‚</p>
<h3 id="é€»è¾‘å¯¹ç§°"><a href="#é€»è¾‘å¯¹ç§°" class="headerlink" title="é€»è¾‘å¯¹ç§°"></a>é€»è¾‘å¯¹ç§°</h3><p>WebViewJavascriptBridge åœ¨ JS ç«¯å’Œ Native ç«¯å¯¹å‘é€è¿‡æ¥çš„æ¶ˆæ¯æœ‰ç€ç›¸åŒé€»è¾‘çš„å¤„ç†å®ç°ï¼Œå¦‚æœè€ƒè™‘åˆ°æ”¶å‘åŒæ–¹çš„èº«ä»½åˆ™å¯ä»¥æŠŠé€»è¾‘ç›¸åŒçœ‹åšé€»è¾‘å¯¹ç§°ã€‚</p>
<p>è¿™ç§å®ç°æ–¹å¼ä¾æ—§éå¸¸åˆç†ï¼Œè¢«æ¡¥è¿æ¥çš„ä¸¤å—å¤§é™†åœ¨è£…è´§ä¸Šæ¡¥å’Œä¸‹æ¡¥å¸è´§è¿™ä¸¤å¤„é€»è¾‘ä¸Šå°±åº”è¯¥æ˜¯å¯¹ç§°çš„ã€‚</p>
<p>å˜›~ è¯´åˆ°è¿™é‡Œå°±ä¸å¾—ä¸ç¥­å‡ºä¸€ä¸ªè¯æ¥å½¢å®¹ WebViewJavascriptBridge äº†ï¼Œè¿™ä¸ªè¯å°±æ˜¯<strong>ä¼˜é›…</strong>ï¼ˆç¬‘ï¼‰ã€‚å½“å¤§å®¶ç»“åˆ WebViewJavascriptBridge æºç é˜…è¯»æœ¬æ–‡ä¹‹åä¸éš¾å‘ç°å…¶æ•´ä¸ªæ¶æ„å’Œè®¾è®¡æ€æƒ³è·Ÿç°å®æ¡¥æ¢è®¾è®¡ä¸­å¾ˆå¤šè®¾è®¡æ€æƒ³ä¸è°‹è€Œåˆï¼Œæ¯”å¦‚æ¡¥ä¸€èˆ¬ä¼šåˆ†ä¸ºå·¦å³æ¡¥å¹…ï¼Œè€Œå·¦å³å¹…æ¡¥ä¸€èˆ¬åªæœ‰ä¸€æ¡çº¿è·¯ä¸­å¿ƒçº¿ï¼Œå³ä¸€ä¸ªå‰è¿›æ–¹å‘ï¼Œç”¨äºæ¡¥ä¸Šå•ä¸€æ–¹å‘çš„èµ„æºä¼ è¾“ï¼Œå·¦å³æ¡¥å¹…åœ¨åŠŸèƒ½ä¸Šå¯¹ç­‰ã€‚</p>
<h2 id="æ–‡ç« æ€»ç»“"><a href="#æ–‡ç« æ€»ç»“" class="headerlink" title="æ–‡ç« æ€»ç»“"></a>æ–‡ç« æ€»ç»“</h2><ul>
<li>æ–‡ç« ç³»ç»Ÿåˆ†æäº† WebViewJavascriptBridge æºç ï¼Œå¸Œæœ›å„ä½è¯»è€…èƒ½å¤Ÿåœ¨é˜…è¯»æœ¬æ–‡ä¹‹åå¯¹ WebViewJavascriptBridge çš„æ¶æ„æœ‰ä¸€ä¸ªæ•´ä½“è®¤è¯†ã€‚</li>
<li>æ–‡ç« å¯¹ WebViewJavascriptBridge åœ¨ JS ç«¯å’Œ Native ç«¯çš„æ¶ˆæ¯å¤„ç†å®ç°åšäº†æ·±å…¥å‰–æï¼Œå¸Œæœ›å¯ä»¥å¯¹å„ä½è¯»è€…è¿™éƒ¨åˆ†æºç çš„ç†è§£æä¾›ä¸€äº›å¾®è–„çš„å¸®åŠ©ã€‚</li>
<li>æ€»ç»“äº† WebViewJavascriptBridge ä½œä¸ºä¸€ä¸ª JSBridge æ¡†æ¶æ‰€å…·æœ‰çš„ä¼˜åŠ¿ï¼Œå³æ–‡ä¸­æ‰€æŒ‡çš„â€œæ¡¥æ¢ç¾å­¦â€ï¼ŒæœŸæœ›å¯ä»¥å¯¹å¤§å®¶ä»¥åè‡ªå·±å°è£…ä¸€ä¸ª JSBridge æä¾›æ€è·¯ï¼ŒæŠ›ç –å¼•ç‰ã€‚</li>
</ul>
<p>Emmmmmâ€¦ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ WebViewJavascriptBridge ä»…ä»…æ˜¯ä½œä¸º JSBridge å±‚ç”¨äºæä¾› JS å’Œ Native ä¹‹é—´ç›¸äº’ä¼ é€’æ¶ˆæ¯çš„åŸºç¡€æ”¯æŒçš„ã€‚å¦‚æœæƒ³è¦å°è£…è‡ªå·±é¡¹ç›®ä¸­çš„ WebView ç»„ä»¶è¿˜éœ€è¦å¦å¤–å®ç° HTTP cookie æ³¨å…¥ï¼Œè‡ªå®šä¹‰ User-Agentï¼Œç™½åå•æˆ–è€…æƒé™æ ¡éªŒç­‰åŠŸèƒ½ï¼Œæ›´è¿›ä¸€æ­¥è¿˜éœ€è¦å¯¹ WebView ç»„ä»¶è¿›è¡Œåˆå§‹åŒ–é€Ÿåº¦ï¼Œé¡µé¢æ¸²æŸ“é€Ÿåº¦ä»¥åŠé¡µé¢ç¼“å­˜ç­–ç•¥çš„ä¼˜åŒ–ã€‚æˆ‘ä¹‹å<strong>ä¹Ÿè®¸å¯èƒ½å¤§æ¦‚åº”è¯¥</strong>ä¼šå†™ä¸€ç¯‡æ–‡ç« åˆ†äº«ä¸€ä¸‹è‡ªå·±å°è£… WebView ç»„ä»¶æ—¶è¸©åˆ°çš„ä¸€äº›å‘ä»¥åŠç»éªŒï¼Œå› ä¸ºè‡ªå·±æ°´å¹³æœ‰é™â€¦æ‰€ä»¥ä¹Ÿå¯èƒ½ä¸ä¼šå†™ï¼ˆç¬‘ï¼‰ã€‚</p>
<p>æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜ <a href="https://lision.me/">https://lision.me/</a>ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ <a href="https://lision.me/">ä¸ªäººåšå®¢</a> ä¸­æ›´æ–°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš <a target="_blank" rel="noopener" href="https://weibo.com/lisioncode">@Lision</a> è”ç³»æˆ‘~</p>
<p>å¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~</p>


    
    
    
	  <div class="tags">
      <a class="tag-none-link" href="/tags/hybrid/" rel="tag">hybrid</a><a class="tag-none-link" href="/tags/jsbridge/" rel="tag">jsbridge</a>
	  </div>
    

  </section>
</article>
  
    <article class="post ">

  
  <h2 class="title">
    <a href="/yyimage/">
      YYImage è®¾è®¡æ€è·¯ï¼Œå®ç°ç»†èŠ‚å‰–æ
    </a>
  </h2>
  
  <time>
    12æœˆ 10, 2017
  </time>
  <section class="content">
	  <img src="/yyimage/yyimage_h.jpg" class="">
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å›¾ç‰‡çš„å†å²æ—©äºæ–‡å­—ï¼Œæ˜¯æœ€åŸå§‹çš„ä¿¡æ¯ä¼ é€’æ–¹å¼ã€‚<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%AD%E6%9B%B8">å…­ä¹¦</a>ä¸­çš„è±¡å½¢æ–‡æ„é€ æ€æƒ³å°±æ˜¯ç”¨æ–‡å­—çš„çº¿æ¡æˆ–ç¬”ç”»ï¼ŒæŠŠè¦è¡¨è¾¾ç‰©ä½“çš„å¤–å½¢ç‰¹å¾ï¼Œå…·ä½“åœ°å‹¾ç”»å‡ºæ¥ã€‚</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%A8%B1%E6%85%8E">è®¸æ…</a>ã€Š<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%AF%B4%E6%96%87%E8%A7%A3%E5%AD%97">è¯´æ–‡è§£å­—</a>ã€‹äº‘ï¼šâ€œè±¡å½¢è€…ï¼Œç”»æˆå…¶ç‰©ï¼Œéšä½“è¯˜è¯ï¼Œæ—¥ã€æœˆæ˜¯ä¹Ÿã€‚â€</p>
</blockquote>
<p>ç°ä»£ç¤¾ä¼šçš„ä¿¡æ¯ä¼ é€’ä¸­ï¼Œå›¾ç‰‡ä»ç„¶æ˜¯ä¸å¯æˆ–ç¼ºçš„ä¸€ç¯ï¼Œä¸è®ºæ˜¯æŠ¥çº¸ã€æ‚å¿—ã€æ¼«ç”»ç­‰å®ä½“åˆŠç‰©è¿˜æ˜¯ç”Ÿæ´»ä¸­è¶…å¸‚åœ°é“å¹¿å‘Šæ´»åŠ¨ï¼Œéƒ½ä¼šæœ‰ä¸“é—¨çš„é…å›¾æŠ“äººçœ¼çƒã€‚</p>
<p>åœ¨ç§»åŠ¨ç«¯ App ä¸­ï¼Œå›¾ç‰‡é€šå¸¸å æ®ç€é‡è¦çš„è§†è§‰ç©ºé—´ï¼Œä½œä¸º iOS å¼€å‘æ¥è®²ï¼Œæ‰€æœ‰çš„ App éƒ½æœ‰ç²¾å¿ƒè®¾è®¡çš„ AppIcon é™ˆåˆ—åœ¨ SpringBoard ä¸­ï¼Œæ‰“å¼€ä»»æ„ä¸€æ¬¾ä¸»æµ App éƒ½å°‘ä¸äº†ç³ç…æ»¡ç›®çš„å›¾ç‰‡æ­é…ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ibireme/YYImage">YYImage</a> æ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„ iOS å›¾åƒæ¡†æ¶ï¼ˆè¯¥é¡¹ç›®æ˜¯ <a target="_blank" rel="noopener" href="https://github.com/ibireme/YYKit">YYKit</a> ç»„ä»¶ä¹‹ä¸€ï¼‰ï¼Œæ”¯æŒç›®å‰å¸‚åœºä¸Šæ‰€æœ‰ä¸»æµçš„å›¾ç‰‡æ ¼å¼çš„æ˜¾ç¤ºä¸ç¼–/è§£ç ï¼Œå¹¶ä¸”æä¾›é«˜æ•ˆçš„åŠ¨æ€å†…å­˜ç¼“å­˜ç®¡ç†ï¼Œä»¥ä¿è¯é«˜æ€§èƒ½ä½å†…å­˜çš„åŠ¨ç”»æ’­æ”¾ã€‚</p>
<p>YYKit çš„ä½œè€… <a target="_blank" rel="noopener" href="https://weibo.com/239801242">@ibireme</a> å¯¹äº iOS å›¾ç‰‡å¤„ç†å†™æœ‰ä¸¤ç¯‡éå¸¸ä¸é”™çš„æ–‡ç« ï¼Œæ¨èå„ä½è¯»è€…åœ¨é˜…è¯»æœ¬æ–‡ä¹‹å‰æŸ¥é˜…ã€‚</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.ibireme.com/2015/11/02/mobile_image_benchmark/">ç§»åŠ¨ç«¯å›¾ç‰‡æ ¼å¼è°ƒç ”</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.ibireme.com/2015/11/02/ios_image_tips/">iOS å¤„ç†å›¾ç‰‡çš„ä¸€äº›å° Tip</a></li>
</ul>
<p>æœ¬æ–‡å¼•ç”¨ä»£ç å‡ä¸º YYImage v1.0.4 ç‰ˆæœ¬æºç ï¼Œæ–‡ç« æ—¨åœ¨å‰–æ YYImage çš„æ¶æ„æ€æƒ³ä»¥åŠè®¾è®¡æ€è·¯å¹¶å¯¹ç¬”è€…åœ¨é˜…è¯»æºç è¿‡ç¨‹ä¸­å‘ç°çš„æœ‰è¶£å®ç°ç»†èŠ‚æ¢ç©¶åˆ†äº«ï¼Œä¸ä¼šé€è¡Œç¿»è¯‘æºç ï¼Œå»ºè®®å¯¹æºç å®ç°æ„Ÿå…´è¶£çš„åŒå­¦ç»“åˆ YYImage v1.0.4 ç‰ˆæœ¬æºç é£Ÿç”¨æœ¬æ–‡~</p>
<img src="/yyimage/xiaomai.gif" class="">
<h2 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h2><ul>
<li>YYImage ç®€ä»‹</li>
<li>YYImage, YYFrameImage, YYSpriteSheetImage</li>
<li>YYAnimatedImageView</li>
<li>YYImageCoder</li>
<li>æ€»ç»“</li>
<li>æ‰©å±•é˜…è¯»</li>
</ul>
<h2 id="YYImage-ç®€ä»‹"><a href="#YYImage-ç®€ä»‹" class="headerlink" title="YYImage ç®€ä»‹"></a>YYImage ç®€ä»‹</h2><img src="/yyimage/yyimage.jpg" class="">
<p>YYImage æ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„ iOS å›¾åƒæ¡†æ¶ï¼Œæ”¯æŒå½“å‰å¸‚åœºä¸»æµçš„é™/åŠ¨æ€å›¾åƒç¼–/è§£ç ä¸åŠ¨æ€å›¾åƒçš„åŠ¨ç”»æ’­æ”¾æ˜¾ç¤ºï¼Œå…¶å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li>æ”¯æŒä»¥ä¸‹ç±»å‹åŠ¨ç”»å›¾åƒçš„æ’­æ”¾/ç¼–ç /è§£ç : WebP, APNG, GIFã€‚</li>
<li>æ”¯æŒä»¥ä¸‹ç±»å‹é™æ€å›¾åƒçš„æ˜¾ç¤º/ç¼–ç /è§£ç : WebP, PNG, GIF, JPEG, JP2, TIFF, BMP, ICO, ICNSã€‚</li>
<li>æ”¯æŒä»¥ä¸‹ç±»å‹å›¾ç‰‡çš„æ¸è¿›å¼/é€è¡Œæ‰«æ/éš”è¡Œæ‰«æè§£ç : PNG, GIF, JPEG, BMPã€‚</li>
<li>æ”¯æŒå¤šå¼ å›¾ç‰‡æ„æˆçš„å¸§åŠ¨ç”»æ’­æ”¾ï¼Œæ”¯æŒå•å¼ å›¾ç‰‡çš„ sprite sheet åŠ¨ç”»ã€‚</li>
<li>é«˜æ•ˆçš„åŠ¨æ€å†…å­˜ç¼“å­˜ç®¡ç†ï¼Œä»¥ä¿è¯é«˜æ€§èƒ½ä½å†…å­˜çš„åŠ¨ç”»æ’­æ”¾ã€‚</li>
<li>å®Œå…¨å…¼å®¹ UIImage å’Œ UIImageViewï¼Œä½¿ç”¨æ–¹ä¾¿ã€‚</li>
<li>ä¿ç•™å¯æ‰©å±•çš„æ¥å£ï¼Œä»¥æ”¯æŒè‡ªå®šä¹‰åŠ¨ç”»ã€‚</li>
<li>æ¯ä¸ªç±»å’Œæ–¹æ³•éƒ½æœ‰å®Œå–„çš„æ–‡æ¡£æ³¨é‡Šã€‚</li>
</ul>
<h3 id="YYImage-æ¶æ„åˆ†æ"><a href="#YYImage-æ¶æ„åˆ†æ" class="headerlink" title="YYImage æ¶æ„åˆ†æ"></a>YYImage æ¶æ„åˆ†æ</h3><p>é€šè¿‡ YYImage æºç å¯ä»¥æŒ‰ç…§å…¶ä¸ UIKit çš„å¯¹åº”å…³ç³»åˆ’åˆ†ä¸ºä¸‰ä¸ªå±‚çº§ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">å±‚çº§</th>
<th style="text-align:center">UIKit</th>
<th style="text-align:center">YYImage</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">å›¾åƒå±‚</td>
<td style="text-align:center">UIImage</td>
<td style="text-align:center">YYImage, YYFrameImage, YYSpriteSheetImage</td>
</tr>
<tr>
<td style="text-align:center">è§†å›¾å±‚</td>
<td style="text-align:center">UIImageView</td>
<td style="text-align:center">YYAnimatedImageView</td>
</tr>
<tr>
<td style="text-align:center">ç¼–/è§£ç å±‚</td>
<td style="text-align:center">ImageIO.framework</td>
<td style="text-align:center">YYImageCoder</td>
</tr>
</tbody>
</table>
<ul>
<li>å›¾åƒå±‚ï¼ŒæŠŠä¸åŒç±»å‹çš„å›¾åƒä¿¡æ¯å°è£…æˆç±»å¹¶æä¾›åˆå§‹åŒ–å’Œå…¶ä»–ä¾¿æ·æ¥å£ã€‚</li>
<li>è§†å›¾å±‚ï¼Œè´Ÿè´£å›¾åƒå±‚å†…å®¹çš„æ˜¾ç¤ºï¼ˆåŒ…å«åŠ¨æ€å›¾åƒçš„åŠ¨ç”»æ’­æ”¾ï¼‰å·¥ä½œã€‚</li>
<li>ç¼–/è§£ç å±‚ï¼Œæä¾›å›¾åƒåº•å±‚æ”¯æŒï¼Œä½¿æ•´ä¸ªæ¡†æ¶å¾—ä»¥æ”¯æŒå¸‚åœºä¸»æµçš„å›¾ç‰‡æ ¼å¼ã€‚</li>
</ul>
<blockquote>
<p>Note: <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/imageio">ImageIO.framework</a> æ˜¯ iOS åº•å±‚å®ç°çš„å›¾ç‰‡ç¼–/è§£ç åº“ï¼Œè´Ÿè´£ç®¡ç†é¢œè‰²å’Œè®¿é—®å›¾åƒå…ƒæ•°æ®ã€‚å…¶å†…éƒ¨çš„å®ç°ä½¿ç”¨äº†ç¬¬ä¸‰æ–¹ç¼–/è§£ç åº“ï¼ˆå¦‚ libpng ç­‰ï¼‰å¹¶å¯¹ç¬¬ä¸‰æ–¹åº“è¿›è¡Œè°ƒæ•´ä¼˜åŒ–ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒiOS è¿˜ä¸“é—¨é’ˆå¯¹ JPEG çš„ç¼–/è§£ç å¼€å‘äº† AppleJPEG.frameworkï¼Œå®ç°äº†æ€§èƒ½æ›´é«˜çš„ç¡¬ç¼–ç å’Œç¡¬è§£ç ã€‚</p>
</blockquote>
<img src="/yyimage/yyimage_struct.png" class="">
<h2 id="YYImage-YYFrameImage-YYSpriteSheetImage"><a href="#YYImage-YYFrameImage-YYSpriteSheetImage" class="headerlink" title="YYImage, YYFrameImage, YYSpriteSheetImage"></a>YYImage, YYFrameImage, YYSpriteSheetImage</h2><p>å…ˆæ¥ä»‹ç» YYImage åº“ä¸­å›¾åƒå±‚çš„ä¸‰ä¸ªç±»ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>YYImage</li>
<li>YYFrameImage</li>
<li>YYSpriteSheetImage</li>
</ul>
<h3 id="YYImage"><a href="#YYImage" class="headerlink" title="YYImage"></a>YYImage</h3><p>YYImage æ˜¯ä¸€ä¸ªæ˜¾ç¤ºåŠ¨æ€å›¾ç‰‡æ•°æ®çš„é«˜çº§åˆ«ç±»ï¼Œå…¶ç»§æ‰¿è‡ª UIImage å¹¶å¯¹ UIImage åšäº†æ‰©å±•ä»¥æ”¯æŒ WebPï¼ŒAPNG å’Œ GIF æ ¼å¼çš„å›¾ç‰‡è§£ç ã€‚å®ƒè¿˜æ”¯æŒ NSCoding åè®®å¯ä»¥å¯¹å¤šå¸§å›¾åƒæ•°æ®è¿›è¡Œ archive å’Œ unarchive æ“ä½œã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYImage</span> : <span class="title">UIImage</span> &lt;<span class="title">YYAnimatedImage</span>&gt;</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">nullable</span> YYImage *)imageNamed:(<span class="built_in">NSString</span> *)name; <span class="comment">// ä¸åŒäº UIImageï¼Œæ­¤æ–¹æ³•æ— ç¼“å­˜</span></span><br><span class="line">+ (<span class="keyword">nullable</span> YYImage *)imageWithContentsOfFile:(<span class="built_in">NSString</span> *)path;</span><br><span class="line">+ (<span class="keyword">nullable</span> YYImage *)imageWithData:(<span class="built_in">NSData</span> *)data;</span><br><span class="line">+ (<span class="keyword">nullable</span> YYImage *)imageWithData:(<span class="built_in">NSData</span> *)data scale:(<span class="built_in">CGFloat</span>)scale;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) YYImageType animatedImageType; <span class="comment">// å›¾åƒæ•°æ®ç±»å‹</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSData</span> *animatedImageData; <span class="comment">// åŠ¨æ€å›¾åƒçš„å…ƒæ•°æ®</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> animatedImageMemorySize; <span class="comment">// å¤šå¸§å›¾åƒå†…å­˜å ç”¨é‡</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="type">BOOL</span> preloadAllAnimatedImageFrames; <span class="comment">// é¢„åŠ è½½æ‰€æœ‰å¸§ï¼ˆåˆ°å†…å­˜ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>YYImage æä¾›äº†ç±»ä¼¼ UIImage çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œå…¬å¼€äº†ä¸€äº›å±æ€§ä¾¿äºæˆ‘ä»¬æ£€æµ‹å’Œæ§åˆ¶å…¶å†…å­˜ä½¿ç”¨ã€‚</p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ YYImage çš„ <code>imageNamed:</code> åˆå§‹åŒ–æ–¹æ³•å¹¶ä¸æ”¯æŒç¼“å­˜ã€‚å› ä¸ºå…¶ <code>imageNamed:</code> å†…éƒ¨å®ç°å¹¶ä¸åŒäº UIImage çš„ <code>imageNamed:</code> æ–¹æ³•ï¼ŒYYImage ä¸­çš„å®ç°æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ¨æµ‹å‡ºç»™å®šå›¾åƒèµ„æºè·¯å¾„</li>
<li>æ‹¿åˆ°è·¯å¾„ä¸­çš„å›¾åƒæ•°æ®ï¼ˆNSDataï¼‰</li>
<li>è°ƒç”¨ YYImage çš„ <code>initWithData:scale:</code> æ–¹æ³•åˆå§‹åŒ–</li>
</ul>
<p>YYImage çš„ç§æœ‰å˜é‡éƒ¨åˆ†ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œç›¸ä¿¡å¤§å®¶å¯ä»¥æ ¹æ®ä¸Šé¢æš´éœ²å‡ºçš„å±æ€§å’Œæ¥å£çŒœå¾—åˆ°å“ˆã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYImage</span> </span>&#123;</span><br><span class="line">    YYImageDecoder *_decoder; <span class="comment">// è§£ç å™¨</span></span><br><span class="line">    <span class="built_in">NSArray</span> *_preloadedFrames; <span class="comment">// é¢„åŠ è½½çš„å›¾åƒå¸§</span></span><br><span class="line">    dispatch_semaphore_t _preloadedLock; <span class="comment">// é¢„åŠ è½½é”</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> _bytesPerFrame; <span class="comment">// å†…å­˜å ç”¨é‡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å†…éƒ¨æœ‰ä¸€æŠŠé” <code>dispatch_semaphore_t</code>ï¼Œæˆ‘ä»¬çŸ¥é“ <code>dispatch_semaphore_t</code> å½“ä¿¡å·é‡ä¸º 1 æ—¶å¯ä»¥å½“åšé”æ¥ä½¿ç”¨ï¼Œåœ¨ä¸é˜»å¡æ—¶å…¶ä½œä¸ºé”çš„æ•ˆç‡éå¸¸é«˜ã€‚è¿™é‡Œä½¿ç”¨ <code>_preloadedLock</code> çš„ä¸»è¦ç›®çš„æ˜¯ä¿è¯ <code>_preloadedFrames</code> çš„è¯»å†™ï¼Œç”±äº <code>_preloadedFrames</code> çš„è¯»å†™è¿‡ç¨‹æ˜¯åœ¨å†…å­˜ä¸­å®Œæˆçš„ï¼Œæ“ä½œè€—æ—¶ä¸ä¼šå¤ªå¤šï¼Œæ‰€ä»¥ä¸ä¼šé•¿æ—¶é—´é˜»å¡ï¼Œè¿™ç§æƒ…å†µä½¿ç”¨ <code>dispatch_semaphore_t</code> éå¸¸åˆé€‚ã€‚</p>
<p>å˜›~ <code>_preloadedFrames</code> å¯¹åº” <code>preloadAllAnimatedImageFrames</code> å±æ€§ï¼Œå¼€å¯é¢„åŠ è½½æ‰€æœ‰å¸§åˆ°å†…å­˜çš„è¯ï¼Œ<code>_preloadedFrames</code> ä½œä¸ºä¸€ä¸ªæ•°ç»„ä¼šä¿å­˜æ‰€æœ‰å¸§çš„å›¾åƒã€‚<code>_bytesPerFrame</code> åˆ™å¯¹åº” <code>animatedImageMemorySize</code> å±æ€§ï¼Œåœ¨åˆå§‹åŒ– YYImage æ—¶ï¼Œå¦‚æœå¸§æ€»æ•°è¶…è¿‡ 1 åˆ™ä¼šè®¡ç®— <code>_bytesPerFrame</code> çš„å¤§å°ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (decoder.frameCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    _decoder = decoder;</span><br><span class="line">    _bytesPerFrame = <span class="built_in">CGImageGetBytesPerRow</span>(image.CGImage) * <span class="built_in">CGImageGetHeight</span>(image.CGImage);</span><br><span class="line">    _animatedImageMemorySize = _bytesPerFrame * decoder.frameCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å® YYImage ä¸­è¿˜æœ‰ä¸€äº›å®ç°ä¹Ÿæ¯”è¾ƒæœ‰è¶£ï¼Œæ¯”å¦‚ <code>animatedImageDurationAtIndex:</code> çš„å®ç°ä¸­å¦‚æœå–åˆ° &lt;= 10 ms çš„æ—¶é•¿ä¼šæ›¿æ¢ä¸º 100 msï¼Œå¹¶åœ¨ <a target="_blank" rel="noopener" href="https://github.com/ibireme/YYImage/blob/master/YYImage/YYImage.m#L246">æ³¨é‡Š</a> ä¸­è§£é‡Šäº†ä¸ºä»€ä¹ˆï¼ˆä¸€å®šè¦ç‚¹è¿›å»çœ‹å•Šï¼Œç¬‘~ï¼‰ã€‚</p>
<h3 id="YYFrameImage"><a href="#YYFrameImage" class="headerlink" title="YYFrameImage"></a>YYFrameImage</h3><p>YYFrameImage æ˜¯ä¸“é—¨ç”¨æ¥æ˜¾ç¤ºåŸºäºå¸§çš„åŠ¨ç”»å›¾åƒç±»ï¼Œå…¶ä¹Ÿæ˜¯ UIImage çš„å­ç±»ã€‚YYFrameImage ä»…æ”¯æŒç³»ç»Ÿå›¾ç‰‡æ ¼å¼ä¾‹å¦‚ png å’Œ jpegã€‚</p>
<blockquote>
<p>Note: ä½¿ç”¨ YYFrameImage æ˜¾ç¤ºåŠ¨ç”»å›¾åƒåŒæ ·è¦åŸºäº YYAnimatedImageView æ’­æ”¾ã€‚</p>
</blockquote>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYFrameImage</span> : <span class="title">UIImage</span> &lt;<span class="title">YYAnimatedImage</span>&gt;</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithImagePaths:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)paths</span><br><span class="line">                           oneFrameDuration:(<span class="built_in">NSTimeInterval</span>)oneFrameDuration</span><br><span class="line">                                  loopCount:(<span class="built_in">NSUInteger</span>)loopCount;</span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithImagePaths:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)paths</span><br><span class="line">                             frameDurations:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSNumber</span> *&gt; *)frameDurations</span><br><span class="line">                                  loopCount:(<span class="built_in">NSUInteger</span>)loopCount;</span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithImageDataArray:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSData</span> *&gt; *)dataArray</span><br><span class="line">                               oneFrameDuration:(<span class="built_in">NSTimeInterval</span>)oneFrameDuration</span><br><span class="line">                                      loopCount:(<span class="built_in">NSUInteger</span>)loopCount;</span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithImageDataArray:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSData</span> *&gt; *)dataArray</span><br><span class="line">                                 frameDurations:(<span class="built_in">NSArray</span> *)frameDurations</span><br><span class="line">                                      loopCount:(<span class="built_in">NSUInteger</span>)loopCount;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>YYFrameImage å¯ä»¥æŠŠé™æ€å›¾ç‰‡ç±»å‹å¦‚ png å’Œ jpeg æ ¼å¼çš„é™æ€å›¾åƒç”¨å¸§åˆ‡æ¢çš„æ–¹å¼ä»¥åŠ¨æ€å›¾ç‰‡çš„å½¢å¼æ˜¾ç¤ºï¼Œå¹¶ä¸”æä¾›äº† 4 ä¸ªå¸¸ç”¨çš„åˆå§‹åŒ–æ–¹æ³•æ–¹ä¾¿æˆ‘ä»¬ä½¿ç”¨ã€‚</p>
<p>YYFrameImage å†…éƒ¨æœ‰ä¸€äº›åŸºæœ¬çš„å˜é‡åˆ†åˆ«å¯¹åº”äºå…¶æš´éœ²çš„ 4 ä¸ªå¸¸ç”¨åˆå§‹åŒ–æ¥å£ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYFrameImage</span> </span>&#123;</span><br><span class="line">    <span class="built_in">NSUInteger</span> _loopCount;</span><br><span class="line">    <span class="built_in">NSUInteger</span> _oneFrameBytes;</span><br><span class="line">    <span class="built_in">NSArray</span> *_imagePaths;</span><br><span class="line">    <span class="built_in">NSArray</span> *_imageDatas;</span><br><span class="line">    <span class="built_in">NSArray</span> *_frameDurations;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>YYFrameImage çš„å®ç°ä»£ç éå¸¸ç®€å•ï¼Œåˆå§‹åŒ–æ–¹æ³•å¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ul>
<li>å…¥å‚æ ¡éªŒ</li>
<li>æ ¹æ®å…¥å‚å–åˆ°é¦–å¼ å›¾ç‰‡</li>
<li>ç”¨é¦–å›¾åˆå§‹åŒ– <code>_oneFrameBytes</code> ï¼Œå¦‚å…¥å‚åˆå§‹åŒ– <code>_imageDatas</code> ï¼Œ<code>_frameDurations</code> å’Œ <code>_loopCount</code></li>
<li>ç”¨ <code>UIImage</code> çš„ <code>initWithCGImage:scale:orientation:</code> åˆå§‹åŒ–å¹¶è¿”å›åˆå§‹åŒ–ç»“æœ</li>
</ul>
<h3 id="YYSpriteSheetImage"><a href="#YYSpriteSheetImage" class="headerlink" title="YYSpriteSheetImage"></a>YYSpriteSheetImage</h3><img src="/yyimage/ss_wukong.png" class="">
<p>YYSpriteSheetImage æ˜¯ç”¨æ¥åš Spritesheet åŠ¨ç”»æ˜¾ç¤ºçš„å›¾åƒç±»ï¼Œå®ƒä¹Ÿæ˜¯ UIImage çš„å­ç±»ã€‚</p>
<p>å…³äº Spritesheet å¯èƒ½åšè¿‡æ¸¸æˆå¼€å‘æˆ–è€…ä»¥å‰é¼“æ£è¿‡ç®€å•ç½‘é¡µæ¸¸æˆ Demo çš„åŒå­¦ä¼šå¾ˆç†Ÿæ‚‰ï¼Œå…¶åŠ¨ç”»åŸç†æ˜¯æŠŠä¸€ä¸ªåŠ¨ç”»è¿‡ç¨‹åˆ†è§£ä¸ºå¤šä¸ªåŠ¨ç”»å¸§ï¼ŒæŒ‰ç…§é¡ºåºå°†è¿™äº›åŠ¨ç”»å¸§æ’å¸ƒåœ¨ä¸€å¼ å¤§çš„ç”»å¸ƒä¸­ï¼Œæ’­æ”¾åŠ¨ç”»æ—¶åªéœ€è¦æŒ‰ç…§æ¯ä¸€å¸§å›¾åƒçš„å°ºå¯¸å¤§å°ä»¥åŠå¯¹åº”ç´¢å¼•å»ç”»å¸ƒä¸­æå–å¯¹åº”çš„å¸§æ›¿æ¢æ˜¾ç¤ºä»¥è¾¾åˆ°äººçœ¼åˆ¤å®šåŠ¨ç”»çš„æ•ˆæœï¼Œç‚¹å‡» <a target="_blank" rel="noopener" href="https://gamedevelopment.tutsplus.com/tutorials/an-introduction-to-spritesheet-animation--gamedev-13099"><br>An Introduction to Spritesheet Animation</a> æˆ–è€… <a target="_blank" rel="noopener" href="https://www.codeandweb.com/what-is-a-sprite-sheet">What is a sprite sheet?</a> äº†è§£æ›´å¤šå…³äº Spritesheet åŠ¨ç”»çš„ä¿¡æ¯ã€‚</p>
<blockquote>
<p>Note: å…³äº SpriteSheet ç´ æçš„åˆ¶ä½œæœ‰ä¸€æ¬¾å·¥å…· <a target="_blank" rel="noopener" href="https://www.codeandweb.com/sprite-sheet-maker">SpriteSheetMaker</a> æ¨èä½¿ç”¨ã€‚</p>
</blockquote>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYSpriteSheetImage</span> : <span class="title">UIImage</span> &lt;<span class="title">YYAnimatedImage</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–æ–¹æ³•ï¼Œè¿™ä¸ªç¬¬ä¸€æ¬¡æ¥è§¦ Spritesheet çš„åŒå­¦å¯èƒ½ä¼šè§‰å¾—æ¯”è¾ƒç¹ç</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithSpriteSheetImage:(<span class="built_in">UIImage</span> *)image</span><br><span class="line">                                     contentRects:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSValue</span> *&gt; *)contentRects</span><br><span class="line">                                   frameDurations:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSNumber</span> *&gt; *)frameDurations</span><br><span class="line">                                        loopCount:(<span class="built_in">NSUInteger</span>)loopCount;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span>&lt;<span class="built_in">NSValue</span> *&gt; *contentRects; <span class="comment">// å¸§ä½ç½®ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span>&lt;<span class="built_in">NSValue</span> *&gt; *frameDurations; <span class="comment">// å¸§æŒç»­æ—¶é•¿</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> loopCount; <span class="comment">// å¾ªç¯æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®ç´¢å¼•æ‰¾åˆ°å¯¹åº”å¸§ CALayer çš„ä½ç½®</span></span><br><span class="line">- (<span class="built_in">CGRect</span>)contentsRectForCALayerAtIndex:(<span class="built_in">NSUInteger</span>)index;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­åˆå§‹åŒ–æ–¹æ³•çš„å…¥å‚ä¸º SpriteSheet ç”»å¸ƒï¼ˆåŒ…å«æ‰€æœ‰åŠ¨ç”»å¸§çš„å¤§å›¾ï¼‰imageï¼Œæ¯ä¸€å¸§çš„ä½ç½® contentRectsï¼Œæ¯ä¸€å¸§å¯¹åº”çš„æŒç»­æ˜¾ç¤ºæ—¶é—´ frameDurationsï¼Œå¾ªç¯æ¬¡æ•° loopCountï¼Œåˆå§‹åŒ–ç¤ºä¾‹åœ¨ YYImage æºæ–‡ä»¶ <a target="_blank" rel="noopener" href="https://github.com/ibireme/YYImage/blob/master/YYImage/YYSpriteSheetImage.h#L32">YYSpriteSheetImage.h</a> æ³¨é‡Šä¸­æœ‰å†™ã€‚</p>
<blockquote>
<p>Note: ä¸‹æ–‡ä¸­è¦è®²çš„ YYAnimatedImageView ä¸­å®šä¹‰äº† YYAnimatedImage åè®®ï¼Œè¿™ä¸ªåè®®ä¸­æœ‰ä¸€ä¸ªå¯é€‰æ–¹æ³• <code>animatedImageContentsRectAtIndex:</code> å°±æ˜¯ä¸º YYSpriteSheetImage é‡èº«æ‰“é€ çš„ã€‚</p>
</blockquote>
<p>è¿™é‡Œéœ€è¦æä¸€ä¸‹ <code>contentsRectForCALayerAtIndex:</code> æ¥å£ä¼šæ ¹æ®ç´¢å¼•æ‰¾åˆ°å¯¹åº”å¸§çš„ CALayer ä½ç½®ï¼Œè¯¥æ¥å£è¿”å›ä¸€ä¸ªç”± 0.0~1.0 ä¹‹é—´çš„æ•°å€¼ç»„æˆçš„å›¾å±‚å®šä½ LayerRectï¼Œå¦‚æœåœ¨æŸ¥æ‰¾ä½ç½®è¿‡ç¨‹ä¸­å‘ç°å¼‚å¸¸åˆ™è¿”å› CGRectMake(0, 0, 1, 1)ï¼Œå…¶å†…éƒ¨å®ç°å¤§ä½“æ­¥éª¤ï¼š</p>
<ul>
<li>æ ¡éªŒå…¥å‚ç´¢å¼•æ˜¯å¦è¶…è¿‡ SpriteSheet åˆ†å‰²å¸§æ€»æ•°ï¼Œè¶…è¿‡è¿”å› CGRectMake(0, 0, 1, 1)</li>
<li>æ²¡è¶…è¿‡åˆ™é€šè¿‡ YYAnimatedImage åè®®çš„ <code>animatedImageContentsRectAtIndex:</code> æ–¹æ³•æ‰¾åˆ°å¯¹åº”ç´¢å¼•çš„çœŸå®ä½ç½® RealRect</li>
<li>é€šè¿‡çœŸå®ä½ç½® RealRect ä¸ SpriteSheet ç”»å¸ƒçš„æ¯”ç®—é”™ 0.0~1.0 ä¹‹é—´çš„å€¼ï¼Œå¾—åˆ°æŒ‡å®šç´¢å¼•å¸§çš„é€»è¾‘å®šä½ LogicRect</li>
<li>é€šè¿‡ <code>CGRectIntersection</code> æ–¹æ³•è®¡ç®—é€»è¾‘å®šä½ LogicRect ä¸ CGRectMake(0, 0, 1, 1) çš„äº¤é›†ï¼Œç¡®ä¿é€»è¾‘å®šä½æ²¡æœ‰è¶…å‡ºç”»å¸ƒçš„éƒ¨åˆ†</li>
<li>å°†å¤„ç†åçš„é€»è¾‘å®šä½ LogicRect ä½œä¸ºå›¾å±‚å®šä½ LayerRect è¿”å›</li>
</ul>
<p>è¿”å›çš„ LayerRect ä½œä¸ºå¯¹åº”ç´¢å¼•å¸§çš„ç”»å¸ƒå†…ç›¸å¯¹ä½ç½®å­˜åœ¨ï¼Œç»“åˆç”»å¸ƒå°±å¯ä»¥å®šä½åˆ°å¯¹åº”å¸§å›¾åƒçš„å…·ä½“å°ºå¯¸å’Œä½ç½®ã€‚</p>
<h2 id="YYAnimatedImageView"><a href="#YYAnimatedImageView" class="headerlink" title="YYAnimatedImageView"></a>YYAnimatedImageView</h2><img src="/yyimage/blood_wheel_eye.jpeg" class="">
<p>äººçœ¼ä¸­å‘ˆç°çš„åŠ¨ç”»æ˜¯ç”±ä¸€å¹…å¹…å†…å®¹è¿è´¯çš„å›¾åƒä»¥è¾ƒçŸ­æ—¶é—´æŒ‰é¡ºåºæ›¿æ¢å½¢æˆçš„ï¼Œæ‰€ä»¥è¦æ˜¾ç¤ºåŠ¨ç”»åªéœ€è¦çŸ¥é“åŠ¨ç”»é¡ºåºä¸­æ¯ä¸€å¸§å›¾åƒä»¥åŠå¯¹åº”çš„æ˜¾ç¤ºæ—¶é—´ç­‰ä¿¡æ¯å³å¯ã€‚YYImage ä¸­å¯¹åº”äº UIImage å±‚çº§çš„å†…å®¹ï¼ˆYYImage, YYFrameImage, YYSpriteSheetImageï¼‰åœ¨ä¸Šæ–‡å·²ç»ä»‹ç»è¿‡äº†ï¼Œè™½ç„¶å®ƒä»¬ä¹‹é—´å­˜åœ¨å†…å®¹å’Œå½¢å¼ä¸Šçš„å·®å¼‚ï¼Œä½†æ˜¯å¯¹äºäººçœ¼åŠ¨ç”»å‘ˆç°çš„åŸç†å´æ˜¯ä¸å˜çš„ã€‚</p>
<p>YYAnimatedImageView æ˜¯ YYImage çš„é‡è¦ç»„æˆï¼Œå®ƒæ˜¯ UIImageView çš„å­ç±»ï¼Œè´Ÿè´£ YYImage å›¾åƒå±‚ä¸­ä¸åŒçš„å›¾åƒç±»çš„è§†å›¾æ˜¾ç¤ºï¼ˆåŒ…å«åŠ¨æ€å›¾åƒçš„åŠ¨ç”»æ’­æ”¾ï¼‰ï¼Œå…¶å†…éƒ¨åŒ…å« YYAnimatedImage åè®®ä»¥åŠ YYAnimatedImageView è‡ªèº«ä¸¤éƒ¨åˆ†ã€‚</p>
<h3 id="YYAnimatedImage-åè®®"><a href="#YYAnimatedImage-åè®®" class="headerlink" title="YYAnimatedImage åè®®"></a>YYAnimatedImage åè®®</h3><p>ä¸Šæ–‡æåˆ°ä¸è®ºæ˜¯ YYImage, YYFrameImage, YYSpriteSheetImage è¿˜æ˜¯ä»¥åå¯èƒ½ä¼šæ‰©å±•çš„å›¾åƒç±»ï¼Œè™½ç„¶å®ƒä»¬ä¹‹é—´å­˜åœ¨å†…å®¹å’Œå½¢å¼ä¸Šçš„å·®å¼‚ï¼Œä½†æ˜¯å¯¹äºäººçœ¼åŠ¨ç”»å‘ˆç°çš„åŸç†å´æ˜¯ä¸å˜çš„ã€‚</p>
<p>YYAnimatedImage åè®®å°±æ˜¯åœ¨ä¸å½±å“åŸæ¥å›¾åƒç±»çš„æƒ…å†µä¸‹æŠŠä¸åŒå›¾åƒç±»ä¹‹é—´çš„å…±æ€§æ‰¾å‡ºæ¥ï¼ˆæ±‚åŒå­˜å¼‚ï¼Ÿç¬‘ï¼‰ï¼Œä»¥ç»Ÿä¸€åŒ–çš„æ¥å£å°†äººçœ¼åŠ¨ç”»å‘ˆç°æ‰€éœ€çš„åŸºæœ¬ä¿¡æ¯è¾“å‡ºç»™ YYAnimatedImageView ä½¿ç”¨çš„åè®®ã€‚</p>
<blockquote>
<p>Note: ä½œä¸ºå›¾åƒç±»é¡»éµå¾ª YYAnimatedImage åè®®ä»¥ä¾¿å¯ä»¥ä½¿ç”¨ YYAnimatedImageView æ’­æ”¾åŠ¨ç”»ã€‚</p>
</blockquote>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">YYAnimatedImage</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@required</span></span><br><span class="line"><span class="comment">// åŠ¨ç”»å¸§æ€»æ•°</span></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)animatedImageFrameCount;</span><br><span class="line"><span class="comment">// åŠ¨ç”»å¾ªç¯æ¬¡æ•°ï¼Œ0 è¡¨ç¤ºæ— é™å¾ªç¯</span></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)animatedImageLoopCount;</span><br><span class="line"><span class="comment">// æ¯å¸§å­—èŠ‚æ•°ï¼ˆåœ¨å†…å­˜ä¸­ï¼‰ï¼Œå¯èƒ½ç”¨äºä¼˜åŒ–å†…å­˜ç¼“å†²åŒºå¤§å°</span></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)animatedImageBytesPerFrame;</span><br><span class="line"><span class="comment">// è¿”å›ç»™å®šç‰¹æ®Šç´¢å¼•å¯¹åº”çš„å¸§å›¾åƒï¼Œè¿™ä¸ªæ–¹æ³•å¯èƒ½åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­è°ƒç”¨</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)animatedImageFrameAtIndex:(<span class="built_in">NSUInteger</span>)index;</span><br><span class="line"><span class="comment">// è¿”å›ç»™å®šç‰¹æ®Šç´¢å¼•å¯¹åº”çš„å¸§å›¾åƒå¯¹åº”çš„æ˜¾ç¤ºæŒç»­æ—¶é•¿</span></span><br><span class="line">- (<span class="built_in">NSTimeInterval</span>)animatedImageDurationAtIndex:(<span class="built_in">NSUInteger</span>)index;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@optional</span></span><br><span class="line"><span class="comment">// é’ˆå¯¹ Spritesheet åŠ¨ç”»çš„æ–¹æ³•ï¼Œç”¨äºæ˜¾ç¤ºæŸä¸€å¸§å›¾åƒåœ¨ Spritesheet ç”»å¸ƒä¸­çš„ä½ç½®</span></span><br><span class="line">- (<span class="built_in">CGRect</span>)animatedImageContentsRectAtIndex:(<span class="built_in">NSUInteger</span>)index;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¸Šæ–‡æåˆ°è¿‡å¯é€‰å®ç°æ¥å£ <code>animatedImageContentsRectAtIndex:</code> æ˜¯ä¸“ä¸º Spritesheet åŠ¨ç”»è®¾è®¡çš„ã€‚</p>
</blockquote>
<p>åƒè¿™æ ·è§„å®šä¸€ä¸ªåè®®ï¼Œä½¿ä¸ç›¸å…³çš„ç±»éµå¾ªæ­¤åè®®æ‹¥æœ‰ç»Ÿä¸€çš„åŠŸèƒ½æ¥å£æ–¹ä¾¿å¦ä¸€ä¸ªç±»è°ƒç”¨çš„è®¾è®¡æ€æƒ³æˆ‘ä»¬åœ¨è‡ªå·±æ—¥å¸¸é¡¹ç›®çš„å¼€å‘è¿‡ç¨‹ä¸­å¾ˆå¤šåœºæ™¯éƒ½å¯ä»¥ç”¨åˆ°ï¼Œä¾‹å¦‚å¯ä»¥å°è£…ä¸€ä¸ª TableViewï¼Œè®¾è®¡ä¸€ä¸ª TableViewCell åè®®ï¼Œè®©æ‰€æœ‰ TableViewCell éƒ½å®ç°è¿™ä¸ªåè®®ä»¥æ‹¥æœ‰ç»Ÿä¸€çš„åŠŸèƒ½æ¥å£ï¼Œç„¶åæˆ‘ä»¬å°è£…çš„ TableView ç±»å°±å¯ä»¥ç»Ÿä¸€çš„ä½¿ç”¨è¿™äº› TableViewCell æ˜¾ç¤ºæ•°æ®å•¦ï¼Œçœå»äº†åå¤å†™ç›¸åŒåŠŸèƒ½ UITableView çš„åŠ³åŠ¨åŠ›ï¼ˆå®é™…åº”ç”¨åœºæ™¯å¾ˆå¤šï¼Œè¿™é‡Œåªæ˜¯ç®€å•ä¸¾ä¾‹ï¼ŒæŠ›ç –å¼•ç‰ï¼‰ã€‚</p>
<h3 id="YYAnimatedImageView-1"><a href="#YYAnimatedImageView-1" class="headerlink" title="YYAnimatedImageView"></a>YYAnimatedImageView</h3><p>ä¸Šæ–‡æåˆ°è¿‡ YYAnimatedImageView ä½œä¸º YYImage æ¡†æ¶ä¸­çš„å›¾ç‰‡è§†å›¾å±‚ï¼Œä¸Šæ¥å›¾åƒå±‚ï¼Œä¸‹å¯ç¼–/è§£ç åº•å±‚ï¼Œæ˜¯æ¢çº½ä¸€èˆ¬çš„å­˜åœ¨ï¼ˆæ‰¿ä¸Šå¯ä¸‹å•Šæœ‰æœ¨æœ‰ï¼Ÿï¼‰ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹ç ”ç©¶å…¶å†…éƒ¨å®ç°ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYAnimatedImageView</span> : <span class="title">UIImageView</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœ image ä¸ºå¤šå¸§ç»„æˆæ—¶ï¼Œè‡ªåŠ¨èµ‹å€¼ä¸º YESï¼Œå¯ä»¥åœ¨æ˜¾ç¤ºå’Œéšè—æ—¶è‡ªåŠ¨æ’­æ”¾å’Œåœæ­¢åŠ¨ç”»</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="type">BOOL</span> autoPlayAnimatedImage;</span><br><span class="line"><span class="comment">// å½“å‰æ˜¾ç¤ºçš„å¸§ï¼ˆä» 0 èµ·å§‹ï¼‰ï¼Œè®¾ç½®æ–°å€¼åä¼šç«‹å³æ˜¾ç¤ºå¯¹åº”å¸§ï¼Œå¦‚æœæ–°å€¼æ— æ•ˆåˆ™æ­¤æ–¹æ³•æ— æ•ˆ</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">NSUInteger</span> currentAnimatedImageIndex;</span><br><span class="line"><span class="comment">// å½“å‰æ˜¯å¦åœ¨æ’­æ”¾åŠ¨ç”»</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="type">BOOL</span> currentIsPlayingAnimation;</span><br><span class="line"><span class="comment">// åŠ¨ç”»å®šæ—¶å™¨æ‰€åœ¨çš„ runloop modeï¼Œé»˜è®¤ä¸º NSRunLoopCommonModesï¼Œå…³ä¹åŠ¨ç”»å®šæ—¶å™¨çš„è§¦å‘</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *runloopMode;</span><br><span class="line"><span class="comment">// å†…éƒ¨ç¼“å­˜åŒºçš„æœ€å¤§å€¼ï¼ˆin bytesï¼‰ï¼Œé»˜è®¤ä¸º 0ï¼ˆåŠ¨æ€ï¼‰ï¼Œå¦‚æœæœ‰å€¼å°†ä¼šæŠŠç¼“å­˜åŒºé™åˆ¶ä¸ºå€¼å¤§å°ï¼Œå½“æ”¶åˆ°å†…å­˜è­¦å‘Šæˆ–è€… App è¿›å…¥åå°æ—¶ï¼Œç¼“å­˜åŒºå°†ä¼šç«‹å³é‡Šæ”¾å¹¶ä¸”åœ¨é€‚æ—¶çš„æ—¶å€™å›å¤åŸçŠ¶</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">NSUInteger</span> maxBufferSize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>é¢â€¦å‡ºä¹æ„æ–™çš„ç®€å•å‘¢~ åªæœ‰ä¸€äº›å±æ€§æš´éœ²å‡ºæ¥ä»¥ä¾¿æˆ‘ä»¬åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å®æ—¶æŸ¥çœ‹åŠ¨ç”»çš„æ’­æ”¾çŠ¶æ€ä»¥åŠå†…å­˜ä½¿ç”¨æƒ…å†µã€‚ç¬”è€…çœ‹æºç æ€»ç»“å‡ºä¸€æ¡ç»éªŒï¼Œå³<strong>å¦‚æœæŸä¸ªç»„ä»¶åœ¨åº“ä¸­å æ®é‡è¦åœ°ä½ï¼Œå…¶ .h æ–‡ä»¶ä¸­æš´éœ²çš„å†…å®¹è¶Šæ˜¯ç®€å•ï¼Œå…¶ .m å†…éƒ¨å®ç°å°±è¶Šæ˜¯å¤æ‚</strong>ã€‚</p>
<p>é€šè¿‡ <code>runloopMode</code> å±æ€§å¤§å®¶ç”¨çŒœçš„ä¹Ÿåº”è¯¥å¯ä»¥çŒœå‡º YYAnimatedImageView å†…éƒ¨å®ç°åŠ¨ç”»çš„åŸç†ç¦»ä¸å¼€ RunLoopï¼Œè€Œä¸”ææœ‰å¯èƒ½æ˜¯ç”¨å®šæ—¶å™¨ NSTimer æˆ–è€… CADisplayLink å®ç°çš„ã€‚ä¸‹é¢æˆ‘ä»¬æ¥å¯¹ YYAnimatedImageView çš„å®ç°å‰–æï¼ŒéªŒè¯ä¸€ä¸‹æˆ‘ä»¬åˆšæ‰çš„çŒœæƒ³ã€‚</p>
<h4 id="YYAnimatedImageView-çš„å®ç°å‰–æ"><a href="#YYAnimatedImageView-çš„å®ç°å‰–æ" class="headerlink" title="YYAnimatedImageView çš„å®ç°å‰–æ"></a>YYAnimatedImageView çš„å®ç°å‰–æ</h4><p>YYAnimatedImageView å†…éƒ¨å®ç°æºç å¾ˆæœ‰è¶£ï¼Œæœ‰å¾ˆå¤šå€¼å¾—åˆ†äº«çš„åœ°æ–¹ã€‚ä¸è¿‡ä¸ºäº†ä¸æŠŠæ–‡ç« å†™æˆ MarkDown ç¼–è¾‘å™¨æ–‡ï¼ˆç¬‘~ï¼‰ç¬”è€…ä¸ä¼šé€è¡Œç¿»è¯‘æºç ã€‚è¯»è€…å¦‚æœæƒ³è¦çŸ¥é“å®ç°çš„ç»†èŠ‚å»ºè®®ç»“åˆæ–‡ç« å»ç¿»é˜…æºç ã€‚ç›¸ä¿¡æœ‰äº†æ–‡ç« æ¢³ç†çš„æ€è·¯æºç çœ‹èµ·æ¥åº”è¯¥ä¸ä¼šæœ‰å¤ªå¤§çš„å›°éš¾ï¼Œæ–‡ç« è¿˜æ˜¯é‡åœ¨ä¼ æ’­å®ç°æ€æƒ³å’Œä¸€äº›å€¼å¾—åˆ†äº«çš„æŠ€å·§ã€‚</p>
<p>æˆ‘ä»¬å…ˆç®€å•çœ‹ä¸€ä¸‹ YYAnimatedImageView çš„å†…éƒ¨ç»“æ„ï¼Œæ–¹ä¾¿åé¢åˆ†æå®ç°æ€è·¯æ—¶å¤§å®¶è„‘ä¸­å¯¹ YYAnimatedImageView çš„ç»“æ„æå‰æœ‰ä¸€ä¸ªå¤§æ¦‚çš„è®¤è¯†ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYAnimatedImageView</span>() </span>&#123;</span><br><span class="line">    <span class="keyword">@package</span></span><br><span class="line">    <span class="built_in">UIImage</span> &lt;YYAnimatedImage&gt; *_curAnimatedImage; <span class="comment">///&lt; å½“å‰å›¾åƒ</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_once_t</span> _onceToken; <span class="comment">///&lt; ç”¨äºç¡®ä¿åˆå§‹åŒ–ä»£ç åªæ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">    dispatch_semaphore_t _lock; <span class="comment">///&lt; ä¿¡å·é‡é”ï¼ˆç”¨äº _bufferï¼‰</span></span><br><span class="line">    <span class="built_in">NSOperationQueue</span> *_requestQueue; <span class="comment">///&lt; å›¾ç‰‡è¯·æ±‚é˜Ÿåˆ—ï¼Œä¸²è¡Œ</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CADisplayLink</span> *_link; <span class="comment">///&lt; å¸§è½¬æ¢</span></span><br><span class="line">    <span class="built_in">NSTimeInterval</span> _time; <span class="comment">///&lt; ä¸Šä¸€å¸§ä¹‹åçš„æ—¶é—´</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIImage</span> *_curFrame; <span class="comment">///&lt; å½“å‰å¸§</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> _curIndex; <span class="comment">///&lt; å½“å‰å¸§ç´¢å¼•</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> _totalFrameCount; <span class="comment">///&lt; å¸§æ€»æ•°</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">BOOL</span> _loopEnd; <span class="comment">///&lt; æ˜¯å¦åœ¨å¾ªç¯æœ«å°¾</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> _curLoop; <span class="comment">///&lt; å½“å‰å¾ªç¯æ¬¡æ•°</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> _totalLoop; <span class="comment">///&lt; æ€»å¾ªç¯æ¬¡æ•°, 0 è¡¨ç¤ºæ— ç©·</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *_buffer; <span class="comment">///&lt; å¸§ç¼“å†²åŒº</span></span><br><span class="line">    <span class="type">BOOL</span> _bufferMiss; <span class="comment">///&lt; æ˜¯å¦ä¸¢å¸§ï¼Œåœ¨ä¸Šé¢ _link å®šæ—¶æ‰§è¡Œçš„ step å‡½æ•°ä¸­ä»å¸§ç¼“å†²åŒºè¯»å–ä¸‹ä¸€å¸§å›¾ç‰‡æ—¶å¦‚æœæ²¡è¯»åˆ°ï¼Œåˆ™è§†ä¸ºä¸¢å¸§</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> _maxBufferCount; <span class="comment">///&lt; æœ€å¤§ç¼“å†²è®¡æ•°</span></span><br><span class="line">    <span class="built_in">NSInteger</span> _incrBufferCount; <span class="comment">///&lt; å½“å‰å…è®¸çš„ç¼“å­˜åŒºè®¡æ•°ï¼ˆå°†é€æ­¥å¢åŠ ï¼‰</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGRect</span> _curContentsRect; <span class="comment">///&lt; é’ˆå¯¹ YYSpriteSheetImage</span></span><br><span class="line">    <span class="type">BOOL</span> _curImageHasContentsRect; <span class="comment">///&lt; å›¾åƒç±»æ˜¯å¦å®ç°äº† animatedImageContentsRectAtIndex: æ¥å£</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readwrite</span>) <span class="type">BOOL</span> currentIsPlayingAnimation;</span><br><span class="line">- (<span class="type">void</span>)calcMaxBufferCount; <span class="comment">// åŠ¨æ€è°ƒèŠ‚ç¼“å†²åŒºæœ€å¤§é™åˆ¶ _maxBufferCount</span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ° YYAnimatedImageView å†…éƒ¨ç»“æ„æ¯” .h ä¸­æš´éœ²çš„å±æ€§è¦å¤æ‚çš„å¤šï¼Œè€Œ <code>CADisplayLink *_link</code> å±æ€§ä¹Ÿè¯å®äº†æˆ‘ä»¬ä¹‹å‰å…³äº .h ä¸­ <code>runloopMode</code> å±æ€§çš„çŒœæƒ³ã€‚</p>
<p>YYAnimatedImageView å†…éƒ¨çš„åˆå§‹åŒ–æ²¡ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„ï¼Œåˆå§‹åŒ–å‡½æ•°ä¸­ä¼šè®¾ç½®å›¾ç‰‡ï¼Œå½“åˆ¤å®šå›¾ç‰‡æœ‰æ›´æ”¹æ—¶ä¼šä¾ç…§ä¸‹é¢ 4 æ­¥å»å¤„ç†ï¼š</p>
<ul>
<li>æ”¹å˜å›¾ç‰‡</li>
<li>é‡ç½®åŠ¨ç”»</li>
<li>åˆå§‹åŒ–åŠ¨ç”»å‚æ•°</li>
<li>é‡ç»˜</li>
</ul>
<blockquote>
<p>Note: è¿™æ ·å¯ä»¥ä¿è¯ YYAnimatedImageView çš„å›¾ç‰‡æ›´æ”¹æ—¶éƒ½ä¼šæ‰§è¡Œä¸Šé¢çš„æ­¥éª¤ä¸ºæ–°çš„å›¾ç‰‡åˆå§‹åŒ–é…å¥—çš„æ–°åŠ¨ç”»å‚æ•°å¹¶ä¸”é‡ç»˜ï¼Œè€Œé‡ç½®åŠ¨ç”»å®ç°ä¸­ä¼šä½¿ç”¨åˆ°ä¸Šé¢çš„ <code>dispatch_once_t _onceToken;</code> ä»¥ç¡®ä¿æŸäº›å†…éƒ¨å˜é‡çš„åˆ›å»ºä»¥åŠå¯¹ App å†…å­˜è­¦å‘Šå’Œè¿›å…¥åå°çš„é€šçŸ¥è§‚å¯Ÿä»£ç åªæ‰§è¡Œä¸€æ¬¡ã€‚</p>
</blockquote>
<p>YYAnimatedImageView ä½¿å›¾ç‰‡åŠ¨èµ·æ¥æ˜¯ä¾é  <code>CADisplayLink *_link;</code> å˜é‡åˆ‡æ¢å¸§å›¾åƒï¼Œå…¶å†…éƒ¨çš„å®ç°é€»è¾‘å¯ä»¥ç®€å•ç†è§£ä¸ºï¼š</p>
<ul>
<li>æ ¹æ®å½“å‰å¸§ç´¢å¼•æ¨å‡ºä¸‹ä¸€å¸§ç´¢å¼•</li>
<li>ä½¿ç”¨ä¸‹ä¸€å¸§ç´¢å¼•å»å¸§ç¼“å†²åŒºå°è¯•è·å–å¯¹åº”å¸§å›¾åƒ</li>
<li>å¦‚æœæ‰¾åˆ°å¯¹åº”å¸§å›¾åƒåˆ™ä½¿ç”¨å…¶é‡ç»˜</li>
<li>å¦‚æœæ²¡æ‰¾åˆ°åˆ™æ ¹æ®æ¡ä»¶å‘å›¾ç‰‡è¯·æ±‚é˜Ÿåˆ—åŠ å…¥è¯·æ±‚æ“ä½œï¼ˆå‘å›¾ç‰‡ç¼“å†²åŒºå½•å…¥ä¹‹åçš„å¸§å›¾åƒæ•°æ®ï¼‰</li>
</ul>
<p>å˜›~ è¿™é‡Œé¢æœ‰ä¸€äº›å€¼å¾—ä¸€æçš„å®ç°ç»†èŠ‚å“ˆï¼</p>
<blockquote>
<ul>
<li>YYAnimatedImageView å®ç°ä¸­å½“ <code>_curIndex</code> å³å½“å‰å¸§ç´¢å¼•ä¿®æ”¹æ—¶åœ¨ä¿®æ”¹ä»£ç å‰ååŠ å…¥äº† <code>willChangeValueForKey:</code> ä¸ <code>didChangeValueForKey:</code> æ–¹æ³•ä»¥æ”¯æŒ KVO</li>
<li>å¯¹å¸§ç¼“å†²åŒº <code>_buffer</code> çš„æ“ä½œéƒ½ä½¿ç”¨ <code>_lock</code> ä¸Šé”</li>
<li>é€šè¿‡å°†å›¾ç‰‡è¯·æ±‚é˜Ÿåˆ— <code>_requestQueue</code> çš„ <code>maxConcurrentOperationCount</code> è®¾ç½®ä¸º 1 ä½¿å›¾ç‰‡è¯·æ±‚é˜Ÿåˆ—æˆä¸ºä¸²è¡Œé˜Ÿåˆ—ï¼ˆæœ€å¤§å¹¶å‘æ•°ä¸º 1ï¼‰</li>
<li>å›¾ç‰‡è¯·æ±‚é˜Ÿåˆ—ä¸­åŠ å…¥çš„æ“ä½œå‡ä¸º <code>_YYAnimatedImageViewFetchOperation</code></li>
<li>ä¸ºäº†é¿å…ä½¿ç”¨ <code>CADisplayLink</code> å¯èƒ½é€ æˆçš„å¾ªç¯å¼•ç”¨è®¾è®¡äº† <code>_YYImageWeakProxy</code></li>
</ul>
</blockquote>
<p>å…ˆçœ‹ä¸€ä¸‹ <code>_YYAnimatedImageViewFetchOperation</code> çš„æºç ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">_YYAnimatedImageViewFetchOperation</span> : <span class="title">NSOperation</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) YYAnimatedImageView *view;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSUInteger</span> nextIndex;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIImage</span> &lt;YYAnimatedImage&gt; *curImage;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">_YYAnimatedImageViewFetchOperation</span></span></span><br><span class="line">- (<span class="type">void</span>)main &#123;<span class="comment">//...&#125;</span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><code>_YYAnimatedImageViewFetchOperation</code> ç»§æ‰¿è‡ª NSOperation ç±»ï¼Œæ˜¯è‡ªå®šä¹‰æ“ä½œç±»ï¼Œä½œè€…å°†å…¶æ“ä½œå†…å®¹å®ç°å†™åœ¨äº† <code>main</code> ä¸­ï¼Œä»£ç å¤ªé•¿è€Œä¸”æˆ‘è§‰å¾—è´´å‡ºæ¥ä¸ä»…ä¸ä¼šå¸®åŠ©è¯»è€…ç†è§£åè€Œä¼šå› ä¸ºç‰‡é¢çš„æºç å®ç°å½±å“è¯»è€…å¯¹ YYAnimatedImageView çš„æ•´ä½“å®ç°æ€è·¯ç†è§£ï¼ˆå› ä¸ºå¤§é‡è´´æºç ä¼šä½¿æ–‡ç« ç”Ÿæ¶©å¾ˆå¤šï¼Œè€Œä¸”ä¼šæŠŠè¯»è€…æ³¨æ„åŠ›è½¬ç§»åˆ°æŸä¸€ä¸ªå®ç°ï¼‰ï¼Œè¿™é‡Œç®€å•æè¿°ä¸€ä¸‹ <code>main</code> å‡½æ•°å†…éƒ¨å®ç°é€»è¾‘ï¼š</p>
<ul>
<li>åˆ¤æ–­å¸§ç¼“å†²åŒºå¤§å°</li>
<li>æ‰«æä¸‹ä¸€å¸§ä»¥åŠå½“å‰å…è®¸ç¼“å†²èŒƒå›´å†…ä¹‹åçš„å¸§å›¾ç‰‡</li>
<li>å¦‚æœå‘ç°ä¸¢å¤±çš„å¸§åˆ™å°è¯•é‡æ–°è·å–å¸§å›¾åƒå¹¶åŠ å…¥åˆ°å¸§ç¼“å†²</li>
</ul>
<p>å˜›~ ä¸è´´æºç å½’ä¸è´´æºç ï¼Œè¯¥æ³¨æ„çš„ç»†èŠ‚è¿˜æ˜¯éœ€è¦åˆ—å‡ºæ¥çš„ï¼ˆç¬‘ï¼‰ã€‚</p>
<blockquote>
<ul>
<li>æ“ä½œä¸­å¯¹äº <code>view</code> ç¼“å†²åŒºçš„æ“ä½œä¹Ÿéƒ½ä¸Šäº†é”</li>
<li>æ“ä½œç”±äºæ˜¯æ”¾å…¥å›¾ç‰‡è¯·æ±‚é˜Ÿåˆ—ä¸­è¿›è¡Œçš„ï¼Œå†…éƒ¨æœ‰å¯¹ <code>isCancelled</code> åšåˆ¤æ–­ï¼Œå¦‚æœæ“ä½œå·²ç»è¢«å–æ¶ˆï¼ˆå‘ç”Ÿåœ¨æ›´æ”¹å›¾ç‰‡ã€åœæ­¢åŠ¨ç”»ã€æ‰‹åŠ¨æ›´æ”¹å½“å‰å¸§ã€æ”¶åˆ°å†…å­˜è­¦å‘Šæˆ– App è¿›å…¥åå°ç­‰ï¼‰åˆ™éœ€è¦åŠæ—¶è·³å‡º</li>
<li>å¯¹äºæ–°çš„çº¿ç¨‹ä¼˜å…ˆçº§åªåœ¨ <code>main</code> æ–¹æ³•èŒƒå›´å†…æœ‰æ•ˆï¼Œæ‰€ä»¥æ¨èæŠŠæ“ä½œçš„å®ç°æ”¾åœ¨ <code>main</code> ä¸­è€Œé <code>start</code>ï¼ˆå¦‚éœ€è¦†ç›– start æ–¹æ³•æ—¶ï¼Œéœ€è¦å…³æ³¨ <code>isExecuting</code> å’Œ <code>isFinished</code> ä¸¤ä¸ª key pathsï¼‰</li>
</ul>
</blockquote>
<p>YYAnimatedImageView å†…éƒ¨è®¾è®¡äº† <code>_YYImageWeakProxy</code> æ¥é¿å…ä½¿ç”¨ NSTimer æˆ–è€… CADisplayLink å¯èƒ½é€ æˆçš„å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œ<code>_YYImageWeakProxy</code> å†…éƒ¨å®ç°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œç»§æ‰¿è‡ª NSProxyï¼Œå…³äº NSProxy å¯ä»¥æŸ¥çœ‹<a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/foundation/nsproxy">å®˜æ–¹æ–‡æ¡£</a>ä»¥äº†è§£æ›´å¤šã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">_YYImageWeakProxy</span> : <span class="title">NSProxy</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">readonly</span>) <span class="type">id</span> target;</span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithTarget:(<span class="type">id</span>)target;</span><br><span class="line">+ (<span class="keyword">instancetype</span>)proxyWithTarget:(<span class="type">id</span>)target;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">_YYImageWeakProxy</span></span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">- (<span class="type">id</span>)forwardingTargetForSelector:(SEL)selector &#123;</span><br><span class="line">    <span class="keyword">return</span> _target;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="type">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)invocation &#123;</span><br><span class="line">    <span class="type">void</span> *null = <span class="literal">NULL</span>;</span><br><span class="line">    [invocation setReturnValue:&amp;null];</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)selector &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSObject</span> instanceMethodSignatureForSelector:<span class="keyword">@selector</span>(init)];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢è´´å‡ºçš„æºç çœç•¥äº†æ¯”è¾ƒåŸºç¡€çš„å®ç°éƒ¨åˆ†ï¼Œ<code>_YYImageWeakProxy</code> å†…éƒ¨å¼±å¼•ç”¨ä¸€ä¸ªå¯¹è±¡ targetï¼Œå¯¹äº <code>_YYImageWeakProxy</code> çš„ä¸€äº›åŸºæœ¬æ“ä½œåŒ…å« <code>hash</code> å’Œ <code>isEqual</code> è¿™äº›ç»Ÿç»Ÿéƒ½è½¬åˆ° target ä¸Šï¼Œå¹¶ä¸”ä½¿ç”¨ <code>forwardingTargetForSelector:</code> æ¶ˆæ¯é‡å®šå‘å°†ä¸èƒ½å“åº”çš„è¿è¡Œæ—¶æ¶ˆæ¯ä¹Ÿé‡å®šå‘ç»™ target æ¥å“åº”ã€‚</p>
<p>Emmmmm..é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæ—¢ç„¶éƒ½æ¶ˆæ¯é‡å®šå‘ç»™ target äº†è¿˜è¦æ¶ˆæ¯è½¬å‘å¹²å˜›ï¼Ÿå› ä¸ºè¦é¿å…å¾ªç¯å¼•ç”¨é—®é¢˜æ‰€ä»¥å¯¹ target ä½¿ç”¨å¼±å¼•ç”¨ï¼ŒæœŸé—´æ— æ³•ä¿è¯ target ä¸€å®šå­˜åœ¨ï¼Œæ‰€ä»¥ <code>forwardingTargetForSelector:</code> æ–¹æ³•å¯èƒ½è¿”å› nilï¼Œæ¥ç€åœ¨ Runtime æ¶ˆæ¯è½¬å‘ä¸­å€Ÿç”¨ init æ¶ˆæ¯è¿”å›ç©ºä»¥â€œåæ‰â€å¼‚å¸¸ã€‚</p>
<blockquote>
<p>Note: æ¶ˆæ¯è½¬å‘äº§ç”Ÿçš„å¼€é”€è¦æ¯”åŠ¨æ€æ–¹æ³•è§£æå’Œæ¶ˆæ¯é‡å®šå‘å¤§ã€‚</p>
</blockquote>
<h2 id="YYImageCoder"><a href="#YYImageCoder" class="headerlink" title="YYImageCoder"></a>YYImageCoder</h2><img src="/yyimage/image_coder.jpg" class="">
<p>YYImageCoder ä½œä¸º YYImage çš„ç¼–/è§£ç å™¨ï¼Œå¯¹åº”äº iOS ä¸­çš„ ImageIO.framework å›¾ç‰‡ç¼–/è§£ç åº“ï¼Œæ­£æ˜¯å› ä¸ºæœ‰äº† YYImageCoder çš„å­˜åœ¨ï¼ŒYYImage æ‰å¾—ä»¥æ”¯æŒå¦‚æ­¤å¤šçš„å›¾ç‰‡æ ¼å¼ï¼Œæ‰€ä»¥è¯´ YYImageCoder æ˜¯ YYImage çš„åº•å±‚æ ¸å¿ƒã€‚</p>
<p>YYImageCoder å†…éƒ¨å®šä¹‰äº†è®¸å¤š YYImage ä¸­ç”¨åˆ°çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š</p>
<ul>
<li>YYImageTypeï¼Œæ‰€æœ‰çš„æ”¯æŒçš„å›¾ç‰‡æ ¼å¼åšäº†æšä¸¾å®šä¹‰</li>
<li>YYImageDisposeMethodï¼ŒæŒ‡å®šåœ¨ç”»å¸ƒä¸Šæ¸²æŸ“ä¸‹ä¸€ä¸ªå¸§ä¹‹å‰å¦‚ä½•å¤„ç†å½“å‰å¸§æ‰€ä½¿ç”¨çš„åŒºåŸŸæ–¹æ³•</li>
<li>YYImageBlendOperationï¼ŒæŒ‡å®šå½“å‰å¸§çš„é€æ˜åƒç´ å¦‚ä½•ä¸å‰ä¸€ä¸ªç”»å¸ƒçš„é€æ˜åƒç´ æ··åˆæ“ä½œ</li>
<li>YYImageFrameï¼Œä¸€å¸§å›¾åƒæ•°æ®</li>
<li>YYImageEncoderï¼Œå›¾åƒç¼–ç å™¨</li>
<li>YYImageDecoderï¼Œå›¾åƒè§£ç å™¨</li>
<li>UIImage+YYImageCoderï¼ŒUIImage çš„åˆ†ç±»ï¼Œé‡Œé¢æä¾›äº†ä¸€äº›æ–¹ä¾¿ä½¿ç”¨çš„æ–¹æ³•</li>
</ul>
<p>å…¶ä¸­ YYImageFrame æ˜¯å¯¹ä¸€å¸§å›¾åƒæ•°æ®çš„å°è£…ï¼Œä¾¿äºåœ¨ YYImageCoder ç¼–/è§£ç è¿‡ç¨‹ä¸­ä½¿ç”¨ã€‚</p>
<p>YYImageCoder å†…éƒ¨å›¾åƒç¼–ç å™¨ YYImageEncoder å’Œå›¾åƒè§£ç å™¨ YYImageDecoder å…¶å®æ˜¯åˆ†å¼€æ¥çš„ï¼Œæˆ‘ä»¬ä¸‹é¢åˆ†åˆ«å¯¹å®ƒä»¬åšåˆ†æã€‚</p>
<h3 id="YYImageEncoder"><a href="#YYImageEncoder" class="headerlink" title="YYImageEncoder"></a>YYImageEncoder</h3><p>å…ˆæ¥è®²ä¸€ä¸‹ YYImageEncoderï¼Œå…¶åœ¨ YYImageCoder ä¸­æ‹…ä»»ç¼–ç å™¨çš„è§’è‰²ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYImageEncoder</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) YYImageType type; <span class="comment">///&lt; å›¾åƒç±»å‹</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">NSUInteger</span> loopCount;       <span class="comment">///&lt; å¾ªç¯æ¬¡æ•°ï¼Œ0 æ— é™å¾ªç¯ï¼Œä»…é€‚ç”¨äº GIF/APNG/WebP æ ¼å¼</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="type">BOOL</span> lossless;              <span class="comment">///&lt; æ— æŸæ ‡è®°ï¼Œä»…é€‚ç”¨äº WebP.</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span> quality;            <span class="comment">///&lt; å‹ç¼©è´¨é‡ï¼Œ0.0~1.0ï¼Œä»…é€‚ç”¨äº JPG/JP2/WebP.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¦æ­¢é€‚ç”¨ initã€new åˆå§‹åŒ–ç¼–ç å™¨ï¼ˆæˆ‘æ²¡å¿˜è®°æˆ‘è¯´è¿‡è¿™äº›ç¼–ç æŠ€å·§ä¼šåœ¨ä¹‹åç»Ÿä¸€å†™ä¸€ç¯‡æ–‡ç« æ±‡æ€»ï¼‰</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)init UNAVAILABLE_ATTRIBUTE;</span><br><span class="line">+ (<span class="keyword">instancetype</span>)new UNAVAILABLE_ATTRIBUTE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®ç»™å®šå›¾ç‰‡ç±»å‹åˆ›å»ºç¼–ç å™¨</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithType:(YYImageType)type <span class="built_in">NS_DESIGNATED_INITIALIZER</span>;</span><br><span class="line"><span class="comment">// æ·»åŠ å›¾åƒ</span></span><br><span class="line">- (<span class="type">void</span>)addImage:(<span class="built_in">UIImage</span> *)image duration:(<span class="built_in">NSTimeInterval</span>)duration;</span><br><span class="line"><span class="comment">// æ·»åŠ å›¾åƒæ•°æ®</span></span><br><span class="line">- (<span class="type">void</span>)addImageWithData:(<span class="built_in">NSData</span> *)data duration:(<span class="built_in">NSTimeInterval</span>)duration;</span><br><span class="line"><span class="comment">// æ·»åŠ æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">- (<span class="type">void</span>)addImageWithFile:(<span class="built_in">NSString</span> *)path duration:(<span class="built_in">NSTimeInterval</span>)duration;</span><br><span class="line"><span class="comment">// å¼€å§‹å›¾åƒç¼–ç å¹¶å°è¯•è¿”å›ç¼–ç åçš„æ•°æ®</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)encode;</span><br><span class="line"><span class="comment">// ç¼–ç å¹¶å°†å¾—åˆ°çš„æ•°æ®ä¿å­˜åˆ°ç»™å®šè·¯å¾„æ–‡ä»¶ä¸­</span></span><br><span class="line">- (<span class="type">BOOL</span>)encodeToFile:(<span class="built_in">NSString</span> *)path;</span><br><span class="line"><span class="comment">// ä¾¿æ·æ–¹æ³•ï¼Œå¯¹ä¸€ä¸ªå•å¸§å›¾åƒç¼–ç </span></span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)encodeImage:(<span class="built_in">UIImage</span> *)image type:(YYImageType)type quality:(<span class="built_in">CGFloat</span>)quality;</span><br><span class="line"><span class="comment">// ä¾¿æ·æ–¹æ³•ï¼Œä»è§£ç å™¨ä¸­ç¼–ç å›¾åƒæ•°æ®</span></span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)encodeImageWithDecoder:(YYImageDecoder *)decoder type:(YYImageType)type quality:(<span class="built_in">CGFloat</span>)quality;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ° YYImageEncoder å†…éƒ¨çš„ä¸€äº›å±æ€§å’Œæ¥å£éƒ½æ¯”è¾ƒåŸºæœ¬ï¼Œå…³äºå…¶å†…éƒ¨å®ç°æˆ‘ä»¬éœ€è¦å…ˆçœ‹ä¸€ä¸‹ç§æœ‰å˜é‡ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYImageEncoder</span> </span>&#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *_images; <span class="comment">// å·²æ·»åŠ åˆ°ç¼–ç å™¨çš„å›¾ç‰‡ï¼ˆæ•°ç»„ï¼‰</span></span><br><span class="line">    <span class="built_in">NSMutableArray</span> *_durations; <span class="comment">// å¯¹åº”çš„å›¾ç‰‡å¸§æ˜¾ç¤ºæŒç»­æ—¶é•¿ï¼ˆæ•°ç»„ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="YYImageEncoder-çš„å®ç°æ€è·¯"><a href="#YYImageEncoder-çš„å®ç°æ€è·¯" class="headerlink" title="YYImageEncoder çš„å®ç°æ€è·¯"></a>YYImageEncoder çš„å®ç°æ€è·¯</h4><p>YYImageEncoder çš„åˆå§‹åŒ–éƒ¨åˆ†æ²¡æœ‰å¤šå¤æ‚ï¼Œæ ¹æ®å›¾ç‰‡çš„ç±»å‹æŒ‰ç…§ç¼–ç æœ€ä¼˜çš„å‚æ•°åšåˆå§‹åŒ–è€Œå·²ã€‚å…³äº YYImageEncoder å¯¹äºå›¾ç‰‡çš„ç¼–ç å·¥ä½œï¼Œå…¶å®ä½œè€…æ ¹æ®è¦æ”¯æŒçš„å›¾ç‰‡ç±»å‹å’Œå¯¹åº”å›¾ç‰‡ç±»å‹çš„ç¼–ç æ–¹å¼åšäº†åº•å±‚å°è£…ï¼Œå†æ ¹æ®å½“å‰å›¾ç‰‡çš„ç±»å‹é€‰æ‹©å¯¹åº”çš„åº•å±‚ç¼–ç æ–¹æ³•æ‰§è¡Œã€‚</p>
<p>å…³äºä¸åŒå›¾ç‰‡ç±»å‹çš„å›¾ç‰‡ç¼–ç æ ¼å¼å¯ä»¥æŸ¥é˜…æœ¬æ–‡æ–‡æœ«çš„æ‰©å±•é˜…è¯»ç« èŠ‚ï¼Œç»“åˆæ‰©å±•é˜…è¯»çš„å†…å®¹æŸ¥é˜… YYImage è¿™éƒ¨åˆ†æºç å¯ä»¥ç†è§£ä½œè€…å¯¹äºåº•å±‚å›¾ç‰‡æ ¼å¼ä¿¡æ¯çš„ç»“æ„å°è£…ä»¥åŠç¼–/è§£ç æ“ä½œå…·ä½“å®ç°ã€‚</p>
<p>å…³äº YYImageEncoder çš„ä¸€äº›ç®€å•ä½¿ç”¨ç¤ºä¾‹å¯ä»¥æŸ¥çœ‹ <a target="_blank" rel="noopener" href="https://github.com/ibireme/YYImage/blob/master/YYImage/YYImageCoder.h#L216">YYImageCoder.h</a> äº†è§£ã€‚</p>
<h3 id="YYImageDecoder"><a href="#YYImageDecoder" class="headerlink" title="YYImageDecoder"></a>YYImageDecoder</h3><p>YYImageDecoder åœ¨ YYImageCoder ä¸­æ‹…ä»»è§£ç å™¨çš„è§’è‰²ï¼Œå…¶ä¸ä¸Šè¿° YYImageEncoder å¯¹åº”ï¼Œä¸€ä¸ªè´Ÿè´£å›¾åƒç¼–ç ä¸€ä¸ªè´Ÿè´£å›¾åƒè§£ç ï¼Œä¸è¿‡ YYImageDecoder çš„å®ç°æ¯” YYImageEncoder æ›´ä¸ºå¤æ‚ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYImageDecoder</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSData</span> *data;    <span class="comment">///&lt; å›¾åƒæ•°æ®</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) YYImageType type;          <span class="comment">///&lt; å›¾åƒæ•°æ®ç±»å‹</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">CGFloat</span> scale;             <span class="comment">///&lt; å›¾åƒå¤§å°</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> frameCount;     <span class="comment">///&lt; å›¾åƒå¸§æ•°é‡</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> loopCount;      <span class="comment">///&lt; å›¾åƒå¾ªç¯æ¬¡æ•°ï¼Œ0 æ— é™å¾ªç¯</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> width;          <span class="comment">///&lt; å›¾åƒç”»å¸ƒå®½åº¦</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> height;         <span class="comment">///&lt; å›¾åƒç”»å¸ƒé«˜åº¦</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>, <span class="keyword">getter</span>=isFinalized) <span class="type">BOOL</span> finalized;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªå›¾åƒè§£ç å™¨</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithScale:(<span class="built_in">CGFloat</span>)scale <span class="built_in">NS_DESIGNATED_INITIALIZER</span>;</span><br><span class="line"><span class="comment">// ç”¨æ–°æ•°æ®å¢é‡æ›´æ–°å›¾åƒ</span></span><br><span class="line">- (<span class="type">BOOL</span>)updateData:(<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)data final:(<span class="type">BOOL</span>)final;</span><br><span class="line"><span class="comment">// æ–¹ä¾¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„æ•°æ®åˆ›å»ºå¯¹åº”çš„è§£ç å™¨</span></span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)decoderWithData:(<span class="built_in">NSData</span> *)data scale:(<span class="built_in">CGFloat</span>)scale;</span><br><span class="line"><span class="comment">// è§£ç å¹¶è¿”å›ç»™å®šç´¢å¼•å¯¹åº”çš„å¸§æ•°æ®</span></span><br><span class="line">- (<span class="keyword">nullable</span> YYImageFrame *)frameAtIndex:(<span class="built_in">NSUInteger</span>)index decodeForDisplay:(<span class="type">BOOL</span>)decodeForDisplay;</span><br><span class="line"><span class="comment">// è¿”å›ç»™å®šç´¢å¼•å¯¹åº”çš„å¸§æŒç»­æ˜¾ç¤ºæ—¶é•¿</span></span><br><span class="line">- (<span class="built_in">NSTimeInterval</span>)frameDurationAtIndex:(<span class="built_in">NSUInteger</span>)index;</span><br><span class="line"><span class="comment">// è¿”å›ç»™å®šç´¢å¼•å¯¹åº”å¸§çš„å±æ€§ä¿¡æ¯ï¼Œå» ImageIO.framework çš„ &quot;CGImageProperties.h&quot; æ–‡ä»¶ä¸­äº†è§£æ›´å¤š</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span> *)framePropertiesAtIndex:(<span class="built_in">NSUInteger</span>)index;</span><br><span class="line"><span class="comment">// è¿”å›å›¾ç‰‡çš„å±æ€§ä¿¡æ¯ï¼Œå» ImageIO.framework çš„ &quot;CGImageProperties.h&quot; æ–‡ä»¶ä¸­äº†è§£æ›´å¤š</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span> *)imageProperties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ° YYImageDecoder æš´éœ²äº†ä¸€äº›å…³äºè§£ç å›¾åƒçš„å±æ€§å¹¶æä¾›äº†åˆå§‹åŒ–è§£ç å™¨æ–¹æ³•ã€å›¾åƒè§£ç æ–¹æ³•ä»¥åŠè®¿é—®å›¾åƒå¸§ä¿¡æ¯çš„æ–¹æ³•ã€‚ä¸è¿‡ä¸Šæ–‡ä¹Ÿè¯´è¿‡ YYImageDecoder çš„å®ç°æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬æ¥ç€çœ‹ä¸€ä¸‹å…¶å†…éƒ¨å˜é‡ç»“æ„ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYImageDecoder</span> </span>&#123;</span><br><span class="line">    pthread_mutex_t _lock; <span class="comment">// é€’å½’é”</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">BOOL</span> _sourceTypeDetected; <span class="comment">// æ˜¯å¦æ¨æµ‹å›¾åƒæºç±»å‹</span></span><br><span class="line">    <span class="built_in">CGImageSourceRef</span> _source; <span class="comment">// å›¾åƒæº</span></span><br><span class="line">    yy_png_info *_apngSource; <span class="comment">// å¦‚æœåˆ¤å®šå›¾åƒä¸º YYImageTypePNG åˆ™ä¼šä»¥ APNG æ›´æ–°å›¾åƒæº</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> YYIMAGE_WEBP_ENABLED</span></span><br><span class="line">    WebPDemuxer *_webpSource; <span class="comment">// å¦‚æœåˆ¤å®šå›¾åƒä¸º YYImageTypeWebP åˆ™ä¼šè®® WebP æ›´æ–°å›¾åƒæº</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIImageOrientation</span> _orientation; <span class="comment">// ç»˜åˆ¶æ–¹å‘</span></span><br><span class="line">    dispatch_semaphore_t _framesLock; <span class="comment">// é’ˆå¯¹äºå›¾åƒå¸§çš„é”</span></span><br><span class="line">    <span class="built_in">NSArray</span> *_frames; <span class="comment">///&lt; Array&lt;_YYImageDecoderFrame *&gt;, without image</span></span><br><span class="line">    <span class="type">BOOL</span> _needBlend; <span class="comment">// æ˜¯å¦éœ€è¦æ··åˆ</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> _blendFrameIndex; <span class="comment">// ä»å¸§ç´¢å¼•æ··åˆåˆ°å½“å‰å¸§</span></span><br><span class="line">    <span class="built_in">CGContextRef</span> _blendCanvas; <span class="comment">// æ··åˆç”»å¸ƒ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>_YYImageDecoderFrame</code> ç»§æ‰¿è‡ª YYImageFrame ç±»ä½œä¸º YYImageCoder å›¾åƒè§£ç å™¨ YYImageDecoder ä½¿ç”¨çš„å†…éƒ¨æ¡†æ¶ç±»å­˜åœ¨ï¼Œæ˜¯å¯¹äºä¸€å¸§å›¾åƒçš„æ•°æ®å°è£…æä¾›äº†ä¾¿äºç¼–/è§£ç æ—¶éœ€è¦è®¿é—®çš„æ•°æ®ã€‚</p>
<h4 id="YYImageDecoder-å†…é”çš„é€‰æ‹©"><a href="#YYImageDecoder-å†…é”çš„é€‰æ‹©" class="headerlink" title="YYImageDecoder å†…é”çš„é€‰æ‹©"></a>YYImageDecoder å†…é”çš„é€‰æ‹©</h4><p>å¯ä»¥çœ‹åˆ°ä½œè€…åœ¨ YYImageDecoder å†…éƒ¨ä½¿ç”¨äº†ä¸¤ç§é”ï¼š</p>
<ul>
<li><code>pthread_mutex_t _lock;</code></li>
<li><code>dispatch_semaphore_t _framesLock;</code></li>
</ul>
<p><code>pthread_mutex_t</code> åœ¨è§£ç å™¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­è¢«ä»¥ <code>PTHREAD_MUTEX_RECURSIVE</code> ç±»å‹è®¾ç½®ä¸ºäº†é€’å½’é”ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pthread_mutexattr_t attr;</span><br><span class="line">pthread_mutexattr_init (&amp;attr);</span><br><span class="line">pthread_mutexattr_settype (&amp;attr, PTHREAD_MUTEX_RECURSIVE);</span><br><span class="line">pthread_mutex_init (&amp;_lock, &amp;attr);</span><br><span class="line">pthread_mutexattr_destroy (&amp;attr);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: ä¸€èˆ¬æƒ…å†µä¸‹ä¸€ä¸ªçº¿ç¨‹åªèƒ½ç”³è¯·ä¸€æ¬¡é”ï¼Œä¹Ÿåªèƒ½åœ¨è·å¾—é”çš„æƒ…å†µä¸‹æ‰èƒ½é‡Šæ”¾é”ï¼Œå¤šæ¬¡ç”³è¯·é”æˆ–é‡Šæ”¾æœªè·å¾—çš„é”éƒ½ä¼šå¯¼è‡´å´©æºƒã€‚å‡è®¾åœ¨å·²ç»è·å¾—é”çš„æƒ…å†µä¸‹å†æ¬¡ç”³è¯·é”ï¼Œçº¿ç¨‹ä¼šå› ä¸ºç­‰å¾…é”çš„é‡Šæ”¾è€Œè¿›å…¥ç¡çœ çŠ¶æ€ï¼Œå› æ­¤å°±ä¸å¯èƒ½å†é‡Šæ”¾é”ï¼Œä»è€Œå¯¼è‡´æ­»é”ã€‚</p>
<p>ç„¶è€Œè¿™ç§æƒ…å†µç»å¸¸ä¼šå‘ç”Ÿï¼Œæ¯”å¦‚æŸä¸ªå‡½æ•°ç”³è¯·äº†é”ï¼Œåœ¨ä¸´ç•ŒåŒºå†…åˆé€’å½’è°ƒç”¨äº†è‡ªå·±ã€‚è¾›è¿çš„æ˜¯ <code>pthread_mutex</code> æ”¯æŒé€’å½’é”ï¼Œä¹Ÿå°±æ˜¯å…è®¸ä¸€ä¸ªçº¿ç¨‹é€’å½’çš„ç”³è¯·é”ï¼Œåªè¦æŠŠ attr çš„ç±»å‹æ”¹æˆ <code>PTHREAD_MUTEX_RECURSIVE</code> å³å¯ã€‚</p>
</blockquote>
<p>ä½œè€…ä½¿ç”¨ <code>dispatch_semaphore_t</code> ä½œä¸ºå›¾åƒå¸§æ•°ç»„çš„é”æ˜¯å› ä¸º <code>dispatch_semaphore_t</code> æ›´åŠ è½»é‡ä¸”å¯¹äºå›¾åƒå¸§æ•°ç»„çš„ä¸´ç•Œæ“ä½œæ¯”è¾ƒå¿«ï¼Œä¸ä¼šé€ æˆé•¿æ—¶é—´çš„é˜»å¡ï¼Œè¿™ç§æƒ…å†µä¸‹ <code>dispatch_semaphore_t</code> å…·æœ‰æ€§èƒ½ä¼˜åŠ¿ï¼ˆEmmmmmm..è€ç”Ÿå¸¸è°ˆäº†ï¼Œç†Ÿæ‚‰çš„åŒå­¦ä¸è¦æŠ±æ€¨ï¼Œç…§é¡¾ä¸€ä¸‹åé¢çš„åŒå­¦ï¼‰ã€‚</p>
<h4 id="YYImageDecoder-å†…çš„å®ç°æ€è·¯"><a href="#YYImageDecoder-å†…çš„å®ç°æ€è·¯" class="headerlink" title="YYImageDecoder å†…çš„å®ç°æ€è·¯"></a>YYImageDecoder å†…çš„å®ç°æ€è·¯</h4><p>YYImageDecoder å†…åœ¨åˆå§‹åŒ–æ—¶ä¼šåˆå§‹åŒ–é”å¹¶æ›´æ–°å›¾åƒæºæ•°æ®ï¼Œåœ¨æ›´æ–°å›¾åƒæºæ—¶è°ƒç”¨ <code>_updateSource</code> æ–¹æ³•æ ¹æ®å½“å‰å›¾åƒç±»å‹ä»¥ä½œè€…å¯¹è¯¥ç±»å‹å°è£…å¥½çš„åº•å±‚æ•°æ®ç»“æ„å’Œå¯¹åº”å›¾åƒç±»å‹è§£ç è§„åˆ™åšè§£ç ï¼Œè§£ç ä¹‹åè®¾ç½®å¯¹åº”å±æ€§ã€‚</p>
<p>å…³äºä½œè€…å¯¹ä¸åŒæ ¼å¼çš„å›¾åƒæ•°æ®çš„åº•å±‚å°è£…æºç æ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å‚è€ƒæœ¬æ–‡æ–‡æœ«çš„æ‰©å±•é˜…è¯»ç« èŠ‚å†…å®¹è‡ªè¡ŒæŸ¥é˜…ã€‚</p>
<p>å…³äº YYImageDecoder çš„ä¸€äº›ç®€å•ä½¿ç”¨ç¤ºä¾‹å¯ä»¥æŸ¥çœ‹ <a target="_blank" rel="noopener" href="https://github.com/ibireme/YYImage/blob/master/YYImage/YYImageCoder.h#L106">YYImageCoder.h</a> äº†è§£ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul>
<li>æ–‡ç« ç³»ç»Ÿçš„åˆ†æäº† YYImage æºç ï¼Œå¸Œæœ›å„ä½è¯»è€…åœ¨é˜…è¯»æœ¬æ–‡ä¹‹åå¯ä»¥å¯¹ YYImage æ•´ä½“æ¶æ„å’Œè®¾è®¡æ€è·¯æœ‰æ¸…æ™°çš„è®¤è¯†ã€‚</li>
<li>æ–‡ç« å¯¹ YYImage çš„ Image å±‚çº§çš„ä¸‰ç±»å›¾åƒï¼ˆYYImage, YYFrameImage, YYSpriteSheetImageï¼‰åˆ†åˆ«è§£è¯»ï¼Œå¸Œæœ›å¯ä»¥å¯¹å„ä½è¯»è€…å…³äºè¿™ä¸‰ç±»å›¾åƒçš„ç»„æˆåŸç†å’Œå‘ˆç°åŠ¨ç”»çš„æ–¹å¼çš„ç†è§£æœ‰æ‰€å¸®åŠ©ã€‚</li>
<li>æ–‡ç« æ·±å…¥å‰–æäº† YYAnimatedImageView çš„å†…éƒ¨å®ç°ï¼Œæç‚¼å‡ºå…¶è®¾è®¡æ€è·¯ä»¥ä¾›è¯»è€…æ¢ç©¶ã€‚</li>
<li>ç¬”è€…æŠŠè‡ªå·±åœ¨é˜…è¯»æºç ä¸­å‘ç°çš„å€¼å¾—åˆ†äº«çš„å®ç°ç»†èŠ‚ç»“åˆæºç å•ç‹¬æ‹å‡ºæ¥åˆ†æï¼Œå¸Œæœ›å„ä½è¯»è€…å¯ä»¥åœ¨è‡ªå·±å¹³æ—¶å·¥ä½œä¸­é‡åˆ°ç›¸ä¼¼æƒ…å†µæ—¶èƒ½å¤Ÿå¤šä¸€äº›æ€è·¯ï¼Œå°è£…é¡¹ç›®ç»„ä»¶æ—¶å¯ä»¥ç”¨åˆ°è¿™äº›æŠ€å·§ã€‚</li>
</ul>
<p>æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ <a href="https://lision.me/">https://lision.me/</a>ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ <a href="https://lision.me/">ä¸ªäººåšå®¢</a> ä¸­æ›´æ–°ã€‚èƒ½åŠ›ä¸è¶³ï¼Œæ°´å¹³æœ‰é™ï¼Œå¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš <a target="_blank" rel="noopener" href="https://weibo.com/lisioncode">@Lision</a> è”ç³»æˆ‘ï¼Œå¦å¤–æˆ‘çš„ <a target="_blank" rel="noopener" href="https://github.com/Lision">GitHub ä¸»é¡µ</a> é‡Œæœ‰å¾ˆå¤šæœ‰è¶£çš„å°ç©æ„å“¦~</p>
<p>æœ€åï¼Œå¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~</p>
<h2 id="æ‰©å±•é˜…è¯»"><a href="#æ‰©å±•é˜…è¯»" class="headerlink" title="æ‰©å±•é˜…è¯»"></a>æ‰©å±•é˜…è¯»</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.libpng.org/pub/png/spec/1.2/PNG-Structure.html">libpng å®˜ç½‘å…³äº PNG ç»“æ„çš„å®˜æ–¹è¯´æ˜</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.mozilla.org/APNG_Specification">APNG çš„ç»´åŸºç™¾ç§‘</a></li>
<li><a target="_blank" rel="noopener" href="https://developers.google.com/speed/webp/docs/api">WebP å¼€å‘è€…æ–‡æ¡£</a></li>
</ul>


    
    
    
	  <div class="tags">
      <a class="tag-none-link" href="/tags/yyimage/" rel="tag">yyimage</a><a class="tag-none-link" href="/tags/yykit/" rel="tag">yykit</a>
	  </div>
    

  </section>
</article>
  
</section>



      <script>setLoadingBarProgress(60);</script>
    </main>
    
    <footer id="footer" class="clearfix">
  
  
	<div class="search">
	  <script>
      (function() {
        var cx = '001858749347000340533:drswradlp64';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
	</div>
	

	<div class="social-wrapper">
  	
      
        <a href="mailto:lisionmail@gmail.com" class="social email"
          target="_blank" rel="external">
          <span class="icon icon-email"></span>
        </a>
      
        <a href="https://github.com/Lision" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="https://twitter.com/LisionChat" class="social twitter"
          target="_blank" rel="external">
          <span class="icon icon-twitter"></span>
        </a>
      
        <a href="https://weibo.com/lisioncode" class="social sina-weibo"
          target="_blank" rel="external">
          <span class="icon icon-sina-weibo"></span>
        </a>
      
    
  </div>
  
  <div>Theme <span class="codename">Typescript</span> designed by <a href="http://rakugaki.me/" target="_blank">Art Chen</a>.</div>
  <div>&copy; <a href="/">èŠå®…</a></div>
  
</footer>


    <script>setLoadingBarProgress(80);</script>
    
  </div>

  
<script>
  var disqus_shortname = 'lision-me';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>




<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>window.jQuery || document.write('<script src="/js/jquery.min.js"><\/script>')</script>


<script src="/js/jquery.fitvids.js"></script>

<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "AIzaSyAMIoydL742ROhE6lLk9n3hT0pZwbrXD_I";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "001858749347000340533:drswradlp64";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "google";
</script>

<script src="/js/search.js"></script>


<script src="/js/app.js"></script>



  <script>setLoadingBarProgress(100);</script>
  
</body>
</html>
