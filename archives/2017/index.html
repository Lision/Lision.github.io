<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>Archives: 2017 | èŠå®…</title>
  <meta name="description" content="ç¾éº—çš„å¤ªé™½ç…§å¸¸å‡èµ· è‹¦ç—›çš„äººå€‘ä¾èˆŠæ­‡æ–¯åº•è£" />
  <meta name="keywords" content="ios,objective-c,swift,python,javascript,otaku,lision" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="æ•²ä»£ç çš„ï¼Œæ¯”è¾ƒå®…çš„å†…ç§">
<meta property="og:type" content="website">
<meta property="og:title" content="èŠå®…">
<meta property="og:url" content="https://lision.me/archives/2017/index.html">
<meta property="og:site_name" content="èŠå®…">
<meta property="og:description" content="æ•²ä»£ç çš„ï¼Œæ¯”è¾ƒå®…çš„å†…ç§">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Lision">
<meta property="article:tag" content="ios,objective-c,swift,python,javascript,otaku,lision">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/favicon.png">
  

	<script src="https://use.typekit.net/eyf3hir.js"></script>
  <script>try{Typekit.load({ async: false });}catch(e){}</script>
  
<link rel="stylesheet" href="/style.css">

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
  
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=" + "UA-118743071-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-118743071-1');
</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>

  <script>setLoadingBarProgress(20)</script>
  
  <div id="site-wrapper">
    
    <header id="header">
	<div id="header-wrapper" class="clearfix">
		<a id="logo" href="/">
			<img src="/images/logo.png" />
			<span id="site-desc">
			  otaku's self-cultivation
      </span>
		</a>
		<button id="site-nav-switch">
	    <span class="icon icon-menu"></span>
	  </button>
	</div>
	<aside id="site-menu">
  	<nav>
  		
        <a href="/" class="nav-home nav">
          é¦–é¡µ
        </a>
      
        <a href="/archives" class="nav-archives nav">
          å½’æ¡£
        </a>
      
        <a target="_blank" rel="noopener" href="https://github.com/Lision" class="nav-about nav">
          å…³äº
        </a>
      
    </nav>
	</aside>
</header>
    <script>setLoadingBarProgress(40);</script>
    
    <main id="main" role="main">
      
	


	<section class="page-header archive">
    <h1>- <span>2017</span> -</h1>
  </section>




<section class="post-list">
	
    <article class="post ">

  
  <h2 class="title">
    <a href="/webview_javascript_bridge/">
      æ·±å…¥å‰–æ WebViewJavascriptBridge
    </a>
  </h2>
  
  <time>
    12æœˆ 23, 2017
  </time>
  <section class="content">
	  <img src="/webview_javascript_bridge/merry_ch.jpg" class="">
<p>Emmmmmâ€¦è¿™ç¯‡æ–‡ç« å‘å¸ƒå‡ºæ¥å¯èƒ½æ­£é€¢åœ£è¯èŠ‚ğŸ„ï¼ŒMerry Christmas!</p>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Web é¡µé¢ä¸­çš„ JS ä¸ iOS Native å¦‚ä½•äº¤äº’æ˜¯æ¯ä¸ª iOS çŒ¿å¿…é¡»æŒæ¡çš„æŠ€èƒ½ã€‚è€Œ JS å’Œ iOS Native å°±å¥½æ¯”ä¸¤å—æ²¡æœ‰äº¤é›†çš„å¤§é™†ï¼Œå¦‚æœæƒ³è¦ä½¿å®ƒä»¬ç›¸äº’é€šä¿¡å°±å¿…é¡»è¦å»ºç«‹ä¸€åº§â€œæ¡¥æ¢â€ã€‚</p>
<p><strong>æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœé¡¹ç›®ç»„è®©ä½ å»é€ è¿™åº§â€œæ¡¥â€ï¼Œå¦‚ä½•æ‰èƒ½åšåˆ°æ—¢ä¼˜é›…åˆå®ç”¨ï¼Ÿ</strong></p>
<p>æœ¬æ–‡å°†ç»“åˆ WebViewJavascriptBridge æºç é€æ­¥å¸¦å¤§å®¶æ‰¾åˆ°ç­”æ¡ˆã€‚</p>
<p><a target="_blank" rel="noopener" href="https://github.com/marcuswestin/WebViewJavascriptBridge">WebViewJavascriptBridge</a> æ˜¯ç››åå·²ä¹…çš„ JSBridge åº“ï¼Œæ—©åœ¨ 2011 å¹´å°±è¢«ä½œè€… <a target="_blank" rel="noopener" href="https://github.com/marcuswestin">Marcus Westin</a> å‘å¸ƒåˆ° GitHubï¼Œç›´åˆ°ç°åœ¨ä½œè€…è¿˜åœ¨ç§¯æç»´æŠ¤ä¸­ï¼Œç›®å‰è¯¥é¡¹ç›®å·²æ”¶è·è¿‘ 1w star å’¯ï¼Œå…¶æºç éå¸¸å€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚</p>
<p>WebViewJavascriptBridge çš„ä»£ç é€»è¾‘æ¸…æ™°ï¼Œé£æ ¼è‰¯å¥½ï¼ŒåŠ ä¸Šè‡ªèº«ä»£ç é‡æ¯”è¾ƒå°ä½¿å¾—å…¶æºç é˜…è¯»éå¸¸è½»æ¾ï¼ˆå¯èƒ½éœ€è¦ä¸€äº› JS åŸºç¡€ï¼‰ã€‚æ›´åŠ éš¾èƒ½å¯è´µçš„æ˜¯å®ƒä»…ä½¿ç”¨äº†å°‘é‡ä»£ç å°±å®ç°äº†å¯¹äº Mac OS X çš„ WebView ä»¥åŠ iOS å¹³å°çš„ UIWebView å’Œ WKWebView ä¸‰ç§ç»„ä»¶çš„å®Œç¾æ”¯æŒã€‚</p>
<p>æˆ‘å¯¹ WebViewJavascriptBridge çš„è¯„ä»·æ˜¯<strong>å°è€Œç¾</strong>ï¼Œè¿™ç±»å°è€Œç¾çš„æºç éå¸¸åˆ©äºæˆ‘ä»¬å¯¹å…¶å®ç°æ€æƒ³çš„å­¦ä¹ ï¼ˆæœ¬æ–‡åˆ†æ WebViewJavascriptBridge æºç ç‰ˆæœ¬ä¸º v6.0.3ï¼‰ã€‚</p>
<p>å…³äº iOS ä¸ JS çš„åŸç”Ÿäº¤äº’çŸ¥è¯†ï¼Œä¹‹å‰æˆ‘æœ‰å†™è¿‡ä¸€ç¯‡æ–‡ç« <a href="https://lision.me/ios-native-js/">ã€ŠiOS ä¸ JS äº¤äº’å¼€å‘çŸ¥è¯†æ€»ç»“ã€‹</a>ï¼Œæ–‡ç« é™¤äº†ä»‹ç» JavaScriptCore åº“ä»¥åŠ UIWebView å’Œ WKWebView ä¸ JS åŸç”Ÿäº¤äº’çš„æ–¹æ³•ä¹‹å¤–è¿˜æå¸¦æåˆ°äº† <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Hybrid">Hybrid</a> çš„å‘å±•ç®€å²ï¼Œæ–‡æœ«è¿˜æä¾›äº†ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://github.com/Lision/HybridCameraDemo">JS é€šè¿‡ Native è°ƒç”¨ iOS è®¾å¤‡æ‘„åƒå¤´çš„ Demo</a>ã€‚</p>
<p>æ‰€ä»¥è¿™ç¯‡æ–‡ç« ä¸ä¼šå†æŠŠé‡ç‚¹æ”¾åœ¨ iOS ä¸ JS çš„åŸç”Ÿäº¤äº’äº†ï¼Œæœ¬æ–‡æ—¨åœ¨ä»‹ç» <a target="_blank" rel="noopener" href="https://github.com/marcuswestin/WebViewJavascriptBridge">WebViewJavascriptBridge</a> çš„è®¾è®¡æ€è·¯å’Œå®ç°åŸç†ï¼Œå¯¹ iOS ä¸ JS åŸç”Ÿäº¤äº’çŸ¥è¯†æ„Ÿå…´è¶£çš„åŒå­¦æ¨èå»é˜…è¯»ä¸Šé¢æåˆ°çš„æ–‡ç« ï¼Œåº”è¯¥ä¼šæœ‰ç‚¹å„¿å¸®åŠ©ï¼ˆç¬‘ï¼‰ã€‚</p>
<h2 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h2><ul>
<li>WebViewJavascriptBridge ç®€ä»‹</li>
<li>WebViewJavascriptBridge &amp;&amp; WKWebViewJavascriptBridge æ¢ç©¶</li>
<li>WebViewJavascriptBridgeBase - JS è°ƒç”¨ Native å®ç°åŸç†å‰–æ</li>
<li>WebViewJavascriptBridge_JS - Native è°ƒç”¨ JS å®ç°è§£è¯»</li>
<li>WebViewJavascriptBridge çš„â€œæ¡¥æ¢ç¾å­¦â€</li>
<li>æ–‡ç« æ€»ç»“</li>
</ul>
<h2 id="WebViewJavascriptBridge-ç®€ä»‹"><a href="#WebViewJavascriptBridge-ç®€ä»‹" class="headerlink" title="WebViewJavascriptBridge ç®€ä»‹"></a>WebViewJavascriptBridge ç®€ä»‹</h2><img src="/webview_javascript_bridge/bridge.png" class="">
<p>WebViewJavascriptBridge æ˜¯ç”¨äºåœ¨ WKWebViewï¼ŒUIWebView å’Œ WebView ä¸­çš„ Obj-C å’Œ JavaScript ä¹‹é—´å‘é€æ¶ˆæ¯çš„ iOS / OSX æ¡¥æ¥å™¨ã€‚</p>
<p>æœ‰è®¸å¤šä¸é”™çš„é¡¹ç›®éƒ½æœ‰ä½¿ç”¨ WebViewJavascriptBridgeï¼Œè¿™é‡Œç®€å•åˆ—ä¸€éƒ¨åˆ†ï¼ˆç¬‘ï¼‰ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.messenger.com/">Facebook Messenger</a></li>
<li><a target="_blank" rel="noopener" href="https://www.facebook.com/paper">Facebook Paper</a></li>
<li><a target="_blank" rel="noopener" href="http://www.stayelsewhere.com/">ELSEWHERE</a></li>
<li>â€¦ &amp; many more!</li>
</ul>
<p>å…³äº WebViewJavascriptBridge çš„å…·ä½“ä½¿ç”¨æ–¹æ³•è¯¦è§å…¶ <a target="_blank" rel="noopener" href="https://github.com/marcuswestin/WebViewJavascriptBridge">GitHub é¡µé¢</a>ã€‚</p>
<p>åœ¨è¯»å®Œ WebViewJavascriptBridge çš„æºç ä¹‹åæˆ‘å°†å…¶åˆ’åˆ†ä¸ºä¸‰ä¸ªå±‚çº§ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">å±‚çº§</th>
<th style="text-align:center">æºæ–‡ä»¶</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">æ¥å£å±‚</td>
<td style="text-align:center">WebViewJavascriptBridge &amp;&amp; WKWebViewJavascriptBridge</td>
</tr>
<tr>
<td style="text-align:center">å®ç°å±‚</td>
<td style="text-align:center">WebViewJavascriptBridgeBase</td>
</tr>
<tr>
<td style="text-align:center">JS å±‚</td>
<td style="text-align:center">WebViewJavascriptBridge_JS</td>
</tr>
</tbody>
</table>
<p>å…¶ä¸­ WebViewJavascriptBridge &amp;&amp; WKWebViewJavascriptBridge ä½œä¸ºæ¥å£å±‚ä¸»è¦è´Ÿè´£æä¾›æ–¹ä¾¿çš„æ¥å£ï¼Œéšè—å®ç°ç»†èŠ‚ï¼Œå…¶å®ç°ç»†èŠ‚éƒ½æ˜¯é€šè¿‡å®ç°å±‚ WebViewJavascriptBridgeBase å»åšçš„ï¼Œè€Œ WebViewJavascriptBridge_JS ä½œä¸º JS å±‚å…¶å®å­˜å‚¨äº†ä¸€æ®µ JS ä»£ç ï¼Œåœ¨éœ€è¦çš„æ—¶å€™æ³¨å…¥åˆ°å½“å‰ WebView ç»„ä»¶ä¸­ï¼Œæœ€ç»ˆå®ç° Native ä¸ JS çš„äº¤äº’ã€‚</p>
<h2 id="WebViewJavascriptBridge-amp-amp-WKWebViewJavascriptBridge-æ¢ç©¶"><a href="#WebViewJavascriptBridge-amp-amp-WKWebViewJavascriptBridge-æ¢ç©¶" class="headerlink" title="WebViewJavascriptBridge &amp;&amp; WKWebViewJavascriptBridge æ¢ç©¶"></a>WebViewJavascriptBridge &amp;&amp; WKWebViewJavascriptBridge æ¢ç©¶</h2><img src="/webview_javascript_bridge/golden_bridge.jpeg" class="">
<p>WebViewJavascriptBridge å’Œ WKWebViewJavascriptBridge ä½œä¸ºæ¥å£å±‚åˆ†åˆ«å¯¹åº”äº UIWebView å’Œ WKWebView ç»„ä»¶ï¼Œæˆ‘ä»¬æ¥ç®€å•çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªæ–‡ä»¶æš´éœ²å‡ºçš„ä¿¡æ¯ï¼š</p>
<p>WebViewJavascriptBridge æš´éœ²ä¿¡æ¯ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WebViewJavascriptBridge</span> : <span class="title">WVJB_WEBVIEW_DELEGATE_INTERFACE</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)bridgeForWebView:(<span class="type">id</span>)webView; <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)bridge:(<span class="type">id</span>)webView; <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)enableLogging; <span class="comment">// å¼€å¯æ—¥å¿—</span></span><br><span class="line">+ (<span class="type">void</span>)setLogMaxLength:(<span class="type">int</span>)length; <span class="comment">// è®¾ç½®æ—¥å¿—æœ€å¤§é•¿åº¦</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)registerHandler:(<span class="built_in">NSString</span>*)handlerName handler:(WVJBHandler)handler; <span class="comment">// æ³¨å†Œ handler (Native)</span></span><br><span class="line">- (<span class="type">void</span>)removeHandler:(<span class="built_in">NSString</span>*)handlerName; <span class="comment">// åˆ é™¤ handler (Native)</span></span><br><span class="line">- (<span class="type">void</span>)callHandler:(<span class="built_in">NSString</span>*)handlerName data:(<span class="type">id</span>)data responseCallback:(WVJBResponseCallback)responseCallback; <span class="comment">// è°ƒç”¨ handler (JS)</span></span><br><span class="line">- (<span class="type">void</span>)setWebViewDelegate:(<span class="type">id</span>)webViewDelegate; <span class="comment">// è®¾ç½® webViewDelegate</span></span><br><span class="line">- (<span class="type">void</span>)disableJavscriptAlertBoxSafetyTimeout; <span class="comment">// ç¦ç”¨ JS AlertBox çš„å®‰å…¨æ—¶é•¿æ¥åŠ é€Ÿæ¶ˆæ¯ä¼ é€’ï¼Œä¸æ¨èä½¿ç”¨</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>WKWebViewJavascriptBridge æš´éœ²ä¿¡æ¯ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Emmmmm...è¿™é‡Œåº”è¯¥ä¸éœ€è¦æˆ‘æ³¨é‡Šäº†å§</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WKWebViewJavascriptBridge</span> : <span class="title">NSObject</span>&lt;<span class="title">WKNavigationDelegate</span>, <span class="title">WebViewJavascriptBridgeBaseDelegate</span>&gt;</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)bridgeForWebView:(<span class="built_in">WKWebView</span>*)webView;</span><br><span class="line">+ (<span class="type">void</span>)enableLogging;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)registerHandler:(<span class="built_in">NSString</span>*)handlerName handler:(WVJBHandler)handler;</span><br><span class="line">- (<span class="type">void</span>)removeHandler:(<span class="built_in">NSString</span>*)handlerName;</span><br><span class="line">- (<span class="type">void</span>)callHandler:(<span class="built_in">NSString</span>*)handlerName data:(<span class="type">id</span>)data responseCallback:(WVJBResponseCallback)responseCallback;</span><br><span class="line">- (<span class="type">void</span>)reset;</span><br><span class="line">- (<span class="type">void</span>)setWebViewDelegate:(<span class="type">id</span>)webViewDelegate;</span><br><span class="line">- (<span class="type">void</span>)disableJavscriptAlertBoxSafetyTimeout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: <code>disableJavscriptAlertBoxSafetyTimeout</code> æ–¹æ³•æ˜¯é€šè¿‡ç¦ç”¨ JS ç«¯ AlertBox çš„å®‰å…¨æ—¶é•¿æ¥åŠ é€Ÿç½‘æ¡¥æ¶ˆæ¯ä¼ é€’çš„ã€‚å¦‚æœæƒ³ä½¿ç”¨é‚£ä¹ˆéœ€è¦å’Œå‰ç«¯çº¦å®šå¥½ï¼Œå¦‚æœç¦ç”¨ä¹‹åå‰ç«¯ JS ä»£ç ä»æœ‰è°ƒç”¨ AlertBox ç›¸å…³ä»£ç ï¼ˆalert, confirm, æˆ– promptï¼‰åˆ™ç¨‹åºå°†è¢«æŒ‚èµ·ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•æ˜¯ä¸å®‰å…¨çš„ï¼Œå¦‚æ— ç‰¹æ®Šéœ€æ±‚ç¬”è€…ä¸æ¨èä½¿ç”¨ã€‚</p>
</blockquote>
<p>å¯ä»¥çœ‹å¾—å‡ºæ¥è¿™ä¸¤ä¸ªæ–‡ä»¶æš´éœ²å‡ºçš„æ¥å£å‡ ä¹ä¸€è‡´ï¼Œå…¶ä¸­ WebViewJavascriptBridge ä¸­ä½¿ç”¨äº†å®å®šä¹‰ <code>WVJB_WEBVIEW_DELEGATE_INTERFACE</code> æ¥åˆ†åˆ«é€‚é… iOS å’Œ Mac OS X å¹³å°çš„ UIWebView å’Œ WebView ç»„ä»¶éœ€è¦å®ç°çš„ä»£ç†æ–¹æ³•ã€‚</p>
<h3 id="WebViewJavascriptBridge-ä¸­çš„å®å®šä¹‰"><a href="#WebViewJavascriptBridge-ä¸­çš„å®å®šä¹‰" class="headerlink" title="WebViewJavascriptBridge ä¸­çš„å®å®šä¹‰"></a>WebViewJavascriptBridge ä¸­çš„å®å®šä¹‰</h3><p>å…¶å® WebViewJavascriptBridge ä¸­ä¸ºäº†é€‚é… iOS å’Œ Mac OS X å¹³å°çš„ UIWebView å’Œ WebView ç»„ä»¶ä½¿ç”¨äº†ä¸€ç³»åˆ—çš„å®å®šä¹‰ï¼Œå…¶æºç æ¯”è¾ƒç®€å•ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> defined __MAC_OS_X_VERSION_MAX_ALLOWED</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_PLATFORM_OSX</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_WEBVIEW_TYPE WebView</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_WEBVIEW_DELEGATE_TYPE NSObject<span class="string">&lt;WebViewJavascriptBridgeBaseDelegate&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_WEBVIEW_DELEGATE_INTERFACE NSObject<span class="string">&lt;WebViewJavascriptBridgeBaseDelegate, WebPolicyDelegate&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined __IPHONE_OS_VERSION_MAX_ALLOWED</span></span><br><span class="line">    <span class="meta">#import <span class="string">&lt;UIKit/UIWebView.h&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_PLATFORM_IOS</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_WEBVIEW_TYPE UIWebView</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_WEBVIEW_DELEGATE_TYPE NSObject<span class="string">&lt;UIWebViewDelegate&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_WEBVIEW_DELEGATE_INTERFACE NSObject<span class="string">&lt;UIWebViewDelegate, WebViewJavascriptBridgeBaseDelegate&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>åˆ†åˆ«æ ¹æ®æ‰€åœ¨å¹³å°ä¸åŒå®šä¹‰äº† <code>WVJB_WEBVIEW_TYPE</code>ï¼Œ<code>WVJB_WEBVIEW_DELEGATE_TYPE</code> ä»¥åŠåˆšæ‰æåˆ°çš„ <code>WVJB_WEBVIEW_DELEGATE_INTERFACE</code> å®å®šä¹‰ï¼Œå¹¶ä¸”åˆ†åˆ«å®šä¹‰äº† <code>WVJB_PLATFORM_OSX</code> å’Œ <code>WVJB_PLATFORM_IOS</code> ä¾¿äºä¹‹åçš„å®ç°æºç åŒºåˆ†å½“å‰å¹³å°æ—¶ä½¿ç”¨ï¼Œä¸‹é¢çš„ <code>supportsWKWebView</code> å®å®šä¹‰ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> (__MAC_OS_X_VERSION_MAX_ALLOWED &gt; __MAC_10_9 || __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= __IPHONE_7_1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> supportsWKWebView</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>åœ¨å¼•å…¥å¤´æ–‡ä»¶çš„æ—¶å€™å¯ä»¥é€šè¿‡è¿™ä¸ª <code>supportsWKWebView</code> å®çµæ´»å¼•å…¥æ‰€éœ€çš„å¤´æ–‡ä»¶ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebViewJavascriptBridge.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined supportsWKWebView</span></span><br><span class="line"><span class="meta">#import <span class="string">&lt;WebKit/WebKit.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// WebViewJavascriptBridge.m</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(supportsWKWebView)</span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;WKWebViewJavascriptBridge.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h3 id="WebViewJavascriptBridge-çš„å®ç°åˆ†æ"><a href="#WebViewJavascriptBridge-çš„å®ç°åˆ†æ" class="headerlink" title="WebViewJavascriptBridge çš„å®ç°åˆ†æ"></a>WebViewJavascriptBridge çš„å®ç°åˆ†æ</h3><p>æˆ‘ä»¬æ¥ç€çœ‹ä¸€ä¸‹ WebViewJavascriptBridge çš„å®ç°éƒ¨åˆ†ï¼Œé¦–å…ˆä»å†…éƒ¨å˜é‡ä¿¡æ¯çœ‹èµ·ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> __has_feature(objc_arc_weak)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_WEAK __weak</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> WVJB_WEAK __unsafe_unretained</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">WebViewJavascriptBridge</span> </span>&#123;</span><br><span class="line">    WVJB_WEAK WVJB_WEBVIEW_TYPE* _webView; <span class="comment">// bridge å¯¹åº”çš„ WebView ç»„ä»¶</span></span><br><span class="line">    WVJB_WEAK <span class="type">id</span> _webViewDelegate; <span class="comment">// ç»™ WebView ç»„ä»¶è®¾ç½®çš„ä»£ç†ï¼ˆéœ€è¦çš„è¯ï¼‰</span></span><br><span class="line">    <span class="type">long</span> _uniqueId; <span class="comment">// å”¯ä¸€æ ‡è¯†ï¼ŒEmmmmm...ä½†æ˜¯æˆ‘å‘ç°æ²¡åµç”¨ï¼Œåªæœ‰ _base ä¸­çš„ _uniqueId æ‰æœ‰ç”¨</span></span><br><span class="line">    WebViewJavascriptBridgeBase *_base; <span class="comment">// ä¸Šæ–‡è¯´è¿‡ï¼Œåº•å±‚å®ç°å…¶å®éƒ½æ˜¯ WebViewJavascriptBridgeBase åœ¨åš</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šæ–‡æåˆ° WebViewJavascriptBridge å’Œ WKWebViewJavascriptBridge çš„ .h æ–‡ä»¶æš´éœ²æ¥å£ä¿¡æ¯éå¸¸ç›¸ä¼¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦ä¸è¦çœ‹çœ‹ WKWebViewJavascriptBridge çš„å†…éƒ¨å˜é‡ä¿¡æ¯å‘¢ï¼Ÿ</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ³¨é‡Šå‚è§ WebViewJavascriptBridge å°±å¥½</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">WKWebViewJavascriptBridge</span> </span>&#123;</span><br><span class="line">    __<span class="keyword">weak</span> <span class="built_in">WKWebView</span>* _webView;</span><br><span class="line">    __<span class="keyword">weak</span> <span class="type">id</span>&lt;<span class="built_in">WKNavigationDelegate</span>&gt; _webViewDelegate;</span><br><span class="line">    <span class="type">long</span> _uniqueId;</span><br><span class="line">    WebViewJavascriptBridgeBase *_base;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å˜›~ è¿™ä¿©è´§ç®€ç›´æ˜¯ä¸€ä¸ªå¦ˆç”Ÿçš„ã€‚å…¶å®è¿™æ˜¯ä½œè€…æ•…æ„ä¸ºä¹‹ï¼Œå› ä¸ºä½œè€…æƒ³å¯¹å¤–æä¾›ä¸€å¥—æ¥å£ï¼Œå³ WebViewJavascriptBridgeï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ WebViewJavascriptBridge å°±å¯ä»¥è‡ªåŠ¨æ ¹æ®ç»‘å®šçš„ WebView ç»„ä»¶çš„ä¸åŒç”Ÿæˆä¸ä¹‹å¯¹åº”çš„ JSBridge å®ä¾‹ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)bridge:(<span class="type">id</span>)webView &#123;</span><br><span class="line"><span class="comment">// å¦‚æœæ”¯æŒ WKWebView</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined supportsWKWebView</span></span><br><span class="line">    <span class="comment">// éœ€è¦å…ˆåˆ¤æ–­å½“å‰å…¥å‚ webView æ˜¯å¦ä»å±äº WKWebView</span></span><br><span class="line">    <span class="keyword">if</span> ([webView isKindOfClass:[<span class="built_in">WKWebView</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="comment">// è¿”å› WKWebViewJavascriptBridge å®ä¾‹</span></span><br><span class="line">        <span class="keyword">return</span> (WebViewJavascriptBridge*) [<span class="built_in">WKWebViewJavascriptBridge</span> bridgeForWebView:webView];</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰å…¥å‚ webView æ˜¯å¦ä»å±äº WebViewï¼ˆMac OS Xï¼‰æˆ–è€… UIWebViewï¼ˆiOSï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> ([webView isKindOfClass:[WVJB_WEBVIEW_TYPE <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="comment">// è¿”å› WebViewJavascriptBridge å®ä¾‹</span></span><br><span class="line">        WebViewJavascriptBridge* bridge = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">        [bridge _platformSpecificSetup:webView];</span><br><span class="line">        <span class="keyword">return</span> bridge;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æŠ›å‡º BadWebViewType å¼‚å¸¸å¹¶è¿”å› nil</span></span><br><span class="line">    [<span class="built_in">NSException</span> raise:<span class="string">@&quot;BadWebViewType&quot;</span> format:<span class="string">@&quot;Unknown web view type.&quot;</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ä»£ç ï¼Œå®ç°å¹¶ä¸å¤æ‚ã€‚å¦‚æœæ”¯æŒ WKWebView çš„è¯ï¼ˆ<code>#if defined supportsWKWebView</code>ï¼‰åˆ™å»åˆ¤æ–­å½“å‰ç»‘å®šçš„ WebView ç»„ä»¶æ˜¯å¦ä»å±äº WKWebViewï¼Œè¿™æ ·å¯ä»¥è¿”å› WKWebViewJavascriptBridge å®ä¾‹ï¼Œå¦åˆ™è¿”å› WebViewJavascriptBridge å®ä¾‹ï¼Œæœ€åå¦‚æœå…¥å‚ <code>webView</code> çš„ç±»å‹ä¸æ»¡è¶³åˆ¤æ–­æ¡ä»¶åˆ™æŠ›å‡º <code>BadWebViewType</code> å¼‚å¸¸ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªå…³äº <code>_webViewDelegate</code> çš„å°ç»†èŠ‚ï¼Œæœ¬æ¥ä¸æ‰“ç®—è®²çš„ï¼Œä½†æ˜¯è¿˜æ˜¯æä¸€ä¸‹å§ï¼ˆå›§ï¼‰ã€‚å…¶å®åœ¨ WebViewJavascriptBridge ä»¥åŠ WKWebViewJavascriptBridge çš„åˆå§‹åŒ–å®ç°è¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠå½“å‰ WebView ç»„ä»¶çš„ä»£ç†ç»‘å®šä¸ºè‡ªå·±ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebViewJavascriptBridge</span></span><br><span class="line">- (<span class="type">void</span>) _platformSpecificSetup:(WVJB_WEBVIEW_TYPE*)webView &#123;</span><br><span class="line">    _webView = webView;</span><br><span class="line">    _webView.delegate = <span class="keyword">self</span>;</span><br><span class="line">    _base = [[WebViewJavascriptBridgeBase alloc] init];</span><br><span class="line">    _base.delegate = <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WKWebViewJavascriptBridge</span></span><br><span class="line">- (<span class="type">void</span>) _setupInstance:(<span class="built_in">WKWebView</span>*)webView &#123;</span><br><span class="line">    _webView = webView;</span><br><span class="line">    _webView.navigationDelegate = <span class="keyword">self</span>;</span><br><span class="line">    _base = [[WebViewJavascriptBridgeBase alloc] init];</span><br><span class="line">    _base.delegate = <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: æ›¿æ¢ç»„ä»¶çš„ä»£ç†å°†å…¶ä»£ç†ç»‘å®šä¸º bridge è‡ªå·±æ˜¯å› ä¸º WebViewJavascriptBridge çš„å®ç°åŸç†ä¸Šæ˜¯åˆ©ç”¨æˆ‘ä¹‹å‰çš„æ–‡ç« <a href="https://lision.me/ios-native-js/">ã€ŠiOS ä¸ JS äº¤äº’å¼€å‘çŸ¥è¯†æ€»ç»“ã€‹</a>ä¸­è®²è¿‡çš„å‡ Request æ–¹æ³•å®ç°çš„ï¼Œæ‰€ä»¥éœ€è¦ç›‘å¬ WebView ç»„ä»¶çš„ä»£ç†æ–¹æ³•è·å–åŠ è½½ä¹‹å‰çš„ Request.URL å¹¶åšå¤„ç†ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ WebViewJavascriptBridge æä¾›äº†ä¸€ä¸ªæ¥å£ <code>setWebViewDelegate:</code> å­˜å‚¨äº†ä¸€ä¸ªé€»è¾‘ä¸Šçš„ <code>_webViewDelegate</code>ï¼Œè¿™ä¸ª <code>_webViewDelegate</code> ä¹Ÿéœ€è¦éµå¾ª WebView ç»„ä»¶çš„ä»£ç†åè®®ï¼Œè¿™æ ·åœ¨ WebViewJavascriptBridge å†…éƒ¨ä¸åŒçš„ä»£ç†æ–¹æ³•ä¸­åšå®Œ bridge è¦åšçš„äº‹æƒ…åªæœ‰å°±ä¼šå†å»è°ƒç”¨ <code>_webViewDelegate</code> å¯¹åº”çš„ä»£ç†æ–¹æ³•ï¼Œå…¶å®å¯ä»¥ç†è§£ä¸º WebViewJavascriptBridge å¯¹å½“å‰ WebView ç»„ä»¶çš„ä»£ç†åšäº† hookã€‚</p>
</blockquote>
<p>å¯¹äº WebViewJavascriptBridge ä¸­æš´éœ²çš„åˆå§‹åŒ–ä»¥å¤–çš„æ‰€æœ‰æ¥å£ï¼Œå…¶å†…éƒ¨å®ç°éƒ½æ˜¯é€šè¿‡ WebViewJavascriptBridgeBase æ¥å®ç°çš„ã€‚è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯<strong>å³ä½¿ WebViewJavascriptBridge å› ä¸ºç»‘å®šäº† WKWebView è¿”å›äº† WKWebViewJavascriptBridge å®ä¾‹ï¼Œåªè¦æ¥å£ä¸€è‡´ï¼Œå¯¹ JSBridge å‘é€ç›¸åŒçš„æ¶ˆæ¯ï¼Œå°±ä¼šæœ‰ç›¸åŒçš„å®ç°ï¼ˆéƒ½æ˜¯ç”± WebViewJavascriptBridgeBase ç±»å®ç°çš„ï¼‰</strong>ã€‚</p>
<h2 id="WebViewJavascriptBridgeBase-JS-è°ƒç”¨-Native-å®ç°åŸç†å‰–æ"><a href="#WebViewJavascriptBridgeBase-JS-è°ƒç”¨-Native-å®ç°åŸç†å‰–æ" class="headerlink" title="WebViewJavascriptBridgeBase - JS è°ƒç”¨ Native å®ç°åŸç†å‰–æ"></a>WebViewJavascriptBridgeBase - JS è°ƒç”¨ Native å®ç°åŸç†å‰–æ</h2><img src="/webview_javascript_bridge/pier.jpg" class="">
<p>ä½œä¸º WebViewJavascriptBridge çš„å®ç°å±‚ï¼ŒWebViewJavascriptBridgeBase çš„å‘½åä¹Ÿå¯ä»¥ä½“ç°å‡ºå…¶æ˜¯ä½œä¸ºæ•´åº§â€œæ¡¥æ¢â€æ¡¥å¢©ä¸€èˆ¬çš„å­˜åœ¨ï¼Œæˆ‘ä»¬è¿˜æ˜¯æŒ‰ç…§è€è§„çŸ©å…ˆçœ‹ä¸€ä¸‹ WebViewJavascriptBridgeBase.h æš´éœ²çš„ä¿¡æ¯ï¼Œå¥½å¯¹å…¶æœ‰ä¸€ä¸ªæ•´ä½“çš„å°è±¡ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">void</span> (^WVJBResponseCallback)(<span class="type">id</span> responseData); <span class="comment">// å›è°ƒ block</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">void</span> (^WVJBHandler)(<span class="type">id</span> data, WVJBResponseCallback responseCallback); <span class="comment">// æ³¨å†Œçš„ Handler block</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NSDictionary</span> WVJBMessage; <span class="comment">// æ¶ˆæ¯ç±»å‹ - å­—å…¸</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">WebViewJavascriptBridgeBaseDelegate</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line">- (<span class="built_in">NSString</span>*) _evaluateJavascript:(<span class="built_in">NSString</span>*)javascriptCommand;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WebViewJavascriptBridgeBase</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="type">id</span> &lt;WebViewJavascriptBridgeBaseDelegate&gt; delegate; <span class="comment">// ä»£ç†ï¼ŒæŒ‡å‘æ¥å£å±‚ç±»ï¼Œç”¨ä»¥ç»™å¯¹åº”æ¥å£ç»‘å®šçš„ WebView ç»„ä»¶å‘é€æ‰§è¡Œ JS æ¶ˆæ¯</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSMutableArray</span>* startupMessageQueue; <span class="comment">// å¯åŠ¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯ä»¥ç†è§£ä¸ºå­˜æ”¾ WVJBMessage</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSMutableDictionary</span>* responseCallbacks; <span class="comment">// å›è°ƒ blocks å­—å…¸ï¼Œå­˜æ”¾ WVJBResponseCallback ç±»å‹çš„ block</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSMutableDictionary</span>* messageHandlers; <span class="comment">// å·²æ³¨å†Œçš„ handlers å­—å…¸ï¼Œå­˜æ”¾ WVJBHandler ç±»å‹çš„ block</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) WVJBHandler messageHandler; <span class="comment">// æ²¡åµç”¨</span></span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)enableLogging; <span class="comment">// å¼€å¯æ—¥å¿—</span></span><br><span class="line">+ (<span class="type">void</span>)setLogMaxLength:(<span class="type">int</span>)length; <span class="comment">// è®¾ç½®æ—¥å¿—æœ€å¤§é•¿åº¦</span></span><br><span class="line">- (<span class="type">void</span>)reset; <span class="comment">// å¯¹åº” WKJSBridge çš„ reset æ¥å£</span></span><br><span class="line">- (<span class="type">void</span>)sendData:(<span class="type">id</span>)data responseCallback:(WVJBResponseCallback)responseCallback handlerName:(<span class="built_in">NSString</span>*)handlerName; <span class="comment">// å‘é€æ¶ˆæ¯ï¼Œå…¥å‚ä¾æ¬¡æ˜¯å‚æ•°ï¼Œå›è°ƒ blockï¼Œå¯¹åº” JS ç«¯æ³¨å†Œçš„ HandlerName</span></span><br><span class="line">- (<span class="type">void</span>)flushMessageQueue:(<span class="built_in">NSString</span> *)messageQueueString; <span class="comment">// åˆ·æ–°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ ¸å¿ƒä»£ç </span></span><br><span class="line">- (<span class="type">void</span>)injectJavascriptFile; <span class="comment">// æ³¨å…¥ JS</span></span><br><span class="line">- (<span class="type">BOOL</span>)isWebViewJavascriptBridgeURL:(<span class="built_in">NSURL</span>*)url; <span class="comment">// åˆ¤å®šæ˜¯å¦ä¸º WebViewJavascriptBridgeURL</span></span><br><span class="line">- (<span class="type">BOOL</span>)isQueueMessageURL:(<span class="built_in">NSURL</span>*)urll; <span class="comment">// åˆ¤å®šæ˜¯å¦ä¸ºé˜Ÿåˆ—æ¶ˆæ¯ URL</span></span><br><span class="line">- (<span class="type">BOOL</span>)isBridgeLoadedURL:(<span class="built_in">NSURL</span>*)urll; <span class="comment">// åˆ¤å®šæ˜¯å¦ä¸º bridge è½½å…¥ URL</span></span><br><span class="line">- (<span class="type">void</span>)logUnkownMessage:(<span class="built_in">NSURL</span>*)url; <span class="comment">// æ‰“å°æ”¶åˆ°æœªçŸ¥æ¶ˆæ¯ä¿¡æ¯</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)webViewJavascriptCheckCommand; <span class="comment">// JS bridge æ£€æµ‹å‘½ä»¤</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)webViewJavascriptFetchQueyCommand; <span class="comment">// JS bridge è·å–æŸ¥è¯¢å‘½ä»¤</span></span><br><span class="line">- (<span class="type">void</span>)disableJavscriptAlertBoxSafetyTimeout; <span class="comment">// ç¦ç”¨ JS AlertBox å®‰å…¨æ—¶é•¿ä»¥è·å–å‘é€æ¶ˆæ¯é€Ÿåº¦æå‡ï¼Œä¸å»ºè®®ä½¿ç”¨ï¼Œç†ç”±è§ä¸Šæ–‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>å˜›~ ä» .h æ–‡ä»¶ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•´ä¸ª WebViewJavascriptBridgeBase æ‰€æš´éœ²å‡ºæ¥çš„ä¿¡æ¯ï¼Œå±æ€§å±‚é¢ä¸Šéœ€è¦å¯¹ä»¥ä¸‹ 4 ä¸ªå±æ€§åŠ æ·±å°è±¡ï¼Œä¹‹ååˆ†æå®ç°çš„è¿‡ç¨‹ä¸­ä¼šå¸¦å…¥è¿™äº›å±æ€§ï¼š</p>
<ul>
<li><code>id &lt;WebViewJavascriptBridgeBaseDelegate&gt; delegate</code> ä»£ç†ï¼Œå¯ä»¥é€šè¿‡ä»£ç†è®©å½“å‰ bridge ç»‘å®šçš„ WebView ç»„ä»¶æ‰§è¡Œ JS ä»£ç </li>
<li><code>NSMutableArray* startupMessageQueue;</code> å¯åŠ¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå­˜æ”¾ Obj-C å‘é€ç»™ JS çš„æ¶ˆæ¯ï¼ˆå¯ä»¥ç†è§£ä¸ºå­˜æ”¾ <code>WVJBMessage</code> ç±»å‹ï¼‰</li>
<li><code>NSMutableDictionary* responseCallbacks;</code> å›è°ƒ blocks å­—å…¸ï¼Œå­˜æ”¾ <code>WVJBResponseCallback</code> ç±»å‹çš„ block</li>
<li><code>NSMutableDictionary* messageHandlers;</code> Obj-C ç«¯å·²æ³¨å†Œçš„ handlers å­—å…¸ï¼Œå­˜æ”¾ <code>WVJBHandler</code> ç±»å‹çš„ block</li>
</ul>
<p>Emmmmmâ€¦æ¥å£å±‚é¢çœ‹ä¸€ä¸‹æ³¨é‡Šå°±å¥½äº†ï¼Œåé¢åˆ†æå®ç°çš„æ—¶å€™ä¼šæå¸¦è®²è§£ä¸€äº›æ¥å£ï¼Œå‰©ä¸‹ä¸€äº›è·Ÿå®ç°æ— å…³çš„æ¥å£å†…å®¹æ„Ÿå…´è¶£çš„åŒå­¦æ¨èè‡ªå·±æ‰’æºç å“ˆã€‚</p>
<p>æˆ‘ä»¬åœ¨å¯¹ WebViewJavascriptBridgeBase æ•´ä½“æœ‰äº†ä¸€ä¸ªåˆå§‹å°è±¡ä¹‹åå°±å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªé¡µé¢ï¼Œç®€å•çš„åµŒå…¥ä¸€äº› JS è·‘ä¸€éæµç¨‹ï¼Œåœ¨ä¸­é—´ä¸‹æ–­ç‚¹æ‰’æºç ï¼Œè¿™æ ·æˆ‘ä»¬å¯¹äº Native ä¸ JS çš„äº¤äº’æµç¨‹å°±å¯ä»¥ä¸€æ¸…äºŒæ¥šäº†ã€‚</p>
<p><strong>ä¸‹é¢æ¨¡æ‹Ÿä¸€é JS é€šè¿‡ WebViewJavascriptBridge è°ƒç”¨ Native åŠŸèƒ½çš„æµç¨‹åˆ†æ WebViewJavascriptBridgeBase çš„ç›¸å…³å®ç°</strong>ï¼ˆè€ƒè™‘ç°åœ¨çš„æ—¶é—´ç‚¹å†³å®šä»¥ WKWebView ä¸ºä¾‹è®²è§£ï¼Œå³é’ˆå¯¹ WKWebViewJavascriptBridge æºç è®²è§£ï¼‰ï¼š</p>
<h3 id="1-ç›‘å¬å‡-Request-å¹¶æ³¨å…¥-WebViewJavascriptBridge-JS-å†…çš„-JS-ä»£ç "><a href="#1-ç›‘å¬å‡-Request-å¹¶æ³¨å…¥-WebViewJavascriptBridge-JS-å†…çš„-JS-ä»£ç " class="headerlink" title="1.ç›‘å¬å‡ Request å¹¶æ³¨å…¥ WebViewJavascriptBridge_JS å†…çš„ JS ä»£ç "></a>1.ç›‘å¬å‡ Request å¹¶æ³¨å…¥ WebViewJavascriptBridge_JS å†…çš„ JS ä»£ç </h3><p>ä¸Šæ–‡è¯´åˆ° WebViewJavascriptBridge çš„å®ç°å…¶å®æœ¬è´¨ä¸Šæ˜¯åˆ©ç”¨äº†æˆ‘ä¹‹å‰çš„æ–‡ç« <a href="https://lision.me/ios-native-js/">ã€ŠiOS ä¸ JS äº¤äº’å¼€å‘çŸ¥è¯†æ€»ç»“ã€‹</a>ä¸­è®²è¿‡çš„å‡ Request æ–¹æ³•å®ç°çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä»ç›‘å¬å‡ Request å¼€å§‹è®²èµ·å§ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WKNavigationDelegate åè®®æ–¹æ³•ï¼Œç”¨äºç›‘å¬ Request å¹¶å†³å®šæ˜¯å¦å…è®¸å¯¼èˆª</span></span><br><span class="line">- (<span class="type">void</span>)webView:(<span class="built_in">WKWebView</span> *)webView decidePolicyForNavigationAction:(<span class="built_in">WKNavigationAction</span> *)navigationAction decisionHandler:(<span class="type">void</span> (^)(<span class="built_in">WKNavigationActionPolicy</span>))decisionHandler &#123;</span><br><span class="line">    <span class="comment">// webView æ ¡éªŒ</span></span><br><span class="line">    <span class="keyword">if</span> (webView != _webView) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">    <span class="built_in">NSURL</span> *url = navigationAction.request.URL;</span><br><span class="line">    __<span class="keyword">strong</span> <span class="keyword">typeof</span>(_webViewDelegate) strongDelegate = _webViewDelegate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¸å¿ƒä»£ç </span></span><br><span class="line">    <span class="keyword">if</span> ([_base isWebViewJavascriptBridgeURL:url]) &#123; <span class="comment">// åˆ¤å®š WebViewJavascriptBridgeURL</span></span><br><span class="line">        <span class="keyword">if</span> ([_base isBridgeLoadedURL:url]) &#123; <span class="comment">// åˆ¤å®š BridgeLoadedURL</span></span><br><span class="line">            <span class="comment">// æ³¨å…¥ JS ä»£ç </span></span><br><span class="line">            [_base injectJavascriptFile];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([_base isQueueMessageURL:url]) &#123; <span class="comment">// åˆ¤å®š QueueMessageURL</span></span><br><span class="line">            <span class="comment">// åˆ·æ–°æ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">            [<span class="keyword">self</span> <span class="built_in">WKFlushMessageQueue</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è®°å½•æœªçŸ¥ bridge msg æ—¥å¿—</span></span><br><span class="line">            [_base logUnkownMessage:url];</span><br><span class="line">        &#125;</span><br><span class="line">        decisionHandler(<span class="built_in">WKNavigationActionPolicyCancel</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è°ƒç”¨ _webViewDelegate å¯¹åº”çš„ä»£ç†æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (strongDelegate &amp;&amp; [strongDelegate respondsToSelector:<span class="keyword">@selector</span>(webView:decidePolicyForNavigationAction:decisionHandler:)]) &#123;</span><br><span class="line">        [_webViewDelegate webView:webView decidePolicyForNavigationAction:navigationAction decisionHandler:decisionHandler];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        decisionHandler(<span class="built_in">WKNavigationActionPolicyAllow</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: ä¹‹å‰è¯´è¿‡ WebViewJavascriptBridge ä¼š hook ç»‘å®šçš„ WebView çš„ä»£ç†æ–¹æ³•ï¼Œè¿™ä¸€ç‚¹ WKWebViewJavascriptBridge ä¹Ÿä¸€æ ·ï¼Œåœ¨åŠ å…¥è‡ªå·±çš„ä»£ç ä¹‹åä¼šåˆ¤æ–­æ˜¯å¦æœ‰ <code>_webViewDelegate</code> å“åº”è¿™ä¸ªä»£ç†æ–¹æ³•ï¼Œå¦‚æœæœ‰åˆ™è°ƒç”¨ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬è¿˜æ˜¯æŠŠæ³¨æ„åŠ›æ”¾åˆ°æ³¨é‡Šä¸­æ ¸å¿ƒä»£ç çš„ä½ç½®ï¼Œé‡Œé¢ä¼šå…ˆåˆ¤æ–­å½“å‰ url æ˜¯å¦ä¸º bridge urlï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç›¸å…³å®å®šä¹‰</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> kOldProtocolScheme @<span class="string">&quot;wvjbscheme&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> kNewProtocolScheme @<span class="string">&quot;https&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> kQueueHasMessage   @<span class="string">&quot;__wvjb_queue_message__&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> kBridgeLoaded      @<span class="string">&quot;__bridge_loaded__&quot;</span></span></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/marcuswestin/WebViewJavascriptBridge">WebViewJavascriptBridge GitHub é¡µé¢</a> çš„ä½¿ç”¨æ–¹æ³•ä¸­ç¬¬ 4 æ­¥æ˜ç¡®æŒ‡å‡ºè¦å¤åˆ¶ç²˜è´´ <code>setupWebViewJavascriptBridge</code> æ–¹æ³•åˆ°å‰æ®µ JS ä¸­ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹è¿™æ®µ JS æ–¹æ³•æºç ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupWebViewJavascriptBridge</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">WebViewJavascriptBridge</span>) &#123; <span class="keyword">return</span> <span class="title function_">callback</span>(<span class="title class_">WebViewJavascriptBridge</span>); &#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">WVJBCallbacks</span>) &#123; <span class="keyword">return</span> <span class="variable language_">window</span>.<span class="property">WVJBCallbacks</span>.<span class="title function_">push</span>(callback); &#125;</span><br><span class="line">	<span class="variable language_">window</span>.<span class="property">WVJBCallbacks</span> = [callback];</span><br><span class="line">	<span class="comment">// åˆ›å»ºä¸€ä¸ª iframe</span></span><br><span class="line">	<span class="keyword">var</span> <span class="title class_">WVJBIframe</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;iframe&#x27;</span>);</span><br><span class="line">	<span class="comment">// è®¾ç½® iframe ä¸ºä¸æ˜¾ç¤º</span></span><br><span class="line">	<span class="title class_">WVJBIframe</span>.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">	<span class="comment">// å°† iframe çš„ src ç½®ä¸º &#x27;https://__bridge_loaded__&#x27;</span></span><br><span class="line">	<span class="title class_">WVJBIframe</span>.<span class="property">src</span> = <span class="string">&#x27;https://__bridge_loaded__&#x27;</span>;</span><br><span class="line">	<span class="comment">// å°† iframe åŠ å…¥åˆ° document.documentElement</span></span><br><span class="line">	<span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="title function_">appendChild</span>(<span class="title class_">WVJBIframe</span>);</span><br><span class="line">	<span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="title function_">removeChild</span>(<span class="title class_">WVJBIframe</span>) &#125;, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ªä¸æ˜¾ç¤ºçš„ iframe å¹¶å°†å…¶ src ç½®ä¸º <code>https://__bridge_loaded__</code>ï¼Œä¸ä¸Šæ–‡ä¸­ <code>kBridgeLoaded</code> å®å®šä¹‰ä¸€è‡´ï¼Œå³ç”¨äº <code>isBridgeLoadedURL:</code> æ–¹æ³•ä¸­åˆ¤å®šå½“å‰ url æ˜¯å¦ä¸º BridgeLoadedURLã€‚</p>
<blockquote>
<p>Note: å‡ Request çš„å‘èµ·æœ‰ä¸¤ç§æ–¹å¼ï¼Œ-1:<code>location.href</code> -2:<code>iframe</code>ã€‚é€šè¿‡ <code>location.href</code> æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚æœ JS å¤šæ¬¡è°ƒç”¨åŸç”Ÿçš„æ–¹æ³•ä¹Ÿå°±æ˜¯ <code>location.href</code> çš„å€¼å¤šæ¬¡å˜åŒ–ï¼ŒNative ç«¯åªèƒ½æ¥å—åˆ°æœ€åä¸€æ¬¡è¯·æ±‚ï¼Œå‰é¢çš„è¯·æ±‚ä¼šè¢«å¿½ç•¥æ‰ï¼Œæ‰€ä»¥è¿™é‡Œ WebViewJavascriptBridge é€‰æ‹©ä½¿ç”¨ iframeï¼Œåé¢ä¸å†è§£é‡Šã€‚</p>
</blockquote>
<p>å› ä¸ºåŠ å…¥äº† src ä¸º <code>https://__bridge_loaded__</code> çš„ iframe å…ƒç´ ï¼Œæˆ‘ä»¬ä¸Šé¢æˆªè· url çš„ä»£ç†æ–¹æ³•å°±ä¼šæ‹¿åˆ°ä¸€ä¸ª <code>https://__bridge_loaded__</code> çš„ urlï¼Œç”±äº https æ»¡è¶³åˆ¤å®š WebViewJavascriptBridgeURLï¼Œå°†ä¼šè¿›å…¥æ ¸å¿ƒä»£ç åŒºåŸŸæ¥ç€ä¼šè¢«åˆ¤å®šä¸º BridgeLoadedURL æ‰§è¡Œæ³¨å…¥ JS ä»£ç çš„æ–¹æ³•ï¼Œå³ <code>[_base injectJavascriptFile];</code>ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)injectJavascriptFile &#123;</span><br><span class="line">    <span class="comment">// è·å–åˆ° WebViewJavascriptBridge_JS çš„ä»£ç </span></span><br><span class="line">    <span class="built_in">NSString</span> *js = WebViewJavascriptBridge_js();</span><br><span class="line">    <span class="comment">// å°†è·å–åˆ°çš„ js é€šè¿‡ä»£ç†æ–¹æ³•æ³¨å…¥åˆ°å½“å‰ç»‘å®šçš„ WebView ç»„ä»¶</span></span><br><span class="line">    [<span class="keyword">self</span> _evaluateJavascript:js];</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰å·²æœ‰æ¶ˆæ¯é˜Ÿåˆ—åˆ™éå†å¹¶åˆ†å‘æ¶ˆæ¯ï¼Œä¹‹åæ¸…ç©ºæ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.startupMessageQueue) &#123;</span><br><span class="line">        <span class="built_in">NSArray</span>* queue = <span class="keyword">self</span>.startupMessageQueue;</span><br><span class="line">        <span class="keyword">self</span>.startupMessageQueue = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">id</span> queuedMessage <span class="keyword">in</span> queue) &#123;</span><br><span class="line">            [<span class="keyword">self</span> _dispatchMessage:queuedMessage];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œç¬¬ä¸€æ­¥äº¤äº’å·²å®Œæˆã€‚å…³äº WebViewJavascriptBridge_JS å†…éƒ¨çš„ JS ä»£ç æˆ‘ä»¬æ”¾åˆ°åé¢çš„ç« èŠ‚è§£è¯»ï¼Œç°åœ¨å¯ä»¥ç®€å•ç†è§£ä¸º WebViewJavascriptBridge åœ¨ JS ç«¯çš„å…·ä½“å®ç°ä»£ç ã€‚</p>
<h3 id="2-JS-ç«¯è°ƒç”¨-callHandler-æ–¹æ³•ä¹‹å-Native-ç«¯ç©¶ç«Ÿæ˜¯å¦‚ä½•å“åº”çš„ï¼Ÿ"><a href="#2-JS-ç«¯è°ƒç”¨-callHandler-æ–¹æ³•ä¹‹å-Native-ç«¯ç©¶ç«Ÿæ˜¯å¦‚ä½•å“åº”çš„ï¼Ÿ" class="headerlink" title="2.JS ç«¯è°ƒç”¨ callHandler æ–¹æ³•ä¹‹å Native ç«¯ç©¶ç«Ÿæ˜¯å¦‚ä½•å“åº”çš„ï¼Ÿ"></a>2.JS ç«¯è°ƒç”¨ <code>callHandler</code> æ–¹æ³•ä¹‹å Native ç«¯ç©¶ç«Ÿæ˜¯å¦‚ä½•å“åº”çš„ï¼Ÿ</h3><p><a target="_blank" rel="noopener" href="https://github.com/marcuswestin/WebViewJavascriptBridge">WebViewJavascriptBridge GitHub é¡µé¢</a> ä¸­æŒ‡å‡º JS ç«¯çš„æ“ä½œæ–¹å¼ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setupWebViewJavascriptBridge</span>(<span class="keyword">function</span>(<span class="params">bridge</span>) &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* Initialize your app here */</span></span><br><span class="line"></span><br><span class="line">	bridge.<span class="title function_">registerHandler</span>(<span class="string">&#x27;JS Echo&#x27;</span>, <span class="keyword">function</span>(<span class="params">data, responseCallback</span>) &#123;</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;JS Echo called with:&quot;</span>, data)</span><br><span class="line">		<span class="title function_">responseCallback</span>(data)</span><br><span class="line">	&#125;)</span><br><span class="line">	bridge.<span class="title function_">callHandler</span>(<span class="string">&#x27;ObjC Echo&#x27;</span>, &#123;<span class="string">&#x27;key&#x27;</span>:<span class="string">&#x27;value&#x27;</span>&#125;, <span class="keyword">function</span> <span class="title function_">responseCallback</span>(<span class="params">responseData</span>) &#123;</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;JS received response:&quot;</span>, responseData)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çŸ¥é“ JS ç«¯è°ƒç”¨ <code>setupWebViewJavascriptBridge</code> æ–¹æ³•ä¼šèµ°æˆ‘ä»¬åˆšæ‰åˆ†æè¿‡çš„ç¬¬ä¸€æ­¥ï¼Œå³ç›‘å¬å‡ Request å¹¶æ³¨å…¥ WebViewJavascriptBridge_JS å†…çš„ JS ä»£ç ã€‚é‚£ä¹ˆå½“ JS ç«¯è°ƒç”¨ <code>bridge.callHandler</code> æ—¶ï¼ŒNative ç«¯ç©¶ç«Ÿæ˜¯å¦‚ä½•åšå‡ºå“åº”çš„å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬éœ€è¦å…ˆç¨å¾®è§£è¯»ä¸€ä¸‹ä¹‹å‰æ³¨å…¥çš„ WebViewJavascriptBridge_JS ä¸­çš„ JS ä»£ç ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨ iOS handlerï¼Œå‚æ•°æ ¡éªŒä¹‹åè°ƒç”¨ _doSend å‡½æ•°</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">callHandler</span>(<span class="params">handlerName, data, responseCallback</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable language_">arguments</span>.<span class="property">length</span> == <span class="number">2</span> &amp;&amp; <span class="keyword">typeof</span> data == <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">		responseCallback = data;</span><br><span class="line">		data = <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="title function_">_doSend</span>(&#123; <span class="attr">handlerName</span>:handlerName, <span class="attr">data</span>:data &#125;, responseCallback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœ‰å›è°ƒï¼Œåˆ™è®¾ç½® message[&#x27;callbackId&#x27;] ä¸ responseCallbacks[callbackId]</span></span><br><span class="line"><span class="comment">// å°† msg åŠ å…¥ sendMessageQueue æ•°ç»„ï¼Œè®¾ç½® messagingIframe.src</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_doSend</span>(<span class="params">message, responseCallback</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> (responseCallback) &#123;</span><br><span class="line">		<span class="keyword">var</span> callbackId = <span class="string">&#x27;cb_&#x27;</span>+(uniqueId++)+<span class="string">&#x27;_&#x27;</span>+<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line">		responseCallbacks[callbackId] = responseCallback;</span><br><span class="line">		message[<span class="string">&#x27;callbackId&#x27;</span>] = callbackId;</span><br><span class="line">	&#125;</span><br><span class="line">	sendMessageQueue.<span class="title function_">push</span>(message);</span><br><span class="line">	messagingIframe.<span class="property">src</span> = <span class="variable constant_">CUSTOM_PROTOCOL_SCHEME</span> + <span class="string">&#x27;://&#x27;</span> + <span class="variable constant_">QUEUE_HAS_MESSAGE</span>;</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line"><span class="comment">// scheme ä½¿ç”¨ https ä¹‹åé€šè¿‡ host åšåŒ¹é…</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">CUSTOM_PROTOCOL_SCHEME</span> = <span class="string">&#x27;https&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">QUEUE_HAS_MESSAGE</span> = <span class="string">&#x27;__wvjb_queue_message__&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ° JS ç«¯çš„ä»£ç ä¸­æœ‰ <code>callHandler</code> å‡½æ•°çš„å®ç°ï¼Œå…¶å†…éƒ¨å°†å…¥å‚ <code>handlerName</code> ä»¥åŠ <code>data</code> ä»¥å­—å…¸å½¢å¼ä½œä¸ºå‚æ•°è°ƒç”¨ <code>_doSend</code> æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>_doSend</code> æ–¹æ³•çš„å®ç°ï¼š</p>
<ul>
<li><code>_doSend</code> æ–¹æ³•å†…éƒ¨ä¼šå…ˆåˆ¤æ–­å…¥å‚ä¸­æ˜¯å¦æœ‰å›è°ƒ</li>
<li>å¦‚æœæœ‰å›è°ƒåˆ™æ ¹æ®è§„åˆ™ç”Ÿæˆ <code>callbackId</code> å¹¶ä¸”å°†å›è°ƒ block ä¿å­˜åˆ° <code>responseCallbacks</code> å­—å…¸ï¼ˆå›§~ JS ä¸å«å­—å…¸çš„ï¼Œæˆ‘æ˜¯ä¸ºäº† iOS è¯»è€…çœ‹ç€æ–¹ä¾¿ï¼‰ï¼Œä¹‹åç»™æ¶ˆæ¯ä¹ŸåŠ å…¥ä¸€ä¸ªé”®å€¼å¯¹ä¿å­˜åˆšæ‰ç”Ÿæˆçš„ <code>callbackId</code></li>
<li>ä¹‹åç»™ <code>sendMessageQueue</code> é˜Ÿåˆ—åŠ å…¥ <code>message</code></li>
<li>å°† <code>messagingIframe.src</code> è®¾ç½®ä¸º <code>https://__wvjb_queue_message__</code></li>
</ul>
<p>å¥½ï¼Œç‚¹åˆ°ä¸ºæ­¢ï¼Œå¯¹äº WebViewJavascriptBridge_JS å†…çš„ JS ç«¯å…¶ä»–æºç æˆ‘ä»¬æ”¾ç€åé¢çœ‹ã€‚æ³¨æ„è¿™é‡ŒåŠ å…¥äº†ä¸€ä¸ª src ä¸º <code>https://__wvjb_queue_message__</code> çš„ <code>messagingIframe</code>ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªä¸å¯è§çš„ iframeã€‚è¿™æ · Native ç«¯ä¼šæ”¶åˆ°ä¸€ä¸ª url ä¸º <code>https://__wvjb_queue_message__</code> çš„ requestï¼Œå›åˆ°ç¬¬ 1 æ­¥ä¸­è·å–åˆ°å‡çš„ request ä¹‹åä¼šè¿›è¡Œå„é¡¹åˆ¤å®šï¼Œè¿™æ¬¡ä¼šæ»¡è¶³ <code>[_base isQueueMessageURL:url]</code> çš„åˆ¤å®šè°ƒç”¨ Native çš„ <code>WKFlushMessageQueue</code> æ–¹æ³•ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)<span class="built_in">WKFlushMessageQueue</span> &#123;</span><br><span class="line">    <span class="comment">// æ‰§è¡Œ WebViewJavascriptBridge._fetchQueue(); æ–¹æ³•</span></span><br><span class="line">    [_webView evaluateJavaScript:[_base webViewJavascriptFetchQueyCommand] completionHandler:^(<span class="built_in">NSString</span>* result, <span class="built_in">NSError</span>* error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error != <span class="literal">nil</span>) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;WebViewJavascriptBridge: WARNING: Error when trying to fetch data from WKWebView: %@&quot;</span>, error);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨</span></span><br><span class="line">        [_base flushMessageQueue:result];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)webViewJavascriptFetchQueyCommand &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;WebViewJavascriptBridge._fetchQueue();&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯è§ Native ç«¯ä¼šåœ¨åˆ·æ–°é˜Ÿåˆ—ä¸­è°ƒç”¨ JS ç«¯çš„ <code>WebViewJavascriptBridge._fetchQueue();</code> æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ JS ç«¯æ­¤æ–¹æ³•çš„å…·ä½“å®ç°ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–é˜Ÿåˆ—ï¼Œåœ¨ iOS ç«¯åˆ·æ–°æ¶ˆæ¯é˜Ÿåˆ—æ—¶ä¼šè°ƒç”¨æ­¤å‡½æ•°</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_fetchQueue</span>(<span class="params"></span>) &#123;</span><br><span class="line">   <span class="comment">// å°† sendMessageQueue è½¬ä¸º JSON æ ¼å¼</span></span><br><span class="line">	<span class="keyword">var</span> messageQueueString = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(sendMessageQueue);</span><br><span class="line">	<span class="comment">// é‡ç½® sendMessageQueue</span></span><br><span class="line">	sendMessageQueue = [];</span><br><span class="line">	<span class="comment">// è¿”å› JSON æ ¼å¼çš„ </span></span><br><span class="line">	<span class="keyword">return</span> messageQueueString;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•ä¼šæŠŠå½“å‰ JS ç«¯ <code>sendMessageQueue</code> æ¶ˆæ¯é˜Ÿåˆ—ä»¥ JSON çš„å½¢å¼è¿”å›ï¼Œè€Œ Native ç«¯ä¼šè°ƒç”¨ <code>[_base flushMessageQueue:result];</code> å°†æ‹¿åˆ°çš„ JSON å½¢å¼æ¶ˆæ¯é˜Ÿåˆ—ä½œä¸ºå‚æ•°è°ƒç”¨ <code>flushMessageQueue:</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯æ•´ä¸ªæ¡†æ¶ Native ç«¯çš„ç²¾åæ‰€åœ¨ï¼Œå°±æ˜¯ç¨å¾®æœ‰ç‚¹é•¿ï¼ˆç¬‘ï¼‰ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)flushMessageQueue:(<span class="built_in">NSString</span> *)messageQueueString &#123;</span><br><span class="line">    <span class="comment">// æ ¡éªŒ messageQueueString</span></span><br><span class="line">    <span class="keyword">if</span> (messageQueueString == <span class="literal">nil</span> || messageQueueString.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;WebViewJavascriptBridge: WARNING: ObjC got nil while fetching the message queue JSON from webview. This can happen if the WebViewJavascriptBridge JS is not currently present in the webview, e.g if the webview just loaded a new page.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† messageQueueString é€šè¿‡ NSJSONSerialization è§£ä¸º messages å¹¶éå†</span></span><br><span class="line">    <span class="type">id</span> messages = [<span class="keyword">self</span> _deserializeMessageJSON:messageQueueString];</span><br><span class="line">    <span class="keyword">for</span> (WVJBMessage* message <span class="keyword">in</span> messages) &#123;</span><br><span class="line">        <span class="comment">// ç±»å‹æ ¡éªŒ</span></span><br><span class="line">        <span class="keyword">if</span> (![message isKindOfClass:[WVJBMessage <span class="keyword">class</span>]]) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;WebViewJavascriptBridge: WARNING: Invalid %@ received: %@&quot;</span>, [message <span class="keyword">class</span>], message);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="keyword">self</span> _log:<span class="string">@&quot;RCVD&quot;</span> json:message];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å°è¯•å– responseIdï¼Œå¦‚å–åˆ°åˆ™è¡¨æ˜æ˜¯å›è°ƒï¼Œä» _responseCallbacks å–åŒ¹é…çš„å›è°ƒ block æ‰§è¡Œ</span></span><br><span class="line">        <span class="built_in">NSString</span>* responseId = message[<span class="string">@&quot;responseId&quot;</span>];</span><br><span class="line">        <span class="keyword">if</span> (responseId) &#123; <span class="comment">// å–åˆ° responseId</span></span><br><span class="line">            WVJBResponseCallback responseCallback = _responseCallbacks[responseId];</span><br><span class="line">            responseCallback(message[<span class="string">@&quot;responseData&quot;</span>]);</span><br><span class="line">            [<span class="keyword">self</span>.responseCallbacks removeObjectForKey:responseId];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// æœªå–åˆ° responseIdï¼Œåˆ™è¡¨æ˜æ˜¯æ­£å¸¸çš„ JS callHandler è°ƒç”¨ iOS</span></span><br><span class="line">            WVJBResponseCallback responseCallback = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="comment">// å°è¯•å– callbackIdï¼Œç¤ºä¾‹ cb_1_1512035076293</span></span><br><span class="line">            <span class="comment">// å¯¹åº” JS ä»£ç  var callbackId = &#x27;cb_&#x27;+(uniqueId++)+&#x27;_&#x27;+new Date().getTime();</span></span><br><span class="line">            <span class="built_in">NSString</span>* callbackId = message[<span class="string">@&quot;callbackId&quot;</span>];</span><br><span class="line">            <span class="keyword">if</span> (callbackId) &#123; <span class="comment">// å–åˆ° callbackIdï¼Œè¡¨ç¤º js ç«¯å¸Œæœ›åœ¨è°ƒç”¨ iOS native ä»£ç åæœ‰å›è°ƒ</span></span><br><span class="line">                responseCallback = ^(<span class="type">id</span> responseData) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (responseData == <span class="literal">nil</span>) &#123;</span><br><span class="line">                        responseData = [<span class="built_in">NSNull</span> null];</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// å°† callbackId ä½œä¸º msg çš„ responseId å¹¶è®¾ç½® responseDataï¼Œæ‰§è¡Œ _queueMessage</span></span><br><span class="line">                    WVJBMessage* msg = @&#123; <span class="string">@&quot;responseId&quot;</span>:callbackId, <span class="string">@&quot;responseData&quot;</span>:responseData &#125;;</span><br><span class="line">                    <span class="comment">// _queueMessage å‡½æ•°ä¸»è¦æ˜¯æŠŠ msg è½¬ä¸º JSON æ ¼å¼ï¼Œå†…å« responseId = callbackId</span></span><br><span class="line">                    <span class="comment">// JS ç«¯è°ƒç”¨ WebViewJavascriptBridge._handleMessageFromObjC(&#x27;msg_JSON&#x27;); å…¶ä¸­ &#x27;msg_JSON&#x27; å°±æ˜¯ JSON æ ¼å¼çš„ msg</span></span><br><span class="line">                    [<span class="keyword">self</span> _queueMessage:msg];</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// æœªå–åˆ° callbackId</span></span><br><span class="line">                responseCallback = ^(<span class="type">id</span> ignoreResponseData) &#123;</span><br><span class="line">                    <span class="comment">// Do nothing</span></span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å°è¯•ä»¥ handlerName è·å– iOS ç«¯ä¹‹å‰æ³¨å†Œè¿‡çš„ handler</span></span><br><span class="line">            WVJBHandler handler = <span class="keyword">self</span>.messageHandlers[message[<span class="string">@&quot;handlerName&quot;</span>]];</span><br><span class="line">            <span class="keyword">if</span> (!handler) &#123; <span class="comment">// æ²¡æ³¨å†Œè¿‡ï¼Œåˆ™è·³è¿‡æ­¤ msg</span></span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@&quot;WVJBNoHandlerException, No handler for message from JS: %@&quot;</span>, message);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è°ƒç”¨å¯¹åº”çš„ handlerï¼Œä»¥ message[@&quot;data&quot;] ä¸ºå…¥å‚ï¼Œä»¥ responseCallback ä¸ºå›è°ƒ</span></span><br><span class="line">            handler(message[<span class="string">@&quot;data&quot;</span>], responseCallback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å˜›~ <code>flushMessageQueue:</code> æ–¹æ³•ä½œä¸ºæ•´ä¸ª Native ç«¯çš„æ ¸å¿ƒï¼Œæœ‰ç‚¹é•¿æ˜¯å¯ä»¥ç†è§£çš„ã€‚æˆ‘ä»¬ç®€å•ç†ä¸€ä¸‹å®ƒçš„å®ç°æ€è·¯ï¼š</p>
<ul>
<li>å…¥å‚æ ¡éªŒ</li>
<li>å°† JSON å½¢å¼çš„å…¥å‚è½¬æ¢ä¸º Native å¯¹è±¡ï¼Œå³æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™é‡Œé¢æ¶ˆæ¯ç±»å‹æ˜¯ä¹‹å‰å®šä¹‰è¿‡çš„ WVJBMessageï¼Œå³å­—å…¸</li>
<li>å¦‚æœæ¶ˆæ¯ä¸­å«æœ‰ â€œresponseIdâ€ åˆ™è¡¨æ˜æ˜¯ä¹‹å‰ Native è°ƒç”¨çš„ JS æ–¹æ³•å›è°ƒè¿‡æ¥çš„æ¶ˆæ¯ï¼ˆå› ä¸º JS ç«¯å’Œ Native ç«¯å®ç°é€»è¾‘æ˜¯å¯¹ç­‰çš„ï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹ä¸æ˜ç™½çš„å¯ä»¥å‚è€ƒä¸‹é¢çš„åˆ†æï¼‰</li>
<li>å¦‚æœæ¶ˆæ¯ä¸­ä¸å« â€œresponseIdâ€ åˆ™è¡¨æ˜æ˜¯ JS ç«¯é€šè¿‡ <code>callHandler</code> å‡½æ•°æ­£å¸¸è°ƒç”¨ Native ç«¯è¿‡æ¥çš„æ¶ˆæ¯</li>
<li>å°è¯•è·å–æ¶ˆæ¯ä¸­çš„ â€œcallbackIdâ€ï¼Œå¦‚æœ JS æœ¬æ¬¡æ¶ˆæ¯éœ€è¦ Native å“åº”ä¹‹åå›è°ƒæ‰ä¼šæœ‰è¿™ä¸ªé”®å€¼ï¼Œå…·ä½“å‚è§ä¸Šæ–‡ä¸­ JS ç«¯ <code>_doSend</code> éƒ¨åˆ†æºç åˆ†æã€‚å¦‚å–åˆ° â€œcallbackIdâ€ åˆ™éœ€ç”Ÿæˆä¸€ä¸ªå›è°ƒ blockï¼Œå›è°ƒ block å†…éƒ¨å°† â€œcallbackIdâ€ ä½œä¸º msg çš„ â€œresponseIdâ€ æ‰§è¡Œ <code>_queueMessage</code> å°†æ¶ˆæ¯å‘é€ç»™ JS ç«¯ï¼ˆJS ç«¯å¤„ç†æ¶ˆæ¯é€»è¾‘ä¸ Native ç«¯ä¸€è‡´ï¼Œæ‰€ä»¥ä¸Šé¢ä½¿ç”¨ â€œresponseIdâ€ åˆ¤æ–­å½“å‰æ¶ˆæ¯æ˜¯å¦ä¸ºå›è°ƒæ–¹æ³•ä¼ é€’è¿‡æ¥çš„æ¶ˆæ¯æ˜¯å¾ˆå®¹æ˜“ç†è§£çš„ï¼‰</li>
<li>å°è¯•ä»¥æ¶ˆæ¯ä¸­çš„ â€œhandlerNameâ€ ä» <code>messageHandlers</code>ï¼ˆä¸Šæ–‡æåˆ°è¿‡ï¼Œæ˜¯ä¿å­˜ Native ç«¯æ³¨å†Œè¿‡çš„ handler çš„å­—å…¸ï¼‰å–åˆ°å¯¹åº”çš„ handler blockï¼Œå¦‚æœå–åˆ°åˆ™æ‰§è¡Œä»£ç å—ï¼Œå¦åˆ™æ‰“å°é”™è¯¯æ—¥å¿—</li>
</ul>
<blockquote>
<p>Note: è¿™ä¸ªæ¶ˆæ¯å¤„ç†çš„æ–¹æ³•è™½ç„¶é•¿ï¼Œä½†æ˜¯é€»è¾‘æ¸…æ™°ï¼Œè€Œä¸”æœ‰æ•ˆçš„è§£å†³äº† JS ä¸ Native ç›¸äº’è°ƒç”¨çš„è¿‡ç¨‹ä¸­å‚æ•°ä¼ é€’çš„é—®é¢˜ï¼ˆåŒ…æ‹¬å›è°ƒï¼‰ï¼Œæ­¤å¤– JS ç«¯çš„æ¶ˆæ¯å¤„ç†é€»è¾‘ä¸ Native ç«¯ä¿æŒä¸€è‡´ï¼Œå®ç°äº†é€»è¾‘å¯¹ç§°ï¼Œéå¸¸å€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚</p>
</blockquote>
<h2 id="WebViewJavascriptBridge-JS-Native-è°ƒç”¨-JS-å®ç°è§£è¯»"><a href="#WebViewJavascriptBridge-JS-Native-è°ƒç”¨-JS-å®ç°è§£è¯»" class="headerlink" title="WebViewJavascriptBridge_JS - Native è°ƒç”¨ JS å®ç°è§£è¯»"></a>WebViewJavascriptBridge_JS - Native è°ƒç”¨ JS å®ç°è§£è¯»</h2><img src="/webview_javascript_bridge/javascript.jpg" class="">
<p>Emmmmmâ€¦è¿™ä¸€ç« èŠ‚ä¸»è¦è®² JS ç«¯æ³¨å…¥çš„ä»£ç ï¼Œå³ WebViewJavascriptBridge_JS ä¸­çš„ JS æºç ã€‚ç”±äºæˆ‘æ²¡åšè¿‡å‰æ®µï¼Œèƒ½åŠ›ä¸è¶³ï¼Œæ°´å¹³æœ‰é™ï¼Œå¯èƒ½æœ‰è°¬è¯¯å¸Œæœ›å„ä½è¯»è€…å‘ç°çš„è¯åŠæ—¶æŒ‡æ­£ï¼Œæ„Ÿæ¿€ä¸å°½ã€‚é¢„è­¦ï¼Œç”±äº JS ç«¯å’Œä¸Šæ–‡åˆ†æè¿‡çš„ Native ç«¯é€»è¾‘å¯¹ç§°ä¸”ä¸Šæ–‡å·²ç»åˆ†æè¿‡éƒ¨åˆ† JS ç«¯çš„å‡½æ•°ï¼Œæ‰€ä»¥ä¸‹é¢çš„ JS æºç æ²¡æœ‰å¦åšæ‹†åˆ†ï¼Œä¸ºé¿å…è¢«å¤§æ®µ JS ä»£ç ç³Šè„¸ä¸æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç›´æ¥çœ‹ä»£ç åé¢çš„æ€»ç»“ã€‚</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// window.WebViewJavascriptBridge æ ¡éªŒï¼Œé¿å…é‡å¤</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">WebViewJavascriptBridge</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‡’åŠ è½½ window.onerrorï¼Œç”¨äºæ‰“å° error æ—¥å¿—</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="variable language_">window</span>.<span class="property">onerror</span>) &#123;</span><br><span class="line">		<span class="variable language_">window</span>.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params">msg, url, line</span>) &#123;</span><br><span class="line">			<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;WebViewJavascriptBridge: ERROR:&quot;</span> + msg + <span class="string">&quot;@&quot;</span> + url + <span class="string">&quot;:&quot;</span> + line);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// window.WebViewJavascriptBridge å£°æ˜</span></span><br><span class="line">	<span class="variable language_">window</span>.<span class="property">WebViewJavascriptBridge</span> = &#123;</span><br><span class="line">		<span class="attr">registerHandler</span>: registerHandler,</span><br><span class="line">		<span class="attr">callHandler</span>: callHandler,</span><br><span class="line">		<span class="attr">disableJavscriptAlertBoxSafetyTimeout</span>: disableJavscriptAlertBoxSafetyTimeout,</span><br><span class="line">		<span class="attr">_fetchQueue</span>: _fetchQueue,</span><br><span class="line">		<span class="attr">_handleMessageFromObjC</span>: _handleMessageFromObjC</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å˜é‡å£°æ˜</span></span><br><span class="line">	<span class="keyword">var</span> messagingIframe; <span class="comment">// æ¶ˆæ¯ iframe</span></span><br><span class="line">	<span class="keyword">var</span> sendMessageQueue = []; <span class="comment">// å‘é€æ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">	<span class="keyword">var</span> messageHandlers = &#123;&#125;; <span class="comment">// JS ç«¯æ³¨å†Œçš„æ¶ˆæ¯å¤„ç† handlers å­—å…¸ï¼ˆå›§ï¼ŒJS å…¶å®å«å¯¹è±¡ï¼‰</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// scheme ä½¿ç”¨ https ä¹‹åé€šè¿‡ host åšåŒ¹é…</span></span><br><span class="line">	<span class="keyword">var</span> <span class="variable constant_">CUSTOM_PROTOCOL_SCHEME</span> = <span class="string">&#x27;https&#x27;</span>;</span><br><span class="line">	<span class="keyword">var</span> <span class="variable constant_">QUEUE_HAS_MESSAGE</span> = <span class="string">&#x27;__wvjb_queue_message__&#x27;</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">var</span> responseCallbacks = &#123;&#125;; <span class="comment">// JS ç«¯å­˜æ”¾å›è°ƒçš„å­—å…¸</span></span><br><span class="line">	<span class="keyword">var</span> uniqueId = <span class="number">1</span>; <span class="comment">// å”¯ä¸€æ ‡ç¤ºï¼Œç”¨äºå›è°ƒæ—¶ç”Ÿæˆ callbackId</span></span><br><span class="line">	<span class="keyword">var</span> dispatchMessagesWithTimeoutSafety = <span class="literal">true</span>; <span class="comment">// é»˜è®¤å¯ç”¨å®‰å…¨æ—¶é•¿</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡ç¦ç”¨ AlertBoxSafetyTimeout æ¥æé€Ÿç½‘æ¡¥æ¶ˆæ¯ä¼ é€’</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">disableJavscriptAlertBoxSafetyTimeout</span>(<span class="params"></span>) &#123;</span><br><span class="line">		dispatchMessagesWithTimeoutSafety = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒ iOS é€»è¾‘ï¼Œæ³¨å†Œ handler å…¶å®æ˜¯å¾€ messageHandlers å­—å…¸ä¸­æ’å…¥å¯¹åº” name çš„ block</span></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">registerHandler</span>(<span class="params">handlerName, handler</span>) &#123;</span><br><span class="line">		messageHandlers[handlerName] = handler;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// è°ƒç”¨ iOS handlerï¼Œå‚æ•°æ ¡éªŒä¹‹åè°ƒç”¨ _doSend å‡½æ•°</span></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">callHandler</span>(<span class="params">handlerName, data, responseCallback</span>) &#123;</span><br><span class="line">	    <span class="comment">// å¦‚æœå‚æ•°åªæœ‰ä¸¤ä¸ªä¸”ç¬¬äºŒä¸ªå‚æ•°ç±»å‹ä¸º functionï¼Œåˆ™è¡¨ç¤ºæ²¡æœ‰å‚æ•°ä¼ é€’ï¼Œå³ data ä¸ºç©º</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="variable language_">arguments</span>.<span class="property">length</span> == <span class="number">2</span> &amp;&amp; <span class="keyword">typeof</span> data == <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">			responseCallback = data;</span><br><span class="line">			data = <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// å°† handlerName å’Œ data ä½œä¸º msg å¯¹è±¡å‚æ•°è°ƒç”¨ _doSend å‡½æ•°</span></span><br><span class="line">		<span class="title function_">_doSend</span>(&#123; <span class="attr">handlerName</span>:handlerName, <span class="attr">data</span>:data &#125;, responseCallback);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// _doSend å‘ Native ç«¯å‘é€æ¶ˆæ¯</span></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">_doSend</span>(<span class="params">message, responseCallback</span>) &#123;</span><br><span class="line">	    <span class="comment">// å¦‚æœ‰å›è°ƒï¼Œåˆ™è®¾ç½® message[&#x27;callbackId&#x27;] ä¸ responseCallbacks[callbackId]</span></span><br><span class="line">		<span class="keyword">if</span> (responseCallback) &#123;</span><br><span class="line">			<span class="keyword">var</span> callbackId = <span class="string">&#x27;cb_&#x27;</span>+(uniqueId++)+<span class="string">&#x27;_&#x27;</span>+<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line">			responseCallbacks[callbackId] = responseCallback;</span><br><span class="line">			message[<span class="string">&#x27;callbackId&#x27;</span>] = callbackId;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// å°† msg åŠ å…¥ sendMessageQueue æ•°ç»„ï¼Œè®¾ç½® messagingIframe.src</span></span><br><span class="line">		sendMessageQueue.<span class="title function_">push</span>(message);</span><br><span class="line">		messagingIframe.<span class="property">src</span> = <span class="variable constant_">CUSTOM_PROTOCOL_SCHEME</span> + <span class="string">&#x27;://&#x27;</span> + <span class="variable constant_">QUEUE_HAS_MESSAGE</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–é˜Ÿåˆ—ï¼Œåœ¨ iOS ç«¯åˆ·æ–°æ¶ˆæ¯é˜Ÿåˆ—æ—¶ä¼šè°ƒç”¨æ­¤å‡½æ•°</span></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">_fetchQueue</span>(<span class="params"></span>) &#123;</span><br><span class="line">	    <span class="comment">// å†…éƒ¨å°†å‘é€æ¶ˆæ¯é˜Ÿåˆ— sendMessageQueue è½¬ä¸º JSON æ ¼å¼å¹¶è¿”å›</span></span><br><span class="line">		<span class="keyword">var</span> messageQueueString = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(sendMessageQueue);</span><br><span class="line">		sendMessageQueue = [];</span><br><span class="line">		<span class="keyword">return</span> messageQueueString;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// iOS ç«¯ _dispatchMessage å‡½æ•°ä¼šè°ƒç”¨æ­¤å‡½æ•°</span></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">_handleMessageFromObjC</span>(<span class="params">messageJSON</span>) &#123;</span><br><span class="line">	    <span class="comment">// è°ƒåº¦ä» Native ç«¯è·å–åˆ°çš„æ¶ˆæ¯</span></span><br><span class="line">        <span class="title function_">_dispatchMessageFromObjC</span>(messageJSON);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¸å¿ƒä»£ç ï¼Œè°ƒåº¦ä» Native ç«¯è·å–åˆ°çš„æ¶ˆæ¯ï¼Œé€»è¾‘ä¸ Native ç«¯ä¸€è‡´</span></span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">_dispatchMessageFromObjC</span>(<span class="params">messageJSON</span>) &#123;</span><br><span class="line">		<span class="comment">// åˆ¤æ–­æœ‰æ²¡æœ‰ç¦ç”¨ AlertBoxSafetyTimeoutï¼Œæœ€ç»ˆä¼šè°ƒç”¨ _doDispatchMessageFromObjC å‡½æ•°</span></span><br><span class="line">		<span class="keyword">if</span> (dispatchMessagesWithTimeoutSafety) &#123;</span><br><span class="line">			<span class="built_in">setTimeout</span>(_doDispatchMessageFromObjC);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			 <span class="title function_">_doDispatchMessageFromObjC</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// è§£æ msgJSON å¾—åˆ° msg</span></span><br><span class="line">		<span class="keyword">function</span> <span class="title function_">_doDispatchMessageFromObjC</span>(<span class="params"></span>) &#123;</span><br><span class="line">			<span class="keyword">var</span> message = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(messageJSON);</span><br><span class="line">			<span class="keyword">var</span> messageHandler;</span><br><span class="line">			<span class="keyword">var</span> responseCallback;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// å¦‚æœæœ‰ responseIdï¼Œåˆ™è¯´æ˜æ˜¯å›è°ƒï¼Œå–å¯¹åº”çš„ responseCallback æ‰§è¡Œï¼Œä¹‹åé‡Šæ”¾</span></span><br><span class="line">			<span class="keyword">if</span> (message.<span class="property">responseId</span>) &#123;</span><br><span class="line">				responseCallback = responseCallbacks[message.<span class="property">responseId</span>];</span><br><span class="line">				<span class="keyword">if</span> (!responseCallback) &#123;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="title function_">responseCallback</span>(message.<span class="property">responseData</span>);</span><br><span class="line">				<span class="keyword">delete</span> responseCallbacks[message.<span class="property">responseId</span>];</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123; <span class="comment">// æ²¡æœ‰ responseIdï¼Œåˆ™è¡¨ç¤ºæ­£å¸¸çš„ iOS call handler è°ƒç”¨ js</span></span><br><span class="line">				<span class="comment">// å¦‚ msg åŒ…å« callbackIdï¼Œè¯´æ˜ iOS ç«¯éœ€è¦å›è°ƒï¼Œåˆå§‹åŒ–å¯¹åº”çš„ responseCallback</span></span><br><span class="line">				<span class="keyword">if</span> (message.<span class="property">callbackId</span>) &#123;</span><br><span class="line">					<span class="keyword">var</span> callbackResponseId = message.<span class="property">callbackId</span>;</span><br><span class="line">					responseCallback = <span class="keyword">function</span>(<span class="params">responseData</span>) &#123;</span><br><span class="line">						<span class="title function_">_doSend</span>(&#123; <span class="attr">handlerName</span>:message.<span class="property">handlerName</span>, <span class="attr">responseId</span>:callbackResponseId, <span class="attr">responseData</span>:responseData &#125;);</span><br><span class="line">					&#125;;</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// ä» messageHandlers æ‹¿åˆ°å¯¹åº”çš„ handler æ‰§è¡Œ</span></span><br><span class="line">				<span class="keyword">var</span> handler = messageHandlers[message.<span class="property">handlerName</span>];</span><br><span class="line">				<span class="keyword">if</span> (!handler) &#123;</span><br><span class="line">				    <span class="comment">// å¦‚æœªå–åˆ°å¯¹åº”çš„ handler åˆ™æ‰“å°é”™è¯¯æ—¥å¿—</span></span><br><span class="line">					<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;WebViewJavascriptBridge: WARNING: no handler for message from ObjC:&quot;</span>, message);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="title function_">handler</span>(message.<span class="property">data</span>, responseCallback);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// messagingIframe çš„å£°æ˜ï¼Œç±»å‹ iframeï¼Œæ ·å¼ä¸å¯è§ï¼Œsrc è®¾ç½®</span></span><br><span class="line">	messagingIframe = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;iframe&#x27;</span>);</span><br><span class="line">	messagingIframe.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">	messagingIframe.<span class="property">src</span> = <span class="variable constant_">CUSTOM_PROTOCOL_SCHEME</span> + <span class="string">&#x27;://&#x27;</span> + <span class="variable constant_">QUEUE_HAS_MESSAGE</span>;</span><br><span class="line">	<span class="comment">// messagingIframe åŠ å…¥ document.documentElement ä¸­</span></span><br><span class="line">	<span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="title function_">appendChild</span>(messagingIframe);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å†Œ disableJavscriptAlertBoxSafetyTimeout handlerï¼ŒNative å¯ä»¥é€šè¿‡ç¦ç”¨ AlertBox çš„å®‰å…¨æ—¶é•¿æ¥åŠ é€Ÿæ¡¥æ¥æ¶ˆæ¯</span></span><br><span class="line">	<span class="title function_">registerHandler</span>(<span class="string">&quot;_disableJavascriptAlertBoxSafetyTimeout&quot;</span>, disableJavscriptAlertBoxSafetyTimeout);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">setTimeout</span>(_callWVJBCallbacks, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">function</span> <span class="title function_">_callWVJBCallbacks</span>(<span class="params"></span>) &#123;</span><br><span class="line">		<span class="keyword">var</span> callbacks = <span class="variable language_">window</span>.<span class="property">WVJBCallbacks</span>;</span><br><span class="line">		<span class="keyword">delete</span> <span class="variable language_">window</span>.<span class="property">WVJBCallbacks</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;callbacks.<span class="property">length</span>; i++) &#123;</span><br><span class="line">			callbacks[i](<span class="title class_">WebViewJavascriptBridge</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JS ç«¯å’Œ Native ç«¯é€»è¾‘ä¸€è‡´ï¼Œä¸Šé¢çš„ä»£ç å·²ç»åŠ å…¥äº†è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šï¼Œä¸Šæ–‡åœ¨å¯¹äºâ€œWebViewJavascriptBridgeBase - JS è°ƒç”¨ Native å®ç°åŸç†å‰–æâ€ç« èŠ‚çš„åˆ†æè¿‡ç¨‹ä¸­ä¸ºäº†èµ°é€šæ•´ä¸ªè°ƒç”¨çš„é€»è¾‘å·²ç»å¯¹éƒ¨åˆ† JS ç«¯ä»£ç è¿›è¡Œäº†åˆ†æï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•çš„æ¢³ç†ä¸€ä¸‹ JS ç«¯æ ¸å¿ƒä»£ç  <code>_doDispatchMessageFromObjC</code> å‡½æ•°çš„é€»è¾‘ï¼š</p>
<ul>
<li>å°† messageJSON ä½¿ç”¨ JSON è§£æå‡ºæ¥</li>
<li>å°è¯•å–è§£æåˆ°çš„æ¶ˆæ¯ä¸­çš„ responseIdï¼Œå¦‚æœæœ‰å–åˆ°åˆ™è¯´æ˜æ˜¯ Native ç«¯å“åº” JS ç«¯ä¹‹åé€šè¿‡å›è°ƒå‘ JS ç«¯å‘å‡ºçš„æ¶ˆæ¯ï¼Œç”¨ responseId å– responseCallbacks ä¸­å¯¹åº”çš„å›è°ƒå“åº” blockï¼Œæ‰¾åˆ°åæ‰§è¡Œè¯¥ block ä¹‹ååˆ é™¤</li>
<li>å¦‚æœæ²¡å–åˆ° responseId åˆ™è¡¨ç¤ºè¿™æ¡æ¶ˆæ¯æ˜¯ Native ç«¯é€šè¿‡ <code>callHandler:data:responseCallback:</code> æ­£å¸¸è°ƒç”¨ JS æ³¨å†Œçš„ handler å‘é€è¿‡æ¥çš„æ¶ˆæ¯ï¼ˆè¿™é‡Œçš„æ­£å¸¸æ˜¯é’ˆå¯¹å›è°ƒè€Œè¨€ï¼‰</li>
<li>å¦‚æœå½“å‰çš„æ¶ˆæ¯æœ‰ callbackId åˆ™è¡¨æ˜ Native ç«¯éœ€è¦ JS ç«¯å“åº”æœ¬æ¬¡æ¶ˆæ¯ä¹‹åå›è°ƒåé¦ˆï¼Œç”Ÿæˆä¸€ä¸ª responseCallback ä½œä¸ºå›è°ƒ block (JS ç«¯æ˜¯ function) ï¼Œå…¶å†…éƒ¨ä½¿ç”¨ <code>_doSend</code> æ–¹æ³•ä¼ é€’ä¸€ä¸ªå¸¦æœ‰ responseId çš„æ¶ˆæ¯ç»™ Native ç«¯ï¼Œè¡¨æ˜æ­¤æ¡æ¶ˆæ¯æ˜¯ä¹‹å‰çš„å›è°ƒæ¶ˆæ¯</li>
<li>æœ€åæŒ‰ç…§è§£æåˆ°çš„æ¶ˆæ¯ä¸­ handlerName ä» messageHandlersï¼Œå³ JS ç«¯æ³¨å†Œè¿‡çš„ handlers ä¸­æ‰¾åˆ°ä¸åç§°å¯¹åº”çš„å¤„ç†å‡½æ•°æ‰§è¡Œï¼Œå¦‚æœæ²¡æ‰¾åˆ°åˆ™æ‰“å°é™„å¸¦ç›¸å…³ä¿¡æ¯çš„é”™è¯¯æ—¥å¿—</li>
</ul>
<p>å˜›~ å¯¹æ¯”ä¸€ä¸‹ Native ç«¯çš„æ ¸å¿ƒä»£ç  <code>flushMessageQueue:</code> çœ‹ä¸€ä¸‹ï¼Œå¾ˆå®¹æ˜“å‘ç°ä¸¤ç«¯çš„å¤„ç†å®ç°æ˜¯é€»è¾‘å¯¹ç§°çš„ã€‚</p>
<h2 id="WebViewJavascriptBridge-çš„â€œæ¡¥æ¢ç¾å­¦â€"><a href="#WebViewJavascriptBridge-çš„â€œæ¡¥æ¢ç¾å­¦â€" class="headerlink" title="WebViewJavascriptBridge çš„â€œæ¡¥æ¢ç¾å­¦â€"></a>WebViewJavascriptBridge çš„â€œæ¡¥æ¢ç¾å­¦â€</h2><img src="/webview_javascript_bridge/bridge_beautiful.jpg" class="">
<p>åœ¨æ€»ç»“ WebViewJavascriptBridge çš„â€œæ¡¥æ¢ç¾å­¦â€ä¹‹å‰è¯·å†å›é¡¾ä¸€ä¸‹ WebViewJavascriptBridge çš„å·¥ä½œæµï¼š</p>
<ul>
<li>JS ç«¯åŠ å…¥ src ä¸º <code>https://__bridge_loaded__</code> çš„ iframe</li>
<li>Native ç«¯æ£€æµ‹åˆ° Requestï¼Œæ£€æµ‹å¦‚æœæ˜¯ <code>__bridge_loaded__</code> åˆ™é€šè¿‡å½“å‰çš„ WebView ç»„ä»¶æ³¨å…¥ WebViewJavascriptBridge_JS ä»£ç </li>
<li>æ³¨å…¥ä»£ç æˆåŠŸä¹‹åä¼šåŠ å…¥ä¸€ä¸ª messagingIframeï¼Œå…¶ src ä¸º <code>https://__wvjb_queue_message__</code></li>
<li>ä¹‹åä¸è®ºæ˜¯ Native ç«¯è¿˜æ˜¯ JS ç«¯éƒ½å¯ä»¥é€šè¿‡ <code>registerHandler</code> æ–¹æ³•æ³¨å†Œä¸€ä¸ªä¸¤ç«¯çº¦å®šå¥½çš„ HandlerName çš„å¤„ç†ï¼Œä¹Ÿéƒ½å¯ä»¥é€šè¿‡ <code>callHandler</code> æ–¹æ³•é€šè¿‡çº¦å®šå¥½çš„ HandlerName è°ƒç”¨å¦ä¸€ç«¯çš„å¤„ç†ï¼ˆä¸¤ç«¯å¤„ç†æ¶ˆæ¯çš„å®ç°é€»è¾‘å¯¹ç§°ï¼‰</li>
</ul>
<p>å˜›~ æ‰€ä»¥æˆ‘ä»¬å¾ˆå®¹æ˜“åˆ—ä¸¾å‡º WebViewJavascriptBridge æ‰€å…·æœ‰çš„â€œç¾å­¦â€ï¼š</p>
<ul>
<li>éšæ€§é€‚é…</li>
<li>æ¥å£å¯¹ç­‰</li>
<li>é€»è¾‘å¯¹ç§°</li>
</ul>
<p>æˆ‘ä»¬ç»“åˆæœ¬æ–‡å±•å¼€æ¥è¯´ä¸€ä¸‹ä¸Šé¢çš„â€œç¾å­¦â€çš„å…·ä½“å®ç°ã€‚</p>
<h3 id="éšæ€§é€‚é…"><a href="#éšæ€§é€‚é…" class="headerlink" title="éšæ€§é€‚é…"></a>éšæ€§é€‚é…</h3><p>WebViewJavascriptBridge ä¸»è¦æ˜¯ä½œä¸º Mac OS X å’Œ iOS ç«¯ï¼ˆNative ç«¯ï¼‰ä¸ JS ç«¯ç›¸äº’é€šä¿¡ï¼Œäº’ç›¸è°ƒç”¨çš„æ¡¥æ¢ã€‚å¯¹äº Mac OS X å’Œ iOS ä¸¤ç§å¹³å°åŒ…å«çš„ä¸‰ç§ WebView åŠŸèƒ½ç»„ä»¶è€Œè¨€ï¼ŒWebViewJavascriptBridge åšäº†éšæ€§é€‚é…ï¼Œå³ä»…ç”¨ä¸€å¥—ä»£ç å³å¯ç»‘å®šä¸åŒå¹³å°çš„ WebView ç»„ä»¶å®ç°åŒæ ·åŠŸèƒ½çš„ JS é€šä¿¡åŠŸèƒ½ï¼Œè¿™ä¸€ç‚¹éå¸¸æ–¹ä¾¿ã€‚</p>
<h3 id="æ¥å£å¯¹ç­‰"><a href="#æ¥å£å¯¹ç­‰" class="headerlink" title="æ¥å£å¯¹ç­‰"></a>æ¥å£å¯¹ç­‰</h3><p>WebViewJavascriptBridge å¯¹äº JS ç«¯å’Œ Native ç«¯è®¾è®¡äº†å¯¹ç­‰çš„æ¥å£ï¼Œä¸è®ºæ˜¯ JS ç«¯è¿˜æ˜¯ Native ç«¯ï¼Œæ³¨å†Œæœ¬ç«¯çš„å“åº”å¤„ç†éƒ½æ˜¯ç”¨ <code>registerHandler</code> æ¥å£ï¼Œè°ƒç”¨å¦ä¸€ç«¯ï¼ˆç»™å¦ä¸€ç«¯å‘æ¶ˆæ¯ï¼‰éƒ½æ˜¯ç”¨ <code>callHandler</code> æ¥å£ã€‚</p>
<p>è¿™æ ·åšæ˜¯éå¸¸åˆç†çš„ï¼Œå› ä¸ºä¸è®ºæ˜¯ JS ç«¯è¿˜æ˜¯ Native ç«¯ï¼Œä½œä¸ºé€šä¿¡çš„åŒæ–¹å°±é€šä¿¡æœ¬èº«è€Œè¨€æ˜¯å¤„äºå¯¹ç­‰çš„åœ°ä½çš„ã€‚è¿™å°±å¥½æ¯”ä¸€åº§å¤§æ¡¥è¿æ¥ä¸¤å—é™†åœ°ï¼Œä¸¤åœ°ç”¨å¤§æ¡¥ç›¸äº’è¿è¾“è´§ç‰©å¹¶æ¥æ”¶èµ„æºï¼Œä¸¤å—é™†åœ°åœ¨å¤§æ¡¥çš„è¿è¾“ä½¿ç”¨è¿‡ç¨‹ä¸­é€»è¾‘ä¸Šä¹Ÿæ˜¯åœ°ä½å¯¹ç­‰çš„ã€‚</p>
<h3 id="é€»è¾‘å¯¹ç§°"><a href="#é€»è¾‘å¯¹ç§°" class="headerlink" title="é€»è¾‘å¯¹ç§°"></a>é€»è¾‘å¯¹ç§°</h3><p>WebViewJavascriptBridge åœ¨ JS ç«¯å’Œ Native ç«¯å¯¹å‘é€è¿‡æ¥çš„æ¶ˆæ¯æœ‰ç€ç›¸åŒé€»è¾‘çš„å¤„ç†å®ç°ï¼Œå¦‚æœè€ƒè™‘åˆ°æ”¶å‘åŒæ–¹çš„èº«ä»½åˆ™å¯ä»¥æŠŠé€»è¾‘ç›¸åŒçœ‹åšé€»è¾‘å¯¹ç§°ã€‚</p>
<p>è¿™ç§å®ç°æ–¹å¼ä¾æ—§éå¸¸åˆç†ï¼Œè¢«æ¡¥è¿æ¥çš„ä¸¤å—å¤§é™†åœ¨è£…è´§ä¸Šæ¡¥å’Œä¸‹æ¡¥å¸è´§è¿™ä¸¤å¤„é€»è¾‘ä¸Šå°±åº”è¯¥æ˜¯å¯¹ç§°çš„ã€‚</p>
<p>å˜›~ è¯´åˆ°è¿™é‡Œå°±ä¸å¾—ä¸ç¥­å‡ºä¸€ä¸ªè¯æ¥å½¢å®¹ WebViewJavascriptBridge äº†ï¼Œè¿™ä¸ªè¯å°±æ˜¯<strong>ä¼˜é›…</strong>ï¼ˆç¬‘ï¼‰ã€‚å½“å¤§å®¶ç»“åˆ WebViewJavascriptBridge æºç é˜…è¯»æœ¬æ–‡ä¹‹åä¸éš¾å‘ç°å…¶æ•´ä¸ªæ¶æ„å’Œè®¾è®¡æ€æƒ³è·Ÿç°å®æ¡¥æ¢è®¾è®¡ä¸­å¾ˆå¤šè®¾è®¡æ€æƒ³ä¸è°‹è€Œåˆï¼Œæ¯”å¦‚æ¡¥ä¸€èˆ¬ä¼šåˆ†ä¸ºå·¦å³æ¡¥å¹…ï¼Œè€Œå·¦å³å¹…æ¡¥ä¸€èˆ¬åªæœ‰ä¸€æ¡çº¿è·¯ä¸­å¿ƒçº¿ï¼Œå³ä¸€ä¸ªå‰è¿›æ–¹å‘ï¼Œç”¨äºæ¡¥ä¸Šå•ä¸€æ–¹å‘çš„èµ„æºä¼ è¾“ï¼Œå·¦å³æ¡¥å¹…åœ¨åŠŸèƒ½ä¸Šå¯¹ç­‰ã€‚</p>
<h2 id="æ–‡ç« æ€»ç»“"><a href="#æ–‡ç« æ€»ç»“" class="headerlink" title="æ–‡ç« æ€»ç»“"></a>æ–‡ç« æ€»ç»“</h2><ul>
<li>æ–‡ç« ç³»ç»Ÿåˆ†æäº† WebViewJavascriptBridge æºç ï¼Œå¸Œæœ›å„ä½è¯»è€…èƒ½å¤Ÿåœ¨é˜…è¯»æœ¬æ–‡ä¹‹åå¯¹ WebViewJavascriptBridge çš„æ¶æ„æœ‰ä¸€ä¸ªæ•´ä½“è®¤è¯†ã€‚</li>
<li>æ–‡ç« å¯¹ WebViewJavascriptBridge åœ¨ JS ç«¯å’Œ Native ç«¯çš„æ¶ˆæ¯å¤„ç†å®ç°åšäº†æ·±å…¥å‰–æï¼Œå¸Œæœ›å¯ä»¥å¯¹å„ä½è¯»è€…è¿™éƒ¨åˆ†æºç çš„ç†è§£æä¾›ä¸€äº›å¾®è–„çš„å¸®åŠ©ã€‚</li>
<li>æ€»ç»“äº† WebViewJavascriptBridge ä½œä¸ºä¸€ä¸ª JSBridge æ¡†æ¶æ‰€å…·æœ‰çš„ä¼˜åŠ¿ï¼Œå³æ–‡ä¸­æ‰€æŒ‡çš„â€œæ¡¥æ¢ç¾å­¦â€ï¼ŒæœŸæœ›å¯ä»¥å¯¹å¤§å®¶ä»¥åè‡ªå·±å°è£…ä¸€ä¸ª JSBridge æä¾›æ€è·¯ï¼ŒæŠ›ç –å¼•ç‰ã€‚</li>
</ul>
<p>Emmmmmâ€¦ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ WebViewJavascriptBridge ä»…ä»…æ˜¯ä½œä¸º JSBridge å±‚ç”¨äºæä¾› JS å’Œ Native ä¹‹é—´ç›¸äº’ä¼ é€’æ¶ˆæ¯çš„åŸºç¡€æ”¯æŒçš„ã€‚å¦‚æœæƒ³è¦å°è£…è‡ªå·±é¡¹ç›®ä¸­çš„ WebView ç»„ä»¶è¿˜éœ€è¦å¦å¤–å®ç° HTTP cookie æ³¨å…¥ï¼Œè‡ªå®šä¹‰ User-Agentï¼Œç™½åå•æˆ–è€…æƒé™æ ¡éªŒç­‰åŠŸèƒ½ï¼Œæ›´è¿›ä¸€æ­¥è¿˜éœ€è¦å¯¹ WebView ç»„ä»¶è¿›è¡Œåˆå§‹åŒ–é€Ÿåº¦ï¼Œé¡µé¢æ¸²æŸ“é€Ÿåº¦ä»¥åŠé¡µé¢ç¼“å­˜ç­–ç•¥çš„ä¼˜åŒ–ã€‚æˆ‘ä¹‹å<strong>ä¹Ÿè®¸å¯èƒ½å¤§æ¦‚åº”è¯¥</strong>ä¼šå†™ä¸€ç¯‡æ–‡ç« åˆ†äº«ä¸€ä¸‹è‡ªå·±å°è£… WebView ç»„ä»¶æ—¶è¸©åˆ°çš„ä¸€äº›å‘ä»¥åŠç»éªŒï¼Œå› ä¸ºè‡ªå·±æ°´å¹³æœ‰é™â€¦æ‰€ä»¥ä¹Ÿå¯èƒ½ä¸ä¼šå†™ï¼ˆç¬‘ï¼‰ã€‚</p>
<p>æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜ <a href="https://lision.me/">https://lision.me/</a>ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ <a href="https://lision.me/">ä¸ªäººåšå®¢</a> ä¸­æ›´æ–°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš <a target="_blank" rel="noopener" href="https://weibo.com/lisioncode">@Lision</a> è”ç³»æˆ‘~</p>
<p>å¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~</p>


    
    
    
	  <div class="tags">
      <a class="tag-none-link" href="/tags/hybrid/" rel="tag">hybrid</a><a class="tag-none-link" href="/tags/jsbridge/" rel="tag">jsbridge</a>
	  </div>
    

  </section>
</article>
  
    <article class="post ">

  
  <h2 class="title">
    <a href="/yyimage/">
      YYImage è®¾è®¡æ€è·¯ï¼Œå®ç°ç»†èŠ‚å‰–æ
    </a>
  </h2>
  
  <time>
    12æœˆ 10, 2017
  </time>
  <section class="content">
	  <img src="/yyimage/yyimage_h.jpg" class="">
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å›¾ç‰‡çš„å†å²æ—©äºæ–‡å­—ï¼Œæ˜¯æœ€åŸå§‹çš„ä¿¡æ¯ä¼ é€’æ–¹å¼ã€‚<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%AD%E6%9B%B8">å…­ä¹¦</a>ä¸­çš„è±¡å½¢æ–‡æ„é€ æ€æƒ³å°±æ˜¯ç”¨æ–‡å­—çš„çº¿æ¡æˆ–ç¬”ç”»ï¼ŒæŠŠè¦è¡¨è¾¾ç‰©ä½“çš„å¤–å½¢ç‰¹å¾ï¼Œå…·ä½“åœ°å‹¾ç”»å‡ºæ¥ã€‚</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%A8%B1%E6%85%8E">è®¸æ…</a>ã€Š<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%AF%B4%E6%96%87%E8%A7%A3%E5%AD%97">è¯´æ–‡è§£å­—</a>ã€‹äº‘ï¼šâ€œè±¡å½¢è€…ï¼Œç”»æˆå…¶ç‰©ï¼Œéšä½“è¯˜è¯ï¼Œæ—¥ã€æœˆæ˜¯ä¹Ÿã€‚â€</p>
</blockquote>
<p>ç°ä»£ç¤¾ä¼šçš„ä¿¡æ¯ä¼ é€’ä¸­ï¼Œå›¾ç‰‡ä»ç„¶æ˜¯ä¸å¯æˆ–ç¼ºçš„ä¸€ç¯ï¼Œä¸è®ºæ˜¯æŠ¥çº¸ã€æ‚å¿—ã€æ¼«ç”»ç­‰å®ä½“åˆŠç‰©è¿˜æ˜¯ç”Ÿæ´»ä¸­è¶…å¸‚åœ°é“å¹¿å‘Šæ´»åŠ¨ï¼Œéƒ½ä¼šæœ‰ä¸“é—¨çš„é…å›¾æŠ“äººçœ¼çƒã€‚</p>
<p>åœ¨ç§»åŠ¨ç«¯ App ä¸­ï¼Œå›¾ç‰‡é€šå¸¸å æ®ç€é‡è¦çš„è§†è§‰ç©ºé—´ï¼Œä½œä¸º iOS å¼€å‘æ¥è®²ï¼Œæ‰€æœ‰çš„ App éƒ½æœ‰ç²¾å¿ƒè®¾è®¡çš„ AppIcon é™ˆåˆ—åœ¨ SpringBoard ä¸­ï¼Œæ‰“å¼€ä»»æ„ä¸€æ¬¾ä¸»æµ App éƒ½å°‘ä¸äº†ç³ç…æ»¡ç›®çš„å›¾ç‰‡æ­é…ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ibireme/YYImage">YYImage</a> æ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„ iOS å›¾åƒæ¡†æ¶ï¼ˆè¯¥é¡¹ç›®æ˜¯ <a target="_blank" rel="noopener" href="https://github.com/ibireme/YYKit">YYKit</a> ç»„ä»¶ä¹‹ä¸€ï¼‰ï¼Œæ”¯æŒç›®å‰å¸‚åœºä¸Šæ‰€æœ‰ä¸»æµçš„å›¾ç‰‡æ ¼å¼çš„æ˜¾ç¤ºä¸ç¼–/è§£ç ï¼Œå¹¶ä¸”æä¾›é«˜æ•ˆçš„åŠ¨æ€å†…å­˜ç¼“å­˜ç®¡ç†ï¼Œä»¥ä¿è¯é«˜æ€§èƒ½ä½å†…å­˜çš„åŠ¨ç”»æ’­æ”¾ã€‚</p>
<p>YYKit çš„ä½œè€… <a target="_blank" rel="noopener" href="https://weibo.com/239801242">@ibireme</a> å¯¹äº iOS å›¾ç‰‡å¤„ç†å†™æœ‰ä¸¤ç¯‡éå¸¸ä¸é”™çš„æ–‡ç« ï¼Œæ¨èå„ä½è¯»è€…åœ¨é˜…è¯»æœ¬æ–‡ä¹‹å‰æŸ¥é˜…ã€‚</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.ibireme.com/2015/11/02/mobile_image_benchmark/">ç§»åŠ¨ç«¯å›¾ç‰‡æ ¼å¼è°ƒç ”</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.ibireme.com/2015/11/02/ios_image_tips/">iOS å¤„ç†å›¾ç‰‡çš„ä¸€äº›å° Tip</a></li>
</ul>
<p>æœ¬æ–‡å¼•ç”¨ä»£ç å‡ä¸º YYImage v1.0.4 ç‰ˆæœ¬æºç ï¼Œæ–‡ç« æ—¨åœ¨å‰–æ YYImage çš„æ¶æ„æ€æƒ³ä»¥åŠè®¾è®¡æ€è·¯å¹¶å¯¹ç¬”è€…åœ¨é˜…è¯»æºç è¿‡ç¨‹ä¸­å‘ç°çš„æœ‰è¶£å®ç°ç»†èŠ‚æ¢ç©¶åˆ†äº«ï¼Œä¸ä¼šé€è¡Œç¿»è¯‘æºç ï¼Œå»ºè®®å¯¹æºç å®ç°æ„Ÿå…´è¶£çš„åŒå­¦ç»“åˆ YYImage v1.0.4 ç‰ˆæœ¬æºç é£Ÿç”¨æœ¬æ–‡~</p>
<img src="/yyimage/xiaomai.gif" class="">
<h2 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h2><ul>
<li>YYImage ç®€ä»‹</li>
<li>YYImage, YYFrameImage, YYSpriteSheetImage</li>
<li>YYAnimatedImageView</li>
<li>YYImageCoder</li>
<li>æ€»ç»“</li>
<li>æ‰©å±•é˜…è¯»</li>
</ul>
<h2 id="YYImage-ç®€ä»‹"><a href="#YYImage-ç®€ä»‹" class="headerlink" title="YYImage ç®€ä»‹"></a>YYImage ç®€ä»‹</h2><img src="/yyimage/yyimage.jpg" class="">
<p>YYImage æ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„ iOS å›¾åƒæ¡†æ¶ï¼Œæ”¯æŒå½“å‰å¸‚åœºä¸»æµçš„é™/åŠ¨æ€å›¾åƒç¼–/è§£ç ä¸åŠ¨æ€å›¾åƒçš„åŠ¨ç”»æ’­æ”¾æ˜¾ç¤ºï¼Œå…¶å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li>æ”¯æŒä»¥ä¸‹ç±»å‹åŠ¨ç”»å›¾åƒçš„æ’­æ”¾/ç¼–ç /è§£ç : WebP, APNG, GIFã€‚</li>
<li>æ”¯æŒä»¥ä¸‹ç±»å‹é™æ€å›¾åƒçš„æ˜¾ç¤º/ç¼–ç /è§£ç : WebP, PNG, GIF, JPEG, JP2, TIFF, BMP, ICO, ICNSã€‚</li>
<li>æ”¯æŒä»¥ä¸‹ç±»å‹å›¾ç‰‡çš„æ¸è¿›å¼/é€è¡Œæ‰«æ/éš”è¡Œæ‰«æè§£ç : PNG, GIF, JPEG, BMPã€‚</li>
<li>æ”¯æŒå¤šå¼ å›¾ç‰‡æ„æˆçš„å¸§åŠ¨ç”»æ’­æ”¾ï¼Œæ”¯æŒå•å¼ å›¾ç‰‡çš„ sprite sheet åŠ¨ç”»ã€‚</li>
<li>é«˜æ•ˆçš„åŠ¨æ€å†…å­˜ç¼“å­˜ç®¡ç†ï¼Œä»¥ä¿è¯é«˜æ€§èƒ½ä½å†…å­˜çš„åŠ¨ç”»æ’­æ”¾ã€‚</li>
<li>å®Œå…¨å…¼å®¹ UIImage å’Œ UIImageViewï¼Œä½¿ç”¨æ–¹ä¾¿ã€‚</li>
<li>ä¿ç•™å¯æ‰©å±•çš„æ¥å£ï¼Œä»¥æ”¯æŒè‡ªå®šä¹‰åŠ¨ç”»ã€‚</li>
<li>æ¯ä¸ªç±»å’Œæ–¹æ³•éƒ½æœ‰å®Œå–„çš„æ–‡æ¡£æ³¨é‡Šã€‚</li>
</ul>
<h3 id="YYImage-æ¶æ„åˆ†æ"><a href="#YYImage-æ¶æ„åˆ†æ" class="headerlink" title="YYImage æ¶æ„åˆ†æ"></a>YYImage æ¶æ„åˆ†æ</h3><p>é€šè¿‡ YYImage æºç å¯ä»¥æŒ‰ç…§å…¶ä¸ UIKit çš„å¯¹åº”å…³ç³»åˆ’åˆ†ä¸ºä¸‰ä¸ªå±‚çº§ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">å±‚çº§</th>
<th style="text-align:center">UIKit</th>
<th style="text-align:center">YYImage</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">å›¾åƒå±‚</td>
<td style="text-align:center">UIImage</td>
<td style="text-align:center">YYImage, YYFrameImage, YYSpriteSheetImage</td>
</tr>
<tr>
<td style="text-align:center">è§†å›¾å±‚</td>
<td style="text-align:center">UIImageView</td>
<td style="text-align:center">YYAnimatedImageView</td>
</tr>
<tr>
<td style="text-align:center">ç¼–/è§£ç å±‚</td>
<td style="text-align:center">ImageIO.framework</td>
<td style="text-align:center">YYImageCoder</td>
</tr>
</tbody>
</table>
<ul>
<li>å›¾åƒå±‚ï¼ŒæŠŠä¸åŒç±»å‹çš„å›¾åƒä¿¡æ¯å°è£…æˆç±»å¹¶æä¾›åˆå§‹åŒ–å’Œå…¶ä»–ä¾¿æ·æ¥å£ã€‚</li>
<li>è§†å›¾å±‚ï¼Œè´Ÿè´£å›¾åƒå±‚å†…å®¹çš„æ˜¾ç¤ºï¼ˆåŒ…å«åŠ¨æ€å›¾åƒçš„åŠ¨ç”»æ’­æ”¾ï¼‰å·¥ä½œã€‚</li>
<li>ç¼–/è§£ç å±‚ï¼Œæä¾›å›¾åƒåº•å±‚æ”¯æŒï¼Œä½¿æ•´ä¸ªæ¡†æ¶å¾—ä»¥æ”¯æŒå¸‚åœºä¸»æµçš„å›¾ç‰‡æ ¼å¼ã€‚</li>
</ul>
<blockquote>
<p>Note: <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/imageio">ImageIO.framework</a> æ˜¯ iOS åº•å±‚å®ç°çš„å›¾ç‰‡ç¼–/è§£ç åº“ï¼Œè´Ÿè´£ç®¡ç†é¢œè‰²å’Œè®¿é—®å›¾åƒå…ƒæ•°æ®ã€‚å…¶å†…éƒ¨çš„å®ç°ä½¿ç”¨äº†ç¬¬ä¸‰æ–¹ç¼–/è§£ç åº“ï¼ˆå¦‚ libpng ç­‰ï¼‰å¹¶å¯¹ç¬¬ä¸‰æ–¹åº“è¿›è¡Œè°ƒæ•´ä¼˜åŒ–ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒiOS è¿˜ä¸“é—¨é’ˆå¯¹ JPEG çš„ç¼–/è§£ç å¼€å‘äº† AppleJPEG.frameworkï¼Œå®ç°äº†æ€§èƒ½æ›´é«˜çš„ç¡¬ç¼–ç å’Œç¡¬è§£ç ã€‚</p>
</blockquote>
<img src="/yyimage/yyimage_struct.png" class="">
<h2 id="YYImage-YYFrameImage-YYSpriteSheetImage"><a href="#YYImage-YYFrameImage-YYSpriteSheetImage" class="headerlink" title="YYImage, YYFrameImage, YYSpriteSheetImage"></a>YYImage, YYFrameImage, YYSpriteSheetImage</h2><p>å…ˆæ¥ä»‹ç» YYImage åº“ä¸­å›¾åƒå±‚çš„ä¸‰ä¸ªç±»ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>YYImage</li>
<li>YYFrameImage</li>
<li>YYSpriteSheetImage</li>
</ul>
<h3 id="YYImage"><a href="#YYImage" class="headerlink" title="YYImage"></a>YYImage</h3><p>YYImage æ˜¯ä¸€ä¸ªæ˜¾ç¤ºåŠ¨æ€å›¾ç‰‡æ•°æ®çš„é«˜çº§åˆ«ç±»ï¼Œå…¶ç»§æ‰¿è‡ª UIImage å¹¶å¯¹ UIImage åšäº†æ‰©å±•ä»¥æ”¯æŒ WebPï¼ŒAPNG å’Œ GIF æ ¼å¼çš„å›¾ç‰‡è§£ç ã€‚å®ƒè¿˜æ”¯æŒ NSCoding åè®®å¯ä»¥å¯¹å¤šå¸§å›¾åƒæ•°æ®è¿›è¡Œ archive å’Œ unarchive æ“ä½œã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYImage</span> : <span class="title">UIImage</span> &lt;<span class="title">YYAnimatedImage</span>&gt;</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">nullable</span> YYImage *)imageNamed:(<span class="built_in">NSString</span> *)name; <span class="comment">// ä¸åŒäº UIImageï¼Œæ­¤æ–¹æ³•æ— ç¼“å­˜</span></span><br><span class="line">+ (<span class="keyword">nullable</span> YYImage *)imageWithContentsOfFile:(<span class="built_in">NSString</span> *)path;</span><br><span class="line">+ (<span class="keyword">nullable</span> YYImage *)imageWithData:(<span class="built_in">NSData</span> *)data;</span><br><span class="line">+ (<span class="keyword">nullable</span> YYImage *)imageWithData:(<span class="built_in">NSData</span> *)data scale:(<span class="built_in">CGFloat</span>)scale;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) YYImageType animatedImageType; <span class="comment">// å›¾åƒæ•°æ®ç±»å‹</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSData</span> *animatedImageData; <span class="comment">// åŠ¨æ€å›¾åƒçš„å…ƒæ•°æ®</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> animatedImageMemorySize; <span class="comment">// å¤šå¸§å›¾åƒå†…å­˜å ç”¨é‡</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="type">BOOL</span> preloadAllAnimatedImageFrames; <span class="comment">// é¢„åŠ è½½æ‰€æœ‰å¸§ï¼ˆåˆ°å†…å­˜ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>YYImage æä¾›äº†ç±»ä¼¼ UIImage çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œå…¬å¼€äº†ä¸€äº›å±æ€§ä¾¿äºæˆ‘ä»¬æ£€æµ‹å’Œæ§åˆ¶å…¶å†…å­˜ä½¿ç”¨ã€‚</p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ YYImage çš„ <code>imageNamed:</code> åˆå§‹åŒ–æ–¹æ³•å¹¶ä¸æ”¯æŒç¼“å­˜ã€‚å› ä¸ºå…¶ <code>imageNamed:</code> å†…éƒ¨å®ç°å¹¶ä¸åŒäº UIImage çš„ <code>imageNamed:</code> æ–¹æ³•ï¼ŒYYImage ä¸­çš„å®ç°æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ¨æµ‹å‡ºç»™å®šå›¾åƒèµ„æºè·¯å¾„</li>
<li>æ‹¿åˆ°è·¯å¾„ä¸­çš„å›¾åƒæ•°æ®ï¼ˆNSDataï¼‰</li>
<li>è°ƒç”¨ YYImage çš„ <code>initWithData:scale:</code> æ–¹æ³•åˆå§‹åŒ–</li>
</ul>
<p>YYImage çš„ç§æœ‰å˜é‡éƒ¨åˆ†ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œç›¸ä¿¡å¤§å®¶å¯ä»¥æ ¹æ®ä¸Šé¢æš´éœ²å‡ºçš„å±æ€§å’Œæ¥å£çŒœå¾—åˆ°å“ˆã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYImage</span> </span>&#123;</span><br><span class="line">    YYImageDecoder *_decoder; <span class="comment">// è§£ç å™¨</span></span><br><span class="line">    <span class="built_in">NSArray</span> *_preloadedFrames; <span class="comment">// é¢„åŠ è½½çš„å›¾åƒå¸§</span></span><br><span class="line">    dispatch_semaphore_t _preloadedLock; <span class="comment">// é¢„åŠ è½½é”</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> _bytesPerFrame; <span class="comment">// å†…å­˜å ç”¨é‡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å†…éƒ¨æœ‰ä¸€æŠŠé” <code>dispatch_semaphore_t</code>ï¼Œæˆ‘ä»¬çŸ¥é“ <code>dispatch_semaphore_t</code> å½“ä¿¡å·é‡ä¸º 1 æ—¶å¯ä»¥å½“åšé”æ¥ä½¿ç”¨ï¼Œåœ¨ä¸é˜»å¡æ—¶å…¶ä½œä¸ºé”çš„æ•ˆç‡éå¸¸é«˜ã€‚è¿™é‡Œä½¿ç”¨ <code>_preloadedLock</code> çš„ä¸»è¦ç›®çš„æ˜¯ä¿è¯ <code>_preloadedFrames</code> çš„è¯»å†™ï¼Œç”±äº <code>_preloadedFrames</code> çš„è¯»å†™è¿‡ç¨‹æ˜¯åœ¨å†…å­˜ä¸­å®Œæˆçš„ï¼Œæ“ä½œè€—æ—¶ä¸ä¼šå¤ªå¤šï¼Œæ‰€ä»¥ä¸ä¼šé•¿æ—¶é—´é˜»å¡ï¼Œè¿™ç§æƒ…å†µä½¿ç”¨ <code>dispatch_semaphore_t</code> éå¸¸åˆé€‚ã€‚</p>
<p>å˜›~ <code>_preloadedFrames</code> å¯¹åº” <code>preloadAllAnimatedImageFrames</code> å±æ€§ï¼Œå¼€å¯é¢„åŠ è½½æ‰€æœ‰å¸§åˆ°å†…å­˜çš„è¯ï¼Œ<code>_preloadedFrames</code> ä½œä¸ºä¸€ä¸ªæ•°ç»„ä¼šä¿å­˜æ‰€æœ‰å¸§çš„å›¾åƒã€‚<code>_bytesPerFrame</code> åˆ™å¯¹åº” <code>animatedImageMemorySize</code> å±æ€§ï¼Œåœ¨åˆå§‹åŒ– YYImage æ—¶ï¼Œå¦‚æœå¸§æ€»æ•°è¶…è¿‡ 1 åˆ™ä¼šè®¡ç®— <code>_bytesPerFrame</code> çš„å¤§å°ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (decoder.frameCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    _decoder = decoder;</span><br><span class="line">    _bytesPerFrame = <span class="built_in">CGImageGetBytesPerRow</span>(image.CGImage) * <span class="built_in">CGImageGetHeight</span>(image.CGImage);</span><br><span class="line">    _animatedImageMemorySize = _bytesPerFrame * decoder.frameCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å® YYImage ä¸­è¿˜æœ‰ä¸€äº›å®ç°ä¹Ÿæ¯”è¾ƒæœ‰è¶£ï¼Œæ¯”å¦‚ <code>animatedImageDurationAtIndex:</code> çš„å®ç°ä¸­å¦‚æœå–åˆ° &lt;= 10 ms çš„æ—¶é•¿ä¼šæ›¿æ¢ä¸º 100 msï¼Œå¹¶åœ¨ <a target="_blank" rel="noopener" href="https://github.com/ibireme/YYImage/blob/master/YYImage/YYImage.m#L246">æ³¨é‡Š</a> ä¸­è§£é‡Šäº†ä¸ºä»€ä¹ˆï¼ˆä¸€å®šè¦ç‚¹è¿›å»çœ‹å•Šï¼Œç¬‘~ï¼‰ã€‚</p>
<h3 id="YYFrameImage"><a href="#YYFrameImage" class="headerlink" title="YYFrameImage"></a>YYFrameImage</h3><p>YYFrameImage æ˜¯ä¸“é—¨ç”¨æ¥æ˜¾ç¤ºåŸºäºå¸§çš„åŠ¨ç”»å›¾åƒç±»ï¼Œå…¶ä¹Ÿæ˜¯ UIImage çš„å­ç±»ã€‚YYFrameImage ä»…æ”¯æŒç³»ç»Ÿå›¾ç‰‡æ ¼å¼ä¾‹å¦‚ png å’Œ jpegã€‚</p>
<blockquote>
<p>Note: ä½¿ç”¨ YYFrameImage æ˜¾ç¤ºåŠ¨ç”»å›¾åƒåŒæ ·è¦åŸºäº YYAnimatedImageView æ’­æ”¾ã€‚</p>
</blockquote>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYFrameImage</span> : <span class="title">UIImage</span> &lt;<span class="title">YYAnimatedImage</span>&gt;</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithImagePaths:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)paths</span><br><span class="line">                           oneFrameDuration:(<span class="built_in">NSTimeInterval</span>)oneFrameDuration</span><br><span class="line">                                  loopCount:(<span class="built_in">NSUInteger</span>)loopCount;</span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithImagePaths:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)paths</span><br><span class="line">                             frameDurations:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSNumber</span> *&gt; *)frameDurations</span><br><span class="line">                                  loopCount:(<span class="built_in">NSUInteger</span>)loopCount;</span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithImageDataArray:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSData</span> *&gt; *)dataArray</span><br><span class="line">                               oneFrameDuration:(<span class="built_in">NSTimeInterval</span>)oneFrameDuration</span><br><span class="line">                                      loopCount:(<span class="built_in">NSUInteger</span>)loopCount;</span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithImageDataArray:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSData</span> *&gt; *)dataArray</span><br><span class="line">                                 frameDurations:(<span class="built_in">NSArray</span> *)frameDurations</span><br><span class="line">                                      loopCount:(<span class="built_in">NSUInteger</span>)loopCount;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>YYFrameImage å¯ä»¥æŠŠé™æ€å›¾ç‰‡ç±»å‹å¦‚ png å’Œ jpeg æ ¼å¼çš„é™æ€å›¾åƒç”¨å¸§åˆ‡æ¢çš„æ–¹å¼ä»¥åŠ¨æ€å›¾ç‰‡çš„å½¢å¼æ˜¾ç¤ºï¼Œå¹¶ä¸”æä¾›äº† 4 ä¸ªå¸¸ç”¨çš„åˆå§‹åŒ–æ–¹æ³•æ–¹ä¾¿æˆ‘ä»¬ä½¿ç”¨ã€‚</p>
<p>YYFrameImage å†…éƒ¨æœ‰ä¸€äº›åŸºæœ¬çš„å˜é‡åˆ†åˆ«å¯¹åº”äºå…¶æš´éœ²çš„ 4 ä¸ªå¸¸ç”¨åˆå§‹åŒ–æ¥å£ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYFrameImage</span> </span>&#123;</span><br><span class="line">    <span class="built_in">NSUInteger</span> _loopCount;</span><br><span class="line">    <span class="built_in">NSUInteger</span> _oneFrameBytes;</span><br><span class="line">    <span class="built_in">NSArray</span> *_imagePaths;</span><br><span class="line">    <span class="built_in">NSArray</span> *_imageDatas;</span><br><span class="line">    <span class="built_in">NSArray</span> *_frameDurations;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>YYFrameImage çš„å®ç°ä»£ç éå¸¸ç®€å•ï¼Œåˆå§‹åŒ–æ–¹æ³•å¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ul>
<li>å…¥å‚æ ¡éªŒ</li>
<li>æ ¹æ®å…¥å‚å–åˆ°é¦–å¼ å›¾ç‰‡</li>
<li>ç”¨é¦–å›¾åˆå§‹åŒ– <code>_oneFrameBytes</code> ï¼Œå¦‚å…¥å‚åˆå§‹åŒ– <code>_imageDatas</code> ï¼Œ<code>_frameDurations</code> å’Œ <code>_loopCount</code></li>
<li>ç”¨ <code>UIImage</code> çš„ <code>initWithCGImage:scale:orientation:</code> åˆå§‹åŒ–å¹¶è¿”å›åˆå§‹åŒ–ç»“æœ</li>
</ul>
<h3 id="YYSpriteSheetImage"><a href="#YYSpriteSheetImage" class="headerlink" title="YYSpriteSheetImage"></a>YYSpriteSheetImage</h3><img src="/yyimage/ss_wukong.png" class="">
<p>YYSpriteSheetImage æ˜¯ç”¨æ¥åš Spritesheet åŠ¨ç”»æ˜¾ç¤ºçš„å›¾åƒç±»ï¼Œå®ƒä¹Ÿæ˜¯ UIImage çš„å­ç±»ã€‚</p>
<p>å…³äº Spritesheet å¯èƒ½åšè¿‡æ¸¸æˆå¼€å‘æˆ–è€…ä»¥å‰é¼“æ£è¿‡ç®€å•ç½‘é¡µæ¸¸æˆ Demo çš„åŒå­¦ä¼šå¾ˆç†Ÿæ‚‰ï¼Œå…¶åŠ¨ç”»åŸç†æ˜¯æŠŠä¸€ä¸ªåŠ¨ç”»è¿‡ç¨‹åˆ†è§£ä¸ºå¤šä¸ªåŠ¨ç”»å¸§ï¼ŒæŒ‰ç…§é¡ºåºå°†è¿™äº›åŠ¨ç”»å¸§æ’å¸ƒåœ¨ä¸€å¼ å¤§çš„ç”»å¸ƒä¸­ï¼Œæ’­æ”¾åŠ¨ç”»æ—¶åªéœ€è¦æŒ‰ç…§æ¯ä¸€å¸§å›¾åƒçš„å°ºå¯¸å¤§å°ä»¥åŠå¯¹åº”ç´¢å¼•å»ç”»å¸ƒä¸­æå–å¯¹åº”çš„å¸§æ›¿æ¢æ˜¾ç¤ºä»¥è¾¾åˆ°äººçœ¼åˆ¤å®šåŠ¨ç”»çš„æ•ˆæœï¼Œç‚¹å‡» <a target="_blank" rel="noopener" href="https://gamedevelopment.tutsplus.com/tutorials/an-introduction-to-spritesheet-animation--gamedev-13099"><br>An Introduction to Spritesheet Animation</a> æˆ–è€… <a target="_blank" rel="noopener" href="https://www.codeandweb.com/what-is-a-sprite-sheet">What is a sprite sheet?</a> äº†è§£æ›´å¤šå…³äº Spritesheet åŠ¨ç”»çš„ä¿¡æ¯ã€‚</p>
<blockquote>
<p>Note: å…³äº SpriteSheet ç´ æçš„åˆ¶ä½œæœ‰ä¸€æ¬¾å·¥å…· <a target="_blank" rel="noopener" href="https://www.codeandweb.com/sprite-sheet-maker">SpriteSheetMaker</a> æ¨èä½¿ç”¨ã€‚</p>
</blockquote>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYSpriteSheetImage</span> : <span class="title">UIImage</span> &lt;<span class="title">YYAnimatedImage</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–æ–¹æ³•ï¼Œè¿™ä¸ªç¬¬ä¸€æ¬¡æ¥è§¦ Spritesheet çš„åŒå­¦å¯èƒ½ä¼šè§‰å¾—æ¯”è¾ƒç¹ç</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithSpriteSheetImage:(<span class="built_in">UIImage</span> *)image</span><br><span class="line">                                     contentRects:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSValue</span> *&gt; *)contentRects</span><br><span class="line">                                   frameDurations:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSNumber</span> *&gt; *)frameDurations</span><br><span class="line">                                        loopCount:(<span class="built_in">NSUInteger</span>)loopCount;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span>&lt;<span class="built_in">NSValue</span> *&gt; *contentRects; <span class="comment">// å¸§ä½ç½®ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span>&lt;<span class="built_in">NSValue</span> *&gt; *frameDurations; <span class="comment">// å¸§æŒç»­æ—¶é•¿</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> loopCount; <span class="comment">// å¾ªç¯æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®ç´¢å¼•æ‰¾åˆ°å¯¹åº”å¸§ CALayer çš„ä½ç½®</span></span><br><span class="line">- (<span class="built_in">CGRect</span>)contentsRectForCALayerAtIndex:(<span class="built_in">NSUInteger</span>)index;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­åˆå§‹åŒ–æ–¹æ³•çš„å…¥å‚ä¸º SpriteSheet ç”»å¸ƒï¼ˆåŒ…å«æ‰€æœ‰åŠ¨ç”»å¸§çš„å¤§å›¾ï¼‰imageï¼Œæ¯ä¸€å¸§çš„ä½ç½® contentRectsï¼Œæ¯ä¸€å¸§å¯¹åº”çš„æŒç»­æ˜¾ç¤ºæ—¶é—´ frameDurationsï¼Œå¾ªç¯æ¬¡æ•° loopCountï¼Œåˆå§‹åŒ–ç¤ºä¾‹åœ¨ YYImage æºæ–‡ä»¶ <a target="_blank" rel="noopener" href="https://github.com/ibireme/YYImage/blob/master/YYImage/YYSpriteSheetImage.h#L32">YYSpriteSheetImage.h</a> æ³¨é‡Šä¸­æœ‰å†™ã€‚</p>
<blockquote>
<p>Note: ä¸‹æ–‡ä¸­è¦è®²çš„ YYAnimatedImageView ä¸­å®šä¹‰äº† YYAnimatedImage åè®®ï¼Œè¿™ä¸ªåè®®ä¸­æœ‰ä¸€ä¸ªå¯é€‰æ–¹æ³• <code>animatedImageContentsRectAtIndex:</code> å°±æ˜¯ä¸º YYSpriteSheetImage é‡èº«æ‰“é€ çš„ã€‚</p>
</blockquote>
<p>è¿™é‡Œéœ€è¦æä¸€ä¸‹ <code>contentsRectForCALayerAtIndex:</code> æ¥å£ä¼šæ ¹æ®ç´¢å¼•æ‰¾åˆ°å¯¹åº”å¸§çš„ CALayer ä½ç½®ï¼Œè¯¥æ¥å£è¿”å›ä¸€ä¸ªç”± 0.0~1.0 ä¹‹é—´çš„æ•°å€¼ç»„æˆçš„å›¾å±‚å®šä½ LayerRectï¼Œå¦‚æœåœ¨æŸ¥æ‰¾ä½ç½®è¿‡ç¨‹ä¸­å‘ç°å¼‚å¸¸åˆ™è¿”å› CGRectMake(0, 0, 1, 1)ï¼Œå…¶å†…éƒ¨å®ç°å¤§ä½“æ­¥éª¤ï¼š</p>
<ul>
<li>æ ¡éªŒå…¥å‚ç´¢å¼•æ˜¯å¦è¶…è¿‡ SpriteSheet åˆ†å‰²å¸§æ€»æ•°ï¼Œè¶…è¿‡è¿”å› CGRectMake(0, 0, 1, 1)</li>
<li>æ²¡è¶…è¿‡åˆ™é€šè¿‡ YYAnimatedImage åè®®çš„ <code>animatedImageContentsRectAtIndex:</code> æ–¹æ³•æ‰¾åˆ°å¯¹åº”ç´¢å¼•çš„çœŸå®ä½ç½® RealRect</li>
<li>é€šè¿‡çœŸå®ä½ç½® RealRect ä¸ SpriteSheet ç”»å¸ƒçš„æ¯”ç®—é”™ 0.0~1.0 ä¹‹é—´çš„å€¼ï¼Œå¾—åˆ°æŒ‡å®šç´¢å¼•å¸§çš„é€»è¾‘å®šä½ LogicRect</li>
<li>é€šè¿‡ <code>CGRectIntersection</code> æ–¹æ³•è®¡ç®—é€»è¾‘å®šä½ LogicRect ä¸ CGRectMake(0, 0, 1, 1) çš„äº¤é›†ï¼Œç¡®ä¿é€»è¾‘å®šä½æ²¡æœ‰è¶…å‡ºç”»å¸ƒçš„éƒ¨åˆ†</li>
<li>å°†å¤„ç†åçš„é€»è¾‘å®šä½ LogicRect ä½œä¸ºå›¾å±‚å®šä½ LayerRect è¿”å›</li>
</ul>
<p>è¿”å›çš„ LayerRect ä½œä¸ºå¯¹åº”ç´¢å¼•å¸§çš„ç”»å¸ƒå†…ç›¸å¯¹ä½ç½®å­˜åœ¨ï¼Œç»“åˆç”»å¸ƒå°±å¯ä»¥å®šä½åˆ°å¯¹åº”å¸§å›¾åƒçš„å…·ä½“å°ºå¯¸å’Œä½ç½®ã€‚</p>
<h2 id="YYAnimatedImageView"><a href="#YYAnimatedImageView" class="headerlink" title="YYAnimatedImageView"></a>YYAnimatedImageView</h2><img src="/yyimage/blood_wheel_eye.jpeg" class="">
<p>äººçœ¼ä¸­å‘ˆç°çš„åŠ¨ç”»æ˜¯ç”±ä¸€å¹…å¹…å†…å®¹è¿è´¯çš„å›¾åƒä»¥è¾ƒçŸ­æ—¶é—´æŒ‰é¡ºåºæ›¿æ¢å½¢æˆçš„ï¼Œæ‰€ä»¥è¦æ˜¾ç¤ºåŠ¨ç”»åªéœ€è¦çŸ¥é“åŠ¨ç”»é¡ºåºä¸­æ¯ä¸€å¸§å›¾åƒä»¥åŠå¯¹åº”çš„æ˜¾ç¤ºæ—¶é—´ç­‰ä¿¡æ¯å³å¯ã€‚YYImage ä¸­å¯¹åº”äº UIImage å±‚çº§çš„å†…å®¹ï¼ˆYYImage, YYFrameImage, YYSpriteSheetImageï¼‰åœ¨ä¸Šæ–‡å·²ç»ä»‹ç»è¿‡äº†ï¼Œè™½ç„¶å®ƒä»¬ä¹‹é—´å­˜åœ¨å†…å®¹å’Œå½¢å¼ä¸Šçš„å·®å¼‚ï¼Œä½†æ˜¯å¯¹äºäººçœ¼åŠ¨ç”»å‘ˆç°çš„åŸç†å´æ˜¯ä¸å˜çš„ã€‚</p>
<p>YYAnimatedImageView æ˜¯ YYImage çš„é‡è¦ç»„æˆï¼Œå®ƒæ˜¯ UIImageView çš„å­ç±»ï¼Œè´Ÿè´£ YYImage å›¾åƒå±‚ä¸­ä¸åŒçš„å›¾åƒç±»çš„è§†å›¾æ˜¾ç¤ºï¼ˆåŒ…å«åŠ¨æ€å›¾åƒçš„åŠ¨ç”»æ’­æ”¾ï¼‰ï¼Œå…¶å†…éƒ¨åŒ…å« YYAnimatedImage åè®®ä»¥åŠ YYAnimatedImageView è‡ªèº«ä¸¤éƒ¨åˆ†ã€‚</p>
<h3 id="YYAnimatedImage-åè®®"><a href="#YYAnimatedImage-åè®®" class="headerlink" title="YYAnimatedImage åè®®"></a>YYAnimatedImage åè®®</h3><p>ä¸Šæ–‡æåˆ°ä¸è®ºæ˜¯ YYImage, YYFrameImage, YYSpriteSheetImage è¿˜æ˜¯ä»¥åå¯èƒ½ä¼šæ‰©å±•çš„å›¾åƒç±»ï¼Œè™½ç„¶å®ƒä»¬ä¹‹é—´å­˜åœ¨å†…å®¹å’Œå½¢å¼ä¸Šçš„å·®å¼‚ï¼Œä½†æ˜¯å¯¹äºäººçœ¼åŠ¨ç”»å‘ˆç°çš„åŸç†å´æ˜¯ä¸å˜çš„ã€‚</p>
<p>YYAnimatedImage åè®®å°±æ˜¯åœ¨ä¸å½±å“åŸæ¥å›¾åƒç±»çš„æƒ…å†µä¸‹æŠŠä¸åŒå›¾åƒç±»ä¹‹é—´çš„å…±æ€§æ‰¾å‡ºæ¥ï¼ˆæ±‚åŒå­˜å¼‚ï¼Ÿç¬‘ï¼‰ï¼Œä»¥ç»Ÿä¸€åŒ–çš„æ¥å£å°†äººçœ¼åŠ¨ç”»å‘ˆç°æ‰€éœ€çš„åŸºæœ¬ä¿¡æ¯è¾“å‡ºç»™ YYAnimatedImageView ä½¿ç”¨çš„åè®®ã€‚</p>
<blockquote>
<p>Note: ä½œä¸ºå›¾åƒç±»é¡»éµå¾ª YYAnimatedImage åè®®ä»¥ä¾¿å¯ä»¥ä½¿ç”¨ YYAnimatedImageView æ’­æ”¾åŠ¨ç”»ã€‚</p>
</blockquote>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">YYAnimatedImage</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@required</span></span><br><span class="line"><span class="comment">// åŠ¨ç”»å¸§æ€»æ•°</span></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)animatedImageFrameCount;</span><br><span class="line"><span class="comment">// åŠ¨ç”»å¾ªç¯æ¬¡æ•°ï¼Œ0 è¡¨ç¤ºæ— é™å¾ªç¯</span></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)animatedImageLoopCount;</span><br><span class="line"><span class="comment">// æ¯å¸§å­—èŠ‚æ•°ï¼ˆåœ¨å†…å­˜ä¸­ï¼‰ï¼Œå¯èƒ½ç”¨äºä¼˜åŒ–å†…å­˜ç¼“å†²åŒºå¤§å°</span></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)animatedImageBytesPerFrame;</span><br><span class="line"><span class="comment">// è¿”å›ç»™å®šç‰¹æ®Šç´¢å¼•å¯¹åº”çš„å¸§å›¾åƒï¼Œè¿™ä¸ªæ–¹æ³•å¯èƒ½åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­è°ƒç”¨</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)animatedImageFrameAtIndex:(<span class="built_in">NSUInteger</span>)index;</span><br><span class="line"><span class="comment">// è¿”å›ç»™å®šç‰¹æ®Šç´¢å¼•å¯¹åº”çš„å¸§å›¾åƒå¯¹åº”çš„æ˜¾ç¤ºæŒç»­æ—¶é•¿</span></span><br><span class="line">- (<span class="built_in">NSTimeInterval</span>)animatedImageDurationAtIndex:(<span class="built_in">NSUInteger</span>)index;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@optional</span></span><br><span class="line"><span class="comment">// é’ˆå¯¹ Spritesheet åŠ¨ç”»çš„æ–¹æ³•ï¼Œç”¨äºæ˜¾ç¤ºæŸä¸€å¸§å›¾åƒåœ¨ Spritesheet ç”»å¸ƒä¸­çš„ä½ç½®</span></span><br><span class="line">- (<span class="built_in">CGRect</span>)animatedImageContentsRectAtIndex:(<span class="built_in">NSUInteger</span>)index;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¸Šæ–‡æåˆ°è¿‡å¯é€‰å®ç°æ¥å£ <code>animatedImageContentsRectAtIndex:</code> æ˜¯ä¸“ä¸º Spritesheet åŠ¨ç”»è®¾è®¡çš„ã€‚</p>
</blockquote>
<p>åƒè¿™æ ·è§„å®šä¸€ä¸ªåè®®ï¼Œä½¿ä¸ç›¸å…³çš„ç±»éµå¾ªæ­¤åè®®æ‹¥æœ‰ç»Ÿä¸€çš„åŠŸèƒ½æ¥å£æ–¹ä¾¿å¦ä¸€ä¸ªç±»è°ƒç”¨çš„è®¾è®¡æ€æƒ³æˆ‘ä»¬åœ¨è‡ªå·±æ—¥å¸¸é¡¹ç›®çš„å¼€å‘è¿‡ç¨‹ä¸­å¾ˆå¤šåœºæ™¯éƒ½å¯ä»¥ç”¨åˆ°ï¼Œä¾‹å¦‚å¯ä»¥å°è£…ä¸€ä¸ª TableViewï¼Œè®¾è®¡ä¸€ä¸ª TableViewCell åè®®ï¼Œè®©æ‰€æœ‰ TableViewCell éƒ½å®ç°è¿™ä¸ªåè®®ä»¥æ‹¥æœ‰ç»Ÿä¸€çš„åŠŸèƒ½æ¥å£ï¼Œç„¶åæˆ‘ä»¬å°è£…çš„ TableView ç±»å°±å¯ä»¥ç»Ÿä¸€çš„ä½¿ç”¨è¿™äº› TableViewCell æ˜¾ç¤ºæ•°æ®å•¦ï¼Œçœå»äº†åå¤å†™ç›¸åŒåŠŸèƒ½ UITableView çš„åŠ³åŠ¨åŠ›ï¼ˆå®é™…åº”ç”¨åœºæ™¯å¾ˆå¤šï¼Œè¿™é‡Œåªæ˜¯ç®€å•ä¸¾ä¾‹ï¼ŒæŠ›ç –å¼•ç‰ï¼‰ã€‚</p>
<h3 id="YYAnimatedImageView-1"><a href="#YYAnimatedImageView-1" class="headerlink" title="YYAnimatedImageView"></a>YYAnimatedImageView</h3><p>ä¸Šæ–‡æåˆ°è¿‡ YYAnimatedImageView ä½œä¸º YYImage æ¡†æ¶ä¸­çš„å›¾ç‰‡è§†å›¾å±‚ï¼Œä¸Šæ¥å›¾åƒå±‚ï¼Œä¸‹å¯ç¼–/è§£ç åº•å±‚ï¼Œæ˜¯æ¢çº½ä¸€èˆ¬çš„å­˜åœ¨ï¼ˆæ‰¿ä¸Šå¯ä¸‹å•Šæœ‰æœ¨æœ‰ï¼Ÿï¼‰ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹ç ”ç©¶å…¶å†…éƒ¨å®ç°ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYAnimatedImageView</span> : <span class="title">UIImageView</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœ image ä¸ºå¤šå¸§ç»„æˆæ—¶ï¼Œè‡ªåŠ¨èµ‹å€¼ä¸º YESï¼Œå¯ä»¥åœ¨æ˜¾ç¤ºå’Œéšè—æ—¶è‡ªåŠ¨æ’­æ”¾å’Œåœæ­¢åŠ¨ç”»</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="type">BOOL</span> autoPlayAnimatedImage;</span><br><span class="line"><span class="comment">// å½“å‰æ˜¾ç¤ºçš„å¸§ï¼ˆä» 0 èµ·å§‹ï¼‰ï¼Œè®¾ç½®æ–°å€¼åä¼šç«‹å³æ˜¾ç¤ºå¯¹åº”å¸§ï¼Œå¦‚æœæ–°å€¼æ— æ•ˆåˆ™æ­¤æ–¹æ³•æ— æ•ˆ</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">NSUInteger</span> currentAnimatedImageIndex;</span><br><span class="line"><span class="comment">// å½“å‰æ˜¯å¦åœ¨æ’­æ”¾åŠ¨ç”»</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="type">BOOL</span> currentIsPlayingAnimation;</span><br><span class="line"><span class="comment">// åŠ¨ç”»å®šæ—¶å™¨æ‰€åœ¨çš„ runloop modeï¼Œé»˜è®¤ä¸º NSRunLoopCommonModesï¼Œå…³ä¹åŠ¨ç”»å®šæ—¶å™¨çš„è§¦å‘</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *runloopMode;</span><br><span class="line"><span class="comment">// å†…éƒ¨ç¼“å­˜åŒºçš„æœ€å¤§å€¼ï¼ˆin bytesï¼‰ï¼Œé»˜è®¤ä¸º 0ï¼ˆåŠ¨æ€ï¼‰ï¼Œå¦‚æœæœ‰å€¼å°†ä¼šæŠŠç¼“å­˜åŒºé™åˆ¶ä¸ºå€¼å¤§å°ï¼Œå½“æ”¶åˆ°å†…å­˜è­¦å‘Šæˆ–è€… App è¿›å…¥åå°æ—¶ï¼Œç¼“å­˜åŒºå°†ä¼šç«‹å³é‡Šæ”¾å¹¶ä¸”åœ¨é€‚æ—¶çš„æ—¶å€™å›å¤åŸçŠ¶</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">NSUInteger</span> maxBufferSize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>é¢â€¦å‡ºä¹æ„æ–™çš„ç®€å•å‘¢~ åªæœ‰ä¸€äº›å±æ€§æš´éœ²å‡ºæ¥ä»¥ä¾¿æˆ‘ä»¬åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å®æ—¶æŸ¥çœ‹åŠ¨ç”»çš„æ’­æ”¾çŠ¶æ€ä»¥åŠå†…å­˜ä½¿ç”¨æƒ…å†µã€‚ç¬”è€…çœ‹æºç æ€»ç»“å‡ºä¸€æ¡ç»éªŒï¼Œå³<strong>å¦‚æœæŸä¸ªç»„ä»¶åœ¨åº“ä¸­å æ®é‡è¦åœ°ä½ï¼Œå…¶ .h æ–‡ä»¶ä¸­æš´éœ²çš„å†…å®¹è¶Šæ˜¯ç®€å•ï¼Œå…¶ .m å†…éƒ¨å®ç°å°±è¶Šæ˜¯å¤æ‚</strong>ã€‚</p>
<p>é€šè¿‡ <code>runloopMode</code> å±æ€§å¤§å®¶ç”¨çŒœçš„ä¹Ÿåº”è¯¥å¯ä»¥çŒœå‡º YYAnimatedImageView å†…éƒ¨å®ç°åŠ¨ç”»çš„åŸç†ç¦»ä¸å¼€ RunLoopï¼Œè€Œä¸”ææœ‰å¯èƒ½æ˜¯ç”¨å®šæ—¶å™¨ NSTimer æˆ–è€… CADisplayLink å®ç°çš„ã€‚ä¸‹é¢æˆ‘ä»¬æ¥å¯¹ YYAnimatedImageView çš„å®ç°å‰–æï¼ŒéªŒè¯ä¸€ä¸‹æˆ‘ä»¬åˆšæ‰çš„çŒœæƒ³ã€‚</p>
<h4 id="YYAnimatedImageView-çš„å®ç°å‰–æ"><a href="#YYAnimatedImageView-çš„å®ç°å‰–æ" class="headerlink" title="YYAnimatedImageView çš„å®ç°å‰–æ"></a>YYAnimatedImageView çš„å®ç°å‰–æ</h4><p>YYAnimatedImageView å†…éƒ¨å®ç°æºç å¾ˆæœ‰è¶£ï¼Œæœ‰å¾ˆå¤šå€¼å¾—åˆ†äº«çš„åœ°æ–¹ã€‚ä¸è¿‡ä¸ºäº†ä¸æŠŠæ–‡ç« å†™æˆ MarkDown ç¼–è¾‘å™¨æ–‡ï¼ˆç¬‘~ï¼‰ç¬”è€…ä¸ä¼šé€è¡Œç¿»è¯‘æºç ã€‚è¯»è€…å¦‚æœæƒ³è¦çŸ¥é“å®ç°çš„ç»†èŠ‚å»ºè®®ç»“åˆæ–‡ç« å»ç¿»é˜…æºç ã€‚ç›¸ä¿¡æœ‰äº†æ–‡ç« æ¢³ç†çš„æ€è·¯æºç çœ‹èµ·æ¥åº”è¯¥ä¸ä¼šæœ‰å¤ªå¤§çš„å›°éš¾ï¼Œæ–‡ç« è¿˜æ˜¯é‡åœ¨ä¼ æ’­å®ç°æ€æƒ³å’Œä¸€äº›å€¼å¾—åˆ†äº«çš„æŠ€å·§ã€‚</p>
<p>æˆ‘ä»¬å…ˆç®€å•çœ‹ä¸€ä¸‹ YYAnimatedImageView çš„å†…éƒ¨ç»“æ„ï¼Œæ–¹ä¾¿åé¢åˆ†æå®ç°æ€è·¯æ—¶å¤§å®¶è„‘ä¸­å¯¹ YYAnimatedImageView çš„ç»“æ„æå‰æœ‰ä¸€ä¸ªå¤§æ¦‚çš„è®¤è¯†ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYAnimatedImageView</span>() </span>&#123;</span><br><span class="line">    <span class="keyword">@package</span></span><br><span class="line">    <span class="built_in">UIImage</span> &lt;YYAnimatedImage&gt; *_curAnimatedImage; <span class="comment">///&lt; å½“å‰å›¾åƒ</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_once_t</span> _onceToken; <span class="comment">///&lt; ç”¨äºç¡®ä¿åˆå§‹åŒ–ä»£ç åªæ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">    dispatch_semaphore_t _lock; <span class="comment">///&lt; ä¿¡å·é‡é”ï¼ˆç”¨äº _bufferï¼‰</span></span><br><span class="line">    <span class="built_in">NSOperationQueue</span> *_requestQueue; <span class="comment">///&lt; å›¾ç‰‡è¯·æ±‚é˜Ÿåˆ—ï¼Œä¸²è¡Œ</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CADisplayLink</span> *_link; <span class="comment">///&lt; å¸§è½¬æ¢</span></span><br><span class="line">    <span class="built_in">NSTimeInterval</span> _time; <span class="comment">///&lt; ä¸Šä¸€å¸§ä¹‹åçš„æ—¶é—´</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIImage</span> *_curFrame; <span class="comment">///&lt; å½“å‰å¸§</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> _curIndex; <span class="comment">///&lt; å½“å‰å¸§ç´¢å¼•</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> _totalFrameCount; <span class="comment">///&lt; å¸§æ€»æ•°</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">BOOL</span> _loopEnd; <span class="comment">///&lt; æ˜¯å¦åœ¨å¾ªç¯æœ«å°¾</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> _curLoop; <span class="comment">///&lt; å½“å‰å¾ªç¯æ¬¡æ•°</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> _totalLoop; <span class="comment">///&lt; æ€»å¾ªç¯æ¬¡æ•°, 0 è¡¨ç¤ºæ— ç©·</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *_buffer; <span class="comment">///&lt; å¸§ç¼“å†²åŒº</span></span><br><span class="line">    <span class="type">BOOL</span> _bufferMiss; <span class="comment">///&lt; æ˜¯å¦ä¸¢å¸§ï¼Œåœ¨ä¸Šé¢ _link å®šæ—¶æ‰§è¡Œçš„ step å‡½æ•°ä¸­ä»å¸§ç¼“å†²åŒºè¯»å–ä¸‹ä¸€å¸§å›¾ç‰‡æ—¶å¦‚æœæ²¡è¯»åˆ°ï¼Œåˆ™è§†ä¸ºä¸¢å¸§</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> _maxBufferCount; <span class="comment">///&lt; æœ€å¤§ç¼“å†²è®¡æ•°</span></span><br><span class="line">    <span class="built_in">NSInteger</span> _incrBufferCount; <span class="comment">///&lt; å½“å‰å…è®¸çš„ç¼“å­˜åŒºè®¡æ•°ï¼ˆå°†é€æ­¥å¢åŠ ï¼‰</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGRect</span> _curContentsRect; <span class="comment">///&lt; é’ˆå¯¹ YYSpriteSheetImage</span></span><br><span class="line">    <span class="type">BOOL</span> _curImageHasContentsRect; <span class="comment">///&lt; å›¾åƒç±»æ˜¯å¦å®ç°äº† animatedImageContentsRectAtIndex: æ¥å£</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readwrite</span>) <span class="type">BOOL</span> currentIsPlayingAnimation;</span><br><span class="line">- (<span class="type">void</span>)calcMaxBufferCount; <span class="comment">// åŠ¨æ€è°ƒèŠ‚ç¼“å†²åŒºæœ€å¤§é™åˆ¶ _maxBufferCount</span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ° YYAnimatedImageView å†…éƒ¨ç»“æ„æ¯” .h ä¸­æš´éœ²çš„å±æ€§è¦å¤æ‚çš„å¤šï¼Œè€Œ <code>CADisplayLink *_link</code> å±æ€§ä¹Ÿè¯å®äº†æˆ‘ä»¬ä¹‹å‰å…³äº .h ä¸­ <code>runloopMode</code> å±æ€§çš„çŒœæƒ³ã€‚</p>
<p>YYAnimatedImageView å†…éƒ¨çš„åˆå§‹åŒ–æ²¡ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„ï¼Œåˆå§‹åŒ–å‡½æ•°ä¸­ä¼šè®¾ç½®å›¾ç‰‡ï¼Œå½“åˆ¤å®šå›¾ç‰‡æœ‰æ›´æ”¹æ—¶ä¼šä¾ç…§ä¸‹é¢ 4 æ­¥å»å¤„ç†ï¼š</p>
<ul>
<li>æ”¹å˜å›¾ç‰‡</li>
<li>é‡ç½®åŠ¨ç”»</li>
<li>åˆå§‹åŒ–åŠ¨ç”»å‚æ•°</li>
<li>é‡ç»˜</li>
</ul>
<blockquote>
<p>Note: è¿™æ ·å¯ä»¥ä¿è¯ YYAnimatedImageView çš„å›¾ç‰‡æ›´æ”¹æ—¶éƒ½ä¼šæ‰§è¡Œä¸Šé¢çš„æ­¥éª¤ä¸ºæ–°çš„å›¾ç‰‡åˆå§‹åŒ–é…å¥—çš„æ–°åŠ¨ç”»å‚æ•°å¹¶ä¸”é‡ç»˜ï¼Œè€Œé‡ç½®åŠ¨ç”»å®ç°ä¸­ä¼šä½¿ç”¨åˆ°ä¸Šé¢çš„ <code>dispatch_once_t _onceToken;</code> ä»¥ç¡®ä¿æŸäº›å†…éƒ¨å˜é‡çš„åˆ›å»ºä»¥åŠå¯¹ App å†…å­˜è­¦å‘Šå’Œè¿›å…¥åå°çš„é€šçŸ¥è§‚å¯Ÿä»£ç åªæ‰§è¡Œä¸€æ¬¡ã€‚</p>
</blockquote>
<p>YYAnimatedImageView ä½¿å›¾ç‰‡åŠ¨èµ·æ¥æ˜¯ä¾é  <code>CADisplayLink *_link;</code> å˜é‡åˆ‡æ¢å¸§å›¾åƒï¼Œå…¶å†…éƒ¨çš„å®ç°é€»è¾‘å¯ä»¥ç®€å•ç†è§£ä¸ºï¼š</p>
<ul>
<li>æ ¹æ®å½“å‰å¸§ç´¢å¼•æ¨å‡ºä¸‹ä¸€å¸§ç´¢å¼•</li>
<li>ä½¿ç”¨ä¸‹ä¸€å¸§ç´¢å¼•å»å¸§ç¼“å†²åŒºå°è¯•è·å–å¯¹åº”å¸§å›¾åƒ</li>
<li>å¦‚æœæ‰¾åˆ°å¯¹åº”å¸§å›¾åƒåˆ™ä½¿ç”¨å…¶é‡ç»˜</li>
<li>å¦‚æœæ²¡æ‰¾åˆ°åˆ™æ ¹æ®æ¡ä»¶å‘å›¾ç‰‡è¯·æ±‚é˜Ÿåˆ—åŠ å…¥è¯·æ±‚æ“ä½œï¼ˆå‘å›¾ç‰‡ç¼“å†²åŒºå½•å…¥ä¹‹åçš„å¸§å›¾åƒæ•°æ®ï¼‰</li>
</ul>
<p>å˜›~ è¿™é‡Œé¢æœ‰ä¸€äº›å€¼å¾—ä¸€æçš„å®ç°ç»†èŠ‚å“ˆï¼</p>
<blockquote>
<ul>
<li>YYAnimatedImageView å®ç°ä¸­å½“ <code>_curIndex</code> å³å½“å‰å¸§ç´¢å¼•ä¿®æ”¹æ—¶åœ¨ä¿®æ”¹ä»£ç å‰ååŠ å…¥äº† <code>willChangeValueForKey:</code> ä¸ <code>didChangeValueForKey:</code> æ–¹æ³•ä»¥æ”¯æŒ KVO</li>
<li>å¯¹å¸§ç¼“å†²åŒº <code>_buffer</code> çš„æ“ä½œéƒ½ä½¿ç”¨ <code>_lock</code> ä¸Šé”</li>
<li>é€šè¿‡å°†å›¾ç‰‡è¯·æ±‚é˜Ÿåˆ— <code>_requestQueue</code> çš„ <code>maxConcurrentOperationCount</code> è®¾ç½®ä¸º 1 ä½¿å›¾ç‰‡è¯·æ±‚é˜Ÿåˆ—æˆä¸ºä¸²è¡Œé˜Ÿåˆ—ï¼ˆæœ€å¤§å¹¶å‘æ•°ä¸º 1ï¼‰</li>
<li>å›¾ç‰‡è¯·æ±‚é˜Ÿåˆ—ä¸­åŠ å…¥çš„æ“ä½œå‡ä¸º <code>_YYAnimatedImageViewFetchOperation</code></li>
<li>ä¸ºäº†é¿å…ä½¿ç”¨ <code>CADisplayLink</code> å¯èƒ½é€ æˆçš„å¾ªç¯å¼•ç”¨è®¾è®¡äº† <code>_YYImageWeakProxy</code></li>
</ul>
</blockquote>
<p>å…ˆçœ‹ä¸€ä¸‹ <code>_YYAnimatedImageViewFetchOperation</code> çš„æºç ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">_YYAnimatedImageViewFetchOperation</span> : <span class="title">NSOperation</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) YYAnimatedImageView *view;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSUInteger</span> nextIndex;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIImage</span> &lt;YYAnimatedImage&gt; *curImage;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">_YYAnimatedImageViewFetchOperation</span></span></span><br><span class="line">- (<span class="type">void</span>)main &#123;<span class="comment">//...&#125;</span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p><code>_YYAnimatedImageViewFetchOperation</code> ç»§æ‰¿è‡ª NSOperation ç±»ï¼Œæ˜¯è‡ªå®šä¹‰æ“ä½œç±»ï¼Œä½œè€…å°†å…¶æ“ä½œå†…å®¹å®ç°å†™åœ¨äº† <code>main</code> ä¸­ï¼Œä»£ç å¤ªé•¿è€Œä¸”æˆ‘è§‰å¾—è´´å‡ºæ¥ä¸ä»…ä¸ä¼šå¸®åŠ©è¯»è€…ç†è§£åè€Œä¼šå› ä¸ºç‰‡é¢çš„æºç å®ç°å½±å“è¯»è€…å¯¹ YYAnimatedImageView çš„æ•´ä½“å®ç°æ€è·¯ç†è§£ï¼ˆå› ä¸ºå¤§é‡è´´æºç ä¼šä½¿æ–‡ç« ç”Ÿæ¶©å¾ˆå¤šï¼Œè€Œä¸”ä¼šæŠŠè¯»è€…æ³¨æ„åŠ›è½¬ç§»åˆ°æŸä¸€ä¸ªå®ç°ï¼‰ï¼Œè¿™é‡Œç®€å•æè¿°ä¸€ä¸‹ <code>main</code> å‡½æ•°å†…éƒ¨å®ç°é€»è¾‘ï¼š</p>
<ul>
<li>åˆ¤æ–­å¸§ç¼“å†²åŒºå¤§å°</li>
<li>æ‰«æä¸‹ä¸€å¸§ä»¥åŠå½“å‰å…è®¸ç¼“å†²èŒƒå›´å†…ä¹‹åçš„å¸§å›¾ç‰‡</li>
<li>å¦‚æœå‘ç°ä¸¢å¤±çš„å¸§åˆ™å°è¯•é‡æ–°è·å–å¸§å›¾åƒå¹¶åŠ å…¥åˆ°å¸§ç¼“å†²</li>
</ul>
<p>å˜›~ ä¸è´´æºç å½’ä¸è´´æºç ï¼Œè¯¥æ³¨æ„çš„ç»†èŠ‚è¿˜æ˜¯éœ€è¦åˆ—å‡ºæ¥çš„ï¼ˆç¬‘ï¼‰ã€‚</p>
<blockquote>
<ul>
<li>æ“ä½œä¸­å¯¹äº <code>view</code> ç¼“å†²åŒºçš„æ“ä½œä¹Ÿéƒ½ä¸Šäº†é”</li>
<li>æ“ä½œç”±äºæ˜¯æ”¾å…¥å›¾ç‰‡è¯·æ±‚é˜Ÿåˆ—ä¸­è¿›è¡Œçš„ï¼Œå†…éƒ¨æœ‰å¯¹ <code>isCancelled</code> åšåˆ¤æ–­ï¼Œå¦‚æœæ“ä½œå·²ç»è¢«å–æ¶ˆï¼ˆå‘ç”Ÿåœ¨æ›´æ”¹å›¾ç‰‡ã€åœæ­¢åŠ¨ç”»ã€æ‰‹åŠ¨æ›´æ”¹å½“å‰å¸§ã€æ”¶åˆ°å†…å­˜è­¦å‘Šæˆ– App è¿›å…¥åå°ç­‰ï¼‰åˆ™éœ€è¦åŠæ—¶è·³å‡º</li>
<li>å¯¹äºæ–°çš„çº¿ç¨‹ä¼˜å…ˆçº§åªåœ¨ <code>main</code> æ–¹æ³•èŒƒå›´å†…æœ‰æ•ˆï¼Œæ‰€ä»¥æ¨èæŠŠæ“ä½œçš„å®ç°æ”¾åœ¨ <code>main</code> ä¸­è€Œé <code>start</code>ï¼ˆå¦‚éœ€è¦†ç›– start æ–¹æ³•æ—¶ï¼Œéœ€è¦å…³æ³¨ <code>isExecuting</code> å’Œ <code>isFinished</code> ä¸¤ä¸ª key pathsï¼‰</li>
</ul>
</blockquote>
<p>YYAnimatedImageView å†…éƒ¨è®¾è®¡äº† <code>_YYImageWeakProxy</code> æ¥é¿å…ä½¿ç”¨ NSTimer æˆ–è€… CADisplayLink å¯èƒ½é€ æˆçš„å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œ<code>_YYImageWeakProxy</code> å†…éƒ¨å®ç°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œç»§æ‰¿è‡ª NSProxyï¼Œå…³äº NSProxy å¯ä»¥æŸ¥çœ‹<a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/foundation/nsproxy">å®˜æ–¹æ–‡æ¡£</a>ä»¥äº†è§£æ›´å¤šã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">_YYImageWeakProxy</span> : <span class="title">NSProxy</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>, <span class="keyword">readonly</span>) <span class="type">id</span> target;</span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithTarget:(<span class="type">id</span>)target;</span><br><span class="line">+ (<span class="keyword">instancetype</span>)proxyWithTarget:(<span class="type">id</span>)target;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">_YYImageWeakProxy</span></span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">- (<span class="type">id</span>)forwardingTargetForSelector:(SEL)selector &#123;</span><br><span class="line">    <span class="keyword">return</span> _target;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="type">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)invocation &#123;</span><br><span class="line">    <span class="type">void</span> *null = <span class="literal">NULL</span>;</span><br><span class="line">    [invocation setReturnValue:&amp;null];</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)selector &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSObject</span> instanceMethodSignatureForSelector:<span class="keyword">@selector</span>(init)];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢è´´å‡ºçš„æºç çœç•¥äº†æ¯”è¾ƒåŸºç¡€çš„å®ç°éƒ¨åˆ†ï¼Œ<code>_YYImageWeakProxy</code> å†…éƒ¨å¼±å¼•ç”¨ä¸€ä¸ªå¯¹è±¡ targetï¼Œå¯¹äº <code>_YYImageWeakProxy</code> çš„ä¸€äº›åŸºæœ¬æ“ä½œåŒ…å« <code>hash</code> å’Œ <code>isEqual</code> è¿™äº›ç»Ÿç»Ÿéƒ½è½¬åˆ° target ä¸Šï¼Œå¹¶ä¸”ä½¿ç”¨ <code>forwardingTargetForSelector:</code> æ¶ˆæ¯é‡å®šå‘å°†ä¸èƒ½å“åº”çš„è¿è¡Œæ—¶æ¶ˆæ¯ä¹Ÿé‡å®šå‘ç»™ target æ¥å“åº”ã€‚</p>
<p>Emmmmm..é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæ—¢ç„¶éƒ½æ¶ˆæ¯é‡å®šå‘ç»™ target äº†è¿˜è¦æ¶ˆæ¯è½¬å‘å¹²å˜›ï¼Ÿå› ä¸ºè¦é¿å…å¾ªç¯å¼•ç”¨é—®é¢˜æ‰€ä»¥å¯¹ target ä½¿ç”¨å¼±å¼•ç”¨ï¼ŒæœŸé—´æ— æ³•ä¿è¯ target ä¸€å®šå­˜åœ¨ï¼Œæ‰€ä»¥ <code>forwardingTargetForSelector:</code> æ–¹æ³•å¯èƒ½è¿”å› nilï¼Œæ¥ç€åœ¨ Runtime æ¶ˆæ¯è½¬å‘ä¸­å€Ÿç”¨ init æ¶ˆæ¯è¿”å›ç©ºä»¥â€œåæ‰â€å¼‚å¸¸ã€‚</p>
<blockquote>
<p>Note: æ¶ˆæ¯è½¬å‘äº§ç”Ÿçš„å¼€é”€è¦æ¯”åŠ¨æ€æ–¹æ³•è§£æå’Œæ¶ˆæ¯é‡å®šå‘å¤§ã€‚</p>
</blockquote>
<h2 id="YYImageCoder"><a href="#YYImageCoder" class="headerlink" title="YYImageCoder"></a>YYImageCoder</h2><img src="/yyimage/image_coder.jpg" class="">
<p>YYImageCoder ä½œä¸º YYImage çš„ç¼–/è§£ç å™¨ï¼Œå¯¹åº”äº iOS ä¸­çš„ ImageIO.framework å›¾ç‰‡ç¼–/è§£ç åº“ï¼Œæ­£æ˜¯å› ä¸ºæœ‰äº† YYImageCoder çš„å­˜åœ¨ï¼ŒYYImage æ‰å¾—ä»¥æ”¯æŒå¦‚æ­¤å¤šçš„å›¾ç‰‡æ ¼å¼ï¼Œæ‰€ä»¥è¯´ YYImageCoder æ˜¯ YYImage çš„åº•å±‚æ ¸å¿ƒã€‚</p>
<p>YYImageCoder å†…éƒ¨å®šä¹‰äº†è®¸å¤š YYImage ä¸­ç”¨åˆ°çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š</p>
<ul>
<li>YYImageTypeï¼Œæ‰€æœ‰çš„æ”¯æŒçš„å›¾ç‰‡æ ¼å¼åšäº†æšä¸¾å®šä¹‰</li>
<li>YYImageDisposeMethodï¼ŒæŒ‡å®šåœ¨ç”»å¸ƒä¸Šæ¸²æŸ“ä¸‹ä¸€ä¸ªå¸§ä¹‹å‰å¦‚ä½•å¤„ç†å½“å‰å¸§æ‰€ä½¿ç”¨çš„åŒºåŸŸæ–¹æ³•</li>
<li>YYImageBlendOperationï¼ŒæŒ‡å®šå½“å‰å¸§çš„é€æ˜åƒç´ å¦‚ä½•ä¸å‰ä¸€ä¸ªç”»å¸ƒçš„é€æ˜åƒç´ æ··åˆæ“ä½œ</li>
<li>YYImageFrameï¼Œä¸€å¸§å›¾åƒæ•°æ®</li>
<li>YYImageEncoderï¼Œå›¾åƒç¼–ç å™¨</li>
<li>YYImageDecoderï¼Œå›¾åƒè§£ç å™¨</li>
<li>UIImage+YYImageCoderï¼ŒUIImage çš„åˆ†ç±»ï¼Œé‡Œé¢æä¾›äº†ä¸€äº›æ–¹ä¾¿ä½¿ç”¨çš„æ–¹æ³•</li>
</ul>
<p>å…¶ä¸­ YYImageFrame æ˜¯å¯¹ä¸€å¸§å›¾åƒæ•°æ®çš„å°è£…ï¼Œä¾¿äºåœ¨ YYImageCoder ç¼–/è§£ç è¿‡ç¨‹ä¸­ä½¿ç”¨ã€‚</p>
<p>YYImageCoder å†…éƒ¨å›¾åƒç¼–ç å™¨ YYImageEncoder å’Œå›¾åƒè§£ç å™¨ YYImageDecoder å…¶å®æ˜¯åˆ†å¼€æ¥çš„ï¼Œæˆ‘ä»¬ä¸‹é¢åˆ†åˆ«å¯¹å®ƒä»¬åšåˆ†æã€‚</p>
<h3 id="YYImageEncoder"><a href="#YYImageEncoder" class="headerlink" title="YYImageEncoder"></a>YYImageEncoder</h3><p>å…ˆæ¥è®²ä¸€ä¸‹ YYImageEncoderï¼Œå…¶åœ¨ YYImageCoder ä¸­æ‹…ä»»ç¼–ç å™¨çš„è§’è‰²ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYImageEncoder</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) YYImageType type; <span class="comment">///&lt; å›¾åƒç±»å‹</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">NSUInteger</span> loopCount;       <span class="comment">///&lt; å¾ªç¯æ¬¡æ•°ï¼Œ0 æ— é™å¾ªç¯ï¼Œä»…é€‚ç”¨äº GIF/APNG/WebP æ ¼å¼</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="type">BOOL</span> lossless;              <span class="comment">///&lt; æ— æŸæ ‡è®°ï¼Œä»…é€‚ç”¨äº WebP.</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span> quality;            <span class="comment">///&lt; å‹ç¼©è´¨é‡ï¼Œ0.0~1.0ï¼Œä»…é€‚ç”¨äº JPG/JP2/WebP.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¦æ­¢é€‚ç”¨ initã€new åˆå§‹åŒ–ç¼–ç å™¨ï¼ˆæˆ‘æ²¡å¿˜è®°æˆ‘è¯´è¿‡è¿™äº›ç¼–ç æŠ€å·§ä¼šåœ¨ä¹‹åç»Ÿä¸€å†™ä¸€ç¯‡æ–‡ç« æ±‡æ€»ï¼‰</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)init UNAVAILABLE_ATTRIBUTE;</span><br><span class="line">+ (<span class="keyword">instancetype</span>)new UNAVAILABLE_ATTRIBUTE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®ç»™å®šå›¾ç‰‡ç±»å‹åˆ›å»ºç¼–ç å™¨</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithType:(YYImageType)type <span class="built_in">NS_DESIGNATED_INITIALIZER</span>;</span><br><span class="line"><span class="comment">// æ·»åŠ å›¾åƒ</span></span><br><span class="line">- (<span class="type">void</span>)addImage:(<span class="built_in">UIImage</span> *)image duration:(<span class="built_in">NSTimeInterval</span>)duration;</span><br><span class="line"><span class="comment">// æ·»åŠ å›¾åƒæ•°æ®</span></span><br><span class="line">- (<span class="type">void</span>)addImageWithData:(<span class="built_in">NSData</span> *)data duration:(<span class="built_in">NSTimeInterval</span>)duration;</span><br><span class="line"><span class="comment">// æ·»åŠ æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">- (<span class="type">void</span>)addImageWithFile:(<span class="built_in">NSString</span> *)path duration:(<span class="built_in">NSTimeInterval</span>)duration;</span><br><span class="line"><span class="comment">// å¼€å§‹å›¾åƒç¼–ç å¹¶å°è¯•è¿”å›ç¼–ç åçš„æ•°æ®</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)encode;</span><br><span class="line"><span class="comment">// ç¼–ç å¹¶å°†å¾—åˆ°çš„æ•°æ®ä¿å­˜åˆ°ç»™å®šè·¯å¾„æ–‡ä»¶ä¸­</span></span><br><span class="line">- (<span class="type">BOOL</span>)encodeToFile:(<span class="built_in">NSString</span> *)path;</span><br><span class="line"><span class="comment">// ä¾¿æ·æ–¹æ³•ï¼Œå¯¹ä¸€ä¸ªå•å¸§å›¾åƒç¼–ç </span></span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)encodeImage:(<span class="built_in">UIImage</span> *)image type:(YYImageType)type quality:(<span class="built_in">CGFloat</span>)quality;</span><br><span class="line"><span class="comment">// ä¾¿æ·æ–¹æ³•ï¼Œä»è§£ç å™¨ä¸­ç¼–ç å›¾åƒæ•°æ®</span></span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)encodeImageWithDecoder:(YYImageDecoder *)decoder type:(YYImageType)type quality:(<span class="built_in">CGFloat</span>)quality;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ° YYImageEncoder å†…éƒ¨çš„ä¸€äº›å±æ€§å’Œæ¥å£éƒ½æ¯”è¾ƒåŸºæœ¬ï¼Œå…³äºå…¶å†…éƒ¨å®ç°æˆ‘ä»¬éœ€è¦å…ˆçœ‹ä¸€ä¸‹ç§æœ‰å˜é‡ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYImageEncoder</span> </span>&#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *_images; <span class="comment">// å·²æ·»åŠ åˆ°ç¼–ç å™¨çš„å›¾ç‰‡ï¼ˆæ•°ç»„ï¼‰</span></span><br><span class="line">    <span class="built_in">NSMutableArray</span> *_durations; <span class="comment">// å¯¹åº”çš„å›¾ç‰‡å¸§æ˜¾ç¤ºæŒç»­æ—¶é•¿ï¼ˆæ•°ç»„ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="YYImageEncoder-çš„å®ç°æ€è·¯"><a href="#YYImageEncoder-çš„å®ç°æ€è·¯" class="headerlink" title="YYImageEncoder çš„å®ç°æ€è·¯"></a>YYImageEncoder çš„å®ç°æ€è·¯</h4><p>YYImageEncoder çš„åˆå§‹åŒ–éƒ¨åˆ†æ²¡æœ‰å¤šå¤æ‚ï¼Œæ ¹æ®å›¾ç‰‡çš„ç±»å‹æŒ‰ç…§ç¼–ç æœ€ä¼˜çš„å‚æ•°åšåˆå§‹åŒ–è€Œå·²ã€‚å…³äº YYImageEncoder å¯¹äºå›¾ç‰‡çš„ç¼–ç å·¥ä½œï¼Œå…¶å®ä½œè€…æ ¹æ®è¦æ”¯æŒçš„å›¾ç‰‡ç±»å‹å’Œå¯¹åº”å›¾ç‰‡ç±»å‹çš„ç¼–ç æ–¹å¼åšäº†åº•å±‚å°è£…ï¼Œå†æ ¹æ®å½“å‰å›¾ç‰‡çš„ç±»å‹é€‰æ‹©å¯¹åº”çš„åº•å±‚ç¼–ç æ–¹æ³•æ‰§è¡Œã€‚</p>
<p>å…³äºä¸åŒå›¾ç‰‡ç±»å‹çš„å›¾ç‰‡ç¼–ç æ ¼å¼å¯ä»¥æŸ¥é˜…æœ¬æ–‡æ–‡æœ«çš„æ‰©å±•é˜…è¯»ç« èŠ‚ï¼Œç»“åˆæ‰©å±•é˜…è¯»çš„å†…å®¹æŸ¥é˜… YYImage è¿™éƒ¨åˆ†æºç å¯ä»¥ç†è§£ä½œè€…å¯¹äºåº•å±‚å›¾ç‰‡æ ¼å¼ä¿¡æ¯çš„ç»“æ„å°è£…ä»¥åŠç¼–/è§£ç æ“ä½œå…·ä½“å®ç°ã€‚</p>
<p>å…³äº YYImageEncoder çš„ä¸€äº›ç®€å•ä½¿ç”¨ç¤ºä¾‹å¯ä»¥æŸ¥çœ‹ <a target="_blank" rel="noopener" href="https://github.com/ibireme/YYImage/blob/master/YYImage/YYImageCoder.h#L216">YYImageCoder.h</a> äº†è§£ã€‚</p>
<h3 id="YYImageDecoder"><a href="#YYImageDecoder" class="headerlink" title="YYImageDecoder"></a>YYImageDecoder</h3><p>YYImageDecoder åœ¨ YYImageCoder ä¸­æ‹…ä»»è§£ç å™¨çš„è§’è‰²ï¼Œå…¶ä¸ä¸Šè¿° YYImageEncoder å¯¹åº”ï¼Œä¸€ä¸ªè´Ÿè´£å›¾åƒç¼–ç ä¸€ä¸ªè´Ÿè´£å›¾åƒè§£ç ï¼Œä¸è¿‡ YYImageDecoder çš„å®ç°æ¯” YYImageEncoder æ›´ä¸ºå¤æ‚ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYImageDecoder</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSData</span> *data;    <span class="comment">///&lt; å›¾åƒæ•°æ®</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) YYImageType type;          <span class="comment">///&lt; å›¾åƒæ•°æ®ç±»å‹</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">CGFloat</span> scale;             <span class="comment">///&lt; å›¾åƒå¤§å°</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> frameCount;     <span class="comment">///&lt; å›¾åƒå¸§æ•°é‡</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> loopCount;      <span class="comment">///&lt; å›¾åƒå¾ªç¯æ¬¡æ•°ï¼Œ0 æ— é™å¾ªç¯</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> width;          <span class="comment">///&lt; å›¾åƒç”»å¸ƒå®½åº¦</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> height;         <span class="comment">///&lt; å›¾åƒç”»å¸ƒé«˜åº¦</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>, <span class="keyword">getter</span>=isFinalized) <span class="type">BOOL</span> finalized;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªå›¾åƒè§£ç å™¨</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithScale:(<span class="built_in">CGFloat</span>)scale <span class="built_in">NS_DESIGNATED_INITIALIZER</span>;</span><br><span class="line"><span class="comment">// ç”¨æ–°æ•°æ®å¢é‡æ›´æ–°å›¾åƒ</span></span><br><span class="line">- (<span class="type">BOOL</span>)updateData:(<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)data final:(<span class="type">BOOL</span>)final;</span><br><span class="line"><span class="comment">// æ–¹ä¾¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„æ•°æ®åˆ›å»ºå¯¹åº”çš„è§£ç å™¨</span></span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)decoderWithData:(<span class="built_in">NSData</span> *)data scale:(<span class="built_in">CGFloat</span>)scale;</span><br><span class="line"><span class="comment">// è§£ç å¹¶è¿”å›ç»™å®šç´¢å¼•å¯¹åº”çš„å¸§æ•°æ®</span></span><br><span class="line">- (<span class="keyword">nullable</span> YYImageFrame *)frameAtIndex:(<span class="built_in">NSUInteger</span>)index decodeForDisplay:(<span class="type">BOOL</span>)decodeForDisplay;</span><br><span class="line"><span class="comment">// è¿”å›ç»™å®šç´¢å¼•å¯¹åº”çš„å¸§æŒç»­æ˜¾ç¤ºæ—¶é•¿</span></span><br><span class="line">- (<span class="built_in">NSTimeInterval</span>)frameDurationAtIndex:(<span class="built_in">NSUInteger</span>)index;</span><br><span class="line"><span class="comment">// è¿”å›ç»™å®šç´¢å¼•å¯¹åº”å¸§çš„å±æ€§ä¿¡æ¯ï¼Œå» ImageIO.framework çš„ &quot;CGImageProperties.h&quot; æ–‡ä»¶ä¸­äº†è§£æ›´å¤š</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span> *)framePropertiesAtIndex:(<span class="built_in">NSUInteger</span>)index;</span><br><span class="line"><span class="comment">// è¿”å›å›¾ç‰‡çš„å±æ€§ä¿¡æ¯ï¼Œå» ImageIO.framework çš„ &quot;CGImageProperties.h&quot; æ–‡ä»¶ä¸­äº†è§£æ›´å¤š</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span> *)imageProperties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ° YYImageDecoder æš´éœ²äº†ä¸€äº›å…³äºè§£ç å›¾åƒçš„å±æ€§å¹¶æä¾›äº†åˆå§‹åŒ–è§£ç å™¨æ–¹æ³•ã€å›¾åƒè§£ç æ–¹æ³•ä»¥åŠè®¿é—®å›¾åƒå¸§ä¿¡æ¯çš„æ–¹æ³•ã€‚ä¸è¿‡ä¸Šæ–‡ä¹Ÿè¯´è¿‡ YYImageDecoder çš„å®ç°æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬æ¥ç€çœ‹ä¸€ä¸‹å…¶å†…éƒ¨å˜é‡ç»“æ„ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYImageDecoder</span> </span>&#123;</span><br><span class="line">    pthread_mutex_t _lock; <span class="comment">// é€’å½’é”</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">BOOL</span> _sourceTypeDetected; <span class="comment">// æ˜¯å¦æ¨æµ‹å›¾åƒæºç±»å‹</span></span><br><span class="line">    <span class="built_in">CGImageSourceRef</span> _source; <span class="comment">// å›¾åƒæº</span></span><br><span class="line">    yy_png_info *_apngSource; <span class="comment">// å¦‚æœåˆ¤å®šå›¾åƒä¸º YYImageTypePNG åˆ™ä¼šä»¥ APNG æ›´æ–°å›¾åƒæº</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> YYIMAGE_WEBP_ENABLED</span></span><br><span class="line">    WebPDemuxer *_webpSource; <span class="comment">// å¦‚æœåˆ¤å®šå›¾åƒä¸º YYImageTypeWebP åˆ™ä¼šè®® WebP æ›´æ–°å›¾åƒæº</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIImageOrientation</span> _orientation; <span class="comment">// ç»˜åˆ¶æ–¹å‘</span></span><br><span class="line">    dispatch_semaphore_t _framesLock; <span class="comment">// é’ˆå¯¹äºå›¾åƒå¸§çš„é”</span></span><br><span class="line">    <span class="built_in">NSArray</span> *_frames; <span class="comment">///&lt; Array&lt;_YYImageDecoderFrame *&gt;, without image</span></span><br><span class="line">    <span class="type">BOOL</span> _needBlend; <span class="comment">// æ˜¯å¦éœ€è¦æ··åˆ</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> _blendFrameIndex; <span class="comment">// ä»å¸§ç´¢å¼•æ··åˆåˆ°å½“å‰å¸§</span></span><br><span class="line">    <span class="built_in">CGContextRef</span> _blendCanvas; <span class="comment">// æ··åˆç”»å¸ƒ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>_YYImageDecoderFrame</code> ç»§æ‰¿è‡ª YYImageFrame ç±»ä½œä¸º YYImageCoder å›¾åƒè§£ç å™¨ YYImageDecoder ä½¿ç”¨çš„å†…éƒ¨æ¡†æ¶ç±»å­˜åœ¨ï¼Œæ˜¯å¯¹äºä¸€å¸§å›¾åƒçš„æ•°æ®å°è£…æä¾›äº†ä¾¿äºç¼–/è§£ç æ—¶éœ€è¦è®¿é—®çš„æ•°æ®ã€‚</p>
<h4 id="YYImageDecoder-å†…é”çš„é€‰æ‹©"><a href="#YYImageDecoder-å†…é”çš„é€‰æ‹©" class="headerlink" title="YYImageDecoder å†…é”çš„é€‰æ‹©"></a>YYImageDecoder å†…é”çš„é€‰æ‹©</h4><p>å¯ä»¥çœ‹åˆ°ä½œè€…åœ¨ YYImageDecoder å†…éƒ¨ä½¿ç”¨äº†ä¸¤ç§é”ï¼š</p>
<ul>
<li><code>pthread_mutex_t _lock;</code></li>
<li><code>dispatch_semaphore_t _framesLock;</code></li>
</ul>
<p><code>pthread_mutex_t</code> åœ¨è§£ç å™¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­è¢«ä»¥ <code>PTHREAD_MUTEX_RECURSIVE</code> ç±»å‹è®¾ç½®ä¸ºäº†é€’å½’é”ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pthread_mutexattr_t attr;</span><br><span class="line">pthread_mutexattr_init (&amp;attr);</span><br><span class="line">pthread_mutexattr_settype (&amp;attr, PTHREAD_MUTEX_RECURSIVE);</span><br><span class="line">pthread_mutex_init (&amp;_lock, &amp;attr);</span><br><span class="line">pthread_mutexattr_destroy (&amp;attr);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: ä¸€èˆ¬æƒ…å†µä¸‹ä¸€ä¸ªçº¿ç¨‹åªèƒ½ç”³è¯·ä¸€æ¬¡é”ï¼Œä¹Ÿåªèƒ½åœ¨è·å¾—é”çš„æƒ…å†µä¸‹æ‰èƒ½é‡Šæ”¾é”ï¼Œå¤šæ¬¡ç”³è¯·é”æˆ–é‡Šæ”¾æœªè·å¾—çš„é”éƒ½ä¼šå¯¼è‡´å´©æºƒã€‚å‡è®¾åœ¨å·²ç»è·å¾—é”çš„æƒ…å†µä¸‹å†æ¬¡ç”³è¯·é”ï¼Œçº¿ç¨‹ä¼šå› ä¸ºç­‰å¾…é”çš„é‡Šæ”¾è€Œè¿›å…¥ç¡çœ çŠ¶æ€ï¼Œå› æ­¤å°±ä¸å¯èƒ½å†é‡Šæ”¾é”ï¼Œä»è€Œå¯¼è‡´æ­»é”ã€‚</p>
<p>ç„¶è€Œè¿™ç§æƒ…å†µç»å¸¸ä¼šå‘ç”Ÿï¼Œæ¯”å¦‚æŸä¸ªå‡½æ•°ç”³è¯·äº†é”ï¼Œåœ¨ä¸´ç•ŒåŒºå†…åˆé€’å½’è°ƒç”¨äº†è‡ªå·±ã€‚è¾›è¿çš„æ˜¯ <code>pthread_mutex</code> æ”¯æŒé€’å½’é”ï¼Œä¹Ÿå°±æ˜¯å…è®¸ä¸€ä¸ªçº¿ç¨‹é€’å½’çš„ç”³è¯·é”ï¼Œåªè¦æŠŠ attr çš„ç±»å‹æ”¹æˆ <code>PTHREAD_MUTEX_RECURSIVE</code> å³å¯ã€‚</p>
</blockquote>
<p>ä½œè€…ä½¿ç”¨ <code>dispatch_semaphore_t</code> ä½œä¸ºå›¾åƒå¸§æ•°ç»„çš„é”æ˜¯å› ä¸º <code>dispatch_semaphore_t</code> æ›´åŠ è½»é‡ä¸”å¯¹äºå›¾åƒå¸§æ•°ç»„çš„ä¸´ç•Œæ“ä½œæ¯”è¾ƒå¿«ï¼Œä¸ä¼šé€ æˆé•¿æ—¶é—´çš„é˜»å¡ï¼Œè¿™ç§æƒ…å†µä¸‹ <code>dispatch_semaphore_t</code> å…·æœ‰æ€§èƒ½ä¼˜åŠ¿ï¼ˆEmmmmmm..è€ç”Ÿå¸¸è°ˆäº†ï¼Œç†Ÿæ‚‰çš„åŒå­¦ä¸è¦æŠ±æ€¨ï¼Œç…§é¡¾ä¸€ä¸‹åé¢çš„åŒå­¦ï¼‰ã€‚</p>
<h4 id="YYImageDecoder-å†…çš„å®ç°æ€è·¯"><a href="#YYImageDecoder-å†…çš„å®ç°æ€è·¯" class="headerlink" title="YYImageDecoder å†…çš„å®ç°æ€è·¯"></a>YYImageDecoder å†…çš„å®ç°æ€è·¯</h4><p>YYImageDecoder å†…åœ¨åˆå§‹åŒ–æ—¶ä¼šåˆå§‹åŒ–é”å¹¶æ›´æ–°å›¾åƒæºæ•°æ®ï¼Œåœ¨æ›´æ–°å›¾åƒæºæ—¶è°ƒç”¨ <code>_updateSource</code> æ–¹æ³•æ ¹æ®å½“å‰å›¾åƒç±»å‹ä»¥ä½œè€…å¯¹è¯¥ç±»å‹å°è£…å¥½çš„åº•å±‚æ•°æ®ç»“æ„å’Œå¯¹åº”å›¾åƒç±»å‹è§£ç è§„åˆ™åšè§£ç ï¼Œè§£ç ä¹‹åè®¾ç½®å¯¹åº”å±æ€§ã€‚</p>
<p>å…³äºä½œè€…å¯¹ä¸åŒæ ¼å¼çš„å›¾åƒæ•°æ®çš„åº•å±‚å°è£…æºç æ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å‚è€ƒæœ¬æ–‡æ–‡æœ«çš„æ‰©å±•é˜…è¯»ç« èŠ‚å†…å®¹è‡ªè¡ŒæŸ¥é˜…ã€‚</p>
<p>å…³äº YYImageDecoder çš„ä¸€äº›ç®€å•ä½¿ç”¨ç¤ºä¾‹å¯ä»¥æŸ¥çœ‹ <a target="_blank" rel="noopener" href="https://github.com/ibireme/YYImage/blob/master/YYImage/YYImageCoder.h#L106">YYImageCoder.h</a> äº†è§£ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul>
<li>æ–‡ç« ç³»ç»Ÿçš„åˆ†æäº† YYImage æºç ï¼Œå¸Œæœ›å„ä½è¯»è€…åœ¨é˜…è¯»æœ¬æ–‡ä¹‹åå¯ä»¥å¯¹ YYImage æ•´ä½“æ¶æ„å’Œè®¾è®¡æ€è·¯æœ‰æ¸…æ™°çš„è®¤è¯†ã€‚</li>
<li>æ–‡ç« å¯¹ YYImage çš„ Image å±‚çº§çš„ä¸‰ç±»å›¾åƒï¼ˆYYImage, YYFrameImage, YYSpriteSheetImageï¼‰åˆ†åˆ«è§£è¯»ï¼Œå¸Œæœ›å¯ä»¥å¯¹å„ä½è¯»è€…å…³äºè¿™ä¸‰ç±»å›¾åƒçš„ç»„æˆåŸç†å’Œå‘ˆç°åŠ¨ç”»çš„æ–¹å¼çš„ç†è§£æœ‰æ‰€å¸®åŠ©ã€‚</li>
<li>æ–‡ç« æ·±å…¥å‰–æäº† YYAnimatedImageView çš„å†…éƒ¨å®ç°ï¼Œæç‚¼å‡ºå…¶è®¾è®¡æ€è·¯ä»¥ä¾›è¯»è€…æ¢ç©¶ã€‚</li>
<li>ç¬”è€…æŠŠè‡ªå·±åœ¨é˜…è¯»æºç ä¸­å‘ç°çš„å€¼å¾—åˆ†äº«çš„å®ç°ç»†èŠ‚ç»“åˆæºç å•ç‹¬æ‹å‡ºæ¥åˆ†æï¼Œå¸Œæœ›å„ä½è¯»è€…å¯ä»¥åœ¨è‡ªå·±å¹³æ—¶å·¥ä½œä¸­é‡åˆ°ç›¸ä¼¼æƒ…å†µæ—¶èƒ½å¤Ÿå¤šä¸€äº›æ€è·¯ï¼Œå°è£…é¡¹ç›®ç»„ä»¶æ—¶å¯ä»¥ç”¨åˆ°è¿™äº›æŠ€å·§ã€‚</li>
</ul>
<p>æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ <a href="https://lision.me/">https://lision.me/</a>ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ <a href="https://lision.me/">ä¸ªäººåšå®¢</a> ä¸­æ›´æ–°ã€‚èƒ½åŠ›ä¸è¶³ï¼Œæ°´å¹³æœ‰é™ï¼Œå¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš <a target="_blank" rel="noopener" href="https://weibo.com/lisioncode">@Lision</a> è”ç³»æˆ‘ï¼Œå¦å¤–æˆ‘çš„ <a target="_blank" rel="noopener" href="https://github.com/Lision">GitHub ä¸»é¡µ</a> é‡Œæœ‰å¾ˆå¤šæœ‰è¶£çš„å°ç©æ„å“¦~</p>
<p>æœ€åï¼Œå¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~</p>
<h2 id="æ‰©å±•é˜…è¯»"><a href="#æ‰©å±•é˜…è¯»" class="headerlink" title="æ‰©å±•é˜…è¯»"></a>æ‰©å±•é˜…è¯»</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.libpng.org/pub/png/spec/1.2/PNG-Structure.html">libpng å®˜ç½‘å…³äº PNG ç»“æ„çš„å®˜æ–¹è¯´æ˜</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.mozilla.org/APNG_Specification">APNG çš„ç»´åŸºç™¾ç§‘</a></li>
<li><a target="_blank" rel="noopener" href="https://developers.google.com/speed/webp/docs/api">WebP å¼€å‘è€…æ–‡æ¡£</a></li>
</ul>


    
    
    
	  <div class="tags">
      <a class="tag-none-link" href="/tags/yyimage/" rel="tag">yyimage</a><a class="tag-none-link" href="/tags/yykit/" rel="tag">yykit</a>
	  </div>
    

  </section>
</article>
  
    <article class="post ">

  
  <h2 class="title">
    <a href="/yymodel0x02/">
      æ­ç§˜ YYModel çš„é­”æ³• 0x02
    </a>
  </h2>
  
  <time>
    11æœˆ 19, 2017
  </time>
  <section class="content">
	  <img src="/yymodel0x02/design_model_0x02.jpg" class="">
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨ä¸Šæ–‡<a href="https://lision.me/yymodel_x01/">ã€Šæ­ç§˜ YYModel çš„é­”æ³•ï¼ˆä¸Šï¼‰ã€‹</a> ä¸­ä¸»è¦å‰–æäº† <a target="_blank" rel="noopener" href="https://github.com/ibireme/YYModel">YYModel</a> çš„æºç ç»“æ„ï¼Œå¹¶ä¸”åˆ†äº«äº† YYClassInfo ä¸ NSObject+YYModel å†…éƒ¨æœ‰è¶£çš„å®ç°ç»†èŠ‚ã€‚</p>
<p>ç´§æ¥ä¸Šç¯‡ï¼Œæœ¬æ–‡å°†è§£è¯» YYModel å…³äº JSON æ¨¡å‹è½¬æ¢çš„æºç ï¼Œæ—¨åœ¨æ­ç§˜ JSON æ¨¡å‹è‡ªåŠ¨è½¬æ¢é­”æ³•ã€‚</p>
<h2 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h2><ul>
<li>JSON ä¸ Model ç›¸äº’è½¬æ¢</li>
<li>æ€»ç»“</li>
</ul>
<h2 id="JSON-ä¸-Model-ç›¸äº’è½¬æ¢"><a href="#JSON-ä¸-Model-ç›¸äº’è½¬æ¢" class="headerlink" title="JSON ä¸ Model ç›¸äº’è½¬æ¢"></a>JSON ä¸ Model ç›¸äº’è½¬æ¢</h2><p>JSON(JavaScript Object Notation) æ˜¯ä¸€ç§è½»é‡çº§çš„æ•°æ®äº¤æ¢æ ¼å¼ï¼Œå®ƒæ˜“äºäººä»¬é˜…è¯»å’Œç¼–å†™ï¼ŒåŒæ—¶ä¹Ÿæ˜“äºæœºå™¨è§£æå’Œç”Ÿæˆã€‚å®ƒæ˜¯åŸºäº <a target="_blank" rel="noopener" href="http://www.crockford.com/javascript/">JavaScript Programming Language</a>, <a target="_blank" rel="noopener" href="http://www.ecma-international.org/publications/files/ECMA-ST/Ecma-262.pdf">Standard ECMA-262 3rd Edition - December 1999</a> çš„ä¸€ä¸ªå­é›†ã€‚JSON é‡‡ç”¨å®Œå…¨ç‹¬ç«‹äºè¯­è¨€çš„æ–‡æœ¬æ ¼å¼ï¼Œä½†æ˜¯ä¹Ÿä½¿ç”¨äº†ç±»ä¼¼äº C è¯­è¨€å®¶æ—çš„ä¹ æƒ¯ï¼ˆåŒ…æ‹¬C, C++, C#, Java, JavaScript, Perl, Pythonç­‰ï¼‰ã€‚è¿™äº›ç‰¹æ€§ä½¿ JSON æˆä¸ºç†æƒ³çš„æ•°æ®äº¤æ¢è¯­è¨€ï¼Œç‚¹å‡» <a target="_blank" rel="noopener" href="https://www.json.org/json-zh.html">è¿™é‡Œ</a> äº†è§£æ›´å¤šå…³äº JSON çš„ä¿¡æ¯ã€‚</p>
<p>Model æ˜¯ <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1">é¢å‘å¯¹è±¡ç¼–ç¨‹</a>ï¼ˆObject Oriented Programmingï¼Œç®€ç§° OOPï¼‰ç¨‹åºè®¾è®¡æ€æƒ³ä¸­çš„å¯¹è±¡ï¼ŒOOP æŠŠå¯¹è±¡ä½œä¸ºç¨‹åºçš„åŸºæœ¬å•å…ƒï¼Œä¸€ä¸ªå¯¹è±¡åŒ…å«äº†æ•°æ®å’Œæ“ä½œæ•°æ®çš„å‡½æ•°ã€‚ä¸€èˆ¬æˆ‘ä»¬ä¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚æ¥åˆ›å»ºå¯¹è±¡ï¼Œåœ¨ä¸€äº›è®¾è®¡æ¨¡å¼ä¸­ï¼ˆå¦‚ MVC ç­‰ï¼‰å¯¹è±¡ä¸€èˆ¬ä½œä¸ºæ¨¡å‹ï¼ˆModelï¼‰ï¼Œå³å¯¹è±¡å»ºæ¨¡ã€‚</p>
<p>JSON ä¸ Model ç›¸äº’è½¬æ¢æŒ‰è½¬æ¢æ–¹å‘åˆ†ä¸ºä¸¤ç§ï¼š</p>
<ul>
<li>JSON to Model</li>
<li>Model to JSON</li>
</ul>
<img src="/yymodel0x02/switch.jpg" class="">
<h3 id="JSON-to-Model"><a href="#JSON-to-Model" class="headerlink" title="JSON to Model"></a>JSON to Model</h3><p>æˆ‘ä»¬ä» YYModel çš„æ¥å£å¼€å§‹è§£è¯»ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)yy_modelWithJSON:(<span class="type">id</span>)json &#123;</span><br><span class="line">    <span class="comment">// å°† json è½¬ä¸ºå­—å…¸ dic</span></span><br><span class="line">    <span class="built_in">NSDictionary</span> *dic = [<span class="keyword">self</span> _yy_dictionaryWithJSON:json];</span><br><span class="line">    <span class="comment">// å†é€šè¿‡ dic å¾—åˆ° model å¹¶è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> yy_modelWithDictionary:dic];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æ¥å£æŠŠ JSON è½¬ Model å¾ˆç®€å•çš„åˆ†ä¸ºäº†ä¸¤ä¸ªå­ä»»åŠ¡ï¼š</p>
<ul>
<li>JSON to NSDictionary</li>
<li>NSDictionary to Model</li>
</ul>
<img src="/yymodel0x02/j2d2m.jpg" class="">
<h4 id="JSON-to-NSDictionary"><a href="#JSON-to-NSDictionary" class="headerlink" title="JSON to NSDictionary"></a>JSON to NSDictionary</h4><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ <code>_yy_dictionaryWithJSON</code> æ˜¯æ€ä¹ˆå°† json è½¬ä¸º NSDictionary çš„ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSDictionary</span> *)_yy_dictionaryWithJSON:(<span class="type">id</span>)json &#123;</span><br><span class="line">    <span class="comment">// å…¥å‚åˆ¤ç©º</span></span><br><span class="line">    <span class="keyword">if</span> (!json || json == (<span class="type">id</span>)kCFNull) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSDictionary</span> *dic = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSData</span> *jsonData = <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// æ ¹æ® json çš„ç±»å‹å¯¹åº”æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> ([json isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯ NSDictionary ç±»åˆ™ç›´æ¥èµ‹å€¼</span></span><br><span class="line">        dic = json;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([json isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯ NSString ç±»åˆ™ç”¨ UTF-8 ç¼–ç è½¬ NSData</span></span><br><span class="line">        jsonData = [(<span class="built_in">NSString</span> *)json dataUsingEncoding : <span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([json isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯ NSData åˆ™ç›´æ¥èµ‹å€¼ç»™ jsonData</span></span><br><span class="line">        jsonData = json;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// jsonData ä¸ä¸º nilï¼Œåˆ™è¡¨ç¤ºä¸Šé¢çš„ 2ã€3 æƒ…å†µä¸­çš„ä¸€ç§</span></span><br><span class="line">    <span class="keyword">if</span> (jsonData) &#123;</span><br><span class="line">        <span class="comment">// åˆ©ç”¨ NSJSONSerialization æ–¹æ³•å°† jsonData è½¬ä¸º dic</span></span><br><span class="line">        dic = [<span class="built_in">NSJSONSerialization</span> JSONObjectWithData:jsonData options:kNilOptions error:<span class="literal">NULL</span>];</span><br><span class="line">        <span class="comment">// åˆ¤æ–­è½¬æ¢ç»“æœ </span></span><br><span class="line">        <span class="keyword">if</span> (![dic isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) dic = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> dic;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯æ ¹æ®å…¥å‚çš„ç±»å‹åˆ¤æ–­å¦‚ä½•å°†å…¶è½¬ä¸º NSDictionary ç±»å‹å¹¶è¿”å›ã€‚</p>
<p>å…¶ä¸­ <code>kCFNull</code> æ˜¯ CoreFoundation ä¸­ CFNull çš„å•ä¾‹å¯¹è±¡ã€‚å¦‚åŒ Foundation æ¡†æ¶ä¸­çš„ NSNull ä¸€æ ·ï¼ŒCFNull æ˜¯ç”¨æ¥è¡¨ç¤ºé›†åˆå¯¹è±¡ä¸­çš„ç©ºå€¼ï¼ˆä¸å…è®¸ä¸º NULLï¼‰ã€‚CFNull å¯¹è±¡æ—¢ä¸å…è®¸è¢«åˆ›å»ºä¹Ÿä¸å…è®¸è¢«é”€æ¯ï¼Œè€Œæ˜¯é€šè¿‡å®šä¹‰ä¸€ä¸ª CFNull å¸¸é‡ï¼Œå³ <code>kCFNull</code>ï¼Œåœ¨éœ€è¦ç©ºå€¼æ—¶ä½¿ç”¨ã€‚</p>
<blockquote>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<br>The CFNull opaque type defines a unique object used to represent null values in collection objects (which donâ€™t allow NULL values). CFNull objects are neither created nor destroyed. Instead, a single CFNull constant objectâ€”<a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/corefoundation/kcfnull">kCFNull</a>â€”is defined and is used wherever a null value is needed.</p>
</blockquote>
<p>NSJSONSerialization æ˜¯ç”¨äºå°† JSON å’Œç­‰æ•ˆçš„ Foundation å¯¹è±¡ä¹‹é—´ç›¸äº’è½¬æ¢çš„å¯¹è±¡ã€‚å®ƒåœ¨ iOS 7 ä»¥åŠ macOS 10.9ï¼ˆåŒ…å« iOS 7 å’Œ macOS 10.9ï¼‰ä¹‹åæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>ä»£ç ä¸­å°† NSString è½¬ä¸º NSData ç”¨åˆ°äº† NSUTF8StringEncodingï¼Œå…¶ä¸­ç¼–ç ç±»å‹å¿…é¡»å±äº JSON è§„èŒƒä¸­åˆ—å‡ºçš„ 5 ç§æ”¯æŒçš„ç¼–ç ç±»å‹ï¼š</p>
<ul>
<li>UTF-8</li>
<li>UTF-16LE</li>
<li>UTF-16BE</li>
<li>UTF-32LE</li>
<li>UTF-32BE</li>
</ul>
<p>è€Œç”¨äºè§£æçš„æœ€é«˜æ•ˆçš„ç¼–ç æ˜¯ UTF-8 ç¼–ç ï¼Œæ‰€ä»¥ä½œè€…è¿™é‡Œä½¿ç”¨ NSUTF8StringEncodingã€‚</p>
<blockquote>
<p>å®˜æ–¹æ³¨é‡Šï¼š<br>The data must be in one of the 5 supported encodings listed in the JSON specification: UTF-8, UTF-16LE, UTF-16BE, UTF-32LE, UTF-32BE. The data may or may not have a BOM. The most efficient encoding to use for parsing is UTF-8, so if you have a choice in encoding the data passed to this method, use UTF-8.</p>
</blockquote>
<h4 id="NSDictionary-to-Model"><a href="#NSDictionary-to-Model" class="headerlink" title="NSDictionary to Model"></a>NSDictionary to Model</h4><p>ç°åœ¨æˆ‘ä»¬è¦ä» <code>yy_modelWithJSON</code> æ¥å£ä¸­æ¢ç©¶ <code>yy_modelWithDictionary</code> æ˜¯å¦‚ä½•å°† NSDictionary è½¬ä¸º Model çš„ã€‚</p>
<p>æ•²é»‘æ¿ï¼åšå¥½å‡†å¤‡ï¼Œè¿™ä¸€å°èŠ‚ä»‹ç»çš„ä»£ç æ˜¯ YYModel çš„ç²¾åå“¦~ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)yy_modelWithDictionary:(<span class="built_in">NSDictionary</span> *)dictionary &#123;</span><br><span class="line">    <span class="comment">// å…¥å‚æ ¡éªŒ</span></span><br><span class="line">    <span class="keyword">if</span> (!dictionary || dictionary == (<span class="type">id</span>)kCFNull) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (![dictionary isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä½¿ç”¨å½“å‰ç±»ç”Ÿæˆä¸€ä¸ª _YYModelMeta æ¨¡å‹å…ƒç±»</span></span><br><span class="line">    Class cls = [<span class="keyword">self</span> <span class="keyword">class</span>];</span><br><span class="line">    _YYModelMeta *modelMeta = [_YYModelMeta metaWithClass:cls];</span><br><span class="line">    <span class="comment">// è¿™é‡Œ _hasCustomClassFromDictionary ç”¨äºæ ‡è¯†æ˜¯å¦éœ€è¦è‡ªå®šä¹‰è¿”å›ç±»</span></span><br><span class="line">    <span class="comment">// å±äºæ¨¡å‹è½¬æ¢é™„åŠ åŠŸèƒ½ï¼Œå¯ä»¥ä¸ç”¨æŠ•å…¥å¤ªå¤šå…³æ³¨</span></span><br><span class="line">    <span class="keyword">if</span> (modelMeta-&gt;_hasCustomClassFromDictionary) &#123;</span><br><span class="line">        cls = [cls modelCustomClassForDictionary:dictionary] ?: cls;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è°ƒç”¨ yy_modelSetWithDictionary ä¸ºæ–°å»ºçš„ç±»å®ä¾‹ one èµ‹å€¼ï¼Œèµ‹å€¼æˆåŠŸåˆ™è¿”å› one</span></span><br><span class="line">    <span class="built_in">NSObject</span> *one = [cls new];</span><br><span class="line">    <span class="comment">// æ‰€ä»¥è¿™ä¸ªå‡½æ•°ä¸­æˆ‘ä»¬åº”è¯¥æŠŠæ³¨æ„åŠ›é›†ä¸­åœ¨ yy_modelSetWithDictionary</span></span><br><span class="line">    <span class="keyword">if</span> ([one yy_modelSetWithDictionary:dictionary]) <span class="keyword">return</span> one;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç ä¸­æ ¹æ® <code>_hasCustomClassFromDictionary</code> æ ‡è¯†åˆ¤æ–­æ˜¯å¦éœ€è¦è‡ªå®šä¹‰è¿”å›æ¨¡å‹çš„ç±»å‹ã€‚è¿™æ®µä»£ç å±äº YYModel çš„é™„åŠ åŠŸèƒ½ï¼Œä¸ºäº†ä¸ä½¿å¤§å®¶åˆ†å¿ƒï¼Œè¿™é‡Œä»…åšç®€å•ä»‹ç»ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬è¦åœ¨ JSON è½¬ Model çš„è¿‡ç¨‹ä¸­æ ¹æ®æƒ…å†µåˆ›å»ºä¸åŒç±»å‹çš„å®ä¾‹ï¼Œåˆ™å¯ä»¥åœ¨ Model ä¸­å®ç°æ¥å£ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">nullable</span> Class)modelCustomClassForDictionary:(<span class="built_in">NSDictionary</span> *)dictionary;</span><br></pre></td></tr></table></figure>
<p>æ¥æ»¡è¶³éœ€æ±‚ã€‚å½“æ¨¡å‹å…ƒåˆå§‹åŒ–æ—¶ä¼šæ£€æµ‹å½“å‰æ¨¡å‹ç±»æ˜¯å¦å¯ä»¥å“åº”ä¸Šé¢çš„æ¥å£ï¼Œå¦‚æœå¯ä»¥å“åº”åˆ™ä¼šæŠŠ <code>_hasCustomClassFromDictionary</code> æ ‡è¯†ä¸º YESï¼Œæ‰€ä»¥ä¸Šé¢æ‰ä¼šå‡ºç°è¿™äº›ä»£ç ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (modelMeta-&gt;_hasCustomClassFromDictionary) &#123;</span><br><span class="line">    cls = [cls modelCustomClassForDictionary:dictionary] ?: cls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å˜›~ æˆ‘è§‰å¾—è¿™äº›é™„åŠ çš„ä¸œè¥¿åœ¨é˜…è¯»æºç æ—¶å¾ˆå¤§ç¨‹åº¦ä¸Šä¼šåˆ†æ•£æˆ‘ä»¬çš„æ³¨æ„åŠ›ï¼Œè¿™æ¬¡å…ˆè¯¦ç»†çš„è®²è§£ä¸€ä¸‹ï¼Œä»¥åé‡åˆ°ç±»ä¼¼çš„ä»£ç æˆ‘ä»¬ä¼šç•¥è¿‡ï¼Œå†…éƒ¨çš„å®ç°å¤§éƒ½ä¸ä¸Šè¿°æ¡ˆä¾‹åŸç†ç›¸åŒï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±ç ”ç©¶å“ˆã€‚</p>
<p>æˆ‘ä»¬åº”è¯¥æŠŠæ³¨æ„åŠ›é›†ä¸­åœ¨ <code>yy_modelSetWithDictionary</code> ä¸Šï¼Œè¿™ä¸ªå‡½æ•°ï¼ˆå…¶å®ä¹Ÿæ˜¯ NSObject+YYModel æš´éœ²çš„æ¥å£ï¼‰æ˜¯æ ¹æ®å­—å…¸åˆå§‹åŒ–æ¨¡å‹çš„å®ç°æ–¹æ³•ã€‚å®ƒçš„ä»£ç æ¯”è¾ƒé•¿ï¼Œå¦‚æœä¸æƒ³çœ‹å¯ä»¥è·³è¿‡ï¼Œåœ¨åé¢æœ‰è§£é‡Šã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)yy_modelSetWithDictionary:(<span class="built_in">NSDictionary</span> *)dic &#123;</span><br><span class="line">    <span class="comment">// å…¥å‚æ ¡éªŒ</span></span><br><span class="line">    <span class="keyword">if</span> (!dic || dic == (<span class="type">id</span>)kCFNull) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">if</span> (![dic isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¹æ®è‡ªèº«ç±»ç”Ÿæˆ _YYModelMeta æ¨¡å‹å…ƒç±»</span></span><br><span class="line">    _YYModelMeta *modelMeta = [_YYModelMeta metaWithClass:object_getClass(<span class="keyword">self</span>)];</span><br><span class="line">    <span class="comment">// å¦‚æœæ¨¡å‹å…ƒç±»é”®å€¼æ˜ å°„æ•°é‡ä¸º 0 åˆ™ return NOï¼Œè¡¨ç¤ºæ„å»ºå¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (modelMeta-&gt;_keyMappedCount == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¿½ç•¥ï¼Œè¯¥æ ‡è¯†å¯¹åº” modelCustomWillTransformFromDictionary æ¥å£</span></span><br><span class="line">    <span class="keyword">if</span> (modelMeta-&gt;_hasCustomWillTransformFromDictionary) &#123;</span><br><span class="line">        <span class="comment">// è¯¥æ¥å£ç±»ä¼¼ modelCustomTransformFromDictionary æ¥å£ï¼Œä¸è¿‡æ˜¯åœ¨æ¨¡å‹è½¬æ¢ä¹‹å‰è°ƒç”¨çš„</span></span><br><span class="line">        dic = [((<span class="type">id</span>&lt;YYModel&gt;)<span class="keyword">self</span>) modelCustomWillTransformFromDictionary:dic];</span><br><span class="line">        <span class="keyword">if</span> (![dic isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ¨¡å‹è®¾ç½®ä¸Šä¸‹æ–‡ ModelSetContext</span></span><br><span class="line">    ModelSetContext context = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    context.modelMeta = (__bridge <span class="type">void</span> *)(modelMeta);</span><br><span class="line">    context.model = (__bridge <span class="type">void</span> *)(<span class="keyword">self</span>);</span><br><span class="line">    context.dictionary = (__bridge <span class="type">void</span> *)(dic);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ¨¡å‹å…ƒé”®å€¼æ˜ å°„æ•°é‡ä¸ JSON æ‰€å¾—å­—å…¸çš„æ•°é‡å…³ç³»</span></span><br><span class="line">    <span class="keyword">if</span> (modelMeta-&gt;_keyMappedCount &gt;= <span class="built_in">CFDictionaryGetCount</span>((<span class="built_in">CFDictionaryRef</span>)dic)) &#123;</span><br><span class="line">        <span class="comment">// ä¸€èˆ¬æƒ…å†µä¸‹ä»–ä»¬çš„æ•°é‡ç›¸ç­‰</span></span><br><span class="line">        <span class="comment">// ç‰¹æ®Šæƒ…å†µæ¯”å¦‚æœ‰çš„å±æ€§å…ƒä¼šæ˜ å°„å­—å…¸ä¸­çš„å¤šä¸ª key</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä¸ºå­—å…¸ä¸­çš„æ¯ä¸ªé”®å€¼å¯¹è°ƒç”¨ ModelSetWithDictionaryFunction</span></span><br><span class="line">        <span class="comment">// è¿™å¥è¯æ˜¯æ ¸å¿ƒä»£ç ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å°±æ˜¯é  ModelSetWithDictionaryFunction é€šè¿‡å­—å…¸è®¾ç½®æ¨¡å‹</span></span><br><span class="line">        <span class="built_in">CFDictionaryApplyFunction</span>((<span class="built_in">CFDictionaryRef</span>)dic, ModelSetWithDictionaryFunction, &amp;context);</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ¨¡å‹ä¸­æ˜¯å¦å­˜åœ¨æ˜ å°„ keyPath çš„å±æ€§å…ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (modelMeta-&gt;_keyPathPropertyMetas) &#123;</span><br><span class="line">            <span class="comment">// ä¸ºæ¯ä¸ªæ˜ å°„ keyPath çš„å±æ€§å…ƒæ‰§è¡Œ ModelSetWithPropertyMetaArrayFunction</span></span><br><span class="line">            <span class="built_in">CFArrayApplyFunction</span>((<span class="built_in">CFArrayRef</span>)modelMeta-&gt;_keyPathPropertyMetas,</span><br><span class="line">                                 <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, <span class="built_in">CFArrayGetCount</span>((<span class="built_in">CFArrayRef</span>)modelMeta-&gt;_keyPathPropertyMetas)),</span><br><span class="line">                                 ModelSetWithPropertyMetaArrayFunction,</span><br><span class="line">                                 &amp;context);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ¨¡å‹ä¸­æ˜¯å¦å­˜åœ¨æ˜ å°„å¤šä¸ª key çš„å±æ€§å…ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (modelMeta-&gt;_multiKeysPropertyMetas) &#123;</span><br><span class="line">            <span class="comment">// ä¸ºæ¯ä¸ªæ˜ å°„å¤šä¸ª key çš„å±æ€§å…ƒæ‰§è¡Œ ModelSetWithPropertyMetaArrayFunction</span></span><br><span class="line">            <span class="built_in">CFArrayApplyFunction</span>((<span class="built_in">CFArrayRef</span>)modelMeta-&gt;_multiKeysPropertyMetas,</span><br><span class="line">                                 <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, <span class="built_in">CFArrayGetCount</span>((<span class="built_in">CFArrayRef</span>)modelMeta-&gt;_multiKeysPropertyMetas)),</span><br><span class="line">                                 ModelSetWithPropertyMetaArrayFunction,</span><br><span class="line">                                 &amp;context);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// æ¨¡å‹å…ƒé”®å€¼æ˜ å°„æ•°é‡å°‘ï¼Œåˆ™è®¤ä¸ºä¸å­˜åœ¨æ˜ å°„å¤šä¸ª key çš„å±æ€§å…ƒ</span></span><br><span class="line">        <span class="comment">// ç›´æ¥ä¸ºæ¯ä¸ª modelMeta å±æ€§å…ƒæ‰§è¡Œ ModelSetWithPropertyMetaArrayFunction</span></span><br><span class="line">        <span class="built_in">CFArrayApplyFunction</span>((<span class="built_in">CFArrayRef</span>)modelMeta-&gt;_allPropertyMetas,</span><br><span class="line">                             <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, modelMeta-&gt;_keyMappedCount),</span><br><span class="line">                             ModelSetWithPropertyMetaArrayFunction,</span><br><span class="line">                             &amp;context);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¿½ç•¥ï¼Œè¯¥æ ‡è¯†å¯¹åº”æ¥å£ modelCustomTransformFromDictionary</span></span><br><span class="line">    <span class="keyword">if</span> (modelMeta-&gt;_hasCustomTransformFromDictionary) &#123;</span><br><span class="line">        <span class="comment">// è¯¥æ¥å£ç”¨äºå½“é»˜è®¤ JSON è½¬ Model ä¸é€‚åˆæ¨¡å‹å¯¹è±¡æ—¶åšé¢å¤–çš„é€»è¾‘å¤„ç†</span></span><br><span class="line">        <span class="comment">// æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªæ¥å£æ¥éªŒè¯æ¨¡å‹è½¬æ¢çš„ç»“æœ</span></span><br><span class="line">        <span class="keyword">return</span> [((<span class="type">id</span>&lt;YYModel&gt;)<span class="keyword">self</span>) modelCustomTransformFromDictionary:dic];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç å·²ç»æ³¨æ˜å¿…è¦ä¸­æ–‡æ³¨é‡Šï¼Œå…³äºä¸¤å¤„è‡ªå®šä¹‰æ‰©å±•æ¥å£æˆ‘ä»¬ä¸å†å¤šè¯´ï¼Œç”±äºä»£ç æ¯”è¾ƒé•¿æˆ‘ä»¬å…ˆæ¥æ¢³ç†ä¸€ä¸‹ <code>yy_modelSetWithDictionary</code> ä¸»è¦åšäº†å“ªäº›äº‹ï¼Ÿ</p>
<ul>
<li>å…¥å‚æ ¡éªŒ</li>
<li>åˆå§‹åŒ–æ¨¡å‹å…ƒä»¥åŠæ˜ å°„è¡¨æ ¡éªŒ</li>
<li>åˆå§‹åŒ–æ¨¡å‹è®¾ç½®ä¸Šä¸‹æ–‡ <code>ModelSetContext</code></li>
<li>ä¸ºå­—å…¸ä¸­çš„æ¯ä¸ªé”®å€¼å¯¹è°ƒç”¨ <code>ModelSetWithDictionaryFunction</code></li>
<li>æ£€éªŒè½¬æ¢ç»“æœ</li>
</ul>
<p>æ¨¡å‹è®¾ç½®ä¸Šä¸‹æ–‡ <code>ModelSetContext</code> å…¶å®å°±æ˜¯ä¸€ä¸ªåŒ…å«æ¨¡å‹å…ƒï¼Œæ¨¡å‹å®ä¾‹ä»¥åŠå¾…è½¬æ¢å­—å…¸çš„ç»“æ„ä½“ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="type">void</span> *modelMeta;  <span class="comment">///&lt; æ¨¡å‹å…ƒ</span></span><br><span class="line">    <span class="type">void</span> *model;      <span class="comment">///&lt; æ¨¡å‹å®ä¾‹ï¼ŒæŒ‡å‘è¾“å‡ºçš„æ¨¡å‹</span></span><br><span class="line">    <span class="type">void</span> *dictionary; <span class="comment">///&lt; å¾…è½¬æ¢å­—å…¸</span></span><br><span class="line">&#125; ModelSetContext;</span><br></pre></td></tr></table></figure>
<p>å¤§å®¶è‚¯å®šéƒ½æ³¨æ„åˆ°äº† <code>ModelSetWithDictionaryFunction</code> å‡½æ•°ï¼Œä¸è®ºèµ°å“ªæ¡é€»è¾‘åˆ†æ”¯ï¼Œæœ€åéƒ½æ˜¯è°ƒç”¨è¿™ä¸ªå‡½æ•°æŠŠå­—å…¸çš„ keyï¼ˆkeypathï¼‰å¯¹åº”çš„ value å–å‡ºå¹¶èµ‹å€¼ç»™ Model çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ¥çœ‹çœ‹è¿™ä¸ªå‡½æ•°çš„å®ç°ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å­—å…¸é”®å€¼å¯¹å»ºæ¨¡</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">void</span> ModelSetWithDictionaryFunction(<span class="keyword">const</span> <span class="type">void</span> *_key, <span class="keyword">const</span> <span class="type">void</span> *_value, <span class="type">void</span> *_context) &#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°å…¥å‚ä¸Šä¸‹æ–‡</span></span><br><span class="line">    ModelSetContext *context = _context;</span><br><span class="line">    <span class="comment">// å–å‡ºä¸Šä¸‹æ–‡ä¸­æ¨¡å‹å…ƒ</span></span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> _YYModelMeta *meta = (__bridge _YYModelMeta *)(context-&gt;modelMeta);</span><br><span class="line">    <span class="comment">// æ ¹æ®å…¥å‚ _key ä»æ¨¡å‹å…ƒä¸­å–å‡ºæ˜ å°„è¡¨å¯¹åº”çš„å±æ€§å…ƒ</span></span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> _YYModelPropertyMeta *propertyMeta = [meta-&gt;_mapper objectForKey:(__bridge <span class="type">id</span>)(_key)];</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°å¾…èµ‹å€¼æ¨¡å‹</span></span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> <span class="type">id</span> model = (__bridge <span class="type">id</span>)(context-&gt;model);</span><br><span class="line">    <span class="comment">// éå† propertyMetaï¼Œç›´åˆ° propertyMeta-&gt;_next == nil</span></span><br><span class="line">    <span class="keyword">while</span> (propertyMeta) &#123;</span><br><span class="line">        <span class="comment">// å½“å‰éå†çš„ propertyMeta æœ‰ setter æ–¹æ³•ï¼Œåˆ™è°ƒç”¨ ModelSetValueForProperty èµ‹å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (propertyMeta-&gt;_<span class="keyword">setter</span>) &#123;</span><br><span class="line">            <span class="comment">// æ ¸å¿ƒæ–¹æ³•ï¼Œæ‹å‡ºæ¥è®²</span></span><br><span class="line">            ModelSetValueForProperty(model, (__bridge __<span class="keyword">unsafe_unretained</span> <span class="type">id</span>)_value, propertyMeta);</span><br><span class="line">        &#125;</span><br><span class="line">        propertyMeta = propertyMeta-&gt;_next;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ModelSetWithDictionaryFunction</code> å‡½æ•°çš„å®ç°é€»è¾‘å°±æ˜¯å…ˆé€šè¿‡æ¨¡å‹è®¾ç½®ä¸Šä¸‹æ–‡æ‹¿åˆ°å¸¦èµ‹å€¼æ¨¡å‹ï¼Œä¹‹åéå†å½“å‰çš„å±æ€§å…ƒï¼ˆç›´åˆ° propertyMeta-&gt;_next == nilï¼‰ï¼Œæ‰¾åˆ° <code>setter</code> ä¸ä¸ºç©ºçš„å±æ€§å…ƒé€šè¿‡ <code>ModelSetValueForProperty</code> æ–¹æ³•èµ‹å€¼ã€‚</p>
<p><code>ModelSetValueForProperty</code> å‡½æ•°æ˜¯ä¸ºæ¨¡å‹ä¸­çš„å±æ€§èµ‹å€¼çš„å®ç°æ–¹æ³•ï¼Œä¹Ÿæ˜¯æ•´ä¸ª YYModel çš„æ ¸å¿ƒä»£ç ã€‚åˆ«ç´§å¼ ï¼Œè¿™ä¸ªå‡½æ•°å†™å¾—å¾ˆå‹å¥½çš„ï¼Œä¹Ÿå°± 300 å¤šè¡Œè€Œå·² ğŸ˜œï¼ˆæ— å…³ç´§è¦çš„å†…å®¹æˆ‘ä¼šå°½é‡å¿½ç•¥æ‰ï¼‰ï¼Œä¸è¿‡å¿½ç•¥çš„å¤ªå¤šä¼šå½±å“ä»£ç é˜…è¯»çš„è¿ç»­æ€§ï¼Œå¦‚æœå«Œé•¿å¯ä»¥ä¸çœ‹ï¼Œæ–‡ç« åé¢ä¼šæ€»ç»“ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å®ç°é€»è¾‘ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">void</span> ModelSetValueForProperty(__<span class="keyword">unsafe_unretained</span> <span class="type">id</span> model,</span><br><span class="line">                                     __<span class="keyword">unsafe_unretained</span> <span class="type">id</span> value,</span><br><span class="line">                                     __<span class="keyword">unsafe_unretained</span> _YYModelPropertyMeta *meta) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå±æ€§æ˜¯ä¸€ä¸ª CNumberï¼Œå³è¾“å…¥ intã€uintâ€¦â€¦</span></span><br><span class="line">    <span class="keyword">if</span> (meta-&gt;_isCNumber) &#123;</span><br><span class="line">        <span class="comment">// è½¬ä¸º NSNumber ä¹‹åèµ‹å€¼</span></span><br><span class="line">        <span class="built_in">NSNumber</span> *num = YYNSNumberCreateFromID(value);</span><br><span class="line">        <span class="comment">// è¿™é‡Œ ModelSetNumberToProperty å°è£…äº†ç»™å±æ€§å…ƒèµ‹å€¼ NSNumber çš„æ“ä½œ</span></span><br><span class="line">        ModelSetNumberToProperty(model, num, meta);</span><br><span class="line">        <span class="keyword">if</span> (num) [num <span class="keyword">class</span>]; <span class="comment">// hold the number</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (meta-&gt;_nsType) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå±æ€§å±äº nsTypeï¼Œå³ NSStringã€NSNumberâ€¦â€¦</span></span><br><span class="line">        <span class="keyword">if</span> (value == (<span class="type">id</span>)kCFNull) &#123; <span class="comment">// ä¸ºç©ºï¼Œåˆ™èµ‹å€¼ nilï¼ˆé€šè¿‡å±æ€§å…ƒ _setter æ–¹æ³•ä½¿ç”¨ objc_msgSend å°† nil èµ‹å€¼ï¼‰</span></span><br><span class="line">            ((<span class="type">void</span> (*)(<span class="type">id</span>, SEL, <span class="type">id</span>))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, meta-&gt;_<span class="keyword">setter</span>, (<span class="type">id</span>)<span class="literal">nil</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// ä¸ä¸ºç©º</span></span><br><span class="line">            <span class="keyword">switch</span> (meta-&gt;_nsType) &#123;</span><br><span class="line">                <span class="comment">// NSString æˆ– NSMutableString</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSString:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSMutableString: &#123;</span><br><span class="line">                    <span class="comment">// å¤„ç†å¯èƒ½çš„ value ç±»å‹ï¼šNSStringï¼ŒNSNumberï¼ŒNSDataï¼ŒNSURLï¼ŒNSAttributedString</span></span><br><span class="line">                    <span class="comment">// å¯¹åº”çš„åˆ†æ”¯å°±æ˜¯æŠŠ value è½¬ä¸º NSString æˆ–è€… NSMutableStringï¼Œä¹‹åè°ƒç”¨ setter èµ‹å€¼</span></span><br><span class="line">                    ...</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// NSValueï¼ŒNSNumber æˆ– NSDecimalNumber</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSValue:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSNumber:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSDecimalNumber: &#123;</span><br><span class="line">                    <span class="comment">// å¯¹å±æ€§å…ƒçš„ç±»å‹åˆ†æƒ…å†µèµ‹å€¼ï¼ˆä¸­é—´å¯èƒ½ä¼šæ¶‰åŠåˆ°ç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼‰</span></span><br><span class="line">                    ...</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="comment">// NSData æˆ– NSMutableData</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSData:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSMutableData: &#123;</span><br><span class="line">                    <span class="comment">// å¯¹å±æ€§å…ƒçš„ç±»å‹åˆ†æƒ…å†µèµ‹å€¼ï¼ˆä¸­é—´å¯èƒ½ä¼šæ¶‰åŠåˆ°ç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼‰</span></span><br><span class="line">                    ...</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="comment">// NSDate</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSDate: &#123;</span><br><span class="line">                    <span class="comment">// è€ƒè™‘å¯èƒ½çš„ value ç±»å‹ï¼šNSDate æˆ– NSString</span></span><br><span class="line">                    <span class="comment">// è½¬æ¢ä¸º NSDate ä¹‹åèµ‹å€¼</span></span><br><span class="line">                    ...</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="comment">// NSURL</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSURL: &#123;</span><br><span class="line">                    <span class="comment">// è€ƒè™‘å¯èƒ½çš„ value ç±»å‹ï¼šNSURL æˆ– NSString</span></span><br><span class="line">                    <span class="comment">// è½¬æ¢ä¸º NSDate ä¹‹åèµ‹å€¼ï¼ˆè¿™é‡Œå¯¹ NSString çš„é•¿åº¦åˆ¤æ–­æ˜¯å¦èµ‹å€¼ nilï¼‰</span></span><br><span class="line">                    ...</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="comment">// NSArray æˆ– NSMutableArray</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSArray:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSMutableArray: &#123;</span><br><span class="line">                    <span class="comment">// å¯¹å±æ€§å…ƒçš„æ³›å‹åˆ¤æ–­</span></span><br><span class="line">                    <span class="keyword">if</span> (meta-&gt;_genericCls) &#123; <span class="comment">// å¦‚æœå­˜åœ¨æ³›å‹</span></span><br><span class="line">                        <span class="built_in">NSArray</span> *valueArr = <span class="literal">nil</span>;</span><br><span class="line">                        <span class="comment">// value æ‰€å± NSArray åˆ™ç›´æ¥èµ‹å€¼ï¼Œå¦‚æœæ‰€å± NSSet ç±»åˆ™è½¬ä¸º NSArray</span></span><br><span class="line">                        <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) valueArr = value;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSSet</span> <span class="keyword">class</span>]]) valueArr = ((<span class="built_in">NSSet</span> *)value).allObjects;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// éå†åˆšæ‰é€šè¿‡ value è½¬æ¢æ¥çš„ valueArr</span></span><br><span class="line">                        <span class="keyword">if</span> (valueArr) &#123;</span><br><span class="line">                            <span class="built_in">NSMutableArray</span> *objectArr = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">                            <span class="keyword">for</span> (<span class="type">id</span> one <span class="keyword">in</span> valueArr) &#123;</span><br><span class="line">                                <span class="comment">// é‡åˆ° valueArr ä¸­çš„å…ƒç´ å±äºæ³›å‹ç±»ï¼Œç›´æ¥åŠ å…¥ objectArr</span></span><br><span class="line">                                <span class="keyword">if</span> ([one isKindOfClass:meta-&gt;_genericCls]) &#123;</span><br><span class="line">                                    [objectArr addObject:one];</span><br><span class="line">                                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([one isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                                    <span class="comment">// é‡åˆ° valueArr ä¸­çš„å…ƒç´ æ˜¯å­—å…¸ç±»ï¼Œ</span></span><br><span class="line">                                    Class cls = meta-&gt;_genericCls;</span><br><span class="line">                                    <span class="comment">// å¿½ç•¥</span></span><br><span class="line">                                    <span class="keyword">if</span> (meta-&gt;_hasCustomClassFromDictionary) &#123;</span><br><span class="line">                                        cls = [cls modelCustomClassForDictionary:one];</span><br><span class="line">                                        <span class="keyword">if</span> (!cls) cls = meta-&gt;_genericCls; <span class="comment">// for xcode code coverage</span></span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="comment">// è¿˜è®°å¾—æˆ‘ä»¬ç›´æ¥çš„èµ·ç‚¹ yy_modelSetWithDictionaryï¼Œå°†å­—å…¸è½¬æ¨¡å‹</span></span><br><span class="line">                                    <span class="comment">// æˆ‘è§‰å¾—è¿™åº”è¯¥ç®—æ˜¯ä¸€ä¸ªé—´æ¥é€’å½’è°ƒç”¨</span></span><br><span class="line">                                    <span class="comment">// å¦‚æœè®¾è®¡å‡ºçš„æ¨¡å‹æ˜¯æ— é™é€’å½’ï¼ˆä»å‰æœ‰åº§å±±ï¼Œå±±ä¸Šæœ‰åº§åº™çš„æ•…äº‹ï¼‰ï¼Œé‚£ä¹ˆè‚¯å®šä¼šæ…¢</span></span><br><span class="line">                                    <span class="built_in">NSObject</span> *newOne = [cls new];</span><br><span class="line">                                    [newOne yy_modelSetWithDictionary:one];</span><br><span class="line">                                    <span class="comment">// è½¬åŒ–æˆåŠŸæœºä¹ŸåŠ å…¥ objectArr</span></span><br><span class="line">                                    <span class="keyword">if</span> (newOne) [objectArr addObject:newOne];</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// æœ€åå°†å¾—åˆ°çš„ objectArr èµ‹å€¼ç»™å±æ€§</span></span><br><span class="line">                            ((<span class="type">void</span> (*)(<span class="type">id</span>, SEL, <span class="type">id</span>))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, meta-&gt;_<span class="keyword">setter</span>, objectArr);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// æ²¡æœ‰æ³›å‹ï¼Œå˜›~ åˆ¤æ–­ä¸€ä¸‹ value çš„å¯èƒ½æ‰€å±ç±»å‹ NSArray æˆ– NSSet</span></span><br><span class="line">                        <span class="comment">// è½¬æ¢èµ‹å€¼ï¼ˆæ¶‰åŠ mutableï¼‰</span></span><br><span class="line">                        ...</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// NSDictionary æˆ– NSMutableDictionary</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSDictionary:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSMutableDictionary: &#123;</span><br><span class="line">                    <span class="comment">// è·Ÿä¸Šé¢æ•°ç»„çš„å¤„ç†è¶…ç›¸ä¼¼ï¼Œæ³›å‹çš„é—´æ¥é€’å½’ä»¥åŠæ— æ³›å‹çš„ç±»å‹è½¬æ¢ï¼ˆmutable çš„å¤„ç†ï¼‰</span></span><br><span class="line">                    ...</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                <span class="comment">// NSSet æˆ– NSMutableSet</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSSet:</span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeNSMutableSet: &#123;</span><br><span class="line">                    <span class="comment">// è·Ÿä¸Šé¢æ•°ç»„çš„å¤„ç†è¶…ç›¸ä¼¼ï¼Œæ³›å‹çš„é—´æ¥é€’å½’ä»¥åŠæ— æ³›å‹çš„ç±»å‹è½¬æ¢ï¼ˆmutable çš„å¤„ç†ï¼‰</span></span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// å±æ€§å…ƒä¸å±äº CNumber å’Œ nsType </span></span><br><span class="line">        <span class="type">BOOL</span> isNull = (value == (<span class="type">id</span>)kCFNull);</span><br><span class="line">        <span class="keyword">switch</span> (meta-&gt;_type &amp; YYEncodingTypeMask) &#123;</span><br><span class="line">            <span class="comment">// id</span></span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeObject: &#123;</span><br><span class="line">                <span class="keyword">if</span> (isNull) &#123; <span class="comment">// ç©ºï¼Œèµ‹å€¼ nil</span></span><br><span class="line">                    ((<span class="type">void</span> (*)(<span class="type">id</span>, SEL, <span class="type">id</span>))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, meta-&gt;_<span class="keyword">setter</span>, (<span class="type">id</span>)<span class="literal">nil</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:meta-&gt;_cls] || !meta-&gt;_cls) &#123;</span><br><span class="line">                    <span class="comment">// å±æ€§å…ƒä¸ value ä»å±äºåŒä¸€ä¸ªç±»ï¼Œåˆ™ç›´æ¥èµ‹å€¼</span></span><br><span class="line">                    ((<span class="type">void</span> (*)(<span class="type">id</span>, SEL, <span class="type">id</span>))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, meta-&gt;_<span class="keyword">setter</span>, (<span class="type">id</span>)value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                    <span class="comment">// å˜›~ value ä»å±äº </span></span><br><span class="line">                    <span class="built_in">NSObject</span> *one = <span class="literal">nil</span>;</span><br><span class="line">                    <span class="comment">// å¦‚æœå±æ€§å…ƒæœ‰ getter æ–¹æ³•ï¼Œåˆ™é€šè¿‡ getter è·å–åˆ°å®ä¾‹</span></span><br><span class="line">                    <span class="keyword">if</span> (meta-&gt;_<span class="keyword">getter</span>) &#123;</span><br><span class="line">                        one = ((<span class="type">id</span> (*)(<span class="type">id</span>, SEL))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, meta-&gt;_<span class="keyword">getter</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (one) &#123;</span><br><span class="line">                        <span class="comment">// ç”¨ yy_modelSetWithDictionary è¾“å‡ºåŒ–å±æ€§å®ä¾‹å¯¹è±¡</span></span><br><span class="line">                        [one yy_modelSetWithDictionary:value];</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Class cls = meta-&gt;_cls;</span><br><span class="line">                        <span class="comment">// ç•¥è¿‡</span></span><br><span class="line">                        <span class="keyword">if</span> (meta-&gt;_hasCustomClassFromDictionary) &#123;</span><br><span class="line">                            cls = [cls modelCustomClassForDictionary:value];</span><br><span class="line">                            <span class="keyword">if</span> (!cls) cls = meta-&gt;_genericCls; <span class="comment">// for xcode code coverage</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// ç”¨ yy_modelSetWithDictionary è¾“å‡ºåŒ–å±æ€§å®ä¾‹å¯¹è±¡ï¼Œèµ‹å€¼</span></span><br><span class="line">                        one = [cls new];</span><br><span class="line">                        [one yy_modelSetWithDictionary:value];</span><br><span class="line">                        ((<span class="type">void</span> (*)(<span class="type">id</span>, SEL, <span class="type">id</span>))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, meta-&gt;_<span class="keyword">setter</span>, (<span class="type">id</span>)one);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Class</span></span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeClass: &#123;</span><br><span class="line">                <span class="keyword">if</span> (isNull) &#123; <span class="comment">// ç©ºï¼Œèµ‹å€¼(Class)NULLï¼Œç”±äº Class å…¶å®æ˜¯ C è¯­è¨€å®šä¹‰çš„ç»“æ„ä½“ï¼Œæ‰€ä»¥ä½¿ç”¨ NULL</span></span><br><span class="line">                    <span class="comment">// å…³äº nilï¼ŒNilï¼ŒNULLï¼ŒNSNullï¼ŒkCFNull çš„æ¨ªå‘æ¯”è¾ƒï¼Œæˆ‘ä¼šå•ç‹¬æ‹å‡ºæ¥åœ¨ä¸‹é¢ä»‹ç»</span></span><br><span class="line">                    ((<span class="type">void</span> (*)(<span class="type">id</span>, SEL, Class))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, meta-&gt;_<span class="keyword">setter</span>, (Class)<span class="literal">NULL</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// åˆ¤æ–­ value å¯èƒ½çš„ç±»å‹ NSString æˆ–åˆ¤æ–­ class_isMetaClass(object_getClass(value))</span></span><br><span class="line">                    <span class="comment">// å¦‚æœæ»¡è¶³æ¡ä»¶åˆ™èµ‹å€¼</span></span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// SEL</span></span><br><span class="line">            <span class="keyword">case</span>  YYEncodingTypeSEL: &#123;</span><br><span class="line">                <span class="comment">// åˆ¤ç©ºï¼Œèµ‹å€¼(SEL)NULL</span></span><br><span class="line">                <span class="comment">// å¦åˆ™è½¬æ¢ç±»å‹ SEL sel = NSSelectorFromString(value); ç„¶åèµ‹å€¼</span></span><br><span class="line">                ...</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="comment">// block</span></span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeBlock: &#123;</span><br><span class="line">                <span class="comment">// åˆ¤ç©ºï¼Œèµ‹å€¼(void (^)())NULL</span></span><br><span class="line">                <span class="comment">// å¦åˆ™åˆ¤æ–­ç±»å‹ [value isKindOfClass:YYNSBlockClass()] ä¹‹åèµ‹å€¼</span></span><br><span class="line">                ...</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// structã€unionã€char[n]ï¼Œå…³äº union å…±åŒä½“æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·± googleï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹</span></span><br><span class="line">            <span class="comment">// union å…±åŒä½“ï¼Œç±»ä¼¼ struct çš„å­˜åœ¨ï¼Œä½†æ˜¯ union æ¯ä¸ªæˆå‘˜ä¼šç”¨åŒä¸€ä¸ªå­˜å‚¨ç©ºé—´ï¼Œåªèƒ½å­˜å‚¨æœ€åä¸€ä¸ªæˆå‘˜çš„ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeStruct:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeUnion:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeCArray: &#123;</span><br><span class="line">                <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSValue</span> <span class="keyword">class</span>]]) &#123; </span><br><span class="line">                    <span class="comment">// æ¶‰åŠ Type Encodings</span></span><br><span class="line">                    <span class="keyword">const</span> <span class="type">char</span> *valueType = ((<span class="built_in">NSValue</span> *)value).objCType;</span><br><span class="line">                    <span class="keyword">const</span> <span class="type">char</span> *metaType = meta-&gt;_info.typeEncoding.UTF8String;</span><br><span class="line">                    <span class="comment">// æ¯”è¾ƒ valueType ä¸ metaType æ˜¯å¦ç›¸åŒï¼Œç›¸åŒï¼ˆstrcmp(a, b) è¿”å› 0ï¼‰åˆ™èµ‹å€¼</span></span><br><span class="line">                    <span class="keyword">if</span> (valueType &amp;&amp; metaType &amp;&amp; strcmp(valueType, metaType) == <span class="number">0</span>) &#123;</span><br><span class="line">                        [model setValue:value forKey:meta-&gt;_name];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// void* æˆ– char*</span></span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypePointer:</span><br><span class="line">            <span class="keyword">case</span> YYEncodingTypeCString: &#123;</span><br><span class="line">                <span class="keyword">if</span> (isNull) &#123; <span class="comment">// åˆ¤ç©ºï¼Œèµ‹å€¼(void *)NULL</span></span><br><span class="line">                    ((<span class="type">void</span> (*)(<span class="type">id</span>, SEL, <span class="type">void</span> *))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, meta-&gt;_<span class="keyword">setter</span>, (<span class="type">void</span> *)<span class="literal">NULL</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSValue</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                    <span class="comment">// æ¶‰åŠ Type Encodings</span></span><br><span class="line">                    <span class="built_in">NSValue</span> *nsValue = value;</span><br><span class="line">                    <span class="keyword">if</span> (nsValue.objCType &amp;&amp; strcmp(nsValue.objCType, <span class="string">&quot;^v&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                        ((<span class="type">void</span> (*)(<span class="type">id</span>, SEL, <span class="type">void</span> *))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, meta-&gt;_<span class="keyword">setter</span>, nsValue.pointerValue);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¢ ğŸ˜“ æˆ‘æ˜¯çœŸçš„å·²ç»å¿½ç•¥æ‰å¾ˆå¤šä»£ç äº†ï¼Œæ²¡åŠæ³•è¿˜æ˜¯æœ‰ç‚¹é•¿ã€‚å…¶å®ä»£ç é€»è¾‘è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œåªæ˜¯æ¨¡å‹èµ‹å€¼æ¶‰åŠçš„ç¼–ç ç±»å‹ç­‰çç¢é€»è¾‘æ¯”è¾ƒå¤šå¯¼è‡´ä»£ç é‡æ¯”è¾ƒå¤§ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥æ€»ç»“ä¸€ä¸‹æ ¸å¿ƒä»£ç çš„å®ç°é€»è¾‘ã€‚</p>
<ul>
<li>æ ¹æ®å±æ€§å…ƒç±»å‹åˆ’åˆ†ä»£ç é€»è¾‘</li>
<li>å¦‚æœå±æ€§å…ƒæ˜¯ CNumber ç±»å‹ï¼Œå³ intã€uint ä¹‹ç±»ï¼Œåˆ™ä½¿ç”¨ <code>ModelSetNumberToProperty</code> èµ‹å€¼</li>
<li>å¦‚æœå±æ€§å…ƒå±äº NSType ç±»å‹ï¼Œå³ NSStringã€NSNumber ä¹‹ç±»ï¼Œåˆ™æ ¹æ®ç±»å‹è½¬æ¢ä¸­å¯èƒ½æ¶‰åŠåˆ°çš„å¯¹åº”ç±»å‹åšé€»è¾‘åˆ¤æ–­å¹¶èµ‹å€¼ï¼ˆå¯ä»¥å»ä¸Šé¢ä»£ç ä¸­æŸ¥çœ‹å…·ä½“å®ç°é€»è¾‘ï¼‰</li>
<li>å¦‚æœå±æ€§å…ƒä¸å±äº CNumber å’Œ NSTypeï¼Œåˆ™çŒœæµ‹ä¸º idï¼ŒClassï¼ŒSELï¼ŒBlockï¼Œstructã€unionã€char[n]ï¼Œvoid<em> æˆ– char</em> ç±»å‹å¹¶ä¸”åšå‡ºç›¸åº”çš„è½¬æ¢å’Œèµ‹å€¼</li>
</ul>
<p>å˜›~ å…¶å®ä¸Šé¢çš„ä»£ç é™¤äº†é•¿ä»¥å¤–é€»è¾‘è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œæ€»ç»“èµ·æ¥å°±æ˜¯æ ¹æ®å¯èƒ½å‡ºç°çš„ç±»å‹å»åšå‡ºå¯¹åº”çš„é€»è¾‘æ“ä½œï¼Œå»ºè®®å„ä½æœ‰æ—¶é—´è¿˜æ˜¯å»è¯»ä¸‹æºç ï¼Œå°¤å…¶æ˜¯è‡ªå·±é¡¹ç›®ä¸­ç”¨åˆ° YYModel çš„åŒå­¦ã€‚ç›¸ä¿¡çœ‹å®Œä¹‹åä¼šå¯¹ YYModel å±æ€§èµ‹å€¼ä¸€æ¸…äºŒæ¥šï¼Œè¿™æ ·åœ¨ä½¿ç”¨ YYModel çš„æ—¥å¸¸ä¸­å‡ºç°ä»»ä½•é—®é¢˜éƒ½å¯ä»¥å¿ƒä¸­æœ‰æ•°ï¼Œæ”¹èµ·ä»£ç è‡ªç„¶å¦‚æœ‰ç¥åŠ©å“ˆã€‚</p>
<p>é¢â€¦è€ƒè™‘åˆ° NSDictionary to Model çš„æ•´ä¸ªè¿‡ç¨‹ä»£ç é‡ä¸å°ï¼Œæˆ‘èŠ±äº†ä¸€äº›æ—¶é—´å°†å…¶é€»è¾‘æ€»ç»“å½’çº³ä¸ºä¸€å¼ å›¾ï¼š</p>
<img src="/yymodel0x02/d2m.png" class="">
<p>å¸Œæœ›å¯ä»¥å°½è‡ªå·±çš„åŠªåŠ›è®©æ–‡ç« çš„è¡¨è¿°å˜å¾—æ›´ç›´ç™½ã€‚</p>
<h3 id="Model-to-JSON"><a href="#Model-to-JSON" class="headerlink" title="Model to JSON"></a>Model to JSON</h3><img src="/yymodel0x02/m2j.jpg" class="">
<p>ç›¸æ¯”äº JSON to Model æ¥è¯´ï¼ŒModel to JSON æ›´ç®€å•ä¸€äº›ã€‚å…¶ä¸­å› ä¸º NSJSONSerialization åœ¨å¯¹ JSON çš„è½¬æ¢æ—¶åšäº†ä¸€äº›è§„å®šï¼š</p>
<ul>
<li>é¡¶çº§å¯¹è±¡æ˜¯ NSArray æˆ–è€… NSDictionary ç±»å‹</li>
<li>æ‰€æœ‰çš„å¯¹è±¡éƒ½æ˜¯ NSString, NSNumber, NSArray, NSDictionary, æˆ– NSNull çš„å®ä¾‹</li>
<li>æ‰€æœ‰å­—å…¸ä¸­çš„ key éƒ½æ˜¯ä¸€ä¸ª NSString å®ä¾‹</li>
<li>Numbers æ˜¯é™¤å»æ— ç©·å¤§å’Œ NaN çš„å…¶ä»–è¡¨ç¤º</li>
</ul>
<blockquote>
<p>Note: ä¸Šæ–‡å‡ºè‡ª <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/foundation/nsjsonserialization">NSJSONSerialization å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
</blockquote>
<p>çŸ¥é“äº†è¿™ä¸€ç‚¹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä» YYModel çš„ Model to JSON æ¥å£ <code>yy_modelToJSONObject</code> å¤„å¼€å§‹è§£è¯»æºç äº†ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">id</span>)yy_modelToJSONObject &#123;</span><br><span class="line">    <span class="comment">// é€’å½’è½¬æ¢æ¨¡å‹åˆ° JSON</span></span><br><span class="line">    <span class="type">id</span> jsonObject = ModelToJSONObjectRecursive(<span class="keyword">self</span>);</span><br><span class="line">    <span class="keyword">if</span> ([jsonObject isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> jsonObject;</span><br><span class="line">    <span class="keyword">if</span> ([jsonObject isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> jsonObject;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å˜›~ ä¸€å…± 4 è¡Œä»£ç ï¼Œåªéœ€è¦å…³æ³¨ä¸€ä¸‹ç¬¬ä¸€è¡Œä»£ç ä¸­çš„ <code>ModelToJSONObjectRecursive</code> æ–¹æ³•ï¼Œ<code>Objective-C</code> çš„è¯­è¨€ç‰¹æ€§å†³å®šäº†ä»å‡½æ•°åç§°å³å¯æ— éœ€æ³¨é‡Šçœ‹æ‡‚ä»£ç ï¼Œè¿™ä¸ªæ–¹æ³•ä»åå­—ä¸Šå°±å¯ä»¥ get åˆ°å®ƒæ˜¯é€šè¿‡é€’å½’æ–¹æ³•ä½¿ Model è½¬æ¢ä¸º JSON çš„ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€’å½’è½¬æ¢æ¨¡å‹åˆ° JSONï¼Œå¦‚æœè½¬æ¢å¼‚å¸¸åˆ™è¿”å› nil</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">id</span> ModelToJSONObjectRecursive(<span class="built_in">NSObject</span> *model) &#123;</span><br><span class="line">    <span class="comment">// åˆ¤ç©ºæˆ–è€…å¯ä»¥ç›´æ¥è¿”å›çš„å¯¹è±¡ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (!model || model == (<span class="type">id</span>)kCFNull) <span class="keyword">return</span> model;</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> model;</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSNumber</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> model;</span><br><span class="line">    <span class="comment">// å¦‚æœ model ä»å±äº NSDictionary</span></span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå¯ä»¥ç›´æ¥è½¬æ¢ä¸º JSON æ•°æ®ï¼Œåˆ™è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> ([<span class="built_in">NSJSONSerialization</span> isValidJSONObject:model]) <span class="keyword">return</span> model;</span><br><span class="line">        <span class="built_in">NSMutableDictionary</span> *newDic = [<span class="built_in">NSMutableDictionary</span> new];</span><br><span class="line">        <span class="comment">// éå† model çš„ key å’Œ value</span></span><br><span class="line">        [((<span class="built_in">NSDictionary</span> *)model) enumerateKeysAndObjectsUsingBlock:^(<span class="built_in">NSString</span> *key, <span class="type">id</span> obj, <span class="type">BOOL</span> *stop) &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *stringKey = [key isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]] ? key : key.description;</span><br><span class="line">            <span class="keyword">if</span> (!stringKey) <span class="keyword">return</span>;</span><br><span class="line">            <span class="comment">// é€’å½’è§£æ value </span></span><br><span class="line">            <span class="type">id</span> jsonObj = ModelToJSONObjectRecursive(obj);</span><br><span class="line">            <span class="keyword">if</span> (!jsonObj) jsonObj = (<span class="type">id</span>)kCFNull;</span><br><span class="line">            newDic[stringKey] = jsonObj;</span><br><span class="line">        &#125;];</span><br><span class="line">        <span class="keyword">return</span> newDic;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœ model ä»å±äº NSSet</span></span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSSet</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœèƒ½å¤Ÿç›´æ¥è½¬æ¢ JSON å¯¹è±¡ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="comment">// å¦åˆ™éå†ï¼ŒæŒ‰éœ€è¦é€’å½’è§£æ</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœèƒ½å¤Ÿç›´æ¥è½¬æ¢ JSON å¯¹è±¡ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="comment">// å¦åˆ™éå†ï¼ŒæŒ‰éœ€è¦é€’å½’è§£æ</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¯¹ NSURL, NSAttributedString, NSDate, NSData åšç›¸åº”å¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSURL</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> ((<span class="built_in">NSURL</span> *)model).absoluteString;</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSAttributedString</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> ((<span class="built_in">NSAttributedString</span> *)model).string;</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSDate</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> [YYISODateFormatter() stringFromDate:(<span class="type">id</span>)model];</span><br><span class="line">    <span class="keyword">if</span> ([model isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨ [model class] åˆå§‹åŒ–ä¸€ä¸ªæ¨¡å‹å…ƒ</span></span><br><span class="line">    _YYModelMeta *modelMeta = [_YYModelMeta metaWithClass:[model <span class="keyword">class</span>]];</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜ å°„è¡¨ä¸ºç©ºï¼Œåˆ™ä¸åšè§£æç›´æ¥è¿”å› nil</span></span><br><span class="line">    <span class="keyword">if</span> (!modelMeta || modelMeta-&gt;_keyMappedCount == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚ï¼Œä½¿ç”¨ __unsafe_unretained æ¥é¿å…åœ¨ä¸‹é¢éå† block ä¸­ç›´æ¥ä½¿ç”¨ result æŒ‡é’ˆé€ æˆçš„ä¸å¿…è¦ retain ä¸ release å¼€é”€</span></span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *result = [[<span class="built_in">NSMutableDictionary</span> alloc] initWithCapacity:<span class="number">64</span>];</span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> <span class="built_in">NSMutableDictionary</span> *dic = result;</span><br><span class="line">    <span class="comment">// éå†æ¨¡å‹å…ƒå±æ€§æ˜ å°„å­—å…¸</span></span><br><span class="line">    [modelMeta-&gt;_mapper enumerateKeysAndObjectsUsingBlock:^(<span class="built_in">NSString</span> *propertyMappedKey, _YYModelPropertyMeta *propertyMeta, <span class="type">BOOL</span> *stop) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœéå†å½“å‰å±æ€§å…ƒæ²¡æœ‰ getter æ–¹æ³•ï¼Œè·³è¿‡</span></span><br><span class="line">        <span class="keyword">if</span> (!propertyMeta-&gt;_<span class="keyword">getter</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="type">id</span> value = <span class="literal">nil</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœå±æ€§å…ƒå±äº CNumberï¼Œå³å…¶ type æ˜¯ intã€floatã€double ä¹‹ç±»çš„</span></span><br><span class="line">        <span class="keyword">if</span> (propertyMeta-&gt;_isCNumber) &#123;</span><br><span class="line">            <span class="comment">// ä»å±æ€§ä¸­åˆ©ç”¨ getter æ–¹æ³•å¾—åˆ°å¯¹åº”çš„å€¼</span></span><br><span class="line">            value = ModelCreateNumberFromProperty(model, propertyMeta);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propertyMeta-&gt;_nsType) &#123; <span class="comment">// å±æ€§å…ƒå±äº nsTypeï¼Œå³ NSString ä¹‹ç±»</span></span><br><span class="line">            <span class="comment">// åˆ©ç”¨ getter æ–¹æ³•æ‹¿åˆ° value</span></span><br><span class="line">            <span class="type">id</span> v = ((<span class="type">id</span> (*)(<span class="type">id</span>, SEL))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, propertyMeta-&gt;_<span class="keyword">getter</span>);</span><br><span class="line">            <span class="comment">// å¯¹æ‹¿åˆ°çš„ value é€’å½’è§£æ</span></span><br><span class="line">            value = ModelToJSONObjectRecursive(v);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ ¹æ®å±æ€§å…ƒçš„ type åšç›¸åº”å¤„ç†</span></span><br><span class="line">            <span class="keyword">switch</span> (propertyMeta-&gt;_type &amp; YYEncodingTypeMask) &#123;</span><br><span class="line">                <span class="comment">// idï¼Œéœ€è¦é€’å½’è§£æï¼Œå¦‚æœè§£æå¤±è´¥åˆ™è¿”å› nil</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeObject: &#123;</span><br><span class="line">                    <span class="type">id</span> v = ((<span class="type">id</span> (*)(<span class="type">id</span>, SEL))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, propertyMeta-&gt;_<span class="keyword">getter</span>);</span><br><span class="line">                    value = ModelToJSONObjectRecursive(v);</span><br><span class="line">                    <span class="keyword">if</span> (value == (<span class="type">id</span>)kCFNull) value = <span class="literal">nil</span>;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// Classï¼Œè½¬ NSStringï¼Œè¿”å› Class åç§°</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeClass: &#123;</span><br><span class="line">                    Class v = ((Class (*)(<span class="type">id</span>, SEL))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, propertyMeta-&gt;_<span class="keyword">getter</span>);</span><br><span class="line">                    value = v ? <span class="built_in">NSStringFromClass</span>(v) : <span class="literal">nil</span>;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// SELï¼Œè½¬ NSStringï¼Œè¿”å›ç»™å®š SEL çš„å­—ç¬¦ä¸²è¡¨ç°å½¢å¼</span></span><br><span class="line">                <span class="keyword">case</span> YYEncodingTypeSEL: &#123;</span><br><span class="line">                    SEL v = ((SEL (*)(<span class="type">id</span>, SEL))(<span class="type">void</span> *) objc_msgSend)((<span class="type">id</span>)model, propertyMeta-&gt;_<span class="keyword">getter</span>);</span><br><span class="line">                    value = v ? <span class="built_in">NSStringFromSelector</span>(v) : <span class="literal">nil</span>;</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>: <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœ value è¿˜æ˜¯æ²¡èƒ½è§£æï¼Œåˆ™è·³è¿‡</span></span><br><span class="line">        <span class="keyword">if</span> (!value) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å½“å‰å±æ€§å…ƒæ˜¯ KeyPath æ˜ å°„ï¼Œå³ a.b.c ä¹‹ç±»</span></span><br><span class="line">        <span class="keyword">if</span> (propertyMeta-&gt;_mappedToKeyPath) &#123;</span><br><span class="line">            <span class="built_in">NSMutableDictionary</span> *superDic = dic;</span><br><span class="line">            <span class="built_in">NSMutableDictionary</span> *subDic = <span class="literal">nil</span>;</span><br><span class="line">            <span class="comment">// _mappedToKeyPath æ˜¯ a.b.c æ ¹æ® &#x27;.&#x27; æ‹†åˆ†æˆçš„å­—ç¬¦ä¸²æ•°ç»„ï¼Œéå† _mappedToKeyPath</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>, max = propertyMeta-&gt;_mappedToKeyPath.count; i &lt; max; i++) &#123;</span><br><span class="line">                <span class="built_in">NSString</span> *key = propertyMeta-&gt;_mappedToKeyPath[i];</span><br><span class="line">                <span class="comment">// éå†åˆ°ç»“å°¾</span></span><br><span class="line">                <span class="keyword">if</span> (i + <span class="number">1</span> == max) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœç»“å°¾çš„ key ä¸º nilï¼Œåˆ™ä½¿ç”¨ value èµ‹å€¼</span></span><br><span class="line">                    <span class="keyword">if</span> (!superDic[key]) superDic[key] = value;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// ç”¨ subDic æ‹¿åˆ°å½“å‰ key å¯¹åº”çš„å€¼</span></span><br><span class="line">                subDic = superDic[key];</span><br><span class="line">                <span class="comment">// å¦‚æœ subDic å­˜åœ¨</span></span><br><span class="line">                <span class="keyword">if</span> (subDic) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœ subDic ä»å±äº NSDictionary</span></span><br><span class="line">                    <span class="keyword">if</span> ([subDic isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                        <span class="comment">// å°† subDic çš„ mutable ç‰ˆæœ¬èµ‹å€¼ç»™ superDic[key]</span></span><br><span class="line">                        subDic = subDic.mutableCopy;</span><br><span class="line">                        superDic[key] = subDic;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// å°† NSMutableDictionary èµ‹å€¼ç»™ superDic[key]</span></span><br><span class="line">                    <span class="comment">// æ³¨æ„è¿™é‡Œä½¿ç”¨ subDic é—´æ¥èµ‹å€¼æ˜¯æœ‰åŸå› çš„ï¼ŒåŸå› å°±åœ¨ä¸‹é¢</span></span><br><span class="line">                    subDic = [<span class="built_in">NSMutableDictionary</span> new];</span><br><span class="line">                    superDic[key] = subDic;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// superDic æŒ‡å‘ subDicï¼Œè¿™æ ·åœ¨éå† _mappedToKeyPath æ—¶å³å¯é€å±‚è§£æ</span></span><br><span class="line">                <span class="comment">// è¿™å°±æ˜¯ä¸Šé¢å…ˆæŠŠ subDic è½¬ä¸º NSMutableDictionary çš„åŸå› </span></span><br><span class="line">                superDic = subDic;</span><br><span class="line">                subDic = <span class="literal">nil</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸æ˜¯ KeyPath åˆ™æ£€æµ‹ dic[propertyMeta-&gt;_mappedToKey]ï¼Œå¦‚æœä¸º nil åˆ™èµ‹å€¼ value</span></span><br><span class="line">            <span class="keyword">if</span> (!dic[propertyMeta-&gt;_mappedToKey]) &#123;</span><br><span class="line">                dic[propertyMeta-&gt;_mappedToKey] = value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¿½ç•¥ï¼Œå¯¹åº” modelCustomTransformToDictionary æ¥å£</span></span><br><span class="line">    <span class="keyword">if</span> (modelMeta-&gt;_hasCustomTransformToDictionary) &#123;</span><br><span class="line">        <span class="comment">// ç”¨äºåœ¨é»˜è®¤çš„ Model è½¬ JSON è¿‡ç¨‹ä¸é€‚åˆå½“å‰ Model ç±»å‹æ—¶æä¾›è‡ªå®šä¹‰é¢å¤–è¿‡ç¨‹</span></span><br><span class="line">        <span class="comment">// ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•æ¥éªŒè¯è½¬æ¢ç»“æœ</span></span><br><span class="line">        <span class="type">BOOL</span> suc = [((<span class="type">id</span>&lt;YYModel&gt;)model) modelCustomTransformToDictionary:dic];</span><br><span class="line">        <span class="keyword">if</span> (!suc) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¢â€¦ä»£ç è¿˜æ˜¯æœ‰äº›é•¿ï¼Œä¸è¿‡ç›¸æ¯”äºä¹‹å‰ JSON to Model æ–¹å‘ä¸Šç”± <code>yy_modelSetWithDictionary</code>ï¼Œ<code>ModelSetWithDictionaryFunction</code> å’Œ <code>ModelSetValueForProperty</code> ä¸‰ä¸ªæ–¹æ³•æ„æˆçš„é—´æ¥é€’å½’æ¥è¯´ç®—æ˜¯éå¸¸ç®€å•äº†ï¼Œé‚£ä¹ˆæ€»ç»“ä¸€ä¸‹ä¸Šé¢çš„ä»£ç é€»è¾‘ã€‚</p>
<ul>
<li>åˆ¤æ–­å…¥å‚ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶å¯ä»¥ç›´æ¥è¿”å›</li>
<li>å¦‚æœ Model ä»å±äº NSTypeï¼Œåˆ™æ ¹æ®ä¸åŒçš„ç±»å‹åšé€»è¾‘å¤„ç†</li>
<li>å¦‚æœä¸Šé¢æ¡ä»¶ä¸è¢«æ»¡è¶³ï¼Œåˆ™ç”¨ Model çš„ Class åˆå§‹åŒ–ä¸€ä¸ªæ¨¡å‹å…ƒ _YYModelMeta</li>
<li>åˆ¤æ–­æ¨¡å‹å…ƒçš„æ˜ å°„å…³ç³»ï¼Œéå†æ˜ å°„è¡¨æ‹¿åˆ°å¯¹åº”é”®å€¼å¯¹å¹¶å­˜å…¥å­—å…¸ä¸­å¹¶è¿”å›</li>
</ul>
<blockquote>
<p>Note: è¿™é‡Œæœ‰ä¸€ä¸ªæ€§èƒ½ä¼˜åŒ–çš„ç»†èŠ‚ï¼Œç”¨ <code>__unsafe_unretained</code> ä¿®é¥°çš„ dic æŒ‡å‘æˆ‘ä»¬æœ€åè¦ return çš„ NSMutableDictionary *resultï¼Œçœ‹ä½œè€…çš„æ³¨é‡Šï¼š<code>// avoid retain and release in block</code> æ˜¯ä¸ºäº†é¿å…ç›´æ¥ä½¿ç”¨ <code>result</code> åœ¨åé¢éå†æ˜ å°„è¡¨çš„ä»£ç å—ä¸­ä¸å¿…è¦çš„ retain å’Œ release æ“ä½œä»¥èŠ‚çœå¼€é”€ã€‚</p>
</blockquote>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul>
<li>æ–‡ç« ç´§æ¥ä¸Šæ–‡<a href="https://lision.me/yymodel_x01/">ã€Šæ­ç§˜ YYModel çš„é­”æ³•ï¼ˆä¸Šï¼‰ã€‹</a>ä¸­å¯¹ YYModel ä»£ç ç»“æ„çš„è®²è§£åå°†é‡ç‚¹æ”¾åˆ°äº†å¯¹ JSON æ¨¡å‹ç›¸äº’è½¬æ¢çš„å®ç°é€»è¾‘ä¸Šã€‚</li>
<li>ä» JSON æ¨¡å‹çš„è½¬æ¢æ–¹å‘ä¸Šåˆ’åˆ†ï¼Œå°† YYModel çš„ JSON æ¨¡å‹è½¬æ¢è¿‡ç¨‹æ­£åæ–¹å‘å‰–ææ­ç§˜ï¼Œå¸Œæœ›å¯ä»¥è§£å¼€å¤§å®¶å¯¹ JSON æ¨¡å‹è‡ªåŠ¨è½¬æ¢çš„ç–‘æƒ‘ã€‚</li>
</ul>
<p>æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜ <a href="https://lision.me/">https://lision.me/</a>ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ <a href="https://lision.me/">ä¸ªäººåšå®¢</a> ä¸­æ›´æ–°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš <a target="_blank" rel="noopener" href="https://weibo.com/lisioncode">@Lision</a> è”ç³»æˆ‘~</p>
<p>å¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~</p>


    
    
    
	  <div class="tags">
      <a class="tag-none-link" href="/tags/yykit/" rel="tag">yykit</a><a class="tag-none-link" href="/tags/yymodel/" rel="tag">yymodel</a>
	  </div>
    

  </section>
</article>
  
    <article class="post ">

  
  <h2 class="title">
    <a href="/yymodel0x01/">
      æ­ç§˜ YYModel çš„é­”æ³• 0x01
    </a>
  </h2>
  
  <time>
    11æœˆ 12, 2017
  </time>
  <section class="content">
	  <img src="/yymodel0x01/design_model_0x01.jpg" class="">
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>iOS å¼€å‘ä¸­å°‘ä¸äº†å„ç§å„æ ·çš„æ¨¡å‹ï¼Œä¸è®ºæ˜¯é‡‡ç”¨ MVCã€MVP è¿˜æ˜¯ MVVM è®¾è®¡æ¨¡å¼éƒ½é€ƒä¸è¿‡ Modelã€‚</p>
<p>é‚£ä¹ˆå¤§å®¶åœ¨ä½¿ç”¨ Model çš„æ—¶å€™è‚¯å®šé‡åˆ°è¿‡ä¸€ä¸ªé—®é¢˜ï¼Œå³æ¥å£ä¼ é€’è¿‡æ¥çš„æ•°æ®ï¼ˆä¸€èˆ¬æ˜¯ JSON æ ¼å¼ï¼‰éœ€è¦è½¬æ¢ä¸º iOS å†…æˆ‘ä»¬èƒ½ç›´æ¥ä½¿ç”¨çš„æ¨¡å‹ï¼ˆç±»ï¼‰ã€‚iOS å¼€å‘æ—©æœŸç¬¬ä¸‰æ–¹æ¡†æ¶æ²¡æœ‰é‚£ä¹ˆå¤šï¼Œå¤§å®¶å¯èƒ½ä¼šæ‰‹å†™ç›¸å…³ä»£ç ï¼Œä½†æ˜¯éšç€ä¸šåŠ¡çš„æ‰©å±•ï¼Œæ¨¡å‹çš„å¢å¤šï¼Œè¿™äº›æ²¡ä»€ä¹ˆæŠ€æœ¯å«é‡çš„ä»£ç åªæ˜¯åœ¨é‡å¤çš„æµªè´¹æˆ‘ä»¬çš„åŠ³åŠ¨åŠ›è€Œå·²ã€‚</p>
<p>è¿™æ—¶å€™å°±éœ€è¦ä¸€ç§å·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬æŠŠåŠ³åŠ¨åŠ›ä»è¿™äº›æ— æ„ä¹‰çš„ç¹çä»£ç ä¸­è§£æ”¾å‡ºæ¥ï¼Œäºæ˜¯ GitHub ä¸Šå‡ºç°äº†å¾ˆå¤šè§£å†³æ­¤ç±»é—®é¢˜çš„ç¬¬ä¸‰æ–¹åº“ï¼Œè¯¸å¦‚ Mantleã€JSONModelã€MJExtension ä»¥åŠ YYModel ç­‰ç­‰ã€‚</p>
<p>è¿™äº›åº“çš„ç¥å¥‡ä¹‹å¤„åœ¨äºå®ƒä»¬æä¾›äº†æ¨¡å‹ä¸ JSON æ•°æ®çš„è‡ªåŠ¨è½¬æ¢åŠŸèƒ½ï¼Œä»¿ä½›å…·æœ‰é­”æ³•ä¸€èˆ¬ï¼æœ¬æ–‡å°†é€šè¿‡å‰–æ YYModel æºç ä¸€æ­¥ä¸€æ­¥ç ´è§£è¿™â€œç¥å¥‡â€çš„é­”æ³•ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ibireme/YYModel">YYModel</a> æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ iOS/OSX æ¨¡å‹è½¬æ¢æ¡†æ¶ï¼ˆè¯¥é¡¹ç›®æ˜¯ <a target="_blank" rel="noopener" href="https://github.com/ibireme/YYKit">YYKit</a> ç»„ä»¶ä¹‹ä¸€ï¼‰ã€‚YYKit åœ¨æˆ‘ä¹‹å‰çš„æ–‡ç« ã€<a href="https://lision.me/yycache/">ä» YYCache æºç  Get åˆ°å¦‚ä½•è®¾è®¡ä¸€ä¸ªä¼˜ç§€çš„ç¼“å­˜</a>ã€‘ä¸­å·²ç»å¾ˆè¯¦ç»†çš„ä»‹ç»è¿‡äº†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç‚¹è¿›å»äº†è§£ä¸€ä¸‹ã€‚</p>
<p>YYModel æ˜¯ä¸€ä¸ªéå¸¸è½»é‡çº§çš„ JSON æ¨¡å‹è‡ªåŠ¨è½¬æ¢åº“ï¼Œä»£ç é£æ ¼è‰¯å¥½ä¸”æ€è·¯æ¸…æ™°ï¼Œå¯ä»¥ä»æºç ä¸­çœ‹åˆ°ä½œè€…å¯¹ Runtime æ·±åšçš„ç†è§£ã€‚éš¾èƒ½å¯è´µçš„æ˜¯ YYModel åœ¨å…¶è½»é‡çº§çš„ä»£ç ä¸‹è¿˜ä¿ç•™ç€è‡ªåŠ¨ç±»å‹è½¬æ¢ï¼Œç±»å‹å®‰å…¨ï¼Œæ— ä¾µå…¥ç­‰ç‰¹æ€§ï¼Œå¹¶ä¸”å…·æœ‰æ¥è¿‘æ‰‹å†™è§£æä»£ç çš„è¶…é«˜æ€§èƒ½ã€‚</p>
<blockquote>
<p>å¤„ç† GithubUser æ•°æ® 10000 æ¬¡è€—æ—¶ç»Ÿè®¡ (iPhone 6):</p>
</blockquote>
<img src="/yymodel0x01/yymodel_performance.png" class="">
<h2 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h2><ul>
<li>YYModel ç®€ä»‹</li>
<li>YYClassInfo å‰–æ</li>
<li>NSObject+YYModel æ¢ç©¶</li>
<li>JSON ä¸ Model ç›¸äº’è½¬æ¢</li>
<li>æ€»ç»“</li>
</ul>
<h2 id="YYModel-ç®€ä»‹"><a href="#YYModel-ç®€ä»‹" class="headerlink" title="YYModel ç®€ä»‹"></a>YYModel ç®€ä»‹</h2><img src="/yymodel0x01/yymodel.png" class="">
<p>æ’¸äº†ä¸€é YYModel çš„æºç ï¼Œæœç„¶æ˜¯éå¸¸è½»é‡çº§çš„ JSON æ¨¡å‹è‡ªåŠ¨è½¬æ¢åº“ï¼ŒåŠ ä¸Š YYModel.h ä¸€å…±ä¹Ÿåªæœ‰ 5 ä¸ªæ–‡ä»¶ã€‚</p>
<p>æŠ›å¼€ YYModel.h æ¥çœ‹ï¼Œå…¶å®åªæœ‰ YYClassInfo å’Œ NSObject+YYModel ä¸¤ä¸ªæ¨¡å—ã€‚</p>
<ul>
<li>YYClassInfo ä¸»è¦å°† Runtime å±‚çº§çš„ä¸€äº›ç»“æ„ä½“å°è£…åˆ° NSObject å±‚çº§ä»¥ä¾¿è°ƒç”¨ã€‚</li>
<li>NSObject+YYModel è´Ÿè´£æä¾›æ–¹ä¾¿è°ƒç”¨çš„æ¥å£ä»¥åŠå®ç°å…·ä½“çš„æ¨¡å‹è½¬æ¢é€»è¾‘ï¼ˆå€ŸåŠ© YYClassInfo ä¸­çš„å°è£…ï¼‰ã€‚</li>
</ul>
<h2 id="YYClassInfo-å‰–æ"><a href="#YYClassInfo-å‰–æ" class="headerlink" title="YYClassInfo å‰–æ"></a>YYClassInfo å‰–æ</h2><img src="/yymodel0x01/yyclassinfo.jpg" class="">
<p>å‰é¢è¯´åˆ° YYClassInfo ä¸»è¦å°† Runtime å±‚çº§çš„ä¸€äº›ç»“æ„ä½“å°è£…åˆ° NSObject å±‚çº§ä»¥ä¾¿è°ƒç”¨ï¼Œæˆ‘è§‰å¾—å¦‚æœéœ€è¦ä¸ Runtime å±‚çº§çš„ç»“æ„ä½“åšå¯¹æ¯”çš„è¯ï¼Œæ²¡ä»€ä¹ˆæ¯”è¡¨æ ¼æ¥çš„æ›´ç®€å•ç›´è§‚äº†ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">YYClassInfo</th>
<th style="text-align:center">Runtime</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">YYClassIvarInfo</td>
<td style="text-align:center"><code>objc_ivar</code></td>
</tr>
<tr>
<td style="text-align:center">YYClassMethodInfo</td>
<td style="text-align:center"><code>objc_method</code></td>
</tr>
<tr>
<td style="text-align:center">YYClassPropertyInfo</td>
<td style="text-align:center"><code>property_t</code></td>
</tr>
<tr>
<td style="text-align:center">YYClassInfo</td>
<td style="text-align:center"><code>objc_class</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>Note: æœ¬æ¬¡æ¯”è¾ƒåŸºäº <a target="_blank" rel="noopener" href="https://opensource.apple.com/tarballs/objc4/">Runtime æºç </a> 723 ç‰ˆæœ¬ã€‚</p>
</blockquote>
<p>å®‰~ æ—¢ç„¶æ˜¯å‰–æè‚¯å®šä¸ä¼šåˆ—ä¸ªè¡¨æ ¼è¿™æ ·å­å“ˆã€‚</p>
<h3 id="YYClassIvarInfo-amp-amp-objc-ivar"><a href="#YYClassIvarInfo-amp-amp-objc-ivar" class="headerlink" title="YYClassIvarInfo &amp;&amp; objc_ivar"></a>YYClassIvarInfo &amp;&amp; objc_ivar</h3><p>æˆ‘æŠŠ YYClassIvarInfo çœ‹åšæ˜¯ä½œè€…å¯¹ Runtime å±‚ <code>objc_ivar</code> ç»“æ„ä½“çš„å°è£…ï¼Œ<code>objc_ivar</code> æ˜¯ Runtime ä¸­è¡¨ç¤ºå˜é‡çš„ç»“æ„ä½“ã€‚</p>
<ul>
<li>YYClassIvarInfo</li>
</ul>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYClassIvarInfo</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) Ivar ivar; <span class="comment">///&lt; å˜é‡ï¼Œå¯¹åº” objc_ivar</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *name; <span class="comment">///&lt; å˜é‡åç§°ï¼Œå¯¹åº” ivar_name</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) ptrdiff_t offset; <span class="comment">///&lt; å˜é‡åç§»é‡ï¼Œå¯¹åº” ivar_offset</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *typeEncoding; <span class="comment">///&lt; å˜é‡ç±»å‹ç¼–ç ï¼Œé€šè¿‡ ivar_getTypeEncoding å‡½æ•°å¾—åˆ°</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) YYEncodingType type; <span class="comment">///&lt; å˜é‡ç±»å‹ï¼Œé€šè¿‡ YYEncodingGetType æ–¹æ³•ä»ç±»å‹ç¼–ç ä¸­å¾—åˆ°</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithIvar:(Ivar)ivar;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>objc_ivar</code></li>
</ul>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_ivar &#123;</span><br><span class="line">    <span class="type">char</span> * _Nullable ivar_name OBJC2_UNAVAILABLE; <span class="comment">// å˜é‡åç§°</span></span><br><span class="line">    <span class="type">char</span> * _Nullable ivar_type OBJC2_UNAVAILABLE; <span class="comment">// å˜é‡ç±»å‹</span></span><br><span class="line">    <span class="type">int</span> ivar_offset OBJC2_UNAVAILABLE; <span class="comment">// å˜é‡åç§»é‡</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __LP64__ <span class="comment">// å¦‚æœå·²å®šä¹‰ __LP64__ åˆ™è¡¨ç¤ºæ­£åœ¨æ„å»º 64 ä½ç›®æ ‡</span></span></span><br><span class="line">    <span class="type">int</span> space OBJC2_UNAVAILABLE; <span class="comment">// å˜é‡ç©ºé—´</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: æ—¥å¸¸å¼€å‘ä¸­ NSString ç±»å‹çš„å±æ€§æˆ‘ä»¬éƒ½ä¼šç”¨ copy æ¥ä¿®é¥°ï¼Œè€Œ YYClassIvarInfo ä¸­çš„ <code>name</code> å’Œ <code>typeEncoding</code> å±æ€§éƒ½ç”¨ strong ä¿®é¥°ã€‚å› ä¸ºå…¶å†…éƒ¨æ˜¯å…ˆé€šè¿‡ Runtime æ–¹æ³•æ‹¿åˆ° <code>const char *</code> ä¹‹åé€šè¿‡ <code>stringWithUTF8String</code> æ–¹æ³•è½¬ä¸º NSString çš„ã€‚æ‰€ä»¥å³ä¾¿æ˜¯ NSString è¿™ç±»å±æ€§åœ¨ç¡®å®šå…¶ä¸ä¼šåœ¨åˆå§‹åŒ–ä¹‹åè¢«ä¿®æ”¹çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ strong åšä¸€æ¬¡å•çº¯çš„å¼ºå¼•ç”¨åœ¨æ€§èƒ½ä¸Šè®²æ¯” copy è¦é«˜ä¸€äº›ã€‚</p>
</blockquote>
<p>å›§~ ä¸çŸ¥é“è®²çš„è¿™ä¹ˆç»†ä¼šä¸ä¼šåè€Œå¼•èµ·åæ„Ÿï¼Œå¦‚æœå¯¹æ–‡ç« æœ‰ä»€ä¹ˆå»ºè®®å¯ä»¥è”ç³»æˆ‘ <a target="_blank" rel="noopener" href="https://weibo.com/5071795354/profile">@è–›å®šè°”çš„çŒ¹</a> ã€‚</p>
<blockquote>
<p>Note: ç±»å‹ç¼–ç ï¼Œå…³äº YYClassIvarInfo ä¸­çš„ YYEncodingType ç±»å‹å±æ€§ type çš„è§£æä»£ç ç¯‡å¹…å¾ˆé•¿ï¼Œè€Œä¸”æ²¡æœ‰æ¬å‡ºæ¥çš„å¿…è¦ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ <a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html">Type Encodings</a> å’Œ <a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtPropertyIntrospection.html">Declared Properties</a> é˜…è¯»è¿™éƒ¨åˆ†æºç ã€‚</p>
</blockquote>
<h3 id="YYClassMethodInfo-amp-amp-objc-method"><a href="#YYClassMethodInfo-amp-amp-objc-method" class="headerlink" title="YYClassMethodInfo &amp;&amp; objc_method"></a>YYClassMethodInfo &amp;&amp; objc_method</h3><p>ç›¸åº”çš„ï¼ŒYYClassMethodInfo åˆ™æ˜¯ä½œè€…å¯¹ Runtime ä¸­ <code>objc_method</code> çš„å°è£…ï¼Œ<code>objc_method</code> åœ¨ Runtime æ˜¯ç”¨æ¥å®šä¹‰æ–¹æ³•çš„ç»“æ„ä½“ã€‚</p>
<ul>
<li>YYClassMethodInfo</li>
</ul>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYClassMethodInfo</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) Method method; <span class="comment">///&lt; æ–¹æ³•</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *name; <span class="comment">///&lt; æ–¹æ³•åç§°</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) SEL sel; <span class="comment">///&lt; æ–¹æ³•é€‰æ‹©å™¨</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) IMP imp; <span class="comment">///&lt; æ–¹æ³•å®ç°ï¼ŒæŒ‡å‘å®ç°æ–¹æ³•å‡½æ•°çš„å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *typeEncoding; <span class="comment">///&lt; æ–¹æ³•å‚æ•°å’Œè¿”å›ç±»å‹ç¼–ç </span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *returnTypeEncoding; <span class="comment">///&lt; è¿”å›å€¼ç±»å‹ç¼–ç </span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *argumentTypeEncodings; <span class="comment">///&lt; å‚æ•°ç±»å‹ç¼–ç æ•°ç»„</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithMethod:(Method)method;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>objc_method</code></li>
</ul>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_method &#123;</span><br><span class="line">    SEL _Nonnull method_name OBJC2_UNAVAILABLE; <span class="comment">// æ–¹æ³•åç§°</span></span><br><span class="line">    <span class="type">char</span> * _Nullable method_types OBJC2_UNAVAILABLE; <span class="comment">// æ–¹æ³•ç±»å‹</span></span><br><span class="line">    IMP _Nonnull method_imp OBJC2_UNAVAILABLE; <span class="comment">// æ–¹æ³•å®ç°ï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°åŸºæœ¬ä¹Ÿæ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œé™¤äº†ç±»å‹ç¼–ç çš„é—®é¢˜ä½œè€…ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨åœ¨å°è£…æ—¶è¿›è¡Œäº†æ‰©å±•ã€‚</p>
<p>ä¸ºäº†ç…§é¡¾å¯¹ Runtime è¿˜æ²¡æœ‰ä¸€å®šäº†è§£çš„è¯»è€…ï¼Œæˆ‘è¿™é‡Œç®€å•çš„è§£é‡Šä¸€ä¸‹ <code>objc_method</code> ç»“æ„ä½“ï¼ˆéƒ½æ˜¯æˆ‘è‡ªå·±çš„è®¤çŸ¥ï¼Œæ¬¢è¿è®¨è®ºï¼‰ï¼š</p>
<ul>
<li>SELï¼Œselector åœ¨ Runtime ä¸­çš„è¡¨ç°å½¢å¼ï¼Œå¯ä»¥ç†è§£ä¸ºæ–¹æ³•é€‰æ‹©å™¨</li>
</ul>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_selector *SEL;</span><br></pre></td></tr></table></figure>
<ul>
<li>IMPï¼Œå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘å…·ä½“å®ç°é€»è¾‘çš„å‡½æ•°</li>
</ul>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> !OBJC_OLD_DISPATCH_PROTOTYPES</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">void</span> (*IMP)(<span class="type">void</span> <span class="comment">/* id, SEL, ... */</span> ); </span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">id</span> _Nullable (*IMP)(<span class="type">id</span> _Nonnull, SEL _Nonnull, ...); </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>å…³äºæ›´å¤š Runtime ç›¸å…³çš„çŸ¥è¯†ç”±äºç¯‡å¹…åŸå› ï¼ˆçœŸçš„å†™ä¸å®Œï¼‰å°±ä¸åœ¨è¿™ç¯‡æ–‡ç« ä»‹ç»äº†ï¼Œæˆ‘æ¨èå¤§å®¶å»é±¼ç¥çš„æ–‡ç«  <a target="_blank" rel="noopener" href="http://yulingtianxia.com/blog/2014/11/05/objective-c-runtime/">Objective-C Runtime</a> å­¦ä¹ ï¼ˆå› ä¸ºæˆ‘æœ€æ—©æ¥è§¦ Runtime å°±æ˜¯é€šè¿‡è¿™ç¯‡æ–‡ç« ï¼Œç¬‘~ï¼‰ã€‚</p>
<p>æœ‰è¶£çš„æ˜¯ï¼Œé±¼ç¥çš„æ–‡ç« ä¸­å¯¹ SEL çš„æè¿°æœ‰ä¸€å¥â€œå…¶å®å®ƒå°±æ˜¯ä¸ªæ˜ å°„åˆ°æ–¹æ³•çš„ C å­—ç¬¦ä¸²â€ï¼Œä½†æ˜¯ä»–åœ¨æ–‡ç« ä¸­æ²¡æœ‰ä»‹ç»å‡ºå¤„ã€‚æœ¬ç€å¯¹è‡ªå·±æ–‡ç« è´¨é‡è´Ÿè´£çš„åŸåˆ™ï¼Œå¯¹äºä¸€åˆ‡æ²¡æœ‰å‡ºå¤„çš„è¡¨è¿°éƒ½åº”è¯¥æŒæœ‰æ€€ç–‘çš„æ€åº¦ï¼Œæ‰€ä»¥æˆ‘ä¸‹é¢è®²ä¸€ä¸‹è‡ªå·±çš„å¯¹äº SEL çš„ç†è§£ã€‚</p>
<p>æ’¸äº†å‡ é Runtime æºç ï¼Œå‘ç°ä¸è®ºæ˜¯ objc-runtime-new è¿˜æ˜¯ objc-runtime-old ä¸­éƒ½ç”¨ SEL ç±»å‹ä½œä¸ºæ–¹æ³•ç»“æ„ä½“çš„ name å±æ€§ç±»å‹ï¼Œè€Œä¸”é€šè¿‡ä»¥ä¸‹æºç ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">OBJC_EXPORT SEL _Nonnull sel_registerName(<span class="keyword">const</span> <span class="type">char</span> * _Nonnull str)</span><br><span class="line">    OBJC_AVAILABLE(<span class="number">10.0</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</span><br><span class="line"></span><br><span class="line">OBJC_EXPORT <span class="keyword">const</span> <span class="type">char</span> * _Nonnull sel_getName(SEL _Nonnull sel)</span><br><span class="line">    OBJC_AVAILABLE(<span class="number">10.0</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°é€šè¿‡ä¸€ä¸ª <code>const char *</code> ç±»å‹çš„å­—ç¬¦ä¸²å³å¯åœ¨ Runtime ç³»ç»Ÿä¸­æ³¨å†Œå¹¶è¿”å›ä¸€ä¸ª SELï¼Œæ–¹æ³•çš„åç§°åˆ™ä¼šæ˜ å°„åˆ°è¿™ä¸ª SELã€‚</p>
<blockquote>
<p>å®˜æ–¹æ³¨é‡Šï¼š<br>Registers a method with the Objective-C runtime system, maps the method name to a selector, and returns the selector value.</p>
</blockquote>
<p>æ‰€ä»¥æˆ‘è§‰å¾— SEL å’Œ <code>char *</code> çš„çš„ç¡®ç¡®æ˜¯æœ‰æŸç§ä¸€ä¸€å¯¹åº”çš„æ˜ å°„å…³ç³»ï¼Œä¸è¿‡ SEL çš„æœ¬è´¨æ˜¯å¦æ˜¯ <code>char *</code> å°±è¦æ‰“ä¸€ä¸ªé—®å·äº†ã€‚å› ä¸ºæˆ‘åœ¨è°ƒè¯• SEL é˜¶æ®µå‘ç° SEL å†…è¿˜æœ‰ä¸€ä¸ªå½“å‰ SEL çš„æŒ‡é’ˆï¼Œä¸ <code>char *</code> ä¸åŒçš„æ˜¯å½“ <code>char *</code> èµ‹å€¼ä¹‹åå½“å‰ <code>char *</code> å˜é‡æŒ‡é’ˆæŒ‡å‘å­—ç¬¦ä¸²é¦–å­—ç¬¦ï¼Œè€Œ SEL åˆ™æ˜¯ <no value available>ï¼Œå³æˆ‘ä»¬æ— æ³•ç›´æ¥çœ‹åˆ°å®ƒã€‚</p>
<p>æ‰€ä»¥æˆ‘åšäº†ä¸€ä¸ªæ— èŠçš„æµ‹è¯•ï¼Œç”¨ç›¸åŒçš„å­—ç¬¦ä¸²åˆå§‹åŒ–ä¸€ä¸ª <code>char *</code> å®ä¾‹ä¸ä¸€ä¸ª SEL å®ä¾‹ï¼Œä¹‹åå°è¯•æ‰“å°å®ƒä»¬ï¼Œæœ‰è¶£çš„æ˜¯ä¸è®ºæˆ‘ä½¿ç”¨ <code>%s</code> è¿˜æ˜¯ <code>%c</code> éƒ½å¯ä»¥ä»ä¸¤ä¸ªå®ä¾‹ä¸­å¾—åˆ°ç›¸åŒçš„æ‰“å°è¾“å‡ºï¼Œä¸çŸ¥é“é±¼ç¥æ˜¯å¦åšè¿‡ç›¸åŒçš„æµ‹è¯•ï¼ˆç¬‘~ï¼‰</p>
<p>å˜›~ ç»è¿‡éªŒè¯æˆ‘ä»¬å¯ä»¥è‚¯å®š SEL å’Œ <code>char *</code> å­˜åœ¨æŸç§æ˜ å°„å…³ç³»ï¼Œå¯ä»¥ç›¸äº’è½¬æ¢ã€‚åŒæ—¶çŒœæµ‹ SEL æœ¬è´¨ä¸Šå°±æ˜¯ <code>char *</code>ï¼Œå¦‚æœæœ‰å“ªä½çŸ¥é“ SEL ä¸ <code>char *</code> ç¡®åˆ‡å…³ç³»çš„å¯ä»¥ç•™è¨€è®¨è®ºå“Ÿã€‚</p>
<h3 id="YYClassPropertyInfo-amp-amp-property-t"><a href="#YYClassPropertyInfo-amp-amp-property-t" class="headerlink" title="YYClassPropertyInfo &amp;&amp; property_t"></a>YYClassPropertyInfo &amp;&amp; property_t</h3><p>YYClassPropertyInfo æ˜¯ä½œè€…å¯¹ <code>property_t</code> çš„å°è£…ï¼Œ<code>property_t</code> åœ¨ Runtime ä¸­æ˜¯ç”¨æ¥è¡¨ç¤ºå±æ€§çš„ç»“æ„ä½“ã€‚</p>
<ul>
<li>YYClassPropertyInfo</li>
</ul>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYClassPropertyInfo</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) objc_property_t property; <span class="comment">///&lt; å±æ€§</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *name; <span class="comment">///&lt; å±æ€§åç§°</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) YYEncodingType type; <span class="comment">///&lt; å±æ€§ç±»å‹</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *typeEncoding; <span class="comment">///&lt; å±æ€§ç±»å‹ç¼–ç </span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *ivarName; <span class="comment">///&lt; å˜é‡åç§°</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) Class cls; <span class="comment">///&lt; ç±»å‹</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *protocols; <span class="comment">///&lt; å±æ€§ç›¸å…³åè®®</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) SEL <span class="keyword">getter</span>; <span class="comment">///&lt; getter æ–¹æ³•é€‰æ‹©å™¨</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) SEL <span class="keyword">setter</span>; <span class="comment">///&lt; setter æ–¹æ³•é€‰æ‹©å™¨</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithProperty:(objc_property_t)property;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>property_t</code></li>
</ul>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> property_t &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="type">char</span> *name; <span class="comment">// åç§°</span></span><br><span class="line">    <span class="keyword">const</span> <span class="type">char</span> *attributes; <span class="comment">// ä¿®é¥°</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¸ºä»€ä¹ˆè¯´ YYClassPropertyInfo æ˜¯ä½œè€…å¯¹ <code>property_t</code> çš„å°è£…å‘¢ï¼Ÿ</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// runtime.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_property *objc_property_t;</span><br><span class="line"></span><br><span class="line"><span class="comment">// objc-private.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __OBJC2__</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> property_t *objc_property_t;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> old_property *objc_property_t;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// objc-runtime-new.h</span></span><br><span class="line"><span class="keyword">struct</span> property_t &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="type">char</span> *name;</span><br><span class="line">    <span class="keyword">const</span> <span class="type">char</span> *attributes;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå”¯ä¸€å€¼å¾—æ³¨æ„çš„å°±æ˜¯ getter ä¸ setter æ–¹æ³•äº†ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…ˆå°è¯•è·å–å±æ€§çš„ getter ä¸ setter</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;G&#x27;</span>: &#123;</span><br><span class="line">        type |= YYEncodingTypePropertyCustomGetter;</span><br><span class="line">        <span class="keyword">if</span> (attrs[i].value) &#123;</span><br><span class="line">            _<span class="keyword">getter</span> = <span class="built_in">NSSelectorFromString</span>([<span class="built_in">NSString</span> stringWithUTF8String:attrs[i].value]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;S&#x27;</span>: &#123;</span><br><span class="line">        type |= YYEncodingTypePropertyCustomSetter;</span><br><span class="line">        <span class="keyword">if</span> (attrs[i].value) &#123;</span><br><span class="line">            _<span class="keyword">setter</span> = <span class="built_in">NSSelectorFromString</span>([<span class="built_in">NSString</span> stringWithUTF8String:attrs[i].value]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">break</span>;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// å¦‚æœæ²¡æœ‰åˆ™æŒ‰ç…§æ ‡å‡†è§„åˆ™è‡ªå·±é€ </span></span><br><span class="line"><span class="keyword">if</span> (!_<span class="keyword">getter</span>) &#123;</span><br><span class="line">    _<span class="keyword">getter</span> = <span class="built_in">NSSelectorFromString</span>(_name);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!_<span class="keyword">setter</span>) &#123;</span><br><span class="line">    _<span class="keyword">setter</span> = <span class="built_in">NSSelectorFromString</span>([<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;set%@%@:&quot;</span>, [_name substringToIndex:<span class="number">1</span>].uppercaseString, [_name substringFromIndex:<span class="number">1</span>]]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="YYClassInfo-amp-amp-objc-class"><a href="#YYClassInfo-amp-amp-objc-class" class="headerlink" title="YYClassInfo &amp;&amp; objc_class"></a>YYClassInfo &amp;&amp; objc_class</h3><p>æœ€åä½œè€…ç”¨ YYClassInfo å°è£…äº† <code>objc_class</code>ï¼Œ<code>objc_class</code> åœ¨ Runtime ä¸­è¡¨ç¤ºä¸€ä¸ª Objective-C ç±»ã€‚</p>
<ul>
<li>YYClassInfo</li>
</ul>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYClassInfo</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) Class cls; <span class="comment">///&lt; ç±»</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) Class superCls; <span class="comment">///&lt; è¶…ç±»</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) Class metaCls;  <span class="comment">///&lt; å…ƒç±»</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="type">BOOL</span> isMeta; <span class="comment">///&lt; å…ƒç±»æ ‡è¯†ï¼Œè‡ªèº«æ˜¯å¦ä¸ºå…ƒç±»</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *name; <span class="comment">///&lt; ç±»åç§°</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) YYClassInfo *superClassInfo; <span class="comment">///&lt; çˆ¶ç±»ï¼ˆè¶…ç±»ï¼‰ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, YYClassIvarInfo *&gt; *ivarInfos; <span class="comment">///&lt; å˜é‡ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, YYClassMethodInfo *&gt; *methodInfos; <span class="comment">///&lt; æ–¹æ³•ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, YYClassPropertyInfo *&gt; *propertyInfos; <span class="comment">///&lt; å±æ€§ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)setNeedUpdate;</span><br><span class="line">- (<span class="type">BOOL</span>)needUpdate;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)classInfoWithClass:(Class)cls;</span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)classInfoWithClassName:(<span class="built_in">NSString</span> *)className;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>objc_class</code></li>
</ul>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</span><br><span class="line"></span><br><span class="line"><span class="comment">// runtime.h</span></span><br><span class="line"><span class="keyword">struct</span> objc_class &#123;</span><br><span class="line">    Class _Nonnull isa OBJC_ISA_AVAILABILITY; <span class="comment">// isa æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !__OBJC2__</span></span><br><span class="line">    Class _Nullable super_class OBJC2_UNAVAILABLE; <span class="comment">// çˆ¶ç±»ï¼ˆè¶…ç±»ï¼‰æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">const</span> <span class="type">char</span> * _Nonnull name OBJC2_UNAVAILABLE; <span class="comment">// ç±»å</span></span><br><span class="line">    <span class="type">long</span> version OBJC2_UNAVAILABLE; <span class="comment">// ç‰ˆæœ¬</span></span><br><span class="line">    <span class="type">long</span> info OBJC2_UNAVAILABLE; <span class="comment">// ä¿¡æ¯</span></span><br><span class="line">    <span class="type">long</span> instance_size OBJC2_UNAVAILABLE; <span class="comment">// åˆå§‹å°ºå¯¸</span></span><br><span class="line">    <span class="keyword">struct</span> objc_ivar_list * _Nullable ivars OBJC2_UNAVAILABLE; <span class="comment">// å˜é‡åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">struct</span> objc_method_list * _Nullable * _Nullable methodLists OBJC2_UNAVAILABLE; <span class="comment">// æ–¹æ³•åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">struct</span> objc_cache * _Nonnull cache OBJC2_UNAVAILABLE; <span class="comment">// ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">struct</span> objc_protocol_list * _Nullable protocols OBJC2_UNAVAILABLE; <span class="comment">// åè®®åˆ—è¡¨</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br></pre></td></tr></table></figure>
<p>é¢â€¦ çœ‹æ¥æƒ³å®Œå…¨é¿å¼€ Runtime çš„çŸ¥è¯†æ¥è®² YYModel æºç æ˜¯ä¸ç°å®çš„ã€‚è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹ Runtime ä¸­å…³äº Class çš„çŸ¥è¯†ä»¥ä¾¿é˜…è¯»ï¼Œå·²ç»ç†Ÿæ‚‰è¿™æ–¹é¢çŸ¥è¯†çš„åŒå­¦å°±å½“æ¸©ä¹ ä¸€ä¸‹å¥½äº†ã€‚</p>
<img src="/yymodel0x01/class_diagram.jpg" class="">
<ul>
<li>isa æŒ‡é’ˆï¼Œç”¨äºæ‰¾åˆ°æ‰€å±ç±»ï¼Œç±»å¯¹è±¡çš„ isa ä¸€èˆ¬æŒ‡å‘å¯¹åº”å…ƒç±»ã€‚</li>
<li>å…ƒç±»ï¼Œç”±äº objc_class ç»§æ‰¿äº objc_objectï¼Œå³ç±»æœ¬èº«åŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥ Runtime åº“è®¾è®¡å‡ºå…ƒç±»ç”¨ä»¥è¡¨è¿°ç±»å¯¹è±¡è‡ªèº«æ‰€å…·å¤‡çš„å…ƒæ•°æ®ã€‚</li>
<li>cacheï¼Œå®é™…ä¸Šå½“ä¸€ä¸ªå¯¹è±¡æ”¶åˆ°æ¶ˆæ¯æ—¶å¹¶ä¸ä¼šç›´æ¥åœ¨ isa æŒ‡å‘çš„ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­éå†æŸ¥æ‰¾èƒ½å¤Ÿå“åº”æ¶ˆæ¯çš„æ–¹æ³•ï¼Œå› ä¸ºè¿™æ ·æ•ˆç‡å¤ªä½äº†ã€‚ä¸ºäº†ä¼˜åŒ–æ–¹æ³•è°ƒç”¨çš„æ•ˆç‡ï¼ŒåŠ å…¥äº† cacheï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œä¼šå…ˆå» cache ä¸­æŸ¥æ‰¾ï¼Œæ‰¾ä¸åˆ°æ‰ä¼šå»åƒä¸Šå›¾æ‰€ç¤ºéå†æŸ¥æ‰¾ï¼Œç›¸ä¿¡è‹¹æœä¸ºäº†æå‡ç¼“å­˜å‘½ä¸­ç‡ï¼Œåº”è¯¥ä¹ŸèŠ±äº†ä¸€äº›å¿ƒæ€ï¼ˆç¬‘~ï¼‰ã€‚</li>
<li>versionï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªå­—æ®µæ¥æä¾›ç±»çš„ç‰ˆæœ¬ä¿¡æ¯ã€‚è¿™å¯¹äºå¯¹è±¡çš„åºåˆ—åŒ–éå¸¸æœ‰ç”¨ï¼Œå®ƒå¯æ˜¯è®©æˆ‘ä»¬è¯†åˆ«å‡ºä¸åŒç±»å®šä¹‰ç‰ˆæœ¬ä¸­å®ä¾‹å˜é‡å¸ƒå±€çš„æ”¹å˜ã€‚</li>
</ul>
<blockquote>
<p>å…³äº Version çš„å®˜æ–¹æè¿°ï¼š<br>Classes derived from the Foundation framework NSObject class can set the class-definition version number using the setVersion: class method, which is implemented using the class_setVersion function.</p>
</blockquote>
<h4 id="YYClassInfo-çš„åˆå§‹åŒ–ç»†èŠ‚"><a href="#YYClassInfo-çš„åˆå§‹åŒ–ç»†èŠ‚" class="headerlink" title="YYClassInfo çš„åˆå§‹åŒ–ç»†èŠ‚"></a>YYClassInfo çš„åˆå§‹åŒ–ç»†èŠ‚</h4><p>å…³äº YYClassInfo çš„åˆå§‹åŒ–ç»†èŠ‚æˆ‘è§‰å¾—è¿˜æ˜¯æœ‰å¿…è¦åˆ†äº«å‡ºæ¥çš„ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)classInfoWithClass:(Class)cls &#123;</span><br><span class="line">    <span class="comment">// åˆ¤ç©ºå…¥å‚</span></span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å•ä¾‹ç¼“å­˜ classCache ä¸ metaCacheï¼Œå¯¹åº”ç¼“å­˜ç±»å’Œå…ƒç±»</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">CFMutableDictionaryRef</span> classCache;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">CFMutableDictionaryRef</span> metaCache;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="keyword">static</span> dispatch_semaphore_t lock;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        classCache = <span class="built_in">CFDictionaryCreateMutable</span>(<span class="built_in">CFAllocatorGetDefault</span>(), <span class="number">0</span>, &amp;kCFTypeDictionaryKeyCallBacks, &amp;kCFTypeDictionaryValueCallBacks);</span><br><span class="line">        metaCache = <span class="built_in">CFDictionaryCreateMutable</span>(<span class="built_in">CFAllocatorGetDefault</span>(), <span class="number">0</span>, &amp;kCFTypeDictionaryKeyCallBacks, &amp;kCFTypeDictionaryValueCallBacks);</span><br><span class="line">        <span class="comment">// è¿™é‡ŒæŠŠ dispatch_semaphore å½“åšé”æ¥ä½¿ç”¨ï¼ˆå½“ä¿¡å·é‡åªæœ‰ 1 æ—¶ï¼‰</span></span><br><span class="line">        lock = dispatch_semaphore_create(<span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–ä¹‹å‰ï¼Œé¦–å…ˆä¼šæ ¹æ®å½“å‰ YYClassInfo æ˜¯å¦ä¸ºå…ƒç±»å»å¯¹åº”çš„å•ä¾‹ç¼“å­˜ä¸­æŸ¥æ‰¾</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œä½¿ç”¨äº†ä¸Šé¢çš„ dispatch_semaphore åŠ é”ï¼Œä¿è¯å•ä¾‹ç¼“å­˜çš„çº¿ç¨‹å®‰å…¨ </span></span><br><span class="line">    dispatch_semaphore_wait(lock, DISPATCH_TIME_FOREVER);</span><br><span class="line">    YYClassInfo *info = <span class="built_in">CFDictionaryGetValue</span>(class_isMetaClass(cls) ? metaCache : classCache, (__bridge <span class="keyword">const</span> <span class="type">void</span> *)(cls));</span><br><span class="line">    <span class="comment">// å¦‚æœæ‰¾åˆ°äº†ï¼Œä¸”æ‰¾åˆ°çš„ä¿¡æ¯éœ€è¦æ›´æ–°çš„è¯åˆ™æ‰§è¡Œæ›´æ–°æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> (info &amp;&amp; info-&gt;_needUpdate) &#123;</span><br><span class="line">        [info _update];</span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_semaphore_signal(lock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æ‰¾åˆ°ï¼Œæ‰ä¼šå»è€å®åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (!info) &#123;</span><br><span class="line">        info = [[YYClassInfo alloc] initWithClass:cls];</span><br><span class="line">        <span class="keyword">if</span> (info) &#123; <span class="comment">// åˆå§‹åŒ–æˆåŠŸ</span></span><br><span class="line">            <span class="comment">// çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">            dispatch_semaphore_wait(lock, DISPATCH_TIME_FOREVER);</span><br><span class="line">            <span class="comment">// æ ¹æ®åˆå§‹åŒ–ä¿¡æ¯é€‰æ‹©å‘å¯¹åº”çš„ç±»/å…ƒç±»ç¼“å­˜æ³¨å…¥ä¿¡æ¯ï¼Œkey = clsï¼Œvalue = info</span></span><br><span class="line">            <span class="built_in">CFDictionarySetValue</span>(info.isMeta ? metaCache : classCache, (__bridge <span class="keyword">const</span> <span class="type">void</span> *)(cls), (__bridge <span class="keyword">const</span> <span class="type">void</span> *)(info));</span><br><span class="line">            dispatch_semaphore_signal(lock);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ€»ç»“ä¸€ä¸‹åˆå§‹åŒ–çš„ä¸»è¦æ­¥éª¤ï¼š</p>
<ul>
<li>åˆ›å»ºå•ä¾‹ç¼“å­˜ï¼Œç±»ç¼“å­˜å’Œå…ƒç±»ç¼“å­˜</li>
<li>ä½¿ç”¨ <code>dispatch_semaphore</code> ä½œä¸ºé”ä¿è¯ç¼“å­˜çº¿ç¨‹å®‰å…¨</li>
<li>åˆå§‹åŒ–å‰å…ˆå»ç¼“å­˜ä¸­æŸ¥æ‰¾æ˜¯å¦å·²ç»å‘ç¼“å­˜ä¸­æ³¨å†Œè¿‡å½“å‰è¦åˆå§‹åŒ–çš„ YYClassInfo</li>
<li>å¦‚æœæŸ¥æ‰¾åˆ°ç¼“å­˜å¯¹è±¡ï¼Œåˆ™åˆ¤æ–­ç¼“å­˜å¯¹è±¡æ˜¯å¦éœ€è¦æ›´æ–°å¹¶æ‰§è¡Œç›¸å…³æ“ä½œ</li>
<li>å¦‚æœç¼“å­˜ä¸­æœªæ‰¾åˆ°ç¼“å­˜å¯¹è±¡åˆ™åˆå§‹åŒ–</li>
<li>åˆå§‹åŒ–æˆåŠŸåå‘ç¼“å­˜ä¸­æ³¨å†Œè¯¥ YYClassInfo å®ä¾‹</li>
</ul>
<p>å…¶ä¸­ï¼Œä½¿ç”¨ç¼“å­˜å¯ä»¥æœ‰æ•ˆå‡å°‘æˆ‘ä»¬åœ¨ JSON æ¨¡å‹è½¬æ¢æ—¶åå¤åˆå§‹åŒ– YYClassInfo å¸¦æ¥çš„å¼€é”€ï¼Œè€Œ <code>dispatch_semaphore</code> åœ¨ä¿¡å·é‡ä¸º 1 æ—¶æ˜¯å¯ä»¥å½“åšé”æ¥ä½¿ç”¨çš„ï¼Œè™½ç„¶å®ƒåœ¨é˜»å¡æ—¶æ•ˆç‡è¶…ä½ï¼Œä½†æ˜¯å¯¹äºä»£ç ä¸­çš„ç¼“å­˜é˜»å¡è¿™é‡Œå±äºä½é¢‘äº‹ä»¶ï¼Œä½¿ç”¨ <code>dispatch_semaphore</code> åœ¨éé˜»å¡çŠ¶æ€ä¸‹æ€§èƒ½å¾ˆé«˜ï¼Œè¿™é‡Œé”çš„é€‰æ‹©éå¸¸åˆé€‚ã€‚</p>
<h4 id="å…³äº-YYClassInfo-çš„æ›´æ–°"><a href="#å…³äº-YYClassInfo-çš„æ›´æ–°" class="headerlink" title="å…³äº YYClassInfo çš„æ›´æ–°"></a>å…³äº YYClassInfo çš„æ›´æ–°</h4><p>é¦–å…ˆ YYClassInfo æ˜¯ä½œè€…å¯¹åº” <code>objc_class</code> å°è£…å‡ºæ¥çš„ç±»ï¼Œæ‰€ä»¥ç†åº”åœ¨å…¶å¯¹åº”çš„ <code>objc_class</code> å®ä¾‹å‘ç”Ÿå˜åŒ–æ—¶æ›´æ–°ã€‚é‚£ä¹ˆ <code>objc_class</code> ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿå˜åŒ–å‘¢ï¼Ÿ</p>
<p>å˜›~ æ¯”å¦‚ä½ ä½¿ç”¨äº† <code>class_addMethod</code> æ–¹æ³•ä¸ºä½ çš„æ¨¡å‹ç±»åŠ å…¥äº†ä¸€ä¸ªæ–¹æ³•ç­‰ç­‰ã€‚</p>
<p>YYClassInfo æœ‰ä¸€ä¸ªç§æœ‰ BOOL ç±»å‹å‚æ•° <code>_needUpdate</code> ç”¨ä»¥è¡¨ç¤ºå½“å‰çš„ YYClassInfo å®ä¾‹æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œå¹¶ä¸”æä¾›äº† <code>- (void)setNeedUpdate;</code> æ¥å£æ–¹ä¾¿æˆ‘ä»¬åœ¨æ›´æ”¹äº†è‡ªå·±çš„æ¨¡å‹ç±»æ—¶è°ƒç”¨å…¶å°† <code>_needUpdate</code> è®¾ç½®ä¸º YESï¼Œå½“ <code>_needUpdate</code> ä¸º YES æ—¶åé¢å°±ä¸ç”¨æˆ‘è¯´äº†ï¼Œç›¸å…³çš„ä»£ç åœ¨ä¸Šä¸€èŠ‚åˆå§‹åŒ–ä¸­æœ‰å“¦ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (info &amp;&amp; info-&gt;_needUpdate) &#123;</span><br><span class="line">    [info _update];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç®€å•ä»‹ç»ä¸€ä¸‹ <code>_update</code>ï¼Œå®ƒæ˜¯ YYClassInfo çš„ç§æœ‰æ–¹æ³•ï¼Œå®ƒçš„å®ç°é€»è¾‘ç®€å•ä»‹ç»å°±æ˜¯æ¸…ç©ºå½“å‰ YYClassInfo å®ä¾‹å˜é‡ï¼Œæ–¹æ³•ä»¥åŠå±æ€§ï¼Œä¹‹åå†é‡æ–°åˆå§‹åŒ–å®ƒä»¬ã€‚ç”±äº <code>_update</code> å®ç°æºç å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„ï¼Œæˆ‘è¿™é‡Œå°±ä¸è´´æºç äº†ã€‚</p>
<p>å˜›~ å¯¹ YYClassInfo çš„å‰–æåˆ°è¿™é‡Œå°±å·®ä¸å¤šäº†ã€‚</p>
<h2 id="NSObject-YYModel-æ¢ç©¶"><a href="#NSObject-YYModel-æ¢ç©¶" class="headerlink" title="NSObject+YYModel æ¢ç©¶"></a>NSObject+YYModel æ¢ç©¶</h2><img src="/yymodel0x01/nsobject_yymodel.jpg" class="">
<p>å¦‚æœè¯´ YYClassInfo ä¸»è¦æ˜¯ä½œè€…å¯¹ Runtime å±‚åœ¨ JSON æ¨¡å‹è½¬æ¢ä¸­éœ€è¦ç”¨åˆ°çš„ç»“æ„ä½“çš„å°è£…ï¼Œé‚£ä¹ˆ NSObject+YYModel åœ¨ YYModel ä¸­æ‹…å½“çš„è´£ä»»åˆ™æ˜¯åˆ©ç”¨ YYClassInfo å±‚çº§å°è£…å¥½çš„ç±»åˆ‡å®çš„æ‰§è¡Œ JSON æ¨¡å‹ä¹‹é—´çš„è½¬æ¢é€»è¾‘ï¼Œå¹¶ä¸”æä¾›äº†æ— ä¾µå…¥æ€§çš„æ¥å£ã€‚</p>
<p>ç¬¬ä¸€æ¬¡é˜…è¯» NSObject+YYModel.m çš„æºç å¯èƒ½ä¼šæœ‰äº›ä¸é€‚åº”ï¼Œè¿™å¾ˆæ­£å¸¸ã€‚å› ä¸ºå…¶å¤§é‡ä½¿ç”¨äº† Runtime å‡½æ•°ä¸ CoreFoundation åº“ï¼ŒåŠ ä¸Šå„ç§ç±»å‹ç¼–ç å’Œé€’å½’è§£æï¼Œä»£ç é‡ä¹Ÿæœ‰ 1800 å¤šè¡Œäº†ã€‚</p>
<p>æˆ‘ç®€å•æŠŠ NSObject+YYModel.m çš„æºç åšäº†ä¸€ä¸‹åˆ’åˆ†ï¼Œè¿™æ ·åˆ’åˆ†ä¹‹åä»£ç çœ‹èµ·æ¥ä¸€æ ·å¾ˆç®€å•æ¸…æ™°ï¼š</p>
<ul>
<li>ç±»å‹ç¼–ç è§£æ</li>
<li>æ•°æ®ç»“æ„å®šä¹‰</li>
<li>é€’å½’æ¨¡å‹è½¬æ¢</li>
<li>æ¥å£ç›¸å…³ä»£ç </li>
</ul>
<h3 id="ç±»å‹ç¼–ç è§£æ"><a href="#ç±»å‹ç¼–ç è§£æ" class="headerlink" title="ç±»å‹ç¼–ç è§£æ"></a>ç±»å‹ç¼–ç è§£æ</h3><p>ç±»å‹ç¼–ç è§£æä»£ç ä¸»è¦é›†ä¸­åœ¨ NSObject+YYModel.m çš„ä¸Šé¢éƒ¨åˆ†ï¼Œæ¶‰åŠåˆ° YYEncodingNSType æšä¸¾çš„å®šä¹‰ï¼Œé…å¥— <code>YYClassGetNSType</code> å‡½æ•°å°† NS ç±»å‹è½¬ä¸º YYEncodingNSType è¿˜æœ‰ <code>YYEncodingTypeIsCNumber</code> å‡½æ•°åˆ¤æ–­ç±»å‹æ˜¯å¦å¯ä»¥ç›´æ¥è½¬ä¸º C è¯­è¨€æ•°å€¼ç±»å‹çš„å‡½æ•°ã€‚</p>
<p>æ­¤å¤–è¿˜æœ‰å°† id æŒ‡é’ˆè½¬ä¸ºå¯¹åº” NSNumber çš„å‡½æ•° <code>YYNSNumberCreateFromID</code>ï¼Œå°† NSString è½¬ä¸º NSDate çš„ <code>YYNSDateFromString</code> å‡½æ•°ï¼Œè¿™ç±»å‡½æ•°ä¸»è¦æ˜¯æ–¹ä¾¿åœ¨æ¨¡å‹è½¬æ¢æ—¶ä½¿ç”¨ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> force_inline <span class="built_in">NSDate</span> *YYNSDateFromString(__<span class="keyword">unsafe_unretained</span> <span class="built_in">NSString</span> *string) &#123;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="built_in">NSDate</span>* (^YYNSDateParseBlock)(<span class="built_in">NSString</span> *string);</span><br><span class="line">    <span class="comment">// YYNSDateFromString æ”¯æŒè§£æçš„æœ€é•¿æ—¶é—´å­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> kParserNum 34</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªå•ä¾‹æ—¶é—´è§£æä»£ç å—æ•°ç»„</span></span><br><span class="line">    <span class="comment">// ä¸ºäº†é¿å…é‡å¤åˆ›å»ºè¿™äº› NSDateFormatterï¼Œå®ƒçš„åˆå§‹åŒ–å¼€é”€ä¸å°</span></span><br><span class="line">    <span class="keyword">static</span> YYNSDateParseBlock blocks[kParserNum + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œæ‹¿ `yyyy-MM-dd` ä¸¾ä¾‹åˆ†æ</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             2014-01-20  // Google</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="built_in">NSDateFormatter</span> *formatter = [[<span class="built_in">NSDateFormatter</span> alloc] init];</span><br><span class="line">            formatter.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@&quot;en_US_POSIX&quot;</span>];</span><br><span class="line">            formatter.timeZone = [<span class="built_in">NSTimeZone</span> timeZoneForSecondsFromGMT:<span class="number">0</span>];</span><br><span class="line">            formatter.dateFormat = <span class="string">@&quot;yyyy-MM-dd&quot;</span>;</span><br><span class="line">            <span class="comment">// è¿™é‡Œä½¿ç”¨ blocks[10] æ˜¯å› ä¸º `yyyy-MM-dd` çš„é•¿åº¦å°±æ˜¯ 10</span></span><br><span class="line">            blocks[<span class="number">10</span>] = ^(<span class="built_in">NSString</span> *string) &#123; <span class="keyword">return</span> [formatter dateFromString:string]; &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å…¶ä»–çš„æ ¼å¼éƒ½æ˜¯ä¸€æ ·ç±»å‹çš„ä»£ç ï¼Œçœç•¥</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!string) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (string.length &gt; kParserNum) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// æ ¹æ®å…¥å‚çš„é•¿åº¦å»åˆšæ‰å­˜æ»¡å„ç§æ ¼å¼æ—¶é—´è§£æä»£ç å—çš„å•ä¾‹æ•°ç»„å–å‡ºå¯¹åº”çš„ä»£ç å—æ‰§è¡Œ</span></span><br><span class="line">    YYNSDateParseBlock parser = blocks[string.length];</span><br><span class="line">    <span class="keyword">if</span> (!parser) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">return</span> parser(string);</span><br><span class="line">    <span class="meta">#<span class="keyword">undef</span> kParserNum</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: åœ¨ iOS 7 ä¹‹å‰ NSDateFormatter æ˜¯<strong>éçº¿ç¨‹å®‰å…¨</strong>çš„ã€‚</p>
</blockquote>
<p>é™¤æ­¤ä¹‹å¤–è¿˜ç”¨ YYNSBlockClass æŒ‡å‘äº† NSBlock ç±»ï¼Œå®ç°è¿‡ç¨‹ä¹Ÿæ¯”è¾ƒå·§å¦™ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> force_inline Class YYNSBlockClass() &#123;</span><br><span class="line">    <span class="keyword">static</span> Class cls;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        <span class="type">void</span> (^block)(<span class="type">void</span>) = ^&#123;&#125;;</span><br><span class="line">        cls = ((<span class="built_in">NSObject</span> *)block).class;</span><br><span class="line">        <span class="comment">// è½®è¯¢çˆ¶ç±»ç›´åˆ°çˆ¶ç±»æŒ‡å‘ NSObject åœæ­¢</span></span><br><span class="line">        <span class="keyword">while</span> (class_getSuperclass(cls) != [<span class="built_in">NSObject</span> <span class="keyword">class</span>]) &#123;</span><br><span class="line">            cls = class_getSuperclass(cls);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> cls; <span class="comment">// æ‹¿åˆ°çš„å°±æ˜¯ &quot;NSBlock&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…³äº <code>force_inline</code> è¿™ç§ä»£ç æŠ€å·§ï¼Œæˆ‘è¯´è¿‡æˆ‘åœ¨å†™å®Œ YYModel æˆ–è€…æ”’åˆ°è¶³å¤Ÿå¤šçš„æ—¶å€™ä¼šä¸»åŠ¨æ‹¿å‡ºæ¥ä¸å¤§å®¶åˆ†äº«è¿™äº›ä»£ç æŠ€å·§ï¼Œä¸è¿‡è¿™é‡Œå¤§å®¶é€šè¿‡å­—é¢ä¹Ÿä¸éš¾ç†è§£ï¼Œå°±æ˜¯å¼ºåˆ¶å†…è”ã€‚</p>
<p>å˜›~ å…³äºå†…è”å‡½æ•°åº”è¯¥ä¸éœ€è¦æˆ‘å¤šè¯´ï¼ˆç¬‘ï¼‰ã€‚</p>
<h3 id="æ•°æ®ç»“æ„å®šä¹‰"><a href="#æ•°æ®ç»“æ„å®šä¹‰" class="headerlink" title="æ•°æ®ç»“æ„å®šä¹‰"></a>æ•°æ®ç»“æ„å®šä¹‰</h3><p>NSObject+YYModel ä¸­é‡æ–°å®šä¹‰äº†ä¸¤ä¸ªç±»ï¼Œé€šè¿‡å®ƒä»¬æ¥ä½¿ç”¨ YYClassInfo ä¸­çš„å°è£…ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">NSObject+YYModel</th>
<th style="text-align:center">YYClassInfo</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>_YYModelPropertyMeta</code></td>
<td style="text-align:center">YYClassPropertyInfo</td>
</tr>
<tr>
<td style="text-align:center"><code>_YYModelMeta</code></td>
<td style="text-align:center">YYClassInfo</td>
</tr>
</tbody>
</table>
<h4 id="YYModelPropertyMeta"><a href="#YYModelPropertyMeta" class="headerlink" title="_YYModelPropertyMeta"></a>_YYModelPropertyMeta</h4><p><code>_YYModelPropertyMeta</code> è¡¨ç¤ºæ¨¡å‹å¯¹è±¡ä¸­çš„å±æ€§ä¿¡æ¯ï¼Œå®ƒåŒ…å« YYClassPropertyInfoã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">_YYModelPropertyMeta</span> : <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">@package</span></span><br><span class="line">    <span class="built_in">NSString</span> *_name;             <span class="comment">///&lt; å±æ€§åç§°</span></span><br><span class="line">    YYEncodingType _type;        <span class="comment">///&lt; å±æ€§ç±»å‹</span></span><br><span class="line">    YYEncodingNSType _nsType;    <span class="comment">///&lt; å±æ€§åœ¨ Foundation æ¡†æ¶ä¸­çš„ç±»å‹</span></span><br><span class="line">    <span class="type">BOOL</span> _isCNumber;             <span class="comment">///&lt; æ˜¯å¦ä¸º CNumber</span></span><br><span class="line">    Class _cls;                  <span class="comment">///&lt; å±æ€§ç±»</span></span><br><span class="line">    Class _genericCls;           <span class="comment">///&lt; å±æ€§åŒ…å«çš„æ³›å‹ç±»å‹ï¼Œæ²¡æœ‰åˆ™ä¸º nil</span></span><br><span class="line">    SEL _<span class="keyword">getter</span>;                 <span class="comment">///&lt; getter</span></span><br><span class="line">    SEL _<span class="keyword">setter</span>;                 <span class="comment">///&lt; setter</span></span><br><span class="line">    <span class="type">BOOL</span> _isKVCCompatible;       <span class="comment">///&lt; å¦‚æœå¯ä»¥ä½¿ç”¨ KVC åˆ™è¿”å› YES</span></span><br><span class="line">    <span class="type">BOOL</span> _isStructAvailableForKeyedArchiver; <span class="comment">///&lt; å¦‚æœå¯ä»¥ä½¿ç”¨ archiver/unarchiver å½’/è§£æ¡£åˆ™è¿”å› YES</span></span><br><span class="line">    <span class="type">BOOL</span> _hasCustomClassFromDictionary; <span class="comment">///&lt; ç±»/æ³›å‹è‡ªå®šä¹‰ç±»å‹ï¼Œä¾‹å¦‚éœ€è¦åœ¨æ•°ç»„ä¸­å®ç°ä¸åŒç±»å‹çš„è½¬æ¢éœ€è¦ç”¨åˆ°</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     property-&gt;key:       _mappedToKey:key     _mappedToKeyPath:nil            _mappedToKeyArray:nil</span></span><br><span class="line"><span class="comment">     property-&gt;keyPath:   _mappedToKey:keyPath _mappedToKeyPath:keyPath(array) _mappedToKeyArray:nil</span></span><br><span class="line"><span class="comment">     property-&gt;keys:      _mappedToKey:keys[0] _mappedToKeyPath:nil/keyPath    _mappedToKeyArray:keys(array)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">NSString</span> *_mappedToKey;      <span class="comment">///&lt; æ˜ å°„ key</span></span><br><span class="line">    <span class="built_in">NSArray</span> *_mappedToKeyPath;   <span class="comment">///&lt; æ˜ å°„ keyPathï¼Œå¦‚æœæ²¡æœ‰æ˜ å°„åˆ° keyPath åˆ™è¿”å› nil</span></span><br><span class="line">    <span class="built_in">NSArray</span> *_mappedToKeyArray;  <span class="comment">///&lt; key æˆ–è€… keyPath çš„æ•°ç»„ï¼Œå¦‚æœæ²¡æœ‰æ˜ å°„å¤šä¸ªé”®çš„è¯åˆ™è¿”å› nil</span></span><br><span class="line">    YYClassPropertyInfo *_info;  <span class="comment">///&lt; å±æ€§ä¿¡æ¯ï¼Œè¯¦è§ä¸Šæ–‡ YYClassPropertyInfo &amp;&amp; property_t ç« èŠ‚</span></span><br><span class="line">    _YYModelPropertyMeta *_next; <span class="comment">///&lt; å¦‚æœæœ‰å¤šä¸ªå±æ€§æ˜ å°„åˆ°åŒä¸€ä¸ª key åˆ™æŒ‡å‘ä¸‹ä¸€ä¸ªæ¨¡å‹å±æ€§å…ƒ</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h4 id="YYModelMeta"><a href="#YYModelMeta" class="headerlink" title="_YYModelMeta"></a>_YYModelMeta</h4><p><code>_YYModelMeta</code> è¡¨ç¤ºæ¨¡å‹çš„ç±»ä¿¡æ¯ï¼Œå®ƒåŒ…å« YYClassInfoã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">_YYModelMeta</span> : <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">@package</span></span><br><span class="line">    YYClassInfo *_classInfo;</span><br><span class="line">    <span class="comment">/// Key:è¢«æ˜ å°„çš„ key ä¸ keyPath, Value:_YYModelPropertyMeta.</span></span><br><span class="line">    <span class="built_in">NSDictionary</span> *_mapper;</span><br><span class="line">    <span class="comment">/// Array&lt;_YYModelPropertyMeta&gt;, å½“å‰æ¨¡å‹çš„æ‰€æœ‰ _YYModelPropertyMeta æ•°ç»„</span></span><br><span class="line">    <span class="built_in">NSArray</span> *_allPropertyMetas;</span><br><span class="line">    <span class="comment">/// Array&lt;_YYModelPropertyMeta&gt;, è¢«æ˜ å°„åˆ° keyPath çš„ _YYModelPropertyMeta æ•°ç»„</span></span><br><span class="line">    <span class="built_in">NSArray</span> *_keyPathPropertyMetas;</span><br><span class="line">    <span class="comment">/// Array&lt;_YYModelPropertyMeta&gt;, è¢«æ˜ å°„åˆ°å¤šä¸ª key çš„ _YYModelPropertyMeta æ•°ç»„</span></span><br><span class="line">    <span class="built_in">NSArray</span> *_multiKeysPropertyMetas;</span><br><span class="line">    <span class="comment">/// æ˜ å°„ key ä¸ keyPath çš„æ•°é‡ï¼Œç­‰åŒäº _mapper.count</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> _keyMappedCount;</span><br><span class="line">    <span class="comment">/// æ¨¡å‹ class ç±»å‹</span></span><br><span class="line">    YYEncodingNSType _nsType;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¿½ç•¥</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="é€’å½’æ¨¡å‹è½¬æ¢"><a href="#é€’å½’æ¨¡å‹è½¬æ¢" class="headerlink" title="é€’å½’æ¨¡å‹è½¬æ¢"></a>é€’å½’æ¨¡å‹è½¬æ¢</h3><p>NSObject+YYModel.m å†…å†™äº†ä¸€äº›ï¼ˆé—´æ¥ï¼‰é€’å½’æ¨¡å‹è½¬æ¢ç›¸å…³çš„å‡½æ•°ï¼Œå¦‚ <code>ModelToJSONObjectRecursive</code> ä¹‹ç±»çš„ï¼Œç”±äºæ¶‰åŠç¹æ‚çš„æ¨¡å‹ç¼–ç è§£æä»¥åŠä»£ç é‡æ¯”è¾ƒå¤§ç­‰åŸå› æˆ‘ä¸å‡†å¤‡æ”¾åœ¨è¿™é‡Œè¯¦ç»†è®²è§£ã€‚</p>
<p>æˆ‘è®¤ä¸ºè¿™ç§é€»è¾‘å¹¶ä¸å¤æ‚ä½†æ˜¯ç‰µæ‰¯è¾ƒå¤šçš„å‡½æ•°ä»£ç ä¸ç»“æ„/ç±»å‹å®šä¹‰ä»£ç ä¸åŒï¼Œåè€…æ›´é€‚åˆåˆ—å‡ºæºç è®©è¯»è€…å¯¹æ•°æ®æœ‰å…¨é¢æ¸…é†’çš„è®¤è¯†ï¼Œè€Œå‰è€…ç»“åˆåŠŸèƒ½å®ä¾‹è®²æ›´å®¹æ˜“ä½¿è¯»è€…å¯¹æ•´æ¡åŠŸèƒ½çš„æµç¨‹æœ‰ä¸€ä¸ªæ›´é€å½»çš„ç†è§£ã€‚</p>
<p>æ‰€ä»¥æˆ‘å‡†å¤‡æ”¾åˆ°åé¢ JSON ä¸ Model ç›¸äº’è½¬æ¢æ—¶ä¸€èµ·è®²ã€‚</p>
<h3 id="æ¥å£ç›¸å…³ä»£ç "><a href="#æ¥å£ç›¸å…³ä»£ç " class="headerlink" title="æ¥å£ç›¸å…³ä»£ç "></a>æ¥å£ç›¸å…³ä»£ç </h3><p>å˜›~ ç†ç”±åŒä¸Šã€‚</p>
<h2 id="åŠç« æ€»ç»“"><a href="#åŠç« æ€»ç»“" class="headerlink" title="åŠç« æ€»ç»“"></a>åŠç« æ€»ç»“</h2><ul>
<li>æ–‡ç« å¯¹ YYModel æºç è¿›è¡Œäº†ç³»ç»Ÿè§£è¯»ï¼Œæœ‰æ¡ç†çš„ä»‹ç»äº† YYModel çš„ç»“æ„ï¼Œç›¸ä¿¡ä¼šè®©å„ä½å¯¹ YYModel çš„ä»£ç ç»“æ„æœ‰ä¸€ä¸ªæ¸…æ™°çš„è®¤è¯†ã€‚</li>
<li>æ·±å…¥å‰–æäº† YYClassInfo çš„ 4 ä¸ªç±»ï¼Œå¹¶è¯¦ç»†è®²è§£äº†å®ƒä»¬ä¸ Runtime å±‚çº§ç»“æ„ä½“çš„å¯¹åº”ã€‚</li>
<li>åœ¨å‰–æ YYClassInfo ç« èŠ‚ä¸­åˆ†äº«äº†ä¸€äº›æˆ‘åœ¨é˜…è¯»æºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¹¶ä¸”è§‰å¾—å€¼å¾—åˆ†äº«çš„å¤„ç†ç»†èŠ‚ï¼Œæ¯”å¦‚ä¸ºä»€ä¹ˆä½œè€…é€‰æ‹©ç”¨ <code>strong</code> æ¥ä¿®é¥° NSString ç­‰ã€‚é¡ºä¾¿è¿˜å¯¹ SEL ä¸ <code>char *</code> çš„å…³ç³»åšäº†å®éªŒå¾—å‡ºäº†æˆ‘çš„æ¨è®ºã€‚</li>
<li>æŠŠ YYClassInfo çš„åˆå§‹åŒ–ä»¥åŠæ›´æ–°ç»†èŠ‚å•ç‹¬æ‹å‡ºæ¥åšäº†åˆ†æã€‚</li>
<li>æ¢ç©¶ NSObject+YYModel æºç ï¼ˆåˆ†äº«äº†ä¸€äº›å®ç°ç»†èŠ‚ï¼‰å¹¶å¯¹å…¶å®ç°ä»£ç åšäº†åˆ’åˆ†ï¼Œå¸Œæœ›èƒ½å¤Ÿå¯¹è¯»è€…é˜…è¯» YYModel æºç æ—¶æä¾›ä¸€äº›å°å°çš„å¸®åŠ©ã€‚</li>
</ul>
<p>å˜›~ ä¸Šç¯‡å·®ä¸å¤šå°±è¿™æ ·äº†ã€‚æˆ‘å†™çš„ä¸Šä¸€ç¯‡ YYKit æºç ç³»åˆ—æ–‡ç« <a href="https://lision.me/yycache/">ã€ä» YYCache æºç  Get åˆ°å¦‚ä½•è®¾è®¡ä¸€ä¸ªä¼˜ç§€çš„ç¼“å­˜ã€‘</a>æ”¶åˆ°äº†ä¸å°‘çš„å¥½è¯„å’Œæ”¯æŒï¼ˆæ˜é‡‘é‡Œä¸€ä½è¯»è€… <a target="_blank" rel="noopener" href="https://juejin.im/user/5912c8b2da2f600053723275">@ios123456</a> çš„è¯„è®ºæ›´æ˜¯æš–åŒ–äº†æˆ‘ï¼‰ï¼Œè¿™äº›ç¾å¥½çš„ä¸œè¥¿è®©æˆ‘æ›´åŠ åšå®šäº†ç»§ç»­ç”¨å¿ƒåˆ›ä½œæ–‡ç« çš„å†³å¿ƒã€‚</p>
<p>æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜ <a href="https://lision.me/">https://lision.me/</a>ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ <a href="https://lision.me/">ä¸ªäººåšå®¢</a> ä¸­æ›´æ–°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš <a target="_blank" rel="noopener" href="https://weibo.com/lisioncode">@Lision</a> è”ç³»æˆ‘~</p>
<p>å¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~</p>


    
    
    
	  <div class="tags">
      <a class="tag-none-link" href="/tags/yykit/" rel="tag">yykit</a><a class="tag-none-link" href="/tags/yymodel/" rel="tag">yymodel</a>
	  </div>
    

  </section>
</article>
  
    <article class="post ">

  
  <h2 class="title">
    <a href="/yycache/">
      ä» YYCache æºç  Get åˆ°å¦‚ä½•è®¾è®¡ä¸€ä¸ªä¼˜ç§€çš„ç¼“å­˜
    </a>
  </h2>
  
  <time>
    10æœˆ 30, 2017
  </time>
  <section class="content">
	  <img src="/yycache/how_to_design_a_good_cache.jpg" class="">
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>iOS å¼€å‘ä¸­æ€»ä¼šç”¨åˆ°å„ç§ç¼“å­˜ï¼Œä½†æ˜¯å„ä½æœ‰æ²¡æœ‰è€ƒè™‘è¿‡ä»€ä¹ˆæ ·çš„ç¼“å­˜æ‰èƒ½è¢«å«åšä¼˜ç§€çš„ç¼“å­˜ï¼Œæˆ–è€…è¯´ä¼˜ç§€çš„ç¼“å­˜åº”è¯¥å…·å¤‡å“ªäº›ç‰¹è´¨ï¼Ÿ</p>
<p><strong>é—­ä¸Šçœ¼ç›ï¼Œæƒ³ä¸€æƒ³å¦‚æœé¢è¯•å®˜è®©ä½ è®¾è®¡ä¸€ä¸ªç¼“å­˜ä½ ä¼šæ€ä¹ˆå›ç­”ï¼Ÿ</strong></p>
<p>æœ¬æ–‡å°†ç»“åˆ YYCache çš„æºç é€æ­¥å¸¦å¤§å®¶æ‰¾åˆ°ç­”æ¡ˆã€‚</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ibireme/YYCache">YYCache</a> æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„é«˜æ€§èƒ½é”®å€¼ç¼“å­˜ï¼ˆè¯¥é¡¹ç›®æ˜¯ <a target="_blank" rel="noopener" href="https://github.com/ibireme/YYKit">YYKit</a> ç»„ä»¶ä¹‹ä¸€ï¼‰ã€‚YYKit æ˜¯åœ¨ 2015 å¹´å‘å¸ƒåˆ° Github çš„ï¼Œç”±äºå…¶ä»£ç è´¨é‡å¾ˆé«˜ï¼Œåœ¨çŸ­æ—¶é—´å†…å°±æ”¶è·äº†å¤§é‡çš„ Starï¼ˆç›®å‰å·²ç» 1w+ Star äº†ï¼‰ï¼Œè€Œä¸”åœ¨ iOS å„å¤§ç¤¾åŒºåå“å¹¿æ³›ï¼ŒGoogle ä¸€ä¸‹ä¹Ÿæ˜¯æ¼«å¤©èµå¹ã€‚</p>
<p>YYKit ä½œè€…æ˜¯ <a target="_blank" rel="noopener" href="https://github.com/ibireme">@ibireme</a>ï¼ŒåŸåéƒ­æ›œæºï¼ˆçŒœæµ‹ YY å‰ç¼€æ¥æºäºæ›œæºï¼Ÿï¼‰ï¼Œæ˜¯æˆ‘ä¸ªäººéå¸¸å–œæ¬¢çš„å›½äººå¼€å‘è€…ï¼ˆä½•æ­¢å–œæ¬¢ï¼Œç®€ç›´æ˜¯è¿·å¼ŸğŸ˜˜ï¼‰ã€‚</p>
<p>YYCache çš„ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ³¨é‡Šè¯¦å°½ï¼ŒåŠ ä¸Šè‡ªèº«ä¸ç®—å¤ªå¤§çš„ä»£ç é‡ä½¿å¾—å…¶é˜…è¯»éå¸¸ç®€å•ï¼Œæ›´åŠ éš¾èƒ½å¯è´µçš„æ˜¯å®ƒçš„æ€§èƒ½è¿˜éå¸¸é«˜ã€‚</p>
<img src="/yycache/performance_yymemorycache.jpg" class="">
<img src="/yycache/performance_yydiskcache.jpg" class="">
<p>æˆ‘å¯¹å®ƒçš„è¯„ä»·æ˜¯<strong>å°è€Œç¾</strong>ï¼Œè¿™ç§å°è€Œç¾çš„ç¼“å­˜æºç å¯¹äºæˆ‘ä»¬ä»Šå¤©çš„ä¸»é¢˜å¤ªåˆé€‚ä¸è¿‡äº†ï¼ˆæœ¬æ–‡ä¸­ YYCache æºç ç‰ˆæœ¬ä¸º v1.0.4ï¼‰ã€‚</p>
<h2 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h2><ul>
<li>YYCache ç®€ä»‹</li>
<li>YYMemoryCache ç»†èŠ‚å‰–æ</li>
<li>YYDiskCache ç»†èŠ‚å‰–æ</li>
<li>ä¼˜ç§€çš„ç¼“å­˜åº”è¯¥å…·å¤‡å“ªäº›ç‰¹è´¨</li>
<li>æ€»ç»“</li>
</ul>
<h2 id="YYCache-ç®€ä»‹"><a href="#YYCache-ç®€ä»‹" class="headerlink" title="YYCache ç®€ä»‹"></a>YYCache ç®€ä»‹</h2><img src="/yycache/yycache.jpg" class="">
<p>ç®€å•æŠŠ YYCache ä»å¤´åˆ°å°¾æ’¸äº†ä¸€éï¼Œæœ€å¤§çš„æ„Ÿè§¦å°±æ˜¯ä»£ç é£æ ¼å¹²å‡€æ•´æ´ï¼Œä»£ç æ€è·¯æ¸…æ™°æ˜äº†ã€‚</p>
<p>ç”±äºä»£ç æ•´ä½“é˜…è¯»éš¾åº¦ä¸æ˜¯éå¸¸å¤§ï¼Œæœ¬æ–‡ä¸ä¼šå»é€å­—é€å¥çš„è§£è¯»æºç ï¼Œè€Œæ˜¯æç‚¼ YYCache ä½œä¸ºä¸€ä¸ªå°è€Œç¾çš„ç¼“å­˜å®ç°äº†å“ªäº›ç¼“å­˜è¯¥å…·å¤‡çš„ç‰¹è´¨ï¼Œå¹¶ä¸”åˆ†æå®ç°ç»†èŠ‚ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥ç®€å•çœ‹ä¸€ä¸‹ YYCache çš„ä»£ç ç»“æ„ï¼ŒYYCache æ˜¯ç”± YYMemoryCache ä¸ YYDiskCache ä¸¤éƒ¨åˆ†ç»„æˆçš„ï¼Œå…¶ä¸­ YYMemoryCache ä½œä¸ºé«˜é€Ÿå†…å­˜ç¼“å­˜ï¼Œè€Œ YYDiskCache åˆ™ä½œä¸ºä½é€Ÿç£ç›˜ç¼“å­˜ã€‚</p>
<blockquote>
<p>é€šå¸¸ä¸€ä¸ªç¼“å­˜æ˜¯ç”±å†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜ç»„æˆï¼Œå†…å­˜ç¼“å­˜æä¾›å®¹é‡å°ä½†é«˜é€Ÿçš„å­˜å–åŠŸèƒ½ï¼Œç£ç›˜ç¼“å­˜æä¾›å¤§å®¹é‡ä½†ä½é€Ÿçš„æŒä¹…åŒ–å­˜å‚¨ã€‚</p>
</blockquote>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYCache</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">copy</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">readonly</span>) YYMemoryCache *memoryCache;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">readonly</span>) YYDiskCache *diskCache;</span><br><span class="line"></span><br><span class="line">- (<span class="type">BOOL</span>)containsObjectForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">nullable</span> <span class="type">id</span>&lt;<span class="built_in">NSCoding</span>&gt;)objectForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="type">void</span>)setObject:(<span class="keyword">nullable</span> <span class="type">id</span>&lt;<span class="built_in">NSCoding</span>&gt;)object forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="type">void</span>)removeObjectForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç æˆ‘åšäº†ç®€åŒ–ï¼Œåªä¿ç•™äº†æœ€åŸºæœ¬çš„ä»£ç ï¼ˆæˆ‘è®¤ä¸ºä½œè€…åœ¨æœ€åˆè®¾è®¡ YYCache é›å½¢æ—¶å¾ˆå¯èƒ½ä¹Ÿåªæ˜¯æä¾›äº†è¿™äº›åŸºæœ¬çš„æ¥å£ï¼‰ï¼Œå…¶ä»–çš„æ¥å£åªæ˜¯é€šè¿‡è°ƒç”¨åŸºæœ¬çš„æ¥å£å†é™„åŠ å¯¹åº”å¤„ç†ä»£ç è€Œæˆã€‚</p>
<blockquote>
<p>Note: å…¶å®æºç ä¸­ä½œè€…ç”¨äº†ä¸€äº›æŠ€å·§æ€§çš„å®ï¼Œä¾‹å¦‚ <code>NS_ASSUME_NONNULL_BEGIN</code> ä¸ <code>NS_ASSUME_NONNULL_END</code> æ¥é€šè¿‡ç¼–è¯‘å™¨å±‚æ£€æµ‹å…¥å‚æ˜¯å¦ä¸ºç©ºå¹¶ç»™äºˆè­¦å‘Šï¼Œå‚è§ <a target="_blank" rel="noopener" href="https://developer.apple.com/swift/blog/?id=25">Nullability and Objective-C</a>ã€‚</p>
<p>ç±»ä¼¼ä¸Šè¿°çš„ç¼–ç æŠ€å·§è¿˜æœ‰å¾ˆå¤šï¼Œæˆ‘å¹¶éä¸æƒ³ä¸å¤§å®¶åˆ†äº«æˆ‘ get åˆ°çš„è¿™äº›ç¼–ç æŠ€å·§ï¼Œåªæ˜¯è§‰å¾—å®ƒä¸æœ¬æ–‡çš„ä¸»é¢˜ä¼¼ä¹ä¸å¤ªç›¸ç¬¦ã€‚æˆ‘å‡†å¤‡åœ¨ä¹‹åä¸“é—¨å†™ä¸€ç¯‡æ–‡ç« æ¥ä¸å¤§å®¶åˆ†äº«æˆ‘åœ¨é˜…è¯»å„å¤§æºç åº“è¿‡ç¨‹ä¸­ get åˆ°çš„ç¼–ç æŠ€å·§ï¼ˆæ„Ÿå…´è¶£çš„è¯å¯ä»¥ <a target="_blank" rel="noopener" href="https://weibo.com/5071795354/profile">å…³æ³¨æˆ‘</a>ï¼‰ã€‚</p>
</blockquote>
<p>ä»ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ° YYCache ä¸­æŒæœ‰ YYMemoryCache ä¸ YYDiskCacheï¼Œå¹¶ä¸”å¯¹å¤–æä¾›äº†ä¸€äº›æ¥å£ã€‚è¿™äº›æ¥å£åŸºæœ¬éƒ½æ˜¯åŸºäº Key å’Œ Value è®¾è®¡çš„ï¼Œç±»ä¼¼äº iOS åŸç”Ÿçš„å­—å…¸ç±»æ¥å£ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰ã€‚</p>
<h2 id="YYMemoryCache-ç»†èŠ‚å‰–æ"><a href="#YYMemoryCache-ç»†èŠ‚å‰–æ" class="headerlink" title="YYMemoryCache ç»†èŠ‚å‰–æ"></a>YYMemoryCache ç»†èŠ‚å‰–æ</h2><img src="/yycache/yymemorycache.jpg" class="">
<p>YYMemoryCache æ˜¯ä¸€ä¸ªé«˜é€Ÿçš„å†…å­˜ç¼“å­˜ï¼Œç”¨äºå­˜å‚¨é”®å€¼å¯¹ã€‚å®ƒä¸ NSDictionary ç›¸åï¼ŒKey è¢«ä¿ç•™å¹¶ä¸”ä¸å¤åˆ¶ã€‚API å’Œæ€§èƒ½ç±»ä¼¼äº NSCacheï¼Œæ‰€æœ‰æ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>YYMemoryCache å¯¹è±¡ä¸ NSCache çš„ä¸åŒä¹‹å¤„åœ¨äºï¼š</p>
<ul>
<li>YYMemoryCache ä½¿ç”¨ LRU(least-recently-used) ç®—æ³•æ¥é©±é€å¯¹è±¡ï¼›NSCache çš„é©±é€æ–¹å¼æ˜¯éç¡®å®šæ€§çš„ã€‚</li>
<li>YYMemoryCache æä¾› ageã€costã€count ä¸‰ç§æ–¹å¼æ§åˆ¶ç¼“å­˜ï¼›NSCache çš„æ§åˆ¶æ–¹å¼æ˜¯ä¸ç²¾ç¡®çš„ã€‚</li>
<li>YYMemoryCache å¯ä»¥é…ç½®ä¸ºåœ¨æ”¶åˆ°å†…å­˜è­¦å‘Šæˆ–è€… App è¿›å…¥åå°æ—¶è‡ªåŠ¨é€å‡ºå¯¹è±¡ã€‚</li>
</ul>
<blockquote>
<p>Note: YYMemoryCache ä¸­çš„ <code>Access Methods</code> æ¶ˆè€—æ—¶é•¿é€šå¸¸æ˜¯ç¨³å®šçš„ <code>(O(1))</code>ã€‚</p>
</blockquote>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYMemoryCache</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - Attribute</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name; <span class="comment">// ç¼“å­˜åç§°ï¼Œé»˜è®¤ä¸º nil</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> totalCount; <span class="comment">// ç¼“å­˜å¯¹è±¡æ€»æ•°</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> totalCost; <span class="comment">// ç¼“å­˜å¯¹è±¡æ€»å¼€é”€</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - Limit</span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">NSUInteger</span> countLimit; <span class="comment">// ç¼“å­˜å¯¹è±¡æ•°é‡é™åˆ¶ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œè¶…è¿‡é™åˆ¶åˆ™ä¼šåœ¨åå°é€å‡ºä¸€äº›å¯¹è±¡ä»¥æ»¡è¶³é™åˆ¶</span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">NSUInteger</span> costLimit; <span class="comment">// ç¼“å­˜å¼€é”€æ•°é‡é™åˆ¶ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œè¶…è¿‡é™åˆ¶åˆ™ä¼šåœ¨åå°é€å‡ºä¸€äº›å¯¹è±¡ä»¥æ»¡è¶³é™åˆ¶</span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">NSTimeInterval</span> ageLimit; <span class="comment">// ç¼“å­˜æ—¶é—´é™åˆ¶ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œè¶…è¿‡é™åˆ¶åˆ™ä¼šåœ¨åå°é€å‡ºä¸€äº›å¯¹è±¡ä»¥æ»¡è¶³é™åˆ¶</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">NSTimeInterval</span> autoTrimInterval; <span class="comment">// ç¼“å­˜è‡ªåŠ¨æ¸…ç†æ—¶é—´é—´éš”ï¼Œé»˜è®¤ 5s</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> <span class="type">BOOL</span> shouldRemoveAllObjectsOnMemoryWarning; <span class="comment">// æ˜¯å¦åº”è¯¥åœ¨æ”¶åˆ°å†…å­˜è­¦å‘Šæ—¶åˆ é™¤æ‰€æœ‰ç¼“å­˜å†…å¯¹è±¡</span></span><br><span class="line"><span class="keyword">@property</span> <span class="type">BOOL</span> shouldRemoveAllObjectsWhenEnteringBackground; <span class="comment">// æ˜¯å¦åº”è¯¥åœ¨ App è¿›å…¥åå°æ—¶åˆ é™¤æ‰€æœ‰ç¼“å­˜å†…å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">copy</span>) <span class="type">void</span>(^didReceiveMemoryWarningBlock)(YYMemoryCache *cache); <span class="comment">// æˆ‘è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ª hookï¼Œä¾¿äºæˆ‘ä»¬åœ¨æ”¶åˆ°å†…å­˜è­¦å‘Šæ—¶è‡ªå®šä¹‰å¤„ç†ç¼“å­˜</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">copy</span>) <span class="type">void</span>(^didEnterBackgroundBlock)(YYMemoryCache *cache); <span class="comment">// æˆ‘è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ª hookï¼Œä¾¿äºæˆ‘ä»¬åœ¨æ”¶åˆ° App è¿›å…¥åå°æ—¶è‡ªå®šä¹‰å¤„ç†ç¼“å­˜</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> <span class="type">BOOL</span> releaseOnMainThread; <span class="comment">// æ˜¯å¦åœ¨ä¸»çº¿ç¨‹é‡Šæ”¾å¯¹è±¡ï¼Œé»˜è®¤ NOï¼Œæœ‰äº›å¯¹è±¡ï¼ˆä¾‹å¦‚ UIView/CALayerï¼‰åº”è¯¥åœ¨ä¸»çº¿ç¨‹é‡Šæ”¾</span></span><br><span class="line"><span class="keyword">@property</span> <span class="type">BOOL</span> releaseAsynchronously; <span class="comment">// æ˜¯å¦å¼‚æ­¥é‡Šæ”¾å¯¹è±¡ï¼Œé»˜è®¤ YES</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">BOOL</span>)containsObjectForKey:(<span class="type">id</span>)key;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="type">id</span>)objectForKey:(<span class="type">id</span>)key;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)setObject:(<span class="keyword">nullable</span> <span class="type">id</span>)object forKey:(<span class="type">id</span>)key;</span><br><span class="line">- (<span class="type">void</span>)setObject:(<span class="keyword">nullable</span> <span class="type">id</span>)object forKey:(<span class="type">id</span>)key withCost:(<span class="built_in">NSUInteger</span>)cost;</span><br><span class="line">- (<span class="type">void</span>)removeObjectForKey:(<span class="type">id</span>)key;</span><br><span class="line">- (<span class="type">void</span>)removeAllObjects;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - Trim</span></span><br><span class="line">- (<span class="type">void</span>)trimToCount:(<span class="built_in">NSUInteger</span>)count; <span class="comment">// ç”¨ LRU ç®—æ³•åˆ é™¤å¯¹è±¡ï¼Œç›´åˆ° totalCount &lt;= count</span></span><br><span class="line">- (<span class="type">void</span>)trimToCost:(<span class="built_in">NSUInteger</span>)cost; <span class="comment">// ç”¨ LRU ç®—æ³•åˆ é™¤å¯¹è±¡ï¼Œç›´åˆ° totalCost &lt;= cost</span></span><br><span class="line">- (<span class="type">void</span>)trimToAge:(<span class="built_in">NSTimeInterval</span>)age; <span class="comment">// ç”¨ LRU ç®—æ³•åˆ é™¤å¯¹è±¡ï¼Œç›´åˆ°æ‰€æœ‰åˆ°æœŸå¯¹è±¡å…¨éƒ¨è¢«åˆ é™¤</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>YYMemoryCache çš„å®šä¹‰ä»£ç æ¯”è¾ƒç®€å•~ è¯¥æœ‰çš„æ³¨é‡Šæˆ‘å·²ç»åŠ åˆ°äº†ä¸Šé¢ï¼Œè¿™é‡Œ LRU ç®—æ³•çš„å®ç°æˆ‘å‡†å¤‡å•ç‹¬æ‹å‡ºæ¥æ”¾åˆ°åé¢å’Œï¼ˆ<code>_YYLinkedMapNode</code> ä¸ <code>_YYLinkedMap</code>ï¼‰ä¸€èµ·è®²ã€‚æˆ‘ä»¬è¿™é‡Œåªéœ€è¦å†å…³æ³¨ä¸€ä¸‹ YYMemoryCache æ˜¯å¦‚ä½•åšåˆ°çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<h3 id="YYMemoryCache-æ˜¯å¦‚ä½•åšåˆ°çº¿ç¨‹å®‰å…¨çš„"><a href="#YYMemoryCache-æ˜¯å¦‚ä½•åšåˆ°çº¿ç¨‹å®‰å…¨çš„" class="headerlink" title="YYMemoryCache æ˜¯å¦‚ä½•åšåˆ°çº¿ç¨‹å®‰å…¨çš„"></a>YYMemoryCache æ˜¯å¦‚ä½•åšåˆ°çº¿ç¨‹å®‰å…¨çš„</h3><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYMemoryCache</span> </span>&#123;</span><br><span class="line">    pthread_mutex_t _lock; <span class="comment">// çº¿ç¨‹é”ï¼Œæ—¨åœ¨ä¿è¯ YYMemoryCache çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">    _YYLinkedMap *_lru; <span class="comment">// _YYLinkedMapï¼ŒYYMemoryCache é€šè¿‡å®ƒé—´æ¥æ“ä½œç¼“å­˜å¯¹è±¡</span></span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> _queue; <span class="comment">// ä¸²è¡Œé˜Ÿåˆ—ï¼Œç”¨äº YYMemoryCache çš„ trim æ“ä½œ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ²¡é”™ï¼Œè¿™é‡Œ ibireme é€‰æ‹©ä½¿ç”¨ <code>pthread_mutex</code> çº¿ç¨‹é”æ¥ç¡®ä¿ YYMemoryCache çš„çº¿ç¨‹å®‰å…¨ã€‚</p>
<blockquote>
<p>æœ‰è¶£çš„æ˜¯ï¼Œè¿™é‡Œ ibireme ä½¿ç”¨ <code>pthread_mutex</code> æ˜¯æœ‰ä¸€æ®µå°æ•…äº‹çš„ã€‚åœ¨æœ€åˆ YYMemoryCache è¿™é‡Œä½¿ç”¨çš„é”æ˜¯ <code>OSSpinLock</code> è‡ªæ—‹é”ï¼ˆè¯¦è§ <a target="_blank" rel="noopener" href="https://blog.ibireme.com/2015/10/26/yycache/">YYCache è®¾è®¡æ€è·¯</a> å¤‡æ³¨-å…³äºé”ï¼‰ï¼Œåé¢æœ‰äººåœ¨ Github å‘ä½œè€…æ <a target="_blank" rel="noopener" href="https://github.com/ibireme/YYModel/issues/43">issue</a> åé¦ˆ <code>OSSpinLock</code> ä¸å®‰å…¨ï¼Œç»è¿‡ä½œè€…çš„ç¡®è®¤ï¼ˆè¯¦è§ <a target="_blank" rel="noopener" href="https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/">ä¸å†å®‰å…¨çš„ OSSpinLock</a>ï¼‰æœ€åé€‰æ‹©ç”¨ <code>pthread_mutex</code> æ›¿ä»£ <code>OSSpinLock</code>ã€‚</p>
</blockquote>
<img src="/yycache/lock_benchmark.jpg" class="">
<p>ä¸Šé¢æ˜¯ ibireme åœ¨ç¡®è®¤ <code>OSSpinLock</code> ä¸å†å®‰å…¨ä¹‹åä¸ºäº†å¯»æ‰¾æ›¿ä»£æ–¹æ¡ˆåšçš„ç®€å•æ€§èƒ½æµ‹è¯•ï¼Œå¯¹æ¯”äº†ä¸€ä¸‹å‡ ç§èƒ½å¤Ÿæ›¿ä»£ <code>OSSpinLock</code> é”çš„æ€§èƒ½ã€‚åœ¨ <a target="_blank" rel="noopener" href="https://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/">ä¸å†å®‰å…¨çš„ OSSpinLock</a> æ–‡æœ«çš„è¯„è®ºä¸­ï¼Œæˆ‘æ‰¾åˆ°äº†ä½œè€…ä½¿ç”¨ <code>pthread_mutex</code> çš„åŸå› ã€‚</p>
<blockquote>
<p>ibireme: è‹¹æœå‘˜å·¥è¯´ libobjc é‡Œ <code>spinlock</code> æ˜¯ç”¨äº†ä¸€äº›ç§æœ‰æ–¹æ³• (<code>mach_thread_switch</code>)ï¼Œè´¡çŒ®å‡ºäº†é«˜çº¿ç¨‹çš„ä¼˜å…ˆæ¥é¿å…ä¼˜å…ˆçº§åè½¬çš„é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ç¿»äº†ä¸‹ libdispatch çš„æºç å€’æ˜¯æ²¡å‘ç°ç›¸å…³é€»è¾‘ï¼Œä¹Ÿå¯èƒ½æ˜¯æˆ‘å¿½ç•¥äº†ä»€ä¹ˆã€‚åœ¨æˆ‘çš„ä¸€äº›æµ‹è¯•ä¸­ï¼Œ<code>OSSpinLock</code> å’Œ <code>dispatch_semaphore</code> éƒ½ä¸ä¼šäº§ç”Ÿç‰¹åˆ«æ˜æ˜¾çš„æ­»é”ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿæ— æ³•ç¡®å®šç”¨ <code>dispatch_semaphore</code> ä»£æ›¿ <code>OSSpinLock</code> æ˜¯å¦æ­£ç¡®ã€‚èƒ½å¤Ÿè‚¯å®šçš„æ˜¯ï¼Œç”¨ <code>pthread_mutex</code> æ˜¯å®‰å…¨çš„ã€‚</p>
</blockquote>
<h3 id="YYLinkedMapNode-ä¸-YYLinkedMap"><a href="#YYLinkedMapNode-ä¸-YYLinkedMap" class="headerlink" title="_YYLinkedMapNode ä¸ _YYLinkedMap"></a><code>_YYLinkedMapNode</code> ä¸ <code>_YYLinkedMap</code></h3><p>ä¸Šæ–‡ä»‹ç»äº† YYMemoryCacheï¼Œå…¶å® YYMemoryCache å¹¶ä¸ç›´æ¥æ“ä½œç¼“å­˜å¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡å†…éƒ¨çš„ <code>_YYLinkedMapNode</code> ä¸ <code>_YYLinkedMap</code> æ¥é—´æ¥çš„æ“ä½œç¼“å­˜å¯¹è±¡ã€‚è¿™ä¸¤ä¸ªç±»å¯¹äºä¸Šæ–‡ä¸­æåˆ°çš„ LRU ç¼“å­˜ç®—æ³•çš„ç†è§£è‡³å…³é‡è¦ï¼Œæ‰€ä»¥æˆ‘æŠŠä»–ä»¬ä¿©å•ç‹¬æ‹å‡ºæ¥æ”¾åœ¨è¿™é‡Œè¯¦ç»†è§£è¯»ä¸€ä¸‹ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> _YYLinkedMap ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="comment"> é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬ä¸åº”è¯¥ä½¿ç”¨è¿™ä¸ªç±»ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">_YYLinkedMapNode</span> : <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">@package</span></span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> _YYLinkedMapNode *_prev; <span class="comment">// __unsafe_unretained æ˜¯ä¸ºäº†æ€§èƒ½ä¼˜åŒ–ï¼ŒèŠ‚ç‚¹è¢« _YYLinkedMap çš„ _dic å¼ºå¼•ç”¨</span></span><br><span class="line">    __<span class="keyword">unsafe_unretained</span> _YYLinkedMapNode *_next; <span class="comment">// __unsafe_unretained æ˜¯ä¸ºäº†æ€§èƒ½ä¼˜åŒ–ï¼ŒèŠ‚ç‚¹è¢« _YYLinkedMap çš„ _dic å¼ºå¼•ç”¨</span></span><br><span class="line">    <span class="type">id</span> _key;</span><br><span class="line">    <span class="type">id</span> _value;</span><br><span class="line">    <span class="built_in">NSUInteger</span> _cost; <span class="comment">// è®°å½•å¼€é”€ï¼Œå¯¹åº” YYMemoryCache æä¾›çš„ cost æ§åˆ¶</span></span><br><span class="line">    <span class="built_in">NSTimeInterval</span> _time; <span class="comment">// è®°å½•æ—¶é—´ï¼Œå¯¹åº” YYMemoryCache æä¾›çš„ age æ§åˆ¶</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> YYMemoryCache å†…çš„ä¸€ä¸ªé“¾è¡¨ã€‚</span></span><br><span class="line"><span class="comment"> _YYLinkedMap ä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ç±»ï¼Œè€Œä¸”å®ƒä¹Ÿä¸å¯¹å‚æ•°åšæ ¡éªŒã€‚</span></span><br><span class="line"><span class="comment"> é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬ä¸åº”è¯¥ä½¿ç”¨è¿™ä¸ªç±»ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">_YYLinkedMap</span> : <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">@package</span></span><br><span class="line">    <span class="built_in">CFMutableDictionaryRef</span> _dic; <span class="comment">// ä¸è¦ç›´æ¥è®¾ç½®è¯¥å¯¹è±¡</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> _totalCost;</span><br><span class="line">    <span class="built_in">NSUInteger</span> _totalCount;</span><br><span class="line">    _YYLinkedMapNode *_head; <span class="comment">// MRU, æœ€å¸¸ç”¨èŠ‚ç‚¹ï¼Œä¸è¦ç›´æ¥ä¿®æ”¹å®ƒ</span></span><br><span class="line">    _YYLinkedMapNode *_tail; <span class="comment">// LRU, æœ€å°‘ç”¨èŠ‚ç‚¹ï¼Œä¸è¦ç›´æ¥ä¿®æ”¹å®ƒ</span></span><br><span class="line">    <span class="type">BOOL</span> _releaseOnMainThread; <span class="comment">// å¯¹åº” YYMemoryCache çš„ releaseOnMainThread</span></span><br><span class="line">    <span class="type">BOOL</span> _releaseAsynchronously; <span class="comment">// å¯¹åº” YYMemoryCache çš„ releaseAsynchronously</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é“¾è¡¨æ“ä½œï¼Œçœ‹æ¥å£åç§°åº”è¯¥ä¸éœ€è¦æ³¨é‡Šå§~</span></span><br><span class="line">- (<span class="type">void</span>)insertNodeAtHead:(_YYLinkedMapNode *)node;</span><br><span class="line">- (<span class="type">void</span>)bringNodeToHead:(_YYLinkedMapNode *)node;</span><br><span class="line">- (<span class="type">void</span>)removeNode:(_YYLinkedMapNode *)node;</span><br><span class="line">- (_YYLinkedMapNode *)removeTailNode;</span><br><span class="line">- (<span class="type">void</span>)removeAll;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†æ–¹ä¾¿å¤§å®¶é˜…è¯»ï¼Œæˆ‘æ ‡æ³¨äº†å¿…è¦çš„ä¸­æ–‡æ³¨é‡Šã€‚å…¶å®å¯¹æ•°æ®ç»“æ„ä¸ç®—æ³•ä¸é™Œç”Ÿçš„åŒå­¦åº”è¯¥ä¸€çœ¼å°±çœ‹çš„å‡ºæ¥ <code>_YYLinkedMapNode</code> ä¸ <code>_YYLinkedMap</code> è¿™ä¿©è´§çš„æœ¬è´¨ã€‚æ²¡é”™ï¼Œä¸«å°±æ˜¯åŒå‘é“¾è¡¨èŠ‚ç‚¹å’ŒåŒå‘é“¾è¡¨ã€‚</p>
<p><code>_YYLinkedMapNode</code> ä½œä¸ºåŒå‘é“¾è¡¨èŠ‚ç‚¹ï¼Œé™¤äº†åŸºæœ¬çš„ <code>_prev</code>ã€<code>_next</code>ï¼Œè¿˜æœ‰é”®å€¼ç¼“å­˜åŸºæœ¬çš„ <code>_key</code> ä¸ <code>_value</code>ï¼Œ<strong>æˆ‘ä»¬å¯ä»¥æŠŠ <code>_YYLinkedMapNode</code> ç†è§£ä¸º YYMemoryCache ä¸­çš„ä¸€ä¸ªç¼“å­˜å¯¹è±¡</strong>ã€‚</p>
<p><code>_YYLinkedMap</code> ä½œä¸ºç”± <code>_YYLinkedMapNode</code> èŠ‚ç‚¹ç»„æˆçš„åŒå‘é“¾è¡¨ï¼Œä½¿ç”¨ <code>CFMutableDictionaryRef _dic</code> å­—å…¸å­˜å‚¨ <code>_YYLinkedMapNode</code>ã€‚è¿™æ ·åœ¨ç¡®ä¿ <code>_YYLinkedMapNode</code> è¢«å¼ºå¼•ç”¨çš„åŒæ—¶ï¼Œèƒ½å¤Ÿåˆ©ç”¨å­—å…¸çš„ Hash å¿«é€Ÿå®šä½ç”¨æˆ·è¦è®¿é—®çš„ç¼“å­˜å¯¹è±¡ï¼Œè¿™æ ·æ—¢ç¬¦åˆäº†é”®å€¼ç¼“å­˜çš„æ¦‚å¿µåˆçœå»äº†è‡ªå·±å®ç°çš„éº»çƒ¦ï¼ˆç¬‘ï¼‰ã€‚</p>
<p>å˜›~ æ€»å¾—æ¥è¯´ YYMemoryCache æ˜¯é€šè¿‡ä½¿ç”¨ <code>_YYLinkedMap</code> åŒå‘é“¾è¡¨æ¥æ“ä½œ <code>_YYLinkedMapNode</code> ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹çš„ã€‚</p>
<h3 id="LRU-least-recently-used-ç®—æ³•çš„å®ç°"><a href="#LRU-least-recently-used-ç®—æ³•çš„å®ç°" class="headerlink" title="LRU(least-recently-used) ç®—æ³•çš„å®ç°"></a>LRU(least-recently-used) ç®—æ³•çš„å®ç°</h3><p>ä¸Šæ–‡æˆ‘ä»¬è®¤æ¸…äº† <code>_YYLinkedMap</code> ä¸ <code>_YYLinkedMapNode</code> æœ¬è´¨ä¸Šå°±æ˜¯åŒå‘é“¾è¡¨å’Œé“¾è¡¨èŠ‚ç‚¹ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•è®²ä¸€ä¸‹ YYMemoryCache æ˜¯å¦‚ä½•åˆ©ç”¨åŒå‘é“¾è¡¨å®ç° LRU(least-recently-used) ç®—æ³•çš„ã€‚</p>
<h4 id="ç¼“å­˜æ›¿æ¢ç­–ç•¥"><a href="#ç¼“å­˜æ›¿æ¢ç­–ç•¥" class="headerlink" title="ç¼“å­˜æ›¿æ¢ç­–ç•¥"></a>ç¼“å­˜æ›¿æ¢ç­–ç•¥</h4><p>é¦–å…ˆ LRU æ˜¯ç¼“å­˜æ›¿æ¢ç­–ç•¥ï¼ˆ<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cache_replacement_policies">Cache replacement policies</a>ï¼‰çš„ä¸€ç§ï¼Œè¿˜æœ‰å¾ˆå¤šç¼“å­˜æ›¿æ¢ç­–ç•¥è¯¸å¦‚ï¼š</p>
<ul>
<li>First In First Out (FIFO)</li>
<li>Last In First Out (LIFO)</li>
<li>Time aware Least Recently Used (TLRU)</li>
<li>Most Recently Used (MRU)</li>
<li>Pseudo-LRU (PLRU)</li>
<li>Random Replacement (RR)</li>
<li>Segmented LRU (SLRU)</li>
<li>Least-Frequently Used (LFU)</li>
<li>Least Frequent Recently Used (LFRU)</li>
<li>LFU with Dynamic Aging (LFUDA)</li>
<li>Low Inter-reference Recency Set (LIRS)</li>
<li>Adaptive Replacement Cache (ARC)</li>
<li>Clock with Adaptive Replacement (CAR)</li>
<li>Multi Queue (MQ) caching algorithm|Multi Queue (MQ)</li>
<li>Pannier: Container-based caching algorithm for compound objects</li>
</ul>
<p>æ˜¯ä¸æ˜¯è¢«å”¬åˆ°äº†ï¼Ÿä¸è¦æ‹…å¿ƒï¼Œæˆ‘è¿™é‡Œä¼šè¡¨è¿°çš„å°½é‡æ˜“æ‡‚ã€‚</p>
<h4 id="ç¼“å­˜å‘½ä¸­ç‡"><a href="#ç¼“å­˜å‘½ä¸­ç‡" class="headerlink" title="ç¼“å­˜å‘½ä¸­ç‡"></a>ç¼“å­˜å‘½ä¸­ç‡</h4><img src="/yycache/cache_hit_ratio.png" class="">
<p>ä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šç¼“å­˜æ›¿æ¢ç­–ç•¥ï¼Œæˆ–è€…è¯´æè¿™ä¹ˆå¤šåå ‚ç©¶ç«Ÿæ˜¯ä¸ºäº†ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯æé«˜ç¼“å­˜å‘½ä¸­ç‡ï¼Œé‚£ä¹ˆä½•è°“ç¼“å­˜å‘½ä¸­ç‡å‘¢ï¼Ÿ</p>
<p>Google ä¸€ä¸‹è‡ªç„¶æ˜¯æœ‰ä¸å°‘è§£é‡Šï¼Œä¸è¿‡å¾ˆå¤šéƒ½æ˜¯ web ç›¸å…³çš„ï¼Œè€Œä¸”ä¸è¯´äººè¯ï¼ˆå¾ˆéš¾ç†è§£ï¼‰ï¼Œæˆ‘ä¸ªäººéå¸¸è®¨åŒå„ç§ä¸è¯´äººè¯çš„â€œé«˜æ·±â€æŠ½è±¡æ¦‚å¿µã€‚</p>
<p>è¿™é‡ŒæŠ–äº†å¥½å‡ æŠ–èƒ†æ‰æ•¢è°ˆä¸€ä¸‹æˆ‘å¯¹äºç¼“å­˜å‘½ä¸­ç‡çš„ç†è§£ï¼ˆé™äº YYCache å’Œ iOS å¼€å‘ï¼‰ã€‚</p>
<ul>
<li>ç¼“å­˜å‘½ä¸­ = ç”¨æˆ·è¦è®¿é—®çš„ç¼“å­˜å¯¹è±¡åœ¨é«˜é€Ÿç¼“å­˜ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨é«˜é€Ÿç¼“å­˜ä¸­é€šè¿‡ Hash å°†å…¶æ‰¾åˆ°å¹¶è¿”å›ç»™ç”¨æˆ·ã€‚</li>
<li>ç¼“å­˜å‘½ä¸­ç‡ = ç”¨æˆ·è¦è®¿é—®çš„ç¼“å­˜å¯¹è±¡åœ¨é«˜é€Ÿç¼“å­˜ä¸­è¢«æˆ‘ä»¬è®¿é—®åˆ°çš„æ¦‚ç‡ã€‚</li>
</ul>
<p>æ—¢ç„¶è°ˆåˆ°äº†è‡ªå·±çš„ç†è§£ï¼Œæˆ‘ç´¢æ€§è¯´ä¸ªå¤Ÿã€‚</p>
<ul>
<li>ç¼“å­˜ä¸¢å¤± = ç”±äºé«˜é€Ÿç¼“å­˜æ•°é‡æœ‰é™ï¼ˆå æ®å†…å­˜ç­‰åŸå› ï¼‰ï¼Œæ‰€ä»¥ç”¨æˆ·è¦è®¿é—®çš„ç¼“å­˜å¯¹è±¡å¾ˆæœ‰å¯èƒ½è¢«æˆ‘ä»¬ä»æœ‰é™çš„é«˜é€Ÿç¼“å­˜ä¸­æ·˜æ±°æ‰äº†ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå°†å…¶å­˜å‚¨äºä½é€Ÿçš„ç£ç›˜ç¼“å­˜ä¸­ï¼ˆå¦‚æœç£ç›˜ç¼“å­˜è¿˜æœ‰èµ„æºçš„è¯ï¼‰ï¼Œé‚£ä¹ˆå°±è¦ä»ç£ç›˜ç¼“å­˜ä¸­è·å–è¯¥ç¼“å­˜å¯¹è±¡ä»¥è¿”å›ç»™ç”¨æˆ·ï¼Œè¿™ç§æƒ…å†µæˆ‘ç†è§£ä¸ºï¼ˆé«˜é€Ÿï¼‰ç¼“å­˜æœªå‘½ä¸­ï¼Œå³ç¼“å­˜ä¸¢å¤±ï¼ˆå¹¶ä¸æ˜¯çœŸçš„è¢«æˆ‘ä»¬ä¸¢æ‰äº†ï¼Œä½†è‚¯å®šæ˜¯è¢«æˆ‘ä»¬ä»é«˜é€Ÿç¼“å­˜æ·˜æ±°æ‰äº†ï¼‰ã€‚</li>
</ul>
<p>ç¼“å­˜å‘½ä¸­æ˜¯ cache-hitï¼Œé‚£ä¹ˆå¦‚æœä½ ç©æ¸¸æˆï¼Œå¯ä»¥ç†è§£ä¸ºè¿™æ¬¡ hit miss äº†ï¼ˆç¬‘ï¼Œæœ‰äººæ‰¾æˆ‘å¼€é»‘å—ï¼‰ã€‚</p>
<h4 id="LRU"><a href="#LRU" class="headerlink" title="LRU"></a>LRU</h4><p>é¦–å…ˆæ¥è®²ä¸€ä¸‹ LRU çš„æ¦‚å¿µè®©å¤§å®¶æœ‰ä¸€ä¸ªåŸºæœ¬çš„è®¤è¯†ã€‚LRU(least-recently-used) ç¿»è¯‘è¿‡æ¥æ˜¯â€œæœ€è¿‘æœ€å°‘ä½¿ç”¨â€ï¼Œé¡¾åæ€ä¹‰è¿™ç§ç¼“å­˜æ›¿æ¢ç­–ç•¥æ˜¯åŸºäºç”¨æˆ·æœ€è¿‘æœ€å°‘è®¿é—®è¿‡çš„ç¼“å­˜å¯¹è±¡è€Œå»ºç«‹ã€‚</p>
<p>æˆ‘è®¤ä¸º LRU ç¼“å­˜æ›¿æ¢ç­–ç•¥çš„æ ¸å¿ƒæ€æƒ³åœ¨äºï¼šLRU è®¤ä¸ºç”¨æˆ·æœ€æ–°ä½¿ç”¨ï¼ˆè®¿é—®ï¼‰è¿‡çš„ç¼“å­˜å¯¹è±¡ä¸ºé«˜é¢‘ç¼“å­˜å¯¹è±¡ï¼Œå³ç”¨æˆ·å¾ˆå¯èƒ½è¿˜ä¼šå†æ¬¡ä½¿ç”¨ï¼ˆè®¿é—®ï¼‰è¯¥ç¼“å­˜å¯¹è±¡ï¼›è€Œåä¹‹ï¼Œç”¨æˆ·å¾ˆä¹…ä¹‹å‰ä½¿ç”¨ï¼ˆè®¿é—®ï¼‰è¿‡çš„ç¼“å­˜å¯¹è±¡ï¼ˆæœŸé—´ä¸€ç›´æ²¡æœ‰å†æ¬¡è®¿é—®ï¼‰ä¸ºä½é¢‘ç¼“å­˜å¯¹è±¡ï¼Œå³ç”¨æˆ·å¾ˆå¯èƒ½ä¸ä¼šå†å»ä½¿ç”¨ï¼ˆè®¿é—®ï¼‰è¯¥ç¼“å­˜å¯¹è±¡ï¼Œé€šå¸¸åœ¨èµ„æºä¸è¶³æ—¶ä¼šå…ˆå»é‡Šæ”¾ä½é¢‘ç¼“å­˜å¯¹è±¡ã€‚</p>
<h4 id="YYLinkedMapNode-ä¸-YYLinkedMap-å®ç°-LRU"><a href="#YYLinkedMapNode-ä¸-YYLinkedMap-å®ç°-LRU" class="headerlink" title="_YYLinkedMapNode ä¸ _YYLinkedMap å®ç° LRU"></a><code>_YYLinkedMapNode</code> ä¸ <code>_YYLinkedMap</code> å®ç° LRU</h4><p>YYCache ä½œè€…é€šè¿‡ <code>_YYLinkedMapNode</code> ä¸ <code>_YYLinkedMap</code> åŒå‘é“¾è¡¨å®ç° LRU ç¼“å­˜æ›¿æ¢ç­–ç•¥çš„æ€è·¯å…¶å®å¾ˆç®€æ·æ¸…æ™°ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥çœ‹ã€‚</p>
<p>åŒå‘é“¾è¡¨ä¸­æœ‰å¤´ç»“ç‚¹å’Œå°¾èŠ‚ç‚¹ï¼š</p>
<ul>
<li>å¤´ç»“ç‚¹ = é“¾è¡¨ä¸­ç”¨æˆ·æœ€è¿‘ä¸€æ¬¡ä½¿ç”¨ï¼ˆè®¿é—®ï¼‰çš„ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹ï¼ŒMRUã€‚</li>
<li>å°¾èŠ‚ç‚¹ = é“¾è¡¨ä¸­ç”¨æˆ·å·²ç»å¾ˆä¹…æ²¡æœ‰å†æ¬¡ä½¿ç”¨ï¼ˆè®¿é—®ï¼‰çš„ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹ï¼ŒLRUã€‚</li>
</ul>
<p>å¦‚ä½•è®©å¤´ç»“ç‚¹å’Œå°¾èŠ‚ç‚¹æŒ‡å‘æˆ‘ä»¬æƒ³æŒ‡å‘çš„ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹ï¼Ÿæˆ‘ä»¬ç»“åˆä»£ç æ¥çœ‹ï¼š</p>
<ul>
<li>åœ¨ç”¨æˆ·ä½¿ç”¨ï¼ˆè®¿é—®ï¼‰æ—¶æ›´æ–°ç¼“å­˜èŠ‚ç‚¹ä¿¡æ¯ï¼Œå¹¶å°†å…¶ç§»åŠ¨è‡³åŒå‘é“¾è¡¨å¤´ç»“ç‚¹ã€‚</li>
</ul>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">id</span>)objectForKey:(<span class="type">id</span>)key &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å…¥å‚</span></span><br><span class="line">    <span class="keyword">if</span> (!key) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    pthread_mutex_lock(&amp;_lock);</span><br><span class="line">    <span class="comment">// æ‰¾åˆ°å¯¹åº”ç¼“å­˜èŠ‚ç‚¹</span></span><br><span class="line">    _YYLinkedMapNode *node = <span class="built_in">CFDictionaryGetValue</span>(_lru-&gt;_dic, (__bridge <span class="keyword">const</span> <span class="type">void</span> *)(key));</span><br><span class="line">    <span class="keyword">if</span> (node) &#123;</span><br><span class="line">        <span class="comment">// æ›´æ–°ç¼“å­˜èŠ‚ç‚¹æ—¶é—´ï¼Œå¹¶å°†å…¶ç§»åŠ¨è‡³åŒå‘é“¾è¡¨å¤´ç»“ç‚¹</span></span><br><span class="line">        node-&gt;_time = <span class="built_in">CACurrentMediaTime</span>();</span><br><span class="line">        [_lru bringNodeToHead:node];</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;_lock);</span><br><span class="line">    <span class="comment">// è¿”å›æ‰¾åˆ°çš„ç¼“å­˜èŠ‚ç‚¹ value</span></span><br><span class="line">    <span class="keyword">return</span> node ? node-&gt;_value : <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>åœ¨ç”¨æˆ·è®¾ç½®ç¼“å­˜å¯¹è±¡æ—¶ï¼Œåˆ¤æ–­å…¥å‚ key å¯¹åº”çš„ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ï¼Ÿå­˜åœ¨åˆ™æ›´æ–°ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹å¹¶å°†èŠ‚ç‚¹ç§»åŠ¨è‡³é“¾è¡¨å¤´ç»“ç‚¹ï¼›ä¸å­˜åœ¨åˆ™æ ¹æ®å…¥å‚ç”Ÿæˆæ–°çš„ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹å¹¶æ’å…¥é“¾è¡¨è¡¨å¤´ã€‚</li>
</ul>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)setObject:(<span class="type">id</span>)object forKey:(<span class="type">id</span>)key withCost:(<span class="built_in">NSUInteger</span>)cost &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å…¥å‚ï¼Œçœç•¥</span></span><br><span class="line">    ...</span><br><span class="line">    pthread_mutex_lock(&amp;_lock);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å…¥å‚ key å¯¹åº”çš„ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    _YYLinkedMapNode *node = <span class="built_in">CFDictionaryGetValue</span>(_lru-&gt;_dic, (__bridge <span class="keyword">const</span> <span class="type">void</span> *)(key));</span><br><span class="line">    <span class="built_in">NSTimeInterval</span> now = <span class="built_in">CACurrentMediaTime</span>();</span><br><span class="line">    <span class="keyword">if</span> (node) &#123;</span><br><span class="line">        <span class="comment">// å­˜åœ¨åˆ™æ›´æ–°ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹å¹¶å°†èŠ‚ç‚¹ç§»åŠ¨è‡³é“¾è¡¨å¤´ç»“ç‚¹</span></span><br><span class="line">        _lru-&gt;_totalCost -= node-&gt;_cost;</span><br><span class="line">        _lru-&gt;_totalCost += cost;</span><br><span class="line">        node-&gt;_cost = cost;</span><br><span class="line">        node-&gt;_time = now;</span><br><span class="line">        node-&gt;_value = object;</span><br><span class="line">        [_lru bringNodeToHead:node];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸å­˜åœ¨åˆ™æ ¹æ®å…¥å‚ç”Ÿæˆæ–°çš„ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹å¹¶æ’å…¥é“¾è¡¨è¡¨å¤´</span></span><br><span class="line">        node = [_YYLinkedMapNode new];</span><br><span class="line">        node-&gt;_cost = cost;</span><br><span class="line">        node-&gt;_time = now;</span><br><span class="line">        node-&gt;_key = key;</span><br><span class="line">        node-&gt;_value = object;</span><br><span class="line">        [_lru insertNodeAtHead:node];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ’å…¥ã€æ›´æ–°èŠ‚ç‚¹ä¹‹åæ˜¯å¦è¶…è¿‡äº†é™åˆ¶ costã€countï¼Œå¦‚æœè¶…è¿‡åˆ™ trimï¼Œçœç•¥</span></span><br><span class="line">    ...</span><br><span class="line">    pthread_mutex_unlock(&amp;_lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>åœ¨èµ„æºä¸è¶³æ—¶ï¼Œä»åŒçº¿é“¾è¡¨çš„å°¾èŠ‚ç‚¹ï¼ˆLRUï¼‰å¼€å§‹æ¸…ç†ç¼“å­˜ï¼Œé‡Šæ”¾èµ„æºã€‚</li>
</ul>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™é‡Œæ‹¿ count èµ„æºä¸¾ä¾‹ï¼Œcostã€age è‡ªå·±ä¸¾ä¸€åä¸‰</span></span><br><span class="line">- (<span class="type">void</span>)_trimToCount:(<span class="built_in">NSUInteger</span>)countLimit &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ countLimit ä¸º 0ï¼Œåˆ™å…¨éƒ¨æ¸…ç©ºç¼“å­˜ï¼Œçœç•¥</span></span><br><span class="line">    <span class="comment">// åˆ¤æ–­ _lru-&gt;_totalCount &lt;= countLimitï¼Œæ²¡æœ‰è¶…å‡ºèµ„æºé™åˆ¶åˆ™ä¸ä½œå¤„ç†ï¼Œçœç•¥</span></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableArray</span> *holder = [<span class="built_in">NSMutableArray</span> new];</span><br><span class="line">    <span class="keyword">while</span> (!finish) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pthread_mutex_trylock(&amp;_lock) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (_lru-&gt;_totalCount &gt; countLimit) &#123;</span><br><span class="line">                <span class="comment">// ä»åŒçº¿é“¾è¡¨çš„å°¾èŠ‚ç‚¹ï¼ˆLRUï¼‰å¼€å§‹æ¸…ç†ç¼“å­˜ï¼Œé‡Šæ”¾èµ„æº</span></span><br><span class="line">                _YYLinkedMapNode *node = [_lru removeTailNode];</span><br><span class="line">                <span class="keyword">if</span> (node) [holder addObject:node];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                finish = <span class="literal">YES</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            pthread_mutex_unlock(&amp;_lock);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨ usleep ä»¥å¾®ç§’ä¸ºå•ä½æŒ‚èµ·çº¿ç¨‹ï¼Œåœ¨çŸ­æ—¶é—´é—´éš”æŒ‚èµ·çº¿ç¨‹</span></span><br><span class="line">            <span class="comment">// å¯¹æ¯” sleep ç”¨ usleep èƒ½æ›´å¥½çš„åˆ©ç”¨ CPU æ—¶é—´</span></span><br><span class="line">            usleep(<span class="number">10</span> * <span class="number">1000</span>); <span class="comment">//10 ms</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦åœ¨ä¸»çº¿ç¨‹é‡Šæ”¾ï¼Œé‡‡å–é‡Šæ”¾ç¼“å­˜å¯¹è±¡æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> (holder.count) &#123;</span><br><span class="line">        <span class="built_in">dispatch_queue_t</span> queue = _lru-&gt;_releaseOnMainThread ? dispatch_get_main_queue() : YYMemoryCacheGetReleaseQueue();</span><br><span class="line">        <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">            <span class="comment">// å¼‚æ­¥é‡Šæ”¾ï¼Œæˆ‘ä»¬å•ç‹¬æ‹å‡ºæ¥è®²</span></span><br><span class="line">            [holder count]; <span class="comment">// release in queue</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å˜›~ æ˜¯ä¸æ˜¯æ„Ÿè§‰æ•²ç®€å•ï¼Ÿä¸Šé¢ä»£ç å»æ‰äº†å¯èƒ½ä¼šåˆ†æ•£å¤§å®¶æ³¨æ„åŠ›çš„ä»£ç ï¼Œæˆ‘ä»¬è¿™é‡Œä»…ä»…è®¨è®º LRU çš„å®ç°ï¼Œå…¶ä½™éƒ¨åˆ†çš„å…·ä½“å®ç°æºç ä¹Ÿéå¸¸ç®€å•ï¼Œæˆ‘è§‰å¾—æ²¡å¿…è¦è´´å‡ºæ¥å•ç‹¬è®²è§£ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±å» <a target="_blank" rel="noopener" href="https://github.com/ibireme/YYCache">YYCache</a> ä¸‹è½½æºç æŸ¥é˜…ã€‚</p>
<h4 id="å¼‚æ­¥é‡Šæ”¾æŠ€å·§"><a href="#å¼‚æ­¥é‡Šæ”¾æŠ€å·§" class="headerlink" title="å¼‚æ­¥é‡Šæ”¾æŠ€å·§"></a>å¼‚æ­¥é‡Šæ”¾æŠ€å·§</h4><p>å…³äºä¸Šé¢çš„å¼‚æ­¥é‡Šæ”¾ç¼“å­˜å¯¹è±¡çš„ä»£ç ï¼Œæˆ‘è§‰å¾—è¿˜æ˜¯æœ‰å¿…è¦å•ç‹¬æ‹å‡ºæ¥è®²ä¸€ä¸‹çš„ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> queue = _lru-&gt;_releaseOnMainThread ? dispatch_get_main_queue() : YYMemoryCacheGetReleaseQueue();</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">    <span class="comment">// å¼‚æ­¥é‡Šæ”¾ï¼Œæˆ‘ä»¬å•ç‹¬æ‹å‡ºæ¥è®²</span></span><br><span class="line">    [holder count]; <span class="comment">// release in queue</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæŠ€å·§ ibireme åœ¨ä»–çš„å¦ä¸€ç¯‡æ–‡ç«  <a target="_blank" rel="noopener" href="https://blog.ibireme.com/2015/11/12/smooth_user_interfaces_for_ios/">iOS ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§</a> ä¸­æœ‰æåŠï¼š</p>
<blockquote>
<p>Note: å¯¹è±¡çš„é”€æ¯è™½ç„¶æ¶ˆè€—èµ„æºä¸å¤šï¼Œä½†ç´¯ç§¯èµ·æ¥ä¹Ÿæ˜¯ä¸å®¹å¿½è§†çš„ã€‚é€šå¸¸å½“å®¹å™¨ç±»æŒæœ‰å¤§é‡å¯¹è±¡æ—¶ï¼Œå…¶é”€æ¯æ—¶çš„èµ„æºæ¶ˆè€—å°±éå¸¸æ˜æ˜¾ã€‚åŒæ ·çš„ï¼Œå¦‚æœå¯¹è±¡å¯ä»¥æ”¾åˆ°åå°çº¿ç¨‹å»é‡Šæ”¾ï¼Œé‚£å°±æŒªåˆ°åå°çº¿ç¨‹å»ã€‚è¿™é‡Œæœ‰ä¸ªå° Tipï¼šæŠŠå¯¹è±¡æ•è·åˆ° block ä¸­ï¼Œç„¶åæ‰”åˆ°åå°é˜Ÿåˆ—å»éšä¾¿å‘é€ä¸ªæ¶ˆæ¯ä»¥é¿å…ç¼–è¯‘å™¨è­¦å‘Šï¼Œå°±å¯ä»¥è®©å¯¹è±¡åœ¨åå°çº¿ç¨‹é”€æ¯äº†ã€‚</p>
</blockquote>
<p>è€Œä¸Šé¢ä»£ç ä¸­çš„ YYMemoryCacheGetReleaseQueue è¿™ä¸ªé˜Ÿåˆ—æºç ä¸ºï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é™æ€å†…è” dispatch_queue_t</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="built_in">dispatch_queue_t</span> YYMemoryCacheGetReleaseQueue() &#123;</span><br><span class="line">    <span class="keyword">return</span> dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_LOW, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨æºç ä¸­å¯ä»¥çœ‹åˆ° YYMemoryCacheGetReleaseQueue æ˜¯ä¸€ä¸ªä½ä¼˜å…ˆçº§ <code>DISPATCH_QUEUE_PRIORITY_LOW</code> é˜Ÿåˆ—ï¼ŒçŒœæµ‹è¿™æ ·è®¾è®¡çš„åŸå› æ˜¯å¯ä»¥è®© iOS åœ¨ç³»ç»Ÿç›¸å¯¹ç©ºé—²æ—¶å†æ¥å¼‚æ­¥é‡Šæ”¾ç¼“å­˜å¯¹è±¡ã€‚</p>
<h2 id="YYDiskCache-ç»†èŠ‚å‰–æ"><a href="#YYDiskCache-ç»†èŠ‚å‰–æ" class="headerlink" title="YYDiskCache ç»†èŠ‚å‰–æ"></a>YYDiskCache ç»†èŠ‚å‰–æ</h2><img src="/yycache/yydiskcache.jpg" class="">
<p>YYDiskCache æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ç£ç›˜ç¼“å­˜ï¼Œç”¨äºå­˜å‚¨ç”± SQLite å’Œæ–‡ä»¶ç³»ç»Ÿæ”¯æŒçš„é”®å€¼å¯¹ï¼ˆç±»ä¼¼äº NSURLCache çš„ç£ç›˜ç¼“å­˜ï¼‰ã€‚</p>
<p>YYDiskCache å…·æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š</p>
<ul>
<li>å®ƒä½¿ç”¨ LRU(least-recently-used) æ¥åˆ é™¤å¯¹è±¡ã€‚</li>
<li>æ”¯æŒæŒ‰ costï¼Œcount å’Œ age è¿›è¡Œæ§åˆ¶ã€‚</li>
<li>å®ƒå¯ä»¥è¢«é…ç½®ä¸ºå½“æ²¡æœ‰å¯ç”¨çš„ç£ç›˜ç©ºé—´æ—¶è‡ªåŠ¨é©±é€ç¼“å­˜å¯¹è±¡ã€‚</li>
<li>å®ƒå¯ä»¥è‡ªåŠ¨æŠ‰æ‹©æ¯ä¸ªç¼“å­˜å¯¹è±¡çš„å­˜å‚¨ç±»å‹ï¼ˆsqlite/fileï¼‰ä»¥ä¾¿æä¾›æ›´å¥½çš„æ€§èƒ½è¡¨ç°ã€‚</li>
</ul>
<blockquote>
<p>Note: æ‚¨å¯ä»¥ç¼–è¯‘æœ€æ–°ç‰ˆæœ¬çš„ sqlite å¹¶å¿½ç•¥ iOS ç³»ç»Ÿä¸­çš„ libsqlite3.dylib æ¥è·å¾— 2xã€œ4x çš„é€Ÿåº¦æå‡ã€‚</p>
</blockquote>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYDiskCache</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - Attribute</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name; <span class="comment">// ç¼“å­˜åç§°ï¼Œé»˜è®¤ä¸º nil</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">NSString</span> *path; <span class="comment">// ç¼“å­˜è·¯å¾„</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> inlineThreshold; <span class="comment">// é˜ˆå€¼ï¼Œå¤§äºé˜ˆå€¼åˆ™å­˜å‚¨ç±»å‹ä¸º fileï¼›å¦åˆ™å­˜å‚¨ç±»å‹ä¸º sqlite</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">copy</span>) <span class="built_in">NSData</span> *(^customArchiveBlock)(<span class="type">id</span> object); <span class="comment">// ç”¨æ¥æ›¿æ¢ NSKeyedArchiverï¼Œä½ å¯ä»¥ä½¿ç”¨è¯¥ä»£ç å—ä»¥æ”¯æŒæ²¡æœ‰ conform `NSCoding` åè®®çš„å¯¹è±¡</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">copy</span>) <span class="type">id</span> (^customUnarchiveBlock)(<span class="built_in">NSData</span> *data); <span class="comment">// ç”¨æ¥æ›¿æ¢ NSKeyedUnarchiverï¼Œä½ å¯ä»¥ä½¿ç”¨è¯¥ä»£ç å—ä»¥æ”¯æŒæ²¡æœ‰ conform `NSCoding` åè®®çš„å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *(^customFileNameBlock)(<span class="built_in">NSString</span> *key); <span class="comment">// å½“ä¸€ä¸ªå¯¹è±¡å°†ä»¥ file çš„å½¢å¼ä¿å­˜æ—¶ï¼Œè¯¥ä»£ç å—ç”¨æ¥ç”ŸæˆæŒ‡å®šæ–‡ä»¶åã€‚å¦‚æœä¸º nilï¼Œåˆ™é»˜è®¤ä½¿ç”¨ md5(key) ä½œä¸ºæ–‡ä»¶å</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - Limit</span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">NSUInteger</span> countLimit; <span class="comment">// ç¼“å­˜å¯¹è±¡æ•°é‡é™åˆ¶ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œè¶…è¿‡é™åˆ¶åˆ™ä¼šåœ¨åå°é€å‡ºä¸€äº›å¯¹è±¡ä»¥æ»¡è¶³é™åˆ¶</span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">NSUInteger</span> costLimit; <span class="comment">// ç¼“å­˜å¼€é”€æ•°é‡é™åˆ¶ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œè¶…è¿‡é™åˆ¶åˆ™ä¼šåœ¨åå°é€å‡ºä¸€äº›å¯¹è±¡ä»¥æ»¡è¶³é™åˆ¶</span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">NSTimeInterval</span> ageLimit; <span class="comment">// ç¼“å­˜æ—¶é—´é™åˆ¶ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œè¶…è¿‡é™åˆ¶åˆ™ä¼šåœ¨åå°é€å‡ºä¸€äº›å¯¹è±¡ä»¥æ»¡è¶³é™åˆ¶</span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">NSUInteger</span> freeDiskSpaceLimit; <span class="comment">// ç¼“å­˜åº”è¯¥ä¿ç•™çš„æœ€å°å¯ç”¨ç£ç›˜ç©ºé—´ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œè¶…è¿‡é™åˆ¶åˆ™ä¼šåœ¨åå°é€å‡ºä¸€äº›å¯¹è±¡ä»¥æ»¡è¶³é™åˆ¶</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">NSTimeInterval</span> autoTrimInterval; <span class="comment">// ç¼“å­˜è‡ªåŠ¨æ¸…ç†æ—¶é—´é—´éš”ï¼Œé»˜è®¤ 60s</span></span><br><span class="line"><span class="keyword">@property</span> <span class="type">BOOL</span> errorLogsEnabled; <span class="comment">// æ˜¯å¦å¼€å¯é”™è¯¯æ—¥å¿—</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - Initializer</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path</span><br><span class="line">                      inlineThreshold:(<span class="built_in">NSUInteger</span>)threshold <span class="built_in">NS_DESIGNATED_INITIALIZER</span>;</span><br><span class="line"></span><br><span class="line">- (<span class="type">BOOL</span>)containsObjectForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="type">id</span>&lt;<span class="built_in">NSCoding</span>&gt;)objectForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)setObject:(<span class="keyword">nullable</span> <span class="type">id</span>&lt;<span class="built_in">NSCoding</span>&gt;)object forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)removeObjectForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="type">void</span>)removeAllObjects;</span><br><span class="line">                                 </span><br><span class="line">- (<span class="built_in">NSInteger</span>)totalCount;</span><br><span class="line">- (<span class="built_in">NSInteger</span>)totalCost;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - Trim</span></span><br><span class="line">- (<span class="type">void</span>)trimToCount:(<span class="built_in">NSUInteger</span>)count;</span><br><span class="line">- (<span class="type">void</span>)trimToCost:(<span class="built_in">NSUInteger</span>)cost;</span><br><span class="line">- (<span class="type">void</span>)trimToAge:(<span class="built_in">NSTimeInterval</span>)age;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - Extended Data</span></span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)getExtendedDataFromObject:(<span class="type">id</span>)object;</span><br><span class="line">+ (<span class="type">void</span>)setExtendedData:(<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)extendedData toObject:(<span class="type">id</span>)object;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>YYDiskCache ç»“æ„ä¸ YYMemoryCache ç±»ä¼¼ï¼Œç”±äºå¾ˆå¤šæ¥å£éƒ½æ˜¯åŸºäºåŸºæœ¬çš„æ¥å£åšäº†æ‰©å±•æ‰€å¾—ï¼Œè¿™é‡Œè´´çš„ä»£ç çœç•¥äº†ä¸€äº›æ¥å£ã€‚ä»£ç è¿˜æ˜¯ä¸€å¦‚æ—¢å¾€çš„å¹²å‡€ç®€æ´ï¼Œç›¸ä¿¡å„ä½éƒ½èƒ½çœ‹æ‡‚ã€‚</p>
<p>YYDiskCache æ˜¯åŸºäº sqlite å’Œ file æ¥åšçš„ç£ç›˜ç¼“å­˜ï¼Œæˆ‘ä»¬çš„ç¼“å­˜å¯¹è±¡å¯ä»¥è‡ªç”±çš„é€‰æ‹©å­˜å‚¨ç±»å‹ï¼Œä¸‹é¢ç®€å•å¯¹æ¯”ä¸€ä¸‹ï¼š</p>
<ul>
<li>sqlite: å¯¹äºå°æ•°æ®ï¼ˆä¾‹å¦‚ NSNumberï¼‰çš„å­˜å–æ•ˆç‡æ˜æ˜¾é«˜äº fileã€‚</li>
<li>file: å¯¹äºè¾ƒå¤§æ•°æ®ï¼ˆä¾‹å¦‚é«˜è´¨é‡å›¾ç‰‡ï¼‰çš„å­˜å–æ•ˆç‡ä¼˜äº sqliteã€‚</li>
</ul>
<p>æ‰€ä»¥ YYDiskCache ä½¿ç”¨ä¸¤è€…é…åˆï¼Œçµæ´»çš„å­˜å‚¨ä»¥æé«˜æ€§èƒ½ã€‚</p>
<h3 id="NSMapTable"><a href="#NSMapTable" class="headerlink" title="NSMapTable"></a>NSMapTable</h3><p>NSMapTable æ˜¯ç±»ä¼¼äºå­—å…¸çš„é›†åˆï¼Œä½†å…·æœ‰æ›´å¹¿æ³›çš„å¯ç”¨å†…å­˜è¯­ä¹‰ã€‚NSMapTable æ˜¯ iOS6 ä¹‹åå¼•å…¥çš„ç±»ï¼Œå®ƒåŸºäº NSDictionary å»ºæ¨¡ï¼Œä½†æ˜¯å…·æœ‰ä»¥ä¸‹å·®å¼‚ï¼š</p>
<ul>
<li>é”®/å€¼å¯ä»¥é€‰æ‹© â€œweaklyâ€ æŒæœ‰ï¼Œä»¥ä¾¿äºåœ¨å›æ”¶å…¶ä¸­ä¸€ä¸ªå¯¹è±¡æ—¶åˆ é™¤å¯¹åº”æ¡ç›®ã€‚</li>
<li>å®ƒå¯ä»¥åŒ…å«ä»»æ„æŒ‡é’ˆï¼ˆå…¶å†…å®¹ä¸è¢«çº¦æŸä¸ºå¯¹è±¡ï¼‰ã€‚</li>
<li>æ‚¨å¯ä»¥å°† NSMapTable å®ä¾‹é…ç½®ä¸ºå¯¹ä»»æ„æŒ‡é’ˆè¿›è¡Œæ“ä½œï¼Œè€Œä¸ä»…ä»…æ˜¯å¯¹è±¡ã€‚</li>
</ul>
<blockquote>
<p>Note: é…ç½®æ˜ å°„è¡¨æ—¶ï¼Œè¯·æ³¨æ„ï¼Œåªæœ‰ NSMapTableOptions ä¸­åˆ—å‡ºçš„é€‰é¡¹æ‰èƒ½ä¿è¯å…¶ä½™çš„ API èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼ŒåŒ…æ‹¬å¤åˆ¶ï¼Œå½’æ¡£å’Œå¿«é€Ÿæšä¸¾ã€‚ è™½ç„¶å…¶ä»– NSPointerFunctions é€‰é¡¹ç”¨äºæŸäº›é…ç½®ï¼Œä¾‹å¦‚æŒæœ‰ä»»æ„æŒ‡é’ˆï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰é€‰é¡¹çš„ç»„åˆéƒ½æœ‰æ•ˆã€‚ä½¿ç”¨æŸäº›ç»„åˆï¼ŒNSMapTableOptions å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œï¼Œç”šè‡³å¯èƒ½æ— æ³•æ­£ç¡®åˆå§‹åŒ–ã€‚</p>
</blockquote>
<p>æ›´å¤šä¿¡æ¯è¯¦è§ <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/foundation/nsmaptable?language=objc">NSMapTable å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<p>éœ€è¦ç‰¹æ®Šè¯´æ˜çš„æ˜¯ï¼ŒYYDiskCache å†…éƒ¨æ˜¯åŸºäºä¸€ä¸ªå•ä¾‹ NSMapTable ç®¡ç†çš„ï¼Œè¿™ç‚¹æœ‰åˆ«äº YYMemoryCacheã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">NSMapTable</span> *_globalInstances; <span class="comment">// å¼•ç”¨ç®¡ç†æ‰€æœ‰çš„ YYDiskCache å®ä¾‹</span></span><br><span class="line"><span class="keyword">static</span> dispatch_semaphore_t _globalInstancesLock; <span class="comment">// YYDiskCache ä½¿ç”¨ dispatch_semaphore ä¿éšœ NSMapTable çº¿ç¨‹å®‰å…¨</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">void</span> _YYDiskCacheInitGlobal() &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        _globalInstancesLock = dispatch_semaphore_create(<span class="number">1</span>);</span><br><span class="line">        _globalInstances = [[<span class="built_in">NSMapTable</span> alloc] initWithKeyOptions:<span class="built_in">NSPointerFunctionsStrongMemory</span> valueOptions:<span class="built_in">NSPointerFunctionsWeakMemory</span> capacity:<span class="number">0</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> YYDiskCache *_YYDiskCacheGetGlobal(<span class="built_in">NSString</span> *path) &#123;</span><br><span class="line">    <span class="keyword">if</span> (path.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    _YYDiskCacheInitGlobal();</span><br><span class="line">    dispatch_semaphore_wait(_globalInstancesLock, DISPATCH_TIME_FOREVER);</span><br><span class="line">    <span class="type">id</span> cache = [_globalInstances objectForKey:path];</span><br><span class="line">    dispatch_semaphore_signal(_globalInstancesLock);</span><br><span class="line">    <span class="keyword">return</span> cache;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">void</span> _YYDiskCacheSetGlobal(YYDiskCache *cache) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cache.path.length == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    _YYDiskCacheInitGlobal();</span><br><span class="line">    dispatch_semaphore_wait(_globalInstancesLock, DISPATCH_TIME_FOREVER);</span><br><span class="line">    [_globalInstances setObject:cache forKey:cache.path];</span><br><span class="line">    dispatch_semaphore_signal(_globalInstancesLock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¯å½“ä¸€ä¸ª YYDiskCache è¢«åˆå§‹åŒ–æ—¶ï¼Œå…¶å®ä¼šå…ˆåˆ° NSMapTable ä¸­è·å–å¯¹åº” path çš„ YYDiskCache å®ä¾‹ï¼Œå¦‚æœè·å–ä¸åˆ°æ‰ä¼šå»çœŸæ­£çš„åˆå§‹åŒ–ä¸€ä¸ª YYDiskCache å®ä¾‹ï¼Œå¹¶ä¸”å°†å…¶å¼•ç”¨åœ¨ NSMapTable ä¸­ï¼Œè¿™æ ·åšä¹Ÿä¼šæå‡ä¸å°‘æ€§èƒ½ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path</span><br><span class="line">             inlineThreshold:(<span class="built_in">NSUInteger</span>)threshold &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦å¯ä»¥æˆåŠŸåˆå§‹åŒ–ï¼Œçœç•¥</span></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…ˆä» NSMapTable å•ä¾‹ä¸­æ ¹æ® path è·å– YYDiskCache å®ä¾‹ï¼Œå¦‚æœè·å–åˆ°å°±ç›´æ¥è¿”å›è¯¥å®ä¾‹</span></span><br><span class="line">    YYDiskCache *globalCache = _YYDiskCacheGetGlobal(path);</span><br><span class="line">    <span class="keyword">if</span> (globalCache) <span class="keyword">return</span> globalCache;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ²¡æœ‰è·å–åˆ°åˆ™åˆå§‹åŒ–ä¸€ä¸ª YYDiskCache å®ä¾‹</span></span><br><span class="line">    <span class="comment">// è¦æƒ³åˆå§‹åŒ–ä¸€ä¸ª YYDiskCache é¦–å…ˆè¦åˆå§‹åŒ–ä¸€ä¸ª YYKVStorage</span></span><br><span class="line">    YYKVStorage *kv = [[YYKVStorage alloc] initWithPath:path type:type];</span><br><span class="line">    <span class="keyword">if</span> (!kv) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ¹æ®åˆšæ‰å¾—åˆ°çš„ kv å’Œ path å…¥å‚åˆå§‹åŒ–ä¸€ä¸ª YYDiskCache å®ä¾‹ï¼Œä»£ç å¤ªé•¿çœç•¥</span></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¼€å¯é€’å½’æ¸…ç†ï¼Œä¼šæ ¹æ® _autoTrimInterval å¯¹ YYDiskCache trim</span></span><br><span class="line">    [<span class="keyword">self</span> _trimRecursively];</span><br><span class="line">    <span class="comment">// å‘ NSMapTable å•ä¾‹æ³¨å†Œæ–°ç”Ÿæˆçš„ YYDiskCache å®ä¾‹</span></span><br><span class="line">    _YYDiskCacheSetGlobal(<span class="keyword">self</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// App ç”Ÿå‘½å‘¨æœŸé€šçŸ¥ç›¸å…³ä»£ç ï¼Œçœç•¥</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘åœ¨ <a target="_blank" rel="noopener" href="https://blog.ibireme.com/2015/10/26/yycache/">YYCache è®¾è®¡æ€è·¯</a> ä¸­æ‰¾åˆ°äº†ä½œè€…ä½¿ç”¨ dispatch_semaphore ä½œä¸º YYDiskCache é”çš„åŸå› ï¼š</p>
<blockquote>
<p>dispatch_semaphore æ˜¯ä¿¡å·é‡ï¼Œä½†å½“ä¿¡å·æ€»é‡è®¾ä¸º 1 æ—¶ä¹Ÿå¯ä»¥å½“ä½œé”æ¥ã€‚åœ¨æ²¡æœ‰ç­‰å¾…æƒ…å†µå‡ºç°æ—¶ï¼Œå®ƒçš„æ€§èƒ½æ¯” pthread_mutex è¿˜è¦é«˜ï¼Œä½†ä¸€æ—¦æœ‰ç­‰å¾…æƒ…å†µå‡ºç°æ—¶ï¼Œæ€§èƒ½å°±ä¼šä¸‹é™è®¸å¤šã€‚ç›¸å¯¹äº OSSpinLock æ¥è¯´ï¼Œå®ƒçš„ä¼˜åŠ¿åœ¨äºç­‰å¾…æ—¶ä¸ä¼šæ¶ˆè€— CPU èµ„æºã€‚å¯¹ç£ç›˜ç¼“å­˜æ¥è¯´ï¼Œå®ƒæ¯”è¾ƒåˆé€‚ã€‚</p>
</blockquote>
<h3 id="YYKVStorageItem-ä¸-YYKVStorage"><a href="#YYKVStorageItem-ä¸-YYKVStorage" class="headerlink" title="YYKVStorageItem ä¸ YYKVStorage"></a>YYKVStorageItem ä¸ YYKVStorage</h3><p>åˆšæ‰åœ¨ YYDiskCache çš„åˆå§‹åŒ–æºç ä¸­ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°ä¸€ä¸ªç±» YYKVStorageã€‚ä¸ YYMemoryCache ç›¸å¯¹åº”çš„ï¼ŒYYDiskCache ä¹Ÿä¸ä¼šç›´æ¥æ“ä½œç¼“å­˜å¯¹è±¡ï¼ˆsqlite/fileï¼‰ï¼Œè€Œæ˜¯é€šè¿‡ YYKVStorage æ¥é—´æ¥çš„æ“ä½œç¼“å­˜å¯¹è±¡ã€‚</p>
<p>ä»è¿™ä¸€ç‚¹ä¸Šä¸éš¾å‘ç°ï¼ŒYYKVStorage ç­‰ä»·äº YYMemoryCache ä¸­çš„åŒå‘é“¾è¡¨ <code>_YYLinkedMap</code>ï¼Œè€Œå¯¹åº”äº <code>_YYLinkedMap</code> ä¸­çš„èŠ‚ç‚¹ <code>_YYLinkedMapNode</code>ï¼ŒYYKVStorage ä¸­ä¹Ÿæœ‰ä¸€ä¸ªç±» YYKVStorageItem å……å½“ç€ä¸ç¼“å­˜å¯¹è±¡ä¸€å¯¹ä¸€çš„è§’è‰²ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YYKVStorageItem æ˜¯ YYKVStorage ä¸­ç”¨æ¥å­˜å‚¨é”®å€¼å¯¹å’Œå…ƒæ•°æ®çš„ç±»</span></span><br><span class="line"><span class="comment">// é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªç±»</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYKVStorageItem</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *key;                <span class="comment">///&lt; key</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSData</span> *value;                <span class="comment">///&lt; value</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSString</span> *filename; <span class="comment">///&lt; filename (nil if inline)</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="type">int</span> size;                             <span class="comment">///&lt; value&#x27;s size in bytes</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="type">int</span> modTime;                          <span class="comment">///&lt; modification unix timestamp</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="type">int</span> accessTime;                       <span class="comment">///&lt; last access unix timestamp</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSData</span> *extendedData; <span class="comment">///&lt; extended data (nil if no extended data)</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> YYKVStorage æ˜¯åŸºäº sqlite å’Œæ–‡ä»¶ç³»ç»Ÿçš„é”®å€¼å­˜å‚¨ã€‚</span></span><br><span class="line"><span class="comment"> é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªç±»ã€‚</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> @warning </span></span><br><span class="line"><span class="comment">  è¿™ä¸ªç±»çš„å®ä¾‹æ˜¯ *é* çº¿ç¨‹å®‰å…¨çš„ï¼Œä½ éœ€è¦ç¡®ä¿</span></span><br><span class="line"><span class="comment">Â  åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è®¿é—®è¯¥å®ä¾‹ã€‚å¦‚æœä½ çœŸçš„</span></span><br><span class="line"><span class="comment">Â  éœ€è¦åœ¨å¤šçº¿ç¨‹ä¸­å¤„ç†å¤§é‡çš„æ•°æ®ï¼Œåº”è¯¥åˆ†å‰²æ•°æ®</span></span><br><span class="line"><span class="comment">Â  åˆ°å¤šä¸ª KVStorage å®ä¾‹ï¼ˆåˆ†ç‰‡ï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YYKVStorage</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - Attribute</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSString</span> *path;        <span class="comment">/// storage è·¯å¾„</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) YYKVStorageType type;  <span class="comment">/// storage ç±»å‹</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="type">BOOL</span> errorLogsEnabled;           <span class="comment">/// æ˜¯å¦å¼€å¯é”™è¯¯æ—¥å¿—</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - Initializer</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithPath:(<span class="built_in">NSString</span> *)path type:(YYKVStorageType)type <span class="built_in">NS_DESIGNATED_INITIALIZER</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - Save Items</span></span><br><span class="line">- (<span class="type">BOOL</span>)saveItem:(YYKVStorageItem *)item;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - Remove Items</span></span><br><span class="line">- (<span class="type">BOOL</span>)removeItemForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - Get Items</span></span><br><span class="line">- (<span class="keyword">nullable</span> YYKVStorageItem *)getItemForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - Get Storage Status</span></span><br><span class="line">- (<span class="type">BOOL</span>)itemExistsForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="type">int</span>)getItemsCount;</span><br><span class="line">- (<span class="type">int</span>)getItemsSize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>ä»£ç ç¾å“­äº†æœ‰æœ¨æœ‰ï¼ï¼Ÿè¿™ç§ä»£ç æ ¹æœ¬ä¸éœ€è¦ç¿»è¯‘ï¼Œæˆ‘è§‰å¾—ç›¸æ¯”äºé€è¡Œçš„ç¿»è¯‘ï¼Œç›´æ¥çœ‹ä»£ç æ›´èˆ’æœã€‚è¿™é‡Œæˆ‘ä»¬åªéœ€è¦çœ‹ä¸€ä¸‹ YYKVStorageType è¿™ä¸ªæšä¸¾ï¼Œä»–å†³å®šç€ YYKVStorage çš„å­˜å‚¨ç±»å‹ã€‚</p>
<h4 id="YYKVStorageType"><a href="#YYKVStorageType" class="headerlink" title="YYKVStorageType"></a>YYKVStorageType</h4><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> å­˜å‚¨ç±»å‹ï¼ŒæŒ‡ç¤ºâ€œYYKVStorageItem.valueâ€å­˜å‚¨åœ¨å“ªé‡Œã€‚</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> @discussion</span></span><br><span class="line"><span class="comment">  é€šå¸¸ï¼Œå°†æ•°æ®å†™å…¥ sqlite æ¯”å¤–éƒ¨æ–‡ä»¶æ›´å¿«ï¼Œä½†æ˜¯</span></span><br><span class="line"><span class="comment">Â  è¯»å–æ€§èƒ½å–å†³äºæ•°æ®å¤§å°ã€‚åœ¨æˆ‘çš„æµ‹è¯•ï¼ˆç¯å¢ƒ iPhone 6 64Gï¼‰ï¼Œ</span></span><br><span class="line"><span class="comment">Â  å½“æ•°æ®è¾ƒå¤§ï¼ˆè¶…è¿‡ 20KBï¼‰æ—¶ä»å¤–éƒ¨æ–‡ä»¶è¯»å–æ•°æ®æ¯” sqlite æ›´å¿«ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSUInteger</span>, YYKVStorageType) &#123;</span><br><span class="line">    YYKVStorageTypeFile = <span class="number">0</span>, <span class="comment">// value ä»¥æ–‡ä»¶çš„å½¢å¼å­˜å‚¨äºæ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">    YYKVStorageTypeSQLite = <span class="number">1</span>, <span class="comment">// value ä»¥äºŒè¿›åˆ¶å½¢å¼å­˜å‚¨äº sqlite</span></span><br><span class="line">    YYKVStorageTypeMixed = <span class="number">2</span>, <span class="comment">// value å°†æ ¹æ®ä½ çš„é€‰æ‹©åŸºäºä¸Šé¢ä¸¤ç§å½¢å¼æ··åˆå­˜å‚¨</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>åœ¨ YYKVStorageType çš„æ³¨é‡Šä¸­æ ‡è®°äº†ä½œè€…å†™ YYCache æ—¶åšå‡ºçš„æµ‹è¯•ç»“è®ºï¼Œå¤§å®¶ä¹Ÿå¯ä»¥åŸºäºè‡ªå·±çš„ç¯å¢ƒå»æµ‹è¯•éªŒè¯ä½œè€…çš„è¯´æ³•ï¼ˆè¿™ä¸€ç‚¹æ˜¯å¯ä»¥è®¨è®ºçš„ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„æµ‹è¯•æ¥è®¾ç½® YYDiskCache ä¸­çš„ inlineThreshold é˜ˆå€¼ï¼‰ã€‚</p>
<blockquote>
<p>å¦‚æœæƒ³è¦äº†è§£æ›´å¤šçš„ä¿¡æ¯å¯ä»¥ç‚¹å‡» <a target="_blank" rel="noopener" href="http://www.sqlite.org/intern-v-extern-blob.html">Internal Versus External BLOBs in SQLite</a> æŸ¥é˜… SQLite å®˜æ–¹æ–‡æ¡£ã€‚</p>
</blockquote>
<h4 id="YYKVStorage-æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚"><a href="#YYKVStorage-æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚" class="headerlink" title="YYKVStorage æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚"></a>YYKVStorage æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚</h4><p>ä¸Šæ–‡è¯´åˆ° YYKVStorage å¯ä»¥åŸºäº SQLite å’Œæ–‡ä»¶ç³»ç»Ÿåšç£ç›˜å­˜å‚¨ï¼Œè¿™é‡Œå†æä¸€äº›æˆ‘é˜…è¯»æºç å‘ç°åˆ°çš„æœ‰è¶£ç»†èŠ‚ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YYKVStorage</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="built_in">CFMutableDictionaryRef</span> _dbStmtCache; <span class="comment">// ç„¦ç‚¹é›†ä¸­åœ¨è¿™é‡Œ</span></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ° <code>CFMutableDictionaryRef _dbStmtCache;</code> æ˜¯ YYKVStorage ä¸­çš„ç§æœ‰æˆå‘˜ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯å˜å­—å…¸å……å½“ç€ sqlite3_stmt ç¼“å­˜çš„è§’è‰²ã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (sqlite3_stmt *)_dbPrepareStmt:(<span class="built_in">NSString</span> *)sql &#123;</span><br><span class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span> _dbCheck] || sql.length == <span class="number">0</span> || !_dbStmtCache) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// å…ˆå°è¯•ä» _dbStmtCache æ ¹æ®å…¥å‚ sql å–å‡ºå·²ç¼“å­˜ sqlite3_stmt</span></span><br><span class="line">    sqlite3_stmt *stmt = (sqlite3_stmt *)<span class="built_in">CFDictionaryGetValue</span>(_dbStmtCache, (__bridge <span class="keyword">const</span> <span class="type">void</span> *)(sql));</span><br><span class="line">    <span class="keyword">if</span> (!stmt) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰ç¼“å­˜å†ä»æ–°ç”Ÿæˆä¸€ä¸ª sqlite3_stmt</span></span><br><span class="line">        <span class="type">int</span> result = sqlite3_prepare_v2(_db, sql.UTF8String, <span class="number">-1</span>, &amp;stmt, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="comment">// ç”Ÿæˆç»“æœå¼‚å¸¸åˆ™æ ¹æ®é”™è¯¯æ—¥å¿—å¼€å¯æ ‡è¯†æ‰“å°æ—¥å¿—</span></span><br><span class="line">        <span class="keyword">if</span> (result != SQLITE_OK) &#123;</span><br><span class="line">            <span class="keyword">if</span> (_errorLogsEnabled) <span class="built_in">NSLog</span>(<span class="string">@&quot;%s line:%d sqlite stmt prepare error (%d): %s&quot;</span>, __FUNCTION__, __LINE__, result, sqlite3_errmsg(_db));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ç”ŸæˆæˆåŠŸåˆ™æ”¾å…¥ _dbStmtCache ç¼“å­˜</span></span><br><span class="line">        <span class="built_in">CFDictionarySetValue</span>(_dbStmtCache, (__bridge <span class="keyword">const</span> <span class="type">void</span> *)(sql), stmt);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sqlite3_reset(stmt);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> stmt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±å¯ä»¥çœå»ä¸€äº›é‡å¤ç”Ÿæˆ sqlite3_stmt çš„å¼€é”€ã€‚</p>
<blockquote>
<p>sqlite3_stmt: è¯¥å¯¹è±¡çš„å®ä¾‹è¡¨ç¤ºå·²ç»ç¼–è¯‘æˆäºŒè¿›åˆ¶å½¢å¼å¹¶å‡†å¤‡æ‰§è¡Œçš„å•ä¸ª SQL è¯­å¥ã€‚</p>
</blockquote>
<p>æ›´å¤šå…³äº SQLite çš„ä¿¡æ¯è¯·ç‚¹å‡» <a target="_blank" rel="noopener" href="http://www.sqlite.org/docs.html">SQLite å®˜æ–¹æ–‡æ¡£</a> æŸ¥é˜…ã€‚</p>
<h2 id="ä¼˜ç§€çš„ç¼“å­˜åº”è¯¥å…·å¤‡å“ªäº›ç‰¹è´¨"><a href="#ä¼˜ç§€çš„ç¼“å­˜åº”è¯¥å…·å¤‡å“ªäº›ç‰¹è´¨" class="headerlink" title="ä¼˜ç§€çš„ç¼“å­˜åº”è¯¥å…·å¤‡å“ªäº›ç‰¹è´¨"></a>ä¼˜ç§€çš„ç¼“å­˜åº”è¯¥å…·å¤‡å“ªäº›ç‰¹è´¨</h2><img src="/yycache/good_cache.jpg" class="">
<p>å˜›~ æˆ‘ä»¬å›åˆ°æ–‡ç« æœ€åˆæåˆ°çš„é—®é¢˜ï¼Œä¼˜ç§€çš„ç¼“å­˜åº”è¯¥å…·å¤‡å“ªäº›ç‰¹è´¨ï¼Ÿ</p>
<p>å¦‚æœè·Ÿç€æ–‡ç« ä¸€æ­¥æ­¥è¯»åˆ°è¿™é‡Œï¼Œç›¸ä¿¡å¾ˆå®¹æ˜“ä¸¾å‡ºä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li>å†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜</li>
<li>çº¿ç¨‹å®‰å…¨</li>
<li>ç¼“å­˜æ§åˆ¶</li>
<li>ç¼“å­˜æ›¿æ¢ç­–ç•¥</li>
<li>ç¼“å­˜å‘½ä¸­ç‡</li>
<li>æ€§èƒ½</li>
</ul>
<p>æˆ‘ä»¬ç®€å•çš„æ€»ç»“ä¸€ä¸‹ YYCache æºç ä¸­æ˜¯å¦‚ä½•ä½“ç°è¿™äº›ç‰¹è´¨çš„ã€‚</p>
<h3 id="å†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜"><a href="#å†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜" class="headerlink" title="å†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜"></a>å†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜</h3><p>YYCache æ˜¯ç”±å†…å­˜ç¼“å­˜ YYMemoryCache ä¸ç£ç›˜ç¼“å­˜ YYDiskCache ç›¸äº’é…åˆç»„æˆçš„ï¼Œå†…å­˜ç¼“å­˜æä¾›å®¹é‡å°ä½†é«˜é€Ÿçš„å­˜å–åŠŸèƒ½ï¼Œç£ç›˜ç¼“å­˜æä¾›å¤§å®¹é‡ä½†ä½é€Ÿçš„æŒä¹…åŒ–å­˜å‚¨ã€‚è¿™æ ·çš„è®¾è®¡æ”¯æŒç”¨æˆ·åœ¨ç¼“å­˜ä¸åŒå¯¹è±¡æ—¶éƒ½èƒ½å¤Ÿæœ‰å¾ˆå¥½çš„ä½“éªŒã€‚</p>
<p>åœ¨ YYCache ä¸­ä½¿ç”¨æ¥å£è®¿é—®ç¼“å­˜å¯¹è±¡æ—¶ï¼Œä¼šå…ˆå»å°è¯•ä»å†…å­˜ç¼“å­˜ YYMemoryCache ä¸­è®¿é—®ï¼Œå¦‚æœè®¿é—®ä¸åˆ°ï¼ˆæ²¡æœ‰ä½¿ç”¨è¯¥ key ç¼“å­˜è¿‡å¯¹è±¡æˆ–è€…è¯¥å¯¹è±¡å·²ç»ä»å®¹é‡æœ‰é™çš„ YYMemoryCache ä¸­æ·˜æ±°æ‰ï¼‰æ‰ä¼šå»ä» YYDiskCache è®¿é—®ï¼Œå¦‚æœè®¿é—®åˆ°ï¼ˆè¡¨ç¤ºä¹‹å‰ç¡®å®ä½¿ç”¨è¯¥ key ç¼“å­˜è¿‡å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å·²ç»ä»å®¹é‡æœ‰é™çš„ YYMemoryCache ä¸­æ·˜æ±°æ‰æˆç«‹ï¼‰ä¼šå…ˆåœ¨ YYMemoryCache ä¸­æ›´æ–°ä¸€æ¬¡è¯¥ç¼“å­˜å¯¹è±¡çš„è®¿é—®ä¿¡æ¯ä¹‹åæ‰è¿”å›ç»™æ¥å£ã€‚</p>
<h3 id="çº¿ç¨‹å®‰å…¨"><a href="#çº¿ç¨‹å®‰å…¨" class="headerlink" title="çº¿ç¨‹å®‰å…¨"></a>çº¿ç¨‹å®‰å…¨</h3><p>å¦‚æœè¯´ YYCache è¿™ä¸ªç±»æ˜¯ä¸€ä¸ªçº¯é€»è¾‘å±‚çš„ç¼“å­˜ç±»ï¼ˆæŒ‡ YYCache çš„æ¥å£å®ç°å…¨éƒ¨æ˜¯è°ƒç”¨å…¶ä»–ç±»å®Œæˆï¼‰ï¼Œé‚£ä¹ˆ YYMemoryCache ä¸ YYDiskCache è¿˜æ˜¯åšäº†ä¸€äº›äº‹æƒ…çš„ï¼ˆå¹¶æ²¡æœ‰ YYCache å½“ç”©æ‰‹æŒæŸœé‚£ä¹ˆè½»æ¾ï¼‰ï¼Œå…¶ä¸­æœ€æ˜¾è€Œæ˜“è§çš„å°±æ˜¯ YYMemoryCache ä¸ YYDiskCache ä¸º YYCache ä¿è¯äº†çº¿ç¨‹å®‰å…¨ã€‚</p>
<p>YYMemoryCache ä½¿ç”¨äº† <code>pthread_mutex</code> çº¿ç¨‹é”æ¥ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œè€Œ YYDiskCache åˆ™é€‰æ‹©äº†æ›´é€‚åˆå®ƒçš„ <code>dispatch_semaphore</code>ï¼Œä¸Šæ–‡å·²ç»ç»™å‡ºäº†ä½œè€…é€‰æ‹©è¿™äº›é”çš„åŸå› ã€‚</p>
<h3 id="ç¼“å­˜æ§åˆ¶"><a href="#ç¼“å­˜æ§åˆ¶" class="headerlink" title="ç¼“å­˜æ§åˆ¶"></a>ç¼“å­˜æ§åˆ¶</h3><p>YYCache æä¾›äº†ä¸‰ç§æ§åˆ¶ç»´åº¦ï¼Œåˆ†åˆ«æ˜¯ï¼šcostã€countã€ageã€‚è¿™å·²ç»æ»¡è¶³äº†ç»å¤§å¤šæ•°å¼€å‘è€…çš„éœ€æ±‚ï¼Œæˆ‘ä»¬åœ¨è‡ªå·±è®¾è®¡ç¼“å­˜æ—¶ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„ä½¿ç”¨ç¯å¢ƒæä¾›åˆé€‚çš„æ§åˆ¶æ–¹å¼ã€‚</p>
<h3 id="ç¼“å­˜æ›¿æ¢ç­–ç•¥-1"><a href="#ç¼“å­˜æ›¿æ¢ç­–ç•¥-1" class="headerlink" title="ç¼“å­˜æ›¿æ¢ç­–ç•¥"></a>ç¼“å­˜æ›¿æ¢ç­–ç•¥</h3><p>åœ¨ä¸Šæ–‡è§£æ YYCache æºç çš„æ—¶å€™ï¼Œä»‹ç»äº†ç¼“å­˜æ›¿æ¢ç­–ç•¥çš„æ¦‚å¿µå¹¶ä¸”åˆ—ä¸¾äº†å¾ˆå¤šç»å…¸çš„ç­–ç•¥ã€‚YYCache ä½¿ç”¨äº†åŒå‘é“¾è¡¨ï¼ˆ<code>_YYLinkedMapNode</code> ä¸ <code>_YYLinkedMap</code>ï¼‰å®ç°äº† LRU(least-recently-used) ç­–ç•¥ï¼Œæ—¨åœ¨æé«˜ YYCache çš„ç¼“å­˜å‘½ä¸­ç‡ã€‚</p>
<h3 id="ç¼“å­˜å‘½ä¸­ç‡-1"><a href="#ç¼“å­˜å‘½ä¸­ç‡-1" class="headerlink" title="ç¼“å­˜å‘½ä¸­ç‡"></a>ç¼“å­˜å‘½ä¸­ç‡</h3><p>è¿™ä¸€æ¦‚å¿µæ˜¯åœ¨ä¸Šæ–‡è§£æ <code>_YYLinkedMapNode</code> ä¸ <code>_YYLinkedMap</code> å°èŠ‚ä»‹ç»çš„ï¼Œæˆ‘ä»¬åœ¨è‡ªå·±è®¾è®¡ç¼“å­˜æ—¶ä¸ä¸€å®šéè¦ä½¿ç”¨ LRU ç­–ç•¥ï¼Œå¯ä»¥æ ¹æ®æˆ‘ä»¬çš„å®é™…ä½¿ç”¨ç¯å¢ƒé€‰æ‹©æœ€é€‚åˆæˆ‘ä»¬è‡ªå·±çš„ç¼“å­˜æ›¿æ¢ç­–ç•¥ã€‚</p>
<h3 id="æ€§èƒ½"><a href="#æ€§èƒ½" class="headerlink" title="æ€§èƒ½"></a>æ€§èƒ½</h3><p>å…¶å®æ€§èƒ½è¿™ä¸ªä¸œè¥¿æ˜¯éšè€Œä¸è§çš„ï¼Œåˆæ˜¯åˆ°å¤„å¯è§çš„ï¼ˆç¬‘ï¼‰ã€‚å®ƒä»æˆ‘ä»¬æœ€å¼€å§‹è®¾è®¡ä¸€ä¸ªç¼“å­˜æ¶æ„æ—¶å°±è¢«å¸¦å…¥ï¼Œä¸€ç›´åˆ°æˆ‘ä»¬å…·ä½“çš„å®ç°ç»†èŠ‚ä¸­æ…¢æ…¢æˆå½¢ï¼Œæœ€åæˆä¸ºäº†æˆ‘ä»¬è®¾è®¡å‡ºæ¥çš„ç¼“å­˜ä¼˜ç§€ä¸å¦çš„å†³å®šæ€§å› ç´ ã€‚</p>
<p>ä¸Šæ–‡ä¸­å‰–æäº†å¤ªå¤š YYCache ä¸­å¯¹äºæ€§èƒ½æå‡çš„å®ç°ç»†èŠ‚ï¼š</p>
<ul>
<li>å¼‚æ­¥é‡Šæ”¾ç¼“å­˜å¯¹è±¡</li>
<li>é”çš„é€‰æ‹©</li>
<li>ä½¿ç”¨ NSMapTable å•ä¾‹ç®¡ç†çš„ YYDiskCache</li>
<li>YYKVStorage ä¸­çš„ <code>_dbStmtCache</code></li>
<li>ç”šè‡³ä½¿ç”¨ CoreFoundation æ¥æ¢å–å¾®ä¹å…¶å¾®çš„æ€§èƒ½æå‡</li>
</ul>
<p>çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯æç„¶å¤§æ‚Ÿï¼Œæ€§èƒ½æ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿå°±æ˜¯è¿™æ ·å¯¹äºæ¯ä¸€ä¸ªç»†èŠ‚çš„æè‡´è¿½æ±‚ä¸€ç‚¹ä¸€æ»´ç§¯å°‘æˆå¤šæŠ å‡ºæ¥çš„ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul>
<li>æ–‡ç« ç³»ç»Ÿçš„è§£è¯»äº† YYCache æºç ï¼Œç›¸ä¿¡å¯ä»¥è®©å„ä½è¯»è€…å¯¹ YYCache çš„æ•´ä½“æ¶æ„æœ‰ä¸€ä¸ªæ¸…æ™°çš„è®¤è¯†ã€‚</li>
<li>æ–‡ç« ç»“åˆä½œè€… <a target="_blank" rel="noopener" href="https://blog.ibireme.com/2015/10/26/yycache/">YYCache è®¾è®¡æ€è·¯</a> ä¸­çš„å†…å®¹å¯¹ YYCache å…·ä½“åŠŸèƒ½ç‚¹å®ç°æºç åšäº†æ·±å…¥å‰–æï¼Œå†ç”¨æˆ‘è‡ªå·±çš„ç†è§£è¡¨è¿°å‡ºæ¥ï¼Œå¸Œæœ›å¯ä»¥å¯¹è¯»è€…ç†è§£ YYCache ä¸­å…·ä½“åŠŸèƒ½çš„å®ç°æä¾›å¸®åŠ©ã€‚</li>
<li>æ ¹æ®æˆ‘è‡ªå·±çš„æºç ç†è§£ï¼ŒæŠŠæˆ‘è®¤ä¸ºåšçš„ä¸é”™çš„æå‡æ€§èƒ½çš„æºç ç»†èŠ‚å•ç‹¬æ‹å‡ºæ¥åšå‡ºè¯¦ç»†åˆ†æã€‚</li>
<li>æ€»ç»“å½’çº³å‡ºâ€œä¸€ä¸ªä¼˜ç§€ç¼“å­˜éœ€è¦å…·å¤‡å“ªäº›ç‰¹è´¨ï¼Ÿâ€è¿™ä¸€é—®é¢˜çš„ç­”æ¡ˆï¼Œå¸Œæœ›å¤§å®¶åœ¨é¢è¯•ä¸­å¦‚æœè¢«é—®åŠâ€œå¦‚ä½•è®¾è®¡ä¸€ä¸ªç¼“å­˜â€è¿™ç±»é—®é¢˜æ—¶å¯ä»¥æ¸¸åˆƒæœ‰ä½™ã€‚é¢ï¼Œè‡³å°‘å¯ä»¥ä¸ºå¤§å®¶æä¾›ä¸€äº›å›ç­”æ€è·¯ï¼ŒæŠ›ç –å¼•ç‰ï¼ˆç¬‘ï¼‰ã€‚</li>
</ul>
<p>æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜ <a href="https://lision.me/">https://lision.me/</a>ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ <a href="https://lision.me/">ä¸ªäººåšå®¢</a> ä¸­æ›´æ–°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš <a target="_blank" rel="noopener" href="https://weibo.com/lisioncode">@Lision</a> è”ç³»æˆ‘~</p>
<p>å¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~</p>


    
    
    
	  <div class="tags">
      <a class="tag-none-link" href="/tags/yycache/" rel="tag">yycache</a><a class="tag-none-link" href="/tags/yykit/" rel="tag">yykit</a>
	  </div>
    

  </section>
</article>
  
    <article class="post ">

  
  <h2 class="title">
    <a href="/ios_native_js/">
      iOS ä¸ JS äº¤äº’å¼€å‘çŸ¥è¯†æ€»ç»“
    </a>
  </h2>
  
  <time>
    10æœˆ 23, 2017
  </time>
  <section class="content">
	  <img src="/ios_native_js/hybrid.jpg" class="">
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Web é¡µé¢ä¸­çš„ JS ä¸ iOS Native å¦‚ä½•äº¤äº’æ˜¯æ¯ä¸ª iOS çŒ¿å¿…é¡»æŒæ¡çš„æŠ€èƒ½ã€‚è€Œè¯´åˆ° Native ä¸ JS äº¤äº’ï¼Œå°±ä¸å¾—ä¸æä¸€å˜´ Hybridã€‚</p>
<p>Hybrid çš„ç¿»è¯‘ç»“æœå¹¶ä¸æ˜¯å¾ˆæ–‡æ˜ï¼ˆæ“¦æ±—ï¼Œä¸çŸ¥é“ä¸ºå•¥å¾ˆå¤šç¿»è¯‘è½¯ä»¶ä¼šè¯‘ä¸ºâ€œæ‚ç§â€ï¼Œä½†æˆ‘æ›´å–œæ¬¢å°†å®ƒç¿»è¯‘ä¸ºâ€œæ··åˆã€æ··è¡€â€ï¼‰ï¼ŒHybrid Mobile App æˆ‘å¯¹å®ƒçš„ç†è§£ä¸ºé€šè¿‡ Web ç½‘ç»œæŠ€æœ¯ï¼ˆå¦‚ HTMLï¼ŒCSS å’Œ JavaScriptï¼‰ä¸ Native ç›¸ç»“åˆçš„æ··åˆç§»åŠ¨åº”ç”¨ç¨‹åºã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Hybrid å¯¹æ¯” Native æœ‰å“ªäº›ä¼˜åŠ£ï¼š</p>
<img src="/ios_native_js/hybrid_vs_native.jpg" class="">
<p>å› ä¸º Hybrid çš„çµæ´»æ€§ï¼ˆæ›´æ”¹ Web é¡µé¢ä¸å¿…é‡æ–°å‘ç‰ˆï¼‰ä»¥åŠé€šç”¨æ€§ï¼ˆä¸€ä»½ H5 ç©éæ‰€æœ‰å¹³å°ï¼‰å†åŠ ä¸Šé—¨æ§›ä½ï¼ˆå‰ç«¯çŒ¿å¯ä»¥æ— ç—›ä¸Šæ‰‹å¼€æ’¸ï¼‰çš„ä¼˜åŠ¿ï¼Œæ‰€ä»¥åœ¨éæ ¸å¿ƒåŠŸèƒ½æ¨¡å—ä½¿ç”¨ Web é€šè¿‡ Hybrid çš„æ–¹å¼æ¥å®ç°å¯èƒ½ä»å„æ–¹é¢éƒ½ä¼šä¼˜äº Nativeã€‚è€Œ Native åˆ™å¯ä»¥åœ¨æ ¸å¿ƒåŠŸèƒ½å’Œè®¾å¤‡ç¡¬ä»¶çš„è°ƒç”¨ä¸Šä¸º JS æä¾›å¼ºæœ‰åŠ›çš„æ”¯æŒã€‚</p>
<h2 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h2><ul>
<li>Hybrid çš„å‘å±•ç®€å²</li>
<li>JavaScriptCore ç®€ä»‹</li>
<li>iOS Native ä¸ JS äº¤äº’çš„æ–¹æ³•</li>
<li>WKWebView ä¸ JS äº¤äº’çš„ç‰¹æœ‰æ–¹æ³•</li>
<li>JS é€šè¿‡ Native è°ƒç”¨ iOS è®¾å¤‡æ‘„åƒå¤´çš„ Demo</li>
<li>æ€»ç»“</li>
</ul>
<h2 id="Hybrid-çš„å‘å±•ç®€å²"><a href="#Hybrid-çš„å‘å±•ç®€å²" class="headerlink" title="Hybrid çš„å‘å±•ç®€å²"></a>Hybrid çš„å‘å±•ç®€å²</h2><p>ä¸‹é¢ç®€è¿°ä¸€ä¸‹ Hybrid çš„å‘å±•å²ï¼š</p>
<h3 id="1-H5-å‘å¸ƒ"><a href="#1-H5-å‘å¸ƒ" class="headerlink" title="1.H5 å‘å¸ƒ"></a>1.H5 å‘å¸ƒ</h3><img src="/ios_native_js/html5.png" class="">
<p>Html5 æ˜¯åœ¨ 2014 å¹´ 9 æœˆä»½æ­£å¼å‘å¸ƒçš„ï¼Œè¿™ä¸€æ¬¡çš„å‘å¸ƒåšäº†ä¸€ä¸ªæœ€å¤§çš„æ”¹å˜å°±æ˜¯â€œä»ä»¥å‰çš„ XML å­é›†å‡çº§æˆä¸ºä¸€ä¸ªç‹¬ç«‹é›†åˆâ€ã€‚</p>
<h3 id="2-H5-æ¸—å…¥-Mobile-App-å¼€å‘"><a href="#2-H5-æ¸—å…¥-Mobile-App-å¼€å‘" class="headerlink" title="2.H5 æ¸—å…¥ Mobile App å¼€å‘"></a>2.H5 æ¸—å…¥ Mobile App å¼€å‘</h3><p>Native APP å¼€å‘ä¸­æœ‰ä¸€ä¸ª webview çš„ç»„ä»¶ï¼ˆAndroid ä¸­æ˜¯ webviewï¼ŒiOS æœ‰ UIWebviewå’Œ WKWebviewï¼‰ï¼Œè¿™ä¸ªç»„ä»¶å¯ä»¥åŠ è½½ Html æ–‡ä»¶ã€‚</p>
<p>åœ¨ H5 å¤§è¡Œå…¶é“ä¹‹å‰ï¼Œwebview åŠ è½½çš„ web é¡µé¢å¾ˆå•è°ƒï¼ˆå› ä¸ºåªèƒ½åŠ è½½ä¸€äº›é™æ€èµ„æºï¼‰ï¼Œè‡ªä» H5 ç«äº†ä¹‹åï¼Œå‰ç«¯çŒ¿ä»¬å¼€å‘çš„ H5 é¡µé¢åœ¨ webview ä¸­çš„è¡¨ç°ä¸ä¿—ä½¿å¾— H5 å¼€å‘æ…¢æ…¢æ¸—é€åˆ°äº† Mobile App å¼€å‘ä¸­æ¥ã€‚</p>
<h3 id="3-Hybrid-ç°çŠ¶"><a href="#3-Hybrid-ç°çŠ¶" class="headerlink" title="3.Hybrid ç°çŠ¶"></a>3.Hybrid ç°çŠ¶</h3><p>è™½ç„¶ç›®å‰å·²ç»å‡ºç°äº† RN å’Œ Weex è¿™äº›ä½¿ç”¨ JS å†™ Native App çš„æŠ€æœ¯ï¼Œä½†æ˜¯ Hybrid ä»ç„¶æ²¡æœ‰è¢«æ·˜æ±°ï¼Œå¸‚é¢ä¸Šå¤§å¤šæ•°åº”ç”¨éƒ½ä¸åŒç¨‹åº¦çš„å¼•å…¥äº† Web é¡µé¢ã€‚</p>
<h2 id="JavaScriptCore"><a href="#JavaScriptCore" class="headerlink" title="JavaScriptCore"></a>JavaScriptCore</h2><p>JavaScriptCore è¿™ä¸ªåº“æ˜¯ Apple åœ¨ iOS 7 ä¹‹ååŠ å…¥åˆ°æ ‡å‡†åº“çš„ï¼Œå®ƒå¯¹ iOS Native ä¸ JS åšäº¤äº’è°ƒç”¨äº§ç”Ÿäº†åˆ’æ—¶ä»£çš„å½±å“ã€‚</p>
<p>JavaScriptCore å¤§ä½“æ˜¯ç”± 4 ä¸ªç±»ä»¥åŠ 1 ä¸ªåè®®ç»„æˆçš„ï¼š</p>
<img src="/ios_native_js/javascriptcore_framework.jpg" class="">
<ul>
<li>JSContext æ˜¯ JS æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸º JS è¿è¡Œçš„ç¯å¢ƒã€‚</li>
<li>JSValue æ˜¯å¯¹ JavaScript å€¼çš„å¼•ç”¨ï¼Œä»»ä½• JS ä¸­çš„å€¼éƒ½å¯ä»¥è¢«åŒ…è£…ä¸ºä¸€ä¸ª JSValueã€‚</li>
<li>JSManagedValue æ˜¯å¯¹ JSValue çš„åŒ…è£…ï¼ŒåŠ å…¥äº†â€œconditional retainâ€ã€‚</li>
<li>JSVirtualMachine è¡¨ç¤º JavaScript æ‰§è¡Œçš„ç‹¬ç«‹ç¯å¢ƒã€‚</li>
</ul>
<p>è¿˜æœ‰ JSExport åè®®ï¼š</p>
<blockquote>
<p>å®ç°å°† Objective-C ç±»åŠå…¶å®ä¾‹æ–¹æ³•ï¼Œç±»æ–¹æ³•å’Œå±æ€§å¯¼å‡ºä¸º JavaScript ä»£ç çš„åè®®ã€‚</p>
</blockquote>
<p>è¿™é‡Œçš„ JSContextï¼ŒJSValueï¼ŒJSManagedValue ç›¸å¯¹æ¯”è¾ƒå¥½ç†è§£ï¼Œä¸‹é¢æˆ‘ä»¬æŠŠ JSVirtualMachine å•æ‹å‡ºæ¥è¯´æ˜ä¸€ä¸‹ï¼š</p>
<h3 id="JSVirtualMachine-çš„ç”¨æ³•å’Œå…¶ä¸-JSContext-çš„å…³ç³»"><a href="#JSVirtualMachine-çš„ç”¨æ³•å’Œå…¶ä¸-JSContext-çš„å…³ç³»" class="headerlink" title="JSVirtualMachine çš„ç”¨æ³•å’Œå…¶ä¸ JSContext çš„å…³ç³»"></a>JSVirtualMachine çš„ç”¨æ³•å’Œå…¶ä¸ JSContext çš„å…³ç³»</h3><img src="/ios_native_js/jsvirtualmachine.jpg" class="">
<p>å®˜æ–¹æ–‡æ¡£çš„ä»‹ç»ï¼š</p>
<blockquote>
<p>JSVirtualMachine å®ä¾‹è¡¨ç¤ºç”¨äº JavaScript æ‰§è¡Œçš„ç‹¬ç«‹ç¯å¢ƒã€‚ æ‚¨ä½¿ç”¨æ­¤ç±»æœ‰ä¸¤ä¸ªä¸»è¦ç›®çš„ï¼šæ”¯æŒå¹¶å‘ JavaScript æ‰§è¡Œï¼Œå¹¶ç®¡ç† JavaScript å’Œ Objective-C æˆ– Swift ä¹‹é—´æ¡¥æ¥çš„å¯¹è±¡çš„å†…å­˜ã€‚</p>
</blockquote>
<p>å…³äº JSVirtualMachine çš„ä½¿ç”¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¸ç”¨æ‰‹åŠ¨å»åˆ›å»º JSVirtualMachineã€‚å› ä¸ºå½“æˆ‘ä»¬è·å– JSContext æ—¶ï¼Œè·å–åˆ°çš„ JSContext ä»å±äºä¸€ä¸ª JSVirtualMachineã€‚</p>
<p>æ¯ä¸ª JavaScript ä¸Šä¸‹æ–‡ï¼ˆJSContext å¯¹è±¡ï¼‰éƒ½å±äºä¸€ä¸ª JSVirtualMachineã€‚ æ¯ä¸ª JSVirtualMachine å¯ä»¥åŒ…å«å¤šä¸ªä¸Šä¸‹æ–‡ï¼Œå…è®¸åœ¨ä¸Šä¸‹æ–‡ä¹‹é—´ä¼ é€’å€¼ï¼ˆJSValue å¯¹è±¡ï¼‰ã€‚ ä½†æ˜¯ï¼Œæ¯ä¸ª JSVirtualMachine æ˜¯ä¸åŒçš„ï¼Œå³æˆ‘ä»¬ä¸èƒ½å°†ä¸€ä¸ª JSVirtualMachine ä¸­åˆ›å»ºçš„å€¼ä¼ é€’åˆ°å¦ä¸€ä¸ª JSVirtualMachine ä¸­çš„ä¸Šä¸‹æ–‡ã€‚</p>
<p>JavaScriptCore API æ˜¯çº¿ç¨‹å®‰å…¨çš„ â€”â€” ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä»»ä½•çº¿ç¨‹åˆ›å»º JSValue å¯¹è±¡æˆ–è¿è¡Œ JS è„šæœ¬ - ä½†æ˜¯ï¼Œå°è¯•ä½¿ç”¨ç›¸åŒ JSVirtualMachine çš„æ‰€æœ‰å…¶ä»–çº¿ç¨‹å°†è¢«é˜»å¡ã€‚ è¦åœ¨å¤šä¸ªçº¿ç¨‹ä¸ŠåŒæ—¶ï¼ˆå¹¶å‘ï¼‰è¿è¡Œ JavaScript è„šæœ¬ï¼Œè¯·ä¸ºæ¯ä¸ªçº¿ç¨‹ä½¿ç”¨å•ç‹¬çš„ JSVirtualMachine å®ä¾‹ã€‚</p>
<h3 id="JSValue-ä¸-JavaScript-çš„è½¬æ¢è¡¨"><a href="#JSValue-ä¸-JavaScript-çš„è½¬æ¢è¡¨" class="headerlink" title="JSValue ä¸ JavaScript çš„è½¬æ¢è¡¨"></a>JSValue ä¸ JavaScript çš„è½¬æ¢è¡¨</h3><table>
<thead>
<tr>
<th>OBJECTIVE-C</th>
<th>JAVASCRIPT</th>
<th>JSVALUE CONVERT</th>
<th>JSVALUE CONSTRUCTOR</th>
</tr>
</thead>
<tbody>
<tr>
<td>nil</td>
<td>undefined</td>
<td></td>
<td>valueWithUndefinedInContext</td>
</tr>
<tr>
<td>NSNull</td>
<td>null</td>
<td></td>
<td>valueWithNullInContext:</td>
</tr>
<tr>
<td>NSString</td>
<td>string</td>
<td>toString</td>
<td></td>
</tr>
<tr>
<td>NSNumber</td>
<td>number, boolean</td>
<td>toNumber<br />toBool<br />toDouble<br />toInt32<br />toUInt32</td>
<td>valueWithBool:inContext:<br />valueWithDouble:inContext:<br />valueWithInt32:inContext:<br />valueWithUInt32:inContext:</td>
</tr>
<tr>
<td>NSDictionary</td>
<td>Object object</td>
<td>toDictionary</td>
<td>valueWithNewObjectInContext:</td>
</tr>
<tr>
<td>NSArray</td>
<td>Array object</td>
<td>toArray</td>
<td>valueWithNewArrayInContext:</td>
</tr>
<tr>
<td>NSDate</td>
<td>Date object</td>
<td>toDate</td>
<td></td>
</tr>
<tr>
<td>NSBlock</td>
<td>Function object</td>
<td></td>
<td></td>
</tr>
<tr>
<td>id</td>
<td>Wrapper object</td>
<td>toObject<br />toObjectOfClass:</td>
<td>valueWithObject:inContext:</td>
</tr>
<tr>
<td>Class</td>
<td>Constructor object</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="iOS-Native-ä¸-JS-äº¤äº’"><a href="#iOS-Native-ä¸-JS-äº¤äº’" class="headerlink" title="iOS Native ä¸ JS äº¤äº’"></a>iOS Native ä¸ JS äº¤äº’</h2><p>å¯¹äº iOS Native ä¸ JS äº¤äº’æˆ‘ä»¬å…ˆä»è°ƒç”¨æ–¹å‘ä¸Šåˆ†ä¸ºä¸¤ç§æƒ…å†µæ¥çœ‹ï¼š</p>
<ul>
<li>JS è°ƒç”¨ Native</li>
<li>Native è°ƒç”¨ JS</li>
</ul>
<img src="/ios_native_js/call_eachother.jpg" class="">
<h3 id="JS-è°ƒç”¨-Native"><a href="#JS-è°ƒç”¨-Native" class="headerlink" title="JS è°ƒç”¨ Native"></a>JS è°ƒç”¨ Native</h3><p>å…¶å® JS è°ƒç”¨ iOS Native ä¹Ÿåˆ†ä¸ºä¸¤ç§å®ç°æ–¹å¼ï¼š</p>
<ul>
<li>å‡ Request æ–¹æ³•</li>
<li>JavaScriptCore æ–¹æ³•</li>
</ul>
<h4 id="å‡-Request-æ–¹æ³•"><a href="#å‡-Request-æ–¹æ³•" class="headerlink" title="å‡ Request æ–¹æ³•"></a>å‡ Request æ–¹æ³•</h4><p>åŸç†ï¼šå…¶å®è¿™ç§æ–¹å¼å°±æ˜¯åˆ©ç”¨äº† webview çš„ä»£ç†æ–¹æ³•ï¼Œåœ¨ webview å¼€å§‹è¯·æ±‚çš„æ—¶å€™æˆªè·è¯·æ±‚ï¼Œåˆ¤æ–­è¯·æ±‚æ˜¯å¦ä¸ºçº¦å®šå¥½çš„å‡è¯·æ±‚ã€‚å¦‚æœæ˜¯å‡è¯·æ±‚åˆ™è¡¨ç¤ºæ˜¯ JS æƒ³è¦æŒ‰ç…§çº¦å®šè°ƒç”¨æˆ‘ä»¬çš„ Native æ–¹æ³•ï¼ŒæŒ‰ç…§çº¦å®šå»æ‰§è¡Œæˆ‘ä»¬çš„ Native ä»£ç å°±å¥½ã€‚</p>
<h5 id="UIWebView"><a href="#UIWebView" class="headerlink" title="UIWebView"></a>UIWebView</h5><p>UIWebView ä»£ç†æœ‰ç”¨äºæˆªè·è¯·æ±‚çš„å‡½æ•°ï¼Œåœ¨é‡Œé¢åšåˆ¤æ–­å°±å¥½ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)webView:(<span class="built_in">UIWebView</span> *)webView shouldStartLoadWithRequest:(<span class="built_in">NSURLRequest</span> *)request navigationType:(<span class="built_in">UIWebViewNavigationType</span>)navigationType &#123;</span><br><span class="line">    <span class="built_in">NSURL</span> *url = request.URL;</span><br><span class="line">    <span class="comment">// ä¸çº¦å®šå¥½çš„å‡½æ•°åä½œæ¯”è¾ƒ</span></span><br><span class="line">    <span class="keyword">if</span> ([[url scheme] isEqualToString:<span class="string">@&quot;your_func_name&quot;</span>]) &#123;</span><br><span class="line">        <span class="comment">// just do it</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="WKWebView"><a href="#WKWebView" class="headerlink" title="WKWebView"></a>WKWebView</h5><p>WKWebView æœ‰ä¸¤ä¸ªä»£ç†ï¼Œä¸€ä¸ªæ˜¯ WKNavigationDelegateï¼Œå¦ä¸€ä¸ªæ˜¯ WKUIDelegateã€‚WKUIDelegate æˆ‘ä»¬åœ¨ä¸‹é¢çš„ç« èŠ‚ä¼šè®²åˆ°ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦è®¾ç½®å¹¶å®ç°å®ƒçš„ WKNavigationDelegate æ–¹æ³•ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)webView:(<span class="built_in">WKWebView</span> *)webView decidePolicyForNavigationAction:(<span class="built_in">WKNavigationAction</span> *)navigationAction decisionHandler:(<span class="type">void</span> (^)(<span class="built_in">WKNavigationActionPolicy</span>))decisionHandler &#123;</span><br><span class="line">    <span class="built_in">NSURL</span> *url = navigationAction.request.URL;</span><br><span class="line">    <span class="comment">// ä¸çº¦å®šå¥½çš„å‡½æ•°åä½œæ¯”è¾ƒ</span></span><br><span class="line">    <span class="keyword">if</span> ([[url scheme] isEqualToString:<span class="string">@&quot;your_func_name&quot;</span>]) &#123;</span><br><span class="line">        <span class="comment">// just do it</span></span><br><span class="line">        decisionHandler(<span class="built_in">WKNavigationActionPolicyCancel</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    decisionHandler(<span class="built_in">WKNavigationActionPolicyAllow</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: <code>decisionHandler</code> æ˜¯å½“ä½ çš„åº”ç”¨ç¨‹åºå†³å®šæ˜¯å…è®¸è¿˜æ˜¯å–æ¶ˆå¯¼èˆªæ—¶ï¼Œè¦è°ƒç”¨çš„ä»£ç å—ã€‚ è¯¥ä»£ç å—ä½¿ç”¨å•ä¸ªå‚æ•°ï¼Œå®ƒå¿…é¡»æ˜¯æšä¸¾ç±»å‹ <code>WKNavigationActionPolicy</code> çš„å¸¸é‡ä¹‹ä¸€ã€‚å¦‚æœä¸è°ƒç”¨ <code>decisionHandler</code> ä¼šå¼•èµ· crashã€‚</p>
</blockquote>
<p>è¿™é‡Œè¡¥å……ä¸€ä¸‹ JS ä»£ç ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">callNative</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">loadURL</span>(<span class="string">&quot;your_func_name://xxx&quot;</span>);</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>
<p>ç„¶åæ‹¿ä¸ª button æ ‡ç­¾ç”¨ä¸€ä¸‹å°±å¥½äº†ï¼š<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;button type=&quot;button&quot; onclick=&quot;callNative()&quot;&gt;Call Native!&lt;/button&gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="JavaScriptCore-æ–¹æ³•"><a href="#JavaScriptCore-æ–¹æ³•" class="headerlink" title="JavaScriptCore æ–¹æ³•"></a>JavaScriptCore æ–¹æ³•</h4><p>iOS 7 æœ‰äº† JavaScriptCore ä¸“é—¨ç”¨æ¥åš Native ä¸ JS çš„äº¤äº’ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ webview å®ŒæˆåŠ è½½ä¹‹åè·å– JSContextï¼Œç„¶ååˆ©ç”¨ JSContext å°† JS ä¸­çš„å¯¹è±¡å¼•ç”¨è¿‡æ¥ç”¨ Native ä»£ç å¯¹å…¶ä½œå‡ºè§£é‡Šæˆ–å“åº”ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¦–å…ˆå¼•å…¥ JavaScriptCore åº“</span></span><br><span class="line"><span class="meta">#import <span class="string">&lt;JavaScriptCore/JavaScriptCore.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç„¶åå† UIWebView çš„å®ŒæˆåŠ è½½çš„ä»£ç†æ–¹æ³•ä¸­</span></span><br><span class="line">- (<span class="type">void</span>)webViewDidFinishLoad:(<span class="built_in">UIWebView</span> *)webView &#123;</span><br><span class="line">    <span class="comment">// è·å– JS ä¸Šä¸‹æ–‡</span></span><br><span class="line">    jsContext = [webView valueForKeyPath:<span class="string">@&quot;documentView.webView.mainFrame.javaScriptContext&quot;</span>];</span><br><span class="line">    <span class="comment">// åšå¼•ç”¨ï¼Œå°† JS å†…çš„å…ƒç´ å¼•ç”¨è¿‡æ¥è§£é‡Šï¼Œæ¯”å¦‚æ–¹æ³•å¯ä»¥è§£é‡Šæˆ Blockï¼Œå¯¹è±¡ä¹Ÿå¯ä»¥æŒ‡å‘ OC çš„ Native å¯¹è±¡å“¦</span></span><br><span class="line">    jsContext[<span class="string">@&quot;iosDelegate&quot;</span>] = <span class="keyword">self</span>;</span><br><span class="line">    jsContext[<span class="string">@&quot;yourFuncName&quot;</span>] = ^(<span class="type">id</span> parameter)&#123;</span><br><span class="line">        <span class="comment">// æ³¨æ„è¿™é‡Œçš„çº¿ç¨‹é»˜è®¤æ˜¯ web å¤„ç†çš„çº¿ç¨‹ï¼Œå¦‚æœæ¶‰åŠä¸»çº¿ç¨‹æ“ä½œéœ€è¦æ‰‹åŠ¨è½¬åˆ°ä¸»çº¿ç¨‹</span></span><br><span class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="comment">// your code</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œ JS è¿™è¾¹ä»£ç æ›´ç®€å•äº†ï¼Œå¹²è„†å£°æ˜ä¸€ä¸ªä¸è§£é‡Šçš„å‡½æ•°ï¼ˆçº¦å®šå¥½åå­—çš„ï¼‰ï¼Œç”¨äºç»™ Native åšå¼•ç”¨ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> parameter = xxx;</span><br><span class="line"><span class="title function_">yourFuncName</span>(parameter);</span><br></pre></td></tr></table></figure>
<h3 id="iOS-Native-è°ƒç”¨-JS"><a href="#iOS-Native-è°ƒç”¨-JS" class="headerlink" title="iOS Native è°ƒç”¨ JS"></a>iOS Native è°ƒç”¨ JS</h3><p>iOS Native è°ƒç”¨ JS çš„å®ç°æ–¹æ³•ä¹Ÿè¢« JavaScriptCore åˆ’åˆ†å¼€æ¥ï¼š</p>
<ul>
<li>webview ç›´æ¥æ³¨å…¥ JS å¹¶æ‰§è¡Œ</li>
<li>JavaScriptCore æ–¹æ³•</li>
</ul>
<h4 id="webview-ç›´æ¥æ³¨å…¥-JS-å¹¶æ‰§è¡Œ"><a href="#webview-ç›´æ¥æ³¨å…¥-JS-å¹¶æ‰§è¡Œ" class="headerlink" title="webview ç›´æ¥æ³¨å…¥ JS å¹¶æ‰§è¡Œ"></a>webview ç›´æ¥æ³¨å…¥ JS å¹¶æ‰§è¡Œ</h4><p>åœ¨ iOS å¹³å°ï¼Œwebview æœ‰æ³¨å…¥å¹¶æ‰§è¡Œ JS çš„ APIã€‚</p>
<h5 id="UIWebView-1"><a href="#UIWebView-1" class="headerlink" title="UIWebView"></a>UIWebView</h5><p>UIWebView æœ‰ç›´æ¥æ³¨å…¥ JS çš„æ–¹æ³•ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *jsStr = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;showAlert(&#x27;%@&#x27;)&quot;</span>, <span class="string">@&quot;alert msg&quot;</span>];</span><br><span class="line">[_webView stringByEvaluatingJavaScriptFromString:jsStr];</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: è¿™ä¸ªæ–¹æ³•ä¼šè¿”å›è¿è¡Œ JS çš„ç»“æœï¼ˆ<code>nullable NSString *</code>ï¼‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼å°½ç®¡æ­¤æ–¹æ³•ä¸è¢«å¼ƒç”¨ï¼Œä½†æœ€ä½³åšæ³•æ˜¯ä½¿ç”¨ <code>WKWebView</code> ç±»çš„ <code>evaluateJavaScriptï¼šcompletionHandlerï¼šmethod</code>ã€‚</p>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<br>The stringByEvaluatingJavaScriptFromString: method waits synchronously for JavaScript evaluation to complete. If you load web content whose JavaScript code you have not vetted, invoking this method could hang your app. Best practice is to adopt the WKWebView class and use its evaluateJavaScript:completionHandler: method instead.</p>
</blockquote>
<h5 id="WKWebView-1"><a href="#WKWebView-1" class="headerlink" title="WKWebView"></a>WKWebView</h5><p>ä¸åŒäº UIWebViewï¼ŒWKWebView æ³¨å…¥å¹¶æ‰§è¡Œ JS çš„æ–¹æ³•ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ã€‚å› ä¸ºè€ƒè™‘åˆ° webview åŠ è½½çš„ web content å†… JS ä»£ç ä¸ä¸€å®šç»è¿‡éªŒè¯ï¼Œå¦‚æœé˜»å¡çº¿ç¨‹å¯èƒ½ä¼šæŒ‚èµ· Appã€‚</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *jsStr = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;setLocation(&#x27;%@&#x27;)&quot;</span>, <span class="string">@&quot;åŒ—äº¬å¸‚ä¸œåŸåŒºå—é”£é¼“å··çº³ç¦èƒ¡åŒxxå·&quot;</span>];</span><br><span class="line">[_webview evaluateJavaScript:jsStr completionHandler:^(<span class="type">id</span> _Nullable result, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@----%@&quot;</span>, result, error);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note: æ–¹æ³•ä¸ä¼šé˜»å¡çº¿ç¨‹ï¼Œè€Œä¸”å®ƒçš„å›è°ƒä»£ç å—æ€»æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œã€‚</p>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<br>Evaluates a JavaScript string.<br>The method sends the result of the script evaluation (or an error) to the completion handler. The completion handler always runs on the main thread.</p>
</blockquote>
<h4 id="JavaScriptCore-æ–¹æ³•-1"><a href="#JavaScriptCore-æ–¹æ³•-1" class="headerlink" title="JavaScriptCore æ–¹æ³•"></a>JavaScriptCore æ–¹æ³•</h4><p>ä¸Šé¢ç®€å•æåˆ°è¿‡ JavaScriptCore åº“æä¾›çš„ JSValue ç±»ï¼Œè¿™é‡Œå†æä¾›ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£å¯¹ JSValue çš„ä»‹ç»ç¿»è¯‘ï¼š</p>
<blockquote>
<p>JSValue å®ä¾‹æ˜¯å¯¹ JavaScript å€¼çš„å¼•ç”¨ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨ JSValue ç±»æ¥è½¬æ¢ JavaScript å’Œ Objective-C æˆ– Swift ä¹‹é—´çš„åŸºæœ¬å€¼ï¼ˆå¦‚æ•°å­—å’Œå­—ç¬¦ä¸²ï¼‰ï¼Œä»¥ä¾¿åœ¨æœ¬æœºä»£ç å’Œ JavaScript ä»£ç ä¹‹é—´ä¼ é€’æ•°æ®ã€‚</p>
</blockquote>
<p>ä¸è¿‡ä½ ä¹Ÿçœ‹åˆ°äº†æˆ‘è´´åœ¨ä¸Šé¢çš„ OC å’Œ JS æ•°æ®ç±»å‹è½¬æ¢è¡¨ï¼Œé‚£é‡Œé¢æ ¹æœ¬æ²¡æœ‰é™å®šä¸ºå®˜æ–¹æ–‡æ¡£æ‰€è¯´çš„åŸºæœ¬å€¼ã€‚å¦‚æœä½ ä¸ç†Ÿæ‚‰ JS çš„è¯ï¼Œæˆ‘è¿™é‡Œè§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆ JSValue ä¹Ÿå¯ä»¥æŒ‡å‘ JS ä¸­çš„å¯¹è±¡å’Œå‡½æ•°ï¼Œå› ä¸º JS è¯­è¨€ä¸åŒºåˆ†åŸºæœ¬å€¼å’Œå¯¹è±¡ä»¥åŠå‡½æ•°ï¼Œåœ¨ JS ä¸­â€œä¸‡ç‰©çš†ä¸ºå¯¹è±¡â€ã€‚</p>
<p>å¥½äº†ä¸‹é¢ç›´æ¥ show codeï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¦–å…ˆå¼•å…¥ JavaScriptCore åº“</span></span><br><span class="line"><span class="meta">#import <span class="string">&lt;JavaScriptCore/JavaScriptCore.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…ˆè·å– JS ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="keyword">self</span>.jsContext = [webView valueForKeyPath:<span class="string">@&quot;documentView.webView.mainFrame.javaScriptContext&quot;</span>];</span><br><span class="line"><span class="comment">// å¦‚æœæ¶‰åŠ UI æ“ä½œï¼Œåˆ‡å›ä¸»çº¿ç¨‹è°ƒç”¨ JS ä»£ç ä¸­çš„ YourFuncNameï¼Œé€šè¿‡æ•°ç»„@[parameter] å…¥å‚</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">    JSValue *jsValue = <span class="keyword">self</span>.jsContext[<span class="string">@&quot;YourFuncName&quot;</span>];</span><br><span class="line">    [jsValue callWithArguments:@[parameter]];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç è°ƒç”¨äº† JS ä»£ç ä¸­ YourFuncName å‡½æ•°ï¼Œå¹¶ä¸”ç»™å‡½æ•°åŠ äº† @[parameter] ä½œä¸ºå…¥å‚ã€‚ä¸ºäº†æ–¹ä¾¿é˜…è¯»ç†è§£ï¼Œè¿™é‡Œå†è´´ä¸€ä¸‹ JS ä»£ç ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">YourFuncName</span>(<span class="params"><span class="variable language_">arguments</span></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="variable language_">arguments</span>;</span><br><span class="line">    <span class="comment">// do what u want to do</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="WKWebView-ä¸-JS-äº¤äº’çš„ç‰¹æœ‰æ–¹æ³•"><a href="#WKWebView-ä¸-JS-äº¤äº’çš„ç‰¹æœ‰æ–¹æ³•" class="headerlink" title="WKWebView ä¸ JS äº¤äº’çš„ç‰¹æœ‰æ–¹æ³•"></a>WKWebView ä¸ JS äº¤äº’çš„ç‰¹æœ‰æ–¹æ³•</h2><img src="/ios_native_js/wkwebview.jpg" class="">
<p>å…³äº WKWebView ä¸ UIWebView çš„åŒºåˆ«å°±ä¸åœ¨æœ¬æ–‡åŠ ä»¥è¯¦ç»†è¯´æ˜äº†ï¼Œæ›´å¤šä¿¡æ¯è¿˜è¯·è‡ªè¡ŒæŸ¥é˜…ã€‚è¿™é‡Œè¦è®²çš„æ˜¯ WKWebView åœ¨ä¸ JS çš„äº¤äº’æ—¶ç‰¹æœ‰çš„æ–¹æ³•ï¼š</p>
<ul>
<li>WKUIDelegate æ–¹æ³•</li>
<li>MessageHandler æ–¹æ³•</li>
</ul>
<h3 id="WKUIDelegate-æ–¹æ³•"><a href="#WKUIDelegate-æ–¹æ³•" class="headerlink" title="WKUIDelegate æ–¹æ³•"></a>WKUIDelegate æ–¹æ³•</h3><p>å¯¹äº WKWebView ä¸Šæ–‡æåˆ°è¿‡ï¼Œé™¤äº† WKNavigationDelegateï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ª WKUIDelegateï¼Œè¿™ä¸ª WKUIDelegate æ˜¯åšä»€ä¹ˆç”¨çš„å‘¢ï¼Ÿ </p>
<p>WKUIDelegate åè®®åŒ…å«ä¸€äº›å‡½æ•°ç”¨æ¥ç›‘å¬ web JS æƒ³è¦æ˜¾ç¤º alert æˆ– confirm æ—¶è§¦å‘ã€‚æˆ‘ä»¬å¦‚æœåœ¨ WKWebView ä¸­åŠ è½½ä¸€ä¸ª web å¹¶ä¸”æƒ³è¦ web JS çš„ alert æˆ– confirm æ­£å¸¸å¼¹å‡ºï¼Œå°±éœ€è¦å®ç°å¯¹åº”çš„ä»£ç†æ–¹æ³•ã€‚</p>
<blockquote>
<p>Note: å¦‚æœæ²¡æœ‰å®ç°å¯¹åº”çš„ä»£ç†æ–¹æ³•ï¼Œåˆ™ webview å°†ä¼šæŒ‰ç…§é»˜è®¤æ“ä½œå»åšå‡ºè¡Œä¸ºã€‚</p>
<ul>
<li>Alert: If you do not implement this method, the web view will behave as if the user selected the OK button.</li>
<li>Confirm: If you do not implement this method, the web view will behave as if the user selected the Cancel button.</li>
</ul>
</blockquote>
<p>æˆ‘ä»¬è¿™é‡Œå°±æ‹¿ alert ä¸¾ä¾‹ï¼Œç›¸ä¿¡å„ä½è¯»è€…å¯ä»¥è‡ªå·±ä¸¾ä¸€åä¸‰ã€‚ä¸‹é¢æ˜¯åœ¨ WKUIDelegate ç›‘å¬ web è¦æ˜¾ç¤º alert çš„ä»£ç†æ–¹æ³•ä¸­ç”¨ Native UIAlertController æ›¿ä»£ JS ä¸­çš„ alert æ˜¾ç¤ºçš„æ —å­ ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)webView:(<span class="built_in">WKWebView</span> *)webView runJavaScriptAlertPanelWithMessage:(<span class="built_in">NSString</span> *)message initiatedByFrame:(<span class="built_in">WKFrameInfo</span> *)frame completionHandler:(<span class="type">void</span> (^)(<span class="type">void</span>))completionHandler &#123;</span><br><span class="line">    <span class="comment">// ç”¨ Native çš„ UIAlertController å¼¹çª—æ˜¾ç¤º JS å°†è¦æç¤ºçš„ä¿¡æ¯</span></span><br><span class="line">    <span class="built_in">UIAlertController</span> *alert = [<span class="built_in">UIAlertController</span> alertControllerWithTitle:<span class="string">@&quot;æé†’&quot;</span> message:message preferredStyle:<span class="built_in">UIAlertControllerStyleAlert</span>];</span><br><span class="line">    [alert addAction:[<span class="built_in">UIAlertAction</span> actionWithTitle:<span class="string">@&quot;çŸ¥é“äº†&quot;</span> style:<span class="built_in">UIAlertActionStyleCancel</span> handler:^(<span class="built_in">UIAlertAction</span> * _Nonnull action) &#123;</span><br><span class="line">        <span class="comment">// å‡½æ•°å†…å¿…é¡»è°ƒç”¨ completionHandler</span></span><br><span class="line">        completionHandler();</span><br><span class="line">    &#125;]];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> presentViewController:alert animated:<span class="literal">YES</span> completion:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="MessageHandler-æ–¹æ³•"><a href="#MessageHandler-æ–¹æ³•" class="headerlink" title="MessageHandler æ–¹æ³•"></a>MessageHandler æ–¹æ³•</h3><p>MessageHandler æ˜¯ç»§ Native æˆªè· JS å‡è¯·æ±‚åå¦ä¸€ç§ JS è°ƒç”¨ Native çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åˆ©ç”¨äº† WKWebView çš„æ–°ç‰¹æ€§å®ç°ã€‚å¯¹æ¯”æˆªè·å‡ Request çš„æ–¹æ³•æ¥è¯´ï¼ŒMessageHandler ä¼ å‚æ•°æ›´åŠ ç®€å•æ–¹ä¾¿ã€‚</p>
<h4 id="MessageHandler-æŒ‡ä»€ä¹ˆï¼Ÿ"><a href="#MessageHandler-æŒ‡ä»€ä¹ˆï¼Ÿ" class="headerlink" title="MessageHandler æŒ‡ä»€ä¹ˆï¼Ÿ"></a>MessageHandler æŒ‡ä»€ä¹ˆï¼Ÿ</h4><p>WKUserContentController ç±»æœ‰ä¸€ä¸ªæ–¹æ³•:<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)addScriptMessageHandler:(<span class="type">id</span> &lt;<span class="built_in">WKScriptMessageHandler</span>&gt;)scriptMessageHandler name:(<span class="built_in">NSString</span> *)name;</span><br></pre></td></tr></table></figure><br>è¯¥æ–¹æ³•ç”¨æ¥æ·»åŠ ä¸€ä¸ªè„šæœ¬å¤„ç†å™¨ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨å†…å¯¹ JS è„šæœ¬è°ƒç”¨çš„æ–¹æ³•åšå‡ºå¤„ç†ï¼Œä»è€Œè¾¾åˆ° JS è°ƒç”¨ Native çš„ç›®çš„ã€‚</p>
<p>é‚£ä¹ˆ WKUserContentController ç±»å’Œ WKWebView æœ‰æ¯›å…³ç³»å‘¢ï¼Ÿ</p>
<p>åœ¨ WKWebView çš„åˆå§‹åŒ–å‡½æ•°ä¸­æœ‰ä¸€ä¸ªå…¥å‚ configurationï¼Œå®ƒçš„ç±»å‹æ˜¯ WKWebViewConfigurationã€‚WKWebViewConfiguration ä¸­åŒ…å«ä¸€ä¸ªå±æ€§ userContentControllerï¼Œè¿™ä¸ª userContentController å°±æ˜¯ WKUserContentController ç±»å‹çš„å®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ª userContentController æ¥æ·»åŠ ä¸åŒåç§°çš„è„šæœ¬å¤„ç†å™¨ã€‚</p>
<img src="/ios_native_js/wkusercontentcontroller.jpg" class="">
<h5 id="MessageHandler-çš„å‘"><a href="#MessageHandler-çš„å‘" class="headerlink" title="MessageHandler çš„å‘"></a>MessageHandler çš„å‘</h5><p>é‚£ä¹ˆå›åˆ° <code>- (void)addScriptMessageHandler:name:</code> æ–¹æ³•ä¸Šé¢ï¼Œè¯¥æ–¹æ³•æ·»åŠ ä¸€ä¸ªè„šæœ¬æ¶ˆæ¯å¤„ç†å™¨ï¼ˆç¬¬ä¸€ä¸ªå…¥å‚ scriptMessageHandlerï¼‰ï¼Œå¹¶ä¸”ç»™è¿™ä¸ªå¤„ç†å™¨èµ·ä¸€ä¸ªåå­—ï¼ˆç¬¬äºŒä¸ªå…¥å‚ nameï¼‰ã€‚ä¸è¿‡è¿™ä¸ªå‡½æ•°åœ¨ä½¿ç”¨çš„æ—¶å€™æœ‰ä¸ªå‘ï¼šscriptMessageHandler å…¥å‚ä¼šè¢«å¼ºå¼•ç”¨ï¼Œé‚£ä¹ˆå¦‚æœä½ æŠŠå½“å‰ WKWebView æ‰€åœ¨çš„ UIViewController ä½œä¸ºç¬¬ä¸€ä¸ªå…¥å‚ï¼Œè¿™ä¸ª viewController è¢«ä»–è‡ªå·±æ‰€æŒæœ‰çš„ <code>webview.configuration. userContentController</code> æ‰€æŒæœ‰ï¼Œå°±ä¼šé€ æˆå¾ªç¯å¼•ç”¨ã€‚</p>
<img src="/ios_native_js/retaincycle.jpg" class="">
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>- (void)removeScriptMessageHandlerForName:</code> æ–¹æ³•åˆ æ‰ userContentController å¯¹ viewController çš„å¼ºå¼•ç”¨ã€‚æ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬çš„ä»£ç ä¼šåœ¨ <code>viewWillAppear</code> å’Œ <code>viewWillDisappear</code> æˆå¯¹å„¿çš„æ·»åŠ å’Œåˆ é™¤ MessageHandlerï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)viewWillAppear:(<span class="type">BOOL</span>)animated &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewWillAppear:animated];</span><br><span class="line">    [<span class="keyword">self</span>.webview.configuration.userContentController addScriptMessageHandler:<span class="keyword">self</span> name:<span class="string">@&quot;YourFuncName&quot;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)viewWillDisappear:(<span class="type">BOOL</span>)animated &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewWillDisappear:animated];</span><br><span class="line">    [<span class="keyword">self</span>.webview.configuration.userContentController removeScriptMessageHandlerForName:<span class="string">@&quot;YourFuncName&quot;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="WKScriptMessageHandler-åè®®"><a href="#WKScriptMessageHandler-åè®®" class="headerlink" title="WKScriptMessageHandler åè®®"></a>WKScriptMessageHandler åè®®</h5><p>WKScriptMessageHandler æ˜¯è„šæœ¬ä¿¡æ¯å¤„ç†å™¨åè®®ï¼Œå¦‚æœæƒ³è®©ä¸€ä¸ªå¯¹è±¡å…·æœ‰è„šæœ¬ä¿¡æ¯å¤„ç†èƒ½åŠ›ï¼ˆæ¯”å¦‚ä¸Šæ–‡ä¸­ webview çš„æ‰€å± viewController ä¹Ÿå°±æ˜¯ä¸Šé¢ä»£ç çš„ selfï¼‰å°±å¿…é¡»ä½¿å…¶éµå¾ªè¯¥åè®®ã€‚</p>
<p>WKScriptMessageHandler åè®®å†…éƒ¨éå¸¸ç®€å•ï¼Œåªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å¿…é¡»è¦å®ç°è¯¥æ–¹æ³•ï¼ˆ@requiredï¼‰ï¼š</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WKScriptMessageHandler åè®®æ–¹æ³•ï¼Œåœ¨æ¥æ”¶åˆ°è„šæœ¬ä¿¡æ¯æ—¶è§¦å‘</span></span><br><span class="line">- (<span class="type">void</span>)userContentController:(<span class="built_in">WKUserContentController</span> *)userContentController didReceiveScriptMessage:(<span class="built_in">WKScriptMessage</span> *)message &#123;</span><br><span class="line">    <span class="comment">// message æœ‰ä¸¤ä¸ªå±æ€§ï¼šname å’Œ body</span></span><br><span class="line">    <span class="comment">// message.name å¯ä»¥ç”¨äºåŒºåˆ«è¦åšçš„å¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> ([message.name isEqualToString:<span class="string">@&quot;YourFuncName&quot;</span>]) &#123;</span><br><span class="line">        <span class="comment">// message.body ç›¸å½“äº JS ä¼ é€’è¿‡æ¥çš„å‚æ•°</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;JS call native success %@&quot;</span>, message.body);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¡¥å…… JS çš„ä»£ç ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &lt;name&gt; æ¢ YourFuncNameï¼Œ&lt;messageBody&gt; æ¢ä½ è¦çš„å…¥å‚å³å¯</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">webkit</span>.<span class="property">messageHandlers</span>.&lt;name&gt;.<span class="title function_">postMessage</span>(&lt;messageBody&gt;)</span><br></pre></td></tr></table></figure>
<p>æå®šæ”¶å·¥ï¼</p>
<h2 id="JS-é€šè¿‡-Native-è°ƒç”¨-iOS-è®¾å¤‡æ‘„åƒå¤´çš„-Demo"><a href="#JS-é€šè¿‡-Native-è°ƒç”¨-iOS-è®¾å¤‡æ‘„åƒå¤´çš„-Demo" class="headerlink" title="JS é€šè¿‡ Native è°ƒç”¨ iOS è®¾å¤‡æ‘„åƒå¤´çš„ Demo"></a>JS é€šè¿‡ Native è°ƒç”¨ iOS è®¾å¤‡æ‘„åƒå¤´çš„ Demo</h2><p>å¾’æ‰‹æ’¸äº†ä¸€ä¸ª Demoï¼Œå®ç°äº† JS ä¸ Native ä»£ç çš„äº¤äº’ï¼Œè¾¾åˆ°ç”¨ JS åœ¨ webview å†…è°ƒç”¨ iOS è®¾å¤‡æ‘„åƒå¤´çš„åŠŸèƒ½ã€‚Demo å†…å«æƒé™ç”³è¯·ï¼Œç”¨æˆ·æ‹’ç»æˆæƒç­‰ç»†èŠ‚ï¼ˆæŠ€æœ¯ä¸Šå°±æ˜¯ JS å’Œ Native ç›¸äº’ä¼ å€¼è°ƒç”¨ï¼‰ï¼Œè¿˜è¯·å„ä½å¤§ä½¬æŒ‡æ•™ã€‚</p>
<p>å‘å„ä½åŸºä½¬ä½å¤´ï¼ŒçŒ®ä¸Šæˆ‘çš„è†ç›–~<a target="_blank" rel="noopener" href="https://github.com/Lision/HybridCameraDemo">ï¼ˆDemo åœ°å€ï¼‰</a></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul>
<li>è¿™ç¯‡æ–‡ç« ç®€å•çš„ä»‹ç»äº†ä¸€ä¸‹ Hybrid Mobile Appï¼ˆå…¶ä¸­è¿˜åŒ…æ‹¬ Hybrid çš„å‘å±•ç®€å²ï¼‰ã€‚</li>
<li>ä»‹ç»äº† JavaScriptCore çš„ç»„æˆï¼Œå¹¶ä¸”æŠŠ JSVirtualMachine ä¸ JSContext å’Œ JSValue ä¹‹é—´çš„å…³ç³»ç”¨å›¾ç‰‡çš„å½¢å¼è¡¨è¿°å‡ºæ¥ï¼ˆJSVirtualMachine åŒ…å« JSContext åŒ…å« JSValueï¼Œéƒ½æ˜¯ 1 å¯¹ n çš„å…³ç³»ï¼Œä¸”ç”±äºåŒä¸€ä¸ª JSVirtualMachine ä¸‹çš„ä»£ç ä¼šç›¸äº’é˜»å¡ï¼Œæ‰€ä»¥å¦‚æœæƒ³å¼‚æ­¥æ‰§è¡Œäº¤äº’éœ€è¦åœ¨ä¸åŒçš„çº¿ç¨‹å£°æ˜ JSVirtualMachine å¹¶å‘æ‰§è¡Œï¼‰ã€‚</li>
<li>ä»è°ƒç”¨æ–¹å‘çš„è§’åº¦æŠŠ JS ä¸ iOS Native ç›¸äº’è°ƒç”¨çš„æ–¹å¼æ–¹æ³•åˆ†åˆ«ç”¨ä»£ç ç¤ºä¾‹è®²è§£äº†ä¸€éã€‚</li>
<li>ä»‹ç»äº† WKWebView ä¸ JS äº¤äº’ç‰¹æœ‰çš„æ–¹æ³•ï¼šWKUIDelegate å’Œ MessageHandlerã€‚</li>
<li>æä¾›äº†ä¸€ä¸ª JS é€šè¿‡ Native è°ƒç”¨ iOS è®¾å¤‡æ‘„åƒå¤´çš„ Demoã€‚</li>
</ul>
<p>æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜ <a href="https://lision.me/">https://lision.me/</a>ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ <a href="https://lision.me/">ä¸ªäººåšå®¢</a> ä¸­æ›´æ–°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš <a target="_blank" rel="noopener" href="https://weibo.com/lisioncode">@Lision</a> è”ç³»æˆ‘~</p>
<p>å¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~</p>


    
    
    
	  <div class="tags">
      <a class="tag-none-link" href="/tags/hybrid/" rel="tag">hybrid</a><a class="tag-none-link" href="/tags/jsbridge/" rel="tag">jsbridge</a>
	  </div>
    

  </section>
</article>
  
</section>



      <script>setLoadingBarProgress(60);</script>
    </main>
    
    <footer id="footer" class="clearfix">
  
  
	<div class="search">
	  <script>
      (function() {
        var cx = '001858749347000340533:drswradlp64';
        var gcse = document.createElement('script');
        gcse.type = 'text/javascript';
        gcse.async = true;
        gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(gcse, s);
      })();
    </script>
    <gcse:searchbox-only></gcse:searchbox-only>
	</div>
	

	<div class="social-wrapper">
  	
      
        <a href="mailto:lisionmail@gmail.com" class="social email"
          target="_blank" rel="external">
          <span class="icon icon-email"></span>
        </a>
      
        <a href="https://github.com/Lision" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="https://twitter.com/LisionChat" class="social twitter"
          target="_blank" rel="external">
          <span class="icon icon-twitter"></span>
        </a>
      
        <a href="https://weibo.com/lisioncode" class="social sina-weibo"
          target="_blank" rel="external">
          <span class="icon icon-sina-weibo"></span>
        </a>
      
    
  </div>
  
  <div>Theme <span class="codename">Typescript</span> designed by <a href="http://rakugaki.me/" target="_blank">Art Chen</a>.</div>
  <div>&copy; <a href="/">èŠå®…</a></div>
  
</footer>


    <script>setLoadingBarProgress(80);</script>
    
  </div>

  
<script>
  var disqus_shortname = 'lision-me';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>




<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>window.jQuery || document.write('<script src="/js/jquery.min.js"><\/script>')</script>


<script src="/js/jquery.fitvids.js"></script>

<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "AIzaSyAMIoydL742ROhE6lLk9n3hT0pZwbrXD_I";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "001858749347000340533:drswradlp64";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "google";
</script>

<script src="/js/search.js"></script>


<script src="/js/app.js"></script>



  <script>setLoadingBarProgress(100);</script>
  
</body>
</html>
