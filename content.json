{"pages":[],"posts":[{"title":"ç†è§£ Hood","comments":true,"permalink":"https://lision.me/hood/","text":"Hood å®˜æ–¹ä¸­æ–‡æŒ‡å¼•ï¼šç†è§£ hoodè¿™ç¯‡æ–‡ç« æ˜¯åœ¨æˆ‘åˆ©ç”¨ä¸ªäººæ—¶é—´åšçš„ App â€”â€” Hood åˆç‰ˆå¿«è¦å®Œæˆæ—¶å†™çš„ï¼Œæ—¨åœ¨è®© Hood çš„ç”¨æˆ·å¯ä»¥é€šè¿‡é˜…è¯»æœ¬æ–‡æå‡å¯¹ Hood äº§å“é€»è¾‘çš„ç†è§£ä»è€Œæ›´åŠ ç§‘å­¦åˆç†çš„ä½¿ç”¨ Hoodã€‚ ç´¢å¼• Hood æ˜¯ä»€ä¹ˆ? æ ¸å¿ƒæ¦‚å¿µ è®¾è®¡ç†å¿µ æ— å¯å¥ˆä½• æœªæ¥è®¡åˆ’ Hood æ˜¯ä»€ä¹ˆï¼ŸHood æ˜¯æˆ‘åˆ©ç”¨ä¸šä½™æ—¶é—´åšçš„ä¸€æ¬¾ Appã€‚ ä½ å¯ä»¥æŠŠ Hood å½“ä½œä¸€ä¸ªéšç§å·¥å…·ï¼Œåœ¨ä»–äººå€Ÿç”¨è®¾å¤‡æ—¶ç¦ç”¨æ‰ç§å¯† Appï¼›ä½ å¯ä»¥æŠŠ Hood å½“ä½œä¸€ä¸ªæ•ˆç‡å·¥å…·ï¼Œåœ¨å·¥ä½œæˆ–è€…é›†ä¸­æ³¨æ„åŠ›æ—¶éšè—åˆ†æ•£ä½ æ³¨æ„åŠ›çš„ Appï¼›ä½ å¯ä»¥æŠŠ Hood å½“ä½œä¸€ä¸ªå®¶é•¿ç®¡ç†å·¥å…·ï¼Œå¿…è¦æ—¶å°†é‚£äº›ä½¿ç”¨æ—¶é•¿è¿‡å¤šå¯¹å­©å­å¥åº·é€ æˆå½±å“çš„ App é™åˆ¶èµ·æ¥ã€‚ æ€»ä¹‹ï¼ŒåŸºäºå±å¹•ä½¿ç”¨æ—¶é—´ç®¡ç†çš„æ ¸å¿ƒåŠŸèƒ½å¯ä»¥æ´¾ç”Ÿå‡ºå¥½å¤šæœ‰è¶£çš„ç”¨æ³•ï¼Œå› æ­¤ Hood æœªæ¥çš„è¿­ä»£æ–¹å‘ä¹Ÿæœ‰å¾ˆå¤šã€‚ æ ¸å¿ƒæ¦‚å¿µ æˆæƒï¼ŒHood çš„ä¸»è¦èƒ½åŠ›æ˜¯å±å¹•æ—¶é—´ç®¡ç†ï¼Œè¿™é¡¹èƒ½åŠ›æ¥è‡ªäº ScreenTime APIï¼Œæ‰€ä»¥åœ¨æ²¡æœ‰å¾—åˆ°æˆæƒæ—¶ Hood å‡ ä¹æ²¡æœ‰ä»»ä½•ç”¨ï¼Œè¿™ä¹Ÿæ˜¯ Hood åœ¨ç”¨æˆ·æœªæˆæƒ ScreenTime æ—¶å‘ç”¨æˆ·ç”³è¯·æƒé™çš„åŸå› ã€‚ éšç§ï¼ŒScreenTime API çš„è®¾è®¡éå¸¸æ³¨é‡éšç§å®‰å…¨ï¼ŒHood ä¸ä¼šçŸ¥é“ä½ å®‰è£…äº†å“ªäº› Appsï¼Œä»¥åŠä»€ä¹ˆ Apps æ˜¯ä½ æƒ³è¦é™åˆ¶ä½¿ç”¨çš„ã€‚å…¶å® Hood çš„ä½¿ç”¨å¹¶ä¸éœ€è¦ç½‘ç»œæˆæƒï¼Œç›®å‰è¯·æ±‚ç½‘ç»œæƒé™ä¹Ÿä»…ä»…æ˜¯ä¸ºäº†åŒæ­¥ AppStore çš„ä¿¡æ¯ã€‚ é™åˆ¶ï¼ŒHood åªä¼šå¯¹æ²¡æœ‰ ScreenTime API æˆæƒçš„ App ç”Ÿæ•ˆï¼Œè¿™æ„å‘³ç€ Hood ä¸å¯ä»¥éšè—è‡ªå·±ï¼Œæ‰€ä»¥ä¸æ˜¯å¾ˆæœ‰è¶£ã€‚è¿™ä¹Ÿæ„å‘³ç€å¦‚æœä½ æƒ³å–æ¶ˆ Hood çš„æ§åˆ¶ï¼Œåªéœ€è¦æ”¶å› Hood æ‹¿åˆ°çš„ ScreenTime æˆæƒæˆ–è€…å¹²è„†å¸è½½ Hoodï¼Œé‚£äº›è¢« Hood é™åˆ¶çš„ Apps å°±ä¼šä¸€åˆ‡å¦‚åˆã€‚ è®¾è®¡ç†å¿µ åº”ç”¨åˆ†ç»„ï¼Œç®¡ç†å•ä¸ªåº”ç”¨æ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥ Hood åŠ å…¥äº†åˆ†ç»„çš„æ¦‚å¿µï¼Œä»¥å¡ç‰‡å½¢å¼å±•ç¤ºã€‚ èº«ä»½è®¤è¯ï¼Œçœ‹åˆ° Hood å†…å®¹çš„äººåº”è¯¥æ˜¯è®¾å¤‡çš„ä¸»äººï¼Œå½“å‰ Hood åªåšäº†ç”Ÿç‰©è¯†åˆ«è®¤è¯ï¼Œä¹Ÿå°±æ˜¯ Face ID æˆ– Touch IDã€‚ é™åˆ¶å¸è½½ï¼Œå¦‚æœ Hood ä¸å†é‚£ä¹ˆå°ä¼—ï¼Œé‚£ä¹ˆå¯èƒ½æ‹¿åˆ°ä½ è®¾å¤‡çš„äººå³ä½¿ä¸è¿›è¡Œèº«ä»½è®¤è¯ä¾ç„¶å¯ä»¥é€šè¿‡å¸è½½ Hood çš„æ–¹å¼çœ‹åˆ°é‚£äº›ä½ ä¸æ„¿æ„è®© TA çœ‹åˆ°çš„ Appsï¼Œæ‰€ä»¥ Hood åšäº†è¿™ä¸ªåŠŸèƒ½ï¼›ç›¸åº”çš„è¿˜æœ‰ã€Œé™åˆ¶å®‰è£…åº”ç”¨ã€å’Œã€Œé™åˆ¶åº”ç”¨å†…è´­ä¹°ã€åŠŸèƒ½ï¼Œç¬”è€…è®¤ä¸ºè¿™ä¸‰ä¸ªåŠŸèƒ½å¯¹äºç›‘æŠ¤äººæ›´å¥½çš„çº¦æŸè¢«ç›‘æŠ¤äººè¿™ä¸ªåœºæ™¯å¾ˆæœ‰ç”¨ï¼Œå¯ä»¥é˜²æ­¢å­©å­å®‰è£…æ–°çš„æ‰‹æ¸¸æˆ–ç§ä¸‹è´­ä¹°æ¸¸æˆé“å…·/æ‰“èµå¥³ä¸»æ’­ã€‚ æ— å¯å¥ˆä½• å›¾æ ‡ä¹±åºï¼Œè¢« ScreenTime API ç¦ç”¨çš„ Apps åœ¨è¿˜åŸæ—¶ä¼šæŒ‰ç…§æŸç§è§„åˆ™é‡æ–°å‡ºç°åˆ°è®¾å¤‡æ¡Œé¢ï¼Œå°±å¥½åƒå®ƒä»¬è¢«ç¦ç”¨æ—¶çœŸçš„è¢«å¸è½½ç„¶åå‡ºç°æ—¶åˆé‡æ–°ä» AppStore å®‰è£…ä¸€æ ·ï¼Œé—æ†¾çš„æ˜¯è¿™æš‚æ—¶æ— è§£ã€‚ä¸è¿‡å¯ä»¥é€šè¿‡åœ¨ç¬¬äºŒå±é¢„ç•™ç›¸åº”ç©ºä½æˆ–è€…å‚ç…§ Hood å†…åˆ‡æ¢éšè—æ¨¡å¼æ—¶çš„æç¤ºç»•è¿‡å»ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥è¯•è¯•é€šè¿‡ Hood çš„é”å®šæ¨¡å¼æ¥ç¦ç”¨ Appã€‚ ç•Œé¢ç®€é™‹ï¼Œå‘ƒâ€¦ å› ä¸ºç›®å‰è¿˜æ²¡æ‰¾åˆ°åˆä½œçš„è®¾è®¡å¸ˆï¼Œæ‰€ä»¥æ•´ä¸ª App çš„äº¤äº’å’Œç•Œé¢è®¾è®¡éƒ½æ˜¯æˆ‘è‡ªå·±åšçš„ï¼Œç¡®å®æœ‰ç‚¹åæ€§å†·æ·¡çš„ç´ ã€‚å…¶å®ä»”ç»†ä½“ä¼šçš„è¯ä½ ä¹Ÿè®¸å¯ä»¥å‘ç°æ‰€æœ‰çš„äº¤äº’è·¯å¾„éƒ½æ˜¯å°½å¯èƒ½çŸ­çš„ï¼Œç›®çš„è‡ªç„¶æ˜¯ä¸ºäº†æ›´é«˜æ•ˆã€‚AppIcon çš„ H ä¸åªæ˜¯ Hood çš„é¦–å­—æ¯ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæ …æ çš„å½¢è±¡ï¼Œæ„å‘³ç€çº¦æŸå’Œæ§åˆ¶ï¼›ä¸»é¢˜è‰²æ˜¯ç»¿è‰²å’Œè“è‰²çš„æ··è‰²ï¼Œè¡¨ç¤ºå¥åº·/è·ç¦»æ„Ÿä¸å¯é ã€‚ æœªæ¥è®¡åˆ’æ­£å¦‚æ–‡ç« å¼€å¤´è¯´çš„é‚£æ ·ï¼ŒåŸºäºå±å¹•ä½¿ç”¨æ—¶é—´ç®¡ç†çš„æ ¸å¿ƒåŠŸèƒ½å¯ä»¥æ´¾ç”Ÿå‡ºå¥½å¤šæœ‰è¶£çš„ç”¨æ³•ï¼Œå› æ­¤ Hood æœªæ¥çš„è¿­ä»£æ–¹å‘ä¹Ÿæœ‰å¾ˆå¤šã€‚è€å®è¯´ï¼Œæˆ‘ç›®å‰å¯¹äº Hood çš„è§„åˆ’æ›´å€¾å‘äºæ•ˆç‡ç±»å·¥å…·ï¼Œæ‰€ä»¥åç»­å¤§æ¦‚ç‡ä¼šå¾€è¿™ä¸ªæ–¹å‘åšè¿­ä»£ã€‚"},{"title":"Understanding Hood","comments":true,"permalink":"https://lision.me/hood-en/","text":"The article was translated from Chinese by ChatGPT. Hood Official English Guide: Understanding HoodThis article was written when I was about to complete the first version of my app, Hood, in my spare time. The purpose is to help users of Hood better understand the product logic through reading this article and use it more scientifically and reasonably. Index What is Hood? Core Concepts Design Philosophy Helplessness Future Plans What is Hood?Hood is an app that I made in my spare time. You can think of Hood as a privacy tool to protect private apps when others borrow your phone; you can think of it as an efficiency tool to block distracting apps while working or focusing attention; you can think of it as a parental management tool to block Apps that have been used too much and may affect childrenâ€™s health if necessary. In short, based on the core function of Screen Time Management, many interesting uses can be derived from them. Therefore, there are many future directions for iteration on Hood. Core Concepts Authorization: The main ability of Hood is Screen Time Management. This ability comes from the ScreenTime API. Therefore, without authorization, Hood is almost useless. This is also why Hood applies for permission to users who have not authorized ScreenTime. Privacy: The design of the ScreenTime API pays great attention to privacy and security. Hood does not know which Apps you have installed or what Apps you want to manage. In fact, using Hood does not require network authorization at present, and requesting network permissions only synchronizes AppStore information. Limitation: Hood only works on Apps that do not have ScreenTime API authorization. This means that Hood cannot hide itself, so it is not very interesting. It also means that if you want to cancel the control of Hood, just revoke the ScreenTime authorization obtained by Hood or simply uninstall it, and those Apps controlled by hidden will return to their original state. Design Philosophy Application grouping: Managing individual applications can be cumbersome, so Hood introduces the concept of grouping in card form display. Identity authentication: People who see content in Hidde should be device owners. Hood only did biometric authentication - Face ID or Touch ID. Uninstall limitation: If Hood is no longer so niche, people who get your device may still be able to see the Apps you donâ€™t want them to see by uninstalling Hood even if they do not authenticate. Therefore, Hood has this function; corresponding functions also include â€œLimit installation of applicationsâ€ and â€œLimit in-app purchasesâ€, which I think are very useful for guardianship scenarios where parents need to restrict their children from installing new mobile games or buying game props/rewarding anchors. Helplessness Icon disorder: When blocking apps restore, they will be rearranged on the device desktop according to some rules, as if they were really uninstalled when blocked and then reinstalled from the App Store when they appear again. There is currently no solution for this problem, but you can bypass it by reserving corresponding space on the second screen or referring to the prompt when switching to block mode in Hidde. Of course, you can also try disabling apps through Hoodâ€™s lock mode. Locking wonâ€™t cause disorder and is suitable for non-essential blocking scenarios such as self-discipline. Simple interface: Umâ€¦ because I havenâ€™t found a cooperating designer yet, so I did all of Hoodâ€™s interaction and interface design myself. It does have a bit of bias towards minimalism. If you carefully experience it, you may find that all interaction paths are as short as possible for higher efficiency. The interface elements are mostly simple graphics that directly map to code logic. To say more, actually â€œHâ€ in AppIcon not only stands for â€œHoodâ€, but also represents a fence image which means constraint and control; The theme color is a mixture of green and blue representing health/distance sense and reliability. Future plansAs mentioned at the beginning of this article, many interesting uses can be derived from Hoodâ€™s core function of Screen Time Management; therefore there are many directions for future iterations of Hood. Honestly speaking, my current plan for Hood leans more towards efficient tools; therefore subsequent iterations will probably move in this direction."},{"title":"Hood éšç§æ”¿ç­–","comments":true,"permalink":"https://lision.me/hood-privacy-policy/","text":"éšç§æ”¿ç­– Hood ä¸­é€‰æ‹©çš„åº”ç”¨ç¨‹åºä»¥ä¸é€æ˜ä»¤ç‰Œçš„å½¢å¼ç”± iOS å±å¹•æ—¶é—´æä¾›ã€‚Hood æ°¸è¿œä¸ä¼šçŸ¥é“æ‚¨é€‰æ‹©äº†å“ªäº›åº”ç”¨ç¨‹åºã€‚ Hood ä¸æ”¶é›†ä»»ä½•æ•°æ®ï¼ŒåŒ…æ‹¬æ‚¨é€‰æ‹©äº†å“ªäº›åº”ç”¨ç¨‹åºã€ä½ç½®ä¿¡æ¯æˆ–ä½¿ç”¨ä¿¡æ¯ã€‚ Hood è¯·æ±‚ç½‘ç»œæˆæƒä»…ç”¨äºåº”ç”¨å†…è´­ä¹°æœåŠ¡ã€‚ Hood ä¸ä½¿ç”¨ä»»ä½•ç¬¬ä¸‰æ–¹ SDK æˆ–æœåŠ¡ã€‚ æœ€åæ›´æ–°äº 2023 å¹´ 06 æœˆ 20 æ—¥"},{"title":"Hood Privacy Policy","comments":true,"permalink":"https://lision.me/hood-privacy-policy-en/","text":"Privacy Policy The applications selected in Hood are provided by iOS Screen Time in the form of opaque tokens. Hood will never know which applications you have chosen. Hood does not collect any data, including which applications you have selected, location information or usage information. Hood requests network authorization only for In-App Purchase services. Hood does not use any third-party SDKs or services. Last updated on June 20, 2023"},{"title":"èŠèŠæˆ‘å¯¹çŸ¥è¯†ä»˜è´¹çš„ç†è§£","comments":true,"permalink":"https://lision.me/talk-about-pay-for-knowledge/","text":"å†™åœ¨å‰é¢Emmmmmâ€¦ä¸Šä¸€ç¯‡æ–‡ç« ç»“å°¾èŠåˆ°è‡ªå·±è¦å°è¯•å¼€å§‹å»ã€Šå°ä¸“æ ã€‹å†™æ–‡ç« çš„äº‹å„¿ï¼Œæœ¬æ¥æ˜¯å‡†å¤‡ç®€å•å†™å‡ å¥ä¸€ç¬”å¸¦è¿‡çš„ï¼Œä¸è¿‡åœ¨æˆ‘å†™å®Œã€ŠFlutter çŠ¶æ€ç®¡ç†ã€‹ç³»åˆ—ç¬¬äºŒç¯‡æ–‡ç« ä¹‹åä»”ç»†æƒ³äº†æƒ³è¿˜æ˜¯åº”è¯¥æŠ½å‡ºæ¥èŠèŠè‡ªå·±å¯¹äºçŸ¥è¯†ä»˜è´¹çš„çœ‹æ³•ã€‚ ç´¢å¼• çŸ¥è¯†ä»˜è´¹ æ—¶é—´æˆæœ¬ æ­£å‘æ¿€åŠ± å•†ä¸šåŒ– çŸ¥è¯†ä»˜è´¹ çŸ¥è¯†ä»˜è´¹ï¼ŒçŸ¥è¯†ä»˜è´¹ä¸»è¦æŒ‡çŸ¥è¯†çš„æ¥æ”¶è€…ä¸ºæ‰€é˜…è§ˆçŸ¥è¯†ä»˜å‡ºèµ„é‡‘çš„ç°è±¡ã€‚çŸ¥è¯†ä»˜è´¹è®©çŸ¥è¯†çš„è·å¾—è€…é—´æ¥ä¸ºå‘çŸ¥è¯†çš„ä¼ æ’­è€…ä¸ç­›é€‰è€…ç»™äºˆæŠ¥é…¬ï¼Œè€Œä¸æ˜¯è®©å‚ä¸çŸ¥è¯†ä¼ æ’­é“¾æ¡çš„äººé€šè¿‡æµé‡æˆ–å¹¿å‘Šç­‰å…¶å®ƒæ–¹å¼è·å¾—æ”¶ç›Šã€‚ è¯·åŸè°…æˆ‘è¿™é‡Œå¼•ç”¨äº†ç™¾åº¦ç™¾ç§‘ï¼Œå› ä¸ºæˆ‘å…¶å®è§‰å¾—ç™¾åº¦ç™¾ç§‘å¯¹äºçŸ¥è¯†ä»˜è´¹çš„æè¿°å¾ˆå¯¹æˆ‘çš„èƒƒå£ï¼Œä½œä¸ºæŠ€æœ¯ä»ä¸šè€…æˆ‘çŸ¥é“å¾ˆå¤šäººæ¯”è¾ƒé„™è§†ç™¾åº¦ç”Ÿæ€ï¼Œä½†æ˜¯æˆ‘è§‰å¾—è¿˜æ˜¯ä¸èƒ½ä¸ºäº†é„™è§†è€Œé„™è§†ï¼Œä¹Ÿä¸æ˜¯è¯´é„™è§†äº†ç™¾åº¦ç”¨äº†è°·æ­Œå°±èƒ½è¯´æ˜è‡ªå·±é«˜äººä¸€ç­‰ï¼Œä½ è¯´å¯¹å§ï¼Ÿ æ—¶é—´æˆæœ¬ç™¾ç§‘é‡Œå¯¹æˆ‘èƒƒå£çš„ä¸»è¦æ˜¯ã€Œæ—¶é—´æˆæœ¬ã€å°èŠ‚çš„æè¿°ï¼š é€‰æ‹©å¤ªå¤šï¼Œç”¨æˆ·å†³ç­–ç˜«ç—ªï¼Œè‡ªå·±é€‰æ‹©çš„æ—¶é—´æˆæœ¬å¢åŠ ï¼Œæ„¿æ„é€šè¿‡ä»˜è´¹æ¥ä»£æ›¿ä¸ªäººæœå¯»é€‰æ‹©ï¼Œè¿™ä½¿çŸ¥è¯†ä»˜è´¹æˆä¸ºå¯èƒ½ã€‚ è¿™å¥è¯ä»æŠ€æœ¯ä»ä¸šè€…çš„è§’åº¦æ¥è®²ä¹Ÿæ˜¯é€‚ç”¨çš„ï¼Œæˆ‘ç›¸ä¿¡ä¹ŸæœŸæœ›æ‰€æœ‰çŸ¥è¯†ä»˜è´¹çš„ä»˜è´¹è€…éƒ½å…·å¤‡ä¸€å®šçš„å†…å®¹è¯†åˆ«èƒ½åŠ›ï¼Œå³è‡ªå·±å¯ä»¥è¾¨åˆ«æ–‡ç« /éŸ³é¢‘/è§†é¢‘ç­‰åª’ä»‹ä¼ æ’­çš„å†…å®¹è´¨é‡ã€‚ æ­£å‘æ¿€åŠ±éšç€äº’è”ç½‘è¶Šæ¥è¶Šå‘è¾¾ï¼Œå„ç§ç¢ç‰‡åŒ–çš„æ•™ç¨‹ç±»æ–‡ç« /éŸ³é¢‘/è§†é¢‘è¶Šæ¥è¶Šå¤šï¼Œè¾¨åˆ«è¿™äº›åª’ä»‹å†…å®¹è´¨é‡å¹¶è¿‡æ»¤å‡ºå¯¹è‡ªå·±æœ‰ç”¨çš„å†…å®¹è¿™ä»¶äº‹å„¿çš„æ—¶é—´æˆæœ¬è¶Šæ¥è¶Šå¤§äº†â€¦ é—æ†¾çš„æ˜¯ï¼Œä¹‹å‰è‡ªå·±åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­å¥½ä¸å®¹æ˜“æ”¶é›†å’Œè®¢é˜…çš„å„ç§ç‰›äººçš„åšå®¢æ›´æ–°é¢‘ç‡è¶Šæ¥è¶Šä½äº†ï¼Œç”šè‡³æœ‰äº›ä»¥åŠåœæ›´äº†ã€‚ä¸€ç§å¯èƒ½æ˜¯è¿™äº›è‡ªå·±å–œæ¬¢çš„äººä»–ä»¬çœŸçš„è¶Šæ¥è¶Šå¿™æ‰€ä»¥æ²¡æœ‰æ—¶é—´æ¥å†™æ–‡ç« åˆ†äº«äº†ï¼Œå¦å¤–ä¸€ç§å¯èƒ½å°±æ˜¯ç¼ºä¹æ­£å‘æ¿€åŠ±ã€‚ åšæŠ€æœ¯æ‰‹è‰ºäººåœ¨ä¸­å›½ç‰¹è‰²å›½æƒ…ä¸‹å…¶å®è¿˜æ˜¯è›®ç„¦è™‘çš„ï¼Œå³ä¾¿æ˜¯åšåˆ°äº†ä¸“å®¶ Title å¸¦äº†å›¢é˜Ÿä¹‹åè¿™ç§ç„¦è™‘ä¹Ÿä¼šå­˜åœ¨ï¼Œç”šè‡³éšç€å¹´é¾„çš„æå‡è€Œé€æ¸å¢å¤§ã€‚è¿™ç§æƒ…å†µä¸‹æœ‰äº›èªæ˜äººè¸©å¯¹äº†æ—¶ä»£çš„èŠ‚å¥ï¼Œåšç‹¬ç«‹å¼€å‘ï¼Œå°‘æ•°äººåšæŒå¹¶æˆåŠŸäº†ï¼Œç›¸å½“äºæœ‰äº†è‡ªå·±çš„äº‹ä¸šï¼›å¦å¤–ä¸€éƒ¨åˆ†äººä¹Ÿæ¸´æœ›æœ‰è‡ªå·±çš„äº‹ä¸šï¼Œä½†æ˜¯è¿™æ¯•ç«Ÿä¸å¯å¼ºæ±‚ï¼Œæ‰€ä»¥åªæœ‰ä¸¤ç§é€‰æ‹©ï¼š æ·±åº¦ä¼˜å…ˆï¼ŒæŒç»­æ·±å…¥è‡ªå·±çš„å·¥ä½œé¢†åŸŸï¼Œæ·±è€•å¹¶ä¿æŒåˆ†äº«è¾“å‡ºï¼Œä¿æŒä¸šç•Œå½±å“åŠ›åœ¨ä¸šç•Œæ‰æ ¹ å¹¿åº¦ä¼˜å…ˆï¼Œåšå…¶ä»–å‰¯ä¸šï¼Œç”šè‡³ç¾¤é‡Œæœ‰æœ‹å‹è½¬ PM å¾ˆå¤šçœŸæ­£å–œæ¬¢ç¼–ç¨‹çš„äººéƒ½æ›´å€¾å‘äºç¬¬ä¸€ç§é€‰æ‹©ï¼Œä½†æ˜¯ä¸€ç›´ç”¨å¿ƒå†™çš„æŠ€æœ¯æ–‡ç« è¢«å„ç§æ— è‰¯ç½‘ç«™å’Œå…¬ä¼—å·å‰½çªƒèµ°ç”šè‡³è¢«ã€Œå¥—å¨ƒã€ï¼Œè¿˜æ˜¯æŒºè®©äººä¼¤å¿ƒå’Œæ‰“å‡»äººç§¯ææ€§çš„ã€‚å› æ­¤å¾ˆå¤šæŠ€æœ¯å¤§ä½¬ä»¬çº·çº·è½¬æŠ•çŸ¥è¯†ä»˜è´¹é¢†åŸŸï¼Œå°†è‡ªå·±ç”¨å¿ƒå†™çš„å†…å®¹ä»˜è´¹ä¼ æ’­ï¼Œå…¶ä¸­ä¸ä¹ä¸€äº› Level å¾ˆé«˜çš„å¤§å‚ä¸“å®¶ Title çš„ç‰›äººã€‚å…¶å®è¿™äº›äººçš„è–ªèµ„å¹¶ä¸ä½ï¼Œä»ä¸“æ å®šä»·å’Œä»˜è´¹ç”¨æˆ·æ•°é‡æ¥çœ‹ç®—ä¸€ç®—ä¹Ÿä¸ä¸€å®šæœ‰ä¸€ä¸ªæœˆå·¥èµ„çš„æ”¶ç›Šï¼Œæˆ‘ç†è§£æ›´å¤šçš„æ˜¯å€ŸåŠ©çŸ¥è¯†ä»˜è´¹å¯¹è‡ªå·±äº§ç”Ÿæ­£å‘æ¿€åŠ±è®©è‡ªå·±ä¿æŒåˆ†äº«è¾“å‡ºã€‚ å•†ä¸šåŒ–æ¶‰åŠä»˜è´¹å°±æœ‰åˆ©ç›Šï¼Œæœ‰åˆ©ç›Šçš„åœ°æ–¹å°±æœ‰å•†æœºï¼Œæ‰€ä»¥çŸ¥è¯†ä»˜è´¹ç»å†æ•°å¹´ä¹‹åæ…¢æ…¢æœ‰äº†æˆç†Ÿçš„ä½“ç³»ã€‚ å•†ä¸šåŒ–çš„åŠ å…¥å–œå¿§å‚åŠï¼š å¥½å¤„æ˜¯æœ‰ä¸“ä¸šçš„å•†ä¸šå›¢é˜Ÿå¸®åŠ©çœŸæ­£æƒ³è¦åœ¨è‡ªå·±é¢†åŸŸæ·±è€•å¹¶æ‰æ ¹çš„æŠ€æœ¯æ‰‹è‰ºäººåšæ¨å¹¿ï¼Œè®©æ›´å¤šä¼˜ç§€çš„å†…å®¹å’Œåˆ›ä½œè€…è¢«äººçŸ¥æ™“ åå¤„æ˜¯å•†ä¸šå›¢é˜Ÿç¼ºä¹å†…å®¹æŠŠæ§ï¼Œå†…å®¹è´¨é‡å‡ºç°ä¸‹é™ï¼Œä¸å°‘ä»˜è´¹ç”¨æˆ·è¡¨ç¤ºè¢«å½“æˆäº†ã€ŒæŠ€æœ¯éŸ­èœã€ï¼Œè¢«æ”¶äº†æ™ºå•†ç¨ï¼Œéå¸¸ä¼¤å¿ƒ æˆ‘è§‰å¾—ç›®å‰å›½å†…åšçš„æ¯”è¾ƒå¥½çš„å¹³å°å°±æ˜¯ã€Œæå®¢æ—¶é—´ã€äº†ï¼Œå…¶ä»–çš„å¹³å°ä¹Ÿæœ‰æ¯”è¾ƒå°ä¼—åšçš„ä¸é”™çš„æ¯”å¦‚ã€Œå°ä¸“æ ã€ã€‚ä¸è¿‡å¹³å°ä¸é‡è¦ï¼Œå†…å®¹è¿™å—æˆ‘è§‰å¾—æ›´å¤šçš„æ˜¯çœ‹å‡†å†…å®¹åˆ›ä½œè€…æœ¬èº«ï¼Œé«˜è´¨é‡å†…å®¹çš„åˆ›ä½œè€…æ— è®ºæ˜¯åœ¨å“ªä¸ªå¹³å°éƒ½ä¼šå¯¹è‡ªå·±ä¸¥æ ¼è¦æ±‚çš„ï¼Œè¿™ç§äººä¹Ÿä¼šæ¯”è¾ƒæœ‰å£ç¢‘å¹¶çœ‹ä¸­è‡ªå·±çš„å£ç¢‘ï¼Œä¹…è€Œä¹…ä¹‹å°±æ ‘ç«‹èµ·äº†ä¸ªäººå“ç‰Œï¼Œéå¸¸ä¸å®¹æ˜“ã€‚ æ€»ç»“Emmmmmâ€¦è²Œä¼¼ä¹Ÿæ²¡ä»€ä¹ˆå¥½æ€»ç»“çš„ï¼Œå¦‚ä½ æ‰€è§è¿™æ˜¯ä¸€ç¯‡å¹æ°´æ–‡ã€‚ å¦‚æœä½ æƒ³ç³»ç»Ÿå…¨é¢çš„å­¦ä¹ ä¸€äº›ç»å…¸åŸºç¡€çŸ¥è¯†ï¼Œæˆ‘å»ºè®®ç›´æ¥ä¹°ä¹¦ï¼Œæ¯”å¦‚æƒ³å­¦æ“ä½œç³»ç»Ÿæ¨èä¹°ã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿã€‹ï¼Œè¿™ç§å£ç¢‘çˆ†è¡¨ä¸”ç»å…¸çš„æ•™æç±»ä¹¦ç±æ˜¯æˆ‘è¿™è¾¹çš„ä¸äºŒæ¨èï¼›å¦‚æœä½ æƒ³å¿«é€Ÿç³»ç»Ÿçš„æŒæ¡ä¸€äº›æ–°è¿›æŠ€æœ¯ï¼Œæˆ‘å»ºè®®å¯ä»¥å°è¯•ä»çŸ¥è¯†ä»˜è´¹é¢†åŸŸä¸‹æ‰‹ã€‚"},{"title":"Flutter çŠ¶æ€ç®¡ç† 0x00 - åŸºç¡€çŸ¥è¯†åŠ State.setState èƒŒåé€»è¾‘","comments":true,"permalink":"https://lision.me/flutter-state-management_0x00/","text":"å‰è¨€ Emmmmmâ€¦æ­£å¼å¼€å§‹æ–‡ç« å‰å…ˆäº¤ä»£ä¸ªäº‹å„¿ï¼Œ2019 å¼€å¹´è®¡åˆ’é‚£ç¯‡æ–‡ç« è¢«æˆ‘åˆ äº†ã€‚åŸå› æ²¡å•¥ç‰¹åˆ«çš„ï¼Œå°±çœŸçš„åªæ˜¯è„¸ç–¼â€¦ å˜›ï½ å¥½ä¹…æ²¡æ›´ Blog äº†ï¼Œæœ€è¿‘ç¬”è€…æ­£åœ¨å­¦ä¹  Flutter ç›¸å…³çš„çŸ¥è¯†ï¼ˆè²Œä¼¼ç°åœ¨å­¦ä¹Ÿä¸ç®—ç‰¹åˆ«æ™šï¼‰ï¼Œæ‰€ä»¥åç»­å¯èƒ½ä¼šæœ‰ä¸€æ³¢è¿ç»­çš„ Flutter ç›¸å…³çš„æ›´æ–°ï¼ˆå…³é”®å­—å·²åŠ ç²— ğŸ˜‚ï¼‰ã€‚ å› ä¸ºä¹‹å‰æˆ‘çš„æ–‡ç« å¤§å¤šæ˜¯æºç å‰–æç›¸å…³çš„ï¼Œæ‰€ä»¥è¿™æ¬¡å†³å®šæ¢ç§æ–¹å¼å…ˆä» Flutter å¼€å‘çš„çŠ¶æ€ç®¡ç†èŠèµ·ã€‚ç”±äºä¸ªäººèƒ½åŠ›ä¸è¶³ã€æ°´å¹³æœ‰é™ï¼Œæ–‡ç« ä¸­éš¾å…æœ‰çº°æ¼å’Œè°¬è¯¯ï¼ŒåŠ ä¸Šå·¥ä½œç¡®å®æ¯”è¾ƒå¿™å¯èƒ½æ²¡æœ‰æ—¶é—´æ ¡éªŒï¼Œå¸Œæœ›å‘ç°çš„æœ‹å‹èƒ½å¤Ÿåœ¨æ–‡ç« ä¸‹æ–¹è¯„è®ºäº¤æµè®¨è®ºï¼ˆä¸»è¦æ˜¯é¿å…è¯¯äººå­å¼Ÿï¼Œä¸è¿‡è¯„è®ºåº”è¯¥éœ€è¦ç§‘å­¦ä¸Šç½‘ï¼‰ã€‚ æœ¬æ–‡ä¼šç®€å•ä»‹ç» Flutter ä»¥åŠå£°æ˜å¼ç¼–ç¨‹æ€æƒ³å’Œä»£ç ç”»é£ï¼Œå¯¹æ¯” StatelessWidget &amp; StatefulWidget è¿™ä¸¤ä¸ªé‡è¦çš„ Widgetï¼Œå†èŠèŠ setState èƒŒåçš„é‚£äº›äº‹å„¿ã€‚ ç´¢å¼• Flutter ç®€ä»‹ å£°æ˜å¼ UI &amp; å“åº”å¼ç¼–ç¨‹ Flutter å¦‚ä½•æ¸²æŸ“ Widget StatelessWidget &amp; StatefulWidget State.setState èƒŒåçš„é‚£äº›äº‹å„¿ Flutter ç®€ä»‹ Flutter æ˜¯ Google å¼€æºçš„ UI å·¥å…·åŒ…ï¼Œå¸®åŠ©å¼€å‘è€…é€šè¿‡ä¸€å¥—ä»£ç åº“é«˜æ•ˆæ„å»ºå¤šå¹³å°ç²¾ç¾åº”ç”¨ï¼Œæ”¯æŒç§»åŠ¨ã€Webã€æ¡Œé¢å’ŒåµŒå…¥å¼å¹³å°ã€‚ ã€ŒWrite once, run anywhere.ã€å§‹ç»ˆæ˜¯å¤§å‰ç«¯å¼€å‘ä¹ƒè‡³æ•´ä¸ªç¨‹åºç•Œçš„ä¸€ä¸ªæ°¸æ’çš„è¯é¢˜ã€‚è¯šç„¶ Flutter çš„ç›®æ ‡ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä¸è¿‡å®ƒä¸ä¹‹å‰ä¸šç•Œå·²ç»å­˜åœ¨çš„ React Nativeã€Xamarinã€Hybrid ç­‰æ¡†æ¶æœ‰ä½•ä¸åŒï¼Ÿ ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ° Flutter çš„è®¾è®¡æ•´ä½“ä¸Šæœ‰ä¸‰å±‚æŠ½è±¡ï¼š æœ€ä¸Šå±‚ Framework å°è£…å¥½äº† Material å’Œ Cupertino è¿™ä¸¤ç§åˆ†åˆ«å¯¹åº” Android å’Œ iOS å®˜æ–¹è®¾è®¡é£æ ¼çš„ UI åº“ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜åŒ…å«äº†æ¸²æŸ“ã€åŠ¨ç”»ã€ç»˜åˆ¶ã€æ‰‹åŠ¿ç­‰ç­‰ï¼Œè¿™ä¸€å±‚ä¸»è¦æ˜¯æä¾›ç»™å¼€å‘è€…ä¾¿æ·æ„å»º App ä½¿ç”¨çš„ï¼Œå…¶åœ¨å¼€å‘æ—¶ä¸º JITã€å‘å¸ƒæ—¶ä¸º AOT çš„ç‰¹æ€§å…¼é¡¾äº†å¼€å‘è°ƒè¯•çš„ä¾¿æ·ä¸çº¿ä¸Šè¿è¡Œçš„é«˜æ€§èƒ½ï¼› Engine ä½œä¸ºä¸­é—´å±‚ï¼Œä½¿ç”¨ C/C++ å®ç°äº†ä¸€å¥—é«˜æ€§èƒ½ã€å¯ç§»æ¤çš„ Runtimeï¼Œå±è”½äº†å¹³å°é—´å·®å¼‚çš„åŒæ—¶æ”¯æ’‘äº†ä¸Šå±‚çš„ Flutter åº”ç”¨ã€‚ Embedder ç”±å¹³å°æŒ‡å®šè¯­è¨€å®ç°ï¼Œæä¾›äº† Flutter æ‰€éœ€çš„äº‹ä»¶å¾ªç¯ã€çº¿ç¨‹ã€æ¸²æŸ“ç­‰åŸºç¡€ APIã€‚ Flutter é€šè¿‡è¿™å¥—æœºåˆ¶æ¥ç®¡äº†æœ€åº•å±‚çš„ç³»ç»Ÿæ¥å£ï¼Œæä¾›äº†ä¸€æ•´å¥—ä»åº•å±‚æ¸²æŸ“é€»è¾‘åˆ°ä¸Šå±‚å¼€å‘è¯­è¨€çš„å®Œæ•´è§£å†³æ–¹æ¡ˆï¼Œä½¿å¾—å®ƒæœ‰ç€è¶…è¶Š React Native çš„é«˜ä¿çœŸã€å¤šç«¯ä¸€è‡´çš„ä½“éªŒï¼Œå’Œè¶…è¶Š Web å®¹å™¨çš„é«˜æ€§èƒ½æ¸²æŸ“èƒ½åŠ›ã€‚ å£°æ˜å¼ UI &amp; å“åº”å¼ç¼–ç¨‹å£°æ˜å¼ UI è¿™å¼ å›¾å¾ˆå¥½çš„æè¿°äº†å£°æ˜å¼ UI çš„æ ¸å¿ƒæ€æƒ³ï¼Œç®€å•æ¥è¯´å°±æ˜¯é€šè¿‡ state ä½œä¸ºå…¥å‚æ ¹æ®å·²ç»å†™å¥½çš„æ„å»º func å°±èƒ½å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ UI æ•ˆæœã€‚ä¸¾ä¸ª ğŸŒ° æ›´ç›´è§‚ï¼š é»˜è®¤çš„ Flutter Demo ç•Œé¢ï¼š å¯¹åº”çš„ä»£ç ï¼š 12345678910111213141516171819202122232425return Scaffold( appBar: AppBar( title: Text(widget.title), ), body: Center( child: Column( mainAxisAlignment: MainAxisAlignment.center, children: &lt;Widget&gt;[ Text( &#x27;You have pushed the button this many times:&#x27;, ), Text( &#x27;$_counter&#x27;, style: Theme.of(context).textTheme.display1, ), ], ), ), floatingActionButton: FloatingActionButton( // _incrementCounter å†…éƒ¨é€»è¾‘å¯å¿½ç•¥ onPressed: _incrementCounter, tooltip: &#x27;Increment&#x27;, child: Icon(Icons.add), ),); In flutter, everything is a widget. Emmmmmâ€¦å¯ä»¥æ³¨æ„åˆ°ä¸Šé¢çš„ä»£ç ä¸­ children: &lt;Widget&gt;[...] ä¸€è¡Œï¼ŒFlutter å¼€å‘ä¸­å°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼åµŒå¥—ç»„åˆ Widget æ¥æè¿°ç”¨æˆ·ç•Œé¢çš„ã€‚ä»è¿™ä¸€è§’åº¦è®²ï¼ŒWidget æ˜¯å¯¹ä¸€éƒ¨åˆ†ç”¨æˆ·ç•Œé¢çš„ä¸å¯å˜æè¿°ã€‚ é»˜è®¤çš„ Flutter Demo è·‘èµ·æ¥å¾ˆç®€å•ï¼Œæ¨èå¤§å®¶äº²èº«ä½“éªŒã€‚ç®€å•è¯´ä¸€ä¸‹æˆ‘çš„æ„Ÿå—ï¼Œå£°æ˜å¼ UI çš„ä¼˜åŠ¿å¾ˆå¤§ï¼Œå…·ä½“è¡¨ç°ä¸ºåªéœ€è¦åœ¨å†™ UI æ—¶å°†ä¸åŒ state å¯¹åº”çš„ UI å±•ç¤ºè€ƒè™‘å¹¶æè¿°æ¸…æ¥šå°±å¯ä»¥çœå»åç»­ state å˜æ›´æ—¶å‘½ä»¤å¼ UI éœ€è¦æ‰‹åŠ¨ç®¡ç†è§†å›¾å±‚çº§ï¼ˆæ–°å¢æˆ–åˆ é™¤è§†å›¾å…ƒç´ ï¼‰å’Œæ›´æ–°å±æ€§ï¼ˆé¢œè‰²ã€å­—å·ç­‰ï¼‰ç­‰éº»çƒ¦ã€‚ å€¼å¾—ä¸€æçš„æ˜¯ SwiftUI ä¹Ÿä½¿ç”¨äº†å£°æ˜å¼ UI çš„æ€æƒ³ï¼ˆå£°æ˜å¼ UI æ‰æ˜¯æœªæ¥ï¼‰ã€‚ å“åº”å¼ç¼–ç¨‹ å“åº”å¼ç¼–ç¨‹ ï¼Œåœ¨è®¡ç®—æœºé¢†åŸŸï¼Œå“åº”å¼ç¼–ç¨‹æ˜¯ä¸€ä¸ªä¸“æ³¨äºæ•°æ®æµå’Œå˜åŒ–ä¼ é€’çš„å¼‚æ­¥ç¼–ç¨‹èŒƒå¼ã€‚è¿™æ„å‘³ç€å¯ä»¥ä½¿ç”¨ç¼–ç¨‹è¯­è¨€å¾ˆå®¹æ˜“åœ°è¡¨ç¤ºé™æ€ï¼ˆä¾‹å¦‚æ•°ç»„ï¼‰æˆ–åŠ¨æ€ï¼ˆä¾‹å¦‚äº‹ä»¶å‘å°„å™¨ï¼‰æ•°æ®æµï¼Œå¹¶ä¸”åœ¨å…³è”çš„æ‰§è¡Œæ¨¡å‹ä¸­ï¼Œå­˜åœ¨ç€å¯æ¨æ–­çš„ä¾èµ–å…³ç³»ï¼Œè¿™ä¸ªå…³ç³»çš„å­˜åœ¨æœ‰åˆ©äºè‡ªåŠ¨ä¼ æ’­ä¸æ•°æ®æµæœ‰å…³çš„æ›´æ”¹ã€‚ å“åº”å¼ç¼–ç¨‹å¯¹äºå¤§å®¶æ¥è¯´åº”è¯¥æ—©å·²ä¸æ˜¯ä»€ä¹ˆæ–°é²œäº‹ç‰©äº†ï¼Œå•åœ¨ç§»åŠ¨å®¢æˆ·ç«¯é¢†åŸŸå°±æœ‰è¯¸å¦‚ ReactiveCocoaã€RxSwiftã€RxJavaã€RxXxxâ€¦ç®€å•æ¥è¯´è¿™ç§ç¼–ç¨‹æ€æƒ³æˆ–è€…è¯´èŒƒå¼ä¸‹å¼€å‘è€…åªéœ€å…³æ³¨å¯èƒ½å­˜åœ¨çš„æ•°æ®çŠ¶æ€ä»¥åŠä¸ä¹‹å¯¹åº”çš„é€»è¾‘ä»è€Œå¤§å¤§å‡è½»äº†ç»´æŠ¤è¿™äº›å¯¹åº”å…³ç³»ä¸çŠ¶æ€ç»†èŠ‚çš„å·¥ä½œè´Ÿæ‹…ã€‚å› ä¸ºç”¨è¿‡çš„äººéƒ½è¯´å¥½ï¼Œæ‰€ä»¥ç›®å‰æ¸æ¸è¢«æ¨ä¸ºç§»åŠ¨å®¢æˆ·ç«¯ä¹ƒè‡³æ•´ä¸ªå¤§å‰ç«¯çš„ä¸»æµç¼–ç¨‹æ€æƒ³ã€‚ ä¸éš¾çœ‹å‡ºå…¶å®å£°æ˜å¼ UI å’Œå“åº”å¼ç¼–ç¨‹ä»æ€æƒ³ä¸Šæ˜¯å®Œå…¨å¥‘åˆçš„ï¼Œæˆ‘ä»¬åªéœ€è¦å°†æ•°æ®æµå¯¹åº”åˆ° UI=f(state) å…¬å¼ä¸­çš„ state å°±å¯ä»¥äº†ã€‚ Flutter å¦‚ä½•æ¸²æŸ“ Widget åœ¨ä»‹ç» StatelessWidget ä¸ StatefulWidget ä¹‹å‰å…ˆè¦äº†è§£ä¸€ä¸‹ Flutter çš„æ¸²æŸ“æ¨¡å‹ï¼Œç®€å•æ¥è®² Flutter åœ¨æ¸²æŸ“ Widget æ—¶ç”¨åˆ°ä¸‰æ£µæ ‘ï¼š Widgetï¼Œè´Ÿè´£æè¿° Element çš„é…ç½®ã€‚ Elementï¼Œè´Ÿè´£ç®¡ç† Widget å’Œ RenderObject çš„ç”Ÿå‘½å‘¨æœŸã€‚ RenderObjectï¼Œè´Ÿè´£æ§åˆ¶å°ºå¯¸ï¼Œå¸ƒå±€å’Œç»˜åˆ¶å·¥ä½œã€‚ ä¸€è¨€ä»¥è”½ä¹‹ï¼ŒElement ä¼šæ ¹æ®æˆ‘ä»¬ä¹¦å†™çš„ Widget å¯¹å…¶çš„é…ç½®æè¿°æ¥ç”Ÿæˆå¹¶ç®¡ç†å¯¹åº”çš„ Element ä¸ RenderObjectï¼Œç”± RenderObject è´Ÿè´£æœ€ç»ˆçš„ç»˜åˆ¶å·¥ä½œã€‚ NOTE: Element ä¼šæ ¹æ® Widget çš„æè¿°æœ€å¤§ç¨‹åº¦å¤ç”¨ç°æœ‰ Element ä¸ RenderObject ä»¥æå‡æ€§èƒ½ã€‚ StatelessWidget &amp; StatefulWidgetStatelessWidget StatelessWidget, A widget that does not require mutable state. StatelessWidget å¦‚å…¶å Statelessï¼Œå®ƒä¸éœ€è¦è¿½è¸ª State å¹¶æ ¹æ® State æ›´æ–° UIï¼Œæ‰€ä»¥ä¸€èˆ¬ StatelessWidget å†…éƒ¨çš„å±æ€§ç”¨ final ä¿®é¥°å£°æ˜ä¸”æ„é€ æ–¹æ³•ä¸€èˆ¬ä»¥ const ä¿®é¥°ã€‚ NOTE: const ä¿®é¥°çš„ Widget æ„é€ æ–¹æ³•ä½¿ç”¨æ—¶å¯ä»¥ææ•ˆã€‚ StatefulWidget StatefulWidget, A widget that has mutable state. StatefulWidget ä¸ StatelessWidget ä¸€æ ·ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸€ç³»åˆ—ï¼ˆç»„åˆåµŒå¥—ï¼‰å…¶ä»–æ›´å…·ä½“æè¿° UI çš„ Widgetï¼ˆæ¯”å¦‚ Textï¼‰æ¥æ„å»ºéƒ¨åˆ†ç”¨æˆ·ç•Œé¢ã€‚åŒºåˆ«åœ¨äº Statefulï¼Œå³å®ƒéœ€è¦è¿½è¸ª State å¹¶æ ¹æ® State æ›´æ–° UIã€‚ åŒºåˆ«StatelessWidget ä¸ StatefulWidget å¤§æ¦‚æ˜¯æˆ‘ä»¬ç”¨ Flutter æŠ€æœ¯æ ˆå¼€å‘ App æ—¶æœ€å¸¸æ‰“äº¤é“çš„ä¸¤ä¸ª Widget äº†ã€‚ å…±åŒç‚¹ï¼š è¿™ä¸¤ä¸ª Widget éƒ½å¯ä»¥ç”¨æ¥é€šè¿‡å¯¹å…¶ä»–ä¸€ç³»åˆ— Widget æ„å»ºå®Œæˆä¸€éƒ¨åˆ†ç”¨æˆ·ç•Œé¢çš„å°è£…ã€‚ ä¸åŒç‚¹ï¼š StatelessWidget æ›´é€‚ç”¨äºä¸€äº›ä¸éœ€é€šè¿‡ç”¨æˆ·äº¤äº’æˆ–å…¶ä»–åŸå› é€šè¿‡ State æ§åˆ¶æ›´æ–°çš„ UI å°è£…ã€‚ StatefulWidget æ›´é€‚ç”¨äºè¿½è¸ªæŸä¸ªä¼šæ ¹æ®ç”¨æˆ·äº¤äº’æˆ–å…¶ä»–å› ç´ å½±å“çš„ Stateï¼Œå¹¶æ ¹æ®æœ€æ–°çš„ State å®æ—¶æ›´æ–°çš„ UI å°è£…ã€‚ æ­¤å¤–ï¼ŒFlutter å¯¹äº StateLessWidget ä¸ StatefulWidget çš„ç»˜åˆ¶ä¹Ÿæœ‰å·®å¼‚ï¼š StatelessWidget é€šè¿‡ StatelessElement.build è§¦å‘ build StatefulWidget é€šè¿‡ StatefulElement.build è§¦å‘ State.build State.setState èƒŒåçš„é‚£äº›äº‹å„¿ NOTE: ä¸‹é¢åˆ†æçš„ State.setState æºç ç‰ˆæœ¬ä¸º Flutter SDK v1.9.1+hotfix.6ã€‚ æˆ‘ä»¬è¿˜ä»¥ Flutter é»˜è®¤ Demo æ¥åˆ†æï¼Œåœ¨ Demo ä¸­æˆ‘ä»¬ç‚¹å‡»ç•Œé¢å³ä¸‹è§’çš„ FloatingActionButton (å°±æ˜¯è“è‰²å¸¦æœ‰ + å·çš„åœ†å½¢æŒ‰é’®)ä¹‹åä¼šåˆ·æ–°ç•Œé¢ï¼Œå±å¹•ä¸­é—´çš„ Text Widget ä¼šæ˜¾ç¤ºæŒ‰é’®è¢«æŒ‰ä¸‹çš„æ¬¡æ•°ã€‚ FloatingActionButton ç‚¹å‡»ä¹‹åè°ƒç”¨äº† _incrementCounter æ–¹æ³•ï¼š 12345678910class _MyHomePageState extends State&lt;MyHomePage&gt; &#123; int _counter = 0; void _incrementCounter() &#123; setState(() &#123; _counter++; &#125;); &#125; ...&#125; _MyHomePageState._incrementCounter å†…éƒ¨é€»è¾‘ä¹Ÿä»…ä»…æ˜¯è°ƒç”¨äº† State.setState è€Œå·²ã€‚æ­£å¦‚ Flutter æ‰€å®£ä¼ çš„å…¬å¼ UI = f(state) ä¸€æ ·ï¼Œå¼€å‘è€…åªéœ€è¦è°ƒç”¨ State.setState ä¼ å…¥ VoidCallback å†…éƒ¨å†™å¥½ç›¸å…³æ•°æ®æ›´æ–°é€»è¾‘å³å¯æ›´æ–° UIï¼Œé‚£ä¹ˆ Flutter æ˜¯å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹çš„å‘¢ï¼Ÿ State.setState èƒŒåé€»è¾‘ State.setState èƒŒåè°ƒç”¨åµŒå¥—è¾ƒå¤šï¼Œå®é™…æ‰€åšçš„äº‹æƒ…ç†è§£èµ·æ¥å´å¾ˆç®€å•ã€‚å¦‚ä¸å–œåœ¨æ–‡å†…é˜…è¯»æºç å¯ç›´æ¥è·³è½¬è‡³ã€Œæ€»ç»“ State.setState èƒŒåé€»è¾‘ã€å°èŠ‚çœ‹ç›¸å…³é€»è¾‘æ€»ç»“ã€‚ State.setState123456789101112@optionalTypeArgsabstract class State&lt;T extends StatefulWidget&gt; extends Diagnosticable &#123; ... @protected void setState(VoidCallback fn) &#123; // assert ... final dynamic result = fn() as dynamic; // assert ... _element.markNeedsBuild(); &#125; ...&#125; å¯è§ State.setState å†…é™¤å»æ–­è¨€çš„é€»è¾‘åªæœ‰ä¸¤è¡Œä»£ç ï¼š æ‰§è¡Œå…¥å‚ VoidCallback é€»è¾‘ï¼ŒDemo ä¸­å¯¹åº” _counter++; æ‰§è¡Œ _element.markNeedsBuild(); Element.markNeedsBuild1234567891011121314abstract class Element extends DiagnosticableTree implements BuildContext &#123; ... void markNeedsBuild() &#123; // assert ... if (!_active) return; // assert ... if (dirty) return; _dirty = true; owner.scheduleBuildFor(this); &#125; ...&#125; Element.markNeedsBuild å†…éƒ¨çš„é€»è¾‘ä¹Ÿå¾ˆç®€å•æ˜äº†ï¼š å¦‚æ­¤ Element ä¸å†æ´»è·ƒåˆ™ç›´æ¥ return æ— éœ€åšä»»ä½•äº‹ å¦‚æ­¤ Element å·²ç»è¢«æ ‡è®°ä¸º dirty ä¹Ÿæ— éœ€é‡å¤æ ‡è®°ç›´æ¥ return ä»¥ä¸Šæ¡ä»¶ä¸æ»¡è¶³æ—¶è¯´æ˜æ­¤ Element æ˜¯æ´»è·ƒä¸”éœ€è¦é‡æ–°æ„å»ºçš„ï¼Œæ‰€ä»¥æ ‡è®°ä¸º dirty åè°ƒç”¨ owner.scheduleBuildFor(this); BuildOwner.scheduleBuildFor1234567891011121314class BuildOwner &#123; ... void scheduleBuildFor(Element element) &#123; // assert ... if (!_scheduledFlushDirtyElements &amp;&amp; onBuildScheduled != null) &#123; _scheduledFlushDirtyElements = true; onBuildScheduled(); &#125; _dirtyElements.add(element); element._inDirtyList = true; // assert ... &#125; ...&#125; BuildOwner.scheduleBuildFor(this); å†…éƒ¨é€»è¾‘ä¹Ÿä¸å¤æ‚ï¼š !_scheduledFlushDirtyElements &amp;&amp; onBuildScheduled != null å¯ä»¥ç†è§£ä¸ºå¦‚æœè¿˜æ²¡æœ‰å®‰æ’è¿‡åˆ·æ–°æ­¤ BuildOwner ä¸‹è¢«æ ‡è®°ä¸º Dirty çš„ Elements ä¸”å®‰æ’æ„å»ºçš„é€»è¾‘ä¸ä¸ºç©ºï¼Œæ»¡è¶³ä»¥ä¸Šæ¡ä»¶åˆ™å°†æ­¤ BuildOwner å®‰æ’åˆ·æ–° Dirty Elements çš„æ ‡è®°ç½®ä¸º true å°†ä¼ å…¥çš„ Element åŠ å…¥æ­¤ BuildOwner ç®¡ç†çš„ _dirtyElements å¹¶å°†æ­¤ Element _inDirtyList æ ‡è®°ä¸º true BuildOwner.onBuildScheduledå…¶å® onBuildScheduled(); è·Ÿä¸‹å»æ˜¯ BuildOwner å†…éƒ¨å±æ€§ onBuildScheduledï¼Œç±»å‹ä¸º VoidCallbackï¼Œåœ¨ WidgetsBinding.initInstances æ—¶è¢«èµ‹å€¼ä¸º WidgetsBinding._handleBuildScheduled: 12345678910mixin WidgetsBinding on BindingBase, SchedulerBinding, GestureBinding, RendererBinding, SemanticsBinding &#123; ... @override void initInstances() &#123; ... buildOwner.onBuildScheduled = _handleBuildScheduled; ... &#125; ...&#125; WidgetsBinding å¯ä»¥ç†è§£ä¸º Widget å±‚ä¸ Flutter engine ä¹‹é—´çš„èƒ¶æ°´å±‚ï¼Œç¯‡å¹…åŸå› ä¸å±•å¼€è®²ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ WidgetsBinding._handleBuildScheduledã€‚ 12345678mixin WidgetsBinding on BindingBase, SchedulerBinding, GestureBinding, RendererBinding, SemanticsBinding &#123; ... void _handleBuildScheduled() &#123; // assert ... ensureVisualUpdate(); &#125; ...&#125; SchedulerBinding.ensureVisualUpdate12345678910111213141516mixin SchedulerBinding on BindingBase, ServicesBinding &#123; ... void ensureVisualUpdate() &#123; switch (schedulerPhase) &#123; case SchedulerPhase.idle: case SchedulerPhase.postFrameCallbacks: scheduleFrame(); return; case SchedulerPhase.transientCallbacks: case SchedulerPhase.midFrameMicrotasks: case SchedulerPhase.persistentCallbacks: return; &#125; &#125; ...&#125; è¿™é‡Œé€šè¿‡å½“å‰ SchedulerPhase çš„çŠ¶æ€è¿›è¡Œå–èˆï¼Œä»…åœ¨ SchedulerPhase.idle &amp; SchedulerPhase.postFrameCallbacks æ—¶è°ƒç”¨ scheduleFrame();ã€‚ SchedulerPhase.scheduleFrame1234567891011mixin SchedulerBinding on BindingBase, ServicesBinding &#123; ... void scheduleFrame() &#123; if (_hasScheduledFrame || !_framesEnabled) return; // assert ... window.scheduleFrame(); _hasScheduledFrame = true; &#125; ...&#125; è¿™é‡Œçš„é€»è¾‘æ›´ç®€å•ï¼š _hasScheduledFrame || !_framesEnabled å¯ç†è§£ä¸ºå¦‚æœå·²ç»å®‰æ’è¿‡ Frame æˆ–å½“å‰ Frame ä¸å¯ç”¨ï¼Œè¿™ç§æƒ…å†µç›´æ¥ return ä¸æ»¡è¶³ä¸Šè¿°æƒ…å†µåˆ™è°ƒç”¨ window.scheduleFrame(); ç„¶åæ ‡è®° _hasScheduledFrame ä¸º true Window.scheduleFrame1void scheduleFrame() native &#x27;Window_scheduleFrame&#x27;; è¿™é‡Œçš„ Window.scheduleFrame æ˜¯ Native æ–¹æ³•ï¼Œå¯ä»¥ç†è§£ä¸ºé€šè¿‡ Window ä¸ Flutter engine æ‰“äº¤é“ï¼Œæ³¨å†Œäº† VSync å›è°ƒã€‚ æ€»ç»“ State.setState èƒŒåé€»è¾‘ ç®€å•æ¥è¯´ State.setState å°±å¹²äº†è¿™ä¹ˆå‡ ä»¶äº‹ï¼š æ‰§è¡Œå…¥å‚ VoidCallback é€»è¾‘ï¼Œå³æ‰§è¡Œå¼€å‘è€…å†™å¥½çš„ä¿¡æ¯å˜æ›´é€»è¾‘ å°è¯•å°†å½“å‰ StatefulWidget å¯¹åº”çš„ StatefulElement æ ‡è®°ä¸º dirty é€šè¿‡ BuildOwner.onBuildScheduled åˆ° SchedulerPhase.scheduleFrame å†åˆ° Window.scheduleFrame ä¸€æ­¥æ­¥å®Œæˆäº† VSync çš„å›è°ƒæ³¨å†Œ æ³¨æ„ä¸Šé¢ State.setState ç¬¬äºŒæ¡ä¸»è¦é€»è¾‘å°±æ˜¯æŠŠ State å…³è”çš„ Element æ ‡è®°ä¸º dirtyã€‚åœ¨ VSync å›è°ƒåä¼šé€šè¿‡ Native åˆ° Flutter engine è°ƒç”¨ Flutter _drawFrame æ–¹æ³•ï¼Œå°†ä¹‹å‰æ ‡è®°ä¸º dirty çš„ Element é‡æ–°æ„å»ºï¼Œæœ€ç»ˆä¼šæ‰§è¡Œåˆ°å¼€å‘è€…ç†Ÿæ‚‰çš„ State.build æ–¹æ³•ã€‚ State.build æ˜¯å¦‚ä½•è¢«æ‰§è¡Œçš„è¿™é‡Œå› ä¸ºç¯‡å¹…åŸå› ç®€å•æè¿°ä¸‹åç»­é€»è¾‘ï¼Œæ¯•ç«Ÿæœ¬æ–‡é‡ç‚¹ä¸åœ¨äº Flutter å¦‚ä½•æ¸²æŸ“ Widgetï¼š State æ˜¯å¼€å‘è€…é‡å†™ StatefulWidget.createState è¿”å›çš„ State å¯¹åº”çš„ Element æ˜¯ StatefulWidget.createElement è¿”å›çš„ï¼Œç±»å‹ä¸º StatefulElement StatefulElement è¢«æ ‡è®°ä¸º dirty ååœ¨ Flutter _drawFrame æ—¶é‡æ–°æ„å»ºä¼šè°ƒç”¨ StatefulElement.buildï¼Œå…¶æºç ä¸º Widget build() =&gt; state.build(this); state.build(this) ä¸­çš„ state å°±æ˜¯æˆ‘ä»¬çš„ Stateï¼Œå¼€å‘è€…å†™çš„ State.build æ–¹æ³•å°±è¿™æ ·è¢«æ‰§è¡Œäº† æ€»ç»“æœ¬æ–‡æ˜¯ Flutter çŠ¶æ€ç®¡ç†çš„å¼€ç¯‡ï¼Œä¸ºäº†ç…§é¡¾ä¸€äº›è¿˜æ²¡æ¥å¾—åŠå­¦ä¹  Flutter æˆ–è€…åˆšå…¥é—¨ Flutter çš„åˆå¿ƒè€…æ‰€ä»¥æ–‡ç« ä»å‰åˆ°ååšäº†ä¸€äº›é“ºå«ä»‹ç»è¿‡æ¸¡ã€‚æ–‡ç« å†…å®¹ä¹Ÿæ¯”è¾ƒæµ…æ˜¾æ˜“æ‡‚ï¼ŒåŸºæœ¬ä¸Šæ˜¯å›´ç»• Flutter åˆ›å»º App é»˜è®¤çš„ Demo æ¥å±•å¼€è®²è§£ä¸€äº›åŸºæœ¬çš„ Flutter çŸ¥è¯†ç‚¹ï¼š Flutter æ¸²æŸ“ Widget çš„ä¸‰é¢—æ ‘æ¦‚å¿µ StatelessWidget &amp; StatefulWidget State.setState èƒŒåé€»è¾‘ ç”±äºçŠ¶æ€ç®¡ç†è¿™ä¸ªè¯é¢˜éå¸¸å¤§ä¸”å¤æ‚ï¼Œæ–‡ç« å› ä¸ºç¯‡å¹…åŸå› å°±åˆ°è¿™é‡Œï¼Œåç»­çš„æ–‡ç« ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰åº”è¯¥ä¸ä¼šå†èŠ±å¤§ç¯‡å¹…åš Flutter åŸºç¡€çŸ¥è¯†çš„é“ºå«å’Œè¿‡æ¸¡äº†ï¼ˆä½†æ˜¯è¯¥æœ‰çš„å‰ç½®çŸ¥è¯†ç‚¹è‚¯å®šè¿˜ä¼šæœ‰ï¼‰ã€‚æ—¶é—´ç´§å¼ ï¼Œæ–‡ç« éš¾å…å‡ºç°è°¬è¯¯ï¼Œä¼°è®¡è‡ªå·±ä¹Ÿæ²¡æœ‰æ—¶é—´åšæ ¡å¯¹äº†ï¼Œæœ‰é—®é¢˜è¿˜æœ›åœ¨è¯„è®ºåŒºæé†’ã€‚ æ‰©å±•è¡¥å……å†™åˆ°è¿™é‡Œæˆ‘æ„è¯†åˆ° Flutter çŠ¶æ€ç®¡ç†è¿™ä¸ªè¯é¢˜ä¸‹å¯ä»¥å¼•å‡ºå¾ˆå¤šå€¼å¾—æŒ–æ˜çš„å†…å®¹ï¼Œè€Œä¸”ç¬”è€…åšä¿¡å£°æ˜å¼ UI + å“åº”å¼ç¼–ç¨‹ä¼šæ˜¯æœªæ¥ç§»åŠ¨å®¢æˆ·ç«¯ä¹ƒè‡³æ•´ä¸ªå¤§å‰ç«¯çš„ä¸»æµç¼–ç¨‹èŒƒå¼ã€‚é‰´äºæ­¤ï¼Œåç»­çš„æ–‡ç« è®¡åˆ’å›´ç»• Flutter çŠ¶æ€ç®¡ç†é€æ­¥æ·±æŒ–ï¼Œå†…å®¹ä¹Ÿå°†åœ¨ Flutter æŠ€æœ¯æ ˆçš„åŸºç¡€ä¸Šåšé€‚åº¦æ¨ªå‘å¯¹æ¯”ã€‚ Emmmmmâ€¦åç»­çš„æ–‡ç« å°†ä¼šå‘å¸ƒåœ¨æˆ‘çš„ã€ŠFlutter çŠ¶æ€ç®¡ç†ã€‹å°ä¸“æ ã€‚è‡³äºä¸“æ å®šä»·å˜›ï¼Œç›®å‰éšä¾¿å®šäº† Â¥69ï¼ˆä½œä¸ºå°é€æ˜çš„æˆ‘ç‘Ÿç‘Ÿå‘æŠ– ing~ï¼‰ã€‚å…¶å®å€’ä¹Ÿä¸æ˜¯å¾ˆåœ¨æ„èƒ½å–å‡ºå¤šå°‘ä»½ï¼Œæˆ–è€…ä»ä¸­æ”¶åˆ°å¤šå°‘é’±ï¼Œæ¯•ç«Ÿè‡ªå·±å†™æ–‡ç« çš„ç²¾åŠ›æ‹¿å»éšä¾¿æ¥ä¸ªæœ‹å‹çš„ç§æ´»éƒ½åº”è¯¥æ¯”è¿™æ¬¡é€šè¿‡å°ä¸“æ èµšåˆ°çš„å¤šã€‚æ¯”èµ·æ”¶å…¥æ›´å¤šçš„æ˜¯å¯¹è‡ªå·±çš„é­ç­–å§ï¼Œæ¯•ç«Ÿæ˜¯æ”¶è´¹çš„ä¸œè¥¿ï¼Œåªè¦æœ‰ä¸€ä¸ªäººè®¢é˜…äº†è¿™ä¸ªä¸“æ å°±æ„å‘³ç€å¯¹æˆ‘çš„è‚¯å®šï¼Œæˆ‘å°±æœ‰è´£ä»»æŠŠè¿™ä¸ªæ–¹å‘æŒ–æ˜çš„æ›´æ·±å…¥ï¼ŒåŒæ—¶æ–‡ç« è´¨é‡ä¹Ÿåº”è¯¥æ¯”åšå®¢å†…å®¹æ›´é«˜ã€‚ å…¶å®æ—©åœ¨å»å¹´å°±æœ‰å¹¸è¢«å°ä¸“æ çš„å¼€å‘è€…@å®‰å“å¤§ç‹å­é‚€è¯·å»å°ä¸“æ å†™æ–‡ç« ï¼Œä¸è¿‡å½“æ—¶è‡ªå·±æ„Ÿè§‰æ²¡ä»€ä¹ˆå¥½çš„å†…å®¹æ–¹å‘æ‰€ä»¥åªæ˜¯å¼€é€šäº†ä¸“æ ä½†æ²¡æœ‰ä»»ä½•è¾“å‡ºã€‚æ—¶è‡³ä»Šæ—¥ç»ˆäºæ‰¾åˆ°äº†ä¸€ä¸ªå€¼å¾—æ·±æŒ–çš„æ–¹å‘ï¼Œè‡ªç„¶è€Œç„¶æƒ³åˆ°äº†è¿™ä¸ªå¹³å°ã€‚ä¸ªäººæ„Ÿè§‰å°ä¸“æ è¿™ä¸ªå¹³å°æ²¡æœ‰å¤ªé‡çš„å•†ä¸šåŒ–å‘³é“ï¼Œè¿™ç‚¹å¾ˆè®¨å–œï¼Œåœ¨å¾®ä¿¡ä¸Šé¢çš„é˜…è¯»ä½“éªŒä¹Ÿæ¯”è‡ªå·±å‘å…¬ä¼—å·è¦å¥½ä¸€äº›ï¼Œæ›´éš¾èƒ½å¯è´µçš„æ˜¯çœå»äº†å‘å…¬ä¼—å·çš„ç¹çæ“ä½œæµç¨‹ã€‚å¯èƒ½æ­£æ˜¯å•†ä¸šåŒ–æ°›å›´å¼±çš„åŸå› ï¼Œä¸Šé¢çš„æ–‡ç« è´¨é‡è¿˜éƒ½æŒºä¸é”™çš„ï¼Œæ¨èå„ä½è¯»è€…æœ‹å‹å¯ä»¥ä¸Šå»è¯•è¯»æˆ–è€…å†™ä½œã€‚"},{"title":"å†™åœ¨ 2018 å¹´çš„æœ€åä¸€å¤©","comments":true,"permalink":"https://lision.me/summary_for_2018/","text":"å‰è¨€æ‰“çœ¼ä¸€ç§ï¼Œä¸Šä¸€ç¯‡æ–‡ç« è¿˜æ˜¯åä¸€é•¿å‡çš„æ—¶å€™ç”±äºæ—…è¡Œè®¡åˆ’ç ´ç­åé—²ç€æ— èŠç ´è§£ Bartender æ—¶å†™çš„ï¼Œè¿™ä¸€è½¬çœ¼çš„åŠŸå¤«å°±åˆ°äº†å…ƒæ—¦å‡æœŸäº†â€¦ Emmmmmâ€¦ æœ¬æ¥å·²ç»æ”¾å¼ƒè¦å†™å¹´æœ«æ€»ç»“çš„~ ä¼—æ‰€å‘¨çŸ¥ï¼Œå†™å¹´æœ«æ€»ç»“çº¦ç­‰äºè‡ªæŠ½å˜´å·´ã€‚æœ«äº†è¿˜è¦å¯¹åº”ç€åˆ—å‡ºæ–°ä¸€å¹´çš„è®¡åˆ’ï¼Œä¸ºæ˜å¹´å¹´æœ«ç›¸åŒçš„ç¯èŠ‚åŸ‹ä¸‹ä¼ç¬”ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¹´åˆçš„è®¡åˆ’å†™çš„è¶Šæ˜¯å…·ä½“ã€ç”ŸåŠ¨ã€å½¢è±¡ï¼Œå¹´æœ«çš„å˜´å·´æŠ½çš„å°±è¶Šæ˜¯å•ªï¼å•ªï¼ï¼å•ªï¼ï¼ï¼ è®©æˆ‘æƒŠå–œçš„æ˜¯ï¼Œæˆ‘çš„å¹´åˆè®¡åˆ’ä¹‹å‰æ²¡æœ‰è®°åˆ°åšå®¢é‡Œï¼Œç¿»äº†ä¸€ä¸‹ä»…æœ‰çš„ä¸€ç¯‡ç›¸å…³å†…å®¹çš„æ–‡ç« ã€Šå˜›~ åˆä¸€å¹´äº†å•Šâ€¦ã€‹ï¼Œé‡Œé¢å¹¶æ²¡æœ‰ä»€ä¹ˆå…·ä½“çš„è‡ªå®š KPI~ åŸæ¥æˆ‘æ˜¯è¿™ä¹ˆçš„æ·±è°‹è¿œè™‘ï¼Œæ—©å°±æƒ³å¥½äº†è¿™ä¸€å¤©çš„åˆ°æ¥ ğŸ˜‚ ç´¢å¼• å·¥ä½œç¯‡ æŠ€æœ¯ç¯‡ ç”Ÿæ´»ç¯‡ æ€»ç»“ å·¥ä½œç¯‡å˜›~ è¿™ä¸€å¹´åœ¨å·¥ä½œä¸­çš„æ•´ä½“è¡¨ç°ç®—æ˜¯è¾¾åˆ°äº†è‡ªå·±çš„é¢„æœŸï¼Œé‡Œç¨‹ç¢‘å¦‚ä¸‹ï¼š å¹´åˆæ¥åˆ°äº†ç¾å›¢å¤–å–å›¢é˜Ÿçš„ Offer å¹¶æˆåŠŸå…¥èŒ å‚åŠ ç¾å›¢Â·ç‚¹è¯„æŠ€æœ¯é€šé“ç§‹å­£æ™‹çº§ç­”è¾©å¹¶æˆåŠŸæ™‹å‡ å¹´åˆçš„ Offer æŠ‰æ‹©æ²¡è®©è‡ªå·±åæ‚”ï¼Œè¿™ä¸€å¹´å¤–å–å•†å®¶ä¾§çš„ä¸šåŠ¡å‘å±•å¾ˆè¿…çŒ›ï¼Œéšä¹‹è€Œè¨€å·¥ä½œä¸­é¢ä¸´çš„æŒ‘æˆ˜ä¹Ÿå¾ˆå¤šï¼Œå·¥ä½œå†…å®¹å……å®ã€‚æˆ‘çš„è€æ¿å¯¹ç»„å‘˜å’Œå…¶è‡ªèº«éƒ½æœ‰ç€å¾ˆé«˜çš„è¦æ±‚ï¼Œæœ‰ä¸€ä¸ªä¼˜ç§€çš„ Leader æ˜¯ä¸€ä»¶å¾ˆå¹¸è¿çš„äº‹ï¼Œå› ä¸ºä»–ï¼ˆå¥¹ï¼‰ä¼šç›´æ¥å†³å®šä½ æ‰€å¤„å›¢é˜Ÿçš„æ–¹æ–¹é¢é¢ã€‚ æŠ€æœ¯ç¯‡è¿™ä¸€å¹´åœ¨æŠ€æœ¯æ–¹é¢å€¼å¾—è®°å½•çš„äº‹ï¼š å¹´åˆåœ¨ GitHub å¼€æºäº†ä¸¤ä¸ªè½®å­ï¼Œä¸€å¹´ç»´æŠ¤ä¸‹æ¥è™½ç„¶ç´¯ï¼Œä½†ä»ä¸­æ”¶è·ä¸å°‘ åŠ å…¥äº† @SwiftGG ç¿»è¯‘ç»„ å¹¶å‚ä¸äº†ä¸€äº›ä¼˜è´¨æ–‡ç« çš„æ ¡å¯¹å·¥ä½œ é˜…è¯»äº†ä¸€äº›å…¬å¸å†…éƒ¨è‡ªå·±æ„Ÿå…´è¶£çš„æºç  å…³äºå¼€æº Emmmmmâ€¦ å¹´åˆçš„æ—¶å€™å†™äº†ä¸¤ä¸ªå¼€æºé¡¹ç›®ï¼š LSAnimator - An easy to read and write, non-invasive multi-chain animation framework, inspired by JHChainableAnimations. WKWebViewJavascriptBridge - A Bridge for Sending Messages between Swift and JavaScript in WKWebViews. æ—©åœ¨å¼€å‘æ—¶å°±åšå¥½äº†å¡«å‘çš„è§‰æ‚Ÿï¼Œå¾—ç›Šäºæ¨å¹¿ä¹‹å‰æœ‰å†™è¦†ç›–è¾ƒä¸ºå…¨é¢çš„å•æµ‹ç”¨ä¾‹å¹¶é…ç½®äº† Travis-CIï¼Œè¿™ä¸€å¹´æ¥ä¸¤ä¸ªå¼€æºé¡¹ç›®å¹¶æœªå¯¹ä½¿ç”¨è€…é€ æˆä»»ä½•è´Ÿé¢å½±å“ï¼Œç”¨æˆ·æçš„ Issue ä¹Ÿéƒ½æœ‰æŠ½å‡ºæ—¶é—´è§£ç­” &amp; å¤„ç†ã€‚ é˜…è¯» &amp; å®è·µ ã€Œçº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç»çŸ¥æ­¤äº‹è¦èº¬è¡Œã€‚ã€ å¯¹äºè¿™å¥è¯çš„ç†è§£è¶Šå‘æ·±åˆ»äº†ï¼Œè‡ªå·±ä¹‹å‰åœ¨ä¹¦æœ¬ä¸Šå­¦åˆ°è¿‡çš„çŸ¥è¯†å¥½å¤šéƒ½æ²¡æœ‰åŠ¨æ‰‹å®è·µè¿‡ï¼Œä»Šå¹´åœ¨å­¦ä¹ æ—¶å¤šæ¬¡æœ‰èŒ…å¡é¡¿å¼€çš„æ„Ÿè§‰ã€‚ç»è¿‡å¤ç›˜ï¼Œè¿™ç§æ„Ÿè§‰äº§ç”Ÿçš„æ ¹æœ¬åŸå› æ˜¯è‡ªå·±ä¹‹å‰é˜…è¯»æŠ€æœ¯ä¹¦ç±æ—¶æ²¡æœ‰å®Œå…¨å¼„æ˜ç™½ï¼Œç±»ä¼¼äºåœ¨è„‘ä¸­è®°å½•äº†ä¸€ä¸ªç¬¦å·ï¼Œåœ¨åæœŸé˜…è¯»æºç  &amp; è§£å†³é—®é¢˜æ—¶æ‰¾åˆ°äº†è¯¥ç¬¦å·çš„å¯¹åº”å®ç°ä½“ï¼ˆç¬‘ï¼‰ã€‚ ç”Ÿæ´»ç¯‡ å·¥ä½œä¹‹ä½™æˆ‘çš„æ—¶é—´ä¸»è¦èŠ±è´¹åœ¨ç”µå­æ¸¸æˆä¸Šé¢ ğŸ˜‚ ä»Šå¹´åˆè´¥äº†ä¸€äº›æ¸¸æˆï¼š ã€Šé©¬é‡Œå¥¥èµ›è½¦ 8 è±ªåç‰ˆã€‹ ã€Šé¾™ç æ–—å£« zã€‹ ã€Šç²¾çµå®å¯æ¢¦ Letâ€™s go çš®å¡ä¸˜ã€‹ ã€Šä»»å¤©å ‚å…¨æ˜æ˜Ÿå¤§ä¹±æ–— spã€‹ ã€ŠDead Cellã€‹ ã€Šä¼ è¯´æ³•å¸ˆã€‹ ã€Šç©ºæ´éª‘å£«ã€‹ Ps: ä¸ºäº†ç©å¤§ä¹±æ–—è¿˜å…¥æ‰‹äº† Switch Pro æ‰‹æŸ„ï¼Œä¸è¿‡ Pro æ‰‹æŸ„çš„æ“æ§æ„ŸçœŸçš„æ˜¯éå¸¸è®©æˆ‘æƒŠå–œï¼Œæƒ³ä¸åˆ°ä»»å¤©å ‚è¿™ç§å“æ§ä¹Ÿèƒ½æœ‰è¿™ç§ç²¾å“å¤–è®¾äº§å‡ºï¼ˆæ‰‹åŠ¨æ»‘ç¨½ï¼‰ã€‚ é—æ†¾çš„æ˜¯ï¼Œè‡ªå·±è²Œä¼¼å¹¶æ²¡æœ‰å¤ªå¤šæ—¶é—´å»äº«å—è¿™äº›æ¸¸æˆï¼Œæœ€ä¸ºå…¸å‹çš„åº”è¯¥æ˜¯ 2016 å¹´å…¥æ‰‹çš„ã€Šé»‘æš—ä¹‹é­‚ IIIã€‹ï¼Œåˆ°ç°åœ¨è¿˜éƒ½æ˜¯æœªå¼€å°çŠ¶æ€ o(â•¯â–¡â•°)o â€¦ æ„Ÿè§‰ä¸€è¿‡äº† 25 å‘¨å²ä¹‹åèº«ä½“æœºèƒ½å¤§ä¸å¦‚å‰äº†ï¼Œæœ€æ˜æ˜¾çš„åŒºåˆ«å°±æ˜¯ç°åœ¨ä¸‹ç­å›å®¶ä¹‹åå¼€æœºå™¨çš„æ„æ„¿éå¸¸å¼±ï¼Œå‘¨æœ«å‡ ä¹ä¸ä¼šæœ‰é€šå®µè‚æ¸¸æˆçš„æƒ³æ³•å‡ºç°ã€‚ æ€»ç»“Emmmmmâ€¦ æ„Ÿè§‰è¿™ä¸€å¹´æ¥æœ€å¤§çš„å˜åŒ–æ˜¯å†™æ–‡ç« çš„æ„æ„¿è¶Šæ¥è¶Šå¼±äº†ï¼Œå…¶å®è®¡åˆ’ä¸­æ˜¯æœ‰å¾ˆå¤šä¸œè¥¿æƒ³è½¬ä¸ºæ–‡å­—æ²‰æ·€åœ¨è‡ªå·±çš„åšå®¢é‡Œçš„ï¼Œå¥ˆä½•è¦åšçš„äº‹æƒ…å¤ªå¤šï¼Œæ—¶é—´å´åˆå¤ªå°‘ã€‚æœ‰äº›ä¸œè¥¿å½“æ—¶æ¢³ç†æˆäº†ç¬”è®°ï¼ˆæ–¹ä¾¿è‡ªå·±å›é¡¾ï¼‰ï¼Œéšç€æ—¶é—´çš„æ¨ç§»ä¹Ÿå°±ä¸æƒ³å†å†™æˆæ–‡ç« å‘å‡ºæ¥äº†â€¦ é€šè¿‡å¤ç›˜ä¹Ÿå‘ç°è‡ªå·±å¯¹äºç”Ÿæ´»çš„æ€åº¦è¿‡äºéšæ„ï¼Œå¯¼è‡´å¹´æœ«å¤ç›˜å‡ ä¹æ²¡ä»€ä¹ˆå¯å†™çš„ä¸œè¥¿ï¼Œå‡†å¤‡åœ¨æ˜å¹´çš„å¹´åº¦è®¡åˆ’ä¸­æ˜ç¡®ç”Ÿæ´»ç›¸å…³çš„å„é¡¹æŒ‡æ ‡ï¼Œç°åœ¨æƒ³åˆ°çš„æœ‰ç†è´¢ï¼Œå¥èº«ï¼Œè§‚å½±ï¼Œæ¸¸æˆâ€¦"},{"title":"é€†å‘ Mac åº”ç”¨ Bartender","comments":true,"permalink":"https://lision.me/mac_re_bartender/","text":"å‰è¨€ æœ¬æ–‡å†…å®¹ä»…ä½œä¸ºå­¦ä¹ äº¤æµï¼Œå¸Œæœ›å¤§å®¶å¤šå¤šæ”¯æŒæ­£ç‰ˆè½¯ä»¶ã€‚ Emmmmmâ€¦ å…¶å®æœ€åˆæ˜¯å‡†å¤‡å†™ä¸€ç¯‡å…³äº iOS åº”ç”¨çš„é€†å‘ç¬”è®°çš„ï¼Œä¸è¿‡ä¸€ç›´æ²¡æ‰¾åˆ°åˆé€‚çš„ç›®æ ‡ App ä»¥åŠéš¾åº¦é€‚å®œçš„åŠŸèƒ½ç‚¹æ¥ä½œä¸ºå†™ä½œç´ æâ€¦ ç ´è§£äº† Bartender ä¹‹åæˆ‘è§‰å¾—å¯¹äº Bartender çš„ç ´è§£è¿‡ç¨‹éš¾åº¦é€‚ä¸­ï¼Œéå¸¸é€‚åˆå½“åšç´ ææ¥å†™ï¼Œä¸”ä¸è®ºæ˜¯ Mac App è¿˜æ˜¯ iOS Appï¼Œé€†å‘çš„æ€è·¯éƒ½æ˜¯ç›¸é€šçš„ï¼Œæ‰€ä»¥å°±å†™äº†è¿™ç¯‡æ–‡ç« ~ å›½åº†ä¹‹å‰ï¼Œæœæœæ”¾å‡ºäº†æœ€æ–°æ“ä½œç³»ç»Ÿ macOS Mojave çš„æ­£å¼ç‰ˆæœ¬ï¼Œç›¸ä¿¡å¾ˆå¤šå°ä¼™ä¼´éƒ½è·Ÿæˆ‘ä¸€æ ·åœ¨æ­£å¼ç‰ˆå‘å¸ƒåç´§è·Ÿç€å°±å‡çº§äº†ç³»ç»Ÿï¼ˆæ­¤å‰ç”±äºå·¥ä½œè®¾å¤‡å‚ä¸é¡¹ç›®äº§å‡ºéœ€è¦ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§æ‰€ä»¥æ²¡æ•¢å°é²œçš„åŒå­¦åº”è¯¥ä¸åªæˆ‘ä¸€ä¸ªäººå“ˆï¼‰ã€‚ å‡çº§åˆ°æ­£å¼ç‰ˆ macOS Mojave ä¹‹åï¼Œæˆ‘å…´è‡´å‹ƒå‹ƒçš„åœ¨æ–°ç³»ç»Ÿä¸­å„å¤„æ¢ç´¢äº†ä¸€ç•ªï¼Œç„¶åå°†ç³»ç»Ÿåˆ‡æ¢åˆ° Dark Mode åæ‰“å¼€ Xcode å¿ƒæ»¡æ„è¶³åœ°æ•²ï¼ˆæ¬ï¼‰èµ·äº†ä»£ç ï¼ˆç –ï¼‰â€¦ å˜›~ åˆæ˜¯ä¸€ä¸ªæƒ¬æ„çš„åˆåï¼Œæœ‰æ—¶å€™äººå°±æ˜¯è¿™ä¹ˆå®¹æ˜“æ»¡è¶³ï¼ˆç¬‘ï¼‰~ ç­‰ç­‰ï¼è¿™æ˜¯ä»€ä¹ˆé¬¼ï¼ï¼Ÿæˆ‘çš„ Bartender æ€ä¹ˆä¸èƒ½æ­£å¸¸å·¥ä½œäº†ï¼ˆå…¶å®ç°åœ¨å›æƒ³èµ·æ¥åº”è¯¥æ˜¯è¯•ç”¨æœŸåˆ°æœŸäº†ï¼‰â€¦ æœ¬æ–‡å°†ä»¥ Bartender ä¸ºç›®æ ‡ Appï¼Œè®²è§£å¦‚ä½•é€šè¿‡é™æ€åˆ†æå·¥å…· Hopper é€æ­¥åˆ†æ Bartender çš„å†…éƒ¨å®ç°é€»è¾‘å¹¶ç»“åˆåŠ¨æ€åˆ†æç­‰æ‰‹æ®µé€æ­¥ç ´è§£ Bartender çš„è¿‡ç¨‹ä¸æ€è·¯~ ç´¢å¼• Bartender Hopper é€†å‘è¿‡ç¨‹ &amp; æ€è·¯ æ€»ç»“ Bartender Bartender æ˜¯ä¸€æ¬¾å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ•´ç†å±å¹•é¡¶éƒ¨èœå•æ å›¾æ ‡çš„å·¥å…·ã€‚ éšç€æˆ‘ä»¬å®‰è£…çš„ App ä¸æ–­å¢å¤šï¼Œå±å¹•é¡¶éƒ¨èœå•æ ä¸Šé¢çš„å›¾æ ‡ä¹Ÿä¼šå¯¹åº”ä¸æ–­å¢åŠ ã€‚è¿™äº› App çš„å›¾æ ‡å¹¶éå‡ºè‡ªä¸€å®¶ä¹‹æ‰‹ï¼Œé£æ ¼å„å¼‚ï¼Œéšç€æ•°ç›®å¢å¤šé€æ¸æ˜¾å¾—æ‚ä¹±ä¸å ªã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡ Bartender æ¥éšè—æˆ–é‡æ–°æ’åˆ—è¿™äº›æ¼äººçš„å°å›¾æ ‡ï¼Œå¯ä»¥å°†æ²¡ä»€ä¹ˆç”¨ä½†æ˜¯è¿è¡Œèµ·æ¥å´è¦æ˜¾ç¤ºçš„ App å›¾æ ‡å§‹ç»ˆéšè—ï¼Œå°†å¶å°”ä¼šç”¨çš„ App å›¾æ ‡éšè—åˆ° Bartender åŠŸèƒ½æŒ‰é’®åé¢ï¼ˆç”¨åˆ°çš„æ—¶å€™å¯ä»¥é€šè¿‡ç‚¹å‡» Bartender åŠŸèƒ½æŒ‰é’®åˆ‡æ¢æ˜¾éšï¼‰ï¼Œåªæ˜¾ç¤ºå¸¸ç”¨çš„æˆ–è€…æˆ‘ä»¬è®¤ä¸ºå¥½çœ‹çš„åº”ç”¨å›¾æ ‡ã€‚ é™¤æ­¤ä¹‹å¤– Bartender è¿˜å…·å¤‡ä¸€äº›å…¶ä»–æ›´åŠ æ·±å…¥çš„åŠŸèƒ½ï¼ˆæ¯”å¦‚æ”¯æŒå…¨éƒ¨èœå•æ æ¡ç›®èŒƒå›´çš„æœç´¢ç­‰ç­‰ï¼‰ï¼Œæ¯«æ— ç–‘é—®å®ƒæ˜¯ä¸€æ¬¾éå¸¸æ£’çš„èœå•æ å›¾æ ‡ç®¡ç†å·¥å…·ã€‚ Note: é‡ç”³ï¼ŒBartender ä»…å”® 15 åˆ€ï¼Œè¿˜æ˜¯æ¨èå„ä½ä½¿ç”¨æ­£ç‰ˆï¼Œæœ¬æ–‡ä»…ä½œä¸ºå­¦ä¹ äº¤æµã€‚ Hopper Hopper æ˜¯ä¸€æ¬¾ä¸é”™çš„ mac OS ä¸ Linux åæ±‡ç¼–å·¥å…·ï¼ŒåŒæ—¶è¿˜æä¾›ä¸€å®šçš„åç¼–è¯‘èƒ½åŠ›ï¼Œå¯ä»¥åˆ©ç”¨å®ƒæ¥è°ƒè¯•æˆ‘ä»¬çš„ç¨‹åºã€‚æ­¤å¤–ï¼ŒHopper è¿˜æ”¯æŒæ§åˆ¶æµè§†å›¾æ¨¡å¼ï¼ŒPython è„šæœ¬ï¼ŒLLDB &amp; GDBï¼Œå¹¶ä¸”æä¾›äº† Hopper SDK å¯ä¾›æ‰©å±•ï¼Œåœ¨ Hopper SDK çš„åŸºç¡€ä¸Šä½ ç”šè‡³å¯ä»¥æ‰©å±•è‡ªå·±çš„æ–‡ä»¶æ ¼å¼å’Œ CPU æ”¯æŒã€‚ å€¼å¾—ä¸€æçš„æ˜¯ Hopper çš„ä½œè€…æ˜¯ä¸€åç‹¬ç«‹å¼€å‘è€…ï¼Œä»–çš„æ—¥å¸¸å·¥ä½œç¯å¢ƒä¹Ÿæ˜¯åœ¨ mac OS ä¸Šï¼Œæ‰€ä»¥åœ¨ mac OS ä¸Šçš„ Hopper æ˜¯å®Œå…¨ä½¿ç”¨ Cocoa Framework å®ç°çš„ï¼Œè€Œ Linux ç‰ˆæœ¬çš„ Hopper åˆ™é€‰æ‹©ä½¿ç”¨ Qt 5 æ¥å®ç°ã€‚ ä¸ªäººè®¤ä¸º Hopper åœ¨ mac OS ä¸Šé¢çš„è¿è¡Œè¡¨ç°éå¸¸å¥½ï¼Œå¾ˆå¤šç»†èŠ‚ï¼ˆæ¯”å¦‚ç±»å‹é¢œè‰²åŒºåˆ†ç­‰ï¼‰éƒ½åšçš„ä¸é”™ï¼ŒåŠŸèƒ½ç®€æ´çš„åŒæ—¶å¿«æ·é”®ä¹Ÿå¾ˆå¥½è®°ï¼ˆHopper æä¾›çš„åŠŸèƒ½å·²ç»è¦†ç›–äº†ç»å¤§å¤šæ•°ä½¿ç”¨åœºæ™¯ï¼‰ã€‚ æœ€å…³é”®çš„ä¸€ç‚¹æ˜¯æ”¶è´¹è‰¯å¿ƒï¼Œä¸ªäººè¯ä¹¦åªè¦ 99 åˆ€ï¼Œå½“ä¹‹æ— æ„§çš„äººäººéƒ½ä¹°å¾—èµ·çš„é€†å‘å·¥å…·ï¼å½“ç„¶å¦‚æœä½ è§‰å¾—è´µï¼ŒHopper è¿˜æä¾›è¯•ç”¨ï¼Œè¯•ç”¨å½¢å¼ç±»ä¼¼äº Charlesï¼Œæ¯æ¬¡å¼€å¯åå¯ä»¥è¯•ç”¨ 30 åˆ†é’Ÿï¼Œä¸€èˆ¬æƒ…å†µä¸‹è¿™å·²ç»å¤Ÿç”¨äº†ã€‚ Note: Hopper v4.4.0 æ”¯æŒ Mojave Dark Modeã€‚ é€†å‘è¿‡ç¨‹ &amp; æ€è·¯è¿™ä¸€ç« èŠ‚çš„å†…å®¹ä¼šè¯¦ç»†çš„è®²è¿°æˆ‘ä¸ªäººåœ¨ç ´è§£ Bartender è¿‡ç¨‹ä¸­çš„æƒ³æ³•ä»¥åŠä¸­é—´é‡åˆ°é—®é¢˜æ—¶è§£å†³é—®é¢˜çš„æ€è·¯ï¼Œä¹‹å‰æ²¡æœ‰æ¶‰è¶³é€†å‘æˆ–è€…é€†å‘ç»éªŒå°šæµ…çš„åŒå­¦å¯èƒ½ä¼šè§‰å¾—æ¯”è¾ƒæ™¦æ¶©ï¼Œè¿™ç§æƒ…å†µæœ€å¥½ç»“åˆè‡ªå·±çš„å®é™…æ“ä½œåå¤é˜…è¯»æ²¡æœ‰ç†è§£çš„åœ°æ–¹ç›´åˆ°çœŸæ­£å¼„æ˜ç™½ä¸ºæ­¢ã€‚ ç›¸ä¿¡è‡ªå·±ï¼Œæ¯ä¸€ä»½åŠªåŠ›ç»ˆä¼šæœ‰æ‰€å›æŠ¥ï¼å½“æœ‰æœä¸€æ—¥è‡ªå·±ä¹Ÿå¯ä»¥é€šè¿‡è‡ªå·±çš„é€†å‘æŠ€æœ¯ç ´è§£ &amp; å®šåˆ¶åŒ–è‡ªå·±æ„Ÿå…´è¶£çš„ App æ—¶ï¼Œä½ ä¼šå‘ç°ä¸€åˆ‡çš„åŠªåŠ›éƒ½æ˜¯å€¼å¾—çš„ã€‚ è·å–ç›®æ ‡äºŒè¿›åˆ¶ä» Bartender å®˜ç½‘ä¸‹è½½æœ€æ–°çš„ Bartenderï¼Œæˆªæ­¢æœ¬æ–‡æç¬”ä¹‹å‰ Bartender çš„æœ€æ–°ç‰ˆæœ¬ä¸º 3.0.47ã€‚ å°†ä¸‹è½½å¥½çš„å‹ç¼©åŒ…è§£å‹ä¹‹åå¾—åˆ° Bartender 3.appï¼Œå°† Bartender 3.app æ–‡ä»¶å¤åˆ¶åˆ°è‡ªå·±çš„ Application æ–‡ä»¶å¤¹ä¸‹ã€‚å³é”®ç‚¹å‡» Bartender 3.app é€‰æ‹©â€œæ˜¾ç¤ºåŒ…å†…å®¹â€ï¼Œåœ¨ Contents ç›®å½•ä¸‹æ‰¾åˆ° MacOS ç›®å½•ï¼Œé‡Œé¢æœ‰æˆ‘ä»¬è¦çš„ç›®æ ‡äºŒè¿›åˆ¶æ–‡ä»¶ Bartender 3ã€‚ ä»â€œæˆæƒâ€ç€æ‰‹æ‰“å¼€ Hopperï¼Œå°†ç›®æ ‡äºŒè¿›åˆ¶æ–‡ä»¶æ‹–å…¥ Hopperï¼Œåœ¨å¼¹å‡ºçš„å¼¹çª—ä¸­é€‰æ‹© OK åç­‰å¾… Hopper åˆ†æå®Œæ¯•ã€‚ åœ¨å·¦ä¾§çš„åˆ†æ ä¸­é€‰æ‹© Proc. ï¼Œè¿™å¯ä»¥è®©æˆ‘ä»¬æŸ¥çœ‹ Hopper åˆ†æå‡ºæ¥çš„æ–¹æ³•ã€‚åˆ†æ ä¸‹é¢æœ‰æœç´¢æ¡†ï¼Œå†…éƒ¨å¯ä»¥é€šè¿‡è¾“å…¥å…³é”®è¯æ¥è¿‡æ»¤å‡ºæˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚å› ä¸ºä¸€èˆ¬çš„ App éƒ½æ˜¯é€šè¿‡æŸäº›æ–¹æ³•åˆ¤æ–­æ˜¯å¦æˆæƒçš„ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆè¾“å…¥ is ï¼ˆæ³¨æ„ is å‰é¢åŠ ç©ºæ ¼ï¼‰ï¼Œç„¶åè§‚å¯Ÿè¿‡æ»¤å‡ºæ¥çš„ç»“æœã€‚ æœä¸å…¶ç„¶ï¼Œå‘ç°é‡Œé¢æœ‰ä¸‰ä¸ª [xxx isLicensed] æ–¹æ³•ï¼Œç‚¹å‡»æ–¹æ³• Hopper ä¼šè·³è½¬è‡³æ–¹æ³•å¤„ã€‚ Note: ä¸‰å¤„ [xxx isLicensed] çš„æ–¹æ³•å†…éƒ¨é€»è¾‘å‡ ä¹ä¸€æ ·ï¼Œè¿™é‡Œæ‹¿ [Bartender_3.AppDelegate isLicensed] è®²è§£ï¼Œå…¶ä»–ä¸¤å¤„ä¸åšèµ˜è¿°ã€‚ Emmmmmâ€¦ è¿™é‡Œçš„æ±‡ç¼–ä»£ç è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œè™½ç„¶æˆ‘ä¸æ˜¯å¾ˆäº†è§£ x86 çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œä¸è¿‡ Hopper å·²ç»å¸®åŠ©æˆ‘ä»¬åšäº†ä¸€äº›è¾…åŠ©æ€§å·¥ä½œã€‚å…¶ä¸­å¼€å§‹å¤„çš„ push rbp ä»¥åŠç»“æŸå¤„ pop rbp å¯ä»¥ç®€å•ç†è§£ä¸ºå…¥æ ˆå‡ºæ ˆï¼Œcall sub_100067830 å¯ä»¥ç†è§£ä¸ºè°ƒç”¨åœ°å€ 0x100067830 å¤„çš„æ–¹æ³•ï¼Œpop ä¹‹å‰çš„ movsx eax, al å’Œ ARM64 ä¸­çš„ mov æŒ‡ä»¤ç±»ä¼¼ï¼Œå¯ä»¥ç†è§£ä¸ºå°† al å†…å­˜å‚¨çš„ä¸œè¥¿ç§»åŠ¨åˆ° eax å¯„å­˜å™¨ä¸­ï¼Œeax å¯„å­˜å™¨ç”¨äºå­˜å‚¨ x86 çš„æ–¹æ³•è¿”å›å€¼ã€‚ æˆ‘ä»¬å¯ä»¥çœ‹å‡ºè¿™é‡Œè°ƒç”¨äº†åœ°å€ 0x100067830 å¤„çš„å‡½æ•°ï¼Œæ‹¿åˆ°ç»“æœä¹‹ååˆè°ƒç”¨äº† imp___stubs__$S10ObjectiveC22_convertBoolToObjCBoolyAA0eF0VSbF æ–¹æ³•å°†ç»“æœåšäº†è½¬åŒ–ï¼Œæœ€åå°†ç»“æœèµ‹å€¼ç»™ eax å¯„å­˜å™¨ç”¨äºç»“æœè¿”å›ã€‚å…¶ä¸­ imp___stubs__$S10ObjectiveC22_convertBoolToObjCBoolyAA0eF0VSbF æˆ‘ä»¬å¯ä»¥æ ¹æ®åç§°æ¨æµ‹å‡ºè¯¥æ–¹æ³•çš„ä½œç”¨åº”è¯¥æ˜¯å°† Bool è½¬åŒ–ä¸º Objective-C çš„ BOOL è€Œå·²ã€‚ é‚£ä¹ˆå…³é”®ä¿¡æ¯åº”è¯¥åœ¨ sub_100067830 å¤„ï¼ŒåŒå‡» sub_100067830 Hopper ä¼šè·³è½¬åˆ° 0x100067830 å¤„ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åˆ†æå…¶ä¸­çš„å…·ä½“å®ç°äº†ã€‚ä¸è¿‡ 0x100067830 å†…éƒ¨çš„å®ç°æ¯”è¾ƒå¤æ‚ï¼Œè·³è½¬è¿‡å»ä¹‹åå‘ç°æ±‡ç¼–ä»£ç éå¸¸å¤šï¼Œè¿˜æœ‰å¾ˆå¤šè·³è½¬â€¦ è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥é€šè¿‡ Hopper é¡¶éƒ¨ä¸­é—´é å³ä¸€ç‚¹çš„åˆ†æ ï¼Œç‚¹å‡»æ˜¾ç¤ºä¸º if(b) f(x); çš„æŒ‰é’®æŸ¥çœ‹ä¼ªä»£ç ã€‚ Hopper è§£æå‡ºæ¥çš„ä¼ªä»£ç é£æ ¼ç±»ä¼¼ Objective-C ä»£ç ï¼Œå¯ä»¥çœ‹åˆ° 0x100067830 å†…éƒ¨é€šè¿‡ NSUserDefaults ä»¥åŠå…¶ä»–çš„é€»è¾‘å®ç°ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬å…¶ä»–çš„å½¢å¼ä¸º sub_xxxxxx çš„æ–¹æ³•è°ƒç”¨ï¼Œè¿™ç§æƒ…å†µä¸‹å¦‚æœæˆ‘ä»¬ç»§ç»­è·³è½¬åˆ°è¿™äº›æ–¹æ³•çš„åœ°å€æŸ¥çœ‹å…¶å†…éƒ¨å®ç°å¾ˆæœ‰å¯èƒ½é™·å…¥é€’å½’ä¸­â€¦ é‚£ä¹ˆè¿™ç§æƒ…å†µè¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ åˆ†æé—®é¢˜ï¼Œæˆ‘ä»¬æ‰¾åˆ° [xxx isLicensed] å¹¶ä¸”è§‰å¾—è¿™æœ‰å¯èƒ½å°±æ˜¯ Bartender ä¸­åˆ¤æ–­æˆæƒä¸å¦çš„å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦å°†ä¸‰å¤„ [xxx isLicensed] çš„è¿”å›å€¼æ”¹ä¸º true å³å¯ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰å¿…è¦ä¸€æ­¥æ­¥çš„çœ‹å…¶å†…éƒ¨å®ç°ï¼Œå…ˆè¿”å› [Bartender_3.AppDelegate isLicensed] å¤„ã€‚å‰é¢è®²è¿‡åœ¨ x86 æ±‡ç¼–ä¸­ eax å¯„å­˜å™¨ç”¨äºå­˜å‚¨æ–¹æ³•çš„è¿”å›å€¼ï¼Œæˆ‘ä»¬åœ¨ [Bartender_3.AppDelegate isLicensed] æŒ‰å¿«æ·é”® option + A æ’å…¥æ±‡ç¼–ä»£ç  mov eax, 0x1 å°† eax æ°¸è¿œèµ‹å€¼ä¸º 1 å³ true ä¹‹åè·Ÿ ret å³ return æŒ‡ä»¤ç›´æ¥è®©å‡½æ•°è¿”å› true å°±å¯ä»¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„äº†ã€‚ ç”¨å¿«æ·é”® shift + command + E å¯¼å‡ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¦†ç›–åˆ°åŸ Bartender ç›®å½•ä¸­ï¼Œå°è¯•è¿è¡Œã€‚ä½ ä¼šå‘ç°ä¸€å¼€å§‹æ˜¯æˆåŠŸçš„ï¼Œå±å¹•é¡¶éƒ¨çš„èœå•æ å›¾æ ‡ä¹Ÿè¢«æ­£å¸¸ç®¡ç†äº†ï¼Œä½†æ˜¯è¿‡äº†å¤§çº¦ 10s ä¹‹åä¸€åˆ‡åˆå˜å›äº†åŸæ ·ï¼Œå¹¶ä¸”è¿˜ä¼šå¼¹å‡ºä¸€ä¸ªè¯•ç”¨æœŸåˆ°æœŸçš„å¼¹çª—â€¦ é‡æ‹¾æ€è·¯é‚£ä¹ˆæˆ‘ä»¬åˆšæ‰ä¿®æ”¹çš„ä¸‰å¤„ [xxx isLicensed] ä¸ºä»€ä¹ˆæ²¡æœ‰äº§ç”Ÿä½œç”¨å‘¢ï¼Ÿå…¶å®å®ƒå·²ç»äº§ç”Ÿä½œç”¨äº†ï¼Œè™½ç„¶æˆ‘ä»¬ä¸å¯ä»¥æ­£å¸¸ä½¿ç”¨ Bartenderï¼Œä½†æ˜¯æ‰“å¼€ Bartender çš„ License ç•Œé¢æˆ‘ä»¬å¯ä»¥å‘ç°è¿™é‡Œçš„ç•Œé¢å·²ç»æ˜¾ç¤ºæˆ‘ä»¬ä»˜è¿‡æ¬¾äº†ï¼Œå°½ç®¡è¿™å¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨å°±æ˜¯äº†â€¦ åˆ°è¿™é‡Œæˆ‘ä»¬ä¼¼ä¹æ²¡æœ‰ä»€ä¹ˆå¤´ç»ªäº†ï¼Œå› ä¸ºå»¶æ—¶æ–¹æ³•æœ‰å¾ˆå¤šï¼Œå…‰æ˜¯å‡­å€Ÿè¿™ä¸€æ¡çº¿ç´¢å¾ˆéš¾å®šä½åˆ°é˜»æ­¢æˆ‘ä»¬ç ´è§£çš„ç›®æ ‡ä»£ç ä½ç½®ã€‚ é€†å‘è¿‡ç¨‹ä¸­çš„æ€è·¯å¾ˆé‡è¦ï¼Œå¦‚æœé‡åˆ°æ€è·¯æ–­äº†çš„æƒ…å†µä¸è¦ç€æ€¥ä¹Ÿä¸è¦æ°”é¦ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°è¿è¡Œç¨‹åºï¼Œå°è¯•ä¸åŒçš„æ“ä½œå¹¶è§‚å¯Ÿæ“ä½œå¯¹åº”çš„è¡¨ç° &amp; ç»“æœã€‚ ç»è¿‡åå¤è¿è¡Œç¨‹åºï¼Œæˆ‘å‘ç°æ¯æ¬¡é‡æ–°å¯åŠ¨ Bartender éƒ½å¯ä»¥æœ‰å¤§çº¦ 10s çš„å¯ç”¨æ—¶é—´ï¼Œå¦‚æœå¯åŠ¨ä¹‹åç›´æ¥ä¸»åŠ¨ç‚¹å‡» Bartender çš„åŠŸèƒ½æŒ‰é’®åˆ™ä¼šç›´æ¥å¼¹å‡ºè¯•ç”¨æœŸåˆ°æœŸå¼¹çª—ä¸”é¡¶éƒ¨èœå•æ å›¾æ ‡ä¹Ÿä¼šç›´æ¥å›åˆ°ä¹‹å‰æ‚ä¹±çš„æ ·å­ã€‚ è¿™æ—¶å€™æˆ‘çš„æ€è·¯ä»å»¶æ—¶æ–¹æ³•è½¬ç§»åˆ°äº†è¿™ä¸ª Trial ended å¼¹çª—ä»¥åŠ Bartender çš„åŠŸèƒ½æŒ‰é’®ç‚¹å‡»ä¹‹åçš„å¯¹åº”æ–¹æ³•ä¸Šã€‚è¿™å°±æ˜¯åŠ¨æ€åˆ†æï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬é‡æ–°æ‰¾å›æ€è·¯ã€‚ æŒ‰é’®å“åº”æ–¹æ³•æœ‰äº†æ€è·¯ï¼Œå¯¹åº”çš„æ–¹æ³•å¹¶ä¸éš¾æ‰¾ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Hopper çš„ Tag Scope å…ˆæŠŠå¯èƒ½å‡ºç°çš„åŒºåŸŸæ‰¾å‡ºæ¥ï¼Œå†åˆ°å¯¹åº”çš„åŒºåŸŸä¸‹çš„æ–¹æ³•åˆ—è¡¨ä¸­å¯»æ‰¾æˆ‘ä»¬çš„ç›®æ ‡æ–¹æ³•ä½ç½®ã€‚ è¿™é‡Œæˆ‘å¾ˆå¿«å°±æ‰¾åˆ°äº†ç›®æ ‡å‡½æ•° -[_TtC11Bartender_311AppDelegate bartenderStatusItemClickWithSender:], å…¶å†…éƒ¨è°ƒç”¨äº† sub_100029ac0(arg2); å…¶ä¸­ arg2 å°±æ˜¯ senderï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ª Bartender çš„åŠŸèƒ½æŒ‰é’®äº†ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148int sub_100029ac0(int arg0) &#123; sub_100022840(arg0); rbx = **_NSApp; if (rbx == 0x0) goto loc_100029f44;loc_100029ae7: [rbx retain]; r14 = [[rbx currentEvent] retain]; rdi = rbx; if (r14 == 0x0) goto loc_100029bef;loc_100029b18: [rdi release]; if (([r14 modifierFlags] &amp; 0x80000) != 0x0) goto loc_100029b6e;loc_100029b33: [r14 retain]; if ((([r14 modifierFlags] &amp; 0x40000) != 0x0) || ([r14 type] == 0x4)) goto loc_100029b66;loc_100029bcc: rbx = [r14 type]; [r14 release]; if (rbx == 0x3) goto loc_100029b6e;loc_100029bec: rdi = r14; goto loc_100029bef;loc_100029bef: [rdi release]; r14 = [[swift_getInitializedObjCClass(@class(NSUserDefaults)) standardUserDefaults] retain]; if (*qword_1000e7e70 != 0xffffffffffffffff) &#123; swift_once(qword_1000e7e70, sub_100069790); &#125; rbx = *qword_1000ee1f8; r15 = *qword_1000ee200; swift_bridgeObjectRetain(rbx); r15 = (extension in Foundation):Swift.String._bridgeToObjectiveC() -&gt; __ObjC.NSString(rbx, r15); swift_bridgeObjectRelease(rbx); rbx = [[r14 objectForKey:r15] retain]; [r15 release]; [r14 release]; if (rbx != 0x0) &#123; swift_getObjectType(rbx); var_50 = rbx; &#125; else &#123; intrinsic_movaps(var_40, 0x0); var_50 = intrinsic_movaps(var_50, 0x0); &#125; rax = sub_10001c9a0(&amp;var_50, &amp;var_78); if (var_58 != 0x1) goto loc_100029cd8;loc_100029ccd: sub_10001c2f0(&amp;var_78); goto loc_100029d44;loc_100029d44: if (*(int8_t *)(r13 + *objc_ivar_offset__TtC11Bartender_311AppDelegate_trialEnded) == 0x1) &#123; rax = sub_1000230e0(0x1); &#125; else &#123; *(int8_t *)(r13 + *objc_ivar_offset__TtC11Bartender_311AppDelegate_performDelayedClicks) = 0x1; rax = sub_1000215f0(); if ((rax &amp; 0x1) == 0x0) &#123; rbx = *objc_ivar_offset__TtC11Bartender_311AppDelegate_performDelayedClicks; rax = *(int8_t *)(r13 + rbx); rax = !rax &amp; 0x1; *(int8_t *)(r13 + rbx) = rax; &#125; &#125; return rax;loc_100029cd8: rcx = *qword_1000e8a98; if (rcx == 0x0) &#123; rcx = swift_getObjCClassMetadata(swift_getInitializedObjCClass(@class(NSDictionary))); *qword_1000e8a98 = rcx; &#125; rax = swift_dynamicCast(&amp;var_28, &amp;var_78, *type metadata for Any + 0x8); if (rax == 0x0) goto loc_100029d44;loc_100029d24: r14 = var_28; if ([r14 count] == 0x0) goto loc_100029d8f;loc_100029d3c: [r14 release]; goto loc_100029d44;loc_100029d8f: r15 = [objc_allocWithZone(@class(NSAlert)) init]; rbx = sub_1000a7f20(&quot;No menu items have been setup&quot;, 0x1d, 0x1, rcx, 0x6); r12 = (extension in Foundation):Swift.String._bridgeToObjectiveC() -&gt; __ObjC.NSString(rbx, 0x1); swift_bridgeObjectRelease(rbx); [r15 setMessageText:r12]; [r12 release]; rbx = sub_1000a7f20(&quot;No menu items have been setup in Bartender Preferences, so Bartender is not doing anything yet. Would you like to open preferences now.&quot;, 0x87, 0x1, rcx, 0x6); r12 = (extension in Foundation):Swift.String._bridgeToObjectiveC() -&gt; __ObjC.NSString(rbx, 0x1); swift_bridgeObjectRelease(rbx); [r15 setInformativeText:r12]; [r12 release]; [r15 setAlertStyle:0x1]; rbx = sub_1000a7f20(&quot;Open Preferences&quot;, 0x10, 0x1, rcx, 0x6); r12 = (extension in Foundation):Swift.String._bridgeToObjectiveC() -&gt; __ObjC.NSString(rbx, 0x1); swift_bridgeObjectRelease(rbx); rbx = [[r15 addButtonWithTitle:r12] retain]; [r12 release]; [rbx release]; rbx = sub_1000a7f20(&quot;Dismiss&quot;, 0x7, 0x1, rcx, 0x6); r12 = (extension in Foundation):Swift.String._bridgeToObjectiveC() -&gt; __ObjC.NSString(rbx, 0x1); swift_bridgeObjectRelease(rbx); rbx = [[r15 addButtonWithTitle:r12] retain]; [r12 release]; [rbx release]; if ([r15 runModal] == 0x3e8) &#123; sub_100029a10(); &#125; [r15 release]; rax = [r14 release]; return rax;loc_100029b6e: *(int8_t *)(r13 + *objc_ivar_offset__TtC11Bartender_311AppDelegate_performDelayedClicks) = 0x0; rdi = r14; if (([rdi modifierFlags] &amp; 0x40000) == 0x0) &#123; sub_100020de0(); &#125; else &#123; if (*(int8_t *)(r13 + *objc_ivar_offset__TtC11Bartender_311AppDelegate_trialEnded) == 0x1) &#123; sub_1000230e0(0x1); &#125; else &#123; sub_100020fe0(rdi); &#125; &#125; rax = [r14 release]; return rax;loc_100029b66: [r14 release]; goto loc_100029b6e;loc_100029f44: asm &#123; ud2 &#125;; rax = sub_100029f46(); return rax;&#125; PS: ä¸ºäº†ä¾¿äºè¯»è€…ç»“åˆåé¢åˆ†æéƒ¨åˆ†çš„å†…å®¹å¿«é€Ÿå®šä½ï¼ˆCommand + Fï¼‰ï¼Œä¸Šé¢çš„ä¼ªä»£ç æ²¡æœ‰ä½¿ç”¨æˆªå›¾å½¢å¼å±•ç¤ºã€‚ å…¶ä¸­å¾ˆé†’ç›®çš„æ˜¯ objc_ivar_offset__TtC11Bartender_311AppDelegate_trialEnded æˆ‘ä»¬æŒ‰ç…§ä¹‹å‰çš„æ–¹æ³•ï¼Œå°†ä¼ªä»£ç å…ˆåˆ‡å›æ±‡ç¼–æ¨¡å¼ï¼Œæ‰¾åˆ°å¯¹åº”çš„æ±‡ç¼–ä»£ç å¤„ã€‚ è¿™æ˜¯ä¸€æ®µæ˜æ˜¾çš„ if è¯­å¥æ±‡ç¼–ä»£ç ï¼Œçœ‹ä¸‹é¢çš„ mov edi, 0x1 è¿™ä¸€å°èŠ‚å°±æ˜¯æŒ‡ objc_ivar_offset__TtC11Bartender_311AppDelegate_trialEnded ä¸º true ä¹‹åæ‰§è¡Œçš„ä»£ç ï¼Œè¡¨ç¤ºè¦æ˜¯è¯•ç”¨æœŸåˆ°æœŸå°±æ‰§è¡Œ 0x1000230e0 å¤„çš„æ–¹æ³•ã€‚æˆ‘ä»¬è®°ä¸‹è¿™ä¸ªåœ°å€ä¹‹åæŠŠè¿™ä¸¤å¤„çš„æ±‡ç¼–ä»£ç é€šè¿‡ä¸Šæ–‡æ’å…¥æ±‡ç¼–ä»£ç çš„æ–¹å¼ä¿®æ”¹ä¸€ä¸‹ï¼Œå°†è¿™ä¸ª objc_ivar_offset__TtC11Bartender_311AppDelegate_trialEnded ç›´æ¥æ›¿æ¢ä¸º 0x0 å³ false ã€‚ åœ¨é€†å‘å·¥ç¨‹ä¸­ï¼Œåˆ‡å¿Œä¸å¯ä»¥å†’è¿›ï¼Œæ—¶å€¼ä»Šæ—¥å‡ ä¹æ‰€æœ‰åº”ç”¨éƒ½ä¼šé‡‡å–æªæ–½æ¥å¢åŠ å…¶é€†å‘éš¾åº¦ã€‚è¿™æ—¶å€™åƒä¸‡ä¸è¦æƒ³ç€ä¸€æ­¥åˆ°ä½ï¼Œåº”è¯¥åœ¨é€‚é‡ä¿®æ”¹ä¹‹åå°è¯•å¯¼å‡ºäºŒè¿›åˆ¶ï¼Œç”¨åŠ¨æ€åˆ†æçš„æ–¹æ³•éªŒè¯ä¸€ä¸‹ç»“æœã€‚å› ä¸ºæˆ‘ä»¬è¿™æ—¶å€™ä¸æ˜¯æ­£å‘å¼€å‘è€…ï¼Œåœ¨æ²¡æœ‰è§åˆ°ä¸Šä¸‹æ–‡çš„æƒ…å†µä¸‹ä¿®æ”¹ä»£ç å¾ˆå¯èƒ½ä¼šæŠŠç¨‹åºæ”¹æˆä¸€ä¸ªä¸å¯ç”¨çš„çŠ¶æ€ï¼ˆæ¯”å¦‚æ­£å¸¸åŠŸèƒ½æŸåæˆ–è€…é¢‘ç¹ Crashï¼‰ï¼Œæ‰€ä»¥æœ€å¥½æ­¥æ­¥ä¸ºè¥ã€‚ è¿™é‡Œæˆ‘ä»¬å¯¼å‡ºä¿®æ”¹ä¹‹åçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒæŒ‰ç…§ Bartender çš„åŸè·¯å¾„è¦†ç›–ä¹‹å‰çš„äºŒè¿›åˆ¶æ–‡ä»¶éªŒè¯ä¸€ä¸‹ç»“æœã€‚æˆ‘åœ¨è¿™ä¸ªé˜¶æ®µè¿è¡Œæ—¶å‘ç°å¦‚æœæ­£å¸¸å¼€å¯ Bartender è¿˜æ˜¯ä¼šæœ‰ä¸€ä¸ª 10s å·¦å³çš„å¯ç”¨æ—¶é•¿ï¼Œä¹‹åä¾ç„¶ä¼šå¼¹å‡ºè¯•ç”¨æœŸåˆ°æœŸå¼¹çª—ï¼Œå¹¶ä¸”ç¨‹åºå˜ä¸ºä¸å¯ç”¨çŠ¶æ€ï¼›è€Œå¦‚æœé‡å¯ Bartender åœ¨è¯•ç”¨æœŸå¼¹çª—å¼¹å‡ºä¹‹å‰ç‚¹å‡»åŠŸèƒ½æŒ‰é’®åˆ™å¯ä»¥æ­£å¸¸åˆ‡æ¢ï¼Œä½†æ˜¯å†æ¬¡ç‚¹å‡»æŒ‰é’®å´åˆ‡æ¢ä¸å›æ¥äº†ï¼Œå¹¶ä¸”ç¨‹åºè¿è¡Œ 10s å·¦å³ä»ä¼šå¼¹å‡ºè¯•ç”¨æœŸåˆ°æœŸå¼¹çª—ï¼Œä½†æ˜¯èœå•æ ä¸Šé¢çš„å›¾æ ‡ä¸ä¼šå˜å¤±æ•ˆï¼Œåªæ˜¯åˆ‡ä¸å›å»è€Œå·²ã€‚ åŠŸèƒ½ç ´è§£åˆ°ç›®å‰ä¸ºæ­¢å¦‚æœä¸åœ¨ä¹åŠŸèƒ½ä»…ä»…æƒ³è¦éšè—èœå•æ çš„å›¾æ ‡å·²ç»æ˜¯å¯ä»¥å‡‘åˆç”¨äº†ï¼Œä½†æ˜¯è¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„æœ€ç»ˆç»“æœã€‚ é€šè¿‡ä¸Šé¢è¿è¡Œç¨‹åºåè§‚å¯Ÿåˆ°çš„æƒ…å†µæˆ‘æ¨æµ‹åœ¨ -[_TtC11Bartender_311AppDelegate bartenderStatusItemClickWithSender:] å†…éƒ¨åˆ‡æ¢å›æ¥çš„é€»è¾‘ä¸­ä»ç„¶æœ‰åœ°æ–¹å¯¹æ˜¯å¦åˆ°æœŸåšäº†åˆ¤æ–­ï¼Œæˆ‘ä»¬ä¸Šé¢åªæ˜¯æˆåŠŸä¿®æ”¹äº†åˆ‡æ¢è¿‡å»çš„é€»è¾‘ï¼Œé‚£ä¹ˆåˆ‡æ¢å›æ¥çš„é€»è¾‘åœ¨å“ªå‘¢ï¼Ÿ æŒ‰é€»è¾‘æ¨æµ‹ï¼Œæ­£å‘åˆ‡æ¢çš„æ—¶å€™æ˜¯ä½¿ç”¨ objc_ivar_offset__TtC11Bartender_311AppDelegate_trialEnded åšåˆ¤æ–­ï¼Œåå‘åˆ‡æ¢åº”è¯¥åŒç†æ‰å¯¹ï¼Œæˆ‘ä»¬å»è¿½è¸ª objc_ivar_offset__TtC11Bartender_311AppDelegate_trialEnded çš„ä½¿ç”¨ï¼Œæœ€ç»ˆå‘ç° sub_10001f870 ä¸­ä½¿ç”¨äº† objc_ivar_offset__TtC11Bartender_311AppDelegate_trialEnded ä¸” sub_10001f870 è¢« sub_100029a10 è°ƒç”¨ï¼Œsub_100029a10 åˆè¢« sub_100029ac0 è°ƒç”¨ï¼Œsub_100029ac0 å°±æ˜¯ä¸Šæ–‡åœ¨ -[_TtC11Bartender_311AppDelegate bartenderStatusItemClickWithSender:] ä¸­è¢«è°ƒç”¨çš„å‡½æ•°ï¼Œè¿™ä¸ä»…æ»¡è¶³äº†è¢« Bartender åŠŸèƒ½æŒ‰é’®æ‰€å¼•ç”¨çš„æ¡ä»¶ï¼ŒåŒæ—¶è¿˜å¯¹ objc_ivar_offset__TtC11Bartender_311AppDelegate_trialEnded æœ‰æ‰€å¼•ç”¨ï¼Œæ‰€ä»¥æˆ‘ç”¨æ’å…¥æ±‡ç¼–çš„æ–¹å¼å°† sub_10001f870 ä¸­å…³äº objc_ivar_offset__TtC11Bartender_311AppDelegate_trialEnded çš„ä½¿ç”¨æ”¹ä¸ºäº† 0x0ï¼Œå³ falseã€‚ å˜›~ å¯¼å‡ºäºŒè¿›åˆ¶è¦†ç›–ï¼Œå‘ç°è¿™æ¬¡çš„ Bartender å·²ç»å¯ä»¥æ­£å¸¸ä½¿ç”¨åŠŸèƒ½äº†ï¼Œä¸è¿‡è¯•ç”¨æœŸåˆ°æœŸçš„å¼¹çª—é—®é¢˜ä¾ç„¶å­˜åœ¨ï¼Œå°½ç®¡å®ƒå¹¶ä¸å½±å“ä½¿ç”¨ï¼Œä½†æˆ‘è¿˜æ˜¯æ— æ³•æ¥å—è¿™æ ·ä¸€ä¸ªåŠæˆå“çš„çŠ¶æ€ã€‚ å®Œç¾ç ´è§£è¿˜è®°å¾—ä¸Šæ–‡ä¸­å¾—å‡ºçš„ 0x1000230e0 å—ï¼Œå¦‚æœè¯•ç”¨æœŸåˆ°æœŸåˆ™ä¼šæ‰§è¡Œ 0x1000230e0 åœ°å€å¤„çš„æ–¹æ³•ï¼Œæˆ‘ä»¬é€šè¿‡å¿«æ·é”® G è·³è½¬åˆ° 0x1000230e0 åœ°å€ï¼Œçœ‹ä¸€ä¸‹é‡Œé¢çš„å®ç°é€»è¾‘ã€‚ 123456789101112131415161718192021222324252627282930313233void sub_1000230e0(int arg0) &#123; r14 = arg0; r15 = r13 + *objc_ivar_offset__TtC11Bartender_311AppDelegate_trialOverWindow; rbx = swift_unknownWeakLoadStrong(r15); if (rbx != 0x0) &#123; [rbx center]; [rbx release]; rbx = **_NSApp; if (rbx != 0x0) &#123; [rbx retain]; [rbx activateIgnoringOtherApps:sign_extend_64($S10ObjectiveC22_convertBoolToObjCBoolyAA0eF0VSbF(r14 &amp; 0xff))]; [rbx release]; rbx = swift_unknownWeakLoadStrong(r15); if (rbx != 0x0) &#123; [rbx makeKeyAndOrderFront:0x0]; [rbx release]; &#125; else &#123; asm &#123; ud2 &#125;; sub_100023199(); &#125; &#125; else &#123; asm &#123; ud2 &#125;; loc_100023195(); &#125; &#125; else &#123; asm &#123; ud2 &#125;; loc_100023191(); &#125; return;&#125; é€šè¿‡ä¸Šé¢çš„ä¼ªä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥åˆæ­¥åˆ¤æ–­è¿™ä¸ª 0x1000230e0 å†…éƒ¨å°±æ˜¯å¼¹å‡ºè¯•ç”¨æœŸåˆ°æœŸå¼¹çª—çš„æ–¹æ³•ã€‚æ¥ç€æˆ‘ä»¬é€šè¿‡å¿«æ·é”® X æŸ¥çœ‹å…³äº 0x1000230e0 çš„å¼•ç”¨ï¼Œå¯ä»¥å‘ç°æœ‰ä¸‰å¤„è°ƒç”¨ï¼Œä¸€ä¸ªä¸€ä¸ªçœ‹ä¸‹å»å‘ç°ç¬¬ä¸€ä¸ª sub_100022840 ä¸­çš„è°ƒç”¨æœ€åƒæ˜¯å»¶æ—¶è°ƒç”¨ï¼Œå› ä¸ºå…¶ä¸­æœ‰ Hopper åç¼–è¯‘å‡ºæ¥çš„ Dispatch ç›¸å…³çš„ä¼ªä»£ç ã€‚ 123456789101112$Ss10SetAlgebraPyxqd__cs8SequenceRd__7ElementQyd__ADRtzlufCTj(&amp;var_A0, r13); swift_release(*__swiftEmptyArrayStorage); (extension in Dispatch):__ObjC.OS_dispatch_queueasyncAfterdeadlineqosflags.execute(Dispatch.DispatchTime, Dispatch.DispatchQoS, Dispatch.DispatchWorkItemFlags, @convention(block) () -&gt; ()) -&gt; ()(var_40, var_68, var_B0, var_30); (*(var_D0 + 0x8))(var_B0, var_C8); (*(var_C0 + 0x8))(var_68, var_B8); _Block_release(var_30); swift_release(var_D8); (var_38)(var_40, var_70, rdx); [var_A8 release]; sub_1000230e0(0x0); rbx = var_48; goto loc_100022df5; åˆ‡åˆ°æ±‡ç¼–æ¨¡å¼ï¼Œæ‰¾åˆ°å¯¹åº”çš„æ±‡ç¼–ä»£ç ã€‚ ç”±äº sub_1000230e0(0x0); æ˜¯åœ¨ Dispatch ä¸­è°ƒç”¨çš„ï¼Œè€ƒè™‘åˆ°ä¿®æ”¹åç¨‹åºçš„ç¨³å®šæ€§ï¼Œè¿™é‡Œé€šè¿‡ Hopper çš„ Modify èœå•ä¸­æä¾›çš„ NOP Region å¡«å¹³ call sub_1000230e0 æ±‡ç¼–ä»£ç ã€‚ è€è§„çŸ©ï¼Œå¯¼å‡ºäºŒè¿›åˆ¶æ–‡ä»¶è¦†ç›– Bartender ä¸­çš„äºŒè¿›åˆ¶åé‡å¯ Bartender éªŒæ”¶æˆæœã€‚ æ¸…çˆ½~ è¿™æ¬¡è¿è¡Œ Bartender å‘ç°ä¸ä½†å¯ä»¥æ­£å¸¸ä½¿ç”¨åŠŸèƒ½ï¼Œä¹‹å‰çƒ¦äººçš„è¯•ç”¨æœŸåˆ°æœŸå¼¹çª—ä¹Ÿè¢«æˆ‘ä»¬æˆåŠŸå¹²æ‰äº†ã€‚ æ€»ç»“ æ–‡ç« ç®€å•ä»‹ç»äº†æœ¬æ¬¡è¦ç ´è§£çš„ç›®æ ‡ Mac åº”ç”¨ Bartenderï¼Œå¦‚æœå„ä½åŒå­¦è¿˜æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„é¡¶éƒ¨èœå•æ å›¾æ ‡ç®¡ç†å·¥å…·ä¸å¦¨è¯•ç€ä½¿ç”¨ Bartenderã€‚ æ–‡ç« ä»‹ç»äº† maxOS ä¸ iOS é€†å‘å·¥ç¨‹ä¸­ä¸»æµçš„é™æ€åˆ†æå·¥å…· Hopperï¼Œä»æ–‡ç« åé¢ç ´è§£ Bartender çš„å®æˆ˜è¿‡ç¨‹ä¸­å°±å¯ä»¥çœ‹å‡º Hopper å¯¹äºæˆ‘ä»¬é€†å‘è¿‡ç¨‹çš„å¸®åŠ©æœ‰å¤šä¹ˆå¤§ã€‚ æ–‡ç« æœ€åè¯¦ç»†è®²è¿°äº†æˆ‘åœ¨ç ´è§£ Bartender è¿‡ç¨‹ä¸­çš„ç»å†ï¼Œä»åˆå§‹å¸¸è§„æ€è·¯åˆ°ä¸èµ·ä½œç”¨æ€è·¯è¢«æˆªæ–­å†åˆ°é€šè¿‡åŠ¨æ€åˆ†æé‡æ‹¾æ€è·¯â€¦ä¸€ç›´åˆ°æœ€åçš„å®Œç¾ç ´è§£ä¸­é—´ç»å†äº†è®¸å¤šå…³é”®èŠ‚ç‚¹ï¼Œå¸Œæœ›å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ã€‚ æ¯ä¸€æ¬¡é€†å‘çš„è¿‡ç¨‹éƒ½æ˜¯æœªçŸ¥çš„ï¼Œæœ‰çš„æ—¶å€™å¯èƒ½ä¼šå¾ˆé¡ºåˆ©ï¼ˆç›´æ¥ mov eax, 0x1 + ret å°±æå®šï¼‰ï¼Œæœ‰çš„æ—¶å€™å¯èƒ½ä¼šå¾ˆæ›²æŠ˜ï¼Œæœ‰çš„æ—¶å€™å¯èƒ½è¿˜ä¼šä»¥å¤±è´¥æ”¶å°¾ã€‚æˆ‘å†™è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯æƒ³ä¸å¤§å®¶äº¤æµåœ¨é€†å‘è¿‡ç¨‹ä¸­çš„å¸¸è§„æ–¹æ³•ä»¥åŠé‡åˆ°å›°éš¾æ—¶çš„ä¸€äº›è§£å†³æ€è·¯ï¼Œå…¶å®ä¸è®ºæ˜¯ Bartender è¿˜æ˜¯å…¶ä»–åº”ç”¨ï¼Œä¸è®ºæ˜¯ Mac åº”ç”¨è¿˜æ˜¯ iOS åº”ç”¨ï¼Œé€†å‘çš„æ€è·¯éƒ½æ˜¯ç›¸é€šçš„ï¼Œæ„¿å„ä½åŒå­¦æ—¥åå¯ä»¥ä¸¾ä¸€åä¸‰ã€‚ å¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æ–‡ç« ä¸‹æ–¹ç•™è¨€æˆ–åœ¨æˆ‘çš„å¾®åš @Lision è”ç³»æˆ‘ï¼ŒçœŸå¿ƒå¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~"},{"title":"WWDC18 Whatâ€™s New in LLVM","comments":true,"permalink":"https://lision.me/wwdc18_llvm/","text":"å‰è¨€LLVM ä½œä¸º Apple å¾¡ç”¨çš„ç¼–è¯‘åŸºç¡€è®¾æ–½å…¶é‡è¦æ€§ä¸è¨€è€Œå–»ï¼ŒApple ä»æœªåœæ­¢å¯¹ LLVM çš„ç»´æŠ¤å’Œæ›´æ–°ï¼Œå¹¶ä¸”å‡ ä¹åœ¨æ¯å¹´çš„ WWDC ä¸­éƒ½æœ‰ä¸“é—¨çš„ Session æ¥é’ˆå¯¹ LLVM çš„æ–°ç‰¹æ€§åšä»‹ç»å’Œè®²è§£ï¼Œåˆšåˆšè¿‡å»çš„ WWDC18 ä¹Ÿä¸ä¾‹å¤–ã€‚ WWDC18 Session 409 Whatâ€™s New in LLVM ä¸­ Apple çš„å·¥ç¨‹å¸ˆä»¬åˆä¸ºæˆ‘ä»¬ä»‹ç»äº† LLVM æœ€æ–°çš„ç‰¹æ€§ï¼Œè¿™ç¯‡æ–‡ç« å°†ä¼šç»“åˆ WWDC18 Session 409 ç»™å‡ºçš„ å®˜æ–¹æ¼”ç¤ºæ–‡ç¨¿ åˆ†äº«ä¸€ä¸‹ LLVM çš„æ–°ç‰¹æ€§å¹¶è°ˆè°ˆç¬”è€…è‡ªå·±ä¸ªäººå¯¹è¿™äº›ç‰¹æ€§çš„æ‹™è§ã€‚ Note: æœ¬æ–‡ä¸ä¼šå¯¹å®˜æ–¹æ¼”ç¤ºæ–‡ç¨¿åšé€å­—é€å¥çš„ç¿»è¯‘å·¥ä½œï¼Œäº¦ä¸ä¼šå»è¿‡å¤šä»‹ç» LLVM çš„åŸºæœ¬å¸¸è¯†ã€‚ ç´¢å¼• ARC æ›´æ–° Xcode 10 æ–°å¢è¯Šæ–­ Clang é™æ€åˆ†æ å¢åŠ å®‰å…¨æ€§ æ–°æŒ‡ä»¤é›†æ‰©å±• æ€»ç»“ ARC æ›´æ–°æœ¬æ¬¡ ARC æ›´æ–°çš„äº®ç‚¹åœ¨äº C struct ä¸­å…è®¸ä½¿ç”¨ ARC Objective-C å¯¹è±¡ã€‚ åœ¨ä¹‹å‰ç‰ˆæœ¬çš„ Xcode ä¸­å°è¯•åœ¨ C struct çš„å®šä¹‰ä¸­ä½¿ç”¨ Objâ€”C å¯¹è±¡ï¼Œç¼–è¯‘å™¨ä¼šæŠ›å‡º Error: ARC forbids Objective-C objects in structï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å˜›~ è¿™æ˜¯å› ä¸ºä¹‹å‰ LLVM ä¸æ”¯æŒï¼Œå¦‚æœåœ¨ Xcode 10 ä¸­ä¹¦å†™åŒæ ·çš„ä»£ç åˆ™ä¸ä¼šæœ‰ä»»ä½• Warning ä¸ Errorï¼š é‚£ä¹ˆç›´æ¥åœ¨ C struct ä¸­ä½¿ç”¨ Objective-C å¯¹è±¡çš„è¯éš¾é“å°±æ²¡æœ‰å†…å­˜ä¸Šçš„é—®é¢˜å—ï¼ŸObjective-C æ‰€å ç”¨çš„å†…å­˜ç©ºé—´æ˜¯ä½•æ—¶è¢«é”€æ¯çš„å‘¢ï¼Ÿ 1234567// ARC Object Pointers in C Structs!typedef struct &#123; NSString *name; NSNumber *price;&#125; MenuItem; void orderFreeFood(NSString *name) &#123; MenuItem item = &#123; name, [NSNumber numberWithInt:0] &#125;; // [item.name retain]; // [item.price retain]; orderMenuItem(item); // [item.name release]; // [item.price release]; &#125; å¦‚ä¸Šè¿°ä»£ç æ‰€ç¤ºï¼Œç¼–è¯‘å™¨ä¼šåœ¨ C struct MenuItem åˆ›å»ºå retain å…¶ä¸­çš„ ARC Objective-C å¯¹è±¡ï¼Œå¹¶åœ¨ orderMenuItem(item); è¯­å¥ä¹‹åï¼Œå³å…¶ä»–ä½¿ç”¨ MenuItem item çš„å‡½æ•°è°ƒç”¨ç»“æŸä¹‹å release æ‰ç›¸å…³ ARC Objective-C å¯¹è±¡ã€‚ æ€è€ƒï¼Œåœ¨åŠ¨æ€å†…å­˜ç®¡ç†æ—¶ï¼ŒARC Objective-C å¯¹è±¡çš„å†…å­˜ç®¡ç†ä¼šæœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ Note: åŠ¨æ€å†…å­˜ç®¡ç†ï¼ˆDynamic Memory Managementï¼‰ï¼ŒæŒ‡é int a[100]; æˆ– MenuItem item = &#123;name, [NSNumber numberWithInt:0]&#125;; è¿™ç§åœ¨å†³å®šäº†ä½¿ç”¨å“ªä¸€å­˜å‚¨ç»“æ„ä¹‹åï¼Œå°±è‡ªåŠ¨å†³å®šäº†ä½œç”¨åŸŸå’Œå­˜å‚¨æ—¶æœŸçš„ä»£ç ï¼Œè¿™ç§ä»£ç å¿…é¡»æœä»é¢„å…ˆåˆ¶å®šçš„å†…å­˜ç®¡ç†è§„åˆ™ã€‚ æˆ‘ä»¬çŸ¥é“ C è¯­è¨€ä¸­å¦‚æœæƒ³è¦çµæ´»çš„åˆ›å»ºä¸€ä¸ªåŠ¨æ€å¤§å°çš„æ•°ç»„éœ€è¦è‡ªå·±æ‰‹åŠ¨å¼€è¾Ÿã€ç®¡ç†ã€é‡Šæ”¾ç›¸å…³çš„å†…å­˜ï¼Œç¤ºä¾‹ï¼š 1234567891011121314151617void foo() &#123; int max; double *ptd; puts(&quot;What is the maximum number of type double entries?&quot;); scanf(&quot;%d&quot;, &amp;max); ptd = malloc(max * sizeof(double)); if (ptd == NULL) &#123; // memory allocation failed ... &#125; // some logic ... free(ptd);&#125; é‚£ä¹ˆ C struct ä¸­ ARC Objective-C çš„åŠ¨æ€å†…å­˜ç®¡ç†æ˜¯å¦åº”è¯¥è¿™ä¹ˆå†™å‘¢ï¼Ÿ 123456// Structs with ARC Fields Need Care for Dynamic Memory Managementtypedef struct &#123; NSString *name; NSNumber *price;&#125; MenuItem; void testMenuItems() &#123; // Allocate an array of 10 menu items MenuItem *items = malloc(10 * sizeof(MenuItem)); orderMenuItems(items, 10); free(items); &#125; ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼ å¯ä»¥çœ‹åˆ°é€šè¿‡ malloc å¼€è¾Ÿå†…å­˜åˆå§‹åŒ–å¸¦æœ‰ ARC Objective-C çš„ C struct ä¸­ ARC Objective-C æŒ‡é’ˆä¸ä¼š zero-initializedã€‚ å˜›~ è¿™ä¸ªæ—¶å€™è‡ªç„¶è€Œç„¶çš„ä¼šæƒ³èµ·ä½¿ç”¨ calloc ^_^ Note: calloc å’Œ malloc å‡å¯å®Œæˆå†…å­˜åˆ†é…ï¼Œä¸åŒä¹‹å¤„åœ¨äº calloc ä¼šå°†åˆ†é…è¿‡æ¥çš„å†…å­˜å—ä¸­å…¨éƒ¨ä½ç½®éƒ½ç½® 0ï¼ˆç„¶è€Œè¦æ³¨æ„ï¼Œåœ¨æŸäº›ç¡¬ä»¶ç³»ç»Ÿä¸­ï¼Œæµ®ç‚¹å€¼ 0 ä¸æ˜¯å…¨éƒ¨ä½ä¸º 0 æ¥è¡¨ç¤ºçš„ï¼‰ã€‚ å¦ä¸€ä¸ªé—®é¢˜å°±æ˜¯ free(items); è¯­å¥æ‰§è¡Œä¹‹å‰ï¼ŒARC Objective-C å¹¶æ²¡æœ‰è¢«æ¸…ç†ã€‚ Emmmmmâ€¦ å®˜æ–¹æ¨èçš„å†™æ³•æ˜¯åœ¨ free(items); ä¹‹å‰å°† items å†…çš„æ‰€æœ‰ struct ä¸­ä½¿ç”¨åˆ°çš„ ARC Objective-C æŒ‡é’ˆæ‰‹åŠ¨èŒä½ nil â€¦ æ‰€ä»¥åœ¨åŠ¨æ€å†…å­˜ç®¡ç†æ—¶ï¼Œä¸Šé¢çš„ä»£ç åº”è¯¥è¿™ä¹ˆå†™ï¼š 123456// Structs with ARC Fields Need Care for Dynamic Memory Managementtypedef struct &#123; NSString *name; NSNumber *price;&#125; MenuItem; void testMenuItems() &#123; // Allocate an array of 10 menu items MenuItem *items = calloc(10, sizeof(MenuItem)); orderMenuItems(items, 10); // ARC Object Pointer Fields Must be Cleared Before Deallocation for (size_t i = 0; i &lt; 10; ++i) &#123; items[i].name = nil; items[i].price = nil; &#125; free(items); &#125; ç¬é—´æœ‰ç§æ—¥äº†ç‹—çš„æ„Ÿè§‰æœ‰æœ¨æœ‰ï¼Ÿ ä¸ªäººè§‚ç‚¹å˜›~ åœ¨ C struct ä¸­å¢åŠ å¯¹ ARC Objective-C å¯¹è±¡å­—æ®µçš„æ”¯æŒæ„å‘³ç€æˆ‘ä»¬ä»Šå Objective-C å¯ä»¥æ„å»ºè·¨è¯­è¨€æ¨¡å¼çš„äº¤äº’æ“ä½œã€‚ Note: å®˜æ–¹å£°æ˜ä¸ºäº†ç»Ÿä¸€ ARC ä¸ manual retain/release (MRR) ä¸‹éƒ¨åˆ† function æŒ‰å€¼ä¼ é€’ã€è¿”å› struct å¯¹ Objective-C++ ABI åšå‡ºäº†äº›è®¸è°ƒæ•´ã€‚ å€¼å¾—ä¸€æçš„æ˜¯ Swift å¹¶ä¸æ”¯æŒè¿™ä¸€ç‰¹æ€§ï¼ˆ2333~ è°è¯´ Objective-C çš„æ›´æ–°éƒ½æ˜¯ä¸ºäº†è¿åˆ Swift çš„å˜åŒ–ï¼‰ã€‚ Xcode 10 æ–°å¢è¯Šæ–­Swift ä¸ Objective-C äº’é€šæ€§æˆ‘ä»¬éƒ½çŸ¥é“ Swift ä¸ Objective-C å…·æœ‰ä¸€å®šç¨‹åº¦çš„äº’é€šæ€§ï¼Œå³ Swift ä¸ Objective-C å¯ä»¥æ··ç¼–ï¼Œåœ¨æ··ç¼–æ—¶ Xcode ç”Ÿæˆä¸€ä¸ªå¤´æ–‡ä»¶å°† Swift å¯ä»¥è½¬åŒ–ä¸º Objective-C çš„éƒ¨åˆ†æ¥å£æš´éœ²å‡ºæ¥ã€‚ ä¸è¿‡ç”±äº Swift ä¸ Objective-C çš„å…¼å®¹æ€§å¯¼è‡´ç”¨ Swift å®ç°çš„éƒ¨åˆ†ä»£ç æ— æ³•è½¬æ¢ç»™ Objective-C ä½¿ç”¨ã€‚ è¿‘äº›å¹´æ¥ LLVM ä¸€è‡´éƒ½åœ¨å°è¯•è®©è¿™ä¸¤ç§è¯­è¨€å¯ä»¥æ›´å¥½çš„äº’é€šï¼ˆè¿™ä¹Ÿå°±æ˜¯ä¸Šæ–‡ä¸­æåˆ° Objective-C çš„æ›´æ–°éƒ½æ˜¯ä¸ºäº†è¿åˆ Swift è¯´æ³•çš„ç”±æ¥ï¼‰ï¼Œæœ¬æ¬¡ LLVM æ”¯æŒå°† Swift ä¸­çš„é—­åŒ…ï¼ˆClosuresï¼‰å¯¼å…¥ Objective-Cã€‚ 123@objc protocol Executor &#123; func performOperation(handler: () -&gt; Void)&#125; 1234#import â€œExecutor-Swift.hâ€@interface DispatchExecutor : NSObject&lt;Executor&gt;- (void)performOperation:(void (^)(void))handler; @end Note: åœ¨ Swift ä¸­é—­åŒ…é»˜è®¤éƒ½æ˜¯éé€ƒé€¸é—­åŒ…ï¼ˆnon-escaping closuresï¼‰ï¼Œå³é—­åŒ…ä¸åº”è¯¥åœ¨å‡½æ•°è¿”å›ä¹‹åæ‰§è¡Œã€‚ Objective-C ä¸­ä¸ Swift é—­åŒ…å¯¹åº”çš„å°±æ˜¯ Block äº†ï¼Œä½†æ˜¯ Objective-C ä¸­çš„ Block å¹¶æ²¡æœ‰è¯¸å¦‚ Swift ä¸­é€ƒé€¸ä¸å¦çš„é™åˆ¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿™æ ·å°† Swift çš„éé€ƒé€¸é—­åŒ…è½¬ä¸º Objective-C ä¸­æ— é™åˆ¶çš„ Block å²‚ä¸æ˜¯ä¼šæœ‰é—®é¢˜ï¼Ÿ åˆ«æ‹…å¿ƒï¼Œè½¬æ¢è¿‡æ¥çš„é—­åŒ…ï¼ˆéé€ƒé€¸ï¼‰ä¼šæœ‰ Warnning æç¤ºï¼Œè€Œä¸”æˆ‘ä»¬è¯´è¿‡ä¸€èˆ¬è¿™ç§æƒ…å†µä¸‹ Apple çš„å·¥ç¨‹å¸ˆéƒ½ä¼šåœ¨ LLVM ä¸º Objective-C åŠ ä¸€ä¸ªå®æ¥è¿åˆ Swiftâ€¦ 12// Warning for Missing Noescape Annotations for Method Overrides #import â€œExecutor-Swift.hâ€ @interface DispatchExecutor : NSObject&lt;Executor&gt; - (void)performOperation:(NS_NOESCAPE void (^)(void))handler; @end @implementation DispatchExecutor - (void)performOperation:(NS_NOESCAPE void (^)(void))handler &#123; &#125;// Programmer must ensure that handler is not called after performOperation returns @end ä¸ªäººè§‚ç‚¹å¦‚æœ Swift 5 çœŸçš„å¯ä»¥åšåˆ° ABI ç¨³å®šï¼Œé‚£ä¹ˆ Swift ä¸ Objective-C æ··ç¼–çš„ App åŒ…å¤§å°ä¹Ÿåº”è¯¥å›å½’æ­£å¸¸ï¼Œç›¸ä¿¡å¾ˆå¤šå…¬å¸çš„é¡¹ç›®éƒ½ä¼šæ…¢æ…¢ä» Objective-C è½¬å‘ Swiftã€‚åœ¨ Swift ä¸­é—­åŒ…ï¼ˆClosuresï¼‰ä½œä¸ºä¸€ç­‰å…¬æ°‘çš„å­˜åœ¨å¥ å®šäº† Swift ä½œä¸ºå‡½æ•°å¼è¯­è¨€çš„æ ¹åŸºï¼Œæœ¬æ¬¡ LLVM æä¾›äº†å°† Swift ä¸­çš„ Closures ä¸ Objective-C ä¸­çš„ Block äº’é€šè½¬æ¢çš„æ”¯æŒæ— ç–‘æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚ ä½¿ç”¨ #pragma pack æ‰“åŒ… Struct æˆå‘˜Emmmmmâ€¦ è€å®è¯´è¿™ä¸€èŠ‚çš„å†…å®¹æ›´åº•å±‚ï¼Œæ‰€ä»¥å¯èƒ½ä¼šæ¯”è¾ƒæ™¦æ¶©ï¼Œå¸Œæœ›è‡ªå·±å¯ä»¥è¡¨è¿°æ¸…æ¥šå§ã€‚åœ¨ C è¯­è¨€ä¸­ struct æœ‰ å†…å­˜å¸ƒå±€ï¼ˆmemory layoutï¼‰ çš„æ¦‚å¿µï¼ŒC è¯­è¨€å…è®¸ç¼–è¯‘å™¨ä¸ºæ¯ä¸ªåŸºæœ¬ç±»å‹æŒ‡å®šä¸€äº›å¯¹é½æ–¹å¼ï¼Œé€šå¸¸æƒ…å†µä¸‹æ˜¯ä»¥ç±»å‹çš„å¤§å°ä¸ºæ ‡å‡†å¯¹é½ï¼Œä½†æ˜¯å®ƒæ˜¯ç‰¹å®šäºå®ç°çš„ã€‚ å˜›~ è¿˜æ˜¯ä¸¾ä¸ªä¾‹å­å§ï¼Œå°±æ‹¿ WWDC18 å®˜æ–¹æ¼”ç¤ºæ–‡ç¨¿ä¸­çš„å§ï¼š 12345struct Struct &#123; uint8_t a, b; // 2 byte padding uint32_t c;&#125;; åœ¨ä¸Šè¿°ä¾‹å­ä¸­ï¼Œç¼–è¯‘å™¨ä¸ºäº†å¯¹é½å†…å­˜å¸ƒå±€ä¸å¾—ä¸åœ¨ Struct çš„ç¬¬äºŒå­—æ®µä¸ç¬¬ä¸‰å­—æ®µä¹‹é—´æ’å…¥ 2 ä¸ª byteã€‚ 123| 1 | 2 | 3 | 4 || a | b | pad.......... || c(1) | c(2) | c(3) | c(4) | è¿™æ ·æœ¬è¯¥å ç”¨ 6 byte çš„ struct å°±å ç”¨äº† 8 byteï¼Œå°½ç®¡å…¶ä¸­åªæœ‰ 6 byte çš„æ•°æ®ã€‚ C è¯­è¨€å…è®¸æ¯ä¸ªè¿œç¨‹ç°ä»£ç¼–è¯‘å™¨å®ç° #pragma packï¼Œå®ƒå…è®¸ç¨‹åºçŒ¿å¯¹å¡«å……è¿›è¡Œæ§åˆ¶æ¥ä¾ä» ABIã€‚ From C99 Â§6.7.2.1: 12 Each non-bit-field member of a structure or union object is aligned in an implementation- defined manner appropriate to its type. 13 Within a structure object, the non-bit-field members and the units in which bit-fields reside have addresses that increase in the order in which they are declared. A pointer to a structure object, suitably converted, points to its initial member (or if that member is a bit-field, then to the unit in which it resides), and vice versa. There may be unnamed padding within a structure object, but not at its beginning. å®é™…ä¸Šå…³äº #pragma pack çš„ç›¸å…³ä¿¡æ¯å¯ä»¥åœ¨ MSDN page ä¸­æ‰¾åˆ°ã€‚ LLVM æœ¬æ¬¡ä¹ŸåŠ å…¥äº†å¯¹ #pragma pack çš„æ”¯æŒï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š 123456#pragma pack (push, 1) struct PackedStruct &#123; uint8_t a, b; uint32_t c; &#125;;#pragma pack (pop) ç»è¿‡ #pragma pack ä¹‹åæˆ‘ä»¬çš„ struct å¯¹é½æ–¹å¼å¦‚ä¸‹ï¼š 1234567| 1 || a | | b || c(1) || c(2) || c(3) || c(4) | å…¶å® #pragma pack (push, 1) ä¸­çš„ 1 å°±æ˜¯å¯¹é½å­—èŠ‚æ•°ï¼Œå¦‚æœè®¾ç½®ä¸º 4 é‚£ä¹ˆå¯¹é½æ–¹å¼åˆä¼šå˜å›åˆ°æœ€åˆçš„çŠ¶æ€ï¼š 123| 1 | 2 | 3 | 4 || a | b | pad.......... || c(1) | c(2) | c(3) | c(4) | å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå¦‚æœä½ ä½¿ç”¨äº† #pragma pack (push, n) ä¹‹åå¿˜è®°å†™ #pragma pack (pop) çš„è¯ï¼ŒXcode 10 ä¼šæŠ›å‡º warningï¼š ä¸ªäººè§‚ç‚¹å˜›~ å½“åœ¨ç½‘ç»œå±‚é¢ä¼ è¾“ struct æ—¶ï¼Œé€šè¿‡ #pragma pack è‡ªå®šä¹‰å†…å­˜å¸ƒå±€çš„å¯¹é½æ–¹å¼å¯ä»¥ä¸ºç”¨æˆ·èŠ‚çº¦æ›´å¤šæµé‡ã€‚ Clang é™æ€åˆ†æXcode ä¸€ç›´éƒ½æä¾›é™æ€åˆ†æå™¨ï¼ˆStatic Analyzerï¼‰ï¼Œä½¿ç”¨ Clang Static Analyzer å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ‰¾å‡ºè¾¹ç•Œæƒ…å†µä»¥åŠéš¾ä»¥å‘è§‰çš„ Bugã€‚ ç‚¹å‡» Product -&gt; Analyze æˆ–è€…ä½¿ç”¨å¿«æ·é”® Shift+Command+B å°±å¯ä»¥é™æ€åˆ†æå½“å‰æ„å»ºçš„é¡¹ç›®äº†ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åœ¨é¡¹ç›®çš„ Build Settings ä¸­è®¾ç½®æ„å»ºé¡¹ç›®æ—¶è‡ªåŠ¨æ‰§è¡Œé™æ€åˆ†æï¼ˆä¸ªäººä¸æ¨èï¼‰ï¼š æœ¬åœ°é™æ€åˆ†æå™¨æœ‰ä»¥ä¸‹æå‡ï¼š GCD æ€§èƒ½åæ¨¡å¼ è‡ªåŠ¨é‡Šæ”¾å˜é‡è¶…å‡ºè‡ªåŠ¨é‡Šæ”¾æ±  æ€§èƒ½å’Œå¯è§†åŒ–æŠ¥å‘Šçš„æå‡ GCD æ€§èƒ½åæ¨¡å¼åœ¨ä¹‹å‰æŸäº›è¿«ä¸å¾—å·²çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ä½¿ç”¨ GCD ä¿¡å·ï¼ˆdispatch_semaphore_tï¼‰æ¥é˜»å¡æŸäº›å¼‚æ­¥æ“ä½œï¼Œå¹¶å°†é˜»å¡åå¾—åˆ°çš„æœ€ç»ˆçš„ç»“æœåŒæ­¥è¿”å›ï¼š 12345678__block NSString *taskName = nil;dispatch_semaphore_t sema = dispatch_semaphore_create(0);[self.connection.remoteObjectProxy requestCurrentTaskName:^(NSString *task) &#123; taskName = task; dispatch_semaphore_signal(sema);&#125;];dispatch_semaphore_wait(sema, DISPATCH_TIME_FOREVER);return taskName; å˜›~ è¿™æ ·å†™æœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ ä¸Šè¿°ä»£ç å­˜åœ¨é€šè¿‡ä½¿ç”¨å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ¥é˜»å¡å½“å‰çº¿ç¨‹ï¼Œè€Œ Task é˜Ÿåˆ—é€šå¸¸ä¼˜å…ˆçº§è¾ƒä½ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´ä¼˜å…ˆçº§åè½¬ã€‚ é‚£ä¹ˆ Xcode 10 ä¹‹åæˆ‘ä»¬åº”è¯¥æ€ä¹ˆå†™å‘¢ï¼Ÿ 1234567__block NSString *taskName = nil;id remoteObjectProxy = [self.connection synchronousRemoteObjectProxyWithErrorHandler: ^(NSError *error) &#123; NSLog(@&quot;Error: %@&quot;, error); &#125;];[remoteObjectProxy requestCurrentTaskName:^(NSString *task) &#123; taskName = task; &#125;];return taskName; å¦‚æœå¯èƒ½çš„è¯ï¼Œå°½é‡ä½¿ç”¨ synchronous ç‰ˆæœ¬çš„ APIã€‚æˆ–è€…ï¼Œä½¿ç”¨ asynchronous æ–¹å¼çš„ APIï¼š 123[self.connection.remoteObjectProxy requestCurrentTaskName:^(NSString *task) &#123; completionHandler(task);&#125;]; å¯ä»¥åœ¨ build settings ä¸‹å¯ç”¨ GCD æ€§èƒ½åæ¨¡å¼çš„é™æ€åˆ†ææ£€æŸ¥ï¼š è‡ªåŠ¨é‡Šæ”¾å˜é‡è¶…å‡ºè‡ªåŠ¨é‡Šæ”¾æ± ä¼—æ‰€å‘¨çŸ¥ï¼Œä½¿ç”¨ __autoreleasing ä¿®é¥°ç¬¦ä¿®é¥°çš„å˜é‡ä¼šåœ¨è‡ªåŠ¨é‡Šæ”¾æ± ç¦»å¼€æ—¶è¢«é‡Šæ”¾ï¼ˆreleaseï¼‰ï¼š 123@autoreleasepool &#123; __autoreleasing NSError *err = [NSError errorWithDomain:@&quot;domain&quot; code:1 userInfo:nil];&#125; è¿™ç§çœ‹ä¼¼ä¸éœ€è¦æˆ‘ä»¬æ³¨æ„çš„ç‚¹å¾€å¾€å°±æ˜¯å¼•èµ·ç¨‹åº Crash çš„éšæ‚£ï¼š 12345678910 - (void)findProblems:(NSArray *)arr error:(NSError **)error &#123; [arr enumerateObjectsUsingBlock:^(id value, NSUInteger idx, BOOL *stop) &#123; if ([value isEqualToString:@&quot;problem&quot;]) &#123; if (error) &#123; *error = [NSError errorWithDomain:@&quot;domain&quot; code:1 userInfo:nil]; &#125; &#125; &#125;];&#125; å˜›~ ä¸Šè¿°ä»£ç æ˜¯ä¼šå¼•èµ· Crash çš„ï¼Œä½ å¯ä»¥æŒ‡å‡ºä¸ºä»€ä¹ˆå—ï¼Ÿ Objective-C åœ¨ ARCï¼ˆAutomatic Reference Countingï¼‰ä¸‹ä¼šéšå¼ä½¿ç”¨ __autoreleasing ä¿®é¥° errorï¼Œå³ NSError *__autoreleasing*ã€‚è€Œ -enumerateObjectsUsingBlock: å†…éƒ¨ä¼šåœ¨è¿­ä»£ block æ—¶ä½¿ç”¨ @autoreleasepoolï¼Œåœ¨è¿­ä»£é€»è¾‘ä¸­è¿™æ ·åšæœ‰åŠ©äºå‡å°‘å†…å­˜å³°å€¼ã€‚ äºæ˜¯ *error åœ¨ -enumerateObjectsUsingBlock: ä¸­è¢«æå‰ release æ‰äº†ï¼Œè¿™æ ·åœ¨éšåè¯»å– *error æ—¶ä¼šå‡ºç° crashã€‚ Xcode 10 ä¸­ä¼šç»™å‡ºå…·æœ‰é’ˆå¯¹æ€§çš„é™æ€åˆ†æè­¦å‘Šï¼š æ­£ç¡®çš„ä¹¦å†™æ–¹å¼åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š 1234567891011- (void)findProblems:(NSArray *)arr error:(NSError *__autoreleasing*)error &#123; __block NSError *localError; [arr enumerateObjectsUsingBlock:^(id value, NSUInteger idx, BOOL *stop) &#123; if ([value isEqualToString:@&quot;problem&quot;]) &#123; localError = [NSError errorWithDomain:@&quot;domain&quot; code:1 userInfo:nil]; &#125; &#125;]; if (error) &#123; *error = localError; &#125; &#125; Note: å…¶å®æ—©åœ¨å»å¹´çš„ WWDC17 Session 411 Whatâ€™s New in LLVM ä¸­ Xcode 9 å°±å¼•å…¥äº†ä¸€ä¸ªéœ€è¦æ˜¾ç¤ºä¹¦å†™ __autoreleasing çš„è­¦å‘Šã€‚ æ€§èƒ½å’Œå¯è§†åŒ–æŠ¥å‘Šçš„æå‡Xcode 10 ä¸­é™æ€åˆ†æå™¨å¯ä»¥ä»¥æ›´é«˜æ•ˆçš„æ–¹å¼å·¥ä½œï¼Œåœ¨ç›¸åŒçš„åˆ†ææ—¶é—´å†…å¹³å‡å¯ä»¥å‘ç°æ¯”ä¹‹å‰å¢åŠ  15% çš„ Bug æ•°é‡ã€‚ ä¸ä»…ä»…æ˜¯æ€§èƒ½çš„æå‡ï¼ŒXcode 10 åœ¨æŠ¥å‘Šçš„å¯è§†åŒ–æ–¹é¢ä¹Ÿæœ‰æ‰€è¿›æ­¥ã€‚åœ¨ Xcode 9 çš„é™æ€åˆ†æå™¨æŠ¥å‘Šé¡µé¢æœ‰ç€éå¿…è¦ä¸”å†—é•¿çš„ Error Pathï¼š Xcode 10 ä¸­åˆ™å¯¹å…¶è¿›è¡Œäº†ä¼˜åŒ–ï¼š ä¸ªäººè§‚ç‚¹å˜›~ å¯¹äº Xcode çš„é™æ€åˆ†æï¼Œä¸ªäººè®¤ä¸ºè¿˜æ˜¯èŠèƒœäºæ— çš„ã€‚ä¸è¿‡ä¸å»ºè®®æ¯æ¬¡æ„å»ºé¡¹ç›®æ—¶éƒ½å»åšé™æ€åˆ†æï¼Œè¿™æ ·å¤§å¤§å¢åŠ äº†æ„å»ºé¡¹ç›®çš„æˆæœ¬ã€‚ ä¸ªäººå»ºè®®åœ¨å¼€å‘æµç¨‹ä¸­è‡ªæµ‹å®Œæ¯•æäº¤ä»£ç ç»™ç»„å†…å°ä¼™ä¼´ä»¬ Code Review ä¹‹å‰åšé™æ€åˆ†æï¼Œå¯ä»¥é¿å…ä¸€äº› issue çš„å‡ºç°ï¼Œä¹Ÿå¯ä»¥å‘ç°ä¸€äº›ä»£ç éšæ‚£ã€‚æœ‰äº›é—®é¢˜æ˜¯å¯ä»¥ä½¿ç”¨é™æ€åˆ†æå™¨åœ¨æäº¤ä»£ç ä¹‹å‰å°±æš´éœ²å‡ºæ¥çš„ï¼Œæ²¡å¿…è¦æ¶ˆè€—ç»„å†… Code Review çš„å®è´µäººåŠ›èµ„æºã€‚ è¿˜å¯ä»¥åœ¨ CI è®¾ç½®æ¯éš”å›ºå®šæ˜¯æ—¶é—´é—´éš”å»è·‘ä¸€æ¬¡é™æ€åˆ†æï¼Œç”ŸæˆæŠ¥è¡¨å‘åˆ°ç»„å†…å°ç¾¤ï¼Œæ ¹æ®é—®é¢˜æŒ‡æ´¾è´£ä»»äººå»æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿®å¤ï¼ˆé™æ€åˆ†æåœ¨æ¯”è¾ƒå¤æ‚çš„ä»£ç ç»“æ„ä¸‹å¹¶ä¸ä¸€å®šå‡†ç¡®ï¼‰ï¼Œè¿™æ ·å®šæœŸç»´æŠ¤ä»æŸç§è§’åº¦è®²å¯ä»¥ä¿æŒé¡¹ç›®ä»£ç çš„å¥åº·çŠ¶å†µã€‚ å¢åŠ å®‰å…¨æ€§Stack ProtectorApple å·¥ç¨‹å¸ˆåœ¨ä»‹ç» Stack Protector ä¹‹å‰å¾ˆè´´å¿ƒçš„å¸¦é¢†ç€åœ¨åœºçš„å¼€å‘è€…ä»¬å¤ä¹ äº†ä¸€éæ ˆ Stack ç›¸å…³çš„åŸºç¡€çŸ¥è¯†ï¼š å¦‚ä¸Šå›¾ï¼Œå…¶å®å°±æ˜¯ç®€å•çš„è®²äº†ä¸€ä¸‹ Stack çš„å·¥ä½œæ–¹å¼ï¼Œå¦‚æ ˆå¸§ç»“æ„ä»¥åŠå‡½æ•°è°ƒç”¨æ—¶æ ˆçš„å±•å¼€ç­‰ã€‚æ¯ä¸€çº§çš„æ–¹æ³•è°ƒç”¨ï¼Œéƒ½å¯¹åº”äº†ä¸€å¼ ç›¸å…³çš„æ´»åŠ¨è®°å½•ï¼Œä¹Ÿè¢«ç§°ä¸ºæ´»åŠ¨å¸§ã€‚å‡½æ•°çš„è°ƒç”¨æ ˆæ˜¯ç”±ä¸€å¼ å¼ å¸§ç»“æ„ç»„æˆçš„ï¼Œæ‰€ä»¥ä¹Ÿç§°ä¹‹ä¸ºæ ˆå¸§ã€‚ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ ˆå¸§ä¸­åŒ…å«ç€ Return Addressï¼Œä¹Ÿå°±æ˜¯å½“å‰æ´»åŠ¨è®°å½•æ‰§è¡Œç»“æŸåè¦è¿”å›çš„åœ°å€ã€‚ é‚£ä¹ˆä¼šæœ‰ä»€ä¹ˆå®‰å…¨æ€§é—®é¢˜å‘¢ï¼ŸApple å·¥ç¨‹å¸ˆæ¥ç€ä»‹ç»äº†é€šè¿‡ä¸æ­£å½“æ‰‹æ®µä¿®æ”¹æ ˆå¸§ Return Address ä»è€Œå®ç°çš„ä¸€äº›æƒé™æå‡ã€‚å˜›~ ä¹Ÿå°±æ˜¯å†å²æ‚ ä¹…çš„ ç¼“å†²åŒºæº¢å‡ºæ”»å‡»ã€‚ å½“ä½¿ç”¨ C è¯­è¨€ä¸­ä¸€äº›ä¸å¤ªå®‰å…¨çš„å‡½æ•°æ—¶ï¼ˆæ¯”å¦‚ä¸Šå›¾çš„ strcpy()ï¼‰ï¼Œå°±æœ‰å¯èƒ½é€ æˆç¼“å†²åŒºæº¢å‡ºã€‚ Note: strcpy() å‡½æ•°å°†æºå­—ç¬¦ä¸²å¤åˆ¶åˆ°æŒ‡å®šç¼“å†²åŒºä¸­ã€‚ä½†æ˜¯ä¸«æ²¡æœ‰æŒ‡å®šè¦å¤åˆ¶å­—ç¬¦çš„å…·ä½“æ•°ç›®ï¼å¦‚æœæºå­—ç¬¦ä¸²ç¢°å·§æ¥è‡ªç”¨æˆ·è¾“å…¥ï¼Œä¸”æ²¡æœ‰ä¸“é—¨é™åˆ¶å…¶å¤§å°ï¼Œåˆ™æœ‰å¯èƒ½ä¼šé€ æˆç¼“å†²åŒºæº¢å‡ºï¼ é’ˆå¯¹ç¼“å†²åŒºæº¢å‡ºæ”»å‡»ï¼ŒLLVM å¼•å…¥äº†ä¸€å—é¢å¤–çš„åŒºåŸŸï¼ˆä¸‹å›¾ç»¿è‰²åŒºåŸŸï¼‰æ¥ä½œä¸ºæ ˆå¸§ Return Address çš„æŠ¤åŸæ²³ï¼Œå«åš Stack Canaryï¼Œå·²é»˜è®¤å¯ç”¨ï¼š Note: Canary è¯‘ä¸º â€œé‡‘ä¸é›€â€ï¼ŒStack Canary çš„å‘½åæºäºæ—©æœŸç…¤çŸ¿å·¥äººä¸‹çŸ¿å‘æ—¶ä¼šæºå¸¦é‡‘ä¸é›€æ¥æ£€æµ‹çŸ¿å‘å†…ä¸€æ°§åŒ–ç¢³æ˜¯å¦è¾¾åˆ°å±é™©å€¼ï¼Œä»è€Œåˆ¤æ–­æ˜¯å¦éœ€è¦é€ƒç”Ÿã€‚ æ ¹æ®æˆ‘ä»¬ä¸Šé¢å¯¹ç¼“å†²åŒºæº¢å‡ºæ”»å‡»çš„åŸç†åˆ†æï¼Œå¤§å®¶åº”è¯¥å¾ˆå®¹æ˜“å‘ç° Stack Canary çš„é˜²å¾¡åŸç†ï¼Œå³ç¼“å†²åŒºæº¢å‡ºæ”»å‡»æ—¨åœ¨åˆ©ç”¨ç¼“å†²åŒºæº¢å‡ºæ¥ç¯¡æ”¹æ ˆå¸§çš„ Return Addressï¼ŒåŠ å…¥äº† Stack Canary ä¹‹åæƒ³è¦ç¯¡æ”¹ Return Address å°±å¿…ç„¶ä¼šç»è¿‡ Stack Canaryï¼Œåœ¨å½“å‰æ ˆå¸§æ‰§è¡Œç»“æŸåè¦ä½¿ç”¨ Return Address å›æº¯æ—¶å…ˆæ£€æµ‹ Stack Canary æ˜¯å¦æœ‰å˜åŠ¨ï¼Œå¦‚æœæœ‰å°±è°ƒç”¨ abort() å¼ºåˆ¶é€€å‡ºã€‚ å˜›~ æ˜¯ä¸æ˜¯å’ŒçŸ¿å‘ä¸­çš„é‡‘ä¸é›€å¾ˆåƒå‘¢ï¼Ÿ ä¸è¿‡ Stack Canary å­˜åœ¨ä¸€äº›å±€é™æ€§ï¼š å¯ä»¥åœ¨ç¼“å†²åŒºæº¢å‡ºæ”»å‡»æ—¶è®¡ç®— Canary çš„åŒºåŸŸå¹¶ä¼ªè£… Canary åŒºåŸŸçš„å€¼ï¼Œä½¿å¾— Return Address è¢«ç¯¡æ”¹çš„åŒæ—¶ Canary åŒºåŸŸå†…å®¹æ— å˜åŒ–ï¼Œç»•è¿‡æ£€æµ‹ã€‚ å†ç²—æš´ä¸€ç‚¹çš„è¯ï¼Œå¯ä»¥é€šè¿‡åŒé‡ strcpy() è¦†å†™ä»»æ„ä¸å—å†…å­˜ä¿æŠ¤çš„æ•°æ®ï¼Œé€šè¿‡æ„å»ºåˆé€‚çš„æº¢å‡ºå­—ç¬¦ä¸²ï¼Œå¯ä»¥è¾¾åˆ°ä¿®æ”¹ ELFï¼ˆExecutable and Linking Formatï¼‰æ˜ å°„çš„ GOTï¼ˆGlobal Offset Tableï¼‰ï¼Œåªè¦ä¿®æ”¹äº† GOT ä¸­çš„ _exit() å…¥å£ï¼Œå³ä¾¿ Canary æ£€æµ‹åˆ°äº†ç¯¡æ”¹ï¼Œå‡½æ•°è¿”å›å‰è°ƒç”¨ abort() é€€å‡ºè¿˜æ˜¯ä¼šèµ°å·²ç»è¢«ç¯¡æ”¹äº†çš„ _exit()ã€‚ Stack CheckingStack Protector æ˜¯ Xcode æ—¢æœ‰çš„ã€ä¸”é»˜è®¤å¼€å¯çš„ç‰¹æ€§ï¼Œè€Œ Stack Checking æ˜¯ Xcode 10 å¼•å…¥çš„æ–°ç‰¹æ€§ï¼Œä¸»è¦é’ˆå¯¹çš„æ˜¯ Stack Clash é—®é¢˜ã€‚ Stack Clash é—®é¢˜çš„äº§ç”Ÿæºäº Stack å’Œ Heapï¼ŒStack æ˜¯ä»ä¸Šå‘ä¸‹å¢é•¿çš„ï¼ŒHeap åˆ™æ˜¯è‡ªä¸‹è€Œä¸Šå¢é•¿çš„ï¼Œä¸¤è€…ç›¸å‘æ‰©å±•è€Œå†…å­˜åˆæ˜¯æœ‰é™çš„ã€‚ Stack Checking çš„å·¥ä½œåŸç†æ˜¯åœ¨ Stack åŒºåŸŸè§„å®šåˆç†çš„åˆ†ç•Œçº¿ï¼ˆä¸Šå›¾çº¢çº¿ï¼‰ï¼Œåœ¨å¯å˜é•¿åº¦ç¼“å†²åŒºçš„å‡½æ•°å†…éƒ¨å¯¹å°†è¦åˆ†é…çš„ç¼“å†²åŒºå¤§å°åšæ ¡éªŒï¼Œå¦‚æœç¼“å†²åŒºè¶…å‡ºåˆ†ç•Œçº¿åˆ™è°ƒç”¨ abort() å¼ºåˆ¶é€€å‡ºã€‚ Note: LLVM å›¢é˜Ÿåœ¨æœ¬æ¬¡ WWDC18 åŠ å…¥ Stack Checkingï¼Œå¤§æ¦‚ç‡æ˜¯å› ä¸ºå»å¹´å¹´ä¸­ Qualys å…¬å¸ƒçš„ä¸€ä»½ å…³äº Stack Clash çš„æŠ¥å‘Šã€‚ æ–°æŒ‡ä»¤é›†æ‰©å±• Emmmmmâ€¦ è¿™ä¸€èŠ‚çš„å†…å®¹æ˜¯é’ˆå¯¹äº iMac Pro ä»¥åŠ iPhone X ä½¿ç”¨çš„ æŒ‡ä»¤é›†æ¶æ„ï¼ˆISA - Instruction set architectureï¼‰ æ‰€åšçš„æ‰©å±•ã€‚å¦ç™½è¯´ï¼Œæˆ‘å¯¹è¿™å—å¹¶ä¸æ˜¯å¾ˆæ„Ÿå…´è¶£ï¼Œä¹Ÿæ²¡æœ‰æ·±å…¥çš„ç ”ç©¶ï¼Œæ‰€ä»¥å°±ä¸çŒ®ä¸‘äº†â€¦ æ€»ç»“æœ¬æ–‡æ¢³ç†äº† WWDC18 Session 409 Whatâ€™s New in LLVM ä¸­çš„å†…å®¹ï¼Œå¹¶åˆ†äº«äº†æˆ‘ä¸ªäººå¯¹è¿™äº›å†…å®¹çš„æ‹™è§ï¼Œå¸Œæœ›èƒ½å¤Ÿå¯¹å„ä½å› ä¸ºç§ç§åŸå› è¿˜æ²¡æœ‰æ¥å¾—åŠçœ‹ WWDC18 Session 409 çš„åŒå­¦æœ‰æ‰€å¸®åŠ©ã€‚ æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜ https://lision.me/ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ä¸ªäººåšå®¢ä¸­æ›´æ–°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš @Lision è”ç³»æˆ‘~ å¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~"},{"title":"Sony WH-H900N å¼€ç®±ç•™å¿µ","comments":true,"permalink":"https://lision.me/sony_wh_h900n/","text":"å‰è¨€å˜›~ åˆæ˜¯ä¸€å¹´é«˜è€ƒå­£ï¼Œæ¯åˆ°è¿™ä¸ªæ—¶å€™æˆ‘å°±çŸ¥é“æˆ‘åˆé•¿äº†ä¸€å²â€¦ Emmmmmâ€¦ æœ€è¿‘ä¼¼ä¹é™·å…¥äº†åˆ›ä½œä½è°·ï¼Œå·²ç»å¾ˆä¹…æ²¡æœ‰æ›´æ–°è¿‡åšå®¢äº†ï¼ŒåŸå› å˜›â€¦ æœ‰å¾ˆå¤šï¼š ä¸€æ–¹é¢æ˜¯å…¥èŒä¹‹åéœ€è¦é€‚åº”æ–°çš„ç¯å¢ƒï¼ŒåŒ…æ‹¬æ–°çš„å›¢é˜Ÿï¼Œæ–°çš„æµç¨‹â€¦ ä»è¿™ä¸€ç‚¹æ¥çœ‹äººç±»æœç„¶æ˜¯å¼±é¸¡åŠ¨ç‰©ï¼Œä¼šå—åˆ°å¤–ç•Œç¯å¢ƒçš„å˜åŒ–ä»¥åŠå¿ƒæƒ…ç­‰å†…åœ¨å› ç´ çš„å½±å“ï¼Œè‡³å°‘æœºå™¨äººä¸ä¼šè¢«è¿™äº›ä¸œè¥¿å›°æ‰°å§â€¦ å¦ä¸€æ–¹é¢æ˜¯ä¸çŸ¥é“åº”è¯¥å†™ä»€ä¹ˆï¼Œæˆ–è€…è¯´è‡ªå·±åœ¨è¿™æ®µä¸æ–°å›¢é˜Ÿçš„ç£¨åˆæœŸä¸­çœ¼ç•Œæå‡äº†å¾ˆå¤šï¼Œå¾ˆå¤šä¹‹å‰è®¡åˆ’å»å†™çš„æ–‡ç« ç°åœ¨çªç„¶æ²¡æœ‰å…´è¶£äº†ï¼Œä»¥å‰ä¹Ÿæœ‰è¿‡ç±»ä¼¼çš„ç»å†â€¦ å”¯æœ‰å‘Šè¯«è‡ªå·±æˆ’æ‰æ‹–å»¶ç—‡ï¼Œä¸è¦é”™è¿‡å½“å‰è¿™æ®µæ—¶æœŸè‡ªå·±æƒ³åšçš„äº‹æƒ…å“ˆ~ å¦å¤–ä¸€ä¸ªæœ€é‡è¦åŸå› å°±æ˜¯â€”â€”çœŸçš„æ²¡æ—¶é—´ã€‚ è‡ªå·±ä¹Ÿæƒ³è¿‡ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Œé™¤å»ç£¨åˆæœŸç§ç§ä¸ç†Ÿæ‚‰å¯¼è‡´çš„æ—¶æ•ˆé—®é¢˜ï¼Œè¿˜å‰©ä¸‹ä¸€äº›å®¢è§‚å­˜åœ¨çš„å› ç´ ï¼Œå…¶ä¸­å°±æœ‰åŠå…¬ç¯å¢ƒçš„å½±å“ï¼Œç°åœ¨çš„åŠå…¬ç¯å¢ƒæ¯”è¾ƒå¼€æ”¾ï¼ˆè£…ä¿®é£æ ¼å’Œç½‘å§ç±»ä¼¼ &gt;_&lt;ï¼‰ï¼Œæ‰€ä»¥æ¯å¤©éƒ½ä¼šæœ‰ QA å°å§å§ä»¬æµ‹è¯•è®¢å•çš„å£°éŸ³ï¼ŒPM å°å“¥å“¥ä»¬æ’•é€¼çš„å£°éŸ³ï¼ŒRD å°ä¼™ä¼´ä»¬æ•²å‡»é”®ç›˜çš„å£°éŸ³â€¦ è¿™å‡ ç§å£°éŸ³åœ¨ä¸åŒçš„éŸ³é¢‘æ”»å‡»ç€æˆ‘å¹¼å°çš„å¿ƒè„å’Œè„†å¼±çš„ç¥ç»ï¼Œå½±å“ç€æˆ‘æ•²ä»£ç æ—¶çš„ä¸“æ³¨ç¨‹åº¦â€¦ ç„¶åå¯èƒ½ä¹‹å‰ä¸‹ç­å›åˆ°å®¶åæœ‰å’Œæˆ‘å¥³ç¥¨æŠ±æ€¨è¿‡å§â€¦ ç»“æœè¿‡ç”Ÿæ—¥å°±æ”¶åˆ°äº†è¿™ç¯‡æ–‡ç« çš„ä¸»è§’â€”â€” Sony WH-H900Nã€‚ ç´¢å¼• Sony WH-H900N å…¥æ‰‹æ¸ é“ å¼€ç®±ç…§ ä¸Šå¤´ä½“éªŒ æ€»ç»“ Sony WH-H900N Sony WH-H900N å…¨ç§° Sony | h.ear on 2 Wireless NC | WH-H900Nï¼Œæ˜¯å¤§æ³•æ——ä¸‹çš„ h.ear on 2 ç³»åˆ—æ— çº¿è“ç‰™é™å™ªè€³æœºã€‚ å…³é”®è¯ï¼š ä½©æˆ´è‰¯å¥½ éš”éŸ³è‰¯å¥½ å¬è¯Šå™¨æ•ˆåº”è½»å¾® åšå·¥ä¼˜ç§€ é™å™ªè‰¯å¥½ æ‚é£Ÿ ç”±äºæˆ‘è‡ªå·±å¹³æ—¶ä»€ä¹ˆéŸ³ä¹éƒ½å¬ä¸€äº›ï¼Œå ACG å’Œ Eason Chen å¤šä¸€äº›ï¼ŒåŠ ä¸Šæˆ‘è‡ªå·±æœ¬èº«æ˜¯æœ¨è€³ï¼ˆæœ¨å¤´è€³æœµï¼ŒæŒ‡å¬ä¸å‡ºä¸åŒè€³æœºçš„éŸ³è´¨åŒºåˆ«ï¼‰æ‰€ä»¥ä¸€ç›´ä»¥æ¥å¯¹è€³æœºå°±åªæœ‰æ— çº¿å’Œé™å™ªä¸¤ä¸ªç¡¬æ€§éœ€æ±‚ï¼Œç„¶åè‡ªå·±æ²¡æœ‰å‡ºè¡—å¬éŸ³ä¹çš„ä¹ æƒ¯ï¼ˆä¸»è¦æ˜¯è§‰å¾—è½¦æ¥è½¦å¾€ä¸å¤ªå®‰å…¨ï¼‰ï¼Œæ‰€ä»¥æƒ³è¦ä¸€æ¬¾å¤´æˆ´å¼çš„è€³æœºï¼ˆåœ¨åŠå…¬å®¤å’Œå®¶é‡Œå¬å¬å°±å¥½ï¼‰ï¼Œç„¶åå› ä¸ºå¤´æˆ´å¼çš„è€³æœºæ¯”è¾ƒæ˜¾çœ¼ï¼Œæ‰€ä»¥å¯¹é¢œå€¼ä¹Ÿæœ‰äº†ä¸€å®šçš„è¦æ±‚â€¦ åˆšåˆšå¥½ï¼Œè¿™äº›éœ€æ±‚ Sony WH-H900N ç»Ÿç»Ÿæ»¡è¶³äº†ï¼Œå†æ¬¡æ„Ÿæ©æˆ‘çš„å¥³ç¥¨ï¼Œæƒ³å¿…èŠ±äº†ä¸å°‘å¿ƒæ€å§ï¼ˆç¬‘ï¼‰ é…è‰²æ–¹é¢ï¼Œè¿™æ¬¾è€³æœºæä¾›äº†äº”ç§é…è‰²å¯ä¾›é€‰æ‹©ï¼š æš®å…‰çº¢ï¼ˆç›®å…‰çº¢ï¼Œå› ä¸ºè¿™ä¸ªé¢œè‰²çœŸçš„ç‰¹åˆ«å°‘å¥³ï¼Œæ®è¯´å‡ºè¡—å›å¤´ç‡è¶…é«˜ï¼‰ æœˆå…‰è“ è–„è·ç»¿ æµ…é‡‘ ç°é»‘ è¿™å‡ ç§é¢œè‰²éƒ½æ˜¯åå“‘å…‰è´¨æ„Ÿçš„ï¼Œä½è°ƒçš„åŒæ—¶æ»¡è¶³äº†ç»å¤§å¤šæ•°æ¶ˆè´¹è€…çš„ä¸ªæ€§åŒ–é€‰æ‹©ï¼Œæˆ‘è¿™æ¬¾å°±æ˜¯æœˆå…‰è“é…è‰²çš„~ Note: é‰´äºç½‘ä¸Šå„ç§è¯„æµ‹è´´å’Œä¹°å®¶ç§€çš„æ™’å›¾ä¸­å‡ºç°äº†å„ç§é¢œè‰²çš„æœˆå…‰è“ï¼Œæ‰€ä»¥æˆ‘è¿™ç¯‡æ–‡ç« çš„æ‰€æœ‰é…å›¾å‡æ— ä»»ä½•æ»¤é•œå’ŒåæœŸå¤„ç†ï¼Œå¸Œæœ›èƒ½å¤Ÿç»™æƒ³ä¹°æœˆå…‰è“çš„åŒå­¦æä¾›ä¸€äº›å‚è€ƒå’Œå¸®åŠ©ã€‚ è¡¥å……ï¼Œè¯è¯´æˆ‘è¿˜åœ¨å¤§æ³•çš„å®˜æ–¹å•†åŸæœåˆ°äº† WH-H900N FATE ç‰¹åˆ«ç‰ˆå“Ÿ~ å¼€ç®±ç…§ ç®±å†…ç‰©å“å¦‚ä¸‹ï¼š Sony WH-H900N è€³æœºæœ¬ä½“ è€³æœºçº¿æï¼ˆæ‰‹æ„Ÿä¸€èˆ¬ï¼Œéšè€³æœºæœ¬ä½“é¢œè‰²ï¼‰ å……ç”µçº¿ï¼ˆé»‘è‰²ï¼‰ æ”¶çº³è¢‹ï¼ˆæ‰‹æ„Ÿä¸é”™çš„é€æ°”å¸†å¸ƒæè´¨æ”¶çº³è¢‹ï¼Œå†…è¡¬æŸ”è½¯ææ–™ï¼Œéšè€³æœºæœ¬ä½“é¢œè‰²ï¼‰ æ”¶çº³ç›’ï¼ˆéšè€³æœºæœ¬ä½“é¢œè‰²ï¼‰ éœ€è¦æ³¨æ„çš„æ˜¯åªæœ‰å……ç”µçº¿æ˜¯é»‘è‰²çš„ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€å¦‚æœä½ é€‰æ‹©çš„æ˜¯æš®å…‰çº¢è¿™ç§åæµ…è‰²ç³»çš„é…è‰²ï¼Œå……ç”µçš„æ—¶å€™ä¼šâ€¦éï¼å¸¸ï¼ä¸‘ï¼å¥½åœ¨è¿™æ¬¾è€³æœºæœ‰å¤§æ³•çš„å¿«å……é»‘ç§‘æŠ€åŠ æŒï¼ˆå…¶å®ä¸å¦‚ Apple çš„å¿«å……é»‘ç§‘æŠ€ï¼‰ï¼Œåœ¨ä½ç”µé‡æ—¶å……ç”µ 10 åˆ†é’Ÿå¯ä»¥å¬ 1 å°æ—¶å·¦å³ï¼ˆè¯´æ˜ä¹¦æœ‰å†™ &amp; äº²æµ‹ï¼‰ï¼Œå¦å¤–è€³æœºå……æ»¡ç”µçš„ç»­èˆªæ—¶é—´ä¸º 28 å°æ—¶ï¼ˆå¼€å¯é™å™ªï¼‰ï¼Œå®Œå…¨å¯ä»¥åœ¨å®¶å……å¥½ç”µå†å¸¦å»å…¬å¸ä½¿ç”¨ã€‚ ä¸Šå¤´ä½“éªŒ Emmmmmâ€¦ è‡ªè®¤æœ¨è€³ï¼Œåˆæ˜¯ç†å·¥ç”·çš„æ¸£æ¸£æ–‡ç¬”ï¼Œå°±ç®€å•å™è¿°ä¸€ä¸‹è‡ªå·±çš„ä¸»è§‚å¬æ„Ÿå§~ éŸ³è´¨éŸ³è´¨æ–¹é¢ä¸ªäººè®¤ä¸ºè¿˜ä¸é”™ï¼Œè¿™æ¬¾è€³æœºåä¸­ä½éŸ³ï¼Œæ°å¥½ Eason Chen çš„æ­Œæ™®ééƒ½æ˜¯ä¸­ä½éŸ³ç”·å£°ï¼Œæ‰€ä»¥è¡¨ç°å¾ˆä¸é”™ï¼Œäººå£°æ¸…æ™°ï¼Œä¸ä¼šæ„Ÿè§‰è·ç¦»è€³æœµå¾ˆè¿œï¼Œåˆä¸ä¼šæ„Ÿè§‰é çš„å¤ªè¿‘ï¼Œå¯ä»¥è¯´æ˜¯æ°åˆ°å¥½å¤„å§~ å¦å¤– ACG å¥³å£°çš„è¡¨ç°ä¹Ÿå¾ˆä¸é”™ï¼Œäººå£°ç”œç¾ï¼Œè·ç¦»é€‚ä¸­ï¼Œå£°éŸ³æœ‰åšåº¦ã€‚æœ‰çš„è€³æœºäººå£°è¡¨ç°å°±å¾ˆå•è–„ï¼Œè¯¥æ€ä¹ˆå½¢å®¹å‘¢ï¼Ÿå°±æ˜¯æ„Ÿè§‰äººå£°æ˜¯è€³æœºä»èƒŒæ™¯éŸ³ä¹ä¸­æ‘˜å‡ºæ¥çªå…€çš„æ”¾åˆ°è€³è¾¹çš„ï¼Œæ¸…æ¥šä½†æ˜¯ä¸èƒŒæ™¯éŸ³æ ¼æ ¼ä¸å…¥ï¼Œåƒçº¸ç‰‡ä¸€æ ·çªå…€ä¸”å•è–„ï¼Œä¸€å¸¦è€Œè¿‡çš„å‘å£°â€¦ é™å™ªé¦–å…ˆï¼Œè€³æœºçš„è€³å«åšå·¥å¾ˆä¸é”™ï¼Œè¶³å¤ŸæŸ”è½¯èˆ’é€‚ï¼Œæ‰£åœ¨è€³æœµä¸Šå·²ç»å¯ä»¥é™ä½ 10%~20% çš„ç¯å¢ƒå™ªéŸ³äº†ï¼Œç„¶åå¼€æœºå¹¶å¼€å¯é™å™ªæ¨¡å¼å¯ä»¥ç¬é—´æ„Ÿè§‰åˆ° &gt;= 80% çš„ç¯å¢ƒå™ªéŸ³éƒ½è¢«å±è”½äº†ï¼Œå‰©ä¸‹çš„ä¸€äº›å£°éŸ³åŸºæœ¬éƒ½æ˜¯é™„è¿‘çš„äººå£°ï¼Œä¸”å£°éŸ³å°äº†å¾ˆå¤šï¼ˆå¼€å§‹å¬éŸ³ä¹æ—¶å¤–é¢å‡å¼±è¿‡çš„äººå£°å°±åŸºæœ¬å¬ä¸åˆ°äº†ï¼‰~ ä½é¢‘çš„æ‚éŸ³ç±»ä¼¼ä¸­å¤®ç©ºè°ƒå‡ºé£å£çš„å£°éŸ³åˆ™å®Œå…¨è¢«å±è”½ï¼Œæˆ‘æ˜¯ä¸­åˆåˆä¼‘æ—¶æ‹†ç®±ç¬¬ä¸€æ¬¡è¯•æˆ´çš„ï¼Œå½“æ—¶æ­£å¥½æ²¡äººè¯´è¯ï¼Œæ„Ÿè§‰ç¬é—´æ²‰å…¥æµ·åº•ï¼Œæ•´ä¸ªä¸–ç•Œéƒ½å®‰é™äº†~ Note: Sony WH-H900N æ”¯æŒæ‰‹åŠ¿æ“æ§ï¼Œç”¨å³æ‰‹é®ç›–å³è€³æœºï¼Œåˆ™ä¼šé™ä½æ­£åœ¨æ’­æ”¾çš„éŸ³ä¹éŸ³é‡ï¼ŒåŒæ—¶æš‚æ—¶å…³é—­é™å™ªï¼Œè¿™æ ·éå¸¸äººæ€§åŒ–çš„ä¾¿æ·è®¾è®¡å¯ä»¥è®©ä½ å¾ˆæ–¹ä¾¿çš„ä¸åŒäº‹çŸ­æš‚æ²Ÿé€šã€‚ æ— çº¿å¤§æ³•é»‘ç§‘æŠ€å°†è“ç‰™ä¼ è¾“çš„é€Ÿç‡æå‡å¾ˆå¤šï¼Œåœ¨æ— çº¿çŠ¶æ€ä¸‹ä¾ç„¶å°½å¯èƒ½çš„äº‰å–éŸ³è´¨ä½“éªŒï¼Œä¸ªäººçš„æ„Ÿè§‰æ˜¯æ¯”æˆ‘ä¹‹å‰ Beats solo 2 çš„éŸ³è´¨è¿˜è¦ç¨å¥½ä¸€äº›~ åšå·¥è¿™æ¬¾è€³æœºçš„å¤´æ¢åšå·¥å¾ˆåšå®ï¼Œä¿è¯äº†é•¿æ—¶é—´ä½©æˆ´çš„èˆ’é€‚åº¦ï¼ˆä¸è¿‡è€³å«å¤„ç”±äºå¯†å°æ€§ç­‰åŸå› ä¼šæ¯”è¾ƒå®¹æ˜“å‡ºæ±—ï¼Œå¥½åœ¨å…¬å¸å’Œå®¶é‡Œéƒ½æœ‰ç©ºè°ƒï¼Œé—®é¢˜ä¸å¤§ï¼‰ï¼Œè¿™ä¸€ç‚¹å’Œæˆ‘ä¹‹å‰çš„ Beats solo 2 å½¢æˆå¼ºçƒˆå¯¹æ¯”ï¼ŒBeats solo 2 çš„å¤´æ¢å°±è–„è–„ä¸€å±‚ï¼Œæ‹†å¼€ä¹‹åå‘ç°é‡Œé¢åªæœ‰ä¸€å±‚è¶…è–„æµ·ç»µï¼ˆæ—¥äº†ç‹—äº†ï¼‰ã€‚ è€³æœºçš„è§¦æ„Ÿå’Œå®ƒåå“‘å…‰çš„é¢œè‰²ä¿æŒä¸€è‡´ï¼Œå½¢å®¹èµ·æ¥å¤§æ¦‚å°±æ˜¯ä»‹äºç£¨ç ‚å’Œå…‰é¢ä¹‹é—´çš„æ„Ÿè§‰ï¼Œè€³å«æŸ”è½¯èˆ’é€‚æœ‰å¼¹æ€§ï¼Œå¤§çˆ± Sony è¿™ç§ä¼˜ç§€æ‰å®çš„åšå·¥å“è´¨ï¼ æ€»ç»“å˜›~ æ€»å¾—æ¥è¯´å‘¢â€¦ Sony WH-H900N è¿™æ¬¾è€³æœºéå¸¸é€‚åˆå¯¹æ— çº¿ &amp; é™å™ªæœ‰ç¡¬æ€§éœ€æ±‚çš„åŒå­¦ï¼Œéš¾èƒ½å¯è´µçš„æ˜¯å…¶åœ¨æ— çº¿ &amp; é™å™ªçš„åŸºç¡€ä¸Šè¿˜ä¿è¯äº†é«˜é¢œå€¼ &amp; ä¸€å®šçš„éŸ³è´¨ï¼ˆåæ­£å¯¹äºæˆ‘è¿™ç§æœ¨è€³æ¥è®²è¶³å¤Ÿäº†ï¼‰ã€‚ è¡¥å……ï¼Œé™å™ªè€³æœºçœŸçš„æ˜¯æå‡å·¥æ•ˆçš„åˆ©å™¨ï¼Œä»æŸç§è§’åº¦çœ‹ç”šè‡³æ¯”é”®ç›˜æ¥çš„æ›´åŠ ç²—æš´æœ‰æ•ˆï¼ˆæ¯•ç«Ÿä¸éœ€è¦ç£¨åˆæœŸï¼‰ã€‚"},{"title":"Hackathon 5.0 å°è®°","comments":true,"permalink":"https://lision.me/hackathon5-0/","text":"å‰è¨€Emmmmmâ€¦ è¿˜è®°å¾—ä¸Šä¸€æ¬¡å‚åŠ  Hackathon æ˜¯åœ¨ 2017 å¹´ä¸Šæµ·ä¸¾åŠçš„ï¼Œå½“æ—¶è¿˜åœ¨ ELSEWHERE å·¥ä½œçš„æˆ‘å’Œå…¬å¸çš„å°ä¼™ä¼´ä»¬ä¸€èµ·ç»„å›¢ä»åŒ—äº¬åˆ°ä¸Šæµ·å‚èµ›ï¼Œä¹Ÿæ˜¯æˆ‘äººç”Ÿä¸­ç¬¬ä¸€æ¬¡å‚åŠ  Hackathonï¼Œæ‰€ä»¥åˆ°ç°åœ¨éƒ½è¿˜å°è±¡æ·±åˆ»å‘¢ï¼ è¿™ä¸€æ™ƒï¼ŒåŠ å…¥ç¾å›¢Â·ç‚¹è¯„ä¹Ÿå¿«æ»¡ä¸‰ä¸ªæœˆäº†ï¼Œæ—©å°±çŸ¥é“ç¾å›¢Â·ç‚¹è¯„æœ‰å…¬å¸å†…éƒ¨ä¸¾åŠ Hackathon çš„ä¼ ç»Ÿï¼Œä½†æ²¡æƒ³åˆ°è¿™ä¹ˆå¿«å°±å¯ä»¥å‚ä¸å…¶ä¸­äº†ï¼Œæƒ³æƒ³è¿˜æœ‰ç‚¹å°æ¿€åŠ¨ã€‚å…¶å®ä¹‹å‰å°±æœ‰çœ‹åˆ°è¿‡åŒäº‹ç©¿ç€å¾€å±Šå†…éƒ¨ Hackathon ä¸»é¢˜ T æ¤æ¥å…¬å¸ä¸Šç­ï¼Œè‡ªå·±ä¹Ÿè¶…æƒ³æœ‰ä¸€ä»¶ï¼æ‰€ä»¥åœ¨å…¬å¸å†…éƒ¨å‘å‡ºè¿™æ¬¡ Hackathon 5.0 çš„å®£ä¼ é¡µä»¥åŠæŠ¥åè¡¨æ—¶å°±æ¯«ä¸çŠ¹è±«çš„æ‹‰ç€ç»„é‡Œçš„ä¸¤ä½å¤§ä½¬ä¸€èµ·æŠ¥åäº†å“ˆã€‚ ç´¢å¼• Hackathon Hackathon 5.0 ä¸åŒäºå¾€å±Šçš„èµ›åˆ¶ å—¨ Kr æ£® Somewhere å»å¹´çš„ Hackathon å›å¿† æ€»ç»“ HackathonHackathon è¯‘ä¸ºâ€œé»‘å®¢é©¬æ‹‰æ¾â€ï¼Œæ—¨åœ¨ç”¨é™å®šçš„æ—¶é—´åšå‡ºå¯ç”¨çš„è½¯ä»¶åº”ç”¨ã€‚ Hackathon å¾€å¾€éƒ½æœ‰ä¸€ä¸ªç‰¹å®šçš„ç„¦ç‚¹ï¼Œå…¶ä¸­å¯èƒ½åŒ…æ‹¬ä½¿ç”¨çš„ç¼–ç¨‹è¯­è¨€ï¼Œæ“ä½œç³»ç»Ÿï¼Œåº”ç”¨ç¨‹åºï¼ŒAPI ç­‰ç­‰ã€‚ ä¸ä»…ä»…æ˜¯ç¨‹åºçŒ¿ï¼ŒHackathon çš„å‚èµ›äººå‘˜åŒ…å«è½¯ä»¶å¼€å‘é¢†åŸŸçš„æ‰€æœ‰èŒä¸šï¼ŒåŒ…æ‹¬å¹³é¢è®¾è®¡å¸ˆï¼Œç•Œé¢è®¾è®¡å¸ˆï¼Œäº§å“ç»ç†ç­‰ç­‰ï¼Œå¤§å®¶åœ¨èµ›å‰æ ¹æ®è®¡åˆ’ç»„é˜Ÿï¼Œæ¯”èµ›è¿‡ç¨‹ä¸­å„å¸å…¶èŒï¼Œå‘æŒ¥ä¸“é•¿ï¼ŒåŠ›äº‰ä¸ºå›¢é˜Ÿæ‹¿ä¸‹å¥½çš„æˆç»©ã€‚ ä¸è¿‡éšç€ Hackathon çš„ä¸æ–­å‘å±•ï¼Œç°åœ¨çš„ Hackathon å·²ç»ä¸å•å•æ˜¯åœºæ¯”èµ›äº†ï¼Œæˆ‘è§‰å¾—å®ƒæ›´åƒæ˜¯è®© Hacker ä»¬é½èšä¸€å ‚ç››ä¼šå’ŒèŠ‚æ—¥ã€‚ Hackathon 5.0Emmmmmâ€¦ ä¸ºä»€ä¹ˆå« Hackathon 5.0 å‘¢ï¼Ÿå…¶å®æ„Ÿè§‰è¿™ä¸ªå°±æ˜¯å…¬å¸å†…éƒ¨ä¸ºäº†åŒºåˆ†æ¯ä¸€å±Š Hackathon çš„ Tag è€Œå·²ã€‚è²Œä¼¼åœ¨ç¾å›¢ç½‘ä¸å¤§ä¼—ç‚¹è¯„åˆå¹¶ä¹‹å‰ï¼Œä¸¤å®¶å…¬å¸å°±éƒ½æœ‰å†…éƒ¨ä¸¾åŠ Hackathon çš„å†å²ï¼Œåˆå¹¶ä¹‹åè‡ªç„¶è€Œç„¶çš„å°†è¿™ä¸€ä¼ ç»Ÿå»¶ç»­äº†ä¸‹æ¥ã€‚ ä¸åŒäºå¾€å±Šçš„èµ›åˆ¶å¾€å±Š Hackathon å¤§è‡´æµç¨‹ï¼š æå‰ä¸€ä¸¤å‘¨ç»™ä¸€ä¸ªç‰¹å®šèŒƒå›´å†…çš„ä¸»é¢˜ å¤§å®¶æ ¹æ®ä¸»é¢˜æ‰¾çµæ„Ÿ çº¿ä¸‹æ‹‰äººç»„é˜Ÿ æŠ€æœ¯è°ƒç ”ä¿è¯é¡¹ç›®å¯è¡Œæ€§ä»¥åŠç¡®å®šæŠ€æœ¯æ–¹æ¡ˆ æŠ¥åå‚èµ› ç°åœºå¼€å§‹ç¼–ç  åœ¨è§„å®šçš„æ—¶é—´å†…ï¼ˆ24 å°æ—¶ï¼‰å®Œæˆä½œå“ åœ¨å®Œæˆä½œå“æœŸé—´æŠ½æ—¶é—´å‡†å¤‡ PPT æ¨¡æ‹Ÿä¸Šå°å®£è®² è¯„å§”å¯¹å‚èµ›é˜Ÿä¼çš„ä½œå“åˆç­› å…¥å›´çš„é˜Ÿä¼ä¸Šå°å†³èµ›ç­”è¾© è¯„å§”ç»™å‡ºæœ€ç»ˆè¯„åˆ†å†³å‡ºåæ¬¡ ä¸Šå°é¢†å¥– &amp; æ‹ç…§ç•™æ‹ ä¸è¿‡è¿™æ¬¡ Hackathon 5.0 åœ¨èµ›åˆ¶ä¸Šä¸ºäº†ä¿è¯å‚èµ›ä½œå“çš„è´¨é‡ï¼Œæ²¡æœ‰æ˜ç¡®çš„é™åˆ¶ä¸»é¢˜ï¼Œè¿™å°±å¯¼è‡´æœ‰äº›ä½œå“æ˜¯åœ¨èµ›å‰åšäº†å¾ˆä¹…çš„é¡¹ç›®ï¼Œè¿™äº›é¡¹ç›®ä¸è®ºä»ä½“é‡è¿˜æ˜¯ä»è´¨é‡ä¸Šéƒ½è·Ÿ 24 å°æ—¶ç«­å°½å…¨åŠ›æ‰€èƒ½äº§å‡ºçš„ä½œå“æœ‰ç€æ‚¬æ®Šçš„å·®è·ã€‚ ä¸ªäººè®¤ä¸ºæå‰ä¸¤å‘¨å…¬å¸ƒä¸€ä¸ªæ˜ç¡®çš„ä¸»é¢˜èŒƒå›´ï¼Œå¤§å®¶åœ¨ä¸¤å‘¨å†…åšæŠ€æœ¯è°ƒç ”ä¹‹åæå‰åœ¨å·¥ä½œä¹‹ä½™å¼€å§‹æ„å»ºé¡¹ç›®è¿˜æ˜¯å¯ä»¥æ¥å—çš„ï¼Œè¿™æ ·å¯ä»¥ä¿è¯å‚èµ›ä½œå“çš„è´¨é‡åŒæ—¶ä¹Ÿå¯ä»¥çœå»å¤§å®¶é€šå®µç†¬å¤œå¯¹èº«ä½“çš„æŸè€—ã€‚ä¸»åŠæ–¹å‡ºå‘ç‚¹æ˜¯å¥½çš„ï¼Œä½†æ˜¯ä»»ä½•ä¸»é¢˜ä»»ä½•é¡¹ç›®éƒ½å¯ä»¥å‚èµ›è¿™ç‚¹å°±å†³å®šäº†è¿™åœº Hackathon æ³¨å®šæ˜¯ä¸å¤ªå…¬å¹³çš„åŒå°ç«æŠ€ï¼Œä¸ä»…æ‰“å‹äº†éƒ¨åˆ†ç¬¬ä¸€æ¬¡å‚åŠ  Hackathon çš„åŒå­¦ä»¥åç»§ç»­å‚åŠ çš„ç§¯ææ€§ï¼Œè¿˜æ€èµ·äº†ä¸€ä¸ªä¸å¥½çš„åŠ¿å¤´ â€”â€” ä»¥åå‚èµ›çš„ä½œå“å¯èƒ½éƒ½ä¼šæ˜¯æå‰å¾ˆä¹…å°±å¼€å§‹æ„å»ºçš„é¡¹ç›®ã€‚ å˜›~ ä¸Šé¢çš„ä¸ªäººè§‚ç‚¹å¯èƒ½æœ‰äº›é…¸å§â€¦ å› ä¸ºæˆ‘ä»¬æˆ˜é˜Ÿå°±æ˜¯æŒ‰ç…§è€ Hackathon çš„èµ›åˆ¶å‡†å¤‡çš„ï¼ˆäº‹å®ä¸Šæˆ‘å¹¶ä¸çŸ¥é“ç¾å›¢Â·ç‚¹è¯„å†…éƒ¨ Hackathon ä»€ä¹ˆæ—¶å€™ä¸¾åŠï¼Œä¹Ÿä¸çŸ¥é“è¿™æ¬¡çš„èµ›åˆ¶ç«Ÿç„¶æ²¡æœ‰é™åˆ¶ä¸»é¢˜ï¼‰ã€‚ å—¨ Kr æ£®å˜›~ â€œå—¨ Kr æ£®â€æ˜¯æˆ‘ä»¬æœ¬æ¬¡å‚åŠ  Hackathon 5.0 çš„æˆ˜é˜Ÿåå“ˆï¼ èµ·è¿™ä¸ªåå­—æ— éå°±æ˜¯è§‰å¾—æ¯”è¾ƒå¥½ç©ï¼Œå› ä¸ºç»„é‡Œè¿æˆ‘åœ¨å†…çš„ä¸‰äººä¸­ï¼Œæœ‰ä¸¤ä½éƒ½æ²¡æœ‰å‚åŠ è¿‡å…¬å¸å†…éƒ¨ç»„ç»‡çš„ Hackathonï¼Œæ‰€ä»¥æœ¬æ¬¡å‚èµ›çš„ä¸»è¦ç›®çš„å°±æ˜¯ç†Ÿæ‚‰ä¸€ä¸‹å…¬å¸å†…éƒ¨ Hackathon çš„æµç¨‹ï¼Œè¿˜æœ‰æ··ä¸€ä»¶ Hackathon 5.0 ä¸»é¢˜ T æ¤è¡«ï¼ˆç¬‘ï¼‰ã€‚ Somewhere Somewhere è¯‘ä¸ºâ€œæŸå¤„â€ï¼Œæ˜¯æˆ‘ä»¬æˆ˜é˜Ÿè¿™æ¬¡æ‹¿æ¥å‚èµ›çš„ä½œå“ã€‚å®ƒæ˜¯ä¸€ä¸ªå°† AR æŠ€æœ¯ç»“åˆåˆ°åœ°å›¾çš„é¡¹ç›®ï¼Œæ—¨åœ¨å¸®åŠ©ç”¨æˆ·å‘ç°å€¼å¾—æ¶ˆè´¹æ—¶é—´å»ç”¨å¿ƒä½“éªŒçš„åœ°æ–¹ã€‚ Emmmmmâ€¦ å…¶å®å…³äº Somewhere è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒæ–‡è‰ºçš„æ–‡æ¡ˆæ˜¯æˆ‘ä»¬å½“æ—¶åœ¨å†™å‚èµ› PPT æ—¶æƒ³åˆ°çš„ã€‚ æˆ‘ä»¬ä¸€ç›´ä»¥æ¥éƒ½å¸Œæœ›ï¼Œæ‰“å¼€æ‰‹æœºï¼Œå¯¹å‡†æƒ³è¦å»çš„æ–¹å‘ã€‚ç›¸ä¿¡æ€»æœ‰ä¸€å¤„åœ°æ–¹ï¼Œå€¼å¾—æˆ‘ä»¬èŠ±äº›æ—¶é—´åœ¨é‚£é‡Œã€‚Somewhereï¼Œå¸®åŠ©ä½ å‘ç°è¿‘åœ¨å’«å°ºçš„ç¾å¥½ã€‚ Somewhere å‚è€ƒäº† ARKit-CoreLocation çš„å®ç°ï¼Œåœ¨å…¶åŸºç¡€ä¸Šåšäº†ä¸€äº›ä¼˜åŒ–ï¼Œä¾‹å¦‚å¯¹æŸä¸€æ–¹å‘é‡å åœ¨ä¸€èµ·çš„ POI AR Annotations åšäº†æ”¶æ•›ä»¥é˜²æ­¢å¤šä¸ª POI AR Annotations é‡å åœ¨ä¸€èµ·çš„é—®é¢˜ã€‚ å¯æƒœçš„æ˜¯ Somewhere åªæ‹¿åˆ°äº†å…¥å›´å¥–ï¼ˆ42 è¿› 10ï¼‰ï¼Œç¡®å®ç«™åœ¨è¯„å§”çš„è§’åº¦çœ‹ Somewhere åœ¨å®Œæˆåº¦ä¸Šé¢å¯¹æ¯”è·å¥–ä½œå“æ¥è¯´å·®çš„å¤ªå¤šäº†â€¦ å»å¹´çš„ Hackathon å›å¿†å»å¹´è¿˜åœ¨ ELSEWHERE å·¥ä½œæ—¶ï¼Œå’Œå…¬å¸çš„å°ä¼™ä¼´ä¸€èµ·å»ä¸Šæµ·å‚åŠ ä¸­ä¿¡é›†å›¢ä¸å®é©¬è”åˆèµåŠ©ä¸¾åŠçš„å¼€æ”¾å¼ Hackathonï¼Œä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡å‚åŠ  Hackathonï¼Œæ‰€ä»¥å¾ˆå¤šç»†èŠ‚éƒ½è®°å¾—æ¸…æ¸…æ¥šæ¥š~ é‚£å±Š Hackathon çš„ä¸»é¢˜æ˜¯ä¸‰é€‰ä¸€ï¼Œå…¶ä¸­ä¸­ä¿¡é›†å›¢çš„ä¸»é¢˜ä¹‹ä¸€æ˜¯æˆ‘ä»¬ä¸€ç›´æ¯”è¾ƒæ„Ÿå…´è¶£çš„åŒºå—é“¾ç›¸å…³ä¸»é¢˜ï¼Œä¸­ä¿¡é›†å›¢æƒ³è¦ä¾é åŒºå—é“¾æŠ€æœ¯æ‰“é€ å…¶é›†å›¢ä¸‹å±ä¸šåŠ¡ä¹‹é—´çš„ç”¨æˆ·ä¿¡ç”¨ä½“ç³»ï¼Œç¡®å®åˆ©ç”¨åŒºå—é“¾è¶…çº§è´¦æœ¬åšä¿¡ç”¨ç›¸å…³çš„ä¸œè¥¿æ˜¯ä¸ªä¸é”™çš„å‡ºå‘ç‚¹ï¼Œä»æ‰©å±•æ€§çš„è§’åº¦çœ‹åŒºå—é“¾æŠ€æœ¯å¯ä»¥è®©ä¸­ä¿¡é›†å›¢ä»¥åæ”¯æŒå¹¶å…¥å…¶ä»–éé›†å›¢æ——ä¸‹çš„å¤–éƒ¨ä¸šåŠ¡ã€‚ æœ€åæˆ‘ä»¬çš„å‚èµ›ä½œå“â€œä¿¡ä¿¡â€éå¸¸å¹¸è¿çš„å…¥å›´ï¼Œå¹¶ä¸”åœ¨å†³èµ›æ‹¿åˆ°äº†åæ¬¡å’Œå¥–å“~ æ€»ç»“ å¹³æ—¥é‡Œæœ‰è‡ªå·±æ„Ÿå…´è¶£çš„æŠ€æœ¯æˆ–è€…æƒ³åšçš„äº‹æƒ…ï¼Œä¸å¦¨æŠ½ç©ºåŠ¨æ‰‹å†™ä¸€å†™ Demoï¼Œå¦‚æœå¯è¡Œçš„è¯å¯ä»¥æŒç»­æŠ½æ—¶é—´å®Œå–„ï¼Œè¯´ä¸å®šå¯ä»¥æ‹¿æ¥ä½œä¸ºä½œå“å‚åŠ ä¸‹ä¸€å±Šå…¬å¸å†…éƒ¨çš„ Hackathonã€‚ PPT å’Œä½œå“çš„æ ¸å¿ƒä»£ç ä¸€æ ·é‡è¦ï¼Œåˆèµ›å®£è®²å’Œå†³èµ›ç­”è¾©ç»™å‡ºçš„æ—¶é—´ä¸åŒï¼Œæœ€å¥½å‡†å¤‡è¯¦ç•¥ä¸¤ä»½ PPTã€‚ æ ¸å¿ƒæµç¨‹ä¸€å®šè¦è·‘é€šï¼Œå°¤å…¶æ˜¯æ¶‰åŠåˆ°ç½‘ç»œï¼Œå®šä½ç­‰ä¸ç¡®å®šå› ç´ æ—¶ï¼Œä¸€å®šè¦åœ¨ä¸Šå°å‰ç¡®è®¤å¥½å½“å‰çš„çŠ¶æ€æ˜¯å¦ä¼šå½±å“åˆ°ä½œå“æ¼”ç¤ºã€‚ æœ€å—æ¬¢è¿å¥–ä¼šåœ¨ç¬¬äºŒæ—¥çš„å†³èµ›ç­”è¾©ä¹‹å‰ç»™å‡ºä¸€ä¸ªæŠ•ç¥¨é¡µé¢ï¼Œåœ¨é˜Ÿé•¿ç¾¤ä¼šå‘¨çŸ¥è¦å¡«å†™æŠ•ç¥¨é¡µé¢ä¸­å…³äºè‡ªå·±æˆ˜é˜Ÿçš„ä½œå“ç®€ä»‹ï¼Œä¸€å®šè¦åŠæ—¶å¡«å†™ä½œå“ç®€ä»‹ä»¥å…å½±å“å¾—ç¥¨ç‡ã€‚ å˜›~ ç›®å‰å‡†å¤‡çœ‹ä¸€ä¸‹ WWDC 2018 æœ‰æ²¡æœ‰ä»€ä¹ˆæ„Ÿå…´è¶£çš„æŠ€æœ¯ç‚¹ï¼Œå‡†å¤‡æ‹¿æ¥ç»“åˆç”Ÿæ´»ä¸­çš„åœºæ™¯åšäº›æœ‰è¶£çš„ä¸œè¥¿å‡ºæ¥ï¼Œä¸º Hackathon 6.0 åšå‡†å¤‡~ Emmmmmâ€¦ æœ€åè¿˜è¦æ„Ÿè°¢æˆ˜é˜Ÿé‡Œé¢çš„ä¸¤ä½å¤§ä½¬æ„¿æ„æŠŠå®£è®²å’Œç­”è¾©çš„æœºä¼šè®©ç»™æˆ‘ï¼Œç¬¬ä¸€æ¬¡é¢å¯¹ç€è¯„å§”å’Œå°ä¸‹è¿™ä¹ˆå¤šä¼˜ç§€çš„åŒäº‹ï¼ˆå…¶ä¸­ä¸ä¹æŠ€æœ¯å¤§ä½¬ï¼‰è®²è¯çœŸçš„æ˜¯éå¸¸ç´§å¼ çš„è¯´ï¼Œæœç„¶åœ¨å›ç­”æŸäº›é—®é¢˜ä¸Šä¸å¤Ÿå·§å¦™â€¦ ä¸è¿‡å¥½åœ¨å¯¹äºé¡¹ç›®çš„å®£è®²å’Œæè¿°è¿˜ç®—æ¯”è¾ƒå®Œæ•´ï¼Œå¤§ä½¬ä»¬ä¹Ÿæ²¡æœ‰è´£æ€ªæˆ‘çš„æ„æ€ï¼Œè¿˜ç»™æˆ‘æ‹äº†ä¸€å¼ ç­”è¾©æ—¶çš„ç…§ç‰‡~"},{"title":"æ·±å…¥ç†è§£ iOS Rendering Process","comments":true,"permalink":"https://lision.me/ios-rendering-process/","text":"å‰è¨€iOS æœ€æ—©åä¸º iPhone OSï¼Œæ˜¯ Apple å…¬å¸ä¸“é—¨ä¸ºå…¶ç¡¬ä»¶è®¾å¤‡å¼€å‘çš„æ“ä½œç³»ç»Ÿï¼Œæœ€åˆäº 2007 å¹´éšç¬¬ä¸€ä»£ iPhone æ¨å‡ºï¼Œåæ‰©å±•ä¸ºæ”¯æŒ Apple å…¬å¸æ——ä¸‹çš„å…¶ä»–ç¡¬ä»¶è®¾å¤‡ï¼Œå¦‚ iPodã€iPad ç­‰ã€‚ ä½œä¸ºä¸€å iOS Developerï¼Œç›¸ä¿¡å¤§å¤šæ•°äººéƒ½æœ‰å†™å‡ºè¿‡é€ æˆ iOS è®¾å¤‡å¡é¡¿çš„ä»£ç ç»å†ï¼Œç›¸åº”çš„ä¹Ÿæœ‰è¿‡æƒ³æ–¹è®¾æ³•ä¼˜åŒ–å¡é¡¿ä»£ç çš„ç»éªŒã€‚ æœ¬æ–‡å°†ä» OpenGL çš„è§’åº¦ç»“åˆ Apple å®˜æ–¹ç»™å‡ºçš„éƒ¨åˆ†èµ„æ–™ï¼Œä»‹ç» iOS Rendering Process çš„æ¦‚å¿µåŠå…¶æ•´ä¸ªåº•å±‚æ¸²æŸ“ç®¡é“çš„å„ä¸ªæµç¨‹ã€‚ ç›¸ä¿¡åœ¨ç†è§£äº† iOS Rendering Process çš„åº•å±‚å„ä¸ªé˜¶æ®µä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¹³æ—¥çš„å¼€å‘å·¥ä½œä¹‹ä¸­å†™å‡ºæ€§èƒ½æ›´é«˜çš„ä»£ç ï¼Œåœ¨è§£å†³å¸§ç‡ä¸è¶³çš„æ˜¾ç¤ºå¡é¡¿é—®é¢˜æ—¶ä¹Ÿå¯ä»¥å¤šä¸€äº›æ€è·¯~ ç´¢å¼• iOS Rendering Process æ¦‚å¿µ iOS Rendering æŠ€æœ¯æ¡†æ¶ OpenGL ä¸»è¦æ¸²æŸ“æ­¥éª¤ OpenGL Render Pipeline Core Animation Pipeline Commit Transaction Animation å…¨æ–‡æ€»ç»“ æ‰©å±•é˜…è¯» iOS Rendering Process æ¦‚å¿µiOS Rendering Process è¯‘ä¸º iOS æ¸²æŸ“æµç¨‹ï¼Œæœ¬æ–‡ç‰¹æŒ‡ iOS è®¾å¤‡ä»è®¾ç½®å°†è¦æ˜¾ç¤ºçš„å›¾å…ƒæ•°æ®åˆ°æœ€ç»ˆåœ¨è®¾å¤‡å±å¹•æˆåƒçš„æ•´ä¸ªè¿‡ç¨‹ã€‚ åœ¨å¼€å§‹å‰–æ iOS Rendering Process ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ iOS çš„æ¸²æŸ“æ¦‚å¿µæœ‰ä¸€ä¸ªåŸºæœ¬çš„è®¤çŸ¥ï¼š åŸºäºå¹³é“ºçš„æ¸²æŸ“iOS è®¾å¤‡çš„å±å¹•åˆ†ä¸º N * N åƒç´ çš„å›¾å—ï¼Œæ¯ä¸ªå›¾å—éƒ½é€‚åˆäº SoC ç¼“å­˜ï¼Œå‡ ä½•ä½“åœ¨å›¾å—å†…è¢«å¤§é‡æ‹†åˆ†ï¼Œåªæœ‰åœ¨æ‰€æœ‰å‡ ä½•ä½“å…¨éƒ¨æäº¤ä¹‹åæ‰å¯ä»¥è¿›è¡Œå…‰æ …åŒ–ï¼ˆRasterizationï¼‰ã€‚ Note: è¿™é‡Œçš„å…‰æ …åŒ–æŒ‡å°†å±å¹•ä¸Šé¢è¢«å¤§é‡æ‹†åˆ†å‡ºæ¥çš„å‡ ä½•ä½“æ¸²æŸ“ä¸ºåƒç´ ç‚¹çš„è¿‡ç¨‹ã€‚ iOS Rendering æŠ€æœ¯æ¡†æ¶äº‹å®ä¸Š iOS æ¸²æŸ“ç›¸å…³çš„å±‚çº§åˆ’åˆ†å¤§æ¦‚å¦‚ä¸‹ï¼š UIKitå˜›~ ä½œä¸ºä¸€å iOS Developer æ¥è¯´ï¼Œåº”è¯¥å¯¹ UIKit éƒ½ä¸é™Œç”Ÿï¼Œæˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ä½¿ç”¨çš„ç”¨æˆ·äº¤äº’ç»„ä»¶éƒ½æ¥è‡ªäº UIKit Frameworkï¼Œæˆ‘ä»¬é€šè¿‡è®¾ç½® UIKit ç»„ä»¶çš„ Layout ä»¥åŠ BackgroundColor ç­‰å±æ€§æ¥å®Œæˆæ—¥å¸¸çš„ç•Œé¢ç»˜ç”»å·¥ä½œã€‚ å…¶å® UIKit Framework è‡ªèº«å¹¶ä¸å…·å¤‡åœ¨å±å¹•æˆåƒçš„èƒ½åŠ›ï¼Œå®ƒä¸»è¦è´Ÿè´£å¯¹ç”¨æˆ·æ“ä½œäº‹ä»¶çš„å“åº”ï¼Œäº‹ä»¶å“åº”çš„ä¼ é€’å¤§ä½“æ˜¯ç»è¿‡é€å±‚çš„è§†å›¾æ ‘éå†å®ç°çš„ã€‚ é‚£ä¹ˆæˆ‘ä»¬æ—¥å¸¸å†™çš„ UIKit ç»„ä»¶ä¸ºä»€ä¹ˆå¯ä»¥å‘ˆç°åœ¨ iOS è®¾å¤‡çš„å±å¹•ä¸Šå‘¢ï¼Ÿ Core AnimationCore Animation å…¶å®æ˜¯ä¸€ä¸ªä»¤äººè¯¯è§£çš„å‘½åã€‚ä½ å¯èƒ½è®¤ä¸ºå®ƒåªæ˜¯ç”¨æ¥åšåŠ¨ç”»çš„ï¼Œä½†å®é™…ä¸Šå®ƒæ˜¯ä»ä¸€ä¸ªå«åš Layer Kit è¿™ä¹ˆä¸€ä¸ªä¸æ€ä¹ˆå’ŒåŠ¨ç”»æœ‰å…³çš„åå­—æ¼”å˜è€Œæ¥çš„ï¼Œæ‰€ä»¥åšåŠ¨ç”»ä»…ä»…æ˜¯ Core Animation ç‰¹æ€§çš„å†°å±±ä¸€è§’ã€‚ Core Animation æœ¬è´¨ä¸Šå¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ªå¤åˆå¼•æ“ï¼Œæ—¨åœ¨å°½å¯èƒ½å¿«çš„ç»„åˆå±å¹•ä¸Šä¸åŒçš„æ˜¾ç¤ºå†…å®¹ã€‚è¿™äº›æ˜¾ç¤ºå†…å®¹è¢«åˆ†è§£æˆç‹¬ç«‹çš„å›¾å±‚ï¼Œå³ CALayerï¼ŒCALayer æ‰æ˜¯ä½ æ‰€èƒ½åœ¨å±å¹•ä¸Šçœ‹è§çš„ä¸€åˆ‡çš„åŸºç¡€ã€‚ å…¶å®å¾ˆå¤šåŒå­¦éƒ½åº”è¯¥çŸ¥é“ CALayerï¼ŒUIKit ä¸­éœ€è¦åœ¨å±å¹•å‘ˆç°çš„ç»„ä»¶å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ CALayerï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ Backing Layerã€‚æ­£æ˜¯å› ä¸ºä¸€ä¸€å¯¹åº”ï¼Œæ‰€ä»¥ CALayer ä¹Ÿæ˜¯æ ‘å½¢ç»“æ„çš„ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå›¾å±‚æ ‘ã€‚ è§†å›¾çš„èŒè´£å°±æ˜¯åˆ›å»ºå¹¶ç®¡ç†è¿™ä¸ªå›¾å±‚ï¼Œä»¥ç¡®ä¿å½“å­è§†å›¾åœ¨å±‚çº§å…³ç³»ä¸­æ·»åŠ æˆ–è€…è¢«ç§»é™¤çš„æ—¶å€™ï¼Œä»–ä»¬å…³è”çš„å›¾å±‚ä¹ŸåŒæ ·å¯¹åº”åœ¨å±‚çº§å…³ç³»æ ‘å½“ä¸­æœ‰ç›¸åŒçš„æ“ä½œã€‚ ä½†æ˜¯ä¸ºä»€ä¹ˆ iOS è¦åŸºäº UIView å’Œ CALayer æä¾›ä¸¤ä¸ªå¹³è¡Œçš„å±‚çº§å…³ç³»å‘¢ï¼Ÿä¸ºä»€ä¹ˆä¸ç”¨ä¸€ä¸ªç®€å•çš„å±‚çº§å…³ç³»æ¥å¤„ç†æ‰€æœ‰äº‹æƒ…å‘¢ï¼Ÿ åŸå› åœ¨äºè¦åšèŒè´£åˆ†ç¦»ï¼Œè¿™æ ·ä¹Ÿèƒ½é¿å…å¾ˆå¤šé‡å¤ä»£ç ã€‚åœ¨ iOS å’Œ Mac OS X ä¸¤ä¸ªå¹³å°ä¸Šï¼Œäº‹ä»¶å’Œç”¨æˆ·äº¤äº’æœ‰å¾ˆå¤šåœ°æ–¹çš„ä¸åŒï¼ŒåŸºäºå¤šç‚¹è§¦æ§çš„ç”¨æˆ·ç•Œé¢å’ŒåŸºäºé¼ æ ‡é”®ç›˜çš„äº¤äº’æœ‰ç€æœ¬è´¨çš„åŒºåˆ«ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ iOS æœ‰ UIKit å’Œ UIViewï¼Œè€Œ Mac OS X æœ‰ AppKit å’Œ NSView çš„åŸå› ã€‚ä»–ä»¬åŠŸèƒ½ä¸Šå¾ˆç›¸ä¼¼ï¼Œä½†æ˜¯åœ¨å®ç°ä¸Šæœ‰ç€æ˜¾è‘—çš„åŒºåˆ«ã€‚ Note: å®é™…ä¸Šï¼Œè¿™é‡Œå¹¶ä¸æ˜¯ä¸¤ä¸ªå±‚çº§å…³ç³»ï¼Œè€Œæ˜¯å››ä¸ªï¼Œæ¯ä¸€ä¸ªéƒ½æ‰®æ¼”ä¸åŒçš„è§’è‰²ï¼Œé™¤äº†è§†å›¾æ ‘å’Œå›¾å±‚æ ‘ä¹‹å¤–ï¼Œè¿˜å­˜åœ¨å‘ˆç°æ ‘å’Œæ¸²æŸ“æ ‘ã€‚ OpenGL ES &amp; Core GraphicsOpenGL ESOpenGL ES ç®€ç§° GLESï¼Œå³ OpenGL for Embedded Systemsï¼Œæ˜¯ OpenGL çš„å­é›†ï¼Œé€šå¸¸é¢å‘å›¾å½¢ç¡¬ä»¶åŠ é€Ÿå¤„ç†å•å…ƒï¼ˆGPUï¼‰æ¸²æŸ“ 2D å’Œ 3D è®¡ç®—æœºå›¾å½¢ï¼Œä¾‹å¦‚è§†é¢‘æ¸¸æˆä½¿ç”¨çš„è®¡ç®—æœºå›¾å½¢ã€‚ OpenGL ES ä¸“ä¸ºæ™ºèƒ½æ‰‹æœºï¼Œå¹³æ¿ç”µè„‘ï¼Œè§†é¢‘æ¸¸æˆæœºå’Œ PDA ç­‰åµŒå…¥å¼ç³»ç»Ÿè€Œè®¾è®¡ ã€‚OpenGL ES æ˜¯â€œå†å²ä¸Šåº”ç”¨æœ€å¹¿æ³›çš„ 3D å›¾å½¢ APIâ€ã€‚ Core GraphicsCore Graphics Framework åŸºäº Quartz é«˜çº§ç»˜å›¾å¼•æ“ã€‚å®ƒæä¾›äº†å…·æœ‰æ— ä¸ä¼¦æ¯”çš„è¾“å‡ºä¿çœŸåº¦çš„ä½çº§åˆ«è½»é‡çº§ 2D æ¸²æŸ“ã€‚æ‚¨å¯ä»¥ä½¿ç”¨æ­¤æ¡†æ¶æ¥å¤„ç†åŸºäºè·¯å¾„çš„ç»˜å›¾ï¼Œè½¬æ¢ï¼Œé¢œè‰²ç®¡ç†ï¼Œç¦»å±æ¸²æŸ“ï¼Œå›¾æ¡ˆï¼Œæ¸å˜å’Œé˜´å½±ï¼Œå›¾åƒæ•°æ®ç®¡ç†ï¼Œå›¾åƒåˆ›å»ºå’Œå›¾åƒé®ç½©ä»¥åŠ PDF æ–‡æ¡£åˆ›å»ºï¼Œæ˜¾ç¤ºå’Œåˆ†æã€‚ Note: åœ¨ Mac OS X ä¸­ï¼ŒCore Graphics è¿˜åŒ…æ‹¬ç”¨äºå¤„ç†æ˜¾ç¤ºç¡¬ä»¶ï¼Œä½çº§ç”¨æˆ·è¾“å…¥äº‹ä»¶å’Œçª—å£ç³»ç»Ÿçš„æœåŠ¡ã€‚ Graphics HardwareGraphics Hardware è¯‘ä¸ºå›¾å½¢ç¡¬ä»¶ï¼ŒiOS è®¾å¤‡ä¸­ä¹Ÿæœ‰è‡ªå·±çš„å›¾å½¢ç¡¬ä»¶è®¾å¤‡ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸æåŠçš„ GPUã€‚ å›¾å½¢å¤„ç†å•å…ƒï¼ˆGPUï¼‰æ˜¯ä¸€ç§ä¸“ç”¨ç”µå­ç”µè·¯ï¼Œæ—¨åœ¨å¿«é€Ÿæ“ä½œå’Œæ”¹å˜å­˜å‚¨å™¨ï¼Œä»¥åŠ é€Ÿåœ¨ç”¨äºè¾“å‡ºåˆ°æ˜¾ç¤ºè®¾å¤‡çš„å¸§ç¼“å†²å™¨ä¸­åˆ›å»ºå›¾åƒã€‚GPU è¢«ç”¨äºåµŒå…¥å¼ç³»ç»Ÿï¼Œæ‰‹æœºï¼Œä¸ªäººç”µè„‘ï¼Œå·¥ä½œç«™å’Œæ¸¸æˆæ§åˆ¶å°ã€‚ç°ä»£ GPU åœ¨å¤„ç†è®¡ç®—æœºå›¾å½¢å’Œå›¾åƒæ–¹é¢éå¸¸é«˜æ•ˆï¼Œå¹¶ä¸” GPU çš„é«˜åº¦å¹¶è¡Œç»“æ„ä½¿å…¶åœ¨å¤§å—æ•°æ®å¹¶è¡Œå¤„ç†çš„ç®—æ³•ä¸­æ¯”é€šç”¨ CPU æ›´æœ‰æ•ˆã€‚ OpenGL ä¸»è¦æ¸²æŸ“æ­¥éª¤OpenGL å…¨ç§° Open Graphics Libraryï¼Œè¯‘ä¸ºå¼€æ”¾å›¾å½¢åº“ï¼Œæ˜¯ç”¨äºæ¸²æŸ“ 2D å’Œ 3D çŸ¢é‡å›¾å½¢çš„è·¨è¯­è¨€ï¼Œè·¨å¹³å°çš„åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼ˆAPIï¼‰ã€‚OpenGL å¯ä»¥ç›´æ¥è®¿é—® GPUï¼Œä»¥å®ç°ç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“ã€‚ ä¸€ä¸ªç”¨æ¥æ¸²æŸ“å›¾åƒçš„ OpenGL ç¨‹åºä¸»è¦å¯ä»¥å¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š è®¾ç½®å›¾å…ƒæ•°æ® ç€è‰²å™¨-shader è®¡ç®—å›¾å…ƒæ•°æ®ï¼ˆä½ç½®Â·é¢œè‰²Â·å…¶ä»–ï¼‰ å…‰æ …åŒ–-rasterization æ¸²æŸ“ä¸ºåƒç´  fragment shaderï¼Œå†³å®šæœ€ç»ˆæˆåƒ å…¶ä»–æ“ä½œï¼ˆæ˜¾ç¤ºÂ·éšè—Â·èåˆï¼‰ Note: å…¶å®è¿˜æœ‰ä¸€äº›éå¿…è¦çš„æ­¥éª¤ï¼Œä¸æœ¬æ–‡ä¸»é¢˜ä¸ç›¸å…³ï¼Œè¿™é‡Œç‚¹åˆ°ä¸ºæ­¢ã€‚ æˆ‘ä»¬æ—¥å¸¸å¼€å‘æ—¶ä½¿ç”¨ UIKit å¸ƒå±€è§†å›¾æ§ä»¶ï¼Œè®¾ç½®é€æ˜åº¦ç­‰ç­‰éƒ½å±äºè®¾ç½®å›¾å…ƒæ•°æ®è¿™æ­¥ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­å¯ä»¥å½±å“ OpenGL æ¸²æŸ“çš„ä¸»è¦æ­¥éª¤ã€‚ OpenGL Render Pipelineå¦‚æœæœ‰åŒå­¦çœ‹è¿‡ WWDC çš„ä¸€äº›æ¼”è®²ç¨¿æˆ–è€…æ¥è§¦è¿‡ä¸€äº› OpenGL çŸ¥è¯†ï¼Œåº”è¯¥å¯¹ Render Pipeline è¿™ä¸ªä¸“ä¸šæœ¯è¯­å¹¶ä¸é™Œç”Ÿã€‚ ä¸è¿‡ Render Pipeline å®åœ¨æ˜¯ä¸€ä¸ªåˆæ¬¡è§é¢ä¸å¤ªå®¹æ˜“ç†è§£çš„è¯ï¼Œå®ƒè¯‘ä¸ºæ¸²æŸ“ç®¡é“ï¼Œä¹Ÿæœ‰è¯‘ä¸ºæ¸²æŸ“ç®¡çº¿çš„â€¦ å…¶å® Render Pipeline æŒ‡çš„æ˜¯ä»åº”ç”¨ç¨‹åºæ•°æ®è½¬æ¢åˆ°æœ€ç»ˆæ¸²æŸ“çš„å›¾åƒä¹‹é—´çš„ä¸€ç³»åˆ—æ•°æ®å¤„ç†è¿‡ç¨‹ã€‚ å¥½æ¯”æˆ‘ä»¬ä¸Šæ–‡ä¸­æåˆ°çš„ OpenGL ä¸»è¦æ¸²æŸ“æ­¥éª¤ä¸€æ ·ï¼Œæˆ‘ä»¬å¼€å‘åº”ç”¨ç¨‹åºæ—¶åœ¨è®¾ç½®å›¾å…ƒæ•°æ®è¿™æ­¥ä¸ºè§†å›¾æ§ä»¶çš„è®¾å®šå¸ƒå±€ï¼ŒèƒŒæ™¯é¢œè‰²ï¼Œé€æ˜åº¦ä»¥åŠé˜´å½±ç­‰ç­‰æ•°æ®ã€‚ ä¸‹é¢ä»¥ OpenGL 4.5 çš„ Render Pipeline ä¸ºä¾‹ä»‹ç»ä¸€ä¸‹ï¼š è¿™äº›å›¾å…ƒæ•°æ®æµå…¥ OpenGL ä¸­ï¼Œä¼ å…¥é¡¶ç‚¹ç€è‰²å™¨ï¼ˆvetex shaderï¼‰ï¼Œç„¶åé¡¶ç‚¹ç€è‰²å™¨å¯¹å…¶è¿›è¡Œç€è‰²å™¨å†…éƒ¨çš„å¤„ç†åæµå‡ºã€‚ä¹‹åå¯èƒ½è¿›å…¥ç»†åˆ†ç€è‰²é˜¶æ®µï¼ˆtessellation shading stageï¼‰ï¼Œå…¶ä¸­åˆæœ‰å¯èƒ½åˆ†ä¸ºç»†åˆ†æ§åˆ¶ç€è‰²å™¨å’Œç»†åˆ†èµ‹å€¼ç€è‰²å™¨ä¸¤éƒ¨åˆ†å¤„ç†ï¼Œè¿˜å¯èƒ½ä¼šè¿›å…¥å‡ ä½•ç€è‰²é˜¶æ®µï¼ˆgeometry shading stageï¼‰ï¼Œæ•°æ®ä»ä¸­ä¼ é€’ã€‚æœ€åéƒ½ä¼šèµ°ç‰‡å…ƒç€è‰²é˜¶æ®µï¼ˆfragment shading stageï¼‰ã€‚ Note: å›¾å…ƒæ•°æ®æ˜¯ä»¥ copy çš„å½¢å¼æµå…¥ shader çš„ï¼Œshader ä¸€èˆ¬ä¼šä»¥ç‰¹æ®Šçš„ç±»ä¼¼å…¨å±€å˜é‡çš„å½¢å¼æ¥æ”¶æ•°æ®ã€‚ OpenGL åœ¨æœ€ç»ˆæˆåƒä¹‹å‰è¿˜ä¼šç»å†ä¸€ä¸ªé˜¶æ®µåä¸ºè®¡ç®—ç€è‰²é˜¶æ®µï¼ˆcompute shaing stageï¼‰ï¼Œè¿™ä¸ªé˜¶æ®µ OpenGL ä¼šè®¡ç®—æœ€ç»ˆè¦åœ¨å±å¹•ä¸­æˆåƒçš„åƒç´ ä½ç½®ä»¥åŠé¢œè‰²ï¼Œå¦‚æœåœ¨ä¹‹å‰æäº¤ä»£ç æ—¶ç”¨åˆ°äº† CALayer ä¼šå¼•èµ· blending çš„æ˜¾ç¤ºæ•ˆæœï¼ˆä¾‹å¦‚ Shadowï¼‰æˆ–è€…è§†å›¾é¢œè‰²æˆ–å†…å®¹å›¾ç‰‡çš„ alpha é€šé“å¼€å¯ï¼Œéƒ½å°†ä¼šåŠ å¤§è¿™ä¸ªé˜¶æ®µ OpenGL çš„å·¥ä½œé‡ã€‚ Core Animation Pipelineä¸Šæ–‡è¯´åˆ°äº† iOS è®¾å¤‡ä¹‹æ‰€ä»¥å¯ä»¥æˆåƒä¸æ˜¯å› ä¸º UIKit è€Œæ˜¯å› ä¸º LayerKitï¼Œå³ Core Animationã€‚ Core Animation å›¾å±‚ï¼Œå³ CALayer ä¸­åŒ…å«ä¸€ä¸ªå±æ€§ contentsï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»™è¿™ä¸ªå±æ€§èµ‹å€¼æ¥æ§åˆ¶ CALayer æˆåƒçš„å†…å®¹ã€‚è¿™ä¸ªå±æ€§çš„ç±»å‹å®šä¹‰ä¸º idï¼Œåœ¨ç¨‹åºç¼–è¯‘æ—¶ä¸è®ºæˆ‘ä»¬ç»™ contents èµ‹äºˆä»»ä½•ç±»å‹çš„å€¼ï¼Œéƒ½æ˜¯å¯ä»¥ç¼–è¯‘é€šè¿‡çš„ã€‚ä½†å®è·µä¸­ï¼Œå¦‚æœ contents èµ‹å€¼ç±»å‹ä¸æ˜¯ CGImageï¼Œé‚£ä¹ˆä½ å°†ä¼šå¾—åˆ°ä¸€ä¸ªç©ºç™½å›¾å±‚ã€‚ Note: é€ æˆ contents å±æ€§çš„å¥‡æ€ªè¡¨ç°çš„åŸå› æ˜¯ Mac OS X çš„å†å²åŒ…è¢±ï¼Œå®ƒä¹‹æ‰€ä»¥è¢«å®šä¹‰ä¸º id ç±»å‹æ˜¯å› ä¸ºåœ¨ Mac OS X ä¸­è¿™ä¸ªå±æ€§å¯¹ CGImage å’Œ NSImage ç±»å‹çš„å€¼éƒ½èµ·ä½œç”¨ã€‚ä½†æ˜¯åœ¨ iOS ä¸­ï¼Œå¦‚æœä½ èµ‹äºˆä¸€ä¸ª UIImage å±æ€§çš„å€¼ï¼Œä»…ä»…ä¼šå¾—åˆ°ä¸€ä¸ªç©ºç™½å›¾å±‚ã€‚ è¯´å®Œ Core Animation çš„ contents å±æ€§ï¼Œä¸‹é¢ä»‹ç»ä¸€ä¸‹ iOS ä¸­ Core Animation Pipelineï¼š åœ¨ Application ä¸­å¸ƒå±€ UIKit è§†å›¾æ§ä»¶é—´æ¥çš„å…³è” Core Animation å›¾å±‚ Core Animation å›¾å±‚ç›¸å…³çš„æ•°æ®æäº¤åˆ° iOS Render Serverï¼Œå³ OpenGL ES &amp; Core Graphics Render Server å°†ä¸ GPU é€šä¿¡æŠŠæ•°æ®ç»è¿‡å¤„ç†ä¹‹åä¼ é€’ç»™ GPU GPU è°ƒç”¨ iOS å½“å‰è®¾å¤‡æ¸²æŸ“ç›¸å…³çš„å›¾å½¢è®¾å¤‡ Display Note: ç”±äº iOS è®¾å¤‡ç›®å‰çš„æ˜¾ç¤ºå±æœ€å¤§æ”¯æŒ 60 FPS çš„åˆ·æ–°ç‡ï¼Œæ‰€ä»¥æ¯ä¸ªå¤„ç†é—´éš”ä¸º 16.67 msã€‚ å¯ä»¥çœ‹åˆ°ä» Commit Transaction ä¹‹åæˆ‘ä»¬çš„å›¾å…ƒæ•°æ®å°±å°†ä¼šåœ¨ä¸‹ä¸€æ¬¡ RunLoop æ—¶è¢« Application å‘é€ç»™åº•å±‚çš„ Render Serverï¼Œåº•å±‚ Render Server ç›´æ¥é¢å‘ GPU ç»è¿‡ä¸€ç³»åˆ—çš„æ•°æ®å¤„ç†å°†å¤„ç†å®Œæ¯•çš„æ•°æ®ä¼ é€’ç»™ GPUï¼Œç„¶å GPU è´Ÿè´£æ¸²æŸ“å·¥ä½œï¼Œæ ¹æ®å½“å‰ iOS è®¾å¤‡çš„å±å¹•è®¡ç®—å›¾åƒåƒç´ ä½ç½®ä»¥åŠåƒç´  alpha é€šé“æ··è‰²è®¡ç®—ç­‰ç­‰æœ€ç»ˆåœ¨å½“å‰ iOS è®¾å¤‡çš„æ˜¾ç¤ºå±ä¸­å‘ˆç°å›¾åƒã€‚ å˜›~ ç”±äº Core Animation Pipeline ä¸­ Render Server åŒ…å« OpenGL ES &amp; Core Graphicsï¼Œå…¶ä¸­ OpenGL ES çš„æ¸²æŸ“å¯ä»¥å‚è€ƒä¸Šæ–‡ OpenGL Render Pipeline ç†è§£ã€‚ Commit TransactionCore Animation Pipeline çš„æ•´ä¸ªç®¡çº¿ä¸­ iOS å¸¸è§„å¼€å‘ä¸€èˆ¬å¯ä»¥å½±å“åˆ°çš„èŒƒå›´ä¹Ÿå°±ä»…ä»…æ˜¯åœ¨ Application ä¸­å¸ƒå±€ UIKit è§†å›¾æ§ä»¶é—´æ¥çš„å…³è” Core Animation å›¾å±‚è¿™ä¸€çº§ï¼Œå³ Commit Transaction ä¹‹å‰çš„ä¸€äº›æ“ä½œã€‚ é‚£ä¹ˆåœ¨ Commit Transaction ä¹‹å‰æˆ‘ä»¬ä¸€èˆ¬è¦åšçš„äº‹æƒ…æœ‰å“ªäº›ï¼Ÿ Layoutï¼Œæ„å»ºè§†å›¾ Displayï¼Œç»˜åˆ¶è§†å›¾ Prepareï¼Œé¢å¤–çš„ Core Animation å·¥ä½œ Commitï¼Œæ‰“åŒ…å›¾å±‚å¹¶å°†å®ƒä»¬å‘é€åˆ° Render Server Layoutåœ¨ Layout é˜¶æ®µæˆ‘ä»¬èƒ½åšçš„æ˜¯æŠŠ constraint å†™çš„å°½é‡é«˜æ•ˆï¼ŒiOS çš„ Layout Constraint ç±»ä¼¼äº Android çš„ Relative Layoutã€‚ Note: Emmmmmâ€¦ æ®è§‚å¯Ÿ iOS çš„ Layout Constraint åœ¨ä¹¦å†™æ—¶åº”è¯¥å°½é‡å°‘çš„ä¾èµ–äºè§†å›¾æ ‘ä¸­åŒå±‚çº§çš„å…„å¼Ÿè§†å›¾èŠ‚ç‚¹ï¼Œå®ƒä¼šæ‹–æ…¢æ•´ä¸ªè§†å›¾æ ‘çš„ Layout è®¡ç®—è¿‡ç¨‹ã€‚ è¿™ä¸ªé˜¶æ®µçš„ Layout è®¡ç®—å·¥ä½œæ˜¯åœ¨ CPU å®Œæˆçš„ï¼ŒåŒ…æ‹¬ layoutSubviews æ–¹æ³•çš„é‡è½½ï¼ŒaddSubview: æ–¹æ³•å¡«å……å­è§†å›¾ç­‰ Displayå…¶å®è¿™é‡Œçš„ Display ä»…ä»…æ˜¯æˆ‘ä»¬è®¾ç½® iOS è®¾å¤‡è¦æœ€ç»ˆæˆåƒçš„å›¾å…ƒæ•°æ®è€Œå·²ï¼Œé‡è½½è§†å›¾ drawRect: æ–¹æ³•å¯ä»¥è‡ªå®šä¹‰ UIView çš„æ˜¾ç¤ºï¼Œå…¶åŸç†æ˜¯åœ¨ drawRect: æ–¹æ³•å†…éƒ¨ç»˜åˆ¶ bitmapã€‚ Note: é‡è½½ drawRect: æ–¹æ³•ç»˜åˆ¶ bitmap è¿‡ç¨‹ä½¿ç”¨ CPU å’Œ å†…å­˜ã€‚ æ‰€ä»¥é‡è½½ drawRect: ä½¿ç”¨ä¸å½“ä¼šé€ æˆ CPU è´Ÿè½½è¿‡é‡ï¼ŒApp å†…å­˜é£™å‡ç­‰é—®é¢˜ã€‚ Prepareè¿™ä¸ªæ­¥éª¤å±äºé™„åŠ æ­¥éª¤ï¼Œä¸€èˆ¬å¤„ç†å›¾åƒçš„è§£ç  &amp; è½¬æ¢ç­‰æ“ä½œã€‚ CommitCommit æ­¥éª¤æŒ‡æ‰“åŒ…å›¾å±‚å¹¶å°†å®ƒä»¬å‘é€åˆ° Render Serverã€‚ Note: Commit æ“ä½œä¼šé€’å½’æ‰§è¡Œï¼Œç”±äºå›¾å±‚å’Œè§†å›¾ä¸€æ ·æ˜¯ä»¥æ ‘å½¢ç»“æ„å­˜åœ¨çš„ï¼Œå½“å›¾å±‚æ ‘è¿‡äºå¤æ‚æ—¶ Commit æ“ä½œçš„å¼€é”€ä¹Ÿä¼šéå¸¸å¤§ã€‚ CATransactionCATransaction æ˜¯ Core Animation ä¸­ç”¨äºå°†å¤šä¸ªå›¾å±‚æ ‘æ“ä½œåˆ†é…åˆ°æ¸²æŸ“æ ‘çš„åŸå­æ›´æ–°ä¸­çš„æœºåˆ¶ï¼Œå¯¹å›¾å±‚æ ‘çš„æ¯ä¸ªä¿®æ”¹éƒ½å¿…é¡»æ˜¯äº‹åŠ¡çš„ä¸€éƒ¨åˆ†ã€‚ CATransaction ç±»æ²¡æœ‰å±æ€§æˆ–è€…å®ä¾‹æ–¹æ³•ï¼Œå¹¶ä¸”ä¹Ÿä¸èƒ½ç”¨ +alloc å’Œ -init æ–¹æ³•åˆ›å»ºå®ƒï¼Œæˆ‘ä»¬åªèƒ½ç”¨ç±»æ–¹æ³• +begin å’Œ +commit åˆ†åˆ«æ¥å…¥æ ˆæˆ–è€…å‡ºæ ˆã€‚ äº‹å®ä¸Šä»»ä½•å¯åŠ¨ç”»åŒ–çš„å›¾å±‚å±æ€§éƒ½ä¼šè¢«æ·»åŠ åˆ°æ ˆé¡¶çš„äº‹åŠ¡ï¼Œä½ å¯ä»¥é€šè¿‡ +setAnimationDuration: æ–¹æ³•è®¾ç½®å½“å‰äº‹åŠ¡çš„åŠ¨ç”»æ—¶é—´ï¼Œæˆ–è€…é€šè¿‡ +animationDuration æ–¹æ³•æ¥è·å–æ—¶é•¿å€¼ï¼ˆé»˜è®¤ 0.25 ç§’ï¼‰ã€‚ Core Animation åœ¨æ¯ä¸ª RunLoop å‘¨æœŸä¸­è‡ªåŠ¨å¼€å§‹ä¸€æ¬¡æ–°çš„äº‹åŠ¡ï¼Œå³ä½¿ä½ ä¸æ˜¾å¼åœ°ä½¿ç”¨ [CATransaction begin] å¼€å§‹ä¸€æ¬¡äº‹åŠ¡ï¼Œåœ¨ä¸€ä¸ªç‰¹å®š RunLoop å¾ªç¯ä¸­çš„ä»»ä½•å±æ€§çš„å˜åŒ–éƒ½ä¼šè¢«æ”¶é›†èµ·æ¥ï¼Œç„¶ååšä¸€æ¬¡ 0.25 ç§’çš„åŠ¨ç”»ï¼ˆCALayer éšå¼åŠ¨ç”»ï¼‰ã€‚ Note: CATransaction æ”¯æŒåµŒå¥—ã€‚ Animationå¯¹äº App ç”¨æˆ·äº¤äº’ä½“éªŒæå‡æœ€æ˜æ˜¾çš„å·¥ä½œè«è¿‡äºä½¿ç”¨åŠ¨ç”»äº†ï¼Œé‚£ä¹ˆ iOS æ˜¯å¦‚ä½•å¤„ç†åŠ¨ç”»çš„æ¸²æŸ“è¿‡ç¨‹çš„å‘¢ï¼Ÿ æ—¥å¸¸å¼€å‘ä¸­å¦‚æœä¸æ˜¯ç‰¹åˆ«å¤æ‚çš„åŠ¨ç”»æˆ‘ä»¬ä¸€èˆ¬ä¼šä½¿ç”¨ UIView Animation å®ç°ï¼ŒiOS å°† UIView Animation çš„å¤„ç†è¿‡ç¨‹åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µï¼š è°ƒç”¨ animateWithDuration:animations: æ–¹æ³• åœ¨ Animation Block ä¸­è¿›è¡Œ Layoutï¼ŒDisplayï¼ŒPrepareï¼ŒCommit Render Server æ ¹æ® Animation é€å¸§æ¸²æŸ“ Note: åŸç†æ˜¯ animateWithDuration:animations: å†…éƒ¨ä½¿ç”¨äº† CATransaction æ¥å°†æ•´ä¸ª Animation Block ä¸­çš„ä»£ç ä½œä¸ºåŸå­æ“ä½œ commit ç»™äº† RunLoopã€‚ åŸºäº CATransaction å®ç°é“¾å¼åŠ¨ç”»äº‹å®ä¸Šå¤§å¤šæ•°çš„åŠ¨ç”»äº¤äº’éƒ½æ˜¯æœ‰åŠ¨ç”»æ‰§è¡Œé¡ºåºçš„ï¼Œå°½ç®¡ UIView Animation å¾ˆå¼ºå¤§ï¼Œä½†æ˜¯åœ¨å†™ä¸€äº›é¡ºåºåŠ¨ç”»æ—¶ä½¿ç”¨ UIView Animation åªèƒ½åœ¨ + (void)animateWithDuration:delay:options:animations:completion: æ–¹æ³•çš„ completion block ä¸­å±‚çº§åµŒå¥—ï¼Œå†™æˆä¸€å¨ä¸€å¨ block å †ç Œè€Œæˆçš„ä»£ç ï¼Œå®åœ¨æ˜¯éš¾ä»¥é˜…è¯»æ›´åˆ«æåæœŸç»´æŠ¤äº†ã€‚ åœ¨å¾—çŸ¥ UIView Animation ä½¿ç”¨äº† CATransaction æ—¶ï¼Œæˆ‘ä»¬ä¸ç¦ä¼šæƒ³åˆ°è¿™ä¸ª completion block æ˜¯ä¸æ˜¯ä¹Ÿæ˜¯åŸºäº CATransaction å®ç°çš„å‘¢ï¼Ÿ Bingoï¼CATransaction ä¸­æœ‰ +completionBlock ä»¥åŠ +setCompletionBlock: æ–¹æ³•å¯ä»¥å¯¹åº”äº UIView Animation çš„ completion block çš„ä¹¦å†™ã€‚ Note: æˆ‘çš„ä¸€ä¸ªå¼€æºåº“ LSAnimator - å¯å¤šé“¾å¼åŠ¨ç”»åº“ åœ¨åŠ¨ç”»é¡ºåºé“¾æ¥æ—¶ä¹Ÿç”¨åˆ°äº† CATransactionã€‚ å…¨æ–‡æ€»ç»“ç»“åˆä¸Šä¸‹æ–‡ä¸éš¾æ¢³ç†å‡ºä¸€ä¸ª iOS æœ€åŸºæœ¬çš„å®Œæ•´æ¸²æŸ“ç»è¿‡ï¼ˆRendering passï¼‰ã€‚ æ€§èƒ½æ£€æµ‹æ€è·¯åŸºäºæ•´ç¯‡æ–‡ç« çš„å†…å®¹å½’çº³ä¸€ä¸‹æˆ‘ä»¬åœ¨æ—¥å¸¸çš„å¼€å‘å·¥ä½œä¸­é‡åˆ°æ€§èƒ½é—®é¢˜æ—¶æ£€æµ‹é—®é¢˜ä»£ç çš„æ€è·¯ï¼š é—®é¢˜ å»ºè®® æ£€æµ‹å·¥å…· ç›®æ ‡å¸§ç‡ 60 FPS Core Animation instrument CPU or GPU é™ä½ä½¿ç”¨ç‡èŠ‚çº¦èƒ½è€— Time Profiler instrument ä¸å¿…è¦çš„ CPU æ¸²æŸ“ GPU æ¸²æŸ“æ›´ç†æƒ³ï¼Œä½†è¦æ¸…æ¥š CPU æ¸²æŸ“åœ¨ä½•æ—¶æœ‰æ„ä¹‰ Time Profiler instrument è¿‡å¤šçš„ offscreen passes è¶Šå°‘è¶Šå¥½ Core Animation instrument è¿‡å¤šçš„ blending è¶Šå°‘è¶Šå¥½ Core Animation instrument å¥‡æ€ªçš„å›¾ç‰‡æ ¼å¼æˆ–å¤§å° é¿å…å®æ—¶è½¬æ¢æˆ–è°ƒæ•´å¤§å° Core Animation instrument å¼€é”€æ˜‚è´µçš„è§†å›¾æˆ–ç‰¹æ•ˆ ç†è§£å½“å‰æ–¹æ¡ˆçš„å¼€é”€æˆæœ¬ Xcode View Debugger æƒ³è±¡ä¸åˆ°çš„å±‚æ¬¡ç»“æ„ äº†è§£å®é™…çš„è§†å›¾å±‚æ¬¡ç»“æ„ Xcode View Debugger æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜ https://lision.me/ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ä¸ªäººåšå®¢ä¸­æ›´æ–°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš @Lision è”ç³»æˆ‘~ å¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~ æ‰©å±•é˜…è¯» WWDC2014-Advanced Graphics and Animations for iOS Apps iOS ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§"},{"title":"HHKB å¼€ç®±ç•™å¿µ","comments":true,"permalink":"https://lision.me/hhkb-bt/","text":"å‰è¨€Emmmmmâ€¦ è¿™ä¸ªæ¸…æ˜èŠ‚æœ¬æ¥æ‰“ç®—å»é’æµ·æ¹–éª‘è¡Œçš„ï¼Œä¸è¿‡å› ä¸ºåŒ—äº¬ 4 æœˆé£é›ªçš„å¤©æ°”éª¤å˜åŠ ä¸Šè‡ªå·±æ²¡æ³¨æ„æ·»è¡£â€¦ æœ€ç»ˆè¿˜æ˜¯æ²¡èƒ½å‡ºäº†å¸éƒ½ â•®(â•¯â–½â•°)â•­ ä¸è¿‡è¿™ä¹Ÿçœä¸‹äº†ä¸€äº›å¼€é”€~ äºæ˜¯ç”¨æœ¬æ¥å‡†å¤‡å‡ºå»è¸é’çš„ ğŸ’° å…¥äº†ä¸€æŠŠå‚æ¶å·²ä¹…çš„é”®ç›˜ï¼Œä¹Ÿå°±æ˜¯æœ¬æ–‡çš„ä¸»è§’ â€”â€” HHKB é…±ï¼ å˜›~ çŸ¥é“ HHKB æ˜¯åœ¨ 2015 å¹´ï¼Œè®°å¾—è¿˜æ˜¯åœ¨æŸä¹çš„ä¸€ç¯‡å›ç­”ä¸­çœ‹åˆ°çš„ï¼Œç­”ä¸»æ˜¯ä¸€ä¸ªå¦¹å­ï¼Œå¤§æ„æ˜¯è¿™ä¸ªå¦¹å­å·å·çœ‹åˆ°äº†ç¨‹åºçŒ¿ç”·ç¥¨çš„è´­ç‰©è½¦ä¸­èººç€ä¸€æŠŠ HHKBï¼Œç„¶åè¿™ä¸ªå¯¹é”®ç›˜ä¸€çªä¸é€šçš„å¦¹å­å†å°½æ³¢æŠ˜å°† HHKB å…¥æ‰‹é€ç»™è‡ªå·±ç¨‹åºçŒ¿ç”·ç¥¨çš„æš–å¿ƒå°æ•…äº‹ã€‚ å½“æ—¶çš„æˆ‘åˆšåˆšæ¯•ä¸šä¸€å¹´å·¦å³å§ï¼Œä¹Ÿæ˜¯æ­£æƒ³ä¹°ä¸€æŠŠé”®ç›˜æ¥æ•²ä»£ç ï¼Œæå‡è‡ªå·±çš„è¾“å‡ºï¼ˆäº‹å®è¯æ˜ï¼Œå¹¶æ²¡æœ‰å¤ªå¤§å¸®åŠ© ^_^||ï¼‰ï¼Œè§è¯è‡ªå·±çš„æˆé•¿ï¼ˆè¿™ä¸ªæ‰“æ²¹çš„é”®å¸½ä»¬å¯ä»¥è¯æ˜å“Ÿï¼‰ã€‚äºæ˜¯å°±æœåˆ°äº†è¿™ç¯‡å›ç­”ï¼Œçœ‹å¾—æˆ‘å¿ƒé‡Œä¸€æš–ï¼Œæ— æ¯”ç¾¡æ…•ç­”ä¸»ç”·ç¥¨çš„åŒæ—¶è‡ªå·±é»˜é»˜çš„ç»§ç»­æµè§ˆå…¶ä»–å…³äºé”®ç›˜çš„ä¸œè¥¿â€¦ æœ€ååœ¨ Filco å’Œ HHKB ä¹‹é—´çº ç»“æŒ£æ‰äº†è®¸ä¹…ï¼Œé€‰æ‹©äº† Filco 87 é’è½´å¥¶ç»¿é…è‰²ï¼Œä¸è¿‡æƒ³å…¥ä¸€æŠŠ HHKB çš„ç§å­å´åŸ‹åœ¨äº†å¿ƒé‡Œâ€¦ æœ‰äº†å¤§ F çš„é™ªä¼´ï¼ŒHHKB çš„è‰¹é•¿å¾—ä¾æ—§å¾ˆå¿«ï¼Œæ¯æ¬¡åœ¨ä½¿ç”¨ ctrl maping command é”®æ—¶å¿ƒé‡Œçš„è‰¹éƒ½ä¼šæ‹”é«˜ä¸€æˆªï¼Œå°¤å…¶æ˜¯æœ€è¿‘å·²ç»åˆ°äº†ä¸èƒ½ä¸æ‹”çš„åœ°æ­¥â€¦ æ‰€ä»¥è¶ç€è¿™æ¬¡æœºä¼šï¼Œæœæ–­å…¥æ‰‹ï¼Œå†™ç¯‡æ–‡ç« è®°å½•ä¸€ä¸‹è‡ªå·±çš„å¼€ç®±æ„Ÿå—ï¼Œè¯´ä¸å®šå¯¹æŸäº›åŒå­¦æœ‰å¸®åŠ©å‘¢~ Note: å‰æ’æç¤ºï¼Œå¤šå›¾é¢„è­¦ï¼ ç´¢å¼• HHKB å…¥æ‰‹æ¸ é“ å¼€ç®±ç…§ æ‰‹æ„Ÿä½“éªŒ é”®å¸½ æ€»ç»“ HHKBHHKB å…¨ç§° Happy Hacking Keyboardï¼Œäº 1996 å¹´ 12 æœˆ 20 æ—¥è¯ç”Ÿäºæ—¥æœ¬ï¼Œç³» å¯Œå£«é€š æ——ä¸‹å­å…¬å¸ PFU ç”Ÿäº§çš„ç´§å‡‘å‹é”®ç›˜ï¼Œä»¥é€¼æ ¼ç”šé«˜çš„é”®ç›˜é…åˆ—ã€ä¼˜ç§€æµç•…çš„æ•²å‡»æ‰‹æ„Ÿã€é«˜æ˜‚çš„å”®ä»·ä¸ºå¤–è®¾å‘çƒ§å‹å’Œç å†œä»¬æ‰€ç†ŸçŸ¥ï¼Œäº¦ä»¥è¢« Hackers é’Ÿçˆ±è€Œé—»åã€‚ å…³äº HHKB çš„è¯„æµ‹è´´å¾ˆå¤šï¼Œè¿™é‡ŒåªæŒ‘ä¸€äº›æˆ‘è®¤ä¸ºå€¼å¾—èŠå¾—ç‚¹æ¥å†™ï¼š HHKB çš„é”®ç›˜é…åˆ—ä¸ºä½•å¦‚æ­¤è®¾è®¡ï¼Ÿ ä»€ä¹ˆæ˜¯é™ç”µå®¹è½´ï¼Ÿ è°æ§çº¢äº† HHKBï¼Ÿ æ ‡å¿—æ€§é…åˆ—HHKB æ˜¯ç”±æ—¥æœ¬ Hacker å’Œç”°è‹±ä¸€ å’Œ PFU ç ”ç©¶æ‰€å…±åŒè®¾è®¡ï¼Œä»åå­—å°±å¯ä»¥çœ‹å‡ºæ­¤ç³»åˆ—é”®ç›˜çš„ç”¨æˆ·å®šä½æ˜¯ Hackerï¼Œè¿™å—é”®ç›˜çš„é…åˆ—ä»ç¬¬ä¸€ä»£è®¾è®¡è‡³ä»Šæœªå˜ï¼Œå¯ä»¥è¯´æ˜¯ HHKB çš„æ ‡å¿—æ€§é…åˆ—ã€‚ é”®ç›˜é 67 é”®çš„æ™®é€šä¸»é”®åŒºå°é”®ç›˜ä¼ ç»Ÿé…åˆ—ï¼Œä¸ºäº† Hackers å¯ä»¥æ›´å¥½çš„åœ¨ Emacs å’Œ Vim ä¸‹ä½¿ç”¨ï¼Œé”®ç›˜å°†é«˜é¢‘é”®ä½ â€”â€” Ctrl ä¸Šç§»è‡³ Cap å¤„ï¼Œç„¶åç æ‰äº† Capâ€¦ å¹¶é»˜è®¤æŠŠ Esc é”®ä¸‹æ²‰è‡³ä½é¢‘é”®ä½ ~ å¤„ï¼ŒåŒæ—¶è¿˜æŠŠ Del é”®ä¸‹æ²‰è‡³ | é”®å¤„ï¼Œç”šè‡³ç æ‰äº† 67 é”®é…åˆ—ä¸­å¤§å¤šæ•°äººè®¤ä¸ºé«˜é¢‘ä½¿ç”¨çš„æ–¹å‘é”®ï¼ é™ç”µå®¹è½´HHKB æ—¢ä¸æ˜¯å¤§å¤šæ•°äººç”¨çš„é‡äº§è–„è†œé”®ç›˜ï¼Œä¹Ÿä¸æ˜¯è¿‘äº›å¹´æ¥é€æ¸ç«çƒ­çš„æœºæ¢°é”®ç›˜ï¼Œè€Œæ˜¯é‡‡ç”¨äº† Topre æ— æ¥è§¦å¼ç”µå®¹å¼€å…³è®¾è®¡ã€‚ æ™®é€šè–„è†œé”®ç›˜çš„è§¦å‘å¼€å…³æ˜¯åœ¨æ©¡èƒ¶ä¸‹é»ä¸€å—å¯¼ç”µè–„è†œï¼Œé€šè¿‡è¿™ä¸ªå¯¼ç”µè–„è†œè§¦å‘æŒ‰é”®å¼€å…³ã€‚ æœºæ¢°é”®ç›˜åœ¨æœºæ¢°è½´ä½“å†…éƒ¨åŠ å…¥é“œç‰‡ï¼ŒæŒ‰é”®æ—¶é€šè¿‡æœºæ¢°è½´ä½“è½´å¿ƒæŒ¤å‹é“œç‰‡è§¦å‘æŒ‰é”®å¼€å…³ã€‚ é™ç”µå®¹é”®ç›˜é€šè¿‡ç¢—çŠ¶æ©¡èƒ¶è§¦å‘å¼€å…³ï¼Œè§¦å‘åŸç†æ˜¯åœ¨æŒ‰é”®è¿‡ç¨‹ä¸­ç”µæé—´è·æ”¹å˜äº§ç”Ÿç”µå®¹å€¼å˜åŒ–ï¼Œè¿›è€Œè§¦å‘é”®ç›˜è®¯å·ã€‚ Note: å¾ˆå¤šåŒå­¦å¯¹æœºæ¢°é”®ç›˜æœ‰è¯¯è§£ï¼Œå…¶å®æœºæ¢°é”®ç›˜è½´ä½“å†…éƒ¨ä¹Ÿæ˜¯æœ‰å¼¹ç°§çš„ï¼Œè½´ä½“å›å¼¹ä¹Ÿæ˜¯ä¾é è¿™ä¸ªå¼¹ç°§å®ç°ã€‚ é’Ÿçˆ± HHKB çš„å¤§ç¥ Richard Stallmanï¼ŒGUN Emacs &amp; GCC å¤§ä½¬ã€‚ Bjarne Stroustrupï¼ŒCè‰¹ ä¹‹çˆ¶ã€‚ å…¥æ‰‹æ¸ é“æˆ‘å…¥æ‰‹çš„æ˜¯ HHKB Professional BT (Bluetooth) ç‰ˆæœ¬ï¼Œä¸»è¦æ˜¯çœ‹ä¸­äº†æ— çº¿çš„ä¼˜åŠ¿ï¼Œæ¯•ç«Ÿå¯¹äº Mac æ¥è¯´ï¼Œä¸€ä¸ªé”®ç›˜å ç”¨ä¸€ä¸ª USB æ¥å£å¤ªè¿‡å¥¢ä¾ˆäº†â€¦ æˆªæ­¢è‡³ä¸‹å•æ—¶ï¼Œæ—¥äºšçš„å”®ä»·æ˜¯ 29700 æ—¥å…ƒï¼Œçº¦åˆäººæ°‘å¸ 1750 å…ƒã€‚ æŸçŒ«æœ‰ä¸€å®¶è®¤è¯è¿‡çš„ HHKB å®˜æ–¹æ——èˆ°åº—ï¼Œå”®ä»· 2388 å…ƒäººæ°‘å¸ï¼Œåº—é“ºé™æ—¶æ´»åŠ¨ -200 å…ƒï¼ŒåŠ ä¸Šæ»¡ 200 å³å‡ 20 çš„æ»¡å‡æ´»åŠ¨ï¼Œæœ€ç»ˆä¸‹å•ä»·ä¸º 2088 å…ƒã€‚ è€ƒè™‘åˆ°è¡Œè´§ä¿ä¿®é—®é¢˜ï¼Œä»¥åŠæµ·æ·˜é‚®å¯„å¯èƒ½å‡ºç°çš„ä¸€äº›çŠ¶å†µæœæ–­é€‰æ‹©äº†å›½è¡Œã€‚ å¼€ç®±ç…§å˜›~ å¿«é€’æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œåº—å®¶åŒ…é¡ºä¸°æ¬¡æ—¥è¾¾ï¼Œé¡ºä¸°çš„æœåŠ¡ä¸€å¦‚æ—¢å¾€çš„è®©äººæ»¡æ„ã€‚ æ¸…æ˜å°é•¿å‡ç¬¬ä¸€å¤©å°±åˆ°äº†ï¼Œå¼€ç®±ç­¾æ”¶ä¹‹åæ´—æ‰‹æ‹ç…§ç•™å¿µï¼ˆç¬‘ï¼‰ã€‚ Note: å†æ¬¡æç¤ºï¼Œå¤šå›¾é¢„è­¦ï¼ å˜›~ åæ§½ä¸€ä¸‹ï¼ŒHHKB Pro BT çš„è¿™ä¸ªç”µæ± ä»“ç•¥ä¸‘ï¼Œå¥½åœ¨å®å®æ•²é”®ç›˜çš„æ—¶å€™çœ‹ä¸åˆ°å®ƒâ€¦ æ‰‹æ„Ÿä½“éªŒä¹°ä¹‹å‰ä½“éªŒäº†åŒäº‹çš„ HHKB Pro Type-S å’Œ HHKB Pro BTï¼Œå¯¹æ¯”å‘ç°æ‰‹æ„Ÿä¸Šå¹¶æ— å¤ªå¤§åå·®ï¼Œä¸è¿‡è™½ç„¶ Type-S ç¼©çŸ­é”®ç¨‹æ²¡æœ‰ç‰¹åˆ«æ˜æ˜¾çš„æ‰‹æ„Ÿä½“éªŒå·®å¼‚ï¼Œä½†æ˜¯é™éŸ³æ˜¯çœŸçš„å·®äº†ä¸€ä¸ªæ¢¯åº¦ã€‚BT ç‰ˆæœ¬çš„å£°éŸ³å¹¶ä¸åµï¼Œä¸ªäººæ„Ÿè§‰åº”è¯¥æ¯” Filco çº¢è½´è¦ç•¥å°ï¼Œå¼€æ”¾å¼åŠå…¬åº”è¯¥é—®é¢˜ä¸å¤§ã€‚ ä¸è¿‡è®²çœŸï¼ŒHHKB çš„æ‰‹æ„Ÿå¹¶æ²¡æœ‰ç½‘ä¸Šä¼ çš„é‚£ä¹ˆç»µè½¯æµç•…ï¼Œè´¨æ„Ÿä¹Ÿå·®äº†æ‰‹è¾¹ Filco é’è½´ä¸€æ®µè·ç¦»ï¼Œä¹Ÿå¯èƒ½æ˜¯æˆ‘é’è½´ç”¨å¤šäº†å§â€¦ å…·ä½“æè¿°çš„è¯ï¼ŒHHKB çš„æ‰‹æ„Ÿç•¥æŸ”å’Œï¼Œæ²¡æœ‰é’è½´æŒ‰ä¸‹æŒ‰é”®è§¦å‘å¼€å…³æ—¶çš„æ¸…è„†å£°ï¼Œæ•´ä½“ç»™æˆ‘çš„æ„Ÿè§‰æœ‰ç‚¹ç¥ä¼¼çº¢è½´ï¼Œä½†æ˜¯åˆä¸åƒçº¢è½´é‚£æ ·ä¸€è§¦åˆ°åº•â€¦ HHKB å’Œ Filco éƒ½æ˜¯ä¿¡ä»°ä¹‹ç‰©ï¼Œä¸Šé¢çš„æ¯”è¾ƒä¹Ÿæ˜¯åœ¨è¾ƒä¸ºè‹›åˆ»çš„ç¨‹åº¦ä¸Šæˆ‘ä¸ªäººä¸»è§‚æ„Ÿå—è€Œå·²ï¼Œæ¯•ç«Ÿè¿™ä¸ªä»·ä½çš„ä¸œè¥¿äº†ï¼Œä½¿ç”¨ä½“éªŒéƒ½ä¼šè®©äººæ„Ÿåˆ°å¾ˆèˆ’æœ~ åœ¨è“ç‰™è¿æ¥çŠ¶æ€ä¸‹æ•²ä»£ç ï¼Œå®Œå…¨æ²¡æœ‰è¯¯æ•²ï¼Œé‡å¤è§¦å‘ä»¥åŠé—æ¼è§¦å‘çš„æƒ…å†µï¼Œä¸ªäººæ„Ÿè§‰è¿˜æ˜¯ååˆ†æ»¡æ„å“ˆ~ é”®å¸½Emmmmmâ€¦ ä¸€å¼€å§‹å¹¶æ²¡æœ‰å…¥ HHKB çš„å®˜æ–¹å½©è‰²é”®å¸½å¥—è£…ï¼Œç†ç”±æ˜¯è´µâ€¦ è€Œä¸”æ€•è‡ªå·±ç”¨ä¸æƒ¯çš„è¯ä¸æ–¹ä¾¿é€€è´§ã€‚ ä¸è¿‡åœ¨è¿ç»­æ•²äº†ä¸¤å¤©é”®ç›˜ä¹‹åï¼Œæ„Ÿè§‰æ‰‹æ„ŸçœŸçš„æ˜¯ç„å­¦å•Š~ æ…¢æ…¢çš„ç«Ÿç„¶æœ‰ç‚¹å–œæ¬¢ HHKB è¿™ç§é™ç”µå®¹è½´çš„æ‰‹æ„Ÿäº†ï¼Œå°½ç®¡ç›®å‰ä»ç„¶è®¤ä¸ºä¸åŠæˆ‘çš„å¤§ F é’è½´ï¼Œä½†æ˜¯å¹¶ä¸æ’æ–¥~ ç»ˆäºåœ¨ç½‘ä¸Šçœ‹äº†å¾ˆå¤šæ­é…äº† HHKB å®˜æ–¹å½©è‰²é”®å¸½çš„æ¯’å›¾ä¹‹åï¼Œä¸‹å•å…¥æ‰‹ï¼ å˜›~ å¤´å›¾å°±æ˜¯æ­é…äº†å½©è‰²é”®å¸½ä¹‹åçš„ HHKB (ï¼¾ï¼µï¼¾)ãƒ~ï¼¹ï¼¯ æ€»ç»“ HHKB é”®ç›˜é…åˆ—ä¸å¤ªé€‚åˆ Windows ç”¨æˆ·ï¼Œä¸è¿‡éå¸¸é€‚åˆ Mac OS X ä¸‹ä½¿ç”¨ï¼Œä¸€ä½†å…»æˆè‚Œè‚‰è®°å¿†å°†ä¼šéå¸¸æ–¹ä¾¿ã€‚ HHKB æ‰‹æ„Ÿåç»µè½¯ï¼Œç»™æˆ‘ä¸ªäººçš„æ„Ÿè§‰è¿˜ç®—æ¯”è¾ƒèˆ’æœï¼Œä½†æ˜¯ä¸åŠå¤§ F é’è½´çš„æ‰‹æ„Ÿã€‚ HHKB Pro BT è“ç‰™è¿æ¥ä½¿ç”¨ä½“éªŒæå¥½ï¼Œæ²¡æœ‰é—æ¼ä»¥åŠé‡å¤è§¦å‘æŒ‰é”®çš„æƒ…å†µå‡ºç°ã€‚ å½©è‰²é”®å¸½çœŸçš„æ˜¯å¯ä»¥ç¬é—´æå‡ HHKB æå…·å†…æ•›çš„é¢œå€¼ã€‚ æœ€åæ”¾ä¸€ä¸‹å·²ç»æœå½¹äº†å°†è¿‘ 3 å¹´çš„å¤§ F å’Œæ–°ä¼™ä¼´çš„åˆå½±ã€‚"},{"title":"å·§ç”¨ Objective-C Class Properties è§£è€¦","comments":true,"permalink":"https://lision.me/oc_class_properties/","text":"å‰è¨€Emmmmmâ€¦ Objective-C Class Properties æ—©åœ¨ WWDC 2016 ä¸­å°±å·²ç»å…¬ç¤ºï¼Œç»™ Objective-C åŠ å…¥è¿™ä¸ªç‰¹æ€§ä¸»è¦æ˜¯ä¸ºäº†ä¸ Swift ç±»å‹å±æ€§ç›¸äº’æ“ä½œã€‚ å®˜æ–¹æ˜¯è¿™ä¹ˆè¯´æ˜çš„ï¼š Interoperate with Swift type properties. å˜›~ è™½ç„¶æ˜¯ä¸ºäº†é…åˆ Swift åŠ å…¥çš„æ–°ç‰¹æ€§ï¼Œä¸è¿‡èŠèƒœäºæ— å“ˆï¼ Note: å€¼å¾—ä¸€æçš„æ˜¯ Objective-C Class Properties è¯­æ³•ç‰¹æ€§è™½ç„¶æ˜¯ WWDC 2016 åŠ å…¥çš„ï¼Œä¸è¿‡ç”±äºæ˜¯ Xcode 8 ä¸­ LLVM Compiler çš„ç‰¹æ€§ï¼Œå› æ­¤ä¹Ÿé€‚ç”¨äº iOS 10 ä¹‹å‰çš„éƒ¨ç½²ç‰ˆæœ¬å“Ÿ~ ç´¢å¼• LLVM Objective-C Class Properties è§£è€¦ æ€»ç»“ LLVM LLVM å®˜ç½‘ å¯¹äº LLVM çš„å®šä¹‰ï¼š Note: The LLVM Project is a collection of modular and reusable compiler and toolchain technologies. Emmmmmâ€¦ æœ‰è¶£çš„æ˜¯ï¼Œæœ‰çš„æ–‡ç« æŠŠ LLVM å¼ºè¡Œå±•å¼€ä¸º â€œlow level virtual machineâ€ è¯‘ä¸º â€œä½çº§åˆ«è™šæ‹Ÿæœºâ€ï¼Œä¸è¿‡åœ¨ LLVM å®˜ç½‘ å¯ä»¥çœ‹åˆ°å®˜æ–¹æ˜ç¤º LLVM ä¸ä¼ ç»Ÿçš„è™šæ‹Ÿæœºæ²¡æœ‰ä¸€æ¯›é’±å…³ç³»ï¼Œåç§° â€œLLVMâ€ æœ¬èº«ä¸æ˜¯ç¼©å†™ï¼Œå®ƒä»…ä»…æ˜¯é¡¹ç›®çš„åç§°è€Œå·²~ å˜›~ å¯èƒ½æœ‰çš„åŒå­¦ä¸èƒ½ç†è§£ä¸ºä½• LLVM æ˜¯ä¸€ä¸ªç¼–è¯‘å™¨å·¥å…·é“¾é›†åˆï¼Ÿè¿™å°±è¦ä» Apple çš„ç¼–è¯‘å™¨å†å²è®²èµ·å’¯~ å¾ˆä¹…å¾ˆä¹…ä»¥å‰â€¦ ç®—äº†ï¼Œæˆ‘æ„Ÿè§‰è¦è·‘é¢˜äº†ï¼ˆå›§ï¼‰ï¼Œè¿™é‡Œç®€å•åˆ—ä¸€ä¸‹ Apple é‡‡ç”¨è¿‡çš„ç¼–è¯‘æ–¹æ¡ˆå§ï¼š GCC LLVM &amp; GCC LLVM Compiler GCCGCC, the GNU Compiler Collection æ˜¯ä¸€å¥—ç”± GNU å¼€å‘çš„ç¼–ç¨‹è¯­è¨€ç¼–è¯‘å™¨ï¼Œæœ€åˆä½œä¸º GNU æ“ä½œç³»ç»Ÿ çš„ç¼–è¯‘å™¨ä½¿ç”¨ï¼Œåé¢å‘å±•æˆä¸ºç±» Unix æ“ä½œç³»ç»Ÿä»¥åŠ Apple Mac OS X æ“ä½œç³»ç»Ÿçš„æ ‡å‡†ç¼–è¯‘å™¨ã€‚ åŸæœ¬ GCC ä»…èƒ½å¤„ç† C è¯­è¨€çš„ç¼–è¯‘ï¼Œä¸è¿‡ GCC å¾ˆå¿«æ‰©å±•ä»¥æ”¯æŒ C++ï¼Œä¹‹åçš„ GCC è¶Šå‘å…¨é¢ï¼Œæ”¯æŒ Objective-Cï¼ŒFortranï¼ŒAdaï¼Œä»¥åŠ Go è¯­è¨€ã€‚ å€¼å¾—ä¸€æçš„æ˜¯ GCC æ˜¯ä¸€å¥—ä»¥ GPL ä»¥åŠ LGPL è®¸å¯è¯é”å‘è¡Œçš„ 100% è‡ªç”±è½¯ä»¶ï¼Œè¿™æ„å‘³ç€ç”¨æˆ·å¯ä»¥è‡ªç”±åœ°è¿è¡Œï¼Œæ‹·è´ï¼Œåˆ†å‘ï¼Œå­¦ä¹ ï¼Œä¿®æ”¹å¹¶æ”¹è¿›è¯¥è½¯ä»¶ã€‚ LLVM &amp; GCCLLVM æˆ‘ä»¬å‰é¢ä»‹ç»è¿‡äº†ï¼Œæ˜¯æ¨¡å—åŒ– &amp; å¯é‡ç”¨æ€§ç¼–è¯‘å™¨ä»¥åŠå·¥å…·é“¾æŠ€æœ¯é›†åˆã€‚ LLVM èƒ½å¤Ÿè¿›è¡Œç¨‹åºè¯­è¨€çš„ ç¼–è¯‘æœŸä¼˜åŒ–ã€é“¾æ¥ä¼˜åŒ–ã€åœ¨çº¿ç¼–è¯‘ä¼˜åŒ–ã€ä»£ç ç”Ÿæˆã€‚ LLVM Compilerå‰é¢ä»‹ç»è¿‡ GCC æ”¯æŒå¾ˆå¤šè¯­è¨€ï¼Œç³»ç»Ÿæ¶æ„åºå¤§è€Œç¬¨é‡ï¼Œè€Œ Apple å¤§é‡ä½¿ç”¨çš„ Objective-C åœ¨ GCC ä¸­é¡ºä½ï¼ˆä¼˜å…ˆçº§ï¼‰è¾ƒä½ã€‚æ­¤å¤–ï¼ŒGCC ä½œä¸ºä¸€ä¸ªçº¯ç²¹çš„ç¼–è¯‘ç³»ç»Ÿï¼Œåœ¨ä¸ IDE é…åˆæ–¹é¢çš„è¡¨ç°ä¹Ÿå¾ˆå·®ã€‚ Soï¼ŒApple å†³å®šä»é›¶å¼€å§‹å†™ Cï¼ŒC++ï¼ŒObjective-C çš„ç¼–è¯‘å™¨ Clangã€‚ è‡³æ­¤ï¼ŒApple å½»åº•ä¸ GCC äº†æ–­ã€‚ Objective-C Class Properties Objective-C Class Properties ä½œä¸º Objective-C æ–°è¯­æ³•ç‰¹æ€§åœ¨ WWDC2016 Whatâ€™s New in LLVM ä¸­å…¬ç¤ºï¼Œè¡¨ç¤º Xcode 8 ä¹‹åå¯ä»¥ä½¿ç”¨è¿™ä¸€æ–°è¯­æ³•ç‰¹æ€§ã€‚ ä½¿ç”¨æ–¹å¼å¾ˆç®€å•ï¼š Declared with class flag Accessed with dot syntax Never synthesized Use @dynamic to defer to runtime Declared with class flag123@interface MyType : NSObject@property (class) NSString *someString;@end Accessed with dot syntax1NSLog(@&quot;format string: %@&quot;, MyType.someString); Never synthesized12345@implementation MyTypestatic NSString *_someString = nil;+ (NSString *)someString &#123; return _someString; &#125;+ (void)setSomeString:(NSString *)newString &#123; _someString = newString; &#125;@end Use @dynamic to defer to runtime123456@implementation MyType@dynamic (class) someString;+ (BOOL)resolveClassMethod:(SEL) name &#123;...&#125;@end è§£è€¦ç¬”è€…åœ¨åšé¡¹ç›®ç»„ä»¶ä¸‹æ²‰æ—¶ï¼Œé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæ­£å¥½é€‚ç”¨äº Objective-C Class Properties å‘æŒ¥ï¼šå°†è¦ä¸‹æ²‰çš„ç»„ä»¶åº“ä¸­æŸç³»ç»Ÿç±» Categroy å¼•ç”¨äº†ä¸šåŠ¡å±‚æŸæ–¹æ³•ã€‚ ä¸šåŠ¡å±‚åº”è¯¥ä¾èµ–äºå°†è¦ä¸‹æ²‰çš„ç»„ä»¶ï¼Œè€Œç»„ä»¶æ—¢ç„¶è¦ä¸‹æ²‰å°±ä¸åº”è¯¥å†åè¿‡æ¥ä¾èµ–ä¸Šå±‚ä¸šåŠ¡å®ç°ï¼ æŒ‰ç…§å¸¸è§„æ€è·¯ï¼Œæƒ³è¦æŠŠä¸Šå±‚ä¸šåŠ¡ä¸­è¢«ä¾èµ–çš„éƒ¨åˆ†ä¸€èµ·éšç»„ä»¶ä¸‹æ²‰ï¼Œä½†æ˜¯å‘ç°è¢«ä¾èµ–çš„éƒ¨åˆ†è™½ç„¶ä¹Ÿå±äºä¸€ä¸ªè¾ƒä¸ºåŸºç¡€çš„æ¨¡å—ï¼Œä¸è¿‡æ­¤æ¨¡å—ç°é˜¶æ®µä¸åšä¸‹æ²‰â€¦ åæ¥ç»è¿‡ç»„å†…å¤§ä½¬æŒ‡ç‚¹ï¼Œä½¿ç”¨ Objective-C Class Properties è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå³å°†ä¸Šå±‚ä¸šåŠ¡è¢«ä¾èµ–çš„éƒ¨åˆ†åŒ–ä½œå°†è¦ä¸‹æ²‰ç»„ä»¶ä¾èµ–æ–¹ç³»ç»Ÿç±» Categroy çš„ Class Propertiesã€‚ Note: åœ¨ Categroy ä¸­å†™ Objective-C Class Properties éœ€è¦ä½¿ç”¨ Runtime å…³è”æ–¹æ³•ã€‚ æ€»ç»“ ä»‹ç»äº† LLVM é¡ºä¾¿æåˆ°äº† Apple çš„ç¼–è¯‘ç³»ç»Ÿå‘å±•ç®€å²ã€‚ ä½¿ç”¨å®˜æ–¹ Demo ç®€å•ä»‹ç»äº† Objective-C Class Properties è¯­æ³•ç‰¹æ€§çš„ä¹¦å†™æ–¹å¼ã€‚ æä¾›äº†ä¸€ç§å·§å¦™ä½¿ç”¨ Objective-C Class Properties è§£è€¦çš„æ€è·¯ã€‚ æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜ https://lision.me/ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ ä¸ªäººåšå®¢ ä¸­æ›´æ–°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš @Lision è”ç³»æˆ‘~ å¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~"},{"title":"å˜›~ åˆä¸€å¹´äº†å•Š...","comments":true,"permalink":"https://lision.me/2017_2018/","text":"å‰è¨€Emmmmmâ€¦ ä¸çŸ¥ä¸è§‰å·²ç»ä¸€ä¸ªå¤šæœˆæ²¡æœ‰æç¬”å†™æ–‡ç« äº†ã€‚ å¹´å‰çš„ä¸€æ®µæ—¶é—´ç¡®å®æ¯”è¾ƒå¿™ï¼Œä¸€æ–¹é¢æƒ³è¦å°½å¯èƒ½çš„ç«™å¥½æœ€åä¸€ç­å²—ï¼ŒæŠŠå…¬å¸äº¤ç»™è‡ªå·±çš„äº‹æƒ…åšå¥½ï¼›å¦ä¸€æ–¹é¢ä¹Ÿåœ¨å¯»æ‰¾æ–°çš„æœºä¼šï¼Œå¹¸è¿çš„æ˜¯åœ¨è¿™ä¸€è¿‡ç¨‹ä¸­å¾—åˆ°äº†å¾ˆå¤šç‰›äººçš„èµè¯†å’Œè®¤å¯ï¼Œè·å¾—äº†ä¸€äº›å¸®åŠ©ä»¥åŠå†…æ¨æœºä¼šï¼ŒçœŸçš„å¾ˆæ„Ÿæ©ã€‚ è¿™æ¬¡çœ‹æœºä¼šéƒ½æ˜¯åœ¨æ¯”è¾ƒçŸ¥åçš„é¡¹ç›®æˆ–å¤§å‚ä¸­å¯»æ‰¾çš„ï¼Œå‰å‰ååå¿™ç¢Œäº†ä¸€ä¸ªå¤šæœˆçš„æ—¶é—´ï¼Œåˆ†åˆ«é¢è¯•äº†å¤´æ¡ï¼ŒçŸ¥ä¹ï¼Œç¾å›¢Â·ç‚¹è¯„ï¼Œæ–°æµªï¼Œé˜¿é‡Œå·´å·´è¿™ 5 å®¶å…¬å¸ã€‚ æ¯”è¾ƒé—æ†¾çš„æ˜¯ç”±äºé¢è¯•å¤´æ¡çš„æ—¶é—´ç‚¹åœ¨ 1 æœˆ åˆï¼Œæ¸…æ¥šè®°å¾—å…ƒæ—¦æ—¶æœŸè‡ªå·±çš„ä¸‰å¤©å‡æœŸåŸºæœ¬éƒ½æŠ•å…¥åˆ°äº†ä¸ªäººå¼€æºé¡¹ç›® LSAnimator çš„è¿­ä»£ä¸­ï¼Œå‡†å¤‡ä¸å……åˆ†åŠ ä¸Šè¾ƒé•¿æ—¶é—´æ²¡æœ‰å‚åŠ è¿‡æ­£å¼é¢è¯•å¯¼è‡´æœ€åæ²¡èƒ½é€šè¿‡ï¼Œè¾œè´Ÿäº†å½¬å“¥çš„å†…æ¨ï¼ˆå›§ï¼‰ã€‚ å€¼å¾—åº†å¹¸çš„æ˜¯åé¢å‡ å®¶å…¬å¸éƒ½å¦‚æ„¿æ‹¿åˆ°äº† offerï¼Œå°¤å…¶åœ¨æ‹¿åˆ°é˜¿é‡Œå·´å·´å£å¤´ offer ä¹‹åçš„æ¬£å–œè‹¥ç‹‚ä»¿ä½›å°±åœ¨æ˜¨å¤©ï¼ˆç¬‘ï¼‰ï¼Œä¸è¿‡ç”±äºä¸ªäººåŸå› æ²¡èƒ½åŠ å…¥é˜¿é‡Œå·´å·´ï¼Œæœ€åé€‰æ‹©äº†ç¾å›¢Â·ç‚¹è¯„æ ¸å¿ƒéƒ¨é—¨çš„ offerã€‚ æœ¬æ¥æƒ³è¶ç€æ˜¥æ‹›ä¹‹é™…æŠŠè‡ªå·±å¹´å‰çš„é¢è¯•ç»å†æ€»ç»“ä¸€ä¸‹ï¼Œå†™ä¸€ç¯‡é¢è¯•æ”»ç•¥ã€‚è½¬å¿µä¸€æƒ³è‡ªå·±çš„åšå®¢é‡Œé¢è¿˜æ˜¯åº”è¯¥è®°å½•ä¸€äº›è‡ªå·±çš„æƒ³æ³•ï¼Œäºæ˜¯æ‰æœ‰è¿™ä¸€ç¯‡æ°´æ–‡å‡ºæ¥ï¼ˆç¬‘ï¼‰ã€‚ å˜›~ æ—¢ç„¶æ˜¯æ°´æ–‡ï¼Œå°±ä¸ä¼šæœ‰ä»€ä¹ˆå¹²è´§åœ¨åé¢ç²—çº¿äº†ã€‚æƒ³äº†è§£ä¸Šè¿°å…¬å¸é¢è¯•æµç¨‹ä»¥åŠé¢è¯•é¢˜çš„åŒå­¦å¯ä»¥å°±æ­¤æ‰“ä½ï¼Œä¸ç”¨å†å¾€ä¸‹çœ‹äº†ï¼Œä»¥å…æµªè´¹æ—¶é—´å“Ÿ~ ç´¢å¼• è¿å¾™ ELSEWHERE æœªæ¥ è¿å¾™å›é¡¾ 2017 å¹´çš„å¤§äº‹ï¼Œåº”è¯¥å°±æ˜¯ä»æ·±åœ³è¿å¾™åˆ°åŒ—äº¬äº†å§â€¦ ä» 14 å¹´æ¯•ä¸šä¹‹åå°±å»äº†æ·±åœ³ï¼Œè¿™ä¸€å¾…å°±æ˜¯ 3 å¹´ï¼Œä¸çŸ¥ä¸è§‰å·²ç»å¯¹é‚£åº§å¹´è½»çš„åŸå¸‚æœ‰äº†ä¸€äº›æ„Ÿæƒ…ï¼Œä¸€ä¸‹å­å›åˆ°åŒ—æ–¹ç«Ÿè¿˜æœ‰äº›èˆä¸å¾—ã€‚ è¿˜è®°å¾—åˆšæ¯•ä¸šçš„é‚£æ®µæ—¥å­ï¼Œä½åœ¨å…¬å¸æä¾›çš„åº”å±Šç”Ÿå®¿èˆé‡Œï¼Œä¸å…¶ä»–å°ä¼™ä¼´åƒåœ¨ä¸€èµ·ï¼Œä½åœ¨ä¸€èµ·ã€‚éšåä»å…¬å¸å®¿èˆæ¬å‡ºæ¥ï¼Œæ‹¿ç€ä»…å¤Ÿç»´æŒåœ¨æ·±åœ³ç”Ÿæ´»çš„å·¥èµ„ï¼Œè¿‡ç€ç´§å¼ è€Œè¿·èŒ«çš„æ—¥å­ã€‚æ‹¿å‡ºè‡ªå·±ä¸€å¹´å¤šæ”’ä¸‹çš„é’±ä¹°äº†äººç”Ÿä¸­ç¬¬ä¸€å° Mac å’Œ iPhoneï¼Œå¼€å§‹è‡ªå­¦ iOS å¼€å‘å¹¶ä¸”ç¬¬ä¸€æ¬¡è·³æ§½ã€‚ åé¢åˆç»å†äº†è®¸è®¸å¤šå¤šçš„ç¬¬ä¸€æ¬¡ï¼Œä¹ŸåŒ…æ‹¬è¿™æ¬¡è¿å¾™ã€‚ å˜›~ æ¯•ç«Ÿæ˜¯åŒ—æ–¹é•¿å¤§çš„å­©å­ï¼Œåˆæ¥åŒ—äº¬çš„æ„Ÿè§‰å°±æ˜¯äº²åˆ‡ï¼Œè¿™é‡Œçš„å»ºç­‘ï¼Œæ¤ç‰©ï¼Œå°åƒâ€¦ ä¸€åˆ‡çš„ä¸€åˆ‡éƒ½æœ‰ç€ä¹…è¿çš„äº²åˆ‡æ„Ÿã€‚ ELSEWHERE æ¥åŒ—äº¬çš„ç¬¬ä¸€ä»½å·¥ä½œæ˜¯åœ¨çš‡åŸæ ¹å„¿æ—è¾¹çš„èƒ¡åŒé‡Œï¼Œä¸€å¦‚æ—¢å¾€çš„åˆ›ä¸šå…¬å¸ï¼ˆç¬‘ï¼‰ï¼Œè²Œä¼¼é™¤äº†æ ¡æ‹›å»çš„å…¬å¸æ˜¯æ¯”è¾ƒå¤§çš„ä¸Šå¸‚å…¬å¸ä¹‹å¤–ï¼Œè‡ªä»è½¬äº† iOS å¼€å‘ä¹‹åçš„å‡ æ¬¡é€‰æ‹©éƒ½é€‰äº†åˆ›ä¸šå…¬å¸â€¦ å½“æ—¶æ¸…æ¥šè®°å¾—æ˜¯ CTO äº²è‡ªé¢è¯•ï¼Œè§é¢çš„ç¬¬ä¸€å°è±¡å°±æ˜¯å¾ˆäº²åˆ‡å’Œå–„ï¼Œé£åº¦ç¿©ç¿©ã€‚èŠäº†èŠå‘ç°å…¬å¸è™½ç„¶æ˜¯åˆåˆ›å›¢é˜Ÿï¼Œä½†æ˜¯æ¯ä¸ªäººçš„ç´ è´¨å’ŒèƒŒæ™¯éƒ½å¾ˆå‡ºä¼—ï¼Œå°¤å…¶æ˜¯ç ”å‘å›¢é˜Ÿçš„ç»¼åˆç´ è´¨å¾ˆé«˜ï¼Œæˆ‘ä¸€ä¸ª 211 å«åº•å¤§å­¦è¿›å»çš„æ—¶å€™ä¸æ•¢å¤§å£°è¯´è¯ï¼ˆç¬‘ï¼‰ã€‚ åŠå¹´å¤šçš„å·¥ä½œä¸­ï¼Œå…¢å…¢ä¸šä¸šï¼Œç”Ÿæ€•å› ä¸ºè‡ªå·±çš„å¤±è¯¯æ‹–äº†æ•´ä¸ªå›¢é˜Ÿçš„åè…¿ï¼Œå¥½åœ¨ä¸€ç›´æ²¡æœ‰å‡ºä»€ä¹ˆçº°æ¼ï¼Œä¸Šçº§å¯¹æˆ‘çš„å·¥ä½œä¹Ÿæ¯”è¾ƒæ»¡æ„ï¼Œåœ¨é‡Œé¢ä¸å„ä½åŒäº‹ç›¸å¤„çš„ä¹Ÿå¾ˆæ„‰å¿«â€¦ ä¸è¿‡å¥½äº‹å¤šç£¨ï¼Œå›¢é˜Ÿå†…éƒ¨ä¹Ÿå‘ç”Ÿè¿‡ä¸€äº›æ‘©æ“¦ï¼Œå¸¦æˆ‘ä¸€èµ·å»èƒ¡åŒé‡Œé¢å°å­¦æ‰“çƒçš„ä¸¤ä¸ªå¤§å“¥å…ˆåç¦»èŒï¼Œæœ€åæˆ‘ä¹Ÿç”±äºç§ç§åŸå› ç¦»å¼€äº†â€¦ è™½ç„¶ç›¸å¤„æ—¶é—´ç®—ä¸ä¸Šé•¿ï¼Œä½†æ˜¯åœ¨ ELSEWHERE çš„è¿™æ®µæ—¶é—´æˆé•¿å¾ˆå¤šï¼Œä¸å¤§å®¶ç›¸å¤„çš„ä¹Ÿå¾ˆæ„‰å¿«ï¼Œç‰¹åˆ«æ˜¯ç ”å‘éƒ¨çš„å°ä¼™ä¼´ä»¬ï¼Œç°åœ¨è¿˜ä¸€ç›´æœ‰æ¥å¾€å‘¢ã€‚ä¹Ÿè®¸ï¼Œä¸‹æ¬¡æ¬å®¶ä¼šè€ƒè™‘åœ¨ä¸€èµ·åˆç§Ÿä¸€å¥—å¤§æˆ¿å­å‘¢~ è¿™é‡Œä¹Ÿè¢«æˆ‘å‘½åä¸º ELSEWHEREï¼Œæ—¨åœ¨çºªå¿µè¿™æ®µæ¥åŒ—äº¬åçš„ç¬¬ä¸€ä»½å·¥ä½œï¼Œä¹Ÿé¡ºä¾¿ç¥ç¦ ELSEWHERE èƒ½æ€å‡ºé‡å›´ï¼Œè¶Šèµ°è¶Šè¿œå§â€¦ æœªæ¥æƒ³è‡ªå·±æ¯•ä¸šä¸‰å¹´æœ‰ä½™ï¼Œå´ä¸€äº‹æ— æˆâ€¦ è¯´å‡ºæ¥è‡ªå·±éƒ½æƒ³ç¬‘ï¼Œä¸€ç›´é€‰æ‹©åˆ›ä¸šå…¬å¸æ˜¯å› ä¸ºæƒ³è¦æ”¹å˜ä¸–ç•Œâ€¦ è‡ªå·±å½“åˆåœ¨å¤§å­¦é‡Œæ‹¿åˆ°å¥–ç‰Œåå¹è¿‡çš„ç‰›é€¼è¿˜å†å†åœ¨ç›®â€¦ ä»¥å‰ä¸€ç›´ä¸æ‡‚ä¸ºä»€ä¹ˆç¤¾ä¼šæ˜¯ä¸ªå¤§æŸ“ç¼¸ï¼Œç°åœ¨èº«ä¸Šå·²ç»è¢«æ²¾æŸ“ä¸Šä¸€äº›ç¤¾ä¼šçš„é¢œè‰²ä¹‹åæ‰æ˜ç™½è¿™ä¸ªæ¯”å–»æ˜¯å¤šä¹ˆçš„è´´åˆ‡è€Œåˆæ— å¯å¥ˆä½•ã€‚æ—¶é—´ä¹Ÿç¡®å®æ˜¯ä¸€æŠŠåˆ©å™¨ï¼Œè¿™æ‰ä¸‰å¹´å¤šçš„å…‰æ™¯ï¼Œå°±æŠŠæ¢¦æƒ³è¶Šç£¨è¶Šå°ï¼Œå°åˆ°ä¸è§â€¦ å¯¹è‡ªå·±è¯´ï¼Œä¹Ÿè®¸ç°åœ¨æˆ‘è¿˜æ²¡æœ‰åˆ›ä¸šçš„èµ„æœ¬ï¼Œç­‰æ—¥åå¤šäº›ç§¯ç´¯å®šè¦å·åœŸé‡æ¥â€¦ å¯¹è‡ªå·±è¯´ï¼Œä¹Ÿè®¸å»å¤§å‚å¹¶éåªæ˜¯åšä¸€é¢—èºä¸é’‰ï¼Œæ¯•ç«Ÿç”¨æˆ·é‡å¤§ï¼Œè‡ªå·±åšçš„äº‹æƒ…å³ä½¿å†å°å†å¾®ä¸è¶³é“ï¼Œéƒ½æ˜¯å¯ä»¥å¯¹ç”¨æˆ·ç«¯æœ‰äº›è®¸å½±å“çš„ï¼Œä»æŸç§æ„ä¹‰ä¸Šè®²ä¹Ÿå®ç°äº†æ”¹å˜äººä»¬çš„ç”Ÿæ´»ï¼Œæ”¹å˜äº†ä¸–ç•Œâ€¦ ä»¥åçš„äº‹ï¼Œè°åˆèƒ½è¯´çš„å‡†å‘¢ï¼Ÿåªå¸Œæœ›è‡ªå·±å¯ä»¥å˜å¾—è¶Šæ¥è¶Šå¼ºâ€¦"},{"title":"ä» Aspects æºç ä¸­æˆ‘å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ","comments":true,"permalink":"https://lision.me/aspects/","text":"å‰è¨€AOP (Aspect-oriented programming) è¯‘ä¸º â€œé¢å‘åˆ‡é¢ç¼–ç¨‹â€ï¼Œæ˜¯é€šè¿‡é¢„ç¼–è¯‘æ–¹å¼å’Œè¿è¡ŒæœŸåŠ¨æ€ä»£ç†å®ç°ç¨‹åºåŠŸèƒ½ç»Ÿä¸€ç»´æŠ¤çš„ä¸€ç§æŠ€æœ¯ã€‚åˆ©ç”¨ AOP å¯ä»¥å¯¹ä¸šåŠ¡é€»è¾‘çš„å„ä¸ªéƒ¨åˆ†è¿›è¡Œéš”ç¦»ï¼Œä»è€Œä½¿å¾—ä¸šåŠ¡é€»è¾‘å„éƒ¨åˆ†ä¹‹é—´çš„è€¦åˆåº¦é™ä½ï¼Œæé«˜ç¨‹åºçš„å¯é‡ç”¨æ€§ï¼ŒåŒæ—¶æé«˜äº†å¼€å‘çš„æ•ˆç‡ã€‚ Emmmmmâ€¦AOP ç›®å‰æ˜¯è¾ƒä¸ºçƒ­é—¨çš„ä¸€ä¸ªè¯é¢˜ï¼Œå°½ç®¡ä½ ä¹Ÿè®¸æ²¡æœ‰å¬è¯´è¿‡å®ƒï¼Œä½†æ˜¯ä½ çš„é¡¹ç›®ä¸­å¯èƒ½å·²ç»æ¸—å…¥äº†å®ƒï¼Œä¾‹å¦‚ï¼šç”¨æˆ·ç»Ÿè®¡ï¼ˆä¸æ·»åŠ ä¸€è¡Œä»£ç å³å®ç°å¯¹æ‰€æœ‰ ViewController çš„è·Ÿè¸ªæ—¥å¿—ï¼‰ã€‚ å¯¹äº iOS å¼€å‘è€…è€Œè¨€ï¼Œæ— å¤–ä¹ Swift å’Œ Objective-C ä¸¤ç§ä¸»æµå¼€å‘è¯­è¨€ï¼š Swift å—é™äº ABI å°šæœªç¨³å®šï¼ŒåŠ¨æ€æ€§ä¾èµ– dynamic ä¿®é¥°ç¬¦ï¼Œåœ¨ Runtime æ²¡æœ‰ç•™ç»™æˆ‘ä»¬å¤ªå¤šçš„å‘æŒ¥ç©ºé—´ï¼ˆå‰å‡ æ—¥æ–°å¢äº† swift-5.0-branch åˆ†æ”¯ï¼Œå†™è¿™ç¯‡æ–‡ç« æ—¶çœ‹äº†ä¸€çœ¼ 181 commits behind master ğŸ˜‚ï¼‰ã€‚ Objective-C åœ¨åŠ¨æ€æ€§ä¸Šç›¸å¯¹ Swift å…·æœ‰æ— é™å¤§çš„ä¼˜åŠ¿ï¼Œè¿™å‡ å¹´ Objective-C Runtime ç›¸å…³æ–‡ç« å¤šå¦‚ç‰›æ¯›ï¼Œç›¸ä¿¡ç°åœ¨çš„ iOSer éƒ½å…·å¤‡ä¸€å®šçš„ Runtime ç›¸å…³çŸ¥è¯†ã€‚ Aspects ä½œä¸º Objective-C è¯­è¨€ç¼–å†™çš„ AOP åº“ï¼Œé€‚ç”¨äº iOS å’Œ Mac OS Xï¼Œä½¿ç”¨ä½“éªŒç®€å•æ„‰å¿«ï¼Œå·²ç»åœ¨ GitHub æ‘˜å¾— 5k+ Starã€‚Aspects å†…éƒ¨å®ç°æ¯”è¾ƒå¥å…¨ï¼Œè€ƒè™‘åˆ°äº† Hook å®‰å…¨æ–¹é¢å¯èƒ½å‘ç”Ÿçš„ç§ç§é—®é¢˜ï¼Œéå¸¸å€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚ Note: æœ¬æ–‡å†…å¼•ç”¨ Aspects æºç ç‰ˆæœ¬ä¸º v1.4.2ï¼Œè¦æ±‚è¯»è€…å…·å¤‡ä¸€å®šçš„ Runtime çŸ¥è¯†ã€‚ ç´¢å¼• AOP ç®€ä»‹ Aspects ç®€ä»‹ Aspects ç»“æ„å‰–æ Aspects æ ¸å¿ƒä»£ç å‰–æ ä¼˜ç§€ AOP åº“åº”è¯¥å…·å¤‡çš„ç‰¹è´¨ æ€»ç»“ AOP ç®€ä»‹ åœ¨è¿è¡Œæ—¶ï¼ŒåŠ¨æ€åœ°å°†ä»£ç åˆ‡å…¥åˆ°ç±»çš„æŒ‡å®šæ–¹æ³•ã€æŒ‡å®šä½ç½®ä¸Šçš„ç¼–ç¨‹æ€æƒ³å°±æ˜¯é¢å‘åˆ‡é¢çš„ç¼–ç¨‹ã€‚ AOP (Aspect-oriented programming)ï¼Œå³ â€œé¢å‘åˆ‡é¢ç¼–ç¨‹â€ æ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œæˆ–è€…è¯´æ˜¯ä¸€ç§ç¼–ç¨‹æ€æƒ³ï¼Œå®ƒè§£å†³äº† OOP (Object-oriented programming) çš„å»¶ä¼¸é—®é¢˜ã€‚ ä»€ä¹ˆæ—¶å€™éœ€è¦ä½¿ç”¨ AOPå…‰æ˜¯ç»™ä¸ªæ¦‚å¿µå¯èƒ½åˆæ¬¡æ¥è§¦ AOP çš„äººè¿˜æ˜¯æ— æ³• Get åˆ°å…¶ä¸­å¾®ç§’ï¼Œæ‹¿æˆ‘ä»¬å‰è¨€ä¸­ä¸¾çš„ä¾‹å­ğŸŒ°ï¼Œå‡è®¾éšç€æˆ‘ä»¬æ‰€åœ¨çš„å…¬å¸é€æ­¥å‘å±•ï¼Œä¹‹å‰ç¬¬ä¸‰æ–¹çš„ç”¨æˆ·é¡µé¢ç»Ÿè®¡å·²ç»ä¸èƒ½æ»¡è¶³éœ€æ±‚äº†ï¼Œå…¬å¸è¦æ±‚å®ç°ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±çš„ç”¨æˆ·é¡µé¢ç»Ÿè®¡ã€‚ å˜›~ æˆ‘ä»¬æ¥ç†ä¸€ä¸‹ OOP æ€æƒ³ä¸‹è¯¥æ€ä¹ˆåŠï¼Ÿ ä¸€ä¸ªç†Ÿæ‚‰ OOP æ€æƒ³çš„ç¨‹åºçŒ¿ä¼šç†æ‰€åº”å½“çš„æƒ³åˆ°è¦æŠŠç”¨æˆ·é¡µé¢ç»Ÿè®¡è¿™ä¸€ä»»åŠ¡æ”¾åˆ° ViewController ä¸­ï¼› è€ƒè™‘åˆ°ä¸€ä¸ªä¸ªçš„æ‰‹åŠ¨æ·»åŠ ç»Ÿè®¡ä»£ç è¦æ­»äººï¼ˆè€Œä¸”è¿˜ä¼šæ¼ï¼Œä»¥åæ–°å¢ ViewController ä¹Ÿè¦æ‰‹åŠ¨åŠ ï¼‰ï¼Œäºæ˜¯æƒ³åˆ°äº† OOP æ€æƒ³ä¸­çš„ç»§æ‰¿ï¼› ä¸å·§ç”±äºé¡¹ç›®ä¹…è¿œï¼Œæ‰€æœ‰çš„ ViewController éƒ½æ˜¯ç›´æ¥ç»§æ‰¿è‡ªç³»ç»Ÿç±» UIViewControllerï¼ˆç¬‘ï¼‰ï¼Œæ­¤æ—¶é€‰æ‹©æŠ½ä¸€ä¸ªé¡¹ç›® RootViewControllerï¼Œæ›¿æ¢æ‰€æœ‰ ViewController ç»§æ‰¿ RootViewControllerï¼› ç„¶ååœ¨ RootViewController çš„ viewWillAppear: å’Œ viewWillDisappear: æ–¹æ³•åŠ å…¥æ—¶é—´ç»Ÿè®¡ä»£ç ï¼Œè®°å½• ViewController ä»¥åŠ Router ä¼ å‚ã€‚ ä½ ä¼šæƒ³ï¼Œæ˜æ˜ OOP ä¹Ÿèƒ½è§£å†³é—®é¢˜æ˜¯ä¸æ˜¯ï¼Ÿä¸è¦æ€¥ï¼Œå†å‡è®¾ä½ ä»¬å…¬å¸æœ‰å¤šä¸ª Appï¼Œä½ è¢«æŠ½è°ƒè‡³åŸºç¡€æŠ€æœ¯ç»„ä¸“é—¨ç»™è¿™äº› App å†™é€šç”¨ç»„ä»¶ï¼Œè¦æŠŠä¹‹å‰å®ç°è¿‡çš„ç”¨æˆ·é¡µé¢ç»Ÿè®¡é‡æ–°ä»¥é€šç”¨çš„å½¢å¼å®ç°ï¼Œæä¾›ç»™ä½ ä»¬å…¬å¸æ‰€æœ‰çš„ App ä½¿ç”¨ã€‚ MMPï¼Œä½¿ç”¨æ ‡å‡† OOP æ€æƒ³è²Œä¼¼æ— è§£å•Šâ€¦è¿™ä¸ªæ—¶å€™å°±æ˜¯ AOP çš„ç”¨æ­¦ä¹‹åœ°äº†ã€‚ è¿™é‡Œç®€å•ç»™ä¸ªæ€è·¯ï¼šHook UIViewController çš„ viewWillAppear: å’Œ viewWillDisappear: æ–¹æ³•ï¼Œåœ¨åŸæ–¹æ³•æ‰§è¡Œä¹‹åè®°å½•éœ€è¦ç»Ÿè®¡çš„ä¿¡æ¯ä¸ŠæŠ¥å³å¯ã€‚ Note: ç®€å•é€šè¿‡ Method Swizzling æ¥ Hook ä¸æ˜¯ä¸å¯ä»¥ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šå®‰å…¨éšæ‚£ï¼ Aspects ç®€ä»‹ Aspects æ˜¯ä¸€ä¸ªä½¿ç”¨èµ·æ¥ç®€å•æ„‰å¿«çš„ AOP åº“ï¼Œä½¿ç”¨ Objective-C ç¼–å†™ï¼Œé€‚ç”¨äº iOS ä¸ Mac OS Xã€‚ Aspects å†…éƒ¨å®ç°è€ƒè™‘åˆ°äº†å¾ˆå¤š Hook å¯èƒ½å¼•å‘çš„é—®é¢˜ï¼Œç¬”è€…åœ¨çœ‹æºç çš„è¿‡ç¨‹ä¸­æŠ çš„æ¯”è¾ƒç»†ï¼ŒçœŸçš„æ˜¯å—ç›ŠåŒªæµ…ã€‚ Aspects ç®€å•æ˜“ç”¨ï¼Œä½œè€…é€šè¿‡åœ¨ NSObject (Aspects) åˆ†ç±»ä¸­æš´éœ²å‡ºçš„ä¸¤ä¸ªæ¥å£åˆ†åˆ«æä¾›äº†å¯¹å®ä¾‹å’Œ Class çš„ Hook å®ç°ï¼š 12345678910111213@interface NSObject (Aspects)+ (id&lt;AspectToken&gt;)aspect_hookSelector:(SEL)selector withOptions:(AspectOptions)options usingBlock:(id)block error:(NSError **)error;- (id&lt;AspectToken&gt;)aspect_hookSelector:(SEL)selector withOptions:(AspectOptions)options usingBlock:(id)block error:(NSError **)error;@end Aspects æ”¯æŒå®ä¾‹ Hookï¼Œç›¸è¾ƒå…¶ä»– Objective-C AOP åº“è€Œè¨€å¯æ“ä½œç²’åº¦æ›´å°ï¼Œé€‚åˆçš„åœºæ™¯æ›´åŠ å¤šæ ·åŒ–ã€‚ä½œä¸ºä½¿ç”¨è€…æ— éœ€è¿›è¡Œæ›´å¤šçš„æ“ä½œå³å¯ Hook æŒ‡å®šå®ä¾‹æˆ–è€… Class çš„æŒ‡å®š SELï¼ŒAspectOptions å‚æ•°å¯ä»¥æŒ‡å®š Hook çš„ç‚¹ï¼Œä»¥åŠæ˜¯å¦æ‰§è¡Œä¸€æ¬¡ä¹‹åå°±æ’¤é”€ Hookã€‚ Aspects ç»“æ„å‰–æ Emmmmmâ€¦å°½ç®¡ Aspects åªæœ‰ä¸åˆ°åƒè¡Œçš„æºç ï¼Œä½†æ˜¯å…¶å†…éƒ¨å®ç°è€ƒè™‘åˆ°äº†å¾ˆå¤š Hook ç›¸å…³çš„å®‰å…¨é—®é¢˜å’Œå…¶ä»–ç»†èŠ‚ï¼Œå¯¹æ¯”å…¶ä»– Objective-C AOP å¼€æºé¡¹ç›®æ¥è¯´ Aspects æ›´ä¸ºå¥å…¨ï¼Œæ‰€ä»¥æˆ‘è‡ªå·±åœ¨æ‰’ Aspects æºç æ—¶ä¹Ÿçœ‹çš„æ¯”è¾ƒä»”ç»†ã€‚ Aspects å†…éƒ¨ç»“æ„Aspects å†…éƒ¨å®šä¹‰äº†ä¸¤ä¸ªåè®®ï¼š AspectToken - ç”¨äºæ³¨é”€ Hook AspectInfo - åµŒå…¥ Hook ä¸­çš„ Block é¦–ä½å‚æ•° æ­¤å¤– Aspects å†…éƒ¨è¿˜å®šä¹‰äº† 4 ä¸ªç±»ï¼š AspectInfo - åˆ‡é¢ä¿¡æ¯ï¼Œéµå¾ª AspectInfo åè®® AspectIdentifier - åˆ‡é¢ IDï¼Œåº”è¯¥éµå¾ª AspectToken åè®®ï¼ˆä½œè€…æ¼æ‰äº†ï¼Œå·²æ PRï¼‰ AspectsContainer - åˆ‡é¢å®¹å™¨ AspectTracker - åˆ‡é¢è·Ÿè¸ªå™¨ ä»¥åŠä¸€ä¸ªç»“æ„ä½“ï¼š AspectBlockRef - å³ _AspectBlockï¼Œå……å½“å†…éƒ¨ Block å¦‚æœä½ æ‰’ä¸€éæºç ï¼Œè¿˜ä¼šå‘ç°ä¸¤ä¸ªå†…éƒ¨é™æ€å…¨å±€å˜é‡ï¼š static NSMutableDictionary *swizzledClassesDict; static NSMutableSet *swizzledClasses; ç°åœ¨ä½ ä¹Ÿè®¸è¿˜ä¸èƒ½ç†è§£ä¸ºä»€ä¹ˆè¦å®šä¹‰è¿™ä¹ˆå¤šä¸œè¥¿ï¼Œåˆ«æ€¥~ æˆ‘ä»¬åé¢éƒ½ä¼šåˆ†æåˆ°ã€‚ Aspects åè®®æŒ‰ç…§ä¸Šé¢åˆ—å‡ºçš„é¡ºåºï¼Œå…ˆæ¥ä»‹ç»ä¸€äº› Aspects å£°æ˜çš„åè®®ã€‚ AspectTokenAspectToken åè®®æ—¨åœ¨è®©ä½¿ç”¨è€…å¯ä»¥çµæ´»çš„æ³¨é”€ä¹‹å‰æ·»åŠ è¿‡çš„ Hookï¼Œå†…éƒ¨è§„å®šéµå®ˆæ­¤åè®®çš„å¯¹è±¡é¡»å®ç° remove æ–¹æ³•ã€‚ 12345678/// ä¸é€æ˜çš„ Aspect Tokenï¼Œç”¨äºæ³¨é”€ Hook@protocol AspectToken &lt;NSObject&gt;/// æ³¨é”€ä¸€ä¸ª aspect./// è¿”å› YES è¡¨ç¤ºæ³¨é”€æˆåŠŸï¼Œå¦åˆ™è¿”å› NO- (BOOL)remove;@end AspectInfoAspectInfo åè®®æ—¨åœ¨è§„èŒƒå¯¹ä¸€ä¸ªåˆ‡é¢ï¼Œå³ aspect çš„ Hook å†…éƒ¨ä¿¡æ¯çš„çº°æ¼ï¼Œæˆ‘ä»¬åœ¨ Hook æ—¶æ·»åŠ åˆ‡é¢çš„ Block ç¬¬ä¸€ä¸ªå‚æ•°å°±éµå®ˆæ­¤åè®®ã€‚ 12345678910111213/// AspectInfo åè®®æ˜¯æˆ‘ä»¬å—è¯­æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚@protocol AspectInfo &lt;NSObject&gt;/// å½“å‰è¢« Hook çš„å®ä¾‹- (id)instance;/// è¢« Hook æ–¹æ³•çš„åŸå§‹ invocation- (NSInvocation *)originalInvocation;/// æ‰€æœ‰æ–¹æ³•å‚æ•°ï¼ˆè£…ç®±ä¹‹åçš„ï¼‰æƒ°æ€§æ‰§è¡Œ- (NSArray *)arguments;@end Note: è£…ç®±æ˜¯ä¸€ä¸ªå¼€é”€æ˜‚è´µæ“ä½œï¼Œæ‰€ä»¥ç”¨åˆ°å†å»æ‰§è¡Œã€‚ Aspects å†…éƒ¨ç±»æ¥ç€åè®®ï¼Œæˆ‘ä»¬ä¸‹é¢è¯¦ç»†ä»‹ç»ä¸€ä¸‹ Aspects çš„å†…éƒ¨ç±»ã€‚ AspectInfo Note: AspectInfo åœ¨è¿™é‡Œæ˜¯ä¸€ä¸ª Classï¼Œå…¶éµå®ˆä¸Šæ–‡ä¸­è®²åˆ°çš„ AspectInfo åè®®ï¼Œä¸è¦æ··æ·†ã€‚ AspectInfo ç±»å®šä¹‰ï¼š 123456789@interface AspectInfo : NSObject &lt;AspectInfo&gt;- (id)initWithInstance:(__unsafe_unretained id)instance invocation:(NSInvocation *)invocation;@property (nonatomic, unsafe_unretained, readonly) id instance;@property (nonatomic, strong, readonly) NSArray *arguments;@property (nonatomic, strong, readonly) NSInvocation *originalInvocation;@end Note: å…³äºè£…ç®±ï¼Œå¯¹äºæä¾›ä¸€ä¸ª NSInvocation å°±å¯ä»¥æ‹¿åˆ°å…¶ arguments è¿™ä¸€ç‚¹ä¸Šï¼ŒReactiveCocoa å›¢é˜Ÿæä¾›äº†å¾ˆå¤§è´¡çŒ®ï¼ˆç»†èŠ‚è§ Aspects å†…éƒ¨ NSInvocation åˆ†ç±»ï¼‰ã€‚ AspectInfo æ¯”è¾ƒç®€å•ï¼Œå‚è€ƒ ReactiveCocoa å›¢é˜Ÿæä¾›çš„ NSInvocation å‚æ•°é€šç”¨æ–¹æ³•å¯å°†å‚æ•°è£…ç®±ä¸º NSValueï¼Œç®€å•æ¥è¯´ AspectInfo æ‰®æ¼”äº†ä¸€ä¸ªæä¾› Hook ä¿¡æ¯çš„è§’è‰²ã€‚ AspectIdentifierAspectIdentifier ç±»å®šä¹‰ï¼š 12345678910111213@interface AspectIdentifier : NSObject+ (instancetype)identifierWithSelector:(SEL)selector object:(id)object options:(AspectOptions)options block:(id)block error:(NSError **)error;- (BOOL)invokeWithInfo:(id&lt;AspectInfo&gt;)info;@property (nonatomic, assign) SEL selector;@property (nonatomic, strong) id block;@property (nonatomic, strong) NSMethodSignature *blockSignature;@property (nonatomic, weak) id object;@property (nonatomic, assign) AspectOptions options;@end Note: AspectIdentifier å®é™…ä¸Šæ˜¯æ·»åŠ åˆ‡é¢çš„ Block çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå…¶åº”è¯¥éµå¾ª AspectToken åè®®ï¼Œäº‹å®ä¸Šä¹Ÿçš„ç¡®å¦‚æ­¤ï¼Œå…¶æä¾›äº† remove æ–¹æ³•çš„å®ç°ã€‚ AspectIdentifier å†…éƒ¨éœ€è¦æ³¨æ„çš„æ˜¯ç”±äºä½¿ç”¨ Block æ¥å†™ Hook ä¸­æˆ‘ä»¬åŠ çš„æ–™ï¼Œè¿™é‡Œç”Ÿæˆäº† blockSignatureï¼Œåœ¨ AspectIdentifier åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ä¼šå»åˆ¤æ–­ blockSignature ä¸å…¥å‚ object çš„ selector å¾—åˆ°çš„ methodSignature çš„å…¼å®¹æ€§ï¼Œå…¼å®¹æ€§åˆ¤æ–­æˆåŠŸæ‰ä¼šé¡ºåˆ©åˆå§‹åŒ–ã€‚ AspectsContainerAspectsContainer ç±»å®šä¹‰ï¼š 1234567891011@interface AspectsContainer : NSObject- (void)addAspect:(AspectIdentifier *)aspect withOptions:(AspectOptions)injectPosition;- (BOOL)removeAspect:(id)aspect;- (BOOL)hasAspects;@property (atomic, copy) NSArray *beforeAspects;@property (atomic, copy) NSArray *insteadAspects;@property (atomic, copy) NSArray *afterAspects;@end AspectsContainer ä½œä¸ºåˆ‡é¢çš„å®¹å™¨ç±»ï¼Œå…³è”æŒ‡å®šå¯¹è±¡çš„æŒ‡å®šæ–¹æ³•ï¼Œå†…éƒ¨æœ‰ä¸‰ä¸ªåˆ‡é¢é˜Ÿåˆ—ï¼Œåˆ†åˆ«å®¹çº³å…³è”æŒ‡å®šå¯¹è±¡çš„æŒ‡å®šæ–¹æ³•ä¸­ç›¸å¯¹åº” AspectOption çš„ Hookï¼š NSArray *beforeAspects; - AspectPositionBefore NSArray *insteadAspects; - AspectPositionInstead NSArray *afterAspects; - AspectPositionAfter ä¸ºä»€ä¹ˆè¦è¯´å…³è”å‘¢ï¼Ÿå› ä¸º AspectsContainer æ˜¯åœ¨ NSObject åˆ†ç±»ä¸­é€šè¿‡ AssociatedObject æ–¹æ³•ä¸å½“å‰è¦ Hook çš„ç›®æ ‡å…³è”åœ¨ä¸€èµ·çš„ã€‚ Note: å…³è”ç›®æ ‡æ˜¯ Hook ä¹‹åçš„ Selectorï¼Œå³ aliasSelectorï¼ˆåŸå§‹ SEL åç§°åŠ  aspects_ å‰ç¼€å¯¹åº”çš„ SELï¼‰ã€‚ AspectTrackerAspectTracker ç±»å®šä¹‰ï¼š 123456789@interface AspectTracker : NSObject- (id)initWithTrackedClass:(Class)trackedClass parent:(AspectTracker *)parent;@property (nonatomic, strong) Class trackedClass;@property (nonatomic, strong) NSMutableSet *selectorNames;@property (nonatomic, weak) AspectTracker *parentEntry;@end AspectTracker ä½œä¸ºåˆ‡é¢è¿½è¸ªå™¨ï¼ŒåŸç†å¤§è‡´å¦‚ä¸‹ï¼š 12345678910111213// Add the selector as being modified.currentClass = klass;AspectTracker *parentTracker = nil;do &#123; AspectTracker *tracker = swizzledClassesDict[currentClass]; if (!tracker) &#123; tracker = [[AspectTracker alloc] initWithTrackedClass:currentClass parent:parentTracker]; swizzledClassesDict[(id&lt;NSCopying&gt;)currentClass] = tracker; &#125; [tracker.selectorNames addObject:selectorName]; // All superclasses get marked as having a subclass that is modified. parentTracker = tracker;&#125;while ((currentClass = class_getSuperclass(currentClass))); Note: èªæ˜çš„ä½ åº”è¯¥å·²ç»æ³¨æ„åˆ°äº†å…¨å±€å˜é‡ swizzledClassesDict ä¸­çš„ value å¯¹åº”ç€ AspectTracker æŒ‡é’ˆã€‚ å˜›~ å°±æ˜¯è¯´ AspectTracker æ˜¯ä»ä¸‹è€Œä¸Šè¿½è¸ªï¼Œæœ€åº•å±‚çš„ parentEntry ä¸º nilï¼Œçˆ¶ç±»çš„ parentEntry ä¸ºå­ç±»çš„ trackerã€‚ Aspects å†…éƒ¨ç»“æ„ä½“AspectBlockRefAspectBlockRefï¼Œå³ struct _AspectBlockï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š 1234567891011121314151617typedef struct _AspectBlock &#123; __unused Class isa; AspectBlockFlags flags; __unused int reserved; void (__unused *invoke)(struct _AspectBlock *block, ...); struct &#123; unsigned long int reserved; unsigned long int size; // requires AspectBlockFlagsHasCopyDisposeHelpers void (*copy)(void *dst, const void *src); void (*dispose)(const void *); // requires AspectBlockFlagsHasSignature const char *signature; const char *layout; &#125; *descriptor; // imported variables&#125; *AspectBlockRef; Emmmmmâ€¦æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œå¤§å®¶åº”è¯¥æ¯”è¾ƒçœ¼ç†Ÿå§ã€‚ Note: __unused å®å®šä¹‰å®é™…ä¸Šæ˜¯ __attribute__((unused)) GCC å®šè¯­ï¼Œæ—¨åœ¨å‘Šè¯‰ç¼–è¯‘å™¨â€œå¦‚æœæˆ‘æ²¡æœ‰åœ¨åé¢ä½¿ç”¨åˆ°è¿™ä¸ªå˜é‡ä¹Ÿåˆ«è­¦å‘Šæˆ‘â€ã€‚ å˜›~ æƒ³èµ·ä¹‹å‰è‡ªå·±æŒ–çš„å‘è¿˜æ²¡æœ‰å¡«ï¼Œäº‹å®ä¸Šè‡ªå·±ä¹Ÿä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™å¡«ï¼ˆç¬‘ï¼‰ï¼š ä¹‹å‰æŒ–å‘è¯´è¦å†™ä¸€ç¯‡æ–‡ç« è®°å½•ä¸€äº›é˜…è¯»æºç æ—¶å‘ç°çš„ä»£ç ä¹¦å†™æŠ€å·§ ä¹‹å‰æŒ–å‘è¯´è¦å°è£…ä¸€ä¸ª WKWebView ç»™ç¾¤é‡Œçš„å…„å¼Ÿå‚è€ƒ ä¸è¦æ€¥~ ä½ ç§ä¼¦å®¶ä¸æ˜¯éƒ½è®°å¾—å˜›ï¼ˆè‡³äºä»€ä¹ˆæ—¶å€™å¡«å‘å˜›å°±â€¦å’³å’³ï¼‰ Aspects é™æ€å…¨å±€å˜é‡static NSMutableDictionary *swizzledClassesDict;static NSMutableDictionary *swizzledClassesDict; åœ¨ Aspects ä¸­æ‰®æ¼”ç€å·²æ··å†™ç±»å­—å…¸çš„è§’è‰²ï¼Œå…¶å†…éƒ¨ç»“æ„åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š 1&lt;Class : AspectTracker *&gt; Aspects å†…éƒ¨æä¾›äº†ä¸“é—¨è®¿é—®è¿™ä¸ªå…¨å±€å­—å…¸çš„æ–¹æ³•ï¼š 12345678static NSMutableDictionary *aspect_getSwizzledClassesDict() &#123; static NSMutableDictionary *swizzledClassesDict; static dispatch_once_t pred; dispatch_once(&amp;pred, ^&#123; swizzledClassesDict = [NSMutableDictionary new]; &#125;); return swizzledClassesDict;&#125; è¿™ä¸ªå…¨å±€å˜é‡å¯ä»¥ç®€å•ç†è§£ä¸ºè®°å½•æ•´ä¸ª Hook å½±å“çš„ Class åŒ…å«å…¶ SuperClass çš„è¿½è¸ªè®°å½•çš„å…¨å±€å­—å…¸ã€‚ static NSMutableSet *swizzledClasses;static NSMutableSet *swizzledClasses; åœ¨ Aspects ä¸­æ‹…å½“è®°å½•å·²æ··å†™ç±»çš„è§’è‰²ï¼Œå…¶å†…éƒ¨ç»“æ„å¦‚ä¸‹ï¼š 1&lt;NSStringFromClass(Class)&gt; Aspects å†…éƒ¨æä¾›ä¸€ä¸ªç”¨äºä¿®æ”¹è¿™ä¸ªå…¨å±€å˜é‡å†…å®¹çš„æ–¹æ³•ï¼š 12345678910static void _aspect_modifySwizzledClasses(void (^block)(NSMutableSet *swizzledClasses)) &#123; static NSMutableSet *swizzledClasses; static dispatch_once_t pred; dispatch_once(&amp;pred, ^&#123; swizzledClasses = [NSMutableSet new]; &#125;); @synchronized(swizzledClasses) &#123; block(swizzledClasses); &#125;&#125; Note: æ³¨æ„ @synchronized(swizzledClasses)ã€‚ è¿™ä¸ªå…¨å±€å˜é‡è®°å½•äº† forwardInvocation: è¢«æ··å†™çš„çš„ç±»åç§°ã€‚ Note: æ³¨æ„åœ¨ç”¨é€”ä¸Šä¸ static NSMutableDictionary *swizzledClassesDict; åŒºåˆ†ç†è§£ã€‚ Aspects æ ¸å¿ƒä»£ç å‰–æ å˜›~ Aspects çš„æ•´ä½“å®ç°ä»£ç ä¸è¶…è¿‡ä¸€åƒè¡Œï¼Œè€Œä¸”è€ƒè™‘çš„æƒ…å†µä¹Ÿæ¯”è¾ƒå…¨é¢ï¼Œéå¸¸å€¼å¾—å¤§å®¶èŠ±æ—¶é—´å»è¯»ä¸€ä¸‹ï¼Œè¿™é‡Œæˆ‘åªå‡†å¤‡ç»™å‡ºè‡ªå·±å¯¹å…¶æ ¸å¿ƒä»£ç çš„ç†è§£ã€‚ Hook Class &amp;&amp; Hook InstanceAspects ä¸å…‰æ”¯æŒ Hook Class è¿˜æ”¯æŒ Hook Instanceï¼Œè¿™æä¾›äº†æ›´å°ç²’åº¦çš„æ§åˆ¶ï¼Œé…åˆ Hook çš„æ’¤é”€åŠŸèƒ½å¯ä»¥æ›´åŠ çµæ´»ç²¾å‡†çš„åšæˆ‘ä»¬æƒ³åšçš„äº‹~ Aspects ä¸ºäº†èƒ½åŒºåˆ« Class å’Œ Instance çš„é€»è¾‘ï¼Œå®ç°äº†åä¸º aspect_hookClass çš„æ–¹æ³•ï¼Œæˆ‘è®¤ä¸ºå…¶ä¸­çš„å®ç°å€¼å¾—æˆ‘ç”¨ä¸€éƒ¨åˆ†ç¯‡å¹…æ¥å•ç‹¬è®²è§£ï¼Œä¹Ÿè§‰å¾—è¯»è€…ä»¬æœ‰å¿…è¦èŠ±ç‚¹æ—¶é—´ç†è§£è¿™é‡Œçš„å®ç°é€»è¾‘ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152static Class aspect_hookClass(NSObject *self, NSError **error) &#123; // æ–­è¨€ self NSCParameterAssert(self); // class Class statedClass = self.class; // isa Class baseClass = object_getClass(self); NSString *className = NSStringFromClass(baseClass); // å·²ç»å­ç±»åŒ–è¿‡äº† if ([className hasSuffix:AspectsSubclassSuffix]) &#123; return baseClass; // æˆ‘ä»¬æ··å†™äº†ä¸€ä¸ª class å¯¹è±¡ï¼Œè€Œéä¸€ä¸ªå•ç‹¬çš„ object &#125;else if (class_isMetaClass(baseClass)) &#123; // baseClass æ˜¯å…ƒç±»ï¼Œåˆ™ self æ˜¯ Class æˆ– MetaClassï¼Œæ··å†™ self return aspect_swizzleClassInPlace((Class)self); // å¯èƒ½æ˜¯ä¸€ä¸ª KVO&#x27;ed classã€‚æ··å†™å°±ä½ã€‚ä¹Ÿè¦æ··å†™ meta classesã€‚ &#125;else if (statedClass != baseClass) &#123; // å½“ .class å’Œ isa æŒ‡å‘ä¸åŒçš„æƒ…å†µï¼Œæ··å†™ baseClass return aspect_swizzleClassInPlace(baseClass); &#125; // é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŠ¨æ€åˆ›å»ºå­ç±» // æ‹¼æ¥å­ç±»åç¼€ AspectsSubclassSuffix const char *subclassName = [className stringByAppendingString:AspectsSubclassSuffix].UTF8String; // å°è¯•ç”¨æ‹¼æ¥åç¼€çš„åç§°è·å– isa Class subclass = objc_getClass(subclassName); // æ‰¾ä¸åˆ° isaï¼Œä»£è¡¨è¿˜æ²¡æœ‰åŠ¨æ€åˆ›å»ºè¿‡è¿™ä¸ªå­ç±» if (subclass == nil) &#123; // åˆ›å»ºä¸€ä¸ª class pairï¼ŒbaseClass ä½œä¸ºæ–°ç±»çš„ superClassï¼Œç±»åä¸º subclassName subclass = objc_allocateClassPair(baseClass, subclassName, 0); if (subclass == nil) &#123; // è¿”å› nilï¼Œå³åˆ›å»ºå¤±è´¥ NSString *errrorDesc = [NSString stringWithFormat:@&quot;objc_allocateClassPair failed to allocate class %s.&quot;, subclassName]; AspectError(AspectErrorFailedToAllocateClassPair, errrorDesc); return nil; &#125; // æ··å†™ forwardInvocation: aspect_swizzleForwardInvocation(subclass); // subClass.class = statedClass aspect_hookedGetClass(subclass, statedClass); // subClass.isa.class = statedClass aspect_hookedGetClass(object_getClass(subclass), statedClass); // æ³¨å†Œæ–°ç±» objc_registerClassPair(subclass); &#125; // è¦†ç›– isa object_setClass(self, subclass); return subclass;&#125; Note: å…¶å®è¿™é‡Œçš„éš¾ç‚¹å°±åœ¨äºå¯¹ .class å’Œ object_getClass çš„åŒºåˆ†ã€‚ .class å½“ target æ˜¯ Instance åˆ™è¿”å› Classï¼Œå½“ target æ˜¯ Class åˆ™è¿”å›è‡ªèº« object_getClass è¿”å› isa æŒ‡é’ˆçš„æŒ‡å‘ Note: åŠ¨æ€åˆ›å»ºä¸€ä¸ª Class çš„å®Œæ•´æ­¥éª¤ä¹Ÿæ˜¯æˆ‘ä»¬åº”è¯¥æ³¨æ„çš„ã€‚ objc_allocateClassPair class_addMethod class_addIvar objc_registerClassPair å˜›~ éš¾ç‚¹å’Œé‡ç‚¹éƒ½è®²å®Œäº†ï¼Œå¤§å®¶ç»“åˆæ³¨é‡Šç†è§£å…¶ä¸­çš„é€»è¾‘åº”è¯¥æ²¡ä»€ä¹ˆå›°éš¾äº†ï¼Œæœ‰ä»€ä¹ˆé—®é¢˜å¯ä»¥æ‰¾æˆ‘ä¸€èµ·äº¤æµ~ Hook çš„å®ç°åœ¨ä¸Šé¢ aspect_hookClass æ–¹æ³•ä¸­ï¼Œä¸ä»…ä»…æ˜¯è¿”å›ä¸€ä¸ªè¦ Hook çš„ Classï¼ŒæœŸé—´è¿˜åšäº†ä¸€äº›ç»†èŠ‚æ“ä½œï¼Œä¸è®ºæ˜¯ Class è¿˜æ˜¯ Instanceï¼Œéƒ½ä¼šè°ƒç”¨ aspect_swizzleForwardInvocation æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ²¡ä»€ä¹ˆéš¾ç‚¹ï¼Œç®€å•è´´ä¸€ä¸‹ä»£ç è®©å¤§å®¶æœ‰ä¸ªå°è±¡ï¼š 123456789101112static void aspect_swizzleForwardInvocation(Class klass) &#123; // æ–­è¨€ klass NSCParameterAssert(klass); // å¦‚æœæ²¡æœ‰ methodï¼Œreplace å®é™…ä¸Šä¼šåƒæ˜¯ class_addMethod ä¸€æ · IMP originalImplementation = class_replaceMethod(klass, @selector(forwardInvocation:), (IMP)__ASPECTS_ARE_BEING_CALLED__, &quot;v@:@&quot;); // æ‹¿åˆ° originalImplementation è¯æ˜æ˜¯ replace è€Œä¸æ˜¯ addï¼Œæƒ…å†µå°‘è§ if (originalImplementation) &#123; // æ·»åŠ  AspectsForwardInvocationSelectorName çš„æ–¹æ³•ï¼ŒIMP ä¸ºåŸç”Ÿ forwardInvocation: class_addMethod(klass, NSSelectorFromString(AspectsForwardInvocationSelectorName), originalImplementation, &quot;v@:@&quot;); &#125; AspectLog(@&quot;Aspects: %@ is now aspect aware.&quot;, NSStringFromClass(klass));&#125; ä¸Šé¢çš„æ–¹æ³•å°±æ˜¯æŠŠè¦ Hook çš„ç›®æ ‡ Class çš„ forwardInvocation: æ··å†™äº†ï¼Œæ··å†™ä¹‹å forwardInvocation: çš„å…·ä½“å®ç°åœ¨ __ASPECTS_ARE_BEING_CALLED__ ä¸­ï¼Œé‡Œé¢èƒ½çœ‹åˆ° invoke æ ‡è¯†ä½çš„ä¸åŒæ˜¯å¦‚ä½•å®ç°çš„ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„å®ç°ç»†èŠ‚ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869// å®å®šä¹‰ï¼Œä»¥ä¾¿äºæˆ‘ä»¬æœ‰ä¸€ä¸ªæ›´æ˜æ™°çš„ stack trace#define aspect_invoke(aspects, info) \\for (AspectIdentifier *aspect in aspects) &#123;\\ [aspect invokeWithInfo:info];\\ if (aspect.options &amp; AspectOptionAutomaticRemoval) &#123; \\ aspectsToRemove = [aspectsToRemove?:@[] arrayByAddingObject:aspect]; \\ &#125; \\&#125;static void __ASPECTS_ARE_BEING_CALLED__(__unsafe_unretained NSObject *self, SEL selector, NSInvocation *invocation) &#123; // __unsafe_unretained NSObject *self ä¸è§£é‡Šäº† // æ–­è¨€ self, invocation NSCParameterAssert(self); NSCParameterAssert(invocation); // ä» invocation å¯ä»¥æ‹¿åˆ°å¾ˆå¤šä¸œè¥¿ï¼Œæ¯”å¦‚ originalSelector SEL originalSelector = invocation.selector; // originalSelector åŠ å‰ç¼€å¾—åˆ° aliasSelector SEL aliasSelector = aspect_aliasForSelector(invocation.selector); // ç”¨ aliasSelector æ›¿æ¢ invocation.selector invocation.selector = aliasSelector; // Instance çš„å®¹å™¨ AspectsContainer *objectContainer = objc_getAssociatedObject(self, aliasSelector); // Class çš„å®¹å™¨ AspectsContainer *classContainer = aspect_getContainerForClass(object_getClass(self), aliasSelector); AspectInfo *info = [[AspectInfo alloc] initWithInstance:self invocation:invocation]; NSArray *aspectsToRemove = nil; // Before hooks. aspect_invoke(classContainer.beforeAspects, info); aspect_invoke(objectContainer.beforeAspects, info); // Instead hooks. BOOL respondsToAlias = YES; if (objectContainer.insteadAspects.count || classContainer.insteadAspects.count) &#123; // å¦‚æœæœ‰ä»»ä½• insteadAspects å°±ç›´æ¥æ›¿æ¢äº† aspect_invoke(classContainer.insteadAspects, info); aspect_invoke(objectContainer.insteadAspects, info); &#125;else &#123; // å¦åˆ™æ­£å¸¸æ‰§è¡Œ // éå† invocation.target åŠå…¶ superClass æ‰¾åˆ°å®ä¾‹å¯ä»¥å“åº” aliasSelector çš„ç‚¹ invoke Class klass = object_getClass(invocation.target); do &#123; if ((respondsToAlias = [klass instancesRespondToSelector:aliasSelector])) &#123; [invocation invoke]; break; &#125; &#125;while (!respondsToAlias &amp;&amp; (klass = class_getSuperclass(klass))); &#125; // After hooks. aspect_invoke(classContainer.afterAspects, info); aspect_invoke(objectContainer.afterAspects, info); // å¦‚æœæ²¡æœ‰ hookï¼Œåˆ™æ‰§è¡ŒåŸå§‹å®ç°ï¼ˆé€šå¸¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼‰ if (!respondsToAlias) &#123; invocation.selector = originalSelector; SEL originalForwardInvocationSEL = NSSelectorFromString(AspectsForwardInvocationSelectorName); // å¦‚æœå¯ä»¥å“åº” originalForwardInvocationSELï¼Œè¡¨ç¤ºä¹‹å‰æ˜¯ replace method è€Œé add method if ([self respondsToSelector:originalForwardInvocationSEL]) &#123; ((void( *)(id, SEL, NSInvocation *))objc_msgSend)(self, originalForwardInvocationSEL, invocation); &#125;else &#123; [self doesNotRecognizeSelector:invocation.selector]; &#125; &#125; // ç§»é™¤ aspectsToRemove é˜Ÿåˆ—ä¸­çš„ AspectIdentifierï¼Œæ‰§è¡Œ remove [aspectsToRemove makeObjectsPerformSelector:@selector(remove)];&#125;#undef aspect_invoke Note: aspect_invoke å®å®šä¹‰çš„ä½œç”¨åŸŸã€‚ ä»£ç å®ç°å¯¹åº”äº† Hook çš„ AspectOptions å‚æ•°çš„ Beforeï¼ŒInstead å’Œ Afterã€‚ aspect_invoke ä¸­ aspectsToRemove æ˜¯ä¸€ä¸ª NSArrayï¼Œé‡Œé¢å®¹çº³ç€éœ€è¦è¢«é”€æˆ·çš„ Hookï¼Œå³ AspectIdentifierï¼ˆä¹‹åä¼šè°ƒç”¨ remove ç§»é™¤ï¼‰ã€‚ éå† invocation.target åŠå…¶ superClass æ‰¾åˆ°å®ä¾‹å¯ä»¥å“åº” aliasSelector çš„ç‚¹ invoke å®ç°ä»£ç ã€‚ Block HookAspects è®©æˆ‘ä»¬åœ¨æŒ‡å®š Class æˆ– Instance çš„ç‰¹å®š Selector æ‰§è¡Œæ—¶ï¼Œæ ¹æ® AspectOptions æ’å…¥æˆ‘ä»¬è‡ªå·±çš„ Block åš Hookï¼Œè€Œè¿™ä¸ª Block å†…éƒ¨æœ‰æˆ‘ä»¬æƒ³è¦çš„æœ‰å…³äºå½“å‰ Target å’Œ Selector çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Aspects æ˜¯æ€ä¹ˆåŠåˆ°çš„ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142- (BOOL)invokeWithInfo:(id&lt;AspectInfo&gt;)info &#123; NSInvocation *blockInvocation = [NSInvocation invocationWithMethodSignature:self.blockSignature]; NSInvocation *originalInvocation = info.originalInvocation; NSUInteger numberOfArguments = self.blockSignature.numberOfArguments; // åæ‰§ã€‚æˆ‘ä»¬å·²ç»åœ¨ hook æ³¨å†Œçš„æ—¶å€™æ£€æŸ¥è¿‡äº†ï¼Œï¼ˆä¸è¿‡è¿™é‡Œæˆ‘ä»¬è¿˜è¦æ£€æŸ¥ï¼‰ã€‚ if (numberOfArguments &gt; originalInvocation.methodSignature.numberOfArguments) &#123; AspectLogError(@&quot;Block has too many arguments. Not calling %@&quot;, info); return NO; &#125; // block çš„ `self` å°†ä¼šæ˜¯ AspectInfoã€‚å¯é€‰çš„ã€‚ if (numberOfArguments &gt; 1) &#123; [blockInvocation setArgument:&amp;info atIndex:1]; &#125; // ç®€å†å‚æ•°åˆ†é…å†…å­˜ argBuf ç„¶åä» originalInvocation å– argument èµ‹å€¼ç»™ blockInvocation void *argBuf = NULL; for (NSUInteger idx = 2; idx &lt; numberOfArguments; idx++) &#123; const char *type = [originalInvocation.methodSignature getArgumentTypeAtIndex:idx]; NSUInteger argSize; NSGetSizeAndAlignment(type, &amp;argSize, NULL); // reallocf ä¼˜ç‚¹ï¼Œå¦‚æœåˆ›å»ºå†…å­˜å¤±è´¥ä¼šè‡ªåŠ¨é‡Šæ”¾ä¹‹å‰çš„å†…å­˜ï¼Œè®²ç©¶ if (!(argBuf = reallocf(argBuf, argSize))) &#123; AspectLogError(@&quot;Failed to allocate memory for block invocation.&quot;); return NO; &#125; [originalInvocation getArgument:argBuf atIndex:idx]; [blockInvocation setArgument:argBuf atIndex:idx]; &#125; // æ‰§è¡Œ [blockInvocation invokeWithTarget:self.block]; // é‡Šæ”¾ argBuf if (argBuf != NULL) &#123; free(argBuf); &#125; return YES;&#125; è€ƒè™‘ä¸¤ä¸ªé—®é¢˜ï¼š [blockInvocation setArgument:&amp;info atIndex:1]; ä¸ºä»€ä¹ˆè¦åœ¨ç´¢å¼• 1 å¤„æ’å…¥å‘¢ï¼Ÿ for (NSUInteger idx = 2; idx &lt; numberOfArguments; idx++) ä¸ºä»€ä¹ˆè¦ä»ç´¢å¼• 2 å¼€å§‹éå†å‚æ•°å‘¢ï¼Ÿ å˜›~ å¦‚æœä½ å¯¹ Block çš„ Runtime ç»“æ„ä»¥åŠæ‰§è¡Œè¿‡ç¨‹ä¸‹æ–­ç‚¹ç ”ç©¶ä¸€ä¸‹å°±å…¨éƒ½æ˜ç™½äº†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦æœ‰ç–‘é—®å¯ä»¥è”ç³»æˆ‘ï¼ˆä¸çœŸæ­£å‹¤å¥‹å¥½å­¦çš„äººäº¤æµåˆæœ‰è°ä¼šä¸ä¹æ„å‘¢ï¼Ÿç¬‘~ï¼‰ ä¼˜ç§€ AOP åº“åº”è¯¥å…·å¤‡çš„ç‰¹è´¨ è‰¯å¥½çš„ä½¿ç”¨ä½“éªŒ å¯æ§ç²’åº¦å° ä½¿ç”¨ Block åš Hook æ”¯æŒæ’¤é”€ Hook å®‰å…¨æ€§ è‰¯å¥½çš„ä½¿ç”¨ä½“éªŒAspects ä½¿ç”¨ NSObject + Categroy çš„æ–¹å¼æä¾›æ¥å£ï¼Œéå¸¸å·§å¦™çš„æ¶µç›–äº† Instance å’Œ Classã€‚ Aspects æä¾›çš„æ¥å£ä¿æŒé«˜åº¦ä¸€è‡´ï¼ˆæœ¬ç€æ˜“ç”¨ï¼Œç®€å•ï¼Œæ–¹ä¾¿çš„åŸåˆ™è®¾è®¡æ¥å£å’Œæ•´ä¸ªæ¡†æ¶çš„å®ç°ä¼šè®©ä½ çš„å¼€æºé¡¹ç›®æ›´å®¹æ˜“è¢«äººä»¬æ¥çº³å’Œä½¿ç”¨ï¼‰ï¼š 123456789+ (id&lt;AspectToken&gt;)aspect_hookSelector:(SEL)selector withOptions:(AspectOptions)options usingBlock:(id)block error:(NSError **)error;- (id&lt;AspectToken&gt;)aspect_hookSelector:(SEL)selector withOptions:(AspectOptions)options usingBlock:(id)block error:(NSError **)error; Note: å…¶å®æ¥å£è¿™é‡Œå¯¹äº block çš„å‚æ•°è‡ªåŠ¨è¡¥å…¨å¯ä»¥æ›´è¿›ä¸€æ­¥ï¼Œä¸è¿‡ Aspects å½“åˆæ˜¯æ²¡æœ‰åŠæ³•åšåˆ°çš„ï¼Œå•ä»æ¥å£è®¾è®¡è¿™å—å·²ç»å¾ˆä¼˜ç§€äº†ã€‚ å¯æ§ç²’åº¦å°Aspects ä¸ä»…æ”¯æŒå¤§éƒ¨åˆ† AOP æ¡†æ¶åº”è¯¥åšåˆ°çš„å¯¹äº Class çš„ Hookï¼Œè¿˜æ”¯æŒç²’åº¦æ›´å°çš„ Instance Hookï¼Œè€Œå…¶åœ¨å†…éƒ¨å®ç°ä¸­ä¸ºäº†æ”¯æŒ Instance Hook æ‰€åšçš„ä»£ç ä¹Ÿéå¸¸å€¼å¾—æˆ‘ä»¬å‚è€ƒå’Œå­¦ä¹ ï¼ˆå·²åœ¨ä¸Šæ–‡ Aspects æ ¸å¿ƒä»£ç å‰–æ å¤„å•ç‹¬åˆ†æï¼‰ã€‚ ä¸ºä½¿ç”¨è€…æä¾›æ›´ä¸ºè‡ªç”±çš„ Hook æ–¹å¼ä»¥è¾¾åˆ°æ›´åŠ ç²¾å‡†çš„æ§åˆ¶æ˜¯æ¯ä¸ªä½¿ç”¨è€…ä¹äºè§åˆ°çš„äº‹ã€‚ ä½¿ç”¨ Block åš HookAspects ä½¿ç”¨ Block æ¥åš Hook åº”è¯¥è€ƒè™‘åˆ°äº†å¾ˆå¤šä¸œè¥¿ï¼Œæ”¯æŒä½¿ç”¨è€…é€šè¿‡åœ¨ Block ä¸­è·å–åˆ°ç›¸å…³çš„ä¿¡æ¯ï¼Œä¹¦å†™è‡ªå·±é¢å¤–çš„æ“ä½œå°±å¯ä»¥å®ç° Hook éœ€æ±‚ã€‚ æ”¯æŒæ’¤é”€ HookAspects è¿˜æ”¯æŒæ’¤é”€ä¹‹å‰åšçš„ Hook ä»¥åŠå·²æ··å†™çš„ Methodï¼Œä¸ºäº†å®ç°è¿™ä¸ªåŠŸèƒ½ Aspects è®¾è®¡äº†å…¨å±€å®¹å™¨ï¼ŒæŠŠ Hook å’Œæ··å†™ç”¨å…¨å±€å®¹å™¨åšè®°å½•ï¼Œè®©ä¸€åˆ‡éƒ½å¯ä»¥å¤åŸï¼Œè¿™ä¸æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„å—ï¼Ÿ å®‰å…¨æ€§å˜›~ æˆ‘ä»¬åœ¨å­¦ä¹  Runtime çš„æ—¶å€™ï¼Œå°±åº”è¯¥çœ‹åˆ°è¿‡ä¸å°‘æ–‡ç« è®²è§£ Method Swizzling è¦æ³¨æ„çš„å®‰å…¨æ€§é—®é¢˜ï¼Œç”±äºç”¨åˆ°äº†å¤§é‡ Runtime æ–¹æ³•ï¼ŒåŠ ä¸Š AOP æ˜¯é¢å‘æ•´ä¸ªåˆ‡é¢çš„ï¼Œæ‰€ä»¥ä¸€å•å‘ç°é—®é¢˜å°±ä¼šæ¯”è¾ƒä¸¥é‡ï¼Œæ¶‰åŠçš„é¢ä¼šæ¯”è¾ƒå¹¿ï¼Œè€Œä¸”éš¾ä»¥è°ƒè¯•ã€‚ Note: æˆ‘ä»¬ä¸èƒ½å› ä¸ºå®¹æ˜“é€ æˆé—®é¢˜å°±å¯ä»¥å›é¿ Method Swizzlingï¼Œå°±å¥½æ¯”å¤§å­¦è€å¸ˆè®²åˆ°é€’å½’æ—¶å¼ºè°ƒå®¹æ˜“å¼•èµ·å¾ªç¯è°ƒç”¨ï¼Œå¾ˆå¤šäººå°±åœ¨å†…å¿ƒå›é¿ä½¿ç”¨é€’å½’ï¼Œç”šè‡³äºéå¸¸é€‚åˆä½¿ç”¨é€’å½’æ¥å†™çš„ç®—æ³•é¢˜ï¼ˆè¿™é‡ŒæŒ‡é€’å½’æ¥å†™ä¼šæ˜“è¯»å†™ã€æ˜“ç»´æŠ¤ï¼‰åªä¼šç”¨å¤æ‚çš„æ–¹å¼æ¥æ€è€ƒã€‚ æ€»ç»“ æ–‡ç« ç®€å•ä»‹ç»äº† AOP çš„æ¦‚å¿µï¼Œå¸Œæœ›èƒ½ç»™å„ä½è¯»è€…å¯¹ AOP æ€æƒ³çš„ç†è§£æä¾›å¾®è–„çš„å¸®åŠ©ã€‚ æ–‡ç« ç³»ç»Ÿçš„å‰–æäº† Aspects å¼€æºåº“çš„å†…éƒ¨ç»“æ„ï¼Œå¸Œæœ›èƒ½è®©å¤§å®¶åœ¨æµè§ˆ Aspects æºç æ—¶å¿«é€Ÿå®šä½ä»£ç ä½ç½®ï¼Œæ‰¾åˆ°æ ¸å¿ƒå†…å®¹ã€‚ æ–‡ç« é‡ç‚¹åˆ†æäº† Aspects çš„æ ¸å¿ƒä»£ç ï¼Œæç‚¼äº†ä¸€äº›ç¬”è€…è®¤ä¸ºå€¼å¾—æ³¨æ„çš„ç‚¹ï¼Œä½†æ„¿å¯ä»¥åœ¨å¤§å®¶æ‰’æºç æ—¶æä¾›ä¸€äº›æŒ‡å¼•ã€‚ æ–‡ç« ç»“å°¾æ€»ç»“äº† Aspects ä½œä¸ºä¸€ä¸ªæ¯”è¾ƒä¼˜ç§€çš„ AOP æ‰€å…·å¤‡çš„ä¸€äº›ç‰¹è´¨ã€‚ æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜ https://lision.me/ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ ä¸ªäººåšå®¢ ä¸­æ›´æ–°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš @Lision è”ç³»æˆ‘~ å¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~"},{"title":"æ·±å…¥å‰–æ WebViewJavascriptBridge","comments":true,"permalink":"https://lision.me/webview_javascript_bridge/","text":"Emmmmmâ€¦è¿™ç¯‡æ–‡ç« å‘å¸ƒå‡ºæ¥å¯èƒ½æ­£é€¢åœ£è¯èŠ‚ğŸ„ï¼ŒMerry Christmas! å‰è¨€Web é¡µé¢ä¸­çš„ JS ä¸ iOS Native å¦‚ä½•äº¤äº’æ˜¯æ¯ä¸ª iOS çŒ¿å¿…é¡»æŒæ¡çš„æŠ€èƒ½ã€‚è€Œ JS å’Œ iOS Native å°±å¥½æ¯”ä¸¤å—æ²¡æœ‰äº¤é›†çš„å¤§é™†ï¼Œå¦‚æœæƒ³è¦ä½¿å®ƒä»¬ç›¸äº’é€šä¿¡å°±å¿…é¡»è¦å»ºç«‹ä¸€åº§â€œæ¡¥æ¢â€ã€‚ æ€è€ƒä¸€ä¸‹ï¼Œå¦‚æœé¡¹ç›®ç»„è®©ä½ å»é€ è¿™åº§â€œæ¡¥â€ï¼Œå¦‚ä½•æ‰èƒ½åšåˆ°æ—¢ä¼˜é›…åˆå®ç”¨ï¼Ÿ æœ¬æ–‡å°†ç»“åˆ WebViewJavascriptBridge æºç é€æ­¥å¸¦å¤§å®¶æ‰¾åˆ°ç­”æ¡ˆã€‚ WebViewJavascriptBridge æ˜¯ç››åå·²ä¹…çš„ JSBridge åº“ï¼Œæ—©åœ¨ 2011 å¹´å°±è¢«ä½œè€… Marcus Westin å‘å¸ƒåˆ° GitHubï¼Œç›´åˆ°ç°åœ¨ä½œè€…è¿˜åœ¨ç§¯æç»´æŠ¤ä¸­ï¼Œç›®å‰è¯¥é¡¹ç›®å·²æ”¶è·è¿‘ 1w star å’¯ï¼Œå…¶æºç éå¸¸å€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚ WebViewJavascriptBridge çš„ä»£ç é€»è¾‘æ¸…æ™°ï¼Œé£æ ¼è‰¯å¥½ï¼ŒåŠ ä¸Šè‡ªèº«ä»£ç é‡æ¯”è¾ƒå°ä½¿å¾—å…¶æºç é˜…è¯»éå¸¸è½»æ¾ï¼ˆå¯èƒ½éœ€è¦ä¸€äº› JS åŸºç¡€ï¼‰ã€‚æ›´åŠ éš¾èƒ½å¯è´µçš„æ˜¯å®ƒä»…ä½¿ç”¨äº†å°‘é‡ä»£ç å°±å®ç°äº†å¯¹äº Mac OS X çš„ WebView ä»¥åŠ iOS å¹³å°çš„ UIWebView å’Œ WKWebView ä¸‰ç§ç»„ä»¶çš„å®Œç¾æ”¯æŒã€‚ æˆ‘å¯¹ WebViewJavascriptBridge çš„è¯„ä»·æ˜¯å°è€Œç¾ï¼Œè¿™ç±»å°è€Œç¾çš„æºç éå¸¸åˆ©äºæˆ‘ä»¬å¯¹å…¶å®ç°æ€æƒ³çš„å­¦ä¹ ï¼ˆæœ¬æ–‡åˆ†æ WebViewJavascriptBridge æºç ç‰ˆæœ¬ä¸º v6.0.3ï¼‰ã€‚ å…³äº iOS ä¸ JS çš„åŸç”Ÿäº¤äº’çŸ¥è¯†ï¼Œä¹‹å‰æˆ‘æœ‰å†™è¿‡ä¸€ç¯‡æ–‡ç« ã€ŠiOS ä¸ JS äº¤äº’å¼€å‘çŸ¥è¯†æ€»ç»“ã€‹ï¼Œæ–‡ç« é™¤äº†ä»‹ç» JavaScriptCore åº“ä»¥åŠ UIWebView å’Œ WKWebView ä¸ JS åŸç”Ÿäº¤äº’çš„æ–¹æ³•ä¹‹å¤–è¿˜æå¸¦æåˆ°äº† Hybrid çš„å‘å±•ç®€å²ï¼Œæ–‡æœ«è¿˜æä¾›äº†ä¸€ä¸ª JS é€šè¿‡ Native è°ƒç”¨ iOS è®¾å¤‡æ‘„åƒå¤´çš„ Demoã€‚ æ‰€ä»¥è¿™ç¯‡æ–‡ç« ä¸ä¼šå†æŠŠé‡ç‚¹æ”¾åœ¨ iOS ä¸ JS çš„åŸç”Ÿäº¤äº’äº†ï¼Œæœ¬æ–‡æ—¨åœ¨ä»‹ç» WebViewJavascriptBridge çš„è®¾è®¡æ€è·¯å’Œå®ç°åŸç†ï¼Œå¯¹ iOS ä¸ JS åŸç”Ÿäº¤äº’çŸ¥è¯†æ„Ÿå…´è¶£çš„åŒå­¦æ¨èå»é˜…è¯»ä¸Šé¢æåˆ°çš„æ–‡ç« ï¼Œåº”è¯¥ä¼šæœ‰ç‚¹å„¿å¸®åŠ©ï¼ˆç¬‘ï¼‰ã€‚ ç´¢å¼• WebViewJavascriptBridge ç®€ä»‹ WebViewJavascriptBridge &amp;&amp; WKWebViewJavascriptBridge æ¢ç©¶ WebViewJavascriptBridgeBase - JS è°ƒç”¨ Native å®ç°åŸç†å‰–æ WebViewJavascriptBridge_JS - Native è°ƒç”¨ JS å®ç°è§£è¯» WebViewJavascriptBridge çš„â€œæ¡¥æ¢ç¾å­¦â€ æ–‡ç« æ€»ç»“ WebViewJavascriptBridge ç®€ä»‹ WebViewJavascriptBridge æ˜¯ç”¨äºåœ¨ WKWebViewï¼ŒUIWebView å’Œ WebView ä¸­çš„ Obj-C å’Œ JavaScript ä¹‹é—´å‘é€æ¶ˆæ¯çš„ iOS / OSX æ¡¥æ¥å™¨ã€‚ æœ‰è®¸å¤šä¸é”™çš„é¡¹ç›®éƒ½æœ‰ä½¿ç”¨ WebViewJavascriptBridgeï¼Œè¿™é‡Œç®€å•åˆ—ä¸€éƒ¨åˆ†ï¼ˆç¬‘ï¼‰ï¼š Facebook Messenger Facebook Paper ELSEWHERE â€¦ &amp; many more! å…³äº WebViewJavascriptBridge çš„å…·ä½“ä½¿ç”¨æ–¹æ³•è¯¦è§å…¶ GitHub é¡µé¢ã€‚ åœ¨è¯»å®Œ WebViewJavascriptBridge çš„æºç ä¹‹åæˆ‘å°†å…¶åˆ’åˆ†ä¸ºä¸‰ä¸ªå±‚çº§ï¼š å±‚çº§ æºæ–‡ä»¶ æ¥å£å±‚ WebViewJavascriptBridge &amp;&amp; WKWebViewJavascriptBridge å®ç°å±‚ WebViewJavascriptBridgeBase JS å±‚ WebViewJavascriptBridge_JS å…¶ä¸­ WebViewJavascriptBridge &amp;&amp; WKWebViewJavascriptBridge ä½œä¸ºæ¥å£å±‚ä¸»è¦è´Ÿè´£æä¾›æ–¹ä¾¿çš„æ¥å£ï¼Œéšè—å®ç°ç»†èŠ‚ï¼Œå…¶å®ç°ç»†èŠ‚éƒ½æ˜¯é€šè¿‡å®ç°å±‚ WebViewJavascriptBridgeBase å»åšçš„ï¼Œè€Œ WebViewJavascriptBridge_JS ä½œä¸º JS å±‚å…¶å®å­˜å‚¨äº†ä¸€æ®µ JS ä»£ç ï¼Œåœ¨éœ€è¦çš„æ—¶å€™æ³¨å…¥åˆ°å½“å‰ WebView ç»„ä»¶ä¸­ï¼Œæœ€ç»ˆå®ç° Native ä¸ JS çš„äº¤äº’ã€‚ WebViewJavascriptBridge &amp;&amp; WKWebViewJavascriptBridge æ¢ç©¶ WebViewJavascriptBridge å’Œ WKWebViewJavascriptBridge ä½œä¸ºæ¥å£å±‚åˆ†åˆ«å¯¹åº”äº UIWebView å’Œ WKWebView ç»„ä»¶ï¼Œæˆ‘ä»¬æ¥ç®€å•çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªæ–‡ä»¶æš´éœ²å‡ºçš„ä¿¡æ¯ï¼š WebViewJavascriptBridge æš´éœ²ä¿¡æ¯ï¼š 123456789101112131415@interface WebViewJavascriptBridge : WVJB_WEBVIEW_DELEGATE_INTERFACE+ (instancetype)bridgeForWebView:(id)webView; // åˆå§‹åŒ–+ (instancetype)bridge:(id)webView; // åˆå§‹åŒ–+ (void)enableLogging; // å¼€å¯æ—¥å¿—+ (void)setLogMaxLength:(int)length; // è®¾ç½®æ—¥å¿—æœ€å¤§é•¿åº¦- (void)registerHandler:(NSString*)handlerName handler:(WVJBHandler)handler; // æ³¨å†Œ handler (Native)- (void)removeHandler:(NSString*)handlerName; // åˆ é™¤ handler (Native)- (void)callHandler:(NSString*)handlerName data:(id)data responseCallback:(WVJBResponseCallback)responseCallback; // è°ƒç”¨ handler (JS)- (void)setWebViewDelegate:(id)webViewDelegate; // è®¾ç½® webViewDelegate- (void)disableJavscriptAlertBoxSafetyTimeout; // ç¦ç”¨ JS AlertBox çš„å®‰å…¨æ—¶é•¿æ¥åŠ é€Ÿæ¶ˆæ¯ä¼ é€’ï¼Œä¸æ¨èä½¿ç”¨@end WKWebViewJavascriptBridge æš´éœ²ä¿¡æ¯ï¼š 1234567891011121314// Emmmmm...è¿™é‡Œåº”è¯¥ä¸éœ€è¦æˆ‘æ³¨é‡Šäº†å§@interface WKWebViewJavascriptBridge : NSObject&lt;WKNavigationDelegate, WebViewJavascriptBridgeBaseDelegate&gt;+ (instancetype)bridgeForWebView:(WKWebView*)webView;+ (void)enableLogging;- (void)registerHandler:(NSString*)handlerName handler:(WVJBHandler)handler;- (void)removeHandler:(NSString*)handlerName;- (void)callHandler:(NSString*)handlerName data:(id)data responseCallback:(WVJBResponseCallback)responseCallback;- (void)reset;- (void)setWebViewDelegate:(id)webViewDelegate;- (void)disableJavscriptAlertBoxSafetyTimeout;@end Note: disableJavscriptAlertBoxSafetyTimeout æ–¹æ³•æ˜¯é€šè¿‡ç¦ç”¨ JS ç«¯ AlertBox çš„å®‰å…¨æ—¶é•¿æ¥åŠ é€Ÿç½‘æ¡¥æ¶ˆæ¯ä¼ é€’çš„ã€‚å¦‚æœæƒ³ä½¿ç”¨é‚£ä¹ˆéœ€è¦å’Œå‰ç«¯çº¦å®šå¥½ï¼Œå¦‚æœç¦ç”¨ä¹‹åå‰ç«¯ JS ä»£ç ä»æœ‰è°ƒç”¨ AlertBox ç›¸å…³ä»£ç ï¼ˆalert, confirm, æˆ– promptï¼‰åˆ™ç¨‹åºå°†è¢«æŒ‚èµ·ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•æ˜¯ä¸å®‰å…¨çš„ï¼Œå¦‚æ— ç‰¹æ®Šéœ€æ±‚ç¬”è€…ä¸æ¨èä½¿ç”¨ã€‚ å¯ä»¥çœ‹å¾—å‡ºæ¥è¿™ä¸¤ä¸ªæ–‡ä»¶æš´éœ²å‡ºçš„æ¥å£å‡ ä¹ä¸€è‡´ï¼Œå…¶ä¸­ WebViewJavascriptBridge ä¸­ä½¿ç”¨äº†å®å®šä¹‰ WVJB_WEBVIEW_DELEGATE_INTERFACE æ¥åˆ†åˆ«é€‚é… iOS å’Œ Mac OS X å¹³å°çš„ UIWebView å’Œ WebView ç»„ä»¶éœ€è¦å®ç°çš„ä»£ç†æ–¹æ³•ã€‚ WebViewJavascriptBridge ä¸­çš„å®å®šä¹‰å…¶å® WebViewJavascriptBridge ä¸­ä¸ºäº†é€‚é… iOS å’Œ Mac OS X å¹³å°çš„ UIWebView å’Œ WebView ç»„ä»¶ä½¿ç”¨äº†ä¸€ç³»åˆ—çš„å®å®šä¹‰ï¼Œå…¶æºç æ¯”è¾ƒç®€å•ï¼š 123456789101112#if defined __MAC_OS_X_VERSION_MAX_ALLOWED #define WVJB_PLATFORM_OSX #define WVJB_WEBVIEW_TYPE WebView #define WVJB_WEBVIEW_DELEGATE_TYPE NSObject&lt;WebViewJavascriptBridgeBaseDelegate&gt; #define WVJB_WEBVIEW_DELEGATE_INTERFACE NSObject&lt;WebViewJavascriptBridgeBaseDelegate, WebPolicyDelegate&gt;#elif defined __IPHONE_OS_VERSION_MAX_ALLOWED #import &lt;UIKit/UIWebView.h&gt; #define WVJB_PLATFORM_IOS #define WVJB_WEBVIEW_TYPE UIWebView #define WVJB_WEBVIEW_DELEGATE_TYPE NSObject&lt;UIWebViewDelegate&gt; #define WVJB_WEBVIEW_DELEGATE_INTERFACE NSObject&lt;UIWebViewDelegate, WebViewJavascriptBridgeBaseDelegate&gt;#endif åˆ†åˆ«æ ¹æ®æ‰€åœ¨å¹³å°ä¸åŒå®šä¹‰äº† WVJB_WEBVIEW_TYPEï¼ŒWVJB_WEBVIEW_DELEGATE_TYPE ä»¥åŠåˆšæ‰æåˆ°çš„ WVJB_WEBVIEW_DELEGATE_INTERFACE å®å®šä¹‰ï¼Œå¹¶ä¸”åˆ†åˆ«å®šä¹‰äº† WVJB_PLATFORM_OSX å’Œ WVJB_PLATFORM_IOS ä¾¿äºä¹‹åçš„å®ç°æºç åŒºåˆ†å½“å‰å¹³å°æ—¶ä½¿ç”¨ï¼Œä¸‹é¢çš„ supportsWKWebView å®å®šä¹‰ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼š 123#if (__MAC_OS_X_VERSION_MAX_ALLOWED &gt; __MAC_10_9 || __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= __IPHONE_7_1)#define supportsWKWebView#endif åœ¨å¼•å…¥å¤´æ–‡ä»¶çš„æ—¶å€™å¯ä»¥é€šè¿‡è¿™ä¸ª supportsWKWebView å®çµæ´»å¼•å…¥æ‰€éœ€çš„å¤´æ–‡ä»¶ï¼š 123456789// WebViewJavascriptBridge.h#if defined supportsWKWebView#import &lt;WebKit/WebKit.h&gt;#endif// WebViewJavascriptBridge.m#if defined(supportsWKWebView)#import &quot;WKWebViewJavascriptBridge.h&quot;#endif WebViewJavascriptBridge çš„å®ç°åˆ†ææˆ‘ä»¬æ¥ç€çœ‹ä¸€ä¸‹ WebViewJavascriptBridge çš„å®ç°éƒ¨åˆ†ï¼Œé¦–å…ˆä»å†…éƒ¨å˜é‡ä¿¡æ¯çœ‹èµ·ï¼š 123456789101112#if __has_feature(objc_arc_weak) #define WVJB_WEAK __weak#else #define WVJB_WEAK __unsafe_unretained#endif@implementation WebViewJavascriptBridge &#123; WVJB_WEAK WVJB_WEBVIEW_TYPE* _webView; // bridge å¯¹åº”çš„ WebView ç»„ä»¶ WVJB_WEAK id _webViewDelegate; // ç»™ WebView ç»„ä»¶è®¾ç½®çš„ä»£ç†ï¼ˆéœ€è¦çš„è¯ï¼‰ long _uniqueId; // å”¯ä¸€æ ‡è¯†ï¼ŒEmmmmm...ä½†æ˜¯æˆ‘å‘ç°æ²¡åµç”¨ï¼Œåªæœ‰ _base ä¸­çš„ _uniqueId æ‰æœ‰ç”¨ WebViewJavascriptBridgeBase *_base; // ä¸Šæ–‡è¯´è¿‡ï¼Œåº•å±‚å®ç°å…¶å®éƒ½æ˜¯ WebViewJavascriptBridgeBase åœ¨åš&#125; ä¸Šæ–‡æåˆ° WebViewJavascriptBridge å’Œ WKWebViewJavascriptBridge çš„ .h æ–‡ä»¶æš´éœ²æ¥å£ä¿¡æ¯éå¸¸ç›¸ä¼¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦ä¸è¦çœ‹çœ‹ WKWebViewJavascriptBridge çš„å†…éƒ¨å˜é‡ä¿¡æ¯å‘¢ï¼Ÿ 1234567// æ³¨é‡Šå‚è§ WebViewJavascriptBridge å°±å¥½@implementation WKWebViewJavascriptBridge &#123; __weak WKWebView* _webView; __weak id&lt;WKNavigationDelegate&gt; _webViewDelegate; long _uniqueId; WebViewJavascriptBridgeBase *_base;&#125; å˜›~ è¿™ä¿©è´§ç®€ç›´æ˜¯ä¸€ä¸ªå¦ˆç”Ÿçš„ã€‚å…¶å®è¿™æ˜¯ä½œè€…æ•…æ„ä¸ºä¹‹ï¼Œå› ä¸ºä½œè€…æƒ³å¯¹å¤–æä¾›ä¸€å¥—æ¥å£ï¼Œå³ WebViewJavascriptBridgeï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ WebViewJavascriptBridge å°±å¯ä»¥è‡ªåŠ¨æ ¹æ®ç»‘å®šçš„ WebView ç»„ä»¶çš„ä¸åŒç”Ÿæˆä¸ä¹‹å¯¹åº”çš„ JSBridge å®ä¾‹ã€‚ 123456789101112131415161718192021+ (instancetype)bridge:(id)webView &#123;// å¦‚æœæ”¯æŒ WKWebView#if defined supportsWKWebView // éœ€è¦å…ˆåˆ¤æ–­å½“å‰å…¥å‚ webView æ˜¯å¦ä»å±äº WKWebView if ([webView isKindOfClass:[WKWebView class]]) &#123; // è¿”å› WKWebViewJavascriptBridge å®ä¾‹ return (WebViewJavascriptBridge*) [WKWebViewJavascriptBridge bridgeForWebView:webView]; &#125;#endif // åˆ¤æ–­å½“å‰å…¥å‚ webView æ˜¯å¦ä»å±äº WebViewï¼ˆMac OS Xï¼‰æˆ–è€… UIWebViewï¼ˆiOSï¼‰ if ([webView isKindOfClass:[WVJB_WEBVIEW_TYPE class]]) &#123; // è¿”å› WebViewJavascriptBridge å®ä¾‹ WebViewJavascriptBridge* bridge = [[self alloc] init]; [bridge _platformSpecificSetup:webView]; return bridge; &#125; // æŠ›å‡º BadWebViewType å¼‚å¸¸å¹¶è¿”å› nil [NSException raise:@&quot;BadWebViewType&quot; format:@&quot;Unknown web view type.&quot;]; return nil;&#125; æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ä»£ç ï¼Œå®ç°å¹¶ä¸å¤æ‚ã€‚å¦‚æœæ”¯æŒ WKWebView çš„è¯ï¼ˆ#if defined supportsWKWebViewï¼‰åˆ™å»åˆ¤æ–­å½“å‰ç»‘å®šçš„ WebView ç»„ä»¶æ˜¯å¦ä»å±äº WKWebViewï¼Œè¿™æ ·å¯ä»¥è¿”å› WKWebViewJavascriptBridge å®ä¾‹ï¼Œå¦åˆ™è¿”å› WebViewJavascriptBridge å®ä¾‹ï¼Œæœ€åå¦‚æœå…¥å‚ webView çš„ç±»å‹ä¸æ»¡è¶³åˆ¤æ–­æ¡ä»¶åˆ™æŠ›å‡º BadWebViewType å¼‚å¸¸ã€‚ è¿˜æœ‰ä¸€ä¸ªå…³äº _webViewDelegate çš„å°ç»†èŠ‚ï¼Œæœ¬æ¥ä¸æ‰“ç®—è®²çš„ï¼Œä½†æ˜¯è¿˜æ˜¯æä¸€ä¸‹å§ï¼ˆå›§ï¼‰ã€‚å…¶å®åœ¨ WebViewJavascriptBridge ä»¥åŠ WKWebViewJavascriptBridge çš„åˆå§‹åŒ–å®ç°è¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠå½“å‰ WebView ç»„ä»¶çš„ä»£ç†ç»‘å®šä¸ºè‡ªå·±ï¼š 123456789101112131415// WebViewJavascriptBridge- (void) _platformSpecificSetup:(WVJB_WEBVIEW_TYPE*)webView &#123; _webView = webView; _webView.delegate = self; _base = [[WebViewJavascriptBridgeBase alloc] init]; _base.delegate = self;&#125;// WKWebViewJavascriptBridge- (void) _setupInstance:(WKWebView*)webView &#123; _webView = webView; _webView.navigationDelegate = self; _base = [[WebViewJavascriptBridgeBase alloc] init]; _base.delegate = self;&#125; Note: æ›¿æ¢ç»„ä»¶çš„ä»£ç†å°†å…¶ä»£ç†ç»‘å®šä¸º bridge è‡ªå·±æ˜¯å› ä¸º WebViewJavascriptBridge çš„å®ç°åŸç†ä¸Šæ˜¯åˆ©ç”¨æˆ‘ä¹‹å‰çš„æ–‡ç« ã€ŠiOS ä¸ JS äº¤äº’å¼€å‘çŸ¥è¯†æ€»ç»“ã€‹ä¸­è®²è¿‡çš„å‡ Request æ–¹æ³•å®ç°çš„ï¼Œæ‰€ä»¥éœ€è¦ç›‘å¬ WebView ç»„ä»¶çš„ä»£ç†æ–¹æ³•è·å–åŠ è½½ä¹‹å‰çš„ Request.URL å¹¶åšå¤„ç†ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ WebViewJavascriptBridge æä¾›äº†ä¸€ä¸ªæ¥å£ setWebViewDelegate: å­˜å‚¨äº†ä¸€ä¸ªé€»è¾‘ä¸Šçš„ _webViewDelegateï¼Œè¿™ä¸ª _webViewDelegate ä¹Ÿéœ€è¦éµå¾ª WebView ç»„ä»¶çš„ä»£ç†åè®®ï¼Œè¿™æ ·åœ¨ WebViewJavascriptBridge å†…éƒ¨ä¸åŒçš„ä»£ç†æ–¹æ³•ä¸­åšå®Œ bridge è¦åšçš„äº‹æƒ…åªæœ‰å°±ä¼šå†å»è°ƒç”¨ _webViewDelegate å¯¹åº”çš„ä»£ç†æ–¹æ³•ï¼Œå…¶å®å¯ä»¥ç†è§£ä¸º WebViewJavascriptBridge å¯¹å½“å‰ WebView ç»„ä»¶çš„ä»£ç†åšäº† hookã€‚ å¯¹äº WebViewJavascriptBridge ä¸­æš´éœ²çš„åˆå§‹åŒ–ä»¥å¤–çš„æ‰€æœ‰æ¥å£ï¼Œå…¶å†…éƒ¨å®ç°éƒ½æ˜¯é€šè¿‡ WebViewJavascriptBridgeBase æ¥å®ç°çš„ã€‚è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯å³ä½¿ WebViewJavascriptBridge å› ä¸ºç»‘å®šäº† WKWebView è¿”å›äº† WKWebViewJavascriptBridge å®ä¾‹ï¼Œåªè¦æ¥å£ä¸€è‡´ï¼Œå¯¹ JSBridge å‘é€ç›¸åŒçš„æ¶ˆæ¯ï¼Œå°±ä¼šæœ‰ç›¸åŒçš„å®ç°ï¼ˆéƒ½æ˜¯ç”± WebViewJavascriptBridgeBase ç±»å®ç°çš„ï¼‰ã€‚ WebViewJavascriptBridgeBase - JS è°ƒç”¨ Native å®ç°åŸç†å‰–æ ä½œä¸º WebViewJavascriptBridge çš„å®ç°å±‚ï¼ŒWebViewJavascriptBridgeBase çš„å‘½åä¹Ÿå¯ä»¥ä½“ç°å‡ºå…¶æ˜¯ä½œä¸ºæ•´åº§â€œæ¡¥æ¢â€æ¡¥å¢©ä¸€èˆ¬çš„å­˜åœ¨ï¼Œæˆ‘ä»¬è¿˜æ˜¯æŒ‰ç…§è€è§„çŸ©å…ˆçœ‹ä¸€ä¸‹ WebViewJavascriptBridgeBase.h æš´éœ²çš„ä¿¡æ¯ï¼Œå¥½å¯¹å…¶æœ‰ä¸€ä¸ªæ•´ä½“çš„å°è±¡ï¼š 12345678910111213141516171819202122232425262728293031typedef void (^WVJBResponseCallback)(id responseData); // å›è°ƒ blocktypedef void (^WVJBHandler)(id data, WVJBResponseCallback responseCallback); // æ³¨å†Œçš„ Handler blocktypedef NSDictionary WVJBMessage; // æ¶ˆæ¯ç±»å‹ - å­—å…¸@protocol WebViewJavascriptBridgeBaseDelegate &lt;NSObject&gt;- (NSString*) _evaluateJavascript:(NSString*)javascriptCommand;@end@interface WebViewJavascriptBridgeBase : NSObject@property (weak, nonatomic) id &lt;WebViewJavascriptBridgeBaseDelegate&gt; delegate; // ä»£ç†ï¼ŒæŒ‡å‘æ¥å£å±‚ç±»ï¼Œç”¨ä»¥ç»™å¯¹åº”æ¥å£ç»‘å®šçš„ WebView ç»„ä»¶å‘é€æ‰§è¡Œ JS æ¶ˆæ¯@property (strong, nonatomic) NSMutableArray* startupMessageQueue; // å¯åŠ¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯ä»¥ç†è§£ä¸ºå­˜æ”¾ WVJBMessage@property (strong, nonatomic) NSMutableDictionary* responseCallbacks; // å›è°ƒ blocks å­—å…¸ï¼Œå­˜æ”¾ WVJBResponseCallback ç±»å‹çš„ block@property (strong, nonatomic) NSMutableDictionary* messageHandlers; // å·²æ³¨å†Œçš„ handlers å­—å…¸ï¼Œå­˜æ”¾ WVJBHandler ç±»å‹çš„ block@property (strong, nonatomic) WVJBHandler messageHandler; // æ²¡åµç”¨+ (void)enableLogging; // å¼€å¯æ—¥å¿—+ (void)setLogMaxLength:(int)length; // è®¾ç½®æ—¥å¿—æœ€å¤§é•¿åº¦- (void)reset; // å¯¹åº” WKJSBridge çš„ reset æ¥å£- (void)sendData:(id)data responseCallback:(WVJBResponseCallback)responseCallback handlerName:(NSString*)handlerName; // å‘é€æ¶ˆæ¯ï¼Œå…¥å‚ä¾æ¬¡æ˜¯å‚æ•°ï¼Œå›è°ƒ blockï¼Œå¯¹åº” JS ç«¯æ³¨å†Œçš„ HandlerName- (void)flushMessageQueue:(NSString *)messageQueueString; // åˆ·æ–°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ ¸å¿ƒä»£ç - (void)injectJavascriptFile; // æ³¨å…¥ JS- (BOOL)isWebViewJavascriptBridgeURL:(NSURL*)url; // åˆ¤å®šæ˜¯å¦ä¸º WebViewJavascriptBridgeURL- (BOOL)isQueueMessageURL:(NSURL*)urll; // åˆ¤å®šæ˜¯å¦ä¸ºé˜Ÿåˆ—æ¶ˆæ¯ URL- (BOOL)isBridgeLoadedURL:(NSURL*)urll; // åˆ¤å®šæ˜¯å¦ä¸º bridge è½½å…¥ URL- (void)logUnkownMessage:(NSURL*)url; // æ‰“å°æ”¶åˆ°æœªçŸ¥æ¶ˆæ¯ä¿¡æ¯- (NSString *)webViewJavascriptCheckCommand; // JS bridge æ£€æµ‹å‘½ä»¤- (NSString *)webViewJavascriptFetchQueyCommand; // JS bridge è·å–æŸ¥è¯¢å‘½ä»¤- (void)disableJavscriptAlertBoxSafetyTimeout; // ç¦ç”¨ JS AlertBox å®‰å…¨æ—¶é•¿ä»¥è·å–å‘é€æ¶ˆæ¯é€Ÿåº¦æå‡ï¼Œä¸å»ºè®®ä½¿ç”¨ï¼Œç†ç”±è§ä¸Šæ–‡@end å˜›~ ä» .h æ–‡ä»¶ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•´ä¸ª WebViewJavascriptBridgeBase æ‰€æš´éœ²å‡ºæ¥çš„ä¿¡æ¯ï¼Œå±æ€§å±‚é¢ä¸Šéœ€è¦å¯¹ä»¥ä¸‹ 4 ä¸ªå±æ€§åŠ æ·±å°è±¡ï¼Œä¹‹ååˆ†æå®ç°çš„è¿‡ç¨‹ä¸­ä¼šå¸¦å…¥è¿™äº›å±æ€§ï¼š id &lt;WebViewJavascriptBridgeBaseDelegate&gt; delegate ä»£ç†ï¼Œå¯ä»¥é€šè¿‡ä»£ç†è®©å½“å‰ bridge ç»‘å®šçš„ WebView ç»„ä»¶æ‰§è¡Œ JS ä»£ç  NSMutableArray* startupMessageQueue; å¯åŠ¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå­˜æ”¾ Obj-C å‘é€ç»™ JS çš„æ¶ˆæ¯ï¼ˆå¯ä»¥ç†è§£ä¸ºå­˜æ”¾ WVJBMessage ç±»å‹ï¼‰ NSMutableDictionary* responseCallbacks; å›è°ƒ blocks å­—å…¸ï¼Œå­˜æ”¾ WVJBResponseCallback ç±»å‹çš„ block NSMutableDictionary* messageHandlers; Obj-C ç«¯å·²æ³¨å†Œçš„ handlers å­—å…¸ï¼Œå­˜æ”¾ WVJBHandler ç±»å‹çš„ block Emmmmmâ€¦æ¥å£å±‚é¢çœ‹ä¸€ä¸‹æ³¨é‡Šå°±å¥½äº†ï¼Œåé¢åˆ†æå®ç°çš„æ—¶å€™ä¼šæå¸¦è®²è§£ä¸€äº›æ¥å£ï¼Œå‰©ä¸‹ä¸€äº›è·Ÿå®ç°æ— å…³çš„æ¥å£å†…å®¹æ„Ÿå…´è¶£çš„åŒå­¦æ¨èè‡ªå·±æ‰’æºç å“ˆã€‚ æˆ‘ä»¬åœ¨å¯¹ WebViewJavascriptBridgeBase æ•´ä½“æœ‰äº†ä¸€ä¸ªåˆå§‹å°è±¡ä¹‹åå°±å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªé¡µé¢ï¼Œç®€å•çš„åµŒå…¥ä¸€äº› JS è·‘ä¸€éæµç¨‹ï¼Œåœ¨ä¸­é—´ä¸‹æ–­ç‚¹æ‰’æºç ï¼Œè¿™æ ·æˆ‘ä»¬å¯¹äº Native ä¸ JS çš„äº¤äº’æµç¨‹å°±å¯ä»¥ä¸€æ¸…äºŒæ¥šäº†ã€‚ ä¸‹é¢æ¨¡æ‹Ÿä¸€é JS é€šè¿‡ WebViewJavascriptBridge è°ƒç”¨ Native åŠŸèƒ½çš„æµç¨‹åˆ†æ WebViewJavascriptBridgeBase çš„ç›¸å…³å®ç°ï¼ˆè€ƒè™‘ç°åœ¨çš„æ—¶é—´ç‚¹å†³å®šä»¥ WKWebView ä¸ºä¾‹è®²è§£ï¼Œå³é’ˆå¯¹ WKWebViewJavascriptBridge æºç è®²è§£ï¼‰ï¼š 1.ç›‘å¬å‡ Request å¹¶æ³¨å…¥ WebViewJavascriptBridge_JS å†…çš„ JS ä»£ç ä¸Šæ–‡è¯´åˆ° WebViewJavascriptBridge çš„å®ç°å…¶å®æœ¬è´¨ä¸Šæ˜¯åˆ©ç”¨äº†æˆ‘ä¹‹å‰çš„æ–‡ç« ã€ŠiOS ä¸ JS äº¤äº’å¼€å‘çŸ¥è¯†æ€»ç»“ã€‹ä¸­è®²è¿‡çš„å‡ Request æ–¹æ³•å®ç°çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä»ç›‘å¬å‡ Request å¼€å§‹è®²èµ·å§ã€‚ 123456789101112131415161718192021222324252627282930// WKNavigationDelegate åè®®æ–¹æ³•ï¼Œç”¨äºç›‘å¬ Request å¹¶å†³å®šæ˜¯å¦å…è®¸å¯¼èˆª- (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler &#123; // webView æ ¡éªŒ if (webView != _webView) &#123; return; &#125; NSURL *url = navigationAction.request.URL; __strong typeof(_webViewDelegate) strongDelegate = _webViewDelegate; // æ ¸å¿ƒä»£ç  if ([_base isWebViewJavascriptBridgeURL:url]) &#123; // åˆ¤å®š WebViewJavascriptBridgeURL if ([_base isBridgeLoadedURL:url]) &#123; // åˆ¤å®š BridgeLoadedURL // æ³¨å…¥ JS ä»£ç  [_base injectJavascriptFile]; &#125; else if ([_base isQueueMessageURL:url]) &#123; // åˆ¤å®š QueueMessageURL // åˆ·æ–°æ¶ˆæ¯é˜Ÿåˆ— [self WKFlushMessageQueue]; &#125; else &#123; // è®°å½•æœªçŸ¥ bridge msg æ—¥å¿— [_base logUnkownMessage:url]; &#125; decisionHandler(WKNavigationActionPolicyCancel); return; &#125; // è°ƒç”¨ _webViewDelegate å¯¹åº”çš„ä»£ç†æ–¹æ³• if (strongDelegate &amp;&amp; [strongDelegate respondsToSelector:@selector(webView:decidePolicyForNavigationAction:decisionHandler:)]) &#123; [_webViewDelegate webView:webView decidePolicyForNavigationAction:navigationAction decisionHandler:decisionHandler]; &#125; else &#123; decisionHandler(WKNavigationActionPolicyAllow); &#125;&#125; Note: ä¹‹å‰è¯´è¿‡ WebViewJavascriptBridge ä¼š hook ç»‘å®šçš„ WebView çš„ä»£ç†æ–¹æ³•ï¼Œè¿™ä¸€ç‚¹ WKWebViewJavascriptBridge ä¹Ÿä¸€æ ·ï¼Œåœ¨åŠ å…¥è‡ªå·±çš„ä»£ç ä¹‹åä¼šåˆ¤æ–­æ˜¯å¦æœ‰ _webViewDelegate å“åº”è¿™ä¸ªä»£ç†æ–¹æ³•ï¼Œå¦‚æœæœ‰åˆ™è°ƒç”¨ã€‚ æˆ‘ä»¬è¿˜æ˜¯æŠŠæ³¨æ„åŠ›æ”¾åˆ°æ³¨é‡Šä¸­æ ¸å¿ƒä»£ç çš„ä½ç½®ï¼Œé‡Œé¢ä¼šå…ˆåˆ¤æ–­å½“å‰ url æ˜¯å¦ä¸º bridge urlï¼š 12345// ç›¸å…³å®å®šä¹‰#define kOldProtocolScheme @&quot;wvjbscheme&quot;#define kNewProtocolScheme @&quot;https&quot;#define kQueueHasMessage @&quot;__wvjb_queue_message__&quot;#define kBridgeLoaded @&quot;__bridge_loaded__&quot; WebViewJavascriptBridge GitHub é¡µé¢ çš„ä½¿ç”¨æ–¹æ³•ä¸­ç¬¬ 4 æ­¥æ˜ç¡®æŒ‡å‡ºè¦å¤åˆ¶ç²˜è´´ setupWebViewJavascriptBridge æ–¹æ³•åˆ°å‰æ®µ JS ä¸­ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹è¿™æ®µ JS æ–¹æ³•æºç ï¼š 1234567891011121314function setupWebViewJavascriptBridge(callback) &#123; if (window.WebViewJavascriptBridge) &#123; return callback(WebViewJavascriptBridge); &#125; if (window.WVJBCallbacks) &#123; return window.WVJBCallbacks.push(callback); &#125; window.WVJBCallbacks = [callback]; // åˆ›å»ºä¸€ä¸ª iframe var WVJBIframe = document.createElement(&#x27;iframe&#x27;); // è®¾ç½® iframe ä¸ºä¸æ˜¾ç¤º WVJBIframe.style.display = &#x27;none&#x27;; // å°† iframe çš„ src ç½®ä¸º &#x27;https://__bridge_loaded__&#x27; WVJBIframe.src = &#x27;https://__bridge_loaded__&#x27;; // å°† iframe åŠ å…¥åˆ° document.documentElement document.documentElement.appendChild(WVJBIframe); setTimeout(function() &#123; document.documentElement.removeChild(WVJBIframe) &#125;, 0)&#125; ä¸Šé¢çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ªä¸æ˜¾ç¤ºçš„ iframe å¹¶å°†å…¶ src ç½®ä¸º https://__bridge_loaded__ï¼Œä¸ä¸Šæ–‡ä¸­ kBridgeLoaded å®å®šä¹‰ä¸€è‡´ï¼Œå³ç”¨äº isBridgeLoadedURL: æ–¹æ³•ä¸­åˆ¤å®šå½“å‰ url æ˜¯å¦ä¸º BridgeLoadedURLã€‚ Note: å‡ Request çš„å‘èµ·æœ‰ä¸¤ç§æ–¹å¼ï¼Œ-1:location.href -2:iframeã€‚é€šè¿‡ location.href æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚æœ JS å¤šæ¬¡è°ƒç”¨åŸç”Ÿçš„æ–¹æ³•ä¹Ÿå°±æ˜¯ location.href çš„å€¼å¤šæ¬¡å˜åŒ–ï¼ŒNative ç«¯åªèƒ½æ¥å—åˆ°æœ€åä¸€æ¬¡è¯·æ±‚ï¼Œå‰é¢çš„è¯·æ±‚ä¼šè¢«å¿½ç•¥æ‰ï¼Œæ‰€ä»¥è¿™é‡Œ WebViewJavascriptBridge é€‰æ‹©ä½¿ç”¨ iframeï¼Œåé¢ä¸å†è§£é‡Šã€‚ å› ä¸ºåŠ å…¥äº† src ä¸º https://__bridge_loaded__ çš„ iframe å…ƒç´ ï¼Œæˆ‘ä»¬ä¸Šé¢æˆªè· url çš„ä»£ç†æ–¹æ³•å°±ä¼šæ‹¿åˆ°ä¸€ä¸ª https://__bridge_loaded__ çš„ urlï¼Œç”±äº https æ»¡è¶³åˆ¤å®š WebViewJavascriptBridgeURLï¼Œå°†ä¼šè¿›å…¥æ ¸å¿ƒä»£ç åŒºåŸŸæ¥ç€ä¼šè¢«åˆ¤å®šä¸º BridgeLoadedURL æ‰§è¡Œæ³¨å…¥ JS ä»£ç çš„æ–¹æ³•ï¼Œå³ [_base injectJavascriptFile];ã€‚ 1234567891011121314- (void)injectJavascriptFile &#123; // è·å–åˆ° WebViewJavascriptBridge_JS çš„ä»£ç  NSString *js = WebViewJavascriptBridge_js(); // å°†è·å–åˆ°çš„ js é€šè¿‡ä»£ç†æ–¹æ³•æ³¨å…¥åˆ°å½“å‰ç»‘å®šçš„ WebView ç»„ä»¶ [self _evaluateJavascript:js]; // å¦‚æœå½“å‰å·²æœ‰æ¶ˆæ¯é˜Ÿåˆ—åˆ™éå†å¹¶åˆ†å‘æ¶ˆæ¯ï¼Œä¹‹åæ¸…ç©ºæ¶ˆæ¯é˜Ÿåˆ— if (self.startupMessageQueue) &#123; NSArray* queue = self.startupMessageQueue; self.startupMessageQueue = nil; for (id queuedMessage in queue) &#123; [self _dispatchMessage:queuedMessage]; &#125; &#125;&#125; è‡³æ­¤ï¼Œç¬¬ä¸€æ­¥äº¤äº’å·²å®Œæˆã€‚å…³äº WebViewJavascriptBridge_JS å†…éƒ¨çš„ JS ä»£ç æˆ‘ä»¬æ”¾åˆ°åé¢çš„ç« èŠ‚è§£è¯»ï¼Œç°åœ¨å¯ä»¥ç®€å•ç†è§£ä¸º WebViewJavascriptBridge åœ¨ JS ç«¯çš„å…·ä½“å®ç°ä»£ç ã€‚ 2.JS ç«¯è°ƒç”¨ callHandler æ–¹æ³•ä¹‹å Native ç«¯ç©¶ç«Ÿæ˜¯å¦‚ä½•å“åº”çš„ï¼ŸWebViewJavascriptBridge GitHub é¡µé¢ ä¸­æŒ‡å‡º JS ç«¯çš„æ“ä½œæ–¹å¼ï¼š 123456789101112setupWebViewJavascriptBridge(function(bridge) &#123; /* Initialize your app here */ bridge.registerHandler(&#x27;JS Echo&#x27;, function(data, responseCallback) &#123; console.log(&quot;JS Echo called with:&quot;, data) responseCallback(data) &#125;) bridge.callHandler(&#x27;ObjC Echo&#x27;, &#123;&#x27;key&#x27;:&#x27;value&#x27;&#125;, function responseCallback(responseData) &#123; console.log(&quot;JS received response:&quot;, responseData) &#125;)&#125;) æˆ‘ä»¬çŸ¥é“ JS ç«¯è°ƒç”¨ setupWebViewJavascriptBridge æ–¹æ³•ä¼šèµ°æˆ‘ä»¬åˆšæ‰åˆ†æè¿‡çš„ç¬¬ä¸€æ­¥ï¼Œå³ç›‘å¬å‡ Request å¹¶æ³¨å…¥ WebViewJavascriptBridge_JS å†…çš„ JS ä»£ç ã€‚é‚£ä¹ˆå½“ JS ç«¯è°ƒç”¨ bridge.callHandler æ—¶ï¼ŒNative ç«¯ç©¶ç«Ÿæ˜¯å¦‚ä½•åšå‡ºå“åº”çš„å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬éœ€è¦å…ˆç¨å¾®è§£è¯»ä¸€ä¸‹ä¹‹å‰æ³¨å…¥çš„ WebViewJavascriptBridge_JS ä¸­çš„ JS ä»£ç ï¼š 123456789101112131415161718192021222324// è°ƒç”¨ iOS handlerï¼Œå‚æ•°æ ¡éªŒä¹‹åè°ƒç”¨ _doSend å‡½æ•°function callHandler(handlerName, data, responseCallback) &#123; if (arguments.length == 2 &amp;&amp; typeof data == &#x27;function&#x27;) &#123; responseCallback = data; data = null; &#125; _doSend(&#123; handlerName:handlerName, data:data &#125;, responseCallback);&#125;// å¦‚æœ‰å›è°ƒï¼Œåˆ™è®¾ç½® message[&#x27;callbackId&#x27;] ä¸ responseCallbacks[callbackId]// å°† msg åŠ å…¥ sendMessageQueue æ•°ç»„ï¼Œè®¾ç½® messagingIframe.srcfunction _doSend(message, responseCallback) &#123; if (responseCallback) &#123; var callbackId = &#x27;cb_&#x27;+(uniqueId++)+&#x27;_&#x27;+new Date().getTime(); responseCallbacks[callbackId] = responseCallback; message[&#x27;callbackId&#x27;] = callbackId; &#125; sendMessageQueue.push(message); messagingIframe.src = CUSTOM_PROTOCOL_SCHEME + &#x27;://&#x27; + QUEUE_HAS_MESSAGE;&#125; // scheme ä½¿ç”¨ https ä¹‹åé€šè¿‡ host åšåŒ¹é…var CUSTOM_PROTOCOL_SCHEME = &#x27;https&#x27;;var QUEUE_HAS_MESSAGE = &#x27;__wvjb_queue_message__&#x27;; å¯ä»¥çœ‹åˆ° JS ç«¯çš„ä»£ç ä¸­æœ‰ callHandler å‡½æ•°çš„å®ç°ï¼Œå…¶å†…éƒ¨å°†å…¥å‚ handlerName ä»¥åŠ data ä»¥å­—å…¸å½¢å¼ä½œä¸ºå‚æ•°è°ƒç”¨ _doSend æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ _doSend æ–¹æ³•çš„å®ç°ï¼š _doSend æ–¹æ³•å†…éƒ¨ä¼šå…ˆåˆ¤æ–­å…¥å‚ä¸­æ˜¯å¦æœ‰å›è°ƒ å¦‚æœæœ‰å›è°ƒåˆ™æ ¹æ®è§„åˆ™ç”Ÿæˆ callbackId å¹¶ä¸”å°†å›è°ƒ block ä¿å­˜åˆ° responseCallbacks å­—å…¸ï¼ˆå›§~ JS ä¸å«å­—å…¸çš„ï¼Œæˆ‘æ˜¯ä¸ºäº† iOS è¯»è€…çœ‹ç€æ–¹ä¾¿ï¼‰ï¼Œä¹‹åç»™æ¶ˆæ¯ä¹ŸåŠ å…¥ä¸€ä¸ªé”®å€¼å¯¹ä¿å­˜åˆšæ‰ç”Ÿæˆçš„ callbackId ä¹‹åç»™ sendMessageQueue é˜Ÿåˆ—åŠ å…¥ message å°† messagingIframe.src è®¾ç½®ä¸º https://__wvjb_queue_message__ å¥½ï¼Œç‚¹åˆ°ä¸ºæ­¢ï¼Œå¯¹äº WebViewJavascriptBridge_JS å†…çš„ JS ç«¯å…¶ä»–æºç æˆ‘ä»¬æ”¾ç€åé¢çœ‹ã€‚æ³¨æ„è¿™é‡ŒåŠ å…¥äº†ä¸€ä¸ª src ä¸º https://__wvjb_queue_message__ çš„ messagingIframeï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªä¸å¯è§çš„ iframeã€‚è¿™æ · Native ç«¯ä¼šæ”¶åˆ°ä¸€ä¸ª url ä¸º https://__wvjb_queue_message__ çš„ requestï¼Œå›åˆ°ç¬¬ 1 æ­¥ä¸­è·å–åˆ°å‡çš„ request ä¹‹åä¼šè¿›è¡Œå„é¡¹åˆ¤å®šï¼Œè¿™æ¬¡ä¼šæ»¡è¶³ [_base isQueueMessageURL:url] çš„åˆ¤å®šè°ƒç”¨ Native çš„ WKFlushMessageQueue æ–¹æ³•ã€‚ 1234567891011121314- (void)WKFlushMessageQueue &#123; // æ‰§è¡Œ WebViewJavascriptBridge._fetchQueue(); æ–¹æ³• [_webView evaluateJavaScript:[_base webViewJavascriptFetchQueyCommand] completionHandler:^(NSString* result, NSError* error) &#123; if (error != nil) &#123; NSLog(@&quot;WebViewJavascriptBridge: WARNING: Error when trying to fetch data from WKWebView: %@&quot;, error); &#125; // åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨ [_base flushMessageQueue:result]; &#125;];&#125;- (NSString *)webViewJavascriptFetchQueyCommand &#123; return @&quot;WebViewJavascriptBridge._fetchQueue();&quot;;&#125; å¯è§ Native ç«¯ä¼šåœ¨åˆ·æ–°é˜Ÿåˆ—ä¸­è°ƒç”¨ JS ç«¯çš„ WebViewJavascriptBridge._fetchQueue(); æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ JS ç«¯æ­¤æ–¹æ³•çš„å…·ä½“å®ç°ï¼š 123456789// è·å–é˜Ÿåˆ—ï¼Œåœ¨ iOS ç«¯åˆ·æ–°æ¶ˆæ¯é˜Ÿåˆ—æ—¶ä¼šè°ƒç”¨æ­¤å‡½æ•°function _fetchQueue() &#123; // å°† sendMessageQueue è½¬ä¸º JSON æ ¼å¼ var messageQueueString = JSON.stringify(sendMessageQueue); // é‡ç½® sendMessageQueue sendMessageQueue = []; // è¿”å› JSON æ ¼å¼çš„ return messageQueueString;&#125; è¿™ä¸ªæ–¹æ³•ä¼šæŠŠå½“å‰ JS ç«¯ sendMessageQueue æ¶ˆæ¯é˜Ÿåˆ—ä»¥ JSON çš„å½¢å¼è¿”å›ï¼Œè€Œ Native ç«¯ä¼šè°ƒç”¨ [_base flushMessageQueue:result]; å°†æ‹¿åˆ°çš„ JSON å½¢å¼æ¶ˆæ¯é˜Ÿåˆ—ä½œä¸ºå‚æ•°è°ƒç”¨ flushMessageQueue: æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯æ•´ä¸ªæ¡†æ¶ Native ç«¯çš„ç²¾åæ‰€åœ¨ï¼Œå°±æ˜¯ç¨å¾®æœ‰ç‚¹é•¿ï¼ˆç¬‘ï¼‰ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657- (void)flushMessageQueue:(NSString *)messageQueueString &#123; // æ ¡éªŒ messageQueueString if (messageQueueString == nil || messageQueueString.length == 0) &#123; NSLog(@&quot;WebViewJavascriptBridge: WARNING: ObjC got nil while fetching the message queue JSON from webview. This can happen if the WebViewJavascriptBridge JS is not currently present in the webview, e.g if the webview just loaded a new page.&quot;); return; &#125; // å°† messageQueueString é€šè¿‡ NSJSONSerialization è§£ä¸º messages å¹¶éå† id messages = [self _deserializeMessageJSON:messageQueueString]; for (WVJBMessage* message in messages) &#123; // ç±»å‹æ ¡éªŒ if (![message isKindOfClass:[WVJBMessage class]]) &#123; NSLog(@&quot;WebViewJavascriptBridge: WARNING: Invalid %@ received: %@&quot;, [message class], message); continue; &#125; [self _log:@&quot;RCVD&quot; json:message]; // å°è¯•å– responseIdï¼Œå¦‚å–åˆ°åˆ™è¡¨æ˜æ˜¯å›è°ƒï¼Œä» _responseCallbacks å–åŒ¹é…çš„å›è°ƒ block æ‰§è¡Œ NSString* responseId = message[@&quot;responseId&quot;]; if (responseId) &#123; // å–åˆ° responseId WVJBResponseCallback responseCallback = _responseCallbacks[responseId]; responseCallback(message[@&quot;responseData&quot;]); [self.responseCallbacks removeObjectForKey:responseId]; &#125; else &#123; // æœªå–åˆ° responseIdï¼Œåˆ™è¡¨æ˜æ˜¯æ­£å¸¸çš„ JS callHandler è°ƒç”¨ iOS WVJBResponseCallback responseCallback = NULL; // å°è¯•å– callbackIdï¼Œç¤ºä¾‹ cb_1_1512035076293 // å¯¹åº” JS ä»£ç  var callbackId = &#x27;cb_&#x27;+(uniqueId++)+&#x27;_&#x27;+new Date().getTime(); NSString* callbackId = message[@&quot;callbackId&quot;]; if (callbackId) &#123; // å–åˆ° callbackIdï¼Œè¡¨ç¤º js ç«¯å¸Œæœ›åœ¨è°ƒç”¨ iOS native ä»£ç åæœ‰å›è°ƒ responseCallback = ^(id responseData) &#123; if (responseData == nil) &#123; responseData = [NSNull null]; &#125; // å°† callbackId ä½œä¸º msg çš„ responseId å¹¶è®¾ç½® responseDataï¼Œæ‰§è¡Œ _queueMessage WVJBMessage* msg = @&#123; @&quot;responseId&quot;:callbackId, @&quot;responseData&quot;:responseData &#125;; // _queueMessage å‡½æ•°ä¸»è¦æ˜¯æŠŠ msg è½¬ä¸º JSON æ ¼å¼ï¼Œå†…å« responseId = callbackId // JS ç«¯è°ƒç”¨ WebViewJavascriptBridge._handleMessageFromObjC(&#x27;msg_JSON&#x27;); å…¶ä¸­ &#x27;msg_JSON&#x27; å°±æ˜¯ JSON æ ¼å¼çš„ msg [self _queueMessage:msg]; &#125;; &#125; else &#123; // æœªå–åˆ° callbackId responseCallback = ^(id ignoreResponseData) &#123; // Do nothing &#125;; &#125; // å°è¯•ä»¥ handlerName è·å– iOS ç«¯ä¹‹å‰æ³¨å†Œè¿‡çš„ handler WVJBHandler handler = self.messageHandlers[message[@&quot;handlerName&quot;]]; if (!handler) &#123; // æ²¡æ³¨å†Œè¿‡ï¼Œåˆ™è·³è¿‡æ­¤ msg NSLog(@&quot;WVJBNoHandlerException, No handler for message from JS: %@&quot;, message); continue; &#125; // è°ƒç”¨å¯¹åº”çš„ handlerï¼Œä»¥ message[@&quot;data&quot;] ä¸ºå…¥å‚ï¼Œä»¥ responseCallback ä¸ºå›è°ƒ handler(message[@&quot;data&quot;], responseCallback); &#125; &#125;&#125; å˜›~ flushMessageQueue: æ–¹æ³•ä½œä¸ºæ•´ä¸ª Native ç«¯çš„æ ¸å¿ƒï¼Œæœ‰ç‚¹é•¿æ˜¯å¯ä»¥ç†è§£çš„ã€‚æˆ‘ä»¬ç®€å•ç†ä¸€ä¸‹å®ƒçš„å®ç°æ€è·¯ï¼š å…¥å‚æ ¡éªŒ å°† JSON å½¢å¼çš„å…¥å‚è½¬æ¢ä¸º Native å¯¹è±¡ï¼Œå³æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™é‡Œé¢æ¶ˆæ¯ç±»å‹æ˜¯ä¹‹å‰å®šä¹‰è¿‡çš„ WVJBMessageï¼Œå³å­—å…¸ å¦‚æœæ¶ˆæ¯ä¸­å«æœ‰ â€œresponseIdâ€ åˆ™è¡¨æ˜æ˜¯ä¹‹å‰ Native è°ƒç”¨çš„ JS æ–¹æ³•å›è°ƒè¿‡æ¥çš„æ¶ˆæ¯ï¼ˆå› ä¸º JS ç«¯å’Œ Native ç«¯å®ç°é€»è¾‘æ˜¯å¯¹ç­‰çš„ï¼Œæ‰€ä»¥è¿™ä¸ªåœ°æ–¹ä¸æ˜ç™½çš„å¯ä»¥å‚è€ƒä¸‹é¢çš„åˆ†æï¼‰ å¦‚æœæ¶ˆæ¯ä¸­ä¸å« â€œresponseIdâ€ åˆ™è¡¨æ˜æ˜¯ JS ç«¯é€šè¿‡ callHandler å‡½æ•°æ­£å¸¸è°ƒç”¨ Native ç«¯è¿‡æ¥çš„æ¶ˆæ¯ å°è¯•è·å–æ¶ˆæ¯ä¸­çš„ â€œcallbackIdâ€ï¼Œå¦‚æœ JS æœ¬æ¬¡æ¶ˆæ¯éœ€è¦ Native å“åº”ä¹‹åå›è°ƒæ‰ä¼šæœ‰è¿™ä¸ªé”®å€¼ï¼Œå…·ä½“å‚è§ä¸Šæ–‡ä¸­ JS ç«¯ _doSend éƒ¨åˆ†æºç åˆ†æã€‚å¦‚å–åˆ° â€œcallbackIdâ€ åˆ™éœ€ç”Ÿæˆä¸€ä¸ªå›è°ƒ blockï¼Œå›è°ƒ block å†…éƒ¨å°† â€œcallbackIdâ€ ä½œä¸º msg çš„ â€œresponseIdâ€ æ‰§è¡Œ _queueMessage å°†æ¶ˆæ¯å‘é€ç»™ JS ç«¯ï¼ˆJS ç«¯å¤„ç†æ¶ˆæ¯é€»è¾‘ä¸ Native ç«¯ä¸€è‡´ï¼Œæ‰€ä»¥ä¸Šé¢ä½¿ç”¨ â€œresponseIdâ€ åˆ¤æ–­å½“å‰æ¶ˆæ¯æ˜¯å¦ä¸ºå›è°ƒæ–¹æ³•ä¼ é€’è¿‡æ¥çš„æ¶ˆæ¯æ˜¯å¾ˆå®¹æ˜“ç†è§£çš„ï¼‰ å°è¯•ä»¥æ¶ˆæ¯ä¸­çš„ â€œhandlerNameâ€ ä» messageHandlersï¼ˆä¸Šæ–‡æåˆ°è¿‡ï¼Œæ˜¯ä¿å­˜ Native ç«¯æ³¨å†Œè¿‡çš„ handler çš„å­—å…¸ï¼‰å–åˆ°å¯¹åº”çš„ handler blockï¼Œå¦‚æœå–åˆ°åˆ™æ‰§è¡Œä»£ç å—ï¼Œå¦åˆ™æ‰“å°é”™è¯¯æ—¥å¿— Note: è¿™ä¸ªæ¶ˆæ¯å¤„ç†çš„æ–¹æ³•è™½ç„¶é•¿ï¼Œä½†æ˜¯é€»è¾‘æ¸…æ™°ï¼Œè€Œä¸”æœ‰æ•ˆçš„è§£å†³äº† JS ä¸ Native ç›¸äº’è°ƒç”¨çš„è¿‡ç¨‹ä¸­å‚æ•°ä¼ é€’çš„é—®é¢˜ï¼ˆåŒ…æ‹¬å›è°ƒï¼‰ï¼Œæ­¤å¤– JS ç«¯çš„æ¶ˆæ¯å¤„ç†é€»è¾‘ä¸ Native ç«¯ä¿æŒä¸€è‡´ï¼Œå®ç°äº†é€»è¾‘å¯¹ç§°ï¼Œéå¸¸å€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚ WebViewJavascriptBridge_JS - Native è°ƒç”¨ JS å®ç°è§£è¯» Emmmmmâ€¦è¿™ä¸€ç« èŠ‚ä¸»è¦è®² JS ç«¯æ³¨å…¥çš„ä»£ç ï¼Œå³ WebViewJavascriptBridge_JS ä¸­çš„ JS æºç ã€‚ç”±äºæˆ‘æ²¡åšè¿‡å‰æ®µï¼Œèƒ½åŠ›ä¸è¶³ï¼Œæ°´å¹³æœ‰é™ï¼Œå¯èƒ½æœ‰è°¬è¯¯å¸Œæœ›å„ä½è¯»è€…å‘ç°çš„è¯åŠæ—¶æŒ‡æ­£ï¼Œæ„Ÿæ¿€ä¸å°½ã€‚é¢„è­¦ï¼Œç”±äº JS ç«¯å’Œä¸Šæ–‡åˆ†æè¿‡çš„ Native ç«¯é€»è¾‘å¯¹ç§°ä¸”ä¸Šæ–‡å·²ç»åˆ†æè¿‡éƒ¨åˆ† JS ç«¯çš„å‡½æ•°ï¼Œæ‰€ä»¥ä¸‹é¢çš„ JS æºç æ²¡æœ‰å¦åšæ‹†åˆ†ï¼Œä¸ºé¿å…è¢«å¤§æ®µ JS ä»£ç ç³Šè„¸ä¸æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç›´æ¥çœ‹ä»£ç åé¢çš„æ€»ç»“ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146;(function() &#123; // window.WebViewJavascriptBridge æ ¡éªŒï¼Œé¿å…é‡å¤ if (window.WebViewJavascriptBridge) &#123; return; &#125; // æ‡’åŠ è½½ window.onerrorï¼Œç”¨äºæ‰“å° error æ—¥å¿— if (!window.onerror) &#123; window.onerror = function(msg, url, line) &#123; console.log(&quot;WebViewJavascriptBridge: ERROR:&quot; + msg + &quot;@&quot; + url + &quot;:&quot; + line); &#125; &#125; // window.WebViewJavascriptBridge å£°æ˜ window.WebViewJavascriptBridge = &#123; registerHandler: registerHandler, callHandler: callHandler, disableJavscriptAlertBoxSafetyTimeout: disableJavscriptAlertBoxSafetyTimeout, _fetchQueue: _fetchQueue, _handleMessageFromObjC: _handleMessageFromObjC &#125;; // å˜é‡å£°æ˜ var messagingIframe; // æ¶ˆæ¯ iframe var sendMessageQueue = []; // å‘é€æ¶ˆæ¯é˜Ÿåˆ— var messageHandlers = &#123;&#125;; // JS ç«¯æ³¨å†Œçš„æ¶ˆæ¯å¤„ç† handlers å­—å…¸ï¼ˆå›§ï¼ŒJS å…¶å®å«å¯¹è±¡ï¼‰ // scheme ä½¿ç”¨ https ä¹‹åé€šè¿‡ host åšåŒ¹é… var CUSTOM_PROTOCOL_SCHEME = &#x27;https&#x27;; var QUEUE_HAS_MESSAGE = &#x27;__wvjb_queue_message__&#x27;; var responseCallbacks = &#123;&#125;; // JS ç«¯å­˜æ”¾å›è°ƒçš„å­—å…¸ var uniqueId = 1; // å”¯ä¸€æ ‡ç¤ºï¼Œç”¨äºå›è°ƒæ—¶ç”Ÿæˆ callbackId var dispatchMessagesWithTimeoutSafety = true; // é»˜è®¤å¯ç”¨å®‰å…¨æ—¶é•¿ // é€šè¿‡ç¦ç”¨ AlertBoxSafetyTimeout æ¥æé€Ÿç½‘æ¡¥æ¶ˆæ¯ä¼ é€’ function disableJavscriptAlertBoxSafetyTimeout() &#123; dispatchMessagesWithTimeoutSafety = false; &#125; // åŒ iOS é€»è¾‘ï¼Œæ³¨å†Œ handler å…¶å®æ˜¯å¾€ messageHandlers å­—å…¸ä¸­æ’å…¥å¯¹åº” name çš„ block function registerHandler(handlerName, handler) &#123; messageHandlers[handlerName] = handler; &#125; // è°ƒç”¨ iOS handlerï¼Œå‚æ•°æ ¡éªŒä¹‹åè°ƒç”¨ _doSend å‡½æ•° function callHandler(handlerName, data, responseCallback) &#123; // å¦‚æœå‚æ•°åªæœ‰ä¸¤ä¸ªä¸”ç¬¬äºŒä¸ªå‚æ•°ç±»å‹ä¸º functionï¼Œåˆ™è¡¨ç¤ºæ²¡æœ‰å‚æ•°ä¼ é€’ï¼Œå³ data ä¸ºç©º if (arguments.length == 2 &amp;&amp; typeof data == &#x27;function&#x27;) &#123; responseCallback = data; data = null; &#125; // å°† handlerName å’Œ data ä½œä¸º msg å¯¹è±¡å‚æ•°è°ƒç”¨ _doSend å‡½æ•° _doSend(&#123; handlerName:handlerName, data:data &#125;, responseCallback); &#125; // _doSend å‘ Native ç«¯å‘é€æ¶ˆæ¯ function _doSend(message, responseCallback) &#123; // å¦‚æœ‰å›è°ƒï¼Œåˆ™è®¾ç½® message[&#x27;callbackId&#x27;] ä¸ responseCallbacks[callbackId] if (responseCallback) &#123; var callbackId = &#x27;cb_&#x27;+(uniqueId++)+&#x27;_&#x27;+new Date().getTime(); responseCallbacks[callbackId] = responseCallback; message[&#x27;callbackId&#x27;] = callbackId; &#125; // å°† msg åŠ å…¥ sendMessageQueue æ•°ç»„ï¼Œè®¾ç½® messagingIframe.src sendMessageQueue.push(message); messagingIframe.src = CUSTOM_PROTOCOL_SCHEME + &#x27;://&#x27; + QUEUE_HAS_MESSAGE; &#125; // è·å–é˜Ÿåˆ—ï¼Œåœ¨ iOS ç«¯åˆ·æ–°æ¶ˆæ¯é˜Ÿåˆ—æ—¶ä¼šè°ƒç”¨æ­¤å‡½æ•° function _fetchQueue() &#123; // å†…éƒ¨å°†å‘é€æ¶ˆæ¯é˜Ÿåˆ— sendMessageQueue è½¬ä¸º JSON æ ¼å¼å¹¶è¿”å› var messageQueueString = JSON.stringify(sendMessageQueue); sendMessageQueue = []; return messageQueueString; &#125; // iOS ç«¯ _dispatchMessage å‡½æ•°ä¼šè°ƒç”¨æ­¤å‡½æ•° function _handleMessageFromObjC(messageJSON) &#123; // è°ƒåº¦ä» Native ç«¯è·å–åˆ°çš„æ¶ˆæ¯ _dispatchMessageFromObjC(messageJSON); &#125; // æ ¸å¿ƒä»£ç ï¼Œè°ƒåº¦ä» Native ç«¯è·å–åˆ°çš„æ¶ˆæ¯ï¼Œé€»è¾‘ä¸ Native ç«¯ä¸€è‡´ function _dispatchMessageFromObjC(messageJSON) &#123; // åˆ¤æ–­æœ‰æ²¡æœ‰ç¦ç”¨ AlertBoxSafetyTimeoutï¼Œæœ€ç»ˆä¼šè°ƒç”¨ _doDispatchMessageFromObjC å‡½æ•° if (dispatchMessagesWithTimeoutSafety) &#123; setTimeout(_doDispatchMessageFromObjC); &#125; else &#123; _doDispatchMessageFromObjC(); &#125; // è§£æ msgJSON å¾—åˆ° msg function _doDispatchMessageFromObjC() &#123; var message = JSON.parse(messageJSON); var messageHandler; var responseCallback; // å¦‚æœæœ‰ responseIdï¼Œåˆ™è¯´æ˜æ˜¯å›è°ƒï¼Œå–å¯¹åº”çš„ responseCallback æ‰§è¡Œï¼Œä¹‹åé‡Šæ”¾ if (message.responseId) &#123; responseCallback = responseCallbacks[message.responseId]; if (!responseCallback) &#123; return; &#125; responseCallback(message.responseData); delete responseCallbacks[message.responseId]; &#125; else &#123; // æ²¡æœ‰ responseIdï¼Œåˆ™è¡¨ç¤ºæ­£å¸¸çš„ iOS call handler è°ƒç”¨ js // å¦‚ msg åŒ…å« callbackIdï¼Œè¯´æ˜ iOS ç«¯éœ€è¦å›è°ƒï¼Œåˆå§‹åŒ–å¯¹åº”çš„ responseCallback if (message.callbackId) &#123; var callbackResponseId = message.callbackId; responseCallback = function(responseData) &#123; _doSend(&#123; handlerName:message.handlerName, responseId:callbackResponseId, responseData:responseData &#125;); &#125;; &#125; // ä» messageHandlers æ‹¿åˆ°å¯¹åº”çš„ handler æ‰§è¡Œ var handler = messageHandlers[message.handlerName]; if (!handler) &#123; // å¦‚æœªå–åˆ°å¯¹åº”çš„ handler åˆ™æ‰“å°é”™è¯¯æ—¥å¿— console.log(&quot;WebViewJavascriptBridge: WARNING: no handler for message from ObjC:&quot;, message); &#125; else &#123; handler(message.data, responseCallback); &#125; &#125; &#125; &#125; // messagingIframe çš„å£°æ˜ï¼Œç±»å‹ iframeï¼Œæ ·å¼ä¸å¯è§ï¼Œsrc è®¾ç½® messagingIframe = document.createElement(&#x27;iframe&#x27;); messagingIframe.style.display = &#x27;none&#x27;; messagingIframe.src = CUSTOM_PROTOCOL_SCHEME + &#x27;://&#x27; + QUEUE_HAS_MESSAGE; // messagingIframe åŠ å…¥ document.documentElement ä¸­ document.documentElement.appendChild(messagingIframe); // æ³¨å†Œ disableJavscriptAlertBoxSafetyTimeout handlerï¼ŒNative å¯ä»¥é€šè¿‡ç¦ç”¨ AlertBox çš„å®‰å…¨æ—¶é•¿æ¥åŠ é€Ÿæ¡¥æ¥æ¶ˆæ¯ registerHandler(&quot;_disableJavascriptAlertBoxSafetyTimeout&quot;, disableJavscriptAlertBoxSafetyTimeout); setTimeout(_callWVJBCallbacks, 0); function _callWVJBCallbacks() &#123; var callbacks = window.WVJBCallbacks; delete window.WVJBCallbacks; for (var i=0; i&lt;callbacks.length; i++) &#123; callbacks[i](WebViewJavascriptBridge); &#125; &#125;&#125; JS ç«¯å’Œ Native ç«¯é€»è¾‘ä¸€è‡´ï¼Œä¸Šé¢çš„ä»£ç å·²ç»åŠ å…¥äº†è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šï¼Œä¸Šæ–‡åœ¨å¯¹äºâ€œWebViewJavascriptBridgeBase - JS è°ƒç”¨ Native å®ç°åŸç†å‰–æâ€ç« èŠ‚çš„åˆ†æè¿‡ç¨‹ä¸­ä¸ºäº†èµ°é€šæ•´ä¸ªè°ƒç”¨çš„é€»è¾‘å·²ç»å¯¹éƒ¨åˆ† JS ç«¯ä»£ç è¿›è¡Œäº†åˆ†æï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•çš„æ¢³ç†ä¸€ä¸‹ JS ç«¯æ ¸å¿ƒä»£ç  _doDispatchMessageFromObjC å‡½æ•°çš„é€»è¾‘ï¼š å°† messageJSON ä½¿ç”¨ JSON è§£æå‡ºæ¥ å°è¯•å–è§£æåˆ°çš„æ¶ˆæ¯ä¸­çš„ responseIdï¼Œå¦‚æœæœ‰å–åˆ°åˆ™è¯´æ˜æ˜¯ Native ç«¯å“åº” JS ç«¯ä¹‹åé€šè¿‡å›è°ƒå‘ JS ç«¯å‘å‡ºçš„æ¶ˆæ¯ï¼Œç”¨ responseId å– responseCallbacks ä¸­å¯¹åº”çš„å›è°ƒå“åº” blockï¼Œæ‰¾åˆ°åæ‰§è¡Œè¯¥ block ä¹‹ååˆ é™¤ å¦‚æœæ²¡å–åˆ° responseId åˆ™è¡¨ç¤ºè¿™æ¡æ¶ˆæ¯æ˜¯ Native ç«¯é€šè¿‡ callHandler:data:responseCallback: æ­£å¸¸è°ƒç”¨ JS æ³¨å†Œçš„ handler å‘é€è¿‡æ¥çš„æ¶ˆæ¯ï¼ˆè¿™é‡Œçš„æ­£å¸¸æ˜¯é’ˆå¯¹å›è°ƒè€Œè¨€ï¼‰ å¦‚æœå½“å‰çš„æ¶ˆæ¯æœ‰ callbackId åˆ™è¡¨æ˜ Native ç«¯éœ€è¦ JS ç«¯å“åº”æœ¬æ¬¡æ¶ˆæ¯ä¹‹åå›è°ƒåé¦ˆï¼Œç”Ÿæˆä¸€ä¸ª responseCallback ä½œä¸ºå›è°ƒ block (JS ç«¯æ˜¯ function) ï¼Œå…¶å†…éƒ¨ä½¿ç”¨ _doSend æ–¹æ³•ä¼ é€’ä¸€ä¸ªå¸¦æœ‰ responseId çš„æ¶ˆæ¯ç»™ Native ç«¯ï¼Œè¡¨æ˜æ­¤æ¡æ¶ˆæ¯æ˜¯ä¹‹å‰çš„å›è°ƒæ¶ˆæ¯ æœ€åæŒ‰ç…§è§£æåˆ°çš„æ¶ˆæ¯ä¸­ handlerName ä» messageHandlersï¼Œå³ JS ç«¯æ³¨å†Œè¿‡çš„ handlers ä¸­æ‰¾åˆ°ä¸åç§°å¯¹åº”çš„å¤„ç†å‡½æ•°æ‰§è¡Œï¼Œå¦‚æœæ²¡æ‰¾åˆ°åˆ™æ‰“å°é™„å¸¦ç›¸å…³ä¿¡æ¯çš„é”™è¯¯æ—¥å¿— å˜›~ å¯¹æ¯”ä¸€ä¸‹ Native ç«¯çš„æ ¸å¿ƒä»£ç  flushMessageQueue: çœ‹ä¸€ä¸‹ï¼Œå¾ˆå®¹æ˜“å‘ç°ä¸¤ç«¯çš„å¤„ç†å®ç°æ˜¯é€»è¾‘å¯¹ç§°çš„ã€‚ WebViewJavascriptBridge çš„â€œæ¡¥æ¢ç¾å­¦â€ åœ¨æ€»ç»“ WebViewJavascriptBridge çš„â€œæ¡¥æ¢ç¾å­¦â€ä¹‹å‰è¯·å†å›é¡¾ä¸€ä¸‹ WebViewJavascriptBridge çš„å·¥ä½œæµï¼š JS ç«¯åŠ å…¥ src ä¸º https://__bridge_loaded__ çš„ iframe Native ç«¯æ£€æµ‹åˆ° Requestï¼Œæ£€æµ‹å¦‚æœæ˜¯ __bridge_loaded__ åˆ™é€šè¿‡å½“å‰çš„ WebView ç»„ä»¶æ³¨å…¥ WebViewJavascriptBridge_JS ä»£ç  æ³¨å…¥ä»£ç æˆåŠŸä¹‹åä¼šåŠ å…¥ä¸€ä¸ª messagingIframeï¼Œå…¶ src ä¸º https://__wvjb_queue_message__ ä¹‹åä¸è®ºæ˜¯ Native ç«¯è¿˜æ˜¯ JS ç«¯éƒ½å¯ä»¥é€šè¿‡ registerHandler æ–¹æ³•æ³¨å†Œä¸€ä¸ªä¸¤ç«¯çº¦å®šå¥½çš„ HandlerName çš„å¤„ç†ï¼Œä¹Ÿéƒ½å¯ä»¥é€šè¿‡ callHandler æ–¹æ³•é€šè¿‡çº¦å®šå¥½çš„ HandlerName è°ƒç”¨å¦ä¸€ç«¯çš„å¤„ç†ï¼ˆä¸¤ç«¯å¤„ç†æ¶ˆæ¯çš„å®ç°é€»è¾‘å¯¹ç§°ï¼‰ å˜›~ æ‰€ä»¥æˆ‘ä»¬å¾ˆå®¹æ˜“åˆ—ä¸¾å‡º WebViewJavascriptBridge æ‰€å…·æœ‰çš„â€œç¾å­¦â€ï¼š éšæ€§é€‚é… æ¥å£å¯¹ç­‰ é€»è¾‘å¯¹ç§° æˆ‘ä»¬ç»“åˆæœ¬æ–‡å±•å¼€æ¥è¯´ä¸€ä¸‹ä¸Šé¢çš„â€œç¾å­¦â€çš„å…·ä½“å®ç°ã€‚ éšæ€§é€‚é…WebViewJavascriptBridge ä¸»è¦æ˜¯ä½œä¸º Mac OS X å’Œ iOS ç«¯ï¼ˆNative ç«¯ï¼‰ä¸ JS ç«¯ç›¸äº’é€šä¿¡ï¼Œäº’ç›¸è°ƒç”¨çš„æ¡¥æ¢ã€‚å¯¹äº Mac OS X å’Œ iOS ä¸¤ç§å¹³å°åŒ…å«çš„ä¸‰ç§ WebView åŠŸèƒ½ç»„ä»¶è€Œè¨€ï¼ŒWebViewJavascriptBridge åšäº†éšæ€§é€‚é…ï¼Œå³ä»…ç”¨ä¸€å¥—ä»£ç å³å¯ç»‘å®šä¸åŒå¹³å°çš„ WebView ç»„ä»¶å®ç°åŒæ ·åŠŸèƒ½çš„ JS é€šä¿¡åŠŸèƒ½ï¼Œè¿™ä¸€ç‚¹éå¸¸æ–¹ä¾¿ã€‚ æ¥å£å¯¹ç­‰WebViewJavascriptBridge å¯¹äº JS ç«¯å’Œ Native ç«¯è®¾è®¡äº†å¯¹ç­‰çš„æ¥å£ï¼Œä¸è®ºæ˜¯ JS ç«¯è¿˜æ˜¯ Native ç«¯ï¼Œæ³¨å†Œæœ¬ç«¯çš„å“åº”å¤„ç†éƒ½æ˜¯ç”¨ registerHandler æ¥å£ï¼Œè°ƒç”¨å¦ä¸€ç«¯ï¼ˆç»™å¦ä¸€ç«¯å‘æ¶ˆæ¯ï¼‰éƒ½æ˜¯ç”¨ callHandler æ¥å£ã€‚ è¿™æ ·åšæ˜¯éå¸¸åˆç†çš„ï¼Œå› ä¸ºä¸è®ºæ˜¯ JS ç«¯è¿˜æ˜¯ Native ç«¯ï¼Œä½œä¸ºé€šä¿¡çš„åŒæ–¹å°±é€šä¿¡æœ¬èº«è€Œè¨€æ˜¯å¤„äºå¯¹ç­‰çš„åœ°ä½çš„ã€‚è¿™å°±å¥½æ¯”ä¸€åº§å¤§æ¡¥è¿æ¥ä¸¤å—é™†åœ°ï¼Œä¸¤åœ°ç”¨å¤§æ¡¥ç›¸äº’è¿è¾“è´§ç‰©å¹¶æ¥æ”¶èµ„æºï¼Œä¸¤å—é™†åœ°åœ¨å¤§æ¡¥çš„è¿è¾“ä½¿ç”¨è¿‡ç¨‹ä¸­é€»è¾‘ä¸Šä¹Ÿæ˜¯åœ°ä½å¯¹ç­‰çš„ã€‚ é€»è¾‘å¯¹ç§°WebViewJavascriptBridge åœ¨ JS ç«¯å’Œ Native ç«¯å¯¹å‘é€è¿‡æ¥çš„æ¶ˆæ¯æœ‰ç€ç›¸åŒé€»è¾‘çš„å¤„ç†å®ç°ï¼Œå¦‚æœè€ƒè™‘åˆ°æ”¶å‘åŒæ–¹çš„èº«ä»½åˆ™å¯ä»¥æŠŠé€»è¾‘ç›¸åŒçœ‹åšé€»è¾‘å¯¹ç§°ã€‚ è¿™ç§å®ç°æ–¹å¼ä¾æ—§éå¸¸åˆç†ï¼Œè¢«æ¡¥è¿æ¥çš„ä¸¤å—å¤§é™†åœ¨è£…è´§ä¸Šæ¡¥å’Œä¸‹æ¡¥å¸è´§è¿™ä¸¤å¤„é€»è¾‘ä¸Šå°±åº”è¯¥æ˜¯å¯¹ç§°çš„ã€‚ å˜›~ è¯´åˆ°è¿™é‡Œå°±ä¸å¾—ä¸ç¥­å‡ºä¸€ä¸ªè¯æ¥å½¢å®¹ WebViewJavascriptBridge äº†ï¼Œè¿™ä¸ªè¯å°±æ˜¯ä¼˜é›…ï¼ˆç¬‘ï¼‰ã€‚å½“å¤§å®¶ç»“åˆ WebViewJavascriptBridge æºç é˜…è¯»æœ¬æ–‡ä¹‹åä¸éš¾å‘ç°å…¶æ•´ä¸ªæ¶æ„å’Œè®¾è®¡æ€æƒ³è·Ÿç°å®æ¡¥æ¢è®¾è®¡ä¸­å¾ˆå¤šè®¾è®¡æ€æƒ³ä¸è°‹è€Œåˆï¼Œæ¯”å¦‚æ¡¥ä¸€èˆ¬ä¼šåˆ†ä¸ºå·¦å³æ¡¥å¹…ï¼Œè€Œå·¦å³å¹…æ¡¥ä¸€èˆ¬åªæœ‰ä¸€æ¡çº¿è·¯ä¸­å¿ƒçº¿ï¼Œå³ä¸€ä¸ªå‰è¿›æ–¹å‘ï¼Œç”¨äºæ¡¥ä¸Šå•ä¸€æ–¹å‘çš„èµ„æºä¼ è¾“ï¼Œå·¦å³æ¡¥å¹…åœ¨åŠŸèƒ½ä¸Šå¯¹ç­‰ã€‚ æ–‡ç« æ€»ç»“ æ–‡ç« ç³»ç»Ÿåˆ†æäº† WebViewJavascriptBridge æºç ï¼Œå¸Œæœ›å„ä½è¯»è€…èƒ½å¤Ÿåœ¨é˜…è¯»æœ¬æ–‡ä¹‹åå¯¹ WebViewJavascriptBridge çš„æ¶æ„æœ‰ä¸€ä¸ªæ•´ä½“è®¤è¯†ã€‚ æ–‡ç« å¯¹ WebViewJavascriptBridge åœ¨ JS ç«¯å’Œ Native ç«¯çš„æ¶ˆæ¯å¤„ç†å®ç°åšäº†æ·±å…¥å‰–æï¼Œå¸Œæœ›å¯ä»¥å¯¹å„ä½è¯»è€…è¿™éƒ¨åˆ†æºç çš„ç†è§£æä¾›ä¸€äº›å¾®è–„çš„å¸®åŠ©ã€‚ æ€»ç»“äº† WebViewJavascriptBridge ä½œä¸ºä¸€ä¸ª JSBridge æ¡†æ¶æ‰€å…·æœ‰çš„ä¼˜åŠ¿ï¼Œå³æ–‡ä¸­æ‰€æŒ‡çš„â€œæ¡¥æ¢ç¾å­¦â€ï¼ŒæœŸæœ›å¯ä»¥å¯¹å¤§å®¶ä»¥åè‡ªå·±å°è£…ä¸€ä¸ª JSBridge æä¾›æ€è·¯ï¼ŒæŠ›ç –å¼•ç‰ã€‚ Emmmmmâ€¦ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ WebViewJavascriptBridge ä»…ä»…æ˜¯ä½œä¸º JSBridge å±‚ç”¨äºæä¾› JS å’Œ Native ä¹‹é—´ç›¸äº’ä¼ é€’æ¶ˆæ¯çš„åŸºç¡€æ”¯æŒçš„ã€‚å¦‚æœæƒ³è¦å°è£…è‡ªå·±é¡¹ç›®ä¸­çš„ WebView ç»„ä»¶è¿˜éœ€è¦å¦å¤–å®ç° HTTP cookie æ³¨å…¥ï¼Œè‡ªå®šä¹‰ User-Agentï¼Œç™½åå•æˆ–è€…æƒé™æ ¡éªŒç­‰åŠŸèƒ½ï¼Œæ›´è¿›ä¸€æ­¥è¿˜éœ€è¦å¯¹ WebView ç»„ä»¶è¿›è¡Œåˆå§‹åŒ–é€Ÿåº¦ï¼Œé¡µé¢æ¸²æŸ“é€Ÿåº¦ä»¥åŠé¡µé¢ç¼“å­˜ç­–ç•¥çš„ä¼˜åŒ–ã€‚æˆ‘ä¹‹åä¹Ÿè®¸å¯èƒ½å¤§æ¦‚åº”è¯¥ä¼šå†™ä¸€ç¯‡æ–‡ç« åˆ†äº«ä¸€ä¸‹è‡ªå·±å°è£… WebView ç»„ä»¶æ—¶è¸©åˆ°çš„ä¸€äº›å‘ä»¥åŠç»éªŒï¼Œå› ä¸ºè‡ªå·±æ°´å¹³æœ‰é™â€¦æ‰€ä»¥ä¹Ÿå¯èƒ½ä¸ä¼šå†™ï¼ˆç¬‘ï¼‰ã€‚ æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜ https://lision.me/ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ ä¸ªäººåšå®¢ ä¸­æ›´æ–°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš @Lision è”ç³»æˆ‘~ å¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~"},{"title":"YYImage è®¾è®¡æ€è·¯ï¼Œå®ç°ç»†èŠ‚å‰–æ","comments":true,"permalink":"https://lision.me/yyimage/","text":"å‰è¨€å›¾ç‰‡çš„å†å²æ—©äºæ–‡å­—ï¼Œæ˜¯æœ€åŸå§‹çš„ä¿¡æ¯ä¼ é€’æ–¹å¼ã€‚å…­ä¹¦ä¸­çš„è±¡å½¢æ–‡æ„é€ æ€æƒ³å°±æ˜¯ç”¨æ–‡å­—çš„çº¿æ¡æˆ–ç¬”ç”»ï¼ŒæŠŠè¦è¡¨è¾¾ç‰©ä½“çš„å¤–å½¢ç‰¹å¾ï¼Œå…·ä½“åœ°å‹¾ç”»å‡ºæ¥ã€‚ è®¸æ…ã€Šè¯´æ–‡è§£å­—ã€‹äº‘ï¼šâ€œè±¡å½¢è€…ï¼Œç”»æˆå…¶ç‰©ï¼Œéšä½“è¯˜è¯ï¼Œæ—¥ã€æœˆæ˜¯ä¹Ÿã€‚â€ ç°ä»£ç¤¾ä¼šçš„ä¿¡æ¯ä¼ é€’ä¸­ï¼Œå›¾ç‰‡ä»ç„¶æ˜¯ä¸å¯æˆ–ç¼ºçš„ä¸€ç¯ï¼Œä¸è®ºæ˜¯æŠ¥çº¸ã€æ‚å¿—ã€æ¼«ç”»ç­‰å®ä½“åˆŠç‰©è¿˜æ˜¯ç”Ÿæ´»ä¸­è¶…å¸‚åœ°é“å¹¿å‘Šæ´»åŠ¨ï¼Œéƒ½ä¼šæœ‰ä¸“é—¨çš„é…å›¾æŠ“äººçœ¼çƒã€‚ åœ¨ç§»åŠ¨ç«¯ App ä¸­ï¼Œå›¾ç‰‡é€šå¸¸å æ®ç€é‡è¦çš„è§†è§‰ç©ºé—´ï¼Œä½œä¸º iOS å¼€å‘æ¥è®²ï¼Œæ‰€æœ‰çš„ App éƒ½æœ‰ç²¾å¿ƒè®¾è®¡çš„ AppIcon é™ˆåˆ—åœ¨ SpringBoard ä¸­ï¼Œæ‰“å¼€ä»»æ„ä¸€æ¬¾ä¸»æµ App éƒ½å°‘ä¸äº†ç³ç…æ»¡ç›®çš„å›¾ç‰‡æ­é…ã€‚ YYImage æ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„ iOS å›¾åƒæ¡†æ¶ï¼ˆè¯¥é¡¹ç›®æ˜¯ YYKit ç»„ä»¶ä¹‹ä¸€ï¼‰ï¼Œæ”¯æŒç›®å‰å¸‚åœºä¸Šæ‰€æœ‰ä¸»æµçš„å›¾ç‰‡æ ¼å¼çš„æ˜¾ç¤ºä¸ç¼–/è§£ç ï¼Œå¹¶ä¸”æä¾›é«˜æ•ˆçš„åŠ¨æ€å†…å­˜ç¼“å­˜ç®¡ç†ï¼Œä»¥ä¿è¯é«˜æ€§èƒ½ä½å†…å­˜çš„åŠ¨ç”»æ’­æ”¾ã€‚ YYKit çš„ä½œè€… @ibireme å¯¹äº iOS å›¾ç‰‡å¤„ç†å†™æœ‰ä¸¤ç¯‡éå¸¸ä¸é”™çš„æ–‡ç« ï¼Œæ¨èå„ä½è¯»è€…åœ¨é˜…è¯»æœ¬æ–‡ä¹‹å‰æŸ¥é˜…ã€‚ ç§»åŠ¨ç«¯å›¾ç‰‡æ ¼å¼è°ƒç ” iOS å¤„ç†å›¾ç‰‡çš„ä¸€äº›å° Tip æœ¬æ–‡å¼•ç”¨ä»£ç å‡ä¸º YYImage v1.0.4 ç‰ˆæœ¬æºç ï¼Œæ–‡ç« æ—¨åœ¨å‰–æ YYImage çš„æ¶æ„æ€æƒ³ä»¥åŠè®¾è®¡æ€è·¯å¹¶å¯¹ç¬”è€…åœ¨é˜…è¯»æºç è¿‡ç¨‹ä¸­å‘ç°çš„æœ‰è¶£å®ç°ç»†èŠ‚æ¢ç©¶åˆ†äº«ï¼Œä¸ä¼šé€è¡Œç¿»è¯‘æºç ï¼Œå»ºè®®å¯¹æºç å®ç°æ„Ÿå…´è¶£çš„åŒå­¦ç»“åˆ YYImage v1.0.4 ç‰ˆæœ¬æºç é£Ÿç”¨æœ¬æ–‡~ ç´¢å¼• YYImage ç®€ä»‹ YYImage, YYFrameImage, YYSpriteSheetImage YYAnimatedImageView YYImageCoder æ€»ç»“ æ‰©å±•é˜…è¯» YYImage ç®€ä»‹ YYImage æ˜¯ä¸€æ¬¾åŠŸèƒ½å¼ºå¤§çš„ iOS å›¾åƒæ¡†æ¶ï¼Œæ”¯æŒå½“å‰å¸‚åœºä¸»æµçš„é™/åŠ¨æ€å›¾åƒç¼–/è§£ç ä¸åŠ¨æ€å›¾åƒçš„åŠ¨ç”»æ’­æ”¾æ˜¾ç¤ºï¼Œå…¶å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š æ”¯æŒä»¥ä¸‹ç±»å‹åŠ¨ç”»å›¾åƒçš„æ’­æ”¾/ç¼–ç /è§£ç : WebP, APNG, GIFã€‚ æ”¯æŒä»¥ä¸‹ç±»å‹é™æ€å›¾åƒçš„æ˜¾ç¤º/ç¼–ç /è§£ç : WebP, PNG, GIF, JPEG, JP2, TIFF, BMP, ICO, ICNSã€‚ æ”¯æŒä»¥ä¸‹ç±»å‹å›¾ç‰‡çš„æ¸è¿›å¼/é€è¡Œæ‰«æ/éš”è¡Œæ‰«æè§£ç : PNG, GIF, JPEG, BMPã€‚ æ”¯æŒå¤šå¼ å›¾ç‰‡æ„æˆçš„å¸§åŠ¨ç”»æ’­æ”¾ï¼Œæ”¯æŒå•å¼ å›¾ç‰‡çš„ sprite sheet åŠ¨ç”»ã€‚ é«˜æ•ˆçš„åŠ¨æ€å†…å­˜ç¼“å­˜ç®¡ç†ï¼Œä»¥ä¿è¯é«˜æ€§èƒ½ä½å†…å­˜çš„åŠ¨ç”»æ’­æ”¾ã€‚ å®Œå…¨å…¼å®¹ UIImage å’Œ UIImageViewï¼Œä½¿ç”¨æ–¹ä¾¿ã€‚ ä¿ç•™å¯æ‰©å±•çš„æ¥å£ï¼Œä»¥æ”¯æŒè‡ªå®šä¹‰åŠ¨ç”»ã€‚ æ¯ä¸ªç±»å’Œæ–¹æ³•éƒ½æœ‰å®Œå–„çš„æ–‡æ¡£æ³¨é‡Šã€‚ YYImage æ¶æ„åˆ†æé€šè¿‡ YYImage æºç å¯ä»¥æŒ‰ç…§å…¶ä¸ UIKit çš„å¯¹åº”å…³ç³»åˆ’åˆ†ä¸ºä¸‰ä¸ªå±‚çº§ï¼š å±‚çº§ UIKit YYImage å›¾åƒå±‚ UIImage YYImage, YYFrameImage, YYSpriteSheetImage è§†å›¾å±‚ UIImageView YYAnimatedImageView ç¼–/è§£ç å±‚ ImageIO.framework YYImageCoder å›¾åƒå±‚ï¼ŒæŠŠä¸åŒç±»å‹çš„å›¾åƒä¿¡æ¯å°è£…æˆç±»å¹¶æä¾›åˆå§‹åŒ–å’Œå…¶ä»–ä¾¿æ·æ¥å£ã€‚ è§†å›¾å±‚ï¼Œè´Ÿè´£å›¾åƒå±‚å†…å®¹çš„æ˜¾ç¤ºï¼ˆåŒ…å«åŠ¨æ€å›¾åƒçš„åŠ¨ç”»æ’­æ”¾ï¼‰å·¥ä½œã€‚ ç¼–/è§£ç å±‚ï¼Œæä¾›å›¾åƒåº•å±‚æ”¯æŒï¼Œä½¿æ•´ä¸ªæ¡†æ¶å¾—ä»¥æ”¯æŒå¸‚åœºä¸»æµçš„å›¾ç‰‡æ ¼å¼ã€‚ Note: ImageIO.framework æ˜¯ iOS åº•å±‚å®ç°çš„å›¾ç‰‡ç¼–/è§£ç åº“ï¼Œè´Ÿè´£ç®¡ç†é¢œè‰²å’Œè®¿é—®å›¾åƒå…ƒæ•°æ®ã€‚å…¶å†…éƒ¨çš„å®ç°ä½¿ç”¨äº†ç¬¬ä¸‰æ–¹ç¼–/è§£ç åº“ï¼ˆå¦‚ libpng ç­‰ï¼‰å¹¶å¯¹ç¬¬ä¸‰æ–¹åº“è¿›è¡Œè°ƒæ•´ä¼˜åŒ–ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒiOS è¿˜ä¸“é—¨é’ˆå¯¹ JPEG çš„ç¼–/è§£ç å¼€å‘äº† AppleJPEG.frameworkï¼Œå®ç°äº†æ€§èƒ½æ›´é«˜çš„ç¡¬ç¼–ç å’Œç¡¬è§£ç ã€‚ YYImage, YYFrameImage, YYSpriteSheetImageå…ˆæ¥ä»‹ç» YYImage åº“ä¸­å›¾åƒå±‚çš„ä¸‰ä¸ªç±»ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š YYImage YYFrameImage YYSpriteSheetImage YYImageYYImage æ˜¯ä¸€ä¸ªæ˜¾ç¤ºåŠ¨æ€å›¾ç‰‡æ•°æ®çš„é«˜çº§åˆ«ç±»ï¼Œå…¶ç»§æ‰¿è‡ª UIImage å¹¶å¯¹ UIImage åšäº†æ‰©å±•ä»¥æ”¯æŒ WebPï¼ŒAPNG å’Œ GIF æ ¼å¼çš„å›¾ç‰‡è§£ç ã€‚å®ƒè¿˜æ”¯æŒ NSCoding åè®®å¯ä»¥å¯¹å¤šå¸§å›¾åƒæ•°æ®è¿›è¡Œ archive å’Œ unarchive æ“ä½œã€‚ 12345678910111213@interface YYImage : UIImage &lt;YYAnimatedImage&gt;+ (nullable YYImage *)imageNamed:(NSString *)name; // ä¸åŒäº UIImageï¼Œæ­¤æ–¹æ³•æ— ç¼“å­˜+ (nullable YYImage *)imageWithContentsOfFile:(NSString *)path;+ (nullable YYImage *)imageWithData:(NSData *)data;+ (nullable YYImage *)imageWithData:(NSData *)data scale:(CGFloat)scale;@property (nonatomic, readonly) YYImageType animatedImageType; // å›¾åƒæ•°æ®ç±»å‹@property (nullable, nonatomic, readonly) NSData *animatedImageData; // åŠ¨æ€å›¾åƒçš„å…ƒæ•°æ®@property (nonatomic, readonly) NSUInteger animatedImageMemorySize; // å¤šå¸§å›¾åƒå†…å­˜å ç”¨é‡@property (nonatomic) BOOL preloadAllAnimatedImageFrames; // é¢„åŠ è½½æ‰€æœ‰å¸§ï¼ˆåˆ°å†…å­˜ï¼‰@end YYImage æä¾›äº†ç±»ä¼¼ UIImage çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œå…¬å¼€äº†ä¸€äº›å±æ€§ä¾¿äºæˆ‘ä»¬æ£€æµ‹å’Œæ§åˆ¶å…¶å†…å­˜ä½¿ç”¨ã€‚ å€¼å¾—ä¸€æçš„æ˜¯ YYImage çš„ imageNamed: åˆå§‹åŒ–æ–¹æ³•å¹¶ä¸æ”¯æŒç¼“å­˜ã€‚å› ä¸ºå…¶ imageNamed: å†…éƒ¨å®ç°å¹¶ä¸åŒäº UIImage çš„ imageNamed: æ–¹æ³•ï¼ŒYYImage ä¸­çš„å®ç°æµç¨‹å¦‚ä¸‹ï¼š æ¨æµ‹å‡ºç»™å®šå›¾åƒèµ„æºè·¯å¾„ æ‹¿åˆ°è·¯å¾„ä¸­çš„å›¾åƒæ•°æ®ï¼ˆNSDataï¼‰ è°ƒç”¨ YYImage çš„ initWithData:scale: æ–¹æ³•åˆå§‹åŒ– YYImage çš„ç§æœ‰å˜é‡éƒ¨åˆ†ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œç›¸ä¿¡å¤§å®¶å¯ä»¥æ ¹æ®ä¸Šé¢æš´éœ²å‡ºçš„å±æ€§å’Œæ¥å£çŒœå¾—åˆ°å“ˆã€‚ 123456@implementation YYImage &#123; YYImageDecoder *_decoder; // è§£ç å™¨ NSArray *_preloadedFrames; // é¢„åŠ è½½çš„å›¾åƒå¸§ dispatch_semaphore_t _preloadedLock; // é¢„åŠ è½½é” NSUInteger _bytesPerFrame; // å†…å­˜å ç”¨é‡&#125; å…¶å†…éƒ¨æœ‰ä¸€æŠŠé” dispatch_semaphore_tï¼Œæˆ‘ä»¬çŸ¥é“ dispatch_semaphore_t å½“ä¿¡å·é‡ä¸º 1 æ—¶å¯ä»¥å½“åšé”æ¥ä½¿ç”¨ï¼Œåœ¨ä¸é˜»å¡æ—¶å…¶ä½œä¸ºé”çš„æ•ˆç‡éå¸¸é«˜ã€‚è¿™é‡Œä½¿ç”¨ _preloadedLock çš„ä¸»è¦ç›®çš„æ˜¯ä¿è¯ _preloadedFrames çš„è¯»å†™ï¼Œç”±äº _preloadedFrames çš„è¯»å†™è¿‡ç¨‹æ˜¯åœ¨å†…å­˜ä¸­å®Œæˆçš„ï¼Œæ“ä½œè€—æ—¶ä¸ä¼šå¤ªå¤šï¼Œæ‰€ä»¥ä¸ä¼šé•¿æ—¶é—´é˜»å¡ï¼Œè¿™ç§æƒ…å†µä½¿ç”¨ dispatch_semaphore_t éå¸¸åˆé€‚ã€‚ å˜›~ _preloadedFrames å¯¹åº” preloadAllAnimatedImageFrames å±æ€§ï¼Œå¼€å¯é¢„åŠ è½½æ‰€æœ‰å¸§åˆ°å†…å­˜çš„è¯ï¼Œ_preloadedFrames ä½œä¸ºä¸€ä¸ªæ•°ç»„ä¼šä¿å­˜æ‰€æœ‰å¸§çš„å›¾åƒã€‚_bytesPerFrame åˆ™å¯¹åº” animatedImageMemorySize å±æ€§ï¼Œåœ¨åˆå§‹åŒ– YYImage æ—¶ï¼Œå¦‚æœå¸§æ€»æ•°è¶…è¿‡ 1 åˆ™ä¼šè®¡ç®— _bytesPerFrame çš„å¤§å°ã€‚ 12345if (decoder.frameCount &gt; 1) &#123; _decoder = decoder; _bytesPerFrame = CGImageGetBytesPerRow(image.CGImage) * CGImageGetHeight(image.CGImage); _animatedImageMemorySize = _bytesPerFrame * decoder.frameCount;&#125; å…¶å® YYImage ä¸­è¿˜æœ‰ä¸€äº›å®ç°ä¹Ÿæ¯”è¾ƒæœ‰è¶£ï¼Œæ¯”å¦‚ animatedImageDurationAtIndex: çš„å®ç°ä¸­å¦‚æœå–åˆ° &lt;= 10 ms çš„æ—¶é•¿ä¼šæ›¿æ¢ä¸º 100 msï¼Œå¹¶åœ¨ æ³¨é‡Š ä¸­è§£é‡Šäº†ä¸ºä»€ä¹ˆï¼ˆä¸€å®šè¦ç‚¹è¿›å»çœ‹å•Šï¼Œç¬‘~ï¼‰ã€‚ YYFrameImageYYFrameImage æ˜¯ä¸“é—¨ç”¨æ¥æ˜¾ç¤ºåŸºäºå¸§çš„åŠ¨ç”»å›¾åƒç±»ï¼Œå…¶ä¹Ÿæ˜¯ UIImage çš„å­ç±»ã€‚YYFrameImage ä»…æ”¯æŒç³»ç»Ÿå›¾ç‰‡æ ¼å¼ä¾‹å¦‚ png å’Œ jpegã€‚ Note: ä½¿ç”¨ YYFrameImage æ˜¾ç¤ºåŠ¨ç”»å›¾åƒåŒæ ·è¦åŸºäº YYAnimatedImageView æ’­æ”¾ã€‚ 12345678910111213141516@interface YYFrameImage : UIImage &lt;YYAnimatedImage&gt;- (nullable instancetype)initWithImagePaths:(NSArray&lt;NSString *&gt; *)paths oneFrameDuration:(NSTimeInterval)oneFrameDuration loopCount:(NSUInteger)loopCount;- (nullable instancetype)initWithImagePaths:(NSArray&lt;NSString *&gt; *)paths frameDurations:(NSArray&lt;NSNumber *&gt; *)frameDurations loopCount:(NSUInteger)loopCount;- (nullable instancetype)initWithImageDataArray:(NSArray&lt;NSData *&gt; *)dataArray oneFrameDuration:(NSTimeInterval)oneFrameDuration loopCount:(NSUInteger)loopCount;- (nullable instancetype)initWithImageDataArray:(NSArray&lt;NSData *&gt; *)dataArray frameDurations:(NSArray *)frameDurations loopCount:(NSUInteger)loopCount;@end YYFrameImage å¯ä»¥æŠŠé™æ€å›¾ç‰‡ç±»å‹å¦‚ png å’Œ jpeg æ ¼å¼çš„é™æ€å›¾åƒç”¨å¸§åˆ‡æ¢çš„æ–¹å¼ä»¥åŠ¨æ€å›¾ç‰‡çš„å½¢å¼æ˜¾ç¤ºï¼Œå¹¶ä¸”æä¾›äº† 4 ä¸ªå¸¸ç”¨çš„åˆå§‹åŒ–æ–¹æ³•æ–¹ä¾¿æˆ‘ä»¬ä½¿ç”¨ã€‚ YYFrameImage å†…éƒ¨æœ‰ä¸€äº›åŸºæœ¬çš„å˜é‡åˆ†åˆ«å¯¹åº”äºå…¶æš´éœ²çš„ 4 ä¸ªå¸¸ç”¨åˆå§‹åŒ–æ¥å£ï¼š 1234567@implementation YYFrameImage &#123; NSUInteger _loopCount; NSUInteger _oneFrameBytes; NSArray *_imagePaths; NSArray *_imageDatas; NSArray *_frameDurations;&#125; YYFrameImage çš„å®ç°ä»£ç éå¸¸ç®€å•ï¼Œåˆå§‹åŒ–æ–¹æ³•å¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š å…¥å‚æ ¡éªŒ æ ¹æ®å…¥å‚å–åˆ°é¦–å¼ å›¾ç‰‡ ç”¨é¦–å›¾åˆå§‹åŒ– _oneFrameBytes ï¼Œå¦‚å…¥å‚åˆå§‹åŒ– _imageDatas ï¼Œ_frameDurations å’Œ _loopCount ç”¨ UIImage çš„ initWithCGImage:scale:orientation: åˆå§‹åŒ–å¹¶è¿”å›åˆå§‹åŒ–ç»“æœ YYSpriteSheetImage YYSpriteSheetImage æ˜¯ç”¨æ¥åš Spritesheet åŠ¨ç”»æ˜¾ç¤ºçš„å›¾åƒç±»ï¼Œå®ƒä¹Ÿæ˜¯ UIImage çš„å­ç±»ã€‚ å…³äº Spritesheet å¯èƒ½åšè¿‡æ¸¸æˆå¼€å‘æˆ–è€…ä»¥å‰é¼“æ£è¿‡ç®€å•ç½‘é¡µæ¸¸æˆ Demo çš„åŒå­¦ä¼šå¾ˆç†Ÿæ‚‰ï¼Œå…¶åŠ¨ç”»åŸç†æ˜¯æŠŠä¸€ä¸ªåŠ¨ç”»è¿‡ç¨‹åˆ†è§£ä¸ºå¤šä¸ªåŠ¨ç”»å¸§ï¼ŒæŒ‰ç…§é¡ºåºå°†è¿™äº›åŠ¨ç”»å¸§æ’å¸ƒåœ¨ä¸€å¼ å¤§çš„ç”»å¸ƒä¸­ï¼Œæ’­æ”¾åŠ¨ç”»æ—¶åªéœ€è¦æŒ‰ç…§æ¯ä¸€å¸§å›¾åƒçš„å°ºå¯¸å¤§å°ä»¥åŠå¯¹åº”ç´¢å¼•å»ç”»å¸ƒä¸­æå–å¯¹åº”çš„å¸§æ›¿æ¢æ˜¾ç¤ºä»¥è¾¾åˆ°äººçœ¼åˆ¤å®šåŠ¨ç”»çš„æ•ˆæœï¼Œç‚¹å‡» An Introduction to Spritesheet Animation æˆ–è€… What is a sprite sheet? äº†è§£æ›´å¤šå…³äº Spritesheet åŠ¨ç”»çš„ä¿¡æ¯ã€‚ Note: å…³äº SpriteSheet ç´ æçš„åˆ¶ä½œæœ‰ä¸€æ¬¾å·¥å…· SpriteSheetMaker æ¨èä½¿ç”¨ã€‚ 12345678910111213141516@interface YYSpriteSheetImage : UIImage &lt;YYAnimatedImage&gt;// åˆå§‹åŒ–æ–¹æ³•ï¼Œè¿™ä¸ªç¬¬ä¸€æ¬¡æ¥è§¦ Spritesheet çš„åŒå­¦å¯èƒ½ä¼šè§‰å¾—æ¯”è¾ƒç¹ç- (nullable instancetype)initWithSpriteSheetImage:(UIImage *)image contentRects:(NSArray&lt;NSValue *&gt; *)contentRects frameDurations:(NSArray&lt;NSNumber *&gt; *)frameDurations loopCount:(NSUInteger)loopCount;@property (nonatomic, readonly) NSArray&lt;NSValue *&gt; *contentRects; // å¸§ä½ç½®ä¿¡æ¯@property (nonatomic, readonly) NSArray&lt;NSValue *&gt; *frameDurations; // å¸§æŒç»­æ—¶é•¿@property (nonatomic, readonly) NSUInteger loopCount; // å¾ªç¯æ•°// æ ¹æ®ç´¢å¼•æ‰¾åˆ°å¯¹åº”å¸§ CALayer çš„ä½ç½®- (CGRect)contentsRectForCALayerAtIndex:(NSUInteger)index;@end å…¶ä¸­åˆå§‹åŒ–æ–¹æ³•çš„å…¥å‚ä¸º SpriteSheet ç”»å¸ƒï¼ˆåŒ…å«æ‰€æœ‰åŠ¨ç”»å¸§çš„å¤§å›¾ï¼‰imageï¼Œæ¯ä¸€å¸§çš„ä½ç½® contentRectsï¼Œæ¯ä¸€å¸§å¯¹åº”çš„æŒç»­æ˜¾ç¤ºæ—¶é—´ frameDurationsï¼Œå¾ªç¯æ¬¡æ•° loopCountï¼Œåˆå§‹åŒ–ç¤ºä¾‹åœ¨ YYImage æºæ–‡ä»¶ YYSpriteSheetImage.h æ³¨é‡Šä¸­æœ‰å†™ã€‚ Note: ä¸‹æ–‡ä¸­è¦è®²çš„ YYAnimatedImageView ä¸­å®šä¹‰äº† YYAnimatedImage åè®®ï¼Œè¿™ä¸ªåè®®ä¸­æœ‰ä¸€ä¸ªå¯é€‰æ–¹æ³• animatedImageContentsRectAtIndex: å°±æ˜¯ä¸º YYSpriteSheetImage é‡èº«æ‰“é€ çš„ã€‚ è¿™é‡Œéœ€è¦æä¸€ä¸‹ contentsRectForCALayerAtIndex: æ¥å£ä¼šæ ¹æ®ç´¢å¼•æ‰¾åˆ°å¯¹åº”å¸§çš„ CALayer ä½ç½®ï¼Œè¯¥æ¥å£è¿”å›ä¸€ä¸ªç”± 0.0~1.0 ä¹‹é—´çš„æ•°å€¼ç»„æˆçš„å›¾å±‚å®šä½ LayerRectï¼Œå¦‚æœåœ¨æŸ¥æ‰¾ä½ç½®è¿‡ç¨‹ä¸­å‘ç°å¼‚å¸¸åˆ™è¿”å› CGRectMake(0, 0, 1, 1)ï¼Œå…¶å†…éƒ¨å®ç°å¤§ä½“æ­¥éª¤ï¼š æ ¡éªŒå…¥å‚ç´¢å¼•æ˜¯å¦è¶…è¿‡ SpriteSheet åˆ†å‰²å¸§æ€»æ•°ï¼Œè¶…è¿‡è¿”å› CGRectMake(0, 0, 1, 1) æ²¡è¶…è¿‡åˆ™é€šè¿‡ YYAnimatedImage åè®®çš„ animatedImageContentsRectAtIndex: æ–¹æ³•æ‰¾åˆ°å¯¹åº”ç´¢å¼•çš„çœŸå®ä½ç½® RealRect é€šè¿‡çœŸå®ä½ç½® RealRect ä¸ SpriteSheet ç”»å¸ƒçš„æ¯”ç®—é”™ 0.0~1.0 ä¹‹é—´çš„å€¼ï¼Œå¾—åˆ°æŒ‡å®šç´¢å¼•å¸§çš„é€»è¾‘å®šä½ LogicRect é€šè¿‡ CGRectIntersection æ–¹æ³•è®¡ç®—é€»è¾‘å®šä½ LogicRect ä¸ CGRectMake(0, 0, 1, 1) çš„äº¤é›†ï¼Œç¡®ä¿é€»è¾‘å®šä½æ²¡æœ‰è¶…å‡ºç”»å¸ƒçš„éƒ¨åˆ† å°†å¤„ç†åçš„é€»è¾‘å®šä½ LogicRect ä½œä¸ºå›¾å±‚å®šä½ LayerRect è¿”å› è¿”å›çš„ LayerRect ä½œä¸ºå¯¹åº”ç´¢å¼•å¸§çš„ç”»å¸ƒå†…ç›¸å¯¹ä½ç½®å­˜åœ¨ï¼Œç»“åˆç”»å¸ƒå°±å¯ä»¥å®šä½åˆ°å¯¹åº”å¸§å›¾åƒçš„å…·ä½“å°ºå¯¸å’Œä½ç½®ã€‚ YYAnimatedImageView äººçœ¼ä¸­å‘ˆç°çš„åŠ¨ç”»æ˜¯ç”±ä¸€å¹…å¹…å†…å®¹è¿è´¯çš„å›¾åƒä»¥è¾ƒçŸ­æ—¶é—´æŒ‰é¡ºåºæ›¿æ¢å½¢æˆçš„ï¼Œæ‰€ä»¥è¦æ˜¾ç¤ºåŠ¨ç”»åªéœ€è¦çŸ¥é“åŠ¨ç”»é¡ºåºä¸­æ¯ä¸€å¸§å›¾åƒä»¥åŠå¯¹åº”çš„æ˜¾ç¤ºæ—¶é—´ç­‰ä¿¡æ¯å³å¯ã€‚YYImage ä¸­å¯¹åº”äº UIImage å±‚çº§çš„å†…å®¹ï¼ˆYYImage, YYFrameImage, YYSpriteSheetImageï¼‰åœ¨ä¸Šæ–‡å·²ç»ä»‹ç»è¿‡äº†ï¼Œè™½ç„¶å®ƒä»¬ä¹‹é—´å­˜åœ¨å†…å®¹å’Œå½¢å¼ä¸Šçš„å·®å¼‚ï¼Œä½†æ˜¯å¯¹äºäººçœ¼åŠ¨ç”»å‘ˆç°çš„åŸç†å´æ˜¯ä¸å˜çš„ã€‚ YYAnimatedImageView æ˜¯ YYImage çš„é‡è¦ç»„æˆï¼Œå®ƒæ˜¯ UIImageView çš„å­ç±»ï¼Œè´Ÿè´£ YYImage å›¾åƒå±‚ä¸­ä¸åŒçš„å›¾åƒç±»çš„è§†å›¾æ˜¾ç¤ºï¼ˆåŒ…å«åŠ¨æ€å›¾åƒçš„åŠ¨ç”»æ’­æ”¾ï¼‰ï¼Œå…¶å†…éƒ¨åŒ…å« YYAnimatedImage åè®®ä»¥åŠ YYAnimatedImageView è‡ªèº«ä¸¤éƒ¨åˆ†ã€‚ YYAnimatedImage åè®®ä¸Šæ–‡æåˆ°ä¸è®ºæ˜¯ YYImage, YYFrameImage, YYSpriteSheetImage è¿˜æ˜¯ä»¥åå¯èƒ½ä¼šæ‰©å±•çš„å›¾åƒç±»ï¼Œè™½ç„¶å®ƒä»¬ä¹‹é—´å­˜åœ¨å†…å®¹å’Œå½¢å¼ä¸Šçš„å·®å¼‚ï¼Œä½†æ˜¯å¯¹äºäººçœ¼åŠ¨ç”»å‘ˆç°çš„åŸç†å´æ˜¯ä¸å˜çš„ã€‚ YYAnimatedImage åè®®å°±æ˜¯åœ¨ä¸å½±å“åŸæ¥å›¾åƒç±»çš„æƒ…å†µä¸‹æŠŠä¸åŒå›¾åƒç±»ä¹‹é—´çš„å…±æ€§æ‰¾å‡ºæ¥ï¼ˆæ±‚åŒå­˜å¼‚ï¼Ÿç¬‘ï¼‰ï¼Œä»¥ç»Ÿä¸€åŒ–çš„æ¥å£å°†äººçœ¼åŠ¨ç”»å‘ˆç°æ‰€éœ€çš„åŸºæœ¬ä¿¡æ¯è¾“å‡ºç»™ YYAnimatedImageView ä½¿ç”¨çš„åè®®ã€‚ Note: ä½œä¸ºå›¾åƒç±»é¡»éµå¾ª YYAnimatedImage åè®®ä»¥ä¾¿å¯ä»¥ä½¿ç”¨ YYAnimatedImageView æ’­æ”¾åŠ¨ç”»ã€‚ 12345678910111213141516171819@protocol YYAnimatedImage &lt;NSObject&gt;@required// åŠ¨ç”»å¸§æ€»æ•°- (NSUInteger)animatedImageFrameCount;// åŠ¨ç”»å¾ªç¯æ¬¡æ•°ï¼Œ0 è¡¨ç¤ºæ— é™å¾ªç¯- (NSUInteger)animatedImageLoopCount;// æ¯å¸§å­—èŠ‚æ•°ï¼ˆåœ¨å†…å­˜ä¸­ï¼‰ï¼Œå¯èƒ½ç”¨äºä¼˜åŒ–å†…å­˜ç¼“å†²åŒºå¤§å°- (NSUInteger)animatedImageBytesPerFrame;// è¿”å›ç»™å®šç‰¹æ®Šç´¢å¼•å¯¹åº”çš„å¸§å›¾åƒï¼Œè¿™ä¸ªæ–¹æ³•å¯èƒ½åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­è°ƒç”¨- (nullable UIImage *)animatedImageFrameAtIndex:(NSUInteger)index;// è¿”å›ç»™å®šç‰¹æ®Šç´¢å¼•å¯¹åº”çš„å¸§å›¾åƒå¯¹åº”çš„æ˜¾ç¤ºæŒç»­æ—¶é•¿- (NSTimeInterval)animatedImageDurationAtIndex:(NSUInteger)index;@optional// é’ˆå¯¹ Spritesheet åŠ¨ç”»çš„æ–¹æ³•ï¼Œç”¨äºæ˜¾ç¤ºæŸä¸€å¸§å›¾åƒåœ¨ Spritesheet ç”»å¸ƒä¸­çš„ä½ç½®- (CGRect)animatedImageContentsRectAtIndex:(NSUInteger)index;@end ä¸Šæ–‡æåˆ°è¿‡å¯é€‰å®ç°æ¥å£ animatedImageContentsRectAtIndex: æ˜¯ä¸“ä¸º Spritesheet åŠ¨ç”»è®¾è®¡çš„ã€‚ åƒè¿™æ ·è§„å®šä¸€ä¸ªåè®®ï¼Œä½¿ä¸ç›¸å…³çš„ç±»éµå¾ªæ­¤åè®®æ‹¥æœ‰ç»Ÿä¸€çš„åŠŸèƒ½æ¥å£æ–¹ä¾¿å¦ä¸€ä¸ªç±»è°ƒç”¨çš„è®¾è®¡æ€æƒ³æˆ‘ä»¬åœ¨è‡ªå·±æ—¥å¸¸é¡¹ç›®çš„å¼€å‘è¿‡ç¨‹ä¸­å¾ˆå¤šåœºæ™¯éƒ½å¯ä»¥ç”¨åˆ°ï¼Œä¾‹å¦‚å¯ä»¥å°è£…ä¸€ä¸ª TableViewï¼Œè®¾è®¡ä¸€ä¸ª TableViewCell åè®®ï¼Œè®©æ‰€æœ‰ TableViewCell éƒ½å®ç°è¿™ä¸ªåè®®ä»¥æ‹¥æœ‰ç»Ÿä¸€çš„åŠŸèƒ½æ¥å£ï¼Œç„¶åæˆ‘ä»¬å°è£…çš„ TableView ç±»å°±å¯ä»¥ç»Ÿä¸€çš„ä½¿ç”¨è¿™äº› TableViewCell æ˜¾ç¤ºæ•°æ®å•¦ï¼Œçœå»äº†åå¤å†™ç›¸åŒåŠŸèƒ½ UITableView çš„åŠ³åŠ¨åŠ›ï¼ˆå®é™…åº”ç”¨åœºæ™¯å¾ˆå¤šï¼Œè¿™é‡Œåªæ˜¯ç®€å•ä¸¾ä¾‹ï¼ŒæŠ›ç –å¼•ç‰ï¼‰ã€‚ YYAnimatedImageViewä¸Šæ–‡æåˆ°è¿‡ YYAnimatedImageView ä½œä¸º YYImage æ¡†æ¶ä¸­çš„å›¾ç‰‡è§†å›¾å±‚ï¼Œä¸Šæ¥å›¾åƒå±‚ï¼Œä¸‹å¯ç¼–/è§£ç åº•å±‚ï¼Œæ˜¯æ¢çº½ä¸€èˆ¬çš„å­˜åœ¨ï¼ˆæ‰¿ä¸Šå¯ä¸‹å•Šæœ‰æœ¨æœ‰ï¼Ÿï¼‰ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹ç ”ç©¶å…¶å†…éƒ¨å®ç°ï¼š 1234567891011121314@interface YYAnimatedImageView : UIImageView// å¦‚æœ image ä¸ºå¤šå¸§ç»„æˆæ—¶ï¼Œè‡ªåŠ¨èµ‹å€¼ä¸º YESï¼Œå¯ä»¥åœ¨æ˜¾ç¤ºå’Œéšè—æ—¶è‡ªåŠ¨æ’­æ”¾å’Œåœæ­¢åŠ¨ç”»@property (nonatomic) BOOL autoPlayAnimatedImage;// å½“å‰æ˜¾ç¤ºçš„å¸§ï¼ˆä» 0 èµ·å§‹ï¼‰ï¼Œè®¾ç½®æ–°å€¼åä¼šç«‹å³æ˜¾ç¤ºå¯¹åº”å¸§ï¼Œå¦‚æœæ–°å€¼æ— æ•ˆåˆ™æ­¤æ–¹æ³•æ— æ•ˆ@property (nonatomic) NSUInteger currentAnimatedImageIndex;// å½“å‰æ˜¯å¦åœ¨æ’­æ”¾åŠ¨ç”»@property (nonatomic, readonly) BOOL currentIsPlayingAnimation;// åŠ¨ç”»å®šæ—¶å™¨æ‰€åœ¨çš„ runloop modeï¼Œé»˜è®¤ä¸º NSRunLoopCommonModesï¼Œå…³ä¹åŠ¨ç”»å®šæ—¶å™¨çš„è§¦å‘@property (nonatomic, copy) NSString *runloopMode;// å†…éƒ¨ç¼“å­˜åŒºçš„æœ€å¤§å€¼ï¼ˆin bytesï¼‰ï¼Œé»˜è®¤ä¸º 0ï¼ˆåŠ¨æ€ï¼‰ï¼Œå¦‚æœæœ‰å€¼å°†ä¼šæŠŠç¼“å­˜åŒºé™åˆ¶ä¸ºå€¼å¤§å°ï¼Œå½“æ”¶åˆ°å†…å­˜è­¦å‘Šæˆ–è€… App è¿›å…¥åå°æ—¶ï¼Œç¼“å­˜åŒºå°†ä¼šç«‹å³é‡Šæ”¾å¹¶ä¸”åœ¨é€‚æ—¶çš„æ—¶å€™å›å¤åŸçŠ¶@property (nonatomic) NSUInteger maxBufferSize;@end é¢â€¦å‡ºä¹æ„æ–™çš„ç®€å•å‘¢~ åªæœ‰ä¸€äº›å±æ€§æš´éœ²å‡ºæ¥ä»¥ä¾¿æˆ‘ä»¬åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å®æ—¶æŸ¥çœ‹åŠ¨ç”»çš„æ’­æ”¾çŠ¶æ€ä»¥åŠå†…å­˜ä½¿ç”¨æƒ…å†µã€‚ç¬”è€…çœ‹æºç æ€»ç»“å‡ºä¸€æ¡ç»éªŒï¼Œå³å¦‚æœæŸä¸ªç»„ä»¶åœ¨åº“ä¸­å æ®é‡è¦åœ°ä½ï¼Œå…¶ .h æ–‡ä»¶ä¸­æš´éœ²çš„å†…å®¹è¶Šæ˜¯ç®€å•ï¼Œå…¶ .m å†…éƒ¨å®ç°å°±è¶Šæ˜¯å¤æ‚ã€‚ é€šè¿‡ runloopMode å±æ€§å¤§å®¶ç”¨çŒœçš„ä¹Ÿåº”è¯¥å¯ä»¥çŒœå‡º YYAnimatedImageView å†…éƒ¨å®ç°åŠ¨ç”»çš„åŸç†ç¦»ä¸å¼€ RunLoopï¼Œè€Œä¸”ææœ‰å¯èƒ½æ˜¯ç”¨å®šæ—¶å™¨ NSTimer æˆ–è€… CADisplayLink å®ç°çš„ã€‚ä¸‹é¢æˆ‘ä»¬æ¥å¯¹ YYAnimatedImageView çš„å®ç°å‰–æï¼ŒéªŒè¯ä¸€ä¸‹æˆ‘ä»¬åˆšæ‰çš„çŒœæƒ³ã€‚ YYAnimatedImageView çš„å®ç°å‰–æYYAnimatedImageView å†…éƒ¨å®ç°æºç å¾ˆæœ‰è¶£ï¼Œæœ‰å¾ˆå¤šå€¼å¾—åˆ†äº«çš„åœ°æ–¹ã€‚ä¸è¿‡ä¸ºäº†ä¸æŠŠæ–‡ç« å†™æˆ MarkDown ç¼–è¾‘å™¨æ–‡ï¼ˆç¬‘~ï¼‰ç¬”è€…ä¸ä¼šé€è¡Œç¿»è¯‘æºç ã€‚è¯»è€…å¦‚æœæƒ³è¦çŸ¥é“å®ç°çš„ç»†èŠ‚å»ºè®®ç»“åˆæ–‡ç« å»ç¿»é˜…æºç ã€‚ç›¸ä¿¡æœ‰äº†æ–‡ç« æ¢³ç†çš„æ€è·¯æºç çœ‹èµ·æ¥åº”è¯¥ä¸ä¼šæœ‰å¤ªå¤§çš„å›°éš¾ï¼Œæ–‡ç« è¿˜æ˜¯é‡åœ¨ä¼ æ’­å®ç°æ€æƒ³å’Œä¸€äº›å€¼å¾—åˆ†äº«çš„æŠ€å·§ã€‚ æˆ‘ä»¬å…ˆç®€å•çœ‹ä¸€ä¸‹ YYAnimatedImageView çš„å†…éƒ¨ç»“æ„ï¼Œæ–¹ä¾¿åé¢åˆ†æå®ç°æ€è·¯æ—¶å¤§å®¶è„‘ä¸­å¯¹ YYAnimatedImageView çš„ç»“æ„æå‰æœ‰ä¸€ä¸ªå¤§æ¦‚çš„è®¤è¯†ã€‚ 123456789101112131415161718192021222324252627282930@interface YYAnimatedImageView() &#123; @package UIImage &lt;YYAnimatedImage&gt; *_curAnimatedImage; ///&lt; å½“å‰å›¾åƒ dispatch_once_t _onceToken; ///&lt; ç”¨äºç¡®ä¿åˆå§‹åŒ–ä»£ç åªæ‰§è¡Œä¸€æ¬¡ dispatch_semaphore_t _lock; ///&lt; ä¿¡å·é‡é”ï¼ˆç”¨äº _bufferï¼‰ NSOperationQueue *_requestQueue; ///&lt; å›¾ç‰‡è¯·æ±‚é˜Ÿåˆ—ï¼Œä¸²è¡Œ CADisplayLink *_link; ///&lt; å¸§è½¬æ¢ NSTimeInterval _time; ///&lt; ä¸Šä¸€å¸§ä¹‹åçš„æ—¶é—´ UIImage *_curFrame; ///&lt; å½“å‰å¸§ NSUInteger _curIndex; ///&lt; å½“å‰å¸§ç´¢å¼• NSUInteger _totalFrameCount; ///&lt; å¸§æ€»æ•° BOOL _loopEnd; ///&lt; æ˜¯å¦åœ¨å¾ªç¯æœ«å°¾ NSUInteger _curLoop; ///&lt; å½“å‰å¾ªç¯æ¬¡æ•° NSUInteger _totalLoop; ///&lt; æ€»å¾ªç¯æ¬¡æ•°, 0 è¡¨ç¤ºæ— ç©· NSMutableDictionary *_buffer; ///&lt; å¸§ç¼“å†²åŒº BOOL _bufferMiss; ///&lt; æ˜¯å¦ä¸¢å¸§ï¼Œåœ¨ä¸Šé¢ _link å®šæ—¶æ‰§è¡Œçš„ step å‡½æ•°ä¸­ä»å¸§ç¼“å†²åŒºè¯»å–ä¸‹ä¸€å¸§å›¾ç‰‡æ—¶å¦‚æœæ²¡è¯»åˆ°ï¼Œåˆ™è§†ä¸ºä¸¢å¸§ NSUInteger _maxBufferCount; ///&lt; æœ€å¤§ç¼“å†²è®¡æ•° NSInteger _incrBufferCount; ///&lt; å½“å‰å…è®¸çš„ç¼“å­˜åŒºè®¡æ•°ï¼ˆå°†é€æ­¥å¢åŠ ï¼‰ CGRect _curContentsRect; ///&lt; é’ˆå¯¹ YYSpriteSheetImage BOOL _curImageHasContentsRect; ///&lt; å›¾åƒç±»æ˜¯å¦å®ç°äº† animatedImageContentsRectAtIndex: æ¥å£&#125;@property (nonatomic, readwrite) BOOL currentIsPlayingAnimation;- (void)calcMaxBufferCount; // åŠ¨æ€è°ƒèŠ‚ç¼“å†²åŒºæœ€å¤§é™åˆ¶ _maxBufferCount@end å¯ä»¥çœ‹åˆ° YYAnimatedImageView å†…éƒ¨ç»“æ„æ¯” .h ä¸­æš´éœ²çš„å±æ€§è¦å¤æ‚çš„å¤šï¼Œè€Œ CADisplayLink *_link å±æ€§ä¹Ÿè¯å®äº†æˆ‘ä»¬ä¹‹å‰å…³äº .h ä¸­ runloopMode å±æ€§çš„çŒœæƒ³ã€‚ YYAnimatedImageView å†…éƒ¨çš„åˆå§‹åŒ–æ²¡ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„ï¼Œåˆå§‹åŒ–å‡½æ•°ä¸­ä¼šè®¾ç½®å›¾ç‰‡ï¼Œå½“åˆ¤å®šå›¾ç‰‡æœ‰æ›´æ”¹æ—¶ä¼šä¾ç…§ä¸‹é¢ 4 æ­¥å»å¤„ç†ï¼š æ”¹å˜å›¾ç‰‡ é‡ç½®åŠ¨ç”» åˆå§‹åŒ–åŠ¨ç”»å‚æ•° é‡ç»˜ Note: è¿™æ ·å¯ä»¥ä¿è¯ YYAnimatedImageView çš„å›¾ç‰‡æ›´æ”¹æ—¶éƒ½ä¼šæ‰§è¡Œä¸Šé¢çš„æ­¥éª¤ä¸ºæ–°çš„å›¾ç‰‡åˆå§‹åŒ–é…å¥—çš„æ–°åŠ¨ç”»å‚æ•°å¹¶ä¸”é‡ç»˜ï¼Œè€Œé‡ç½®åŠ¨ç”»å®ç°ä¸­ä¼šä½¿ç”¨åˆ°ä¸Šé¢çš„ dispatch_once_t _onceToken; ä»¥ç¡®ä¿æŸäº›å†…éƒ¨å˜é‡çš„åˆ›å»ºä»¥åŠå¯¹ App å†…å­˜è­¦å‘Šå’Œè¿›å…¥åå°çš„é€šçŸ¥è§‚å¯Ÿä»£ç åªæ‰§è¡Œä¸€æ¬¡ã€‚ YYAnimatedImageView ä½¿å›¾ç‰‡åŠ¨èµ·æ¥æ˜¯ä¾é  CADisplayLink *_link; å˜é‡åˆ‡æ¢å¸§å›¾åƒï¼Œå…¶å†…éƒ¨çš„å®ç°é€»è¾‘å¯ä»¥ç®€å•ç†è§£ä¸ºï¼š æ ¹æ®å½“å‰å¸§ç´¢å¼•æ¨å‡ºä¸‹ä¸€å¸§ç´¢å¼• ä½¿ç”¨ä¸‹ä¸€å¸§ç´¢å¼•å»å¸§ç¼“å†²åŒºå°è¯•è·å–å¯¹åº”å¸§å›¾åƒ å¦‚æœæ‰¾åˆ°å¯¹åº”å¸§å›¾åƒåˆ™ä½¿ç”¨å…¶é‡ç»˜ å¦‚æœæ²¡æ‰¾åˆ°åˆ™æ ¹æ®æ¡ä»¶å‘å›¾ç‰‡è¯·æ±‚é˜Ÿåˆ—åŠ å…¥è¯·æ±‚æ“ä½œï¼ˆå‘å›¾ç‰‡ç¼“å†²åŒºå½•å…¥ä¹‹åçš„å¸§å›¾åƒæ•°æ®ï¼‰ å˜›~ è¿™é‡Œé¢æœ‰ä¸€äº›å€¼å¾—ä¸€æçš„å®ç°ç»†èŠ‚å“ˆï¼ YYAnimatedImageView å®ç°ä¸­å½“ _curIndex å³å½“å‰å¸§ç´¢å¼•ä¿®æ”¹æ—¶åœ¨ä¿®æ”¹ä»£ç å‰ååŠ å…¥äº† willChangeValueForKey: ä¸ didChangeValueForKey: æ–¹æ³•ä»¥æ”¯æŒ KVO å¯¹å¸§ç¼“å†²åŒº _buffer çš„æ“ä½œéƒ½ä½¿ç”¨ _lock ä¸Šé” é€šè¿‡å°†å›¾ç‰‡è¯·æ±‚é˜Ÿåˆ— _requestQueue çš„ maxConcurrentOperationCount è®¾ç½®ä¸º 1 ä½¿å›¾ç‰‡è¯·æ±‚é˜Ÿåˆ—æˆä¸ºä¸²è¡Œé˜Ÿåˆ—ï¼ˆæœ€å¤§å¹¶å‘æ•°ä¸º 1ï¼‰ å›¾ç‰‡è¯·æ±‚é˜Ÿåˆ—ä¸­åŠ å…¥çš„æ“ä½œå‡ä¸º _YYAnimatedImageViewFetchOperation ä¸ºäº†é¿å…ä½¿ç”¨ CADisplayLink å¯èƒ½é€ æˆçš„å¾ªç¯å¼•ç”¨è®¾è®¡äº† _YYImageWeakProxy å…ˆçœ‹ä¸€ä¸‹ _YYAnimatedImageViewFetchOperation çš„æºç ï¼š 123456789@interface _YYAnimatedImageViewFetchOperation : NSOperation@property (nonatomic, weak) YYAnimatedImageView *view;@property (nonatomic, assign) NSUInteger nextIndex;@property (nonatomic, strong) UIImage &lt;YYAnimatedImage&gt; *curImage;@end@implementation _YYAnimatedImageViewFetchOperation- (void)main &#123;//...&#125;@end _YYAnimatedImageViewFetchOperation ç»§æ‰¿è‡ª NSOperation ç±»ï¼Œæ˜¯è‡ªå®šä¹‰æ“ä½œç±»ï¼Œä½œè€…å°†å…¶æ“ä½œå†…å®¹å®ç°å†™åœ¨äº† main ä¸­ï¼Œä»£ç å¤ªé•¿è€Œä¸”æˆ‘è§‰å¾—è´´å‡ºæ¥ä¸ä»…ä¸ä¼šå¸®åŠ©è¯»è€…ç†è§£åè€Œä¼šå› ä¸ºç‰‡é¢çš„æºç å®ç°å½±å“è¯»è€…å¯¹ YYAnimatedImageView çš„æ•´ä½“å®ç°æ€è·¯ç†è§£ï¼ˆå› ä¸ºå¤§é‡è´´æºç ä¼šä½¿æ–‡ç« ç”Ÿæ¶©å¾ˆå¤šï¼Œè€Œä¸”ä¼šæŠŠè¯»è€…æ³¨æ„åŠ›è½¬ç§»åˆ°æŸä¸€ä¸ªå®ç°ï¼‰ï¼Œè¿™é‡Œç®€å•æè¿°ä¸€ä¸‹ main å‡½æ•°å†…éƒ¨å®ç°é€»è¾‘ï¼š åˆ¤æ–­å¸§ç¼“å†²åŒºå¤§å° æ‰«æä¸‹ä¸€å¸§ä»¥åŠå½“å‰å…è®¸ç¼“å†²èŒƒå›´å†…ä¹‹åçš„å¸§å›¾ç‰‡ å¦‚æœå‘ç°ä¸¢å¤±çš„å¸§åˆ™å°è¯•é‡æ–°è·å–å¸§å›¾åƒå¹¶åŠ å…¥åˆ°å¸§ç¼“å†² å˜›~ ä¸è´´æºç å½’ä¸è´´æºç ï¼Œè¯¥æ³¨æ„çš„ç»†èŠ‚è¿˜æ˜¯éœ€è¦åˆ—å‡ºæ¥çš„ï¼ˆç¬‘ï¼‰ã€‚ æ“ä½œä¸­å¯¹äº view ç¼“å†²åŒºçš„æ“ä½œä¹Ÿéƒ½ä¸Šäº†é” æ“ä½œç”±äºæ˜¯æ”¾å…¥å›¾ç‰‡è¯·æ±‚é˜Ÿåˆ—ä¸­è¿›è¡Œçš„ï¼Œå†…éƒ¨æœ‰å¯¹ isCancelled åšåˆ¤æ–­ï¼Œå¦‚æœæ“ä½œå·²ç»è¢«å–æ¶ˆï¼ˆå‘ç”Ÿåœ¨æ›´æ”¹å›¾ç‰‡ã€åœæ­¢åŠ¨ç”»ã€æ‰‹åŠ¨æ›´æ”¹å½“å‰å¸§ã€æ”¶åˆ°å†…å­˜è­¦å‘Šæˆ– App è¿›å…¥åå°ç­‰ï¼‰åˆ™éœ€è¦åŠæ—¶è·³å‡º å¯¹äºæ–°çš„çº¿ç¨‹ä¼˜å…ˆçº§åªåœ¨ main æ–¹æ³•èŒƒå›´å†…æœ‰æ•ˆï¼Œæ‰€ä»¥æ¨èæŠŠæ“ä½œçš„å®ç°æ”¾åœ¨ main ä¸­è€Œé startï¼ˆå¦‚éœ€è¦†ç›– start æ–¹æ³•æ—¶ï¼Œéœ€è¦å…³æ³¨ isExecuting å’Œ isFinished ä¸¤ä¸ª key pathsï¼‰ YYAnimatedImageView å†…éƒ¨è®¾è®¡äº† _YYImageWeakProxy æ¥é¿å…ä½¿ç”¨ NSTimer æˆ–è€… CADisplayLink å¯èƒ½é€ æˆçš„å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œ_YYImageWeakProxy å†…éƒ¨å®ç°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œç»§æ‰¿è‡ª NSProxyï¼Œå…³äº NSProxy å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ä»¥äº†è§£æ›´å¤šã€‚ 1234567891011121314151617181920@interface _YYImageWeakProxy : NSProxy@property (nonatomic, weak, readonly) id target;- (instancetype)initWithTarget:(id)target;+ (instancetype)proxyWithTarget:(id)target;@end@implementation _YYImageWeakProxy// ...- (id)forwardingTargetForSelector:(SEL)selector &#123; return _target;&#125;- (void)forwardInvocation:(NSInvocation *)invocation &#123; void *null = NULL; [invocation setReturnValue:&amp;null];&#125;- (NSMethodSignature *)methodSignatureForSelector:(SEL)selector &#123; return [NSObject instanceMethodSignatureForSelector:@selector(init)];&#125;// ...@end ä¸Šé¢è´´å‡ºçš„æºç çœç•¥äº†æ¯”è¾ƒåŸºç¡€çš„å®ç°éƒ¨åˆ†ï¼Œ_YYImageWeakProxy å†…éƒ¨å¼±å¼•ç”¨ä¸€ä¸ªå¯¹è±¡ targetï¼Œå¯¹äº _YYImageWeakProxy çš„ä¸€äº›åŸºæœ¬æ“ä½œåŒ…å« hash å’Œ isEqual è¿™äº›ç»Ÿç»Ÿéƒ½è½¬åˆ° target ä¸Šï¼Œå¹¶ä¸”ä½¿ç”¨ forwardingTargetForSelector: æ¶ˆæ¯é‡å®šå‘å°†ä¸èƒ½å“åº”çš„è¿è¡Œæ—¶æ¶ˆæ¯ä¹Ÿé‡å®šå‘ç»™ target æ¥å“åº”ã€‚ Emmmmm..é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæ—¢ç„¶éƒ½æ¶ˆæ¯é‡å®šå‘ç»™ target äº†è¿˜è¦æ¶ˆæ¯è½¬å‘å¹²å˜›ï¼Ÿå› ä¸ºè¦é¿å…å¾ªç¯å¼•ç”¨é—®é¢˜æ‰€ä»¥å¯¹ target ä½¿ç”¨å¼±å¼•ç”¨ï¼ŒæœŸé—´æ— æ³•ä¿è¯ target ä¸€å®šå­˜åœ¨ï¼Œæ‰€ä»¥ forwardingTargetForSelector: æ–¹æ³•å¯èƒ½è¿”å› nilï¼Œæ¥ç€åœ¨ Runtime æ¶ˆæ¯è½¬å‘ä¸­å€Ÿç”¨ init æ¶ˆæ¯è¿”å›ç©ºä»¥â€œåæ‰â€å¼‚å¸¸ã€‚ Note: æ¶ˆæ¯è½¬å‘äº§ç”Ÿçš„å¼€é”€è¦æ¯”åŠ¨æ€æ–¹æ³•è§£æå’Œæ¶ˆæ¯é‡å®šå‘å¤§ã€‚ YYImageCoder YYImageCoder ä½œä¸º YYImage çš„ç¼–/è§£ç å™¨ï¼Œå¯¹åº”äº iOS ä¸­çš„ ImageIO.framework å›¾ç‰‡ç¼–/è§£ç åº“ï¼Œæ­£æ˜¯å› ä¸ºæœ‰äº† YYImageCoder çš„å­˜åœ¨ï¼ŒYYImage æ‰å¾—ä»¥æ”¯æŒå¦‚æ­¤å¤šçš„å›¾ç‰‡æ ¼å¼ï¼Œæ‰€ä»¥è¯´ YYImageCoder æ˜¯ YYImage çš„åº•å±‚æ ¸å¿ƒã€‚ YYImageCoder å†…éƒ¨å®šä¹‰äº†è®¸å¤š YYImage ä¸­ç”¨åˆ°çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š YYImageTypeï¼Œæ‰€æœ‰çš„æ”¯æŒçš„å›¾ç‰‡æ ¼å¼åšäº†æšä¸¾å®šä¹‰ YYImageDisposeMethodï¼ŒæŒ‡å®šåœ¨ç”»å¸ƒä¸Šæ¸²æŸ“ä¸‹ä¸€ä¸ªå¸§ä¹‹å‰å¦‚ä½•å¤„ç†å½“å‰å¸§æ‰€ä½¿ç”¨çš„åŒºåŸŸæ–¹æ³• YYImageBlendOperationï¼ŒæŒ‡å®šå½“å‰å¸§çš„é€æ˜åƒç´ å¦‚ä½•ä¸å‰ä¸€ä¸ªç”»å¸ƒçš„é€æ˜åƒç´ æ··åˆæ“ä½œ YYImageFrameï¼Œä¸€å¸§å›¾åƒæ•°æ® YYImageEncoderï¼Œå›¾åƒç¼–ç å™¨ YYImageDecoderï¼Œå›¾åƒè§£ç å™¨ UIImage+YYImageCoderï¼ŒUIImage çš„åˆ†ç±»ï¼Œé‡Œé¢æä¾›äº†ä¸€äº›æ–¹ä¾¿ä½¿ç”¨çš„æ–¹æ³• å…¶ä¸­ YYImageFrame æ˜¯å¯¹ä¸€å¸§å›¾åƒæ•°æ®çš„å°è£…ï¼Œä¾¿äºåœ¨ YYImageCoder ç¼–/è§£ç è¿‡ç¨‹ä¸­ä½¿ç”¨ã€‚ YYImageCoder å†…éƒ¨å›¾åƒç¼–ç å™¨ YYImageEncoder å’Œå›¾åƒè§£ç å™¨ YYImageDecoder å…¶å®æ˜¯åˆ†å¼€æ¥çš„ï¼Œæˆ‘ä»¬ä¸‹é¢åˆ†åˆ«å¯¹å®ƒä»¬åšåˆ†æã€‚ YYImageEncoderå…ˆæ¥è®²ä¸€ä¸‹ YYImageEncoderï¼Œå…¶åœ¨ YYImageCoder ä¸­æ‹…ä»»ç¼–ç å™¨çš„è§’è‰²ã€‚ 1234567891011121314151617181920212223242526272829@interface YYImageEncoder : NSObject@property (nonatomic, readonly) YYImageType type; ///&lt; å›¾åƒç±»å‹@property (nonatomic) NSUInteger loopCount; ///&lt; å¾ªç¯æ¬¡æ•°ï¼Œ0 æ— é™å¾ªç¯ï¼Œä»…é€‚ç”¨äº GIF/APNG/WebP æ ¼å¼@property (nonatomic) BOOL lossless; ///&lt; æ— æŸæ ‡è®°ï¼Œä»…é€‚ç”¨äº WebP.@property (nonatomic) CGFloat quality; ///&lt; å‹ç¼©è´¨é‡ï¼Œ0.0~1.0ï¼Œä»…é€‚ç”¨äº JPG/JP2/WebP.// ç¦æ­¢é€‚ç”¨ initã€new åˆå§‹åŒ–ç¼–ç å™¨ï¼ˆæˆ‘æ²¡å¿˜è®°æˆ‘è¯´è¿‡è¿™äº›ç¼–ç æŠ€å·§ä¼šåœ¨ä¹‹åç»Ÿä¸€å†™ä¸€ç¯‡æ–‡ç« æ±‡æ€»ï¼‰- (instancetype)init UNAVAILABLE_ATTRIBUTE;+ (instancetype)new UNAVAILABLE_ATTRIBUTE;// æ ¹æ®ç»™å®šå›¾ç‰‡ç±»å‹åˆ›å»ºç¼–ç å™¨- (nullable instancetype)initWithType:(YYImageType)type NS_DESIGNATED_INITIALIZER;// æ·»åŠ å›¾åƒ- (void)addImage:(UIImage *)image duration:(NSTimeInterval)duration;// æ·»åŠ å›¾åƒæ•°æ®- (void)addImageWithData:(NSData *)data duration:(NSTimeInterval)duration;// æ·»åŠ æ–‡ä»¶è·¯å¾„- (void)addImageWithFile:(NSString *)path duration:(NSTimeInterval)duration;// å¼€å§‹å›¾åƒç¼–ç å¹¶å°è¯•è¿”å›ç¼–ç åçš„æ•°æ®- (nullable NSData *)encode;// ç¼–ç å¹¶å°†å¾—åˆ°çš„æ•°æ®ä¿å­˜åˆ°ç»™å®šè·¯å¾„æ–‡ä»¶ä¸­- (BOOL)encodeToFile:(NSString *)path;// ä¾¿æ·æ–¹æ³•ï¼Œå¯¹ä¸€ä¸ªå•å¸§å›¾åƒç¼–ç + (nullable NSData *)encodeImage:(UIImage *)image type:(YYImageType)type quality:(CGFloat)quality;// ä¾¿æ·æ–¹æ³•ï¼Œä»è§£ç å™¨ä¸­ç¼–ç å›¾åƒæ•°æ®+ (nullable NSData *)encodeImageWithDecoder:(YYImageDecoder *)decoder type:(YYImageType)type quality:(CGFloat)quality;@end å¯ä»¥çœ‹åˆ° YYImageEncoder å†…éƒ¨çš„ä¸€äº›å±æ€§å’Œæ¥å£éƒ½æ¯”è¾ƒåŸºæœ¬ï¼Œå…³äºå…¶å†…éƒ¨å®ç°æˆ‘ä»¬éœ€è¦å…ˆçœ‹ä¸€ä¸‹ç§æœ‰å˜é‡ï¼š 1234@implementation YYImageEncoder &#123; NSMutableArray *_images; // å·²æ·»åŠ åˆ°ç¼–ç å™¨çš„å›¾ç‰‡ï¼ˆæ•°ç»„ï¼‰ NSMutableArray *_durations; // å¯¹åº”çš„å›¾ç‰‡å¸§æ˜¾ç¤ºæŒç»­æ—¶é•¿ï¼ˆæ•°ç»„ï¼‰&#125; YYImageEncoder çš„å®ç°æ€è·¯YYImageEncoder çš„åˆå§‹åŒ–éƒ¨åˆ†æ²¡æœ‰å¤šå¤æ‚ï¼Œæ ¹æ®å›¾ç‰‡çš„ç±»å‹æŒ‰ç…§ç¼–ç æœ€ä¼˜çš„å‚æ•°åšåˆå§‹åŒ–è€Œå·²ã€‚å…³äº YYImageEncoder å¯¹äºå›¾ç‰‡çš„ç¼–ç å·¥ä½œï¼Œå…¶å®ä½œè€…æ ¹æ®è¦æ”¯æŒçš„å›¾ç‰‡ç±»å‹å’Œå¯¹åº”å›¾ç‰‡ç±»å‹çš„ç¼–ç æ–¹å¼åšäº†åº•å±‚å°è£…ï¼Œå†æ ¹æ®å½“å‰å›¾ç‰‡çš„ç±»å‹é€‰æ‹©å¯¹åº”çš„åº•å±‚ç¼–ç æ–¹æ³•æ‰§è¡Œã€‚ å…³äºä¸åŒå›¾ç‰‡ç±»å‹çš„å›¾ç‰‡ç¼–ç æ ¼å¼å¯ä»¥æŸ¥é˜…æœ¬æ–‡æ–‡æœ«çš„æ‰©å±•é˜…è¯»ç« èŠ‚ï¼Œç»“åˆæ‰©å±•é˜…è¯»çš„å†…å®¹æŸ¥é˜… YYImage è¿™éƒ¨åˆ†æºç å¯ä»¥ç†è§£ä½œè€…å¯¹äºåº•å±‚å›¾ç‰‡æ ¼å¼ä¿¡æ¯çš„ç»“æ„å°è£…ä»¥åŠç¼–/è§£ç æ“ä½œå…·ä½“å®ç°ã€‚ å…³äº YYImageEncoder çš„ä¸€äº›ç®€å•ä½¿ç”¨ç¤ºä¾‹å¯ä»¥æŸ¥çœ‹ YYImageCoder.h äº†è§£ã€‚ YYImageDecoderYYImageDecoder åœ¨ YYImageCoder ä¸­æ‹…ä»»è§£ç å™¨çš„è§’è‰²ï¼Œå…¶ä¸ä¸Šè¿° YYImageEncoder å¯¹åº”ï¼Œä¸€ä¸ªè´Ÿè´£å›¾åƒç¼–ç ä¸€ä¸ªè´Ÿè´£å›¾åƒè§£ç ï¼Œä¸è¿‡ YYImageDecoder çš„å®ç°æ¯” YYImageEncoder æ›´ä¸ºå¤æ‚ã€‚ 123456789101112131415161718192021222324252627@interface YYImageDecoder : NSObject@property (nullable, nonatomic, readonly) NSData *data; ///&lt; å›¾åƒæ•°æ®@property (nonatomic, readonly) YYImageType type; ///&lt; å›¾åƒæ•°æ®ç±»å‹@property (nonatomic, readonly) CGFloat scale; ///&lt; å›¾åƒå¤§å°@property (nonatomic, readonly) NSUInteger frameCount; ///&lt; å›¾åƒå¸§æ•°é‡@property (nonatomic, readonly) NSUInteger loopCount; ///&lt; å›¾åƒå¾ªç¯æ¬¡æ•°ï¼Œ0 æ— é™å¾ªç¯@property (nonatomic, readonly) NSUInteger width; ///&lt; å›¾åƒç”»å¸ƒå®½åº¦@property (nonatomic, readonly) NSUInteger height; ///&lt; å›¾åƒç”»å¸ƒé«˜åº¦@property (nonatomic, readonly, getter=isFinalized) BOOL finalized;// åˆ›å»ºä¸€ä¸ªå›¾åƒè§£ç å™¨- (instancetype)initWithScale:(CGFloat)scale NS_DESIGNATED_INITIALIZER;// ç”¨æ–°æ•°æ®å¢é‡æ›´æ–°å›¾åƒ- (BOOL)updateData:(nullable NSData *)data final:(BOOL)final;// æ–¹ä¾¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„æ•°æ®åˆ›å»ºå¯¹åº”çš„è§£ç å™¨+ (nullable instancetype)decoderWithData:(NSData *)data scale:(CGFloat)scale;// è§£ç å¹¶è¿”å›ç»™å®šç´¢å¼•å¯¹åº”çš„å¸§æ•°æ®- (nullable YYImageFrame *)frameAtIndex:(NSUInteger)index decodeForDisplay:(BOOL)decodeForDisplay;// è¿”å›ç»™å®šç´¢å¼•å¯¹åº”çš„å¸§æŒç»­æ˜¾ç¤ºæ—¶é•¿- (NSTimeInterval)frameDurationAtIndex:(NSUInteger)index;// è¿”å›ç»™å®šç´¢å¼•å¯¹åº”å¸§çš„å±æ€§ä¿¡æ¯ï¼Œå» ImageIO.framework çš„ &quot;CGImageProperties.h&quot; æ–‡ä»¶ä¸­äº†è§£æ›´å¤š- (nullable NSDictionary *)framePropertiesAtIndex:(NSUInteger)index;// è¿”å›å›¾ç‰‡çš„å±æ€§ä¿¡æ¯ï¼Œå» ImageIO.framework çš„ &quot;CGImageProperties.h&quot; æ–‡ä»¶ä¸­äº†è§£æ›´å¤š- (nullable NSDictionary *)imageProperties;@end å¯ä»¥çœ‹åˆ° YYImageDecoder æš´éœ²äº†ä¸€äº›å…³äºè§£ç å›¾åƒçš„å±æ€§å¹¶æä¾›äº†åˆå§‹åŒ–è§£ç å™¨æ–¹æ³•ã€å›¾åƒè§£ç æ–¹æ³•ä»¥åŠè®¿é—®å›¾åƒå¸§ä¿¡æ¯çš„æ–¹æ³•ã€‚ä¸è¿‡ä¸Šæ–‡ä¹Ÿè¯´è¿‡ YYImageDecoder çš„å®ç°æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬æ¥ç€çœ‹ä¸€ä¸‹å…¶å†…éƒ¨å˜é‡ç»“æ„ï¼š 1234567891011121314151617@implementation YYImageDecoder &#123; pthread_mutex_t _lock; // é€’å½’é” BOOL _sourceTypeDetected; // æ˜¯å¦æ¨æµ‹å›¾åƒæºç±»å‹ CGImageSourceRef _source; // å›¾åƒæº yy_png_info *_apngSource; // å¦‚æœåˆ¤å®šå›¾åƒä¸º YYImageTypePNG åˆ™ä¼šä»¥ APNG æ›´æ–°å›¾åƒæº#if YYIMAGE_WEBP_ENABLED WebPDemuxer *_webpSource; // å¦‚æœåˆ¤å®šå›¾åƒä¸º YYImageTypeWebP åˆ™ä¼šè®® WebP æ›´æ–°å›¾åƒæº#endif UIImageOrientation _orientation; // ç»˜åˆ¶æ–¹å‘ dispatch_semaphore_t _framesLock; // é’ˆå¯¹äºå›¾åƒå¸§çš„é” NSArray *_frames; ///&lt; Array&lt;_YYImageDecoderFrame *&gt;, without image BOOL _needBlend; // æ˜¯å¦éœ€è¦æ··åˆ NSUInteger _blendFrameIndex; // ä»å¸§ç´¢å¼•æ··åˆåˆ°å½“å‰å¸§ CGContextRef _blendCanvas; // æ··åˆç”»å¸ƒ&#125; _YYImageDecoderFrame ç»§æ‰¿è‡ª YYImageFrame ç±»ä½œä¸º YYImageCoder å›¾åƒè§£ç å™¨ YYImageDecoder ä½¿ç”¨çš„å†…éƒ¨æ¡†æ¶ç±»å­˜åœ¨ï¼Œæ˜¯å¯¹äºä¸€å¸§å›¾åƒçš„æ•°æ®å°è£…æä¾›äº†ä¾¿äºç¼–/è§£ç æ—¶éœ€è¦è®¿é—®çš„æ•°æ®ã€‚ YYImageDecoder å†…é”çš„é€‰æ‹©å¯ä»¥çœ‹åˆ°ä½œè€…åœ¨ YYImageDecoder å†…éƒ¨ä½¿ç”¨äº†ä¸¤ç§é”ï¼š pthread_mutex_t _lock; dispatch_semaphore_t _framesLock; pthread_mutex_t åœ¨è§£ç å™¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­è¢«ä»¥ PTHREAD_MUTEX_RECURSIVE ç±»å‹è®¾ç½®ä¸ºäº†é€’å½’é”ã€‚ 12345pthread_mutexattr_t attr;pthread_mutexattr_init (&amp;attr);pthread_mutexattr_settype (&amp;attr, PTHREAD_MUTEX_RECURSIVE);pthread_mutex_init (&amp;_lock, &amp;attr);pthread_mutexattr_destroy (&amp;attr); Note: ä¸€èˆ¬æƒ…å†µä¸‹ä¸€ä¸ªçº¿ç¨‹åªèƒ½ç”³è¯·ä¸€æ¬¡é”ï¼Œä¹Ÿåªèƒ½åœ¨è·å¾—é”çš„æƒ…å†µä¸‹æ‰èƒ½é‡Šæ”¾é”ï¼Œå¤šæ¬¡ç”³è¯·é”æˆ–é‡Šæ”¾æœªè·å¾—çš„é”éƒ½ä¼šå¯¼è‡´å´©æºƒã€‚å‡è®¾åœ¨å·²ç»è·å¾—é”çš„æƒ…å†µä¸‹å†æ¬¡ç”³è¯·é”ï¼Œçº¿ç¨‹ä¼šå› ä¸ºç­‰å¾…é”çš„é‡Šæ”¾è€Œè¿›å…¥ç¡çœ çŠ¶æ€ï¼Œå› æ­¤å°±ä¸å¯èƒ½å†é‡Šæ”¾é”ï¼Œä»è€Œå¯¼è‡´æ­»é”ã€‚ ç„¶è€Œè¿™ç§æƒ…å†µç»å¸¸ä¼šå‘ç”Ÿï¼Œæ¯”å¦‚æŸä¸ªå‡½æ•°ç”³è¯·äº†é”ï¼Œåœ¨ä¸´ç•ŒåŒºå†…åˆé€’å½’è°ƒç”¨äº†è‡ªå·±ã€‚è¾›è¿çš„æ˜¯ pthread_mutex æ”¯æŒé€’å½’é”ï¼Œä¹Ÿå°±æ˜¯å…è®¸ä¸€ä¸ªçº¿ç¨‹é€’å½’çš„ç”³è¯·é”ï¼Œåªè¦æŠŠ attr çš„ç±»å‹æ”¹æˆ PTHREAD_MUTEX_RECURSIVE å³å¯ã€‚ ä½œè€…ä½¿ç”¨ dispatch_semaphore_t ä½œä¸ºå›¾åƒå¸§æ•°ç»„çš„é”æ˜¯å› ä¸º dispatch_semaphore_t æ›´åŠ è½»é‡ä¸”å¯¹äºå›¾åƒå¸§æ•°ç»„çš„ä¸´ç•Œæ“ä½œæ¯”è¾ƒå¿«ï¼Œä¸ä¼šé€ æˆé•¿æ—¶é—´çš„é˜»å¡ï¼Œè¿™ç§æƒ…å†µä¸‹ dispatch_semaphore_t å…·æœ‰æ€§èƒ½ä¼˜åŠ¿ï¼ˆEmmmmmm..è€ç”Ÿå¸¸è°ˆäº†ï¼Œç†Ÿæ‚‰çš„åŒå­¦ä¸è¦æŠ±æ€¨ï¼Œç…§é¡¾ä¸€ä¸‹åé¢çš„åŒå­¦ï¼‰ã€‚ YYImageDecoder å†…çš„å®ç°æ€è·¯YYImageDecoder å†…åœ¨åˆå§‹åŒ–æ—¶ä¼šåˆå§‹åŒ–é”å¹¶æ›´æ–°å›¾åƒæºæ•°æ®ï¼Œåœ¨æ›´æ–°å›¾åƒæºæ—¶è°ƒç”¨ _updateSource æ–¹æ³•æ ¹æ®å½“å‰å›¾åƒç±»å‹ä»¥ä½œè€…å¯¹è¯¥ç±»å‹å°è£…å¥½çš„åº•å±‚æ•°æ®ç»“æ„å’Œå¯¹åº”å›¾åƒç±»å‹è§£ç è§„åˆ™åšè§£ç ï¼Œè§£ç ä¹‹åè®¾ç½®å¯¹åº”å±æ€§ã€‚ å…³äºä½œè€…å¯¹ä¸åŒæ ¼å¼çš„å›¾åƒæ•°æ®çš„åº•å±‚å°è£…æºç æ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å‚è€ƒæœ¬æ–‡æ–‡æœ«çš„æ‰©å±•é˜…è¯»ç« èŠ‚å†…å®¹è‡ªè¡ŒæŸ¥é˜…ã€‚ å…³äº YYImageDecoder çš„ä¸€äº›ç®€å•ä½¿ç”¨ç¤ºä¾‹å¯ä»¥æŸ¥çœ‹ YYImageCoder.h äº†è§£ã€‚ æ€»ç»“ æ–‡ç« ç³»ç»Ÿçš„åˆ†æäº† YYImage æºç ï¼Œå¸Œæœ›å„ä½è¯»è€…åœ¨é˜…è¯»æœ¬æ–‡ä¹‹åå¯ä»¥å¯¹ YYImage æ•´ä½“æ¶æ„å’Œè®¾è®¡æ€è·¯æœ‰æ¸…æ™°çš„è®¤è¯†ã€‚ æ–‡ç« å¯¹ YYImage çš„ Image å±‚çº§çš„ä¸‰ç±»å›¾åƒï¼ˆYYImage, YYFrameImage, YYSpriteSheetImageï¼‰åˆ†åˆ«è§£è¯»ï¼Œå¸Œæœ›å¯ä»¥å¯¹å„ä½è¯»è€…å…³äºè¿™ä¸‰ç±»å›¾åƒçš„ç»„æˆåŸç†å’Œå‘ˆç°åŠ¨ç”»çš„æ–¹å¼çš„ç†è§£æœ‰æ‰€å¸®åŠ©ã€‚ æ–‡ç« æ·±å…¥å‰–æäº† YYAnimatedImageView çš„å†…éƒ¨å®ç°ï¼Œæç‚¼å‡ºå…¶è®¾è®¡æ€è·¯ä»¥ä¾›è¯»è€…æ¢ç©¶ã€‚ ç¬”è€…æŠŠè‡ªå·±åœ¨é˜…è¯»æºç ä¸­å‘ç°çš„å€¼å¾—åˆ†äº«çš„å®ç°ç»†èŠ‚ç»“åˆæºç å•ç‹¬æ‹å‡ºæ¥åˆ†æï¼Œå¸Œæœ›å„ä½è¯»è€…å¯ä»¥åœ¨è‡ªå·±å¹³æ—¶å·¥ä½œä¸­é‡åˆ°ç›¸ä¼¼æƒ…å†µæ—¶èƒ½å¤Ÿå¤šä¸€äº›æ€è·¯ï¼Œå°è£…é¡¹ç›®ç»„ä»¶æ—¶å¯ä»¥ç”¨åˆ°è¿™äº›æŠ€å·§ã€‚ æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ https://lision.me/ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ ä¸ªäººåšå®¢ ä¸­æ›´æ–°ã€‚èƒ½åŠ›ä¸è¶³ï¼Œæ°´å¹³æœ‰é™ï¼Œå¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš @Lision è”ç³»æˆ‘ï¼Œå¦å¤–æˆ‘çš„ GitHub ä¸»é¡µ é‡Œæœ‰å¾ˆå¤šæœ‰è¶£çš„å°ç©æ„å“¦~ æœ€åï¼Œå¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~ æ‰©å±•é˜…è¯» libpng å®˜ç½‘å…³äº PNG ç»“æ„çš„å®˜æ–¹è¯´æ˜ APNG çš„ç»´åŸºç™¾ç§‘ WebP å¼€å‘è€…æ–‡æ¡£"},{"title":"æ­ç§˜ YYModel çš„é­”æ³• 0x02","comments":true,"permalink":"https://lision.me/yymodel0x02/","text":"å‰è¨€åœ¨ä¸Šæ–‡ã€Šæ­ç§˜ YYModel çš„é­”æ³•ï¼ˆä¸Šï¼‰ã€‹ ä¸­ä¸»è¦å‰–æäº† YYModel çš„æºç ç»“æ„ï¼Œå¹¶ä¸”åˆ†äº«äº† YYClassInfo ä¸ NSObject+YYModel å†…éƒ¨æœ‰è¶£çš„å®ç°ç»†èŠ‚ã€‚ ç´§æ¥ä¸Šç¯‡ï¼Œæœ¬æ–‡å°†è§£è¯» YYModel å…³äº JSON æ¨¡å‹è½¬æ¢çš„æºç ï¼Œæ—¨åœ¨æ­ç§˜ JSON æ¨¡å‹è‡ªåŠ¨è½¬æ¢é­”æ³•ã€‚ ç´¢å¼• JSON ä¸ Model ç›¸äº’è½¬æ¢ æ€»ç»“ JSON ä¸ Model ç›¸äº’è½¬æ¢JSON(JavaScript Object Notation) æ˜¯ä¸€ç§è½»é‡çº§çš„æ•°æ®äº¤æ¢æ ¼å¼ï¼Œå®ƒæ˜“äºäººä»¬é˜…è¯»å’Œç¼–å†™ï¼ŒåŒæ—¶ä¹Ÿæ˜“äºæœºå™¨è§£æå’Œç”Ÿæˆã€‚å®ƒæ˜¯åŸºäº JavaScript Programming Language, Standard ECMA-262 3rd Edition - December 1999 çš„ä¸€ä¸ªå­é›†ã€‚JSON é‡‡ç”¨å®Œå…¨ç‹¬ç«‹äºè¯­è¨€çš„æ–‡æœ¬æ ¼å¼ï¼Œä½†æ˜¯ä¹Ÿä½¿ç”¨äº†ç±»ä¼¼äº C è¯­è¨€å®¶æ—çš„ä¹ æƒ¯ï¼ˆåŒ…æ‹¬C, C++, C#, Java, JavaScript, Perl, Pythonç­‰ï¼‰ã€‚è¿™äº›ç‰¹æ€§ä½¿ JSON æˆä¸ºç†æƒ³çš„æ•°æ®äº¤æ¢è¯­è¨€ï¼Œç‚¹å‡» è¿™é‡Œ äº†è§£æ›´å¤šå…³äº JSON çš„ä¿¡æ¯ã€‚ Model æ˜¯ é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼ˆObject Oriented Programmingï¼Œç®€ç§° OOPï¼‰ç¨‹åºè®¾è®¡æ€æƒ³ä¸­çš„å¯¹è±¡ï¼ŒOOP æŠŠå¯¹è±¡ä½œä¸ºç¨‹åºçš„åŸºæœ¬å•å…ƒï¼Œä¸€ä¸ªå¯¹è±¡åŒ…å«äº†æ•°æ®å’Œæ“ä½œæ•°æ®çš„å‡½æ•°ã€‚ä¸€èˆ¬æˆ‘ä»¬ä¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚æ¥åˆ›å»ºå¯¹è±¡ï¼Œåœ¨ä¸€äº›è®¾è®¡æ¨¡å¼ä¸­ï¼ˆå¦‚ MVC ç­‰ï¼‰å¯¹è±¡ä¸€èˆ¬ä½œä¸ºæ¨¡å‹ï¼ˆModelï¼‰ï¼Œå³å¯¹è±¡å»ºæ¨¡ã€‚ JSON ä¸ Model ç›¸äº’è½¬æ¢æŒ‰è½¬æ¢æ–¹å‘åˆ†ä¸ºä¸¤ç§ï¼š JSON to Model Model to JSON JSON to Modelæˆ‘ä»¬ä» YYModel çš„æ¥å£å¼€å§‹è§£è¯»ã€‚ 123456+ (instancetype)yy_modelWithJSON:(id)json &#123; // å°† json è½¬ä¸ºå­—å…¸ dic NSDictionary *dic = [self _yy_dictionaryWithJSON:json]; // å†é€šè¿‡ dic å¾—åˆ° model å¹¶è¿”å› return [self yy_modelWithDictionary:dic];&#125; ä¸Šé¢æ¥å£æŠŠ JSON è½¬ Model å¾ˆç®€å•çš„åˆ†ä¸ºäº†ä¸¤ä¸ªå­ä»»åŠ¡ï¼š JSON to NSDictionary NSDictionary to Model JSON to NSDictionaryæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ _yy_dictionaryWithJSON æ˜¯æ€ä¹ˆå°† json è½¬ä¸º NSDictionary çš„ã€‚ 12345678910111213141516171819202122232425262728+ (NSDictionary *)_yy_dictionaryWithJSON:(id)json &#123; // å…¥å‚åˆ¤ç©º if (!json || json == (id)kCFNull) return nil; NSDictionary *dic = nil; NSData *jsonData = nil; // æ ¹æ® json çš„ç±»å‹å¯¹åº”æ“ä½œ if ([json isKindOfClass:[NSDictionary class]]) &#123; // å¦‚æœæ˜¯ NSDictionary ç±»åˆ™ç›´æ¥èµ‹å€¼ dic = json; &#125; else if ([json isKindOfClass:[NSString class]]) &#123; // å¦‚æœæ˜¯ NSString ç±»åˆ™ç”¨ UTF-8 ç¼–ç è½¬ NSData jsonData = [(NSString *)json dataUsingEncoding : NSUTF8StringEncoding]; &#125; else if ([json isKindOfClass:[NSData class]]) &#123; // å¦‚æœæ˜¯ NSData åˆ™ç›´æ¥èµ‹å€¼ç»™ jsonData jsonData = json; &#125; // jsonData ä¸ä¸º nilï¼Œåˆ™è¡¨ç¤ºä¸Šé¢çš„ 2ã€3 æƒ…å†µä¸­çš„ä¸€ç§ if (jsonData) &#123; // åˆ©ç”¨ NSJSONSerialization æ–¹æ³•å°† jsonData è½¬ä¸º dic dic = [NSJSONSerialization JSONObjectWithData:jsonData options:kNilOptions error:NULL]; // åˆ¤æ–­è½¬æ¢ç»“æœ if (![dic isKindOfClass:[NSDictionary class]]) dic = nil; &#125; return dic;&#125; è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯æ ¹æ®å…¥å‚çš„ç±»å‹åˆ¤æ–­å¦‚ä½•å°†å…¶è½¬ä¸º NSDictionary ç±»å‹å¹¶è¿”å›ã€‚ å…¶ä¸­ kCFNull æ˜¯ CoreFoundation ä¸­ CFNull çš„å•ä¾‹å¯¹è±¡ã€‚å¦‚åŒ Foundation æ¡†æ¶ä¸­çš„ NSNull ä¸€æ ·ï¼ŒCFNull æ˜¯ç”¨æ¥è¡¨ç¤ºé›†åˆå¯¹è±¡ä¸­çš„ç©ºå€¼ï¼ˆä¸å…è®¸ä¸º NULLï¼‰ã€‚CFNull å¯¹è±¡æ—¢ä¸å…è®¸è¢«åˆ›å»ºä¹Ÿä¸å…è®¸è¢«é”€æ¯ï¼Œè€Œæ˜¯é€šè¿‡å®šä¹‰ä¸€ä¸ª CFNull å¸¸é‡ï¼Œå³ kCFNullï¼Œåœ¨éœ€è¦ç©ºå€¼æ—¶ä½¿ç”¨ã€‚ å®˜æ–¹æ–‡æ¡£ï¼šThe CFNull opaque type defines a unique object used to represent null values in collection objects (which donâ€™t allow NULL values). CFNull objects are neither created nor destroyed. Instead, a single CFNull constant objectâ€”kCFNullâ€”is defined and is used wherever a null value is needed. NSJSONSerialization æ˜¯ç”¨äºå°† JSON å’Œç­‰æ•ˆçš„ Foundation å¯¹è±¡ä¹‹é—´ç›¸äº’è½¬æ¢çš„å¯¹è±¡ã€‚å®ƒåœ¨ iOS 7 ä»¥åŠ macOS 10.9ï¼ˆåŒ…å« iOS 7 å’Œ macOS 10.9ï¼‰ä¹‹åæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ ä»£ç ä¸­å°† NSString è½¬ä¸º NSData ç”¨åˆ°äº† NSUTF8StringEncodingï¼Œå…¶ä¸­ç¼–ç ç±»å‹å¿…é¡»å±äº JSON è§„èŒƒä¸­åˆ—å‡ºçš„ 5 ç§æ”¯æŒçš„ç¼–ç ç±»å‹ï¼š UTF-8 UTF-16LE UTF-16BE UTF-32LE UTF-32BE è€Œç”¨äºè§£æçš„æœ€é«˜æ•ˆçš„ç¼–ç æ˜¯ UTF-8 ç¼–ç ï¼Œæ‰€ä»¥ä½œè€…è¿™é‡Œä½¿ç”¨ NSUTF8StringEncodingã€‚ å®˜æ–¹æ³¨é‡Šï¼šThe data must be in one of the 5 supported encodings listed in the JSON specification: UTF-8, UTF-16LE, UTF-16BE, UTF-32LE, UTF-32BE. The data may or may not have a BOM. The most efficient encoding to use for parsing is UTF-8, so if you have a choice in encoding the data passed to this method, use UTF-8. NSDictionary to Modelç°åœ¨æˆ‘ä»¬è¦ä» yy_modelWithJSON æ¥å£ä¸­æ¢ç©¶ yy_modelWithDictionary æ˜¯å¦‚ä½•å°† NSDictionary è½¬ä¸º Model çš„ã€‚ æ•²é»‘æ¿ï¼åšå¥½å‡†å¤‡ï¼Œè¿™ä¸€å°èŠ‚ä»‹ç»çš„ä»£ç æ˜¯ YYModel çš„ç²¾åå“¦~ã€‚ 123456789101112131415161718192021+ (instancetype)yy_modelWithDictionary:(NSDictionary *)dictionary &#123; // å…¥å‚æ ¡éªŒ if (!dictionary || dictionary == (id)kCFNull) return nil; if (![dictionary isKindOfClass:[NSDictionary class]]) return nil; // ä½¿ç”¨å½“å‰ç±»ç”Ÿæˆä¸€ä¸ª _YYModelMeta æ¨¡å‹å…ƒç±» Class cls = [self class]; _YYModelMeta *modelMeta = [_YYModelMeta metaWithClass:cls]; // è¿™é‡Œ _hasCustomClassFromDictionary ç”¨äºæ ‡è¯†æ˜¯å¦éœ€è¦è‡ªå®šä¹‰è¿”å›ç±» // å±äºæ¨¡å‹è½¬æ¢é™„åŠ åŠŸèƒ½ï¼Œå¯ä»¥ä¸ç”¨æŠ•å…¥å¤ªå¤šå…³æ³¨ if (modelMeta-&gt;_hasCustomClassFromDictionary) &#123; cls = [cls modelCustomClassForDictionary:dictionary] ?: cls; &#125; // è°ƒç”¨ yy_modelSetWithDictionary ä¸ºæ–°å»ºçš„ç±»å®ä¾‹ one èµ‹å€¼ï¼Œèµ‹å€¼æˆåŠŸåˆ™è¿”å› one NSObject *one = [cls new]; // æ‰€ä»¥è¿™ä¸ªå‡½æ•°ä¸­æˆ‘ä»¬åº”è¯¥æŠŠæ³¨æ„åŠ›é›†ä¸­åœ¨ yy_modelSetWithDictionary if ([one yy_modelSetWithDictionary:dictionary]) return one; return nil;&#125; ä»£ç ä¸­æ ¹æ® _hasCustomClassFromDictionary æ ‡è¯†åˆ¤æ–­æ˜¯å¦éœ€è¦è‡ªå®šä¹‰è¿”å›æ¨¡å‹çš„ç±»å‹ã€‚è¿™æ®µä»£ç å±äº YYModel çš„é™„åŠ åŠŸèƒ½ï¼Œä¸ºäº†ä¸ä½¿å¤§å®¶åˆ†å¿ƒï¼Œè¿™é‡Œä»…åšç®€å•ä»‹ç»ã€‚ å¦‚æœæˆ‘ä»¬è¦åœ¨ JSON è½¬ Model çš„è¿‡ç¨‹ä¸­æ ¹æ®æƒ…å†µåˆ›å»ºä¸åŒç±»å‹çš„å®ä¾‹ï¼Œåˆ™å¯ä»¥åœ¨ Model ä¸­å®ç°æ¥å£ï¼š 1+ (nullable Class)modelCustomClassForDictionary:(NSDictionary *)dictionary; æ¥æ»¡è¶³éœ€æ±‚ã€‚å½“æ¨¡å‹å…ƒåˆå§‹åŒ–æ—¶ä¼šæ£€æµ‹å½“å‰æ¨¡å‹ç±»æ˜¯å¦å¯ä»¥å“åº”ä¸Šé¢çš„æ¥å£ï¼Œå¦‚æœå¯ä»¥å“åº”åˆ™ä¼šæŠŠ _hasCustomClassFromDictionary æ ‡è¯†ä¸º YESï¼Œæ‰€ä»¥ä¸Šé¢æ‰ä¼šå‡ºç°è¿™äº›ä»£ç ï¼š 123if (modelMeta-&gt;_hasCustomClassFromDictionary) &#123; cls = [cls modelCustomClassForDictionary:dictionary] ?: cls;&#125; å˜›~ æˆ‘è§‰å¾—è¿™äº›é™„åŠ çš„ä¸œè¥¿åœ¨é˜…è¯»æºç æ—¶å¾ˆå¤§ç¨‹åº¦ä¸Šä¼šåˆ†æ•£æˆ‘ä»¬çš„æ³¨æ„åŠ›ï¼Œè¿™æ¬¡å…ˆè¯¦ç»†çš„è®²è§£ä¸€ä¸‹ï¼Œä»¥åé‡åˆ°ç±»ä¼¼çš„ä»£ç æˆ‘ä»¬ä¼šç•¥è¿‡ï¼Œå†…éƒ¨çš„å®ç°å¤§éƒ½ä¸ä¸Šè¿°æ¡ˆä¾‹åŸç†ç›¸åŒï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±ç ”ç©¶å“ˆã€‚ æˆ‘ä»¬åº”è¯¥æŠŠæ³¨æ„åŠ›é›†ä¸­åœ¨ yy_modelSetWithDictionary ä¸Šï¼Œè¿™ä¸ªå‡½æ•°ï¼ˆå…¶å®ä¹Ÿæ˜¯ NSObject+YYModel æš´éœ²çš„æ¥å£ï¼‰æ˜¯æ ¹æ®å­—å…¸åˆå§‹åŒ–æ¨¡å‹çš„å®ç°æ–¹æ³•ã€‚å®ƒçš„ä»£ç æ¯”è¾ƒé•¿ï¼Œå¦‚æœä¸æƒ³çœ‹å¯ä»¥è·³è¿‡ï¼Œåœ¨åé¢æœ‰è§£é‡Šã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364- (BOOL)yy_modelSetWithDictionary:(NSDictionary *)dic &#123; // å…¥å‚æ ¡éªŒ if (!dic || dic == (id)kCFNull) return NO; if (![dic isKindOfClass:[NSDictionary class]]) return NO; // æ ¹æ®è‡ªèº«ç±»ç”Ÿæˆ _YYModelMeta æ¨¡å‹å…ƒç±» _YYModelMeta *modelMeta = [_YYModelMeta metaWithClass:object_getClass(self)]; // å¦‚æœæ¨¡å‹å…ƒç±»é”®å€¼æ˜ å°„æ•°é‡ä¸º 0 åˆ™ return NOï¼Œè¡¨ç¤ºæ„å»ºå¤±è´¥ if (modelMeta-&gt;_keyMappedCount == 0) return NO; // å¿½ç•¥ï¼Œè¯¥æ ‡è¯†å¯¹åº” modelCustomWillTransformFromDictionary æ¥å£ if (modelMeta-&gt;_hasCustomWillTransformFromDictionary) &#123; // è¯¥æ¥å£ç±»ä¼¼ modelCustomTransformFromDictionary æ¥å£ï¼Œä¸è¿‡æ˜¯åœ¨æ¨¡å‹è½¬æ¢ä¹‹å‰è°ƒç”¨çš„ dic = [((id&lt;YYModel&gt;)self) modelCustomWillTransformFromDictionary:dic]; if (![dic isKindOfClass:[NSDictionary class]]) return NO; &#125; // åˆå§‹åŒ–æ¨¡å‹è®¾ç½®ä¸Šä¸‹æ–‡ ModelSetContext ModelSetContext context = &#123;0&#125;; context.modelMeta = (__bridge void *)(modelMeta); context.model = (__bridge void *)(self); context.dictionary = (__bridge void *)(dic); // åˆ¤æ–­æ¨¡å‹å…ƒé”®å€¼æ˜ å°„æ•°é‡ä¸ JSON æ‰€å¾—å­—å…¸çš„æ•°é‡å…³ç³» if (modelMeta-&gt;_keyMappedCount &gt;= CFDictionaryGetCount((CFDictionaryRef)dic)) &#123; // ä¸€èˆ¬æƒ…å†µä¸‹ä»–ä»¬çš„æ•°é‡ç›¸ç­‰ // ç‰¹æ®Šæƒ…å†µæ¯”å¦‚æœ‰çš„å±æ€§å…ƒä¼šæ˜ å°„å­—å…¸ä¸­çš„å¤šä¸ª key // ä¸ºå­—å…¸ä¸­çš„æ¯ä¸ªé”®å€¼å¯¹è°ƒç”¨ ModelSetWithDictionaryFunction // è¿™å¥è¯æ˜¯æ ¸å¿ƒä»£ç ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å°±æ˜¯é  ModelSetWithDictionaryFunction é€šè¿‡å­—å…¸è®¾ç½®æ¨¡å‹ CFDictionaryApplyFunction((CFDictionaryRef)dic, ModelSetWithDictionaryFunction, &amp;context); // åˆ¤æ–­æ¨¡å‹ä¸­æ˜¯å¦å­˜åœ¨æ˜ å°„ keyPath çš„å±æ€§å…ƒ if (modelMeta-&gt;_keyPathPropertyMetas) &#123; // ä¸ºæ¯ä¸ªæ˜ å°„ keyPath çš„å±æ€§å…ƒæ‰§è¡Œ ModelSetWithPropertyMetaArrayFunction CFArrayApplyFunction((CFArrayRef)modelMeta-&gt;_keyPathPropertyMetas, CFRangeMake(0, CFArrayGetCount((CFArrayRef)modelMeta-&gt;_keyPathPropertyMetas)), ModelSetWithPropertyMetaArrayFunction, &amp;context); &#125; // åˆ¤æ–­æ¨¡å‹ä¸­æ˜¯å¦å­˜åœ¨æ˜ å°„å¤šä¸ª key çš„å±æ€§å…ƒ if (modelMeta-&gt;_multiKeysPropertyMetas) &#123; // ä¸ºæ¯ä¸ªæ˜ å°„å¤šä¸ª key çš„å±æ€§å…ƒæ‰§è¡Œ ModelSetWithPropertyMetaArrayFunction CFArrayApplyFunction((CFArrayRef)modelMeta-&gt;_multiKeysPropertyMetas, CFRangeMake(0, CFArrayGetCount((CFArrayRef)modelMeta-&gt;_multiKeysPropertyMetas)), ModelSetWithPropertyMetaArrayFunction, &amp;context); &#125; &#125; else &#123; // æ¨¡å‹å…ƒé”®å€¼æ˜ å°„æ•°é‡å°‘ï¼Œåˆ™è®¤ä¸ºä¸å­˜åœ¨æ˜ å°„å¤šä¸ª key çš„å±æ€§å…ƒ // ç›´æ¥ä¸ºæ¯ä¸ª modelMeta å±æ€§å…ƒæ‰§è¡Œ ModelSetWithPropertyMetaArrayFunction CFArrayApplyFunction((CFArrayRef)modelMeta-&gt;_allPropertyMetas, CFRangeMake(0, modelMeta-&gt;_keyMappedCount), ModelSetWithPropertyMetaArrayFunction, &amp;context); &#125; // å¿½ç•¥ï¼Œè¯¥æ ‡è¯†å¯¹åº”æ¥å£ modelCustomTransformFromDictionary if (modelMeta-&gt;_hasCustomTransformFromDictionary) &#123; // è¯¥æ¥å£ç”¨äºå½“é»˜è®¤ JSON è½¬ Model ä¸é€‚åˆæ¨¡å‹å¯¹è±¡æ—¶åšé¢å¤–çš„é€»è¾‘å¤„ç† // æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªæ¥å£æ¥éªŒè¯æ¨¡å‹è½¬æ¢çš„ç»“æœ return [((id&lt;YYModel&gt;)self) modelCustomTransformFromDictionary:dic]; &#125; return YES;&#125; ä»£ç å·²ç»æ³¨æ˜å¿…è¦ä¸­æ–‡æ³¨é‡Šï¼Œå…³äºä¸¤å¤„è‡ªå®šä¹‰æ‰©å±•æ¥å£æˆ‘ä»¬ä¸å†å¤šè¯´ï¼Œç”±äºä»£ç æ¯”è¾ƒé•¿æˆ‘ä»¬å…ˆæ¥æ¢³ç†ä¸€ä¸‹ yy_modelSetWithDictionary ä¸»è¦åšäº†å“ªäº›äº‹ï¼Ÿ å…¥å‚æ ¡éªŒ åˆå§‹åŒ–æ¨¡å‹å…ƒä»¥åŠæ˜ å°„è¡¨æ ¡éªŒ åˆå§‹åŒ–æ¨¡å‹è®¾ç½®ä¸Šä¸‹æ–‡ ModelSetContext ä¸ºå­—å…¸ä¸­çš„æ¯ä¸ªé”®å€¼å¯¹è°ƒç”¨ ModelSetWithDictionaryFunction æ£€éªŒè½¬æ¢ç»“æœ æ¨¡å‹è®¾ç½®ä¸Šä¸‹æ–‡ ModelSetContext å…¶å®å°±æ˜¯ä¸€ä¸ªåŒ…å«æ¨¡å‹å…ƒï¼Œæ¨¡å‹å®ä¾‹ä»¥åŠå¾…è½¬æ¢å­—å…¸çš„ç»“æ„ä½“ã€‚ 12345typedef struct &#123; void *modelMeta; ///&lt; æ¨¡å‹å…ƒ void *model; ///&lt; æ¨¡å‹å®ä¾‹ï¼ŒæŒ‡å‘è¾“å‡ºçš„æ¨¡å‹ void *dictionary; ///&lt; å¾…è½¬æ¢å­—å…¸&#125; ModelSetContext; å¤§å®¶è‚¯å®šéƒ½æ³¨æ„åˆ°äº† ModelSetWithDictionaryFunction å‡½æ•°ï¼Œä¸è®ºèµ°å“ªæ¡é€»è¾‘åˆ†æ”¯ï¼Œæœ€åéƒ½æ˜¯è°ƒç”¨è¿™ä¸ªå‡½æ•°æŠŠå­—å…¸çš„ keyï¼ˆkeypathï¼‰å¯¹åº”çš„ value å–å‡ºå¹¶èµ‹å€¼ç»™ Model çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ¥çœ‹çœ‹è¿™ä¸ªå‡½æ•°çš„å®ç°ã€‚ 1234567891011121314151617181920// å­—å…¸é”®å€¼å¯¹å»ºæ¨¡static void ModelSetWithDictionaryFunction(const void *_key, const void *_value, void *_context) &#123; // æ‹¿åˆ°å…¥å‚ä¸Šä¸‹æ–‡ ModelSetContext *context = _context; // å–å‡ºä¸Šä¸‹æ–‡ä¸­æ¨¡å‹å…ƒ __unsafe_unretained _YYModelMeta *meta = (__bridge _YYModelMeta *)(context-&gt;modelMeta); // æ ¹æ®å…¥å‚ _key ä»æ¨¡å‹å…ƒä¸­å–å‡ºæ˜ å°„è¡¨å¯¹åº”çš„å±æ€§å…ƒ __unsafe_unretained _YYModelPropertyMeta *propertyMeta = [meta-&gt;_mapper objectForKey:(__bridge id)(_key)]; // æ‹¿åˆ°å¾…èµ‹å€¼æ¨¡å‹ __unsafe_unretained id model = (__bridge id)(context-&gt;model); // éå† propertyMetaï¼Œç›´åˆ° propertyMeta-&gt;_next == nil while (propertyMeta) &#123; // å½“å‰éå†çš„ propertyMeta æœ‰ setter æ–¹æ³•ï¼Œåˆ™è°ƒç”¨ ModelSetValueForProperty èµ‹å€¼ if (propertyMeta-&gt;_setter) &#123; // æ ¸å¿ƒæ–¹æ³•ï¼Œæ‹å‡ºæ¥è®² ModelSetValueForProperty(model, (__bridge __unsafe_unretained id)_value, propertyMeta); &#125; propertyMeta = propertyMeta-&gt;_next; &#125;;&#125; ModelSetWithDictionaryFunction å‡½æ•°çš„å®ç°é€»è¾‘å°±æ˜¯å…ˆé€šè¿‡æ¨¡å‹è®¾ç½®ä¸Šä¸‹æ–‡æ‹¿åˆ°å¸¦èµ‹å€¼æ¨¡å‹ï¼Œä¹‹åéå†å½“å‰çš„å±æ€§å…ƒï¼ˆç›´åˆ° propertyMeta-&gt;_next == nilï¼‰ï¼Œæ‰¾åˆ° setter ä¸ä¸ºç©ºçš„å±æ€§å…ƒé€šè¿‡ ModelSetValueForProperty æ–¹æ³•èµ‹å€¼ã€‚ ModelSetValueForProperty å‡½æ•°æ˜¯ä¸ºæ¨¡å‹ä¸­çš„å±æ€§èµ‹å€¼çš„å®ç°æ–¹æ³•ï¼Œä¹Ÿæ˜¯æ•´ä¸ª YYModel çš„æ ¸å¿ƒä»£ç ã€‚åˆ«ç´§å¼ ï¼Œè¿™ä¸ªå‡½æ•°å†™å¾—å¾ˆå‹å¥½çš„ï¼Œä¹Ÿå°± 300 å¤šè¡Œè€Œå·² ğŸ˜œï¼ˆæ— å…³ç´§è¦çš„å†…å®¹æˆ‘ä¼šå°½é‡å¿½ç•¥æ‰ï¼‰ï¼Œä¸è¿‡å¿½ç•¥çš„å¤ªå¤šä¼šå½±å“ä»£ç é˜…è¯»çš„è¿ç»­æ€§ï¼Œå¦‚æœå«Œé•¿å¯ä»¥ä¸çœ‹ï¼Œæ–‡ç« åé¢ä¼šæ€»ç»“ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å®ç°é€»è¾‘ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209static void ModelSetValueForProperty(__unsafe_unretained id model, __unsafe_unretained id value, __unsafe_unretained _YYModelPropertyMeta *meta) &#123; // å¦‚æœå±æ€§æ˜¯ä¸€ä¸ª CNumberï¼Œå³è¾“å…¥ intã€uintâ€¦â€¦ if (meta-&gt;_isCNumber) &#123; // è½¬ä¸º NSNumber ä¹‹åèµ‹å€¼ NSNumber *num = YYNSNumberCreateFromID(value); // è¿™é‡Œ ModelSetNumberToProperty å°è£…äº†ç»™å±æ€§å…ƒèµ‹å€¼ NSNumber çš„æ“ä½œ ModelSetNumberToProperty(model, num, meta); if (num) [num class]; // hold the number &#125; else if (meta-&gt;_nsType) &#123; // å¦‚æœå±æ€§å±äº nsTypeï¼Œå³ NSStringã€NSNumberâ€¦â€¦ if (value == (id)kCFNull) &#123; // ä¸ºç©ºï¼Œåˆ™èµ‹å€¼ nilï¼ˆé€šè¿‡å±æ€§å…ƒ _setter æ–¹æ³•ä½¿ç”¨ objc_msgSend å°† nil èµ‹å€¼ï¼‰ ((void (*)(id, SEL, id))(void *) objc_msgSend)((id)model, meta-&gt;_setter, (id)nil); &#125; else &#123; // ä¸ä¸ºç©º switch (meta-&gt;_nsType) &#123; // NSString æˆ– NSMutableString case YYEncodingTypeNSString: case YYEncodingTypeNSMutableString: &#123; // å¤„ç†å¯èƒ½çš„ value ç±»å‹ï¼šNSStringï¼ŒNSNumberï¼ŒNSDataï¼ŒNSURLï¼ŒNSAttributedString // å¯¹åº”çš„åˆ†æ”¯å°±æ˜¯æŠŠ value è½¬ä¸º NSString æˆ–è€… NSMutableStringï¼Œä¹‹åè°ƒç”¨ setter èµ‹å€¼ ... &#125; break; // NSValueï¼ŒNSNumber æˆ– NSDecimalNumber case YYEncodingTypeNSValue: case YYEncodingTypeNSNumber: case YYEncodingTypeNSDecimalNumber: &#123; // å¯¹å±æ€§å…ƒçš„ç±»å‹åˆ†æƒ…å†µèµ‹å€¼ï¼ˆä¸­é—´å¯èƒ½ä¼šæ¶‰åŠåˆ°ç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼‰ ... &#125; break; // NSData æˆ– NSMutableData case YYEncodingTypeNSData: case YYEncodingTypeNSMutableData: &#123; // å¯¹å±æ€§å…ƒçš„ç±»å‹åˆ†æƒ…å†µèµ‹å€¼ï¼ˆä¸­é—´å¯èƒ½ä¼šæ¶‰åŠåˆ°ç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼‰ ... &#125; break; // NSDate case YYEncodingTypeNSDate: &#123; // è€ƒè™‘å¯èƒ½çš„ value ç±»å‹ï¼šNSDate æˆ– NSString // è½¬æ¢ä¸º NSDate ä¹‹åèµ‹å€¼ ... &#125; break; // NSURL case YYEncodingTypeNSURL: &#123; // è€ƒè™‘å¯èƒ½çš„ value ç±»å‹ï¼šNSURL æˆ– NSString // è½¬æ¢ä¸º NSDate ä¹‹åèµ‹å€¼ï¼ˆè¿™é‡Œå¯¹ NSString çš„é•¿åº¦åˆ¤æ–­æ˜¯å¦èµ‹å€¼ nilï¼‰ ... &#125; break; // NSArray æˆ– NSMutableArray case YYEncodingTypeNSArray: case YYEncodingTypeNSMutableArray: &#123; // å¯¹å±æ€§å…ƒçš„æ³›å‹åˆ¤æ–­ if (meta-&gt;_genericCls) &#123; // å¦‚æœå­˜åœ¨æ³›å‹ NSArray *valueArr = nil; // value æ‰€å± NSArray åˆ™ç›´æ¥èµ‹å€¼ï¼Œå¦‚æœæ‰€å± NSSet ç±»åˆ™è½¬ä¸º NSArray if ([value isKindOfClass:[NSArray class]]) valueArr = value; else if ([value isKindOfClass:[NSSet class]]) valueArr = ((NSSet *)value).allObjects; // éå†åˆšæ‰é€šè¿‡ value è½¬æ¢æ¥çš„ valueArr if (valueArr) &#123; NSMutableArray *objectArr = [NSMutableArray new]; for (id one in valueArr) &#123; // é‡åˆ° valueArr ä¸­çš„å…ƒç´ å±äºæ³›å‹ç±»ï¼Œç›´æ¥åŠ å…¥ objectArr if ([one isKindOfClass:meta-&gt;_genericCls]) &#123; [objectArr addObject:one]; &#125; else if ([one isKindOfClass:[NSDictionary class]]) &#123; // é‡åˆ° valueArr ä¸­çš„å…ƒç´ æ˜¯å­—å…¸ç±»ï¼Œ Class cls = meta-&gt;_genericCls; // å¿½ç•¥ if (meta-&gt;_hasCustomClassFromDictionary) &#123; cls = [cls modelCustomClassForDictionary:one]; if (!cls) cls = meta-&gt;_genericCls; // for xcode code coverage &#125; // è¿˜è®°å¾—æˆ‘ä»¬ç›´æ¥çš„èµ·ç‚¹ yy_modelSetWithDictionaryï¼Œå°†å­—å…¸è½¬æ¨¡å‹ // æˆ‘è§‰å¾—è¿™åº”è¯¥ç®—æ˜¯ä¸€ä¸ªé—´æ¥é€’å½’è°ƒç”¨ // å¦‚æœè®¾è®¡å‡ºçš„æ¨¡å‹æ˜¯æ— é™é€’å½’ï¼ˆä»å‰æœ‰åº§å±±ï¼Œå±±ä¸Šæœ‰åº§åº™çš„æ•…äº‹ï¼‰ï¼Œé‚£ä¹ˆè‚¯å®šä¼šæ…¢ NSObject *newOne = [cls new]; [newOne yy_modelSetWithDictionary:one]; // è½¬åŒ–æˆåŠŸæœºä¹ŸåŠ å…¥ objectArr if (newOne) [objectArr addObject:newOne]; &#125; &#125; // æœ€åå°†å¾—åˆ°çš„ objectArr èµ‹å€¼ç»™å±æ€§ ((void (*)(id, SEL, id))(void *) objc_msgSend)((id)model, meta-&gt;_setter, objectArr); &#125; &#125; else &#123; // æ²¡æœ‰æ³›å‹ï¼Œå˜›~ åˆ¤æ–­ä¸€ä¸‹ value çš„å¯èƒ½æ‰€å±ç±»å‹ NSArray æˆ– NSSet // è½¬æ¢èµ‹å€¼ï¼ˆæ¶‰åŠ mutableï¼‰ ... &#125; &#125; break; // NSDictionary æˆ– NSMutableDictionary case YYEncodingTypeNSDictionary: case YYEncodingTypeNSMutableDictionary: &#123; // è·Ÿä¸Šé¢æ•°ç»„çš„å¤„ç†è¶…ç›¸ä¼¼ï¼Œæ³›å‹çš„é—´æ¥é€’å½’ä»¥åŠæ— æ³›å‹çš„ç±»å‹è½¬æ¢ï¼ˆmutable çš„å¤„ç†ï¼‰ ... &#125; break; // NSSet æˆ– NSMutableSet case YYEncodingTypeNSSet: case YYEncodingTypeNSMutableSet: &#123; // è·Ÿä¸Šé¢æ•°ç»„çš„å¤„ç†è¶…ç›¸ä¼¼ï¼Œæ³›å‹çš„é—´æ¥é€’å½’ä»¥åŠæ— æ³›å‹çš„ç±»å‹è½¬æ¢ï¼ˆmutable çš„å¤„ç†ï¼‰ ... &#125; default: break; &#125; &#125; &#125; else &#123; // å±æ€§å…ƒä¸å±äº CNumber å’Œ nsType BOOL isNull = (value == (id)kCFNull); switch (meta-&gt;_type &amp; YYEncodingTypeMask) &#123; // id case YYEncodingTypeObject: &#123; if (isNull) &#123; // ç©ºï¼Œèµ‹å€¼ nil ((void (*)(id, SEL, id))(void *) objc_msgSend)((id)model, meta-&gt;_setter, (id)nil); &#125; else if ([value isKindOfClass:meta-&gt;_cls] || !meta-&gt;_cls) &#123; // å±æ€§å…ƒä¸ value ä»å±äºåŒä¸€ä¸ªç±»ï¼Œåˆ™ç›´æ¥èµ‹å€¼ ((void (*)(id, SEL, id))(void *) objc_msgSend)((id)model, meta-&gt;_setter, (id)value); &#125; else if ([value isKindOfClass:[NSDictionary class]]) &#123; // å˜›~ value ä»å±äº NSObject *one = nil; // å¦‚æœå±æ€§å…ƒæœ‰ getter æ–¹æ³•ï¼Œåˆ™é€šè¿‡ getter è·å–åˆ°å®ä¾‹ if (meta-&gt;_getter) &#123; one = ((id (*)(id, SEL))(void *) objc_msgSend)((id)model, meta-&gt;_getter); &#125; if (one) &#123; // ç”¨ yy_modelSetWithDictionary è¾“å‡ºåŒ–å±æ€§å®ä¾‹å¯¹è±¡ [one yy_modelSetWithDictionary:value]; &#125; else &#123; Class cls = meta-&gt;_cls; // ç•¥è¿‡ if (meta-&gt;_hasCustomClassFromDictionary) &#123; cls = [cls modelCustomClassForDictionary:value]; if (!cls) cls = meta-&gt;_genericCls; // for xcode code coverage &#125; // ç”¨ yy_modelSetWithDictionary è¾“å‡ºåŒ–å±æ€§å®ä¾‹å¯¹è±¡ï¼Œèµ‹å€¼ one = [cls new]; [one yy_modelSetWithDictionary:value]; ((void (*)(id, SEL, id))(void *) objc_msgSend)((id)model, meta-&gt;_setter, (id)one); &#125; &#125; &#125; break; // Class case YYEncodingTypeClass: &#123; if (isNull) &#123; // ç©ºï¼Œèµ‹å€¼(Class)NULLï¼Œç”±äº Class å…¶å®æ˜¯ C è¯­è¨€å®šä¹‰çš„ç»“æ„ä½“ï¼Œæ‰€ä»¥ä½¿ç”¨ NULL // å…³äº nilï¼ŒNilï¼ŒNULLï¼ŒNSNullï¼ŒkCFNull çš„æ¨ªå‘æ¯”è¾ƒï¼Œæˆ‘ä¼šå•ç‹¬æ‹å‡ºæ¥åœ¨ä¸‹é¢ä»‹ç» ((void (*)(id, SEL, Class))(void *) objc_msgSend)((id)model, meta-&gt;_setter, (Class)NULL); &#125; else &#123; // åˆ¤æ–­ value å¯èƒ½çš„ç±»å‹ NSString æˆ–åˆ¤æ–­ class_isMetaClass(object_getClass(value)) // å¦‚æœæ»¡è¶³æ¡ä»¶åˆ™èµ‹å€¼ ... &#125; &#125; break; // SEL case YYEncodingTypeSEL: &#123; // åˆ¤ç©ºï¼Œèµ‹å€¼(SEL)NULL // å¦åˆ™è½¬æ¢ç±»å‹ SEL sel = NSSelectorFromString(value); ç„¶åèµ‹å€¼ ... &#125; break; // block case YYEncodingTypeBlock: &#123; // åˆ¤ç©ºï¼Œèµ‹å€¼(void (^)())NULL // å¦åˆ™åˆ¤æ–­ç±»å‹ [value isKindOfClass:YYNSBlockClass()] ä¹‹åèµ‹å€¼ ... &#125; break; // structã€unionã€char[n]ï¼Œå…³äº union å…±åŒä½“æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·± googleï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹ // union å…±åŒä½“ï¼Œç±»ä¼¼ struct çš„å­˜åœ¨ï¼Œä½†æ˜¯ union æ¯ä¸ªæˆå‘˜ä¼šç”¨åŒä¸€ä¸ªå­˜å‚¨ç©ºé—´ï¼Œåªèƒ½å­˜å‚¨æœ€åä¸€ä¸ªæˆå‘˜çš„ä¿¡æ¯ case YYEncodingTypeStruct: case YYEncodingTypeUnion: case YYEncodingTypeCArray: &#123; if ([value isKindOfClass:[NSValue class]]) &#123; // æ¶‰åŠ Type Encodings const char *valueType = ((NSValue *)value).objCType; const char *metaType = meta-&gt;_info.typeEncoding.UTF8String; // æ¯”è¾ƒ valueType ä¸ metaType æ˜¯å¦ç›¸åŒï¼Œç›¸åŒï¼ˆstrcmp(a, b) è¿”å› 0ï¼‰åˆ™èµ‹å€¼ if (valueType &amp;&amp; metaType &amp;&amp; strcmp(valueType, metaType) == 0) &#123; [model setValue:value forKey:meta-&gt;_name]; &#125; &#125; &#125; break; // void* æˆ– char* case YYEncodingTypePointer: case YYEncodingTypeCString: &#123; if (isNull) &#123; // åˆ¤ç©ºï¼Œèµ‹å€¼(void *)NULL ((void (*)(id, SEL, void *))(void *) objc_msgSend)((id)model, meta-&gt;_setter, (void *)NULL); &#125; else if ([value isKindOfClass:[NSValue class]]) &#123; // æ¶‰åŠ Type Encodings NSValue *nsValue = value; if (nsValue.objCType &amp;&amp; strcmp(nsValue.objCType, &quot;^v&quot;) == 0) &#123; ((void (*)(id, SEL, void *))(void *) objc_msgSend)((id)model, meta-&gt;_setter, nsValue.pointerValue); &#125; &#125; &#125; default: break; &#125; &#125;&#125; é¢ ğŸ˜“ æˆ‘æ˜¯çœŸçš„å·²ç»å¿½ç•¥æ‰å¾ˆå¤šä»£ç äº†ï¼Œæ²¡åŠæ³•è¿˜æ˜¯æœ‰ç‚¹é•¿ã€‚å…¶å®ä»£ç é€»è¾‘è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œåªæ˜¯æ¨¡å‹èµ‹å€¼æ¶‰åŠçš„ç¼–ç ç±»å‹ç­‰çç¢é€»è¾‘æ¯”è¾ƒå¤šå¯¼è‡´ä»£ç é‡æ¯”è¾ƒå¤§ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥æ€»ç»“ä¸€ä¸‹æ ¸å¿ƒä»£ç çš„å®ç°é€»è¾‘ã€‚ æ ¹æ®å±æ€§å…ƒç±»å‹åˆ’åˆ†ä»£ç é€»è¾‘ å¦‚æœå±æ€§å…ƒæ˜¯ CNumber ç±»å‹ï¼Œå³ intã€uint ä¹‹ç±»ï¼Œåˆ™ä½¿ç”¨ ModelSetNumberToProperty èµ‹å€¼ å¦‚æœå±æ€§å…ƒå±äº NSType ç±»å‹ï¼Œå³ NSStringã€NSNumber ä¹‹ç±»ï¼Œåˆ™æ ¹æ®ç±»å‹è½¬æ¢ä¸­å¯èƒ½æ¶‰åŠåˆ°çš„å¯¹åº”ç±»å‹åšé€»è¾‘åˆ¤æ–­å¹¶èµ‹å€¼ï¼ˆå¯ä»¥å»ä¸Šé¢ä»£ç ä¸­æŸ¥çœ‹å…·ä½“å®ç°é€»è¾‘ï¼‰ å¦‚æœå±æ€§å…ƒä¸å±äº CNumber å’Œ NSTypeï¼Œåˆ™çŒœæµ‹ä¸º idï¼ŒClassï¼ŒSELï¼ŒBlockï¼Œstructã€unionã€char[n]ï¼Œvoid æˆ– char ç±»å‹å¹¶ä¸”åšå‡ºç›¸åº”çš„è½¬æ¢å’Œèµ‹å€¼ å˜›~ å…¶å®ä¸Šé¢çš„ä»£ç é™¤äº†é•¿ä»¥å¤–é€»è¾‘è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œæ€»ç»“èµ·æ¥å°±æ˜¯æ ¹æ®å¯èƒ½å‡ºç°çš„ç±»å‹å»åšå‡ºå¯¹åº”çš„é€»è¾‘æ“ä½œï¼Œå»ºè®®å„ä½æœ‰æ—¶é—´è¿˜æ˜¯å»è¯»ä¸‹æºç ï¼Œå°¤å…¶æ˜¯è‡ªå·±é¡¹ç›®ä¸­ç”¨åˆ° YYModel çš„åŒå­¦ã€‚ç›¸ä¿¡çœ‹å®Œä¹‹åä¼šå¯¹ YYModel å±æ€§èµ‹å€¼ä¸€æ¸…äºŒæ¥šï¼Œè¿™æ ·åœ¨ä½¿ç”¨ YYModel çš„æ—¥å¸¸ä¸­å‡ºç°ä»»ä½•é—®é¢˜éƒ½å¯ä»¥å¿ƒä¸­æœ‰æ•°ï¼Œæ”¹èµ·ä»£ç è‡ªç„¶å¦‚æœ‰ç¥åŠ©å“ˆã€‚ é¢â€¦è€ƒè™‘åˆ° NSDictionary to Model çš„æ•´ä¸ªè¿‡ç¨‹ä»£ç é‡ä¸å°ï¼Œæˆ‘èŠ±äº†ä¸€äº›æ—¶é—´å°†å…¶é€»è¾‘æ€»ç»“å½’çº³ä¸ºä¸€å¼ å›¾ï¼š å¸Œæœ›å¯ä»¥å°½è‡ªå·±çš„åŠªåŠ›è®©æ–‡ç« çš„è¡¨è¿°å˜å¾—æ›´ç›´ç™½ã€‚ Model to JSON ç›¸æ¯”äº JSON to Model æ¥è¯´ï¼ŒModel to JSON æ›´ç®€å•ä¸€äº›ã€‚å…¶ä¸­å› ä¸º NSJSONSerialization åœ¨å¯¹ JSON çš„è½¬æ¢æ—¶åšäº†ä¸€äº›è§„å®šï¼š é¡¶çº§å¯¹è±¡æ˜¯ NSArray æˆ–è€… NSDictionary ç±»å‹ æ‰€æœ‰çš„å¯¹è±¡éƒ½æ˜¯ NSString, NSNumber, NSArray, NSDictionary, æˆ– NSNull çš„å®ä¾‹ æ‰€æœ‰å­—å…¸ä¸­çš„ key éƒ½æ˜¯ä¸€ä¸ª NSString å®ä¾‹ Numbers æ˜¯é™¤å»æ— ç©·å¤§å’Œ NaN çš„å…¶ä»–è¡¨ç¤º Note: ä¸Šæ–‡å‡ºè‡ª NSJSONSerialization å®˜æ–¹æ–‡æ¡£ã€‚ çŸ¥é“äº†è¿™ä¸€ç‚¹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä» YYModel çš„ Model to JSON æ¥å£ yy_modelToJSONObject å¤„å¼€å§‹è§£è¯»æºç äº†ã€‚ 12345678- (id)yy_modelToJSONObject &#123; // é€’å½’è½¬æ¢æ¨¡å‹åˆ° JSON id jsonObject = ModelToJSONObjectRecursive(self); if ([jsonObject isKindOfClass:[NSArray class]]) return jsonObject; if ([jsonObject isKindOfClass:[NSDictionary class]]) return jsonObject; return nil;&#125; å˜›~ ä¸€å…± 4 è¡Œä»£ç ï¼Œåªéœ€è¦å…³æ³¨ä¸€ä¸‹ç¬¬ä¸€è¡Œä»£ç ä¸­çš„ ModelToJSONObjectRecursive æ–¹æ³•ï¼ŒObjective-C çš„è¯­è¨€ç‰¹æ€§å†³å®šäº†ä»å‡½æ•°åç§°å³å¯æ— éœ€æ³¨é‡Šçœ‹æ‡‚ä»£ç ï¼Œè¿™ä¸ªæ–¹æ³•ä»åå­—ä¸Šå°±å¯ä»¥ get åˆ°å®ƒæ˜¯é€šè¿‡é€’å½’æ–¹æ³•ä½¿ Model è½¬æ¢ä¸º JSON çš„ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141// é€’å½’è½¬æ¢æ¨¡å‹åˆ° JSONï¼Œå¦‚æœè½¬æ¢å¼‚å¸¸åˆ™è¿”å› nilstatic id ModelToJSONObjectRecursive(NSObject *model) &#123; // åˆ¤ç©ºæˆ–è€…å¯ä»¥ç›´æ¥è¿”å›çš„å¯¹è±¡ï¼Œåˆ™ç›´æ¥è¿”å› if (!model || model == (id)kCFNull) return model; if ([model isKindOfClass:[NSString class]]) return model; if ([model isKindOfClass:[NSNumber class]]) return model; // å¦‚æœ model ä»å±äº NSDictionary if ([model isKindOfClass:[NSDictionary class]]) &#123; // å¦‚æœå¯ä»¥ç›´æ¥è½¬æ¢ä¸º JSON æ•°æ®ï¼Œåˆ™è¿”å› if ([NSJSONSerialization isValidJSONObject:model]) return model; NSMutableDictionary *newDic = [NSMutableDictionary new]; // éå† model çš„ key å’Œ value [((NSDictionary *)model) enumerateKeysAndObjectsUsingBlock:^(NSString *key, id obj, BOOL *stop) &#123; NSString *stringKey = [key isKindOfClass:[NSString class]] ? key : key.description; if (!stringKey) return; // é€’å½’è§£æ value id jsonObj = ModelToJSONObjectRecursive(obj); if (!jsonObj) jsonObj = (id)kCFNull; newDic[stringKey] = jsonObj; &#125;]; return newDic; &#125; // å¦‚æœ model ä»å±äº NSSet if ([model isKindOfClass:[NSSet class]]) &#123; // å¦‚æœèƒ½å¤Ÿç›´æ¥è½¬æ¢ JSON å¯¹è±¡ï¼Œåˆ™ç›´æ¥è¿”å› // å¦åˆ™éå†ï¼ŒæŒ‰éœ€è¦é€’å½’è§£æ ... &#125; if ([model isKindOfClass:[NSArray class]]) &#123; // å¦‚æœèƒ½å¤Ÿç›´æ¥è½¬æ¢ JSON å¯¹è±¡ï¼Œåˆ™ç›´æ¥è¿”å› // å¦åˆ™éå†ï¼ŒæŒ‰éœ€è¦é€’å½’è§£æ ... &#125; // å¯¹ NSURL, NSAttributedString, NSDate, NSData åšç›¸åº”å¤„ç† if ([model isKindOfClass:[NSURL class]]) return ((NSURL *)model).absoluteString; if ([model isKindOfClass:[NSAttributedString class]]) return ((NSAttributedString *)model).string; if ([model isKindOfClass:[NSDate class]]) return [YYISODateFormatter() stringFromDate:(id)model]; if ([model isKindOfClass:[NSData class]]) return nil; // ç”¨ [model class] åˆå§‹åŒ–ä¸€ä¸ªæ¨¡å‹å…ƒ _YYModelMeta *modelMeta = [_YYModelMeta metaWithClass:[model class]]; // å¦‚æœæ˜ å°„è¡¨ä¸ºç©ºï¼Œåˆ™ä¸åšè§£æç›´æ¥è¿”å› nil if (!modelMeta || modelMeta-&gt;_keyMappedCount == 0) return nil; // æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚ï¼Œä½¿ç”¨ __unsafe_unretained æ¥é¿å…åœ¨ä¸‹é¢éå† block ä¸­ç›´æ¥ä½¿ç”¨ result æŒ‡é’ˆé€ æˆçš„ä¸å¿…è¦ retain ä¸ release å¼€é”€ NSMutableDictionary *result = [[NSMutableDictionary alloc] initWithCapacity:64]; __unsafe_unretained NSMutableDictionary *dic = result; // éå†æ¨¡å‹å…ƒå±æ€§æ˜ å°„å­—å…¸ [modelMeta-&gt;_mapper enumerateKeysAndObjectsUsingBlock:^(NSString *propertyMappedKey, _YYModelPropertyMeta *propertyMeta, BOOL *stop) &#123; // å¦‚æœéå†å½“å‰å±æ€§å…ƒæ²¡æœ‰ getter æ–¹æ³•ï¼Œè·³è¿‡ if (!propertyMeta-&gt;_getter) return; id value = nil; // å¦‚æœå±æ€§å…ƒå±äº CNumberï¼Œå³å…¶ type æ˜¯ intã€floatã€double ä¹‹ç±»çš„ if (propertyMeta-&gt;_isCNumber) &#123; // ä»å±æ€§ä¸­åˆ©ç”¨ getter æ–¹æ³•å¾—åˆ°å¯¹åº”çš„å€¼ value = ModelCreateNumberFromProperty(model, propertyMeta); &#125; else if (propertyMeta-&gt;_nsType) &#123; // å±æ€§å…ƒå±äº nsTypeï¼Œå³ NSString ä¹‹ç±» // åˆ©ç”¨ getter æ–¹æ³•æ‹¿åˆ° value id v = ((id (*)(id, SEL))(void *) objc_msgSend)((id)model, propertyMeta-&gt;_getter); // å¯¹æ‹¿åˆ°çš„ value é€’å½’è§£æ value = ModelToJSONObjectRecursive(v); &#125; else &#123; // æ ¹æ®å±æ€§å…ƒçš„ type åšç›¸åº”å¤„ç† switch (propertyMeta-&gt;_type &amp; YYEncodingTypeMask) &#123; // idï¼Œéœ€è¦é€’å½’è§£æï¼Œå¦‚æœè§£æå¤±è´¥åˆ™è¿”å› nil case YYEncodingTypeObject: &#123; id v = ((id (*)(id, SEL))(void *) objc_msgSend)((id)model, propertyMeta-&gt;_getter); value = ModelToJSONObjectRecursive(v); if (value == (id)kCFNull) value = nil; &#125; break; // Classï¼Œè½¬ NSStringï¼Œè¿”å› Class åç§° case YYEncodingTypeClass: &#123; Class v = ((Class (*)(id, SEL))(void *) objc_msgSend)((id)model, propertyMeta-&gt;_getter); value = v ? NSStringFromClass(v) : nil; &#125; break; // SELï¼Œè½¬ NSStringï¼Œè¿”å›ç»™å®š SEL çš„å­—ç¬¦ä¸²è¡¨ç°å½¢å¼ case YYEncodingTypeSEL: &#123; SEL v = ((SEL (*)(id, SEL))(void *) objc_msgSend)((id)model, propertyMeta-&gt;_getter); value = v ? NSStringFromSelector(v) : nil; &#125; break; default: break; &#125; &#125; // å¦‚æœ value è¿˜æ˜¯æ²¡èƒ½è§£æï¼Œåˆ™è·³è¿‡ if (!value) return; // å½“å‰å±æ€§å…ƒæ˜¯ KeyPath æ˜ å°„ï¼Œå³ a.b.c ä¹‹ç±» if (propertyMeta-&gt;_mappedToKeyPath) &#123; NSMutableDictionary *superDic = dic; NSMutableDictionary *subDic = nil; // _mappedToKeyPath æ˜¯ a.b.c æ ¹æ® &#x27;.&#x27; æ‹†åˆ†æˆçš„å­—ç¬¦ä¸²æ•°ç»„ï¼Œéå† _mappedToKeyPath for (NSUInteger i = 0, max = propertyMeta-&gt;_mappedToKeyPath.count; i &lt; max; i++) &#123; NSString *key = propertyMeta-&gt;_mappedToKeyPath[i]; // éå†åˆ°ç»“å°¾ if (i + 1 == max) &#123; // å¦‚æœç»“å°¾çš„ key ä¸º nilï¼Œåˆ™ä½¿ç”¨ value èµ‹å€¼ if (!superDic[key]) superDic[key] = value; break; &#125; // ç”¨ subDic æ‹¿åˆ°å½“å‰ key å¯¹åº”çš„å€¼ subDic = superDic[key]; // å¦‚æœ subDic å­˜åœ¨ if (subDic) &#123; // å¦‚æœ subDic ä»å±äº NSDictionary if ([subDic isKindOfClass:[NSDictionary class]]) &#123; // å°† subDic çš„ mutable ç‰ˆæœ¬èµ‹å€¼ç»™ superDic[key] subDic = subDic.mutableCopy; superDic[key] = subDic; &#125; else &#123; break; &#125; &#125; else &#123; // å°† NSMutableDictionary èµ‹å€¼ç»™ superDic[key] // æ³¨æ„è¿™é‡Œä½¿ç”¨ subDic é—´æ¥èµ‹å€¼æ˜¯æœ‰åŸå› çš„ï¼ŒåŸå› å°±åœ¨ä¸‹é¢ subDic = [NSMutableDictionary new]; superDic[key] = subDic; &#125; // superDic æŒ‡å‘ subDicï¼Œè¿™æ ·åœ¨éå† _mappedToKeyPath æ—¶å³å¯é€å±‚è§£æ // è¿™å°±æ˜¯ä¸Šé¢å…ˆæŠŠ subDic è½¬ä¸º NSMutableDictionary çš„åŸå›  superDic = subDic; subDic = nil; &#125; &#125; else &#123; // å¦‚æœä¸æ˜¯ KeyPath åˆ™æ£€æµ‹ dic[propertyMeta-&gt;_mappedToKey]ï¼Œå¦‚æœä¸º nil åˆ™èµ‹å€¼ value if (!dic[propertyMeta-&gt;_mappedToKey]) &#123; dic[propertyMeta-&gt;_mappedToKey] = value; &#125; &#125; &#125;]; // å¿½ç•¥ï¼Œå¯¹åº” modelCustomTransformToDictionary æ¥å£ if (modelMeta-&gt;_hasCustomTransformToDictionary) &#123; // ç”¨äºåœ¨é»˜è®¤çš„ Model è½¬ JSON è¿‡ç¨‹ä¸é€‚åˆå½“å‰ Model ç±»å‹æ—¶æä¾›è‡ªå®šä¹‰é¢å¤–è¿‡ç¨‹ // ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•æ¥éªŒè¯è½¬æ¢ç»“æœ BOOL suc = [((id&lt;YYModel&gt;)model) modelCustomTransformToDictionary:dic]; if (!suc) return nil; &#125; return result;&#125; é¢â€¦ä»£ç è¿˜æ˜¯æœ‰äº›é•¿ï¼Œä¸è¿‡ç›¸æ¯”äºä¹‹å‰ JSON to Model æ–¹å‘ä¸Šç”± yy_modelSetWithDictionaryï¼ŒModelSetWithDictionaryFunction å’Œ ModelSetValueForProperty ä¸‰ä¸ªæ–¹æ³•æ„æˆçš„é—´æ¥é€’å½’æ¥è¯´ç®—æ˜¯éå¸¸ç®€å•äº†ï¼Œé‚£ä¹ˆæ€»ç»“ä¸€ä¸‹ä¸Šé¢çš„ä»£ç é€»è¾‘ã€‚ åˆ¤æ–­å…¥å‚ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶å¯ä»¥ç›´æ¥è¿”å› å¦‚æœ Model ä»å±äº NSTypeï¼Œåˆ™æ ¹æ®ä¸åŒçš„ç±»å‹åšé€»è¾‘å¤„ç† å¦‚æœä¸Šé¢æ¡ä»¶ä¸è¢«æ»¡è¶³ï¼Œåˆ™ç”¨ Model çš„ Class åˆå§‹åŒ–ä¸€ä¸ªæ¨¡å‹å…ƒ _YYModelMeta åˆ¤æ–­æ¨¡å‹å…ƒçš„æ˜ å°„å…³ç³»ï¼Œéå†æ˜ å°„è¡¨æ‹¿åˆ°å¯¹åº”é”®å€¼å¯¹å¹¶å­˜å…¥å­—å…¸ä¸­å¹¶è¿”å› Note: è¿™é‡Œæœ‰ä¸€ä¸ªæ€§èƒ½ä¼˜åŒ–çš„ç»†èŠ‚ï¼Œç”¨ __unsafe_unretained ä¿®é¥°çš„ dic æŒ‡å‘æˆ‘ä»¬æœ€åè¦ return çš„ NSMutableDictionary *resultï¼Œçœ‹ä½œè€…çš„æ³¨é‡Šï¼š// avoid retain and release in block æ˜¯ä¸ºäº†é¿å…ç›´æ¥ä½¿ç”¨ result åœ¨åé¢éå†æ˜ å°„è¡¨çš„ä»£ç å—ä¸­ä¸å¿…è¦çš„ retain å’Œ release æ“ä½œä»¥èŠ‚çœå¼€é”€ã€‚ æ€»ç»“ æ–‡ç« ç´§æ¥ä¸Šæ–‡ã€Šæ­ç§˜ YYModel çš„é­”æ³•ï¼ˆä¸Šï¼‰ã€‹ä¸­å¯¹ YYModel ä»£ç ç»“æ„çš„è®²è§£åå°†é‡ç‚¹æ”¾åˆ°äº†å¯¹ JSON æ¨¡å‹ç›¸äº’è½¬æ¢çš„å®ç°é€»è¾‘ä¸Šã€‚ ä» JSON æ¨¡å‹çš„è½¬æ¢æ–¹å‘ä¸Šåˆ’åˆ†ï¼Œå°† YYModel çš„ JSON æ¨¡å‹è½¬æ¢è¿‡ç¨‹æ­£åæ–¹å‘å‰–ææ­ç§˜ï¼Œå¸Œæœ›å¯ä»¥è§£å¼€å¤§å®¶å¯¹ JSON æ¨¡å‹è‡ªåŠ¨è½¬æ¢çš„ç–‘æƒ‘ã€‚ æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜ https://lision.me/ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ ä¸ªäººåšå®¢ ä¸­æ›´æ–°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš @Lision è”ç³»æˆ‘~ å¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~"},{"title":"æ­ç§˜ YYModel çš„é­”æ³• 0x01","comments":true,"permalink":"https://lision.me/yymodel0x01/","text":"å‰è¨€iOS å¼€å‘ä¸­å°‘ä¸äº†å„ç§å„æ ·çš„æ¨¡å‹ï¼Œä¸è®ºæ˜¯é‡‡ç”¨ MVCã€MVP è¿˜æ˜¯ MVVM è®¾è®¡æ¨¡å¼éƒ½é€ƒä¸è¿‡ Modelã€‚ é‚£ä¹ˆå¤§å®¶åœ¨ä½¿ç”¨ Model çš„æ—¶å€™è‚¯å®šé‡åˆ°è¿‡ä¸€ä¸ªé—®é¢˜ï¼Œå³æ¥å£ä¼ é€’è¿‡æ¥çš„æ•°æ®ï¼ˆä¸€èˆ¬æ˜¯ JSON æ ¼å¼ï¼‰éœ€è¦è½¬æ¢ä¸º iOS å†…æˆ‘ä»¬èƒ½ç›´æ¥ä½¿ç”¨çš„æ¨¡å‹ï¼ˆç±»ï¼‰ã€‚iOS å¼€å‘æ—©æœŸç¬¬ä¸‰æ–¹æ¡†æ¶æ²¡æœ‰é‚£ä¹ˆå¤šï¼Œå¤§å®¶å¯èƒ½ä¼šæ‰‹å†™ç›¸å…³ä»£ç ï¼Œä½†æ˜¯éšç€ä¸šåŠ¡çš„æ‰©å±•ï¼Œæ¨¡å‹çš„å¢å¤šï¼Œè¿™äº›æ²¡ä»€ä¹ˆæŠ€æœ¯å«é‡çš„ä»£ç åªæ˜¯åœ¨é‡å¤çš„æµªè´¹æˆ‘ä»¬çš„åŠ³åŠ¨åŠ›è€Œå·²ã€‚ è¿™æ—¶å€™å°±éœ€è¦ä¸€ç§å·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬æŠŠåŠ³åŠ¨åŠ›ä»è¿™äº›æ— æ„ä¹‰çš„ç¹çä»£ç ä¸­è§£æ”¾å‡ºæ¥ï¼Œäºæ˜¯ GitHub ä¸Šå‡ºç°äº†å¾ˆå¤šè§£å†³æ­¤ç±»é—®é¢˜çš„ç¬¬ä¸‰æ–¹åº“ï¼Œè¯¸å¦‚ Mantleã€JSONModelã€MJExtension ä»¥åŠ YYModel ç­‰ç­‰ã€‚ è¿™äº›åº“çš„ç¥å¥‡ä¹‹å¤„åœ¨äºå®ƒä»¬æä¾›äº†æ¨¡å‹ä¸ JSON æ•°æ®çš„è‡ªåŠ¨è½¬æ¢åŠŸèƒ½ï¼Œä»¿ä½›å…·æœ‰é­”æ³•ä¸€èˆ¬ï¼æœ¬æ–‡å°†é€šè¿‡å‰–æ YYModel æºç ä¸€æ­¥ä¸€æ­¥ç ´è§£è¿™â€œç¥å¥‡â€çš„é­”æ³•ã€‚ YYModel æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ iOS/OSX æ¨¡å‹è½¬æ¢æ¡†æ¶ï¼ˆè¯¥é¡¹ç›®æ˜¯ YYKit ç»„ä»¶ä¹‹ä¸€ï¼‰ã€‚YYKit åœ¨æˆ‘ä¹‹å‰çš„æ–‡ç« ã€ä» YYCache æºç  Get åˆ°å¦‚ä½•è®¾è®¡ä¸€ä¸ªä¼˜ç§€çš„ç¼“å­˜ã€‘ä¸­å·²ç»å¾ˆè¯¦ç»†çš„ä»‹ç»è¿‡äº†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç‚¹è¿›å»äº†è§£ä¸€ä¸‹ã€‚ YYModel æ˜¯ä¸€ä¸ªéå¸¸è½»é‡çº§çš„ JSON æ¨¡å‹è‡ªåŠ¨è½¬æ¢åº“ï¼Œä»£ç é£æ ¼è‰¯å¥½ä¸”æ€è·¯æ¸…æ™°ï¼Œå¯ä»¥ä»æºç ä¸­çœ‹åˆ°ä½œè€…å¯¹ Runtime æ·±åšçš„ç†è§£ã€‚éš¾èƒ½å¯è´µçš„æ˜¯ YYModel åœ¨å…¶è½»é‡çº§çš„ä»£ç ä¸‹è¿˜ä¿ç•™ç€è‡ªåŠ¨ç±»å‹è½¬æ¢ï¼Œç±»å‹å®‰å…¨ï¼Œæ— ä¾µå…¥ç­‰ç‰¹æ€§ï¼Œå¹¶ä¸”å…·æœ‰æ¥è¿‘æ‰‹å†™è§£æä»£ç çš„è¶…é«˜æ€§èƒ½ã€‚ å¤„ç† GithubUser æ•°æ® 10000 æ¬¡è€—æ—¶ç»Ÿè®¡ (iPhone 6): ç´¢å¼• YYModel ç®€ä»‹ YYClassInfo å‰–æ NSObject+YYModel æ¢ç©¶ JSON ä¸ Model ç›¸äº’è½¬æ¢ æ€»ç»“ YYModel ç®€ä»‹ æ’¸äº†ä¸€é YYModel çš„æºç ï¼Œæœç„¶æ˜¯éå¸¸è½»é‡çº§çš„ JSON æ¨¡å‹è‡ªåŠ¨è½¬æ¢åº“ï¼ŒåŠ ä¸Š YYModel.h ä¸€å…±ä¹Ÿåªæœ‰ 5 ä¸ªæ–‡ä»¶ã€‚ æŠ›å¼€ YYModel.h æ¥çœ‹ï¼Œå…¶å®åªæœ‰ YYClassInfo å’Œ NSObject+YYModel ä¸¤ä¸ªæ¨¡å—ã€‚ YYClassInfo ä¸»è¦å°† Runtime å±‚çº§çš„ä¸€äº›ç»“æ„ä½“å°è£…åˆ° NSObject å±‚çº§ä»¥ä¾¿è°ƒç”¨ã€‚ NSObject+YYModel è´Ÿè´£æä¾›æ–¹ä¾¿è°ƒç”¨çš„æ¥å£ä»¥åŠå®ç°å…·ä½“çš„æ¨¡å‹è½¬æ¢é€»è¾‘ï¼ˆå€ŸåŠ© YYClassInfo ä¸­çš„å°è£…ï¼‰ã€‚ YYClassInfo å‰–æ å‰é¢è¯´åˆ° YYClassInfo ä¸»è¦å°† Runtime å±‚çº§çš„ä¸€äº›ç»“æ„ä½“å°è£…åˆ° NSObject å±‚çº§ä»¥ä¾¿è°ƒç”¨ï¼Œæˆ‘è§‰å¾—å¦‚æœéœ€è¦ä¸ Runtime å±‚çº§çš„ç»“æ„ä½“åšå¯¹æ¯”çš„è¯ï¼Œæ²¡ä»€ä¹ˆæ¯”è¡¨æ ¼æ¥çš„æ›´ç®€å•ç›´è§‚äº†ï¼š YYClassInfo Runtime YYClassIvarInfo objc_ivar YYClassMethodInfo objc_method YYClassPropertyInfo property_t YYClassInfo objc_class Note: æœ¬æ¬¡æ¯”è¾ƒåŸºäº Runtime æºç  723 ç‰ˆæœ¬ã€‚ å®‰~ æ—¢ç„¶æ˜¯å‰–æè‚¯å®šä¸ä¼šåˆ—ä¸ªè¡¨æ ¼è¿™æ ·å­å“ˆã€‚ YYClassIvarInfo &amp;&amp; objc_ivaræˆ‘æŠŠ YYClassIvarInfo çœ‹åšæ˜¯ä½œè€…å¯¹ Runtime å±‚ objc_ivar ç»“æ„ä½“çš„å°è£…ï¼Œobjc_ivar æ˜¯ Runtime ä¸­è¡¨ç¤ºå˜é‡çš„ç»“æ„ä½“ã€‚ YYClassIvarInfo 123456789@interface YYClassIvarInfo : NSObject@property (nonatomic, assign, readonly) Ivar ivar; ///&lt; å˜é‡ï¼Œå¯¹åº” objc_ivar@property (nonatomic, strong, readonly) NSString *name; ///&lt; å˜é‡åç§°ï¼Œå¯¹åº” ivar_name@property (nonatomic, assign, readonly) ptrdiff_t offset; ///&lt; å˜é‡åç§»é‡ï¼Œå¯¹åº” ivar_offset@property (nonatomic, strong, readonly) NSString *typeEncoding; ///&lt; å˜é‡ç±»å‹ç¼–ç ï¼Œé€šè¿‡ ivar_getTypeEncoding å‡½æ•°å¾—åˆ°@property (nonatomic, assign, readonly) YYEncodingType type; ///&lt; å˜é‡ç±»å‹ï¼Œé€šè¿‡ YYEncodingGetType æ–¹æ³•ä»ç±»å‹ç¼–ç ä¸­å¾—åˆ°- (instancetype)initWithIvar:(Ivar)ivar;@end objc_ivar 12345678struct objc_ivar &#123; char * _Nullable ivar_name OBJC2_UNAVAILABLE; // å˜é‡åç§° char * _Nullable ivar_type OBJC2_UNAVAILABLE; // å˜é‡ç±»å‹ int ivar_offset OBJC2_UNAVAILABLE; // å˜é‡åç§»é‡#ifdef __LP64__ // å¦‚æœå·²å®šä¹‰ __LP64__ åˆ™è¡¨ç¤ºæ­£åœ¨æ„å»º 64 ä½ç›®æ ‡ int space OBJC2_UNAVAILABLE; // å˜é‡ç©ºé—´#endif&#125; Note: æ—¥å¸¸å¼€å‘ä¸­ NSString ç±»å‹çš„å±æ€§æˆ‘ä»¬éƒ½ä¼šç”¨ copy æ¥ä¿®é¥°ï¼Œè€Œ YYClassIvarInfo ä¸­çš„ name å’Œ typeEncoding å±æ€§éƒ½ç”¨ strong ä¿®é¥°ã€‚å› ä¸ºå…¶å†…éƒ¨æ˜¯å…ˆé€šè¿‡ Runtime æ–¹æ³•æ‹¿åˆ° const char * ä¹‹åé€šè¿‡ stringWithUTF8String æ–¹æ³•è½¬ä¸º NSString çš„ã€‚æ‰€ä»¥å³ä¾¿æ˜¯ NSString è¿™ç±»å±æ€§åœ¨ç¡®å®šå…¶ä¸ä¼šåœ¨åˆå§‹åŒ–ä¹‹åè¢«ä¿®æ”¹çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ strong åšä¸€æ¬¡å•çº¯çš„å¼ºå¼•ç”¨åœ¨æ€§èƒ½ä¸Šè®²æ¯” copy è¦é«˜ä¸€äº›ã€‚ å›§~ ä¸çŸ¥é“è®²çš„è¿™ä¹ˆç»†ä¼šä¸ä¼šåè€Œå¼•èµ·åæ„Ÿï¼Œå¦‚æœå¯¹æ–‡ç« æœ‰ä»€ä¹ˆå»ºè®®å¯ä»¥è”ç³»æˆ‘ @è–›å®šè°”çš„çŒ¹ ã€‚ Note: ç±»å‹ç¼–ç ï¼Œå…³äº YYClassIvarInfo ä¸­çš„ YYEncodingType ç±»å‹å±æ€§ type çš„è§£æä»£ç ç¯‡å¹…å¾ˆé•¿ï¼Œè€Œä¸”æ²¡æœ‰æ¬å‡ºæ¥çš„å¿…è¦ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ Type Encodings å’Œ Declared Properties é˜…è¯»è¿™éƒ¨åˆ†æºç ã€‚ YYClassMethodInfo &amp;&amp; objc_methodç›¸åº”çš„ï¼ŒYYClassMethodInfo åˆ™æ˜¯ä½œè€…å¯¹ Runtime ä¸­ objc_method çš„å°è£…ï¼Œobjc_method åœ¨ Runtime æ˜¯ç”¨æ¥å®šä¹‰æ–¹æ³•çš„ç»“æ„ä½“ã€‚ YYClassMethodInfo 1234567891011@interface YYClassMethodInfo : NSObject@property (nonatomic, assign, readonly) Method method; ///&lt; æ–¹æ³•@property (nonatomic, strong, readonly) NSString *name; ///&lt; æ–¹æ³•åç§°@property (nonatomic, assign, readonly) SEL sel; ///&lt; æ–¹æ³•é€‰æ‹©å™¨@property (nonatomic, assign, readonly) IMP imp; ///&lt; æ–¹æ³•å®ç°ï¼ŒæŒ‡å‘å®ç°æ–¹æ³•å‡½æ•°çš„å‡½æ•°æŒ‡é’ˆ@property (nonatomic, strong, readonly) NSString *typeEncoding; ///&lt; æ–¹æ³•å‚æ•°å’Œè¿”å›ç±»å‹ç¼–ç @property (nonatomic, strong, readonly) NSString *returnTypeEncoding; ///&lt; è¿”å›å€¼ç±»å‹ç¼–ç @property (nullable, nonatomic, strong, readonly) NSArray&lt;NSString *&gt; *argumentTypeEncodings; ///&lt; å‚æ•°ç±»å‹ç¼–ç æ•°ç»„- (instancetype)initWithMethod:(Method)method;@end objc_method 12345struct objc_method &#123; SEL _Nonnull method_name OBJC2_UNAVAILABLE; // æ–¹æ³•åç§° char * _Nullable method_types OBJC2_UNAVAILABLE; // æ–¹æ³•ç±»å‹ IMP _Nonnull method_imp OBJC2_UNAVAILABLE; // æ–¹æ³•å®ç°ï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰&#125; å¯ä»¥çœ‹åˆ°åŸºæœ¬ä¹Ÿæ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œé™¤äº†ç±»å‹ç¼–ç çš„é—®é¢˜ä½œè€…ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨åœ¨å°è£…æ—¶è¿›è¡Œäº†æ‰©å±•ã€‚ ä¸ºäº†ç…§é¡¾å¯¹ Runtime è¿˜æ²¡æœ‰ä¸€å®šäº†è§£çš„è¯»è€…ï¼Œæˆ‘è¿™é‡Œç®€å•çš„è§£é‡Šä¸€ä¸‹ objc_method ç»“æ„ä½“ï¼ˆéƒ½æ˜¯æˆ‘è‡ªå·±çš„è®¤çŸ¥ï¼Œæ¬¢è¿è®¨è®ºï¼‰ï¼š SELï¼Œselector åœ¨ Runtime ä¸­çš„è¡¨ç°å½¢å¼ï¼Œå¯ä»¥ç†è§£ä¸ºæ–¹æ³•é€‰æ‹©å™¨ 1typedef struct objc_selector *SEL; IMPï¼Œå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘å…·ä½“å®ç°é€»è¾‘çš„å‡½æ•° 12345#if !OBJC_OLD_DISPATCH_PROTOTYPEStypedef void (*IMP)(void /* id, SEL, ... */ ); #elsetypedef id _Nullable (*IMP)(id _Nonnull, SEL _Nonnull, ...); #endif å…³äºæ›´å¤š Runtime ç›¸å…³çš„çŸ¥è¯†ç”±äºç¯‡å¹…åŸå› ï¼ˆçœŸçš„å†™ä¸å®Œï¼‰å°±ä¸åœ¨è¿™ç¯‡æ–‡ç« ä»‹ç»äº†ï¼Œæˆ‘æ¨èå¤§å®¶å»é±¼ç¥çš„æ–‡ç«  Objective-C Runtime å­¦ä¹ ï¼ˆå› ä¸ºæˆ‘æœ€æ—©æ¥è§¦ Runtime å°±æ˜¯é€šè¿‡è¿™ç¯‡æ–‡ç« ï¼Œç¬‘~ï¼‰ã€‚ æœ‰è¶£çš„æ˜¯ï¼Œé±¼ç¥çš„æ–‡ç« ä¸­å¯¹ SEL çš„æè¿°æœ‰ä¸€å¥â€œå…¶å®å®ƒå°±æ˜¯ä¸ªæ˜ å°„åˆ°æ–¹æ³•çš„ C å­—ç¬¦ä¸²â€ï¼Œä½†æ˜¯ä»–åœ¨æ–‡ç« ä¸­æ²¡æœ‰ä»‹ç»å‡ºå¤„ã€‚æœ¬ç€å¯¹è‡ªå·±æ–‡ç« è´¨é‡è´Ÿè´£çš„åŸåˆ™ï¼Œå¯¹äºä¸€åˆ‡æ²¡æœ‰å‡ºå¤„çš„è¡¨è¿°éƒ½åº”è¯¥æŒæœ‰æ€€ç–‘çš„æ€åº¦ï¼Œæ‰€ä»¥æˆ‘ä¸‹é¢è®²ä¸€ä¸‹è‡ªå·±çš„å¯¹äº SEL çš„ç†è§£ã€‚ æ’¸äº†å‡ é Runtime æºç ï¼Œå‘ç°ä¸è®ºæ˜¯ objc-runtime-new è¿˜æ˜¯ objc-runtime-old ä¸­éƒ½ç”¨ SEL ç±»å‹ä½œä¸ºæ–¹æ³•ç»“æ„ä½“çš„ name å±æ€§ç±»å‹ï¼Œè€Œä¸”é€šè¿‡ä»¥ä¸‹æºç ï¼š 12345OBJC_EXPORT SEL _Nonnull sel_registerName(const char * _Nonnull str) OBJC_AVAILABLE(10.0, 2.0, 9.0, 1.0, 2.0);OBJC_EXPORT const char * _Nonnull sel_getName(SEL _Nonnull sel) OBJC_AVAILABLE(10.0, 2.0, 9.0, 1.0, 2.0); å¯ä»¥çœ‹åˆ°é€šè¿‡ä¸€ä¸ª const char * ç±»å‹çš„å­—ç¬¦ä¸²å³å¯åœ¨ Runtime ç³»ç»Ÿä¸­æ³¨å†Œå¹¶è¿”å›ä¸€ä¸ª SELï¼Œæ–¹æ³•çš„åç§°åˆ™ä¼šæ˜ å°„åˆ°è¿™ä¸ª SELã€‚ å®˜æ–¹æ³¨é‡Šï¼šRegisters a method with the Objective-C runtime system, maps the method name to a selector, and returns the selector value. æ‰€ä»¥æˆ‘è§‰å¾— SEL å’Œ char * çš„çš„ç¡®ç¡®æ˜¯æœ‰æŸç§ä¸€ä¸€å¯¹åº”çš„æ˜ å°„å…³ç³»ï¼Œä¸è¿‡ SEL çš„æœ¬è´¨æ˜¯å¦æ˜¯ char * å°±è¦æ‰“ä¸€ä¸ªé—®å·äº†ã€‚å› ä¸ºæˆ‘åœ¨è°ƒè¯• SEL é˜¶æ®µå‘ç° SEL å†…è¿˜æœ‰ä¸€ä¸ªå½“å‰ SEL çš„æŒ‡é’ˆï¼Œä¸ char * ä¸åŒçš„æ˜¯å½“ char * èµ‹å€¼ä¹‹åå½“å‰ char * å˜é‡æŒ‡é’ˆæŒ‡å‘å­—ç¬¦ä¸²é¦–å­—ç¬¦ï¼Œè€Œ SEL åˆ™æ˜¯ ï¼Œå³æˆ‘ä»¬æ— æ³•ç›´æ¥çœ‹åˆ°å®ƒã€‚ æ‰€ä»¥æˆ‘åšäº†ä¸€ä¸ªæ— èŠçš„æµ‹è¯•ï¼Œç”¨ç›¸åŒçš„å­—ç¬¦ä¸²åˆå§‹åŒ–ä¸€ä¸ª char * å®ä¾‹ä¸ä¸€ä¸ª SEL å®ä¾‹ï¼Œä¹‹åå°è¯•æ‰“å°å®ƒä»¬ï¼Œæœ‰è¶£çš„æ˜¯ä¸è®ºæˆ‘ä½¿ç”¨ %s è¿˜æ˜¯ %c éƒ½å¯ä»¥ä»ä¸¤ä¸ªå®ä¾‹ä¸­å¾—åˆ°ç›¸åŒçš„æ‰“å°è¾“å‡ºï¼Œä¸çŸ¥é“é±¼ç¥æ˜¯å¦åšè¿‡ç›¸åŒçš„æµ‹è¯•ï¼ˆç¬‘~ï¼‰ å˜›~ ç»è¿‡éªŒè¯æˆ‘ä»¬å¯ä»¥è‚¯å®š SEL å’Œ char * å­˜åœ¨æŸç§æ˜ å°„å…³ç³»ï¼Œå¯ä»¥ç›¸äº’è½¬æ¢ã€‚åŒæ—¶çŒœæµ‹ SEL æœ¬è´¨ä¸Šå°±æ˜¯ char *ï¼Œå¦‚æœæœ‰å“ªä½çŸ¥é“ SEL ä¸ char * ç¡®åˆ‡å…³ç³»çš„å¯ä»¥ç•™è¨€è®¨è®ºå“Ÿã€‚ YYClassPropertyInfo &amp;&amp; property_tYYClassPropertyInfo æ˜¯ä½œè€…å¯¹ property_t çš„å°è£…ï¼Œproperty_t åœ¨ Runtime ä¸­æ˜¯ç”¨æ¥è¡¨ç¤ºå±æ€§çš„ç»“æ„ä½“ã€‚ YYClassPropertyInfo 12345678910111213@interface YYClassPropertyInfo : NSObject@property (nonatomic, assign, readonly) objc_property_t property; ///&lt; å±æ€§@property (nonatomic, strong, readonly) NSString *name; ///&lt; å±æ€§åç§°@property (nonatomic, assign, readonly) YYEncodingType type; ///&lt; å±æ€§ç±»å‹@property (nonatomic, strong, readonly) NSString *typeEncoding; ///&lt; å±æ€§ç±»å‹ç¼–ç @property (nonatomic, strong, readonly) NSString *ivarName; ///&lt; å˜é‡åç§°@property (nullable, nonatomic, assign, readonly) Class cls; ///&lt; ç±»å‹@property (nullable, nonatomic, strong, readonly) NSArray&lt;NSString *&gt; *protocols; ///&lt; å±æ€§ç›¸å…³åè®®@property (nonatomic, assign, readonly) SEL getter; ///&lt; getter æ–¹æ³•é€‰æ‹©å™¨@property (nonatomic, assign, readonly) SEL setter; ///&lt; setter æ–¹æ³•é€‰æ‹©å™¨- (instancetype)initWithProperty:(objc_property_t)property;@end property_t 1234struct property_t &#123; const char *name; // åç§° const char *attributes; // ä¿®é¥°&#125;; ä¸ºä»€ä¹ˆè¯´ YYClassPropertyInfo æ˜¯ä½œè€…å¯¹ property_t çš„å°è£…å‘¢ï¼Ÿ 123456789101112131415// runtime.htypedef struct objc_property *objc_property_t;// objc-private.h#if __OBJC2__typedef struct property_t *objc_property_t;#elsetypedef struct old_property *objc_property_t;#endif// objc-runtime-new.hstruct property_t &#123; const char *name; const char *attributes;&#125;; è¿™é‡Œå”¯ä¸€å€¼å¾—æ³¨æ„çš„å°±æ˜¯ getter ä¸ setter æ–¹æ³•äº†ã€‚ 123456789101112131415161718192021// å…ˆå°è¯•è·å–å±æ€§çš„ getter ä¸ setter case &#x27;G&#x27;: &#123; type |= YYEncodingTypePropertyCustomGetter; if (attrs[i].value) &#123; _getter = NSSelectorFromString([NSString stringWithUTF8String:attrs[i].value]); &#125; &#125; break; case &#x27;S&#x27;: &#123; type |= YYEncodingTypePropertyCustomSetter; if (attrs[i].value) &#123; _setter = NSSelectorFromString([NSString stringWithUTF8String:attrs[i].value]); &#125; &#125; break; // å¦‚æœæ²¡æœ‰åˆ™æŒ‰ç…§æ ‡å‡†è§„åˆ™è‡ªå·±é€ if (!_getter) &#123; _getter = NSSelectorFromString(_name);&#125;if (!_setter) &#123; _setter = NSSelectorFromString([NSString stringWithFormat:@&quot;set%@%@:&quot;, [_name substringToIndex:1].uppercaseString, [_name substringFromIndex:1]]);&#125; YYClassInfo &amp;&amp; objc_classæœ€åä½œè€…ç”¨ YYClassInfo å°è£…äº† objc_classï¼Œobjc_class åœ¨ Runtime ä¸­è¡¨ç¤ºä¸€ä¸ª Objective-C ç±»ã€‚ YYClassInfo 123456789101112131415161718@interface YYClassInfo : NSObject@property (nonatomic, assign, readonly) Class cls; ///&lt; ç±»@property (nullable, nonatomic, assign, readonly) Class superCls; ///&lt; è¶…ç±»@property (nullable, nonatomic, assign, readonly) Class metaCls; ///&lt; å…ƒç±»@property (nonatomic, readonly) BOOL isMeta; ///&lt; å…ƒç±»æ ‡è¯†ï¼Œè‡ªèº«æ˜¯å¦ä¸ºå…ƒç±»@property (nonatomic, strong, readonly) NSString *name; ///&lt; ç±»åç§°@property (nullable, nonatomic, strong, readonly) YYClassInfo *superClassInfo; ///&lt; çˆ¶ç±»ï¼ˆè¶…ç±»ï¼‰ä¿¡æ¯@property (nullable, nonatomic, strong, readonly) NSDictionary&lt;NSString *, YYClassIvarInfo *&gt; *ivarInfos; ///&lt; å˜é‡ä¿¡æ¯@property (nullable, nonatomic, strong, readonly) NSDictionary&lt;NSString *, YYClassMethodInfo *&gt; *methodInfos; ///&lt; æ–¹æ³•ä¿¡æ¯@property (nullable, nonatomic, strong, readonly) NSDictionary&lt;NSString *, YYClassPropertyInfo *&gt; *propertyInfos; ///&lt; å±æ€§ä¿¡æ¯- (void)setNeedUpdate;- (BOOL)needUpdate;+ (nullable instancetype)classInfoWithClass:(Class)cls;+ (nullable instancetype)classInfoWithClassName:(NSString *)className;@end objc_class 1234567891011121314151617181920// objc.htypedef struct objc_class *Class;// runtime.hstruct objc_class &#123; Class _Nonnull isa OBJC_ISA_AVAILABILITY; // isa æŒ‡é’ˆ#if !__OBJC2__ Class _Nullable super_class OBJC2_UNAVAILABLE; // çˆ¶ç±»ï¼ˆè¶…ç±»ï¼‰æŒ‡é’ˆ const char * _Nonnull name OBJC2_UNAVAILABLE; // ç±»å long version OBJC2_UNAVAILABLE; // ç‰ˆæœ¬ long info OBJC2_UNAVAILABLE; // ä¿¡æ¯ long instance_size OBJC2_UNAVAILABLE; // åˆå§‹å°ºå¯¸ struct objc_ivar_list * _Nullable ivars OBJC2_UNAVAILABLE; // å˜é‡åˆ—è¡¨ struct objc_method_list * _Nullable * _Nullable methodLists OBJC2_UNAVAILABLE; // æ–¹æ³•åˆ—è¡¨ struct objc_cache * _Nonnull cache OBJC2_UNAVAILABLE; // ç¼“å­˜ struct objc_protocol_list * _Nullable protocols OBJC2_UNAVAILABLE; // åè®®åˆ—è¡¨#endif&#125; OBJC2_UNAVAILABLE; é¢â€¦ çœ‹æ¥æƒ³å®Œå…¨é¿å¼€ Runtime çš„çŸ¥è¯†æ¥è®² YYModel æºç æ˜¯ä¸ç°å®çš„ã€‚è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹ Runtime ä¸­å…³äº Class çš„çŸ¥è¯†ä»¥ä¾¿é˜…è¯»ï¼Œå·²ç»ç†Ÿæ‚‰è¿™æ–¹é¢çŸ¥è¯†çš„åŒå­¦å°±å½“æ¸©ä¹ ä¸€ä¸‹å¥½äº†ã€‚ isa æŒ‡é’ˆï¼Œç”¨äºæ‰¾åˆ°æ‰€å±ç±»ï¼Œç±»å¯¹è±¡çš„ isa ä¸€èˆ¬æŒ‡å‘å¯¹åº”å…ƒç±»ã€‚ å…ƒç±»ï¼Œç”±äº objc_class ç»§æ‰¿äº objc_objectï¼Œå³ç±»æœ¬èº«åŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥ Runtime åº“è®¾è®¡å‡ºå…ƒç±»ç”¨ä»¥è¡¨è¿°ç±»å¯¹è±¡è‡ªèº«æ‰€å…·å¤‡çš„å…ƒæ•°æ®ã€‚ cacheï¼Œå®é™…ä¸Šå½“ä¸€ä¸ªå¯¹è±¡æ”¶åˆ°æ¶ˆæ¯æ—¶å¹¶ä¸ä¼šç›´æ¥åœ¨ isa æŒ‡å‘çš„ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­éå†æŸ¥æ‰¾èƒ½å¤Ÿå“åº”æ¶ˆæ¯çš„æ–¹æ³•ï¼Œå› ä¸ºè¿™æ ·æ•ˆç‡å¤ªä½äº†ã€‚ä¸ºäº†ä¼˜åŒ–æ–¹æ³•è°ƒç”¨çš„æ•ˆç‡ï¼ŒåŠ å…¥äº† cacheï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œä¼šå…ˆå» cache ä¸­æŸ¥æ‰¾ï¼Œæ‰¾ä¸åˆ°æ‰ä¼šå»åƒä¸Šå›¾æ‰€ç¤ºéå†æŸ¥æ‰¾ï¼Œç›¸ä¿¡è‹¹æœä¸ºäº†æå‡ç¼“å­˜å‘½ä¸­ç‡ï¼Œåº”è¯¥ä¹ŸèŠ±äº†ä¸€äº›å¿ƒæ€ï¼ˆç¬‘~ï¼‰ã€‚ versionï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªå­—æ®µæ¥æä¾›ç±»çš„ç‰ˆæœ¬ä¿¡æ¯ã€‚è¿™å¯¹äºå¯¹è±¡çš„åºåˆ—åŒ–éå¸¸æœ‰ç”¨ï¼Œå®ƒå¯æ˜¯è®©æˆ‘ä»¬è¯†åˆ«å‡ºä¸åŒç±»å®šä¹‰ç‰ˆæœ¬ä¸­å®ä¾‹å˜é‡å¸ƒå±€çš„æ”¹å˜ã€‚ å…³äº Version çš„å®˜æ–¹æè¿°ï¼šClasses derived from the Foundation framework NSObject class can set the class-definition version number using the setVersion: class method, which is implemented using the class_setVersion function. YYClassInfo çš„åˆå§‹åŒ–ç»†èŠ‚å…³äº YYClassInfo çš„åˆå§‹åŒ–ç»†èŠ‚æˆ‘è§‰å¾—è¿˜æ˜¯æœ‰å¿…è¦åˆ†äº«å‡ºæ¥çš„ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940+ (instancetype)classInfoWithClass:(Class)cls &#123; // åˆ¤ç©ºå…¥å‚ if (!cls) return nil; // å•ä¾‹ç¼“å­˜ classCache ä¸ metaCacheï¼Œå¯¹åº”ç¼“å­˜ç±»å’Œå…ƒç±» static CFMutableDictionaryRef classCache; static CFMutableDictionaryRef metaCache; static dispatch_once_t onceToken; static dispatch_semaphore_t lock; dispatch_once(&amp;onceToken, ^&#123; classCache = CFDictionaryCreateMutable(CFAllocatorGetDefault(), 0, &amp;kCFTypeDictionaryKeyCallBacks, &amp;kCFTypeDictionaryValueCallBacks); metaCache = CFDictionaryCreateMutable(CFAllocatorGetDefault(), 0, &amp;kCFTypeDictionaryKeyCallBacks, &amp;kCFTypeDictionaryValueCallBacks); // è¿™é‡ŒæŠŠ dispatch_semaphore å½“åšé”æ¥ä½¿ç”¨ï¼ˆå½“ä¿¡å·é‡åªæœ‰ 1 æ—¶ï¼‰ lock = dispatch_semaphore_create(1); &#125;); // åˆå§‹åŒ–ä¹‹å‰ï¼Œé¦–å…ˆä¼šæ ¹æ®å½“å‰ YYClassInfo æ˜¯å¦ä¸ºå…ƒç±»å»å¯¹åº”çš„å•ä¾‹ç¼“å­˜ä¸­æŸ¥æ‰¾ // è¿™é‡Œä½¿ç”¨äº†ä¸Šé¢çš„ dispatch_semaphore åŠ é”ï¼Œä¿è¯å•ä¾‹ç¼“å­˜çš„çº¿ç¨‹å®‰å…¨ dispatch_semaphore_wait(lock, DISPATCH_TIME_FOREVER); YYClassInfo *info = CFDictionaryGetValue(class_isMetaClass(cls) ? metaCache : classCache, (__bridge const void *)(cls)); // å¦‚æœæ‰¾åˆ°äº†ï¼Œä¸”æ‰¾åˆ°çš„ä¿¡æ¯éœ€è¦æ›´æ–°çš„è¯åˆ™æ‰§è¡Œæ›´æ–°æ“ä½œ if (info &amp;&amp; info-&gt;_needUpdate) &#123; [info _update]; &#125; dispatch_semaphore_signal(lock); // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œæ‰ä¼šå»è€å®åˆå§‹åŒ– if (!info) &#123; info = [[YYClassInfo alloc] initWithClass:cls]; if (info) &#123; // åˆå§‹åŒ–æˆåŠŸ // çº¿ç¨‹å®‰å…¨ dispatch_semaphore_wait(lock, DISPATCH_TIME_FOREVER); // æ ¹æ®åˆå§‹åŒ–ä¿¡æ¯é€‰æ‹©å‘å¯¹åº”çš„ç±»/å…ƒç±»ç¼“å­˜æ³¨å…¥ä¿¡æ¯ï¼Œkey = clsï¼Œvalue = info CFDictionarySetValue(info.isMeta ? metaCache : classCache, (__bridge const void *)(cls), (__bridge const void *)(info)); dispatch_semaphore_signal(lock); &#125; &#125; return info;&#125; æ€»ç»“ä¸€ä¸‹åˆå§‹åŒ–çš„ä¸»è¦æ­¥éª¤ï¼š åˆ›å»ºå•ä¾‹ç¼“å­˜ï¼Œç±»ç¼“å­˜å’Œå…ƒç±»ç¼“å­˜ ä½¿ç”¨ dispatch_semaphore ä½œä¸ºé”ä¿è¯ç¼“å­˜çº¿ç¨‹å®‰å…¨ åˆå§‹åŒ–å‰å…ˆå»ç¼“å­˜ä¸­æŸ¥æ‰¾æ˜¯å¦å·²ç»å‘ç¼“å­˜ä¸­æ³¨å†Œè¿‡å½“å‰è¦åˆå§‹åŒ–çš„ YYClassInfo å¦‚æœæŸ¥æ‰¾åˆ°ç¼“å­˜å¯¹è±¡ï¼Œåˆ™åˆ¤æ–­ç¼“å­˜å¯¹è±¡æ˜¯å¦éœ€è¦æ›´æ–°å¹¶æ‰§è¡Œç›¸å…³æ“ä½œ å¦‚æœç¼“å­˜ä¸­æœªæ‰¾åˆ°ç¼“å­˜å¯¹è±¡åˆ™åˆå§‹åŒ– åˆå§‹åŒ–æˆåŠŸåå‘ç¼“å­˜ä¸­æ³¨å†Œè¯¥ YYClassInfo å®ä¾‹ å…¶ä¸­ï¼Œä½¿ç”¨ç¼“å­˜å¯ä»¥æœ‰æ•ˆå‡å°‘æˆ‘ä»¬åœ¨ JSON æ¨¡å‹è½¬æ¢æ—¶åå¤åˆå§‹åŒ– YYClassInfo å¸¦æ¥çš„å¼€é”€ï¼Œè€Œ dispatch_semaphore åœ¨ä¿¡å·é‡ä¸º 1 æ—¶æ˜¯å¯ä»¥å½“åšé”æ¥ä½¿ç”¨çš„ï¼Œè™½ç„¶å®ƒåœ¨é˜»å¡æ—¶æ•ˆç‡è¶…ä½ï¼Œä½†æ˜¯å¯¹äºä»£ç ä¸­çš„ç¼“å­˜é˜»å¡è¿™é‡Œå±äºä½é¢‘äº‹ä»¶ï¼Œä½¿ç”¨ dispatch_semaphore åœ¨éé˜»å¡çŠ¶æ€ä¸‹æ€§èƒ½å¾ˆé«˜ï¼Œè¿™é‡Œé”çš„é€‰æ‹©éå¸¸åˆé€‚ã€‚ å…³äº YYClassInfo çš„æ›´æ–°é¦–å…ˆ YYClassInfo æ˜¯ä½œè€…å¯¹åº” objc_class å°è£…å‡ºæ¥çš„ç±»ï¼Œæ‰€ä»¥ç†åº”åœ¨å…¶å¯¹åº”çš„ objc_class å®ä¾‹å‘ç”Ÿå˜åŒ–æ—¶æ›´æ–°ã€‚é‚£ä¹ˆ objc_class ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿå˜åŒ–å‘¢ï¼Ÿ å˜›~ æ¯”å¦‚ä½ ä½¿ç”¨äº† class_addMethod æ–¹æ³•ä¸ºä½ çš„æ¨¡å‹ç±»åŠ å…¥äº†ä¸€ä¸ªæ–¹æ³•ç­‰ç­‰ã€‚ YYClassInfo æœ‰ä¸€ä¸ªç§æœ‰ BOOL ç±»å‹å‚æ•° _needUpdate ç”¨ä»¥è¡¨ç¤ºå½“å‰çš„ YYClassInfo å®ä¾‹æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œå¹¶ä¸”æä¾›äº† - (void)setNeedUpdate; æ¥å£æ–¹ä¾¿æˆ‘ä»¬åœ¨æ›´æ”¹äº†è‡ªå·±çš„æ¨¡å‹ç±»æ—¶è°ƒç”¨å…¶å°† _needUpdate è®¾ç½®ä¸º YESï¼Œå½“ _needUpdate ä¸º YES æ—¶åé¢å°±ä¸ç”¨æˆ‘è¯´äº†ï¼Œç›¸å…³çš„ä»£ç åœ¨ä¸Šä¸€èŠ‚åˆå§‹åŒ–ä¸­æœ‰å“¦ã€‚ 123if (info &amp;&amp; info-&gt;_needUpdate) &#123; [info _update];&#125; ç®€å•ä»‹ç»ä¸€ä¸‹ _updateï¼Œå®ƒæ˜¯ YYClassInfo çš„ç§æœ‰æ–¹æ³•ï¼Œå®ƒçš„å®ç°é€»è¾‘ç®€å•ä»‹ç»å°±æ˜¯æ¸…ç©ºå½“å‰ YYClassInfo å®ä¾‹å˜é‡ï¼Œæ–¹æ³•ä»¥åŠå±æ€§ï¼Œä¹‹åå†é‡æ–°åˆå§‹åŒ–å®ƒä»¬ã€‚ç”±äº _update å®ç°æºç å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„ï¼Œæˆ‘è¿™é‡Œå°±ä¸è´´æºç äº†ã€‚ å˜›~ å¯¹ YYClassInfo çš„å‰–æåˆ°è¿™é‡Œå°±å·®ä¸å¤šäº†ã€‚ NSObject+YYModel æ¢ç©¶ å¦‚æœè¯´ YYClassInfo ä¸»è¦æ˜¯ä½œè€…å¯¹ Runtime å±‚åœ¨ JSON æ¨¡å‹è½¬æ¢ä¸­éœ€è¦ç”¨åˆ°çš„ç»“æ„ä½“çš„å°è£…ï¼Œé‚£ä¹ˆ NSObject+YYModel åœ¨ YYModel ä¸­æ‹…å½“çš„è´£ä»»åˆ™æ˜¯åˆ©ç”¨ YYClassInfo å±‚çº§å°è£…å¥½çš„ç±»åˆ‡å®çš„æ‰§è¡Œ JSON æ¨¡å‹ä¹‹é—´çš„è½¬æ¢é€»è¾‘ï¼Œå¹¶ä¸”æä¾›äº†æ— ä¾µå…¥æ€§çš„æ¥å£ã€‚ ç¬¬ä¸€æ¬¡é˜…è¯» NSObject+YYModel.m çš„æºç å¯èƒ½ä¼šæœ‰äº›ä¸é€‚åº”ï¼Œè¿™å¾ˆæ­£å¸¸ã€‚å› ä¸ºå…¶å¤§é‡ä½¿ç”¨äº† Runtime å‡½æ•°ä¸ CoreFoundation åº“ï¼ŒåŠ ä¸Šå„ç§ç±»å‹ç¼–ç å’Œé€’å½’è§£æï¼Œä»£ç é‡ä¹Ÿæœ‰ 1800 å¤šè¡Œäº†ã€‚ æˆ‘ç®€å•æŠŠ NSObject+YYModel.m çš„æºç åšäº†ä¸€ä¸‹åˆ’åˆ†ï¼Œè¿™æ ·åˆ’åˆ†ä¹‹åä»£ç çœ‹èµ·æ¥ä¸€æ ·å¾ˆç®€å•æ¸…æ™°ï¼š ç±»å‹ç¼–ç è§£æ æ•°æ®ç»“æ„å®šä¹‰ é€’å½’æ¨¡å‹è½¬æ¢ æ¥å£ç›¸å…³ä»£ç  ç±»å‹ç¼–ç è§£æç±»å‹ç¼–ç è§£æä»£ç ä¸»è¦é›†ä¸­åœ¨ NSObject+YYModel.m çš„ä¸Šé¢éƒ¨åˆ†ï¼Œæ¶‰åŠåˆ° YYEncodingNSType æšä¸¾çš„å®šä¹‰ï¼Œé…å¥— YYClassGetNSType å‡½æ•°å°† NS ç±»å‹è½¬ä¸º YYEncodingNSType è¿˜æœ‰ YYEncodingTypeIsCNumber å‡½æ•°åˆ¤æ–­ç±»å‹æ˜¯å¦å¯ä»¥ç›´æ¥è½¬ä¸º C è¯­è¨€æ•°å€¼ç±»å‹çš„å‡½æ•°ã€‚ æ­¤å¤–è¿˜æœ‰å°† id æŒ‡é’ˆè½¬ä¸ºå¯¹åº” NSNumber çš„å‡½æ•° YYNSNumberCreateFromIDï¼Œå°† NSString è½¬ä¸º NSDate çš„ YYNSDateFromString å‡½æ•°ï¼Œè¿™ç±»å‡½æ•°ä¸»è¦æ˜¯æ–¹ä¾¿åœ¨æ¨¡å‹è½¬æ¢æ—¶ä½¿ç”¨ã€‚ 12345678910111213141516171819202122232425262728293031323334static force_inline NSDate *YYNSDateFromString(__unsafe_unretained NSString *string) &#123; typedef NSDate* (^YYNSDateParseBlock)(NSString *string); // YYNSDateFromString æ”¯æŒè§£æçš„æœ€é•¿æ—¶é—´å­—ç¬¦ä¸² #define kParserNum 34 // è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªå•ä¾‹æ—¶é—´è§£æä»£ç å—æ•°ç»„ // ä¸ºäº†é¿å…é‡å¤åˆ›å»ºè¿™äº› NSDateFormatterï¼Œå®ƒçš„åˆå§‹åŒ–å¼€é”€ä¸å° static YYNSDateParseBlock blocks[kParserNum + 1] = &#123;0&#125;; static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^&#123; // è¿™é‡Œæ‹¿ `yyyy-MM-dd` ä¸¾ä¾‹åˆ†æ &#123; /* 2014-01-20 // Google */ NSDateFormatter *formatter = [[NSDateFormatter alloc] init]; formatter.locale = [[NSLocale alloc] initWithLocaleIdentifier:@&quot;en_US_POSIX&quot;]; formatter.timeZone = [NSTimeZone timeZoneForSecondsFromGMT:0]; formatter.dateFormat = @&quot;yyyy-MM-dd&quot;; // è¿™é‡Œä½¿ç”¨ blocks[10] æ˜¯å› ä¸º `yyyy-MM-dd` çš„é•¿åº¦å°±æ˜¯ 10 blocks[10] = ^(NSString *string) &#123; return [formatter dateFromString:string]; &#125;; &#125; // å…¶ä»–çš„æ ¼å¼éƒ½æ˜¯ä¸€æ ·ç±»å‹çš„ä»£ç ï¼Œçœç•¥ ... &#125;); if (!string) return nil; if (string.length &gt; kParserNum) return nil; // æ ¹æ®å…¥å‚çš„é•¿åº¦å»åˆšæ‰å­˜æ»¡å„ç§æ ¼å¼æ—¶é—´è§£æä»£ç å—çš„å•ä¾‹æ•°ç»„å–å‡ºå¯¹åº”çš„ä»£ç å—æ‰§è¡Œ YYNSDateParseBlock parser = blocks[string.length]; if (!parser) return nil; return parser(string); #undef kParserNum&#125; Note: åœ¨ iOS 7 ä¹‹å‰ NSDateFormatter æ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚ é™¤æ­¤ä¹‹å¤–è¿˜ç”¨ YYNSBlockClass æŒ‡å‘äº† NSBlock ç±»ï¼Œå®ç°è¿‡ç¨‹ä¹Ÿæ¯”è¾ƒå·§å¦™ã€‚ 12345678910111213static force_inline Class YYNSBlockClass() &#123; static Class cls; static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^&#123; void (^block)(void) = ^&#123;&#125;; cls = ((NSObject *)block).class; // è½®è¯¢çˆ¶ç±»ç›´åˆ°çˆ¶ç±»æŒ‡å‘ NSObject åœæ­¢ while (class_getSuperclass(cls) != [NSObject class]) &#123; cls = class_getSuperclass(cls); &#125; &#125;); return cls; // æ‹¿åˆ°çš„å°±æ˜¯ &quot;NSBlock&quot;&#125; å…³äº force_inline è¿™ç§ä»£ç æŠ€å·§ï¼Œæˆ‘è¯´è¿‡æˆ‘åœ¨å†™å®Œ YYModel æˆ–è€…æ”’åˆ°è¶³å¤Ÿå¤šçš„æ—¶å€™ä¼šä¸»åŠ¨æ‹¿å‡ºæ¥ä¸å¤§å®¶åˆ†äº«è¿™äº›ä»£ç æŠ€å·§ï¼Œä¸è¿‡è¿™é‡Œå¤§å®¶é€šè¿‡å­—é¢ä¹Ÿä¸éš¾ç†è§£ï¼Œå°±æ˜¯å¼ºåˆ¶å†…è”ã€‚ å˜›~ å…³äºå†…è”å‡½æ•°åº”è¯¥ä¸éœ€è¦æˆ‘å¤šè¯´ï¼ˆç¬‘ï¼‰ã€‚ æ•°æ®ç»“æ„å®šä¹‰NSObject+YYModel ä¸­é‡æ–°å®šä¹‰äº†ä¸¤ä¸ªç±»ï¼Œé€šè¿‡å®ƒä»¬æ¥ä½¿ç”¨ YYClassInfo ä¸­çš„å°è£…ã€‚ NSObject+YYModel YYClassInfo _YYModelPropertyMeta YYClassPropertyInfo _YYModelMeta YYClassInfo _YYModelPropertyMeta_YYModelPropertyMeta è¡¨ç¤ºæ¨¡å‹å¯¹è±¡ä¸­çš„å±æ€§ä¿¡æ¯ï¼Œå®ƒåŒ…å« YYClassPropertyInfoã€‚ 1234567891011121314151617181920212223242526@interface _YYModelPropertyMeta : NSObject &#123; @package NSString *_name; ///&lt; å±æ€§åç§° YYEncodingType _type; ///&lt; å±æ€§ç±»å‹ YYEncodingNSType _nsType; ///&lt; å±æ€§åœ¨ Foundation æ¡†æ¶ä¸­çš„ç±»å‹ BOOL _isCNumber; ///&lt; æ˜¯å¦ä¸º CNumber Class _cls; ///&lt; å±æ€§ç±» Class _genericCls; ///&lt; å±æ€§åŒ…å«çš„æ³›å‹ç±»å‹ï¼Œæ²¡æœ‰åˆ™ä¸º nil SEL _getter; ///&lt; getter SEL _setter; ///&lt; setter BOOL _isKVCCompatible; ///&lt; å¦‚æœå¯ä»¥ä½¿ç”¨ KVC åˆ™è¿”å› YES BOOL _isStructAvailableForKeyedArchiver; ///&lt; å¦‚æœå¯ä»¥ä½¿ç”¨ archiver/unarchiver å½’/è§£æ¡£åˆ™è¿”å› YES BOOL _hasCustomClassFromDictionary; ///&lt; ç±»/æ³›å‹è‡ªå®šä¹‰ç±»å‹ï¼Œä¾‹å¦‚éœ€è¦åœ¨æ•°ç»„ä¸­å®ç°ä¸åŒç±»å‹çš„è½¬æ¢éœ€è¦ç”¨åˆ° /* property-&gt;key: _mappedToKey:key _mappedToKeyPath:nil _mappedToKeyArray:nil property-&gt;keyPath: _mappedToKey:keyPath _mappedToKeyPath:keyPath(array) _mappedToKeyArray:nil property-&gt;keys: _mappedToKey:keys[0] _mappedToKeyPath:nil/keyPath _mappedToKeyArray:keys(array) */ NSString *_mappedToKey; ///&lt; æ˜ å°„ key NSArray *_mappedToKeyPath; ///&lt; æ˜ å°„ keyPathï¼Œå¦‚æœæ²¡æœ‰æ˜ å°„åˆ° keyPath åˆ™è¿”å› nil NSArray *_mappedToKeyArray; ///&lt; key æˆ–è€… keyPath çš„æ•°ç»„ï¼Œå¦‚æœæ²¡æœ‰æ˜ å°„å¤šä¸ªé”®çš„è¯åˆ™è¿”å› nil YYClassPropertyInfo *_info; ///&lt; å±æ€§ä¿¡æ¯ï¼Œè¯¦è§ä¸Šæ–‡ YYClassPropertyInfo &amp;&amp; property_t ç« èŠ‚ _YYModelPropertyMeta *_next; ///&lt; å¦‚æœæœ‰å¤šä¸ªå±æ€§æ˜ å°„åˆ°åŒä¸€ä¸ª key åˆ™æŒ‡å‘ä¸‹ä¸€ä¸ªæ¨¡å‹å±æ€§å…ƒ&#125;@end _YYModelMeta_YYModelMeta è¡¨ç¤ºæ¨¡å‹çš„ç±»ä¿¡æ¯ï¼Œå®ƒåŒ…å« YYClassInfoã€‚ 1234567891011121314151617181920@interface _YYModelMeta : NSObject &#123; @package YYClassInfo *_classInfo; /// Key:è¢«æ˜ å°„çš„ key ä¸ keyPath, Value:_YYModelPropertyMeta. NSDictionary *_mapper; /// Array&lt;_YYModelPropertyMeta&gt;, å½“å‰æ¨¡å‹çš„æ‰€æœ‰ _YYModelPropertyMeta æ•°ç»„ NSArray *_allPropertyMetas; /// Array&lt;_YYModelPropertyMeta&gt;, è¢«æ˜ å°„åˆ° keyPath çš„ _YYModelPropertyMeta æ•°ç»„ NSArray *_keyPathPropertyMetas; /// Array&lt;_YYModelPropertyMeta&gt;, è¢«æ˜ å°„åˆ°å¤šä¸ª key çš„ _YYModelPropertyMeta æ•°ç»„ NSArray *_multiKeysPropertyMetas; /// æ˜ å°„ key ä¸ keyPath çš„æ•°é‡ï¼Œç­‰åŒäº _mapper.count NSUInteger _keyMappedCount; /// æ¨¡å‹ class ç±»å‹ YYEncodingNSType _nsType; // å¿½ç•¥ ...&#125;@end é€’å½’æ¨¡å‹è½¬æ¢NSObject+YYModel.m å†…å†™äº†ä¸€äº›ï¼ˆé—´æ¥ï¼‰é€’å½’æ¨¡å‹è½¬æ¢ç›¸å…³çš„å‡½æ•°ï¼Œå¦‚ ModelToJSONObjectRecursive ä¹‹ç±»çš„ï¼Œç”±äºæ¶‰åŠç¹æ‚çš„æ¨¡å‹ç¼–ç è§£æä»¥åŠä»£ç é‡æ¯”è¾ƒå¤§ç­‰åŸå› æˆ‘ä¸å‡†å¤‡æ”¾åœ¨è¿™é‡Œè¯¦ç»†è®²è§£ã€‚ æˆ‘è®¤ä¸ºè¿™ç§é€»è¾‘å¹¶ä¸å¤æ‚ä½†æ˜¯ç‰µæ‰¯è¾ƒå¤šçš„å‡½æ•°ä»£ç ä¸ç»“æ„/ç±»å‹å®šä¹‰ä»£ç ä¸åŒï¼Œåè€…æ›´é€‚åˆåˆ—å‡ºæºç è®©è¯»è€…å¯¹æ•°æ®æœ‰å…¨é¢æ¸…é†’çš„è®¤è¯†ï¼Œè€Œå‰è€…ç»“åˆåŠŸèƒ½å®ä¾‹è®²æ›´å®¹æ˜“ä½¿è¯»è€…å¯¹æ•´æ¡åŠŸèƒ½çš„æµç¨‹æœ‰ä¸€ä¸ªæ›´é€å½»çš„ç†è§£ã€‚ æ‰€ä»¥æˆ‘å‡†å¤‡æ”¾åˆ°åé¢ JSON ä¸ Model ç›¸äº’è½¬æ¢æ—¶ä¸€èµ·è®²ã€‚ æ¥å£ç›¸å…³ä»£ç å˜›~ ç†ç”±åŒä¸Šã€‚ åŠç« æ€»ç»“ æ–‡ç« å¯¹ YYModel æºç è¿›è¡Œäº†ç³»ç»Ÿè§£è¯»ï¼Œæœ‰æ¡ç†çš„ä»‹ç»äº† YYModel çš„ç»“æ„ï¼Œç›¸ä¿¡ä¼šè®©å„ä½å¯¹ YYModel çš„ä»£ç ç»“æ„æœ‰ä¸€ä¸ªæ¸…æ™°çš„è®¤è¯†ã€‚ æ·±å…¥å‰–æäº† YYClassInfo çš„ 4 ä¸ªç±»ï¼Œå¹¶è¯¦ç»†è®²è§£äº†å®ƒä»¬ä¸ Runtime å±‚çº§ç»“æ„ä½“çš„å¯¹åº”ã€‚ åœ¨å‰–æ YYClassInfo ç« èŠ‚ä¸­åˆ†äº«äº†ä¸€äº›æˆ‘åœ¨é˜…è¯»æºç çš„è¿‡ç¨‹ä¸­å‘ç°çš„å¹¶ä¸”è§‰å¾—å€¼å¾—åˆ†äº«çš„å¤„ç†ç»†èŠ‚ï¼Œæ¯”å¦‚ä¸ºä»€ä¹ˆä½œè€…é€‰æ‹©ç”¨ strong æ¥ä¿®é¥° NSString ç­‰ã€‚é¡ºä¾¿è¿˜å¯¹ SEL ä¸ char * çš„å…³ç³»åšäº†å®éªŒå¾—å‡ºäº†æˆ‘çš„æ¨è®ºã€‚ æŠŠ YYClassInfo çš„åˆå§‹åŒ–ä»¥åŠæ›´æ–°ç»†èŠ‚å•ç‹¬æ‹å‡ºæ¥åšäº†åˆ†æã€‚ æ¢ç©¶ NSObject+YYModel æºç ï¼ˆåˆ†äº«äº†ä¸€äº›å®ç°ç»†èŠ‚ï¼‰å¹¶å¯¹å…¶å®ç°ä»£ç åšäº†åˆ’åˆ†ï¼Œå¸Œæœ›èƒ½å¤Ÿå¯¹è¯»è€…é˜…è¯» YYModel æºç æ—¶æä¾›ä¸€äº›å°å°çš„å¸®åŠ©ã€‚ å˜›~ ä¸Šç¯‡å·®ä¸å¤šå°±è¿™æ ·äº†ã€‚æˆ‘å†™çš„ä¸Šä¸€ç¯‡ YYKit æºç ç³»åˆ—æ–‡ç« ã€ä» YYCache æºç  Get åˆ°å¦‚ä½•è®¾è®¡ä¸€ä¸ªä¼˜ç§€çš„ç¼“å­˜ã€‘æ”¶åˆ°äº†ä¸å°‘çš„å¥½è¯„å’Œæ”¯æŒï¼ˆæ˜é‡‘é‡Œä¸€ä½è¯»è€… @ios123456 çš„è¯„è®ºæ›´æ˜¯æš–åŒ–äº†æˆ‘ï¼‰ï¼Œè¿™äº›ç¾å¥½çš„ä¸œè¥¿è®©æˆ‘æ›´åŠ åšå®šäº†ç»§ç»­ç”¨å¿ƒåˆ›ä½œæ–‡ç« çš„å†³å¿ƒã€‚ æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜ https://lision.me/ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ ä¸ªäººåšå®¢ ä¸­æ›´æ–°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš @Lision è”ç³»æˆ‘~ å¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~"},{"title":"ä» YYCache æºç  Get åˆ°å¦‚ä½•è®¾è®¡ä¸€ä¸ªä¼˜ç§€çš„ç¼“å­˜","comments":true,"permalink":"https://lision.me/yycache/","text":"å‰è¨€iOS å¼€å‘ä¸­æ€»ä¼šç”¨åˆ°å„ç§ç¼“å­˜ï¼Œä½†æ˜¯å„ä½æœ‰æ²¡æœ‰è€ƒè™‘è¿‡ä»€ä¹ˆæ ·çš„ç¼“å­˜æ‰èƒ½è¢«å«åšä¼˜ç§€çš„ç¼“å­˜ï¼Œæˆ–è€…è¯´ä¼˜ç§€çš„ç¼“å­˜åº”è¯¥å…·å¤‡å“ªäº›ç‰¹è´¨ï¼Ÿ é—­ä¸Šçœ¼ç›ï¼Œæƒ³ä¸€æƒ³å¦‚æœé¢è¯•å®˜è®©ä½ è®¾è®¡ä¸€ä¸ªç¼“å­˜ä½ ä¼šæ€ä¹ˆå›ç­”ï¼Ÿ æœ¬æ–‡å°†ç»“åˆ YYCache çš„æºç é€æ­¥å¸¦å¤§å®¶æ‰¾åˆ°ç­”æ¡ˆã€‚ YYCache æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„é«˜æ€§èƒ½é”®å€¼ç¼“å­˜ï¼ˆè¯¥é¡¹ç›®æ˜¯ YYKit ç»„ä»¶ä¹‹ä¸€ï¼‰ã€‚YYKit æ˜¯åœ¨ 2015 å¹´å‘å¸ƒåˆ° Github çš„ï¼Œç”±äºå…¶ä»£ç è´¨é‡å¾ˆé«˜ï¼Œåœ¨çŸ­æ—¶é—´å†…å°±æ”¶è·äº†å¤§é‡çš„ Starï¼ˆç›®å‰å·²ç» 1w+ Star äº†ï¼‰ï¼Œè€Œä¸”åœ¨ iOS å„å¤§ç¤¾åŒºåå“å¹¿æ³›ï¼ŒGoogle ä¸€ä¸‹ä¹Ÿæ˜¯æ¼«å¤©èµå¹ã€‚ YYKit ä½œè€…æ˜¯ @ibiremeï¼ŒåŸåéƒ­æ›œæºï¼ˆçŒœæµ‹ YY å‰ç¼€æ¥æºäºæ›œæºï¼Ÿï¼‰ï¼Œæ˜¯æˆ‘ä¸ªäººéå¸¸å–œæ¬¢çš„å›½äººå¼€å‘è€…ï¼ˆä½•æ­¢å–œæ¬¢ï¼Œç®€ç›´æ˜¯è¿·å¼ŸğŸ˜˜ï¼‰ã€‚ YYCache çš„ä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ³¨é‡Šè¯¦å°½ï¼ŒåŠ ä¸Šè‡ªèº«ä¸ç®—å¤ªå¤§çš„ä»£ç é‡ä½¿å¾—å…¶é˜…è¯»éå¸¸ç®€å•ï¼Œæ›´åŠ éš¾èƒ½å¯è´µçš„æ˜¯å®ƒçš„æ€§èƒ½è¿˜éå¸¸é«˜ã€‚ æˆ‘å¯¹å®ƒçš„è¯„ä»·æ˜¯å°è€Œç¾ï¼Œè¿™ç§å°è€Œç¾çš„ç¼“å­˜æºç å¯¹äºæˆ‘ä»¬ä»Šå¤©çš„ä¸»é¢˜å¤ªåˆé€‚ä¸è¿‡äº†ï¼ˆæœ¬æ–‡ä¸­ YYCache æºç ç‰ˆæœ¬ä¸º v1.0.4ï¼‰ã€‚ ç´¢å¼• YYCache ç®€ä»‹ YYMemoryCache ç»†èŠ‚å‰–æ YYDiskCache ç»†èŠ‚å‰–æ ä¼˜ç§€çš„ç¼“å­˜åº”è¯¥å…·å¤‡å“ªäº›ç‰¹è´¨ æ€»ç»“ YYCache ç®€ä»‹ ç®€å•æŠŠ YYCache ä»å¤´åˆ°å°¾æ’¸äº†ä¸€éï¼Œæœ€å¤§çš„æ„Ÿè§¦å°±æ˜¯ä»£ç é£æ ¼å¹²å‡€æ•´æ´ï¼Œä»£ç æ€è·¯æ¸…æ™°æ˜äº†ã€‚ ç”±äºä»£ç æ•´ä½“é˜…è¯»éš¾åº¦ä¸æ˜¯éå¸¸å¤§ï¼Œæœ¬æ–‡ä¸ä¼šå»é€å­—é€å¥çš„è§£è¯»æºç ï¼Œè€Œæ˜¯æç‚¼ YYCache ä½œä¸ºä¸€ä¸ªå°è€Œç¾çš„ç¼“å­˜å®ç°äº†å“ªäº›ç¼“å­˜è¯¥å…·å¤‡çš„ç‰¹è´¨ï¼Œå¹¶ä¸”åˆ†æå®ç°ç»†èŠ‚ã€‚ æˆ‘ä»¬å…ˆæ¥ç®€å•çœ‹ä¸€ä¸‹ YYCache çš„ä»£ç ç»“æ„ï¼ŒYYCache æ˜¯ç”± YYMemoryCache ä¸ YYDiskCache ä¸¤éƒ¨åˆ†ç»„æˆçš„ï¼Œå…¶ä¸­ YYMemoryCache ä½œä¸ºé«˜é€Ÿå†…å­˜ç¼“å­˜ï¼Œè€Œ YYDiskCache åˆ™ä½œä¸ºä½é€Ÿç£ç›˜ç¼“å­˜ã€‚ é€šå¸¸ä¸€ä¸ªç¼“å­˜æ˜¯ç”±å†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜ç»„æˆï¼Œå†…å­˜ç¼“å­˜æä¾›å®¹é‡å°ä½†é«˜é€Ÿçš„å­˜å–åŠŸèƒ½ï¼Œç£ç›˜ç¼“å­˜æä¾›å¤§å®¹é‡ä½†ä½é€Ÿçš„æŒä¹…åŒ–å­˜å‚¨ã€‚ 123456789101112@interface YYCache : NSObject@property (copy, readonly) NSString *name;@property (strong, readonly) YYMemoryCache *memoryCache;@property (strong, readonly) YYDiskCache *diskCache;- (BOOL)containsObjectForKey:(NSString *)key;- (nullable id&lt;NSCoding&gt;)objectForKey:(NSString *)key;- (void)setObject:(nullable id&lt;NSCoding&gt;)object forKey:(NSString *)key;- (void)removeObjectForKey:(NSString *)key;@end ä¸Šé¢çš„ä»£ç æˆ‘åšäº†ç®€åŒ–ï¼Œåªä¿ç•™äº†æœ€åŸºæœ¬çš„ä»£ç ï¼ˆæˆ‘è®¤ä¸ºä½œè€…åœ¨æœ€åˆè®¾è®¡ YYCache é›å½¢æ—¶å¾ˆå¯èƒ½ä¹Ÿåªæ˜¯æä¾›äº†è¿™äº›åŸºæœ¬çš„æ¥å£ï¼‰ï¼Œå…¶ä»–çš„æ¥å£åªæ˜¯é€šè¿‡è°ƒç”¨åŸºæœ¬çš„æ¥å£å†é™„åŠ å¯¹åº”å¤„ç†ä»£ç è€Œæˆã€‚ Note: å…¶å®æºç ä¸­ä½œè€…ç”¨äº†ä¸€äº›æŠ€å·§æ€§çš„å®ï¼Œä¾‹å¦‚ NS_ASSUME_NONNULL_BEGIN ä¸ NS_ASSUME_NONNULL_END æ¥é€šè¿‡ç¼–è¯‘å™¨å±‚æ£€æµ‹å…¥å‚æ˜¯å¦ä¸ºç©ºå¹¶ç»™äºˆè­¦å‘Šï¼Œå‚è§ Nullability and Objective-Cã€‚ ç±»ä¼¼ä¸Šè¿°çš„ç¼–ç æŠ€å·§è¿˜æœ‰å¾ˆå¤šï¼Œæˆ‘å¹¶éä¸æƒ³ä¸å¤§å®¶åˆ†äº«æˆ‘ get åˆ°çš„è¿™äº›ç¼–ç æŠ€å·§ï¼Œåªæ˜¯è§‰å¾—å®ƒä¸æœ¬æ–‡çš„ä¸»é¢˜ä¼¼ä¹ä¸å¤ªç›¸ç¬¦ã€‚æˆ‘å‡†å¤‡åœ¨ä¹‹åä¸“é—¨å†™ä¸€ç¯‡æ–‡ç« æ¥ä¸å¤§å®¶åˆ†äº«æˆ‘åœ¨é˜…è¯»å„å¤§æºç åº“è¿‡ç¨‹ä¸­ get åˆ°çš„ç¼–ç æŠ€å·§ï¼ˆæ„Ÿå…´è¶£çš„è¯å¯ä»¥ å…³æ³¨æˆ‘ï¼‰ã€‚ ä»ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ° YYCache ä¸­æŒæœ‰ YYMemoryCache ä¸ YYDiskCacheï¼Œå¹¶ä¸”å¯¹å¤–æä¾›äº†ä¸€äº›æ¥å£ã€‚è¿™äº›æ¥å£åŸºæœ¬éƒ½æ˜¯åŸºäº Key å’Œ Value è®¾è®¡çš„ï¼Œç±»ä¼¼äº iOS åŸç”Ÿçš„å­—å…¸ç±»æ¥å£ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰ã€‚ YYMemoryCache ç»†èŠ‚å‰–æ YYMemoryCache æ˜¯ä¸€ä¸ªé«˜é€Ÿçš„å†…å­˜ç¼“å­˜ï¼Œç”¨äºå­˜å‚¨é”®å€¼å¯¹ã€‚å®ƒä¸ NSDictionary ç›¸åï¼ŒKey è¢«ä¿ç•™å¹¶ä¸”ä¸å¤åˆ¶ã€‚API å’Œæ€§èƒ½ç±»ä¼¼äº NSCacheï¼Œæ‰€æœ‰æ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ YYMemoryCache å¯¹è±¡ä¸ NSCache çš„ä¸åŒä¹‹å¤„åœ¨äºï¼š YYMemoryCache ä½¿ç”¨ LRU(least-recently-used) ç®—æ³•æ¥é©±é€å¯¹è±¡ï¼›NSCache çš„é©±é€æ–¹å¼æ˜¯éç¡®å®šæ€§çš„ã€‚ YYMemoryCache æä¾› ageã€costã€count ä¸‰ç§æ–¹å¼æ§åˆ¶ç¼“å­˜ï¼›NSCache çš„æ§åˆ¶æ–¹å¼æ˜¯ä¸ç²¾ç¡®çš„ã€‚ YYMemoryCache å¯ä»¥é…ç½®ä¸ºåœ¨æ”¶åˆ°å†…å­˜è­¦å‘Šæˆ–è€… App è¿›å…¥åå°æ—¶è‡ªåŠ¨é€å‡ºå¯¹è±¡ã€‚ Note: YYMemoryCache ä¸­çš„ Access Methods æ¶ˆè€—æ—¶é•¿é€šå¸¸æ˜¯ç¨³å®šçš„ (O(1))ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940@interface YYMemoryCache : NSObject#pragma mark - Attribute@property (nullable, copy) NSString *name; // ç¼“å­˜åç§°ï¼Œé»˜è®¤ä¸º nil@property (readonly) NSUInteger totalCount; // ç¼“å­˜å¯¹è±¡æ€»æ•°@property (readonly) NSUInteger totalCost; // ç¼“å­˜å¯¹è±¡æ€»å¼€é”€#pragma mark - Limit@property NSUInteger countLimit; // ç¼“å­˜å¯¹è±¡æ•°é‡é™åˆ¶ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œè¶…è¿‡é™åˆ¶åˆ™ä¼šåœ¨åå°é€å‡ºä¸€äº›å¯¹è±¡ä»¥æ»¡è¶³é™åˆ¶@property NSUInteger costLimit; // ç¼“å­˜å¼€é”€æ•°é‡é™åˆ¶ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œè¶…è¿‡é™åˆ¶åˆ™ä¼šåœ¨åå°é€å‡ºä¸€äº›å¯¹è±¡ä»¥æ»¡è¶³é™åˆ¶@property NSTimeInterval ageLimit; // ç¼“å­˜æ—¶é—´é™åˆ¶ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œè¶…è¿‡é™åˆ¶åˆ™ä¼šåœ¨åå°é€å‡ºä¸€äº›å¯¹è±¡ä»¥æ»¡è¶³é™åˆ¶@property NSTimeInterval autoTrimInterval; // ç¼“å­˜è‡ªåŠ¨æ¸…ç†æ—¶é—´é—´éš”ï¼Œé»˜è®¤ 5s@property BOOL shouldRemoveAllObjectsOnMemoryWarning; // æ˜¯å¦åº”è¯¥åœ¨æ”¶åˆ°å†…å­˜è­¦å‘Šæ—¶åˆ é™¤æ‰€æœ‰ç¼“å­˜å†…å¯¹è±¡@property BOOL shouldRemoveAllObjectsWhenEnteringBackground; // æ˜¯å¦åº”è¯¥åœ¨ App è¿›å…¥åå°æ—¶åˆ é™¤æ‰€æœ‰ç¼“å­˜å†…å¯¹è±¡@property (nullable, copy) void(^didReceiveMemoryWarningBlock)(YYMemoryCache *cache); // æˆ‘è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ª hookï¼Œä¾¿äºæˆ‘ä»¬åœ¨æ”¶åˆ°å†…å­˜è­¦å‘Šæ—¶è‡ªå®šä¹‰å¤„ç†ç¼“å­˜@property (nullable, copy) void(^didEnterBackgroundBlock)(YYMemoryCache *cache); // æˆ‘è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ª hookï¼Œä¾¿äºæˆ‘ä»¬åœ¨æ”¶åˆ° App è¿›å…¥åå°æ—¶è‡ªå®šä¹‰å¤„ç†ç¼“å­˜@property BOOL releaseOnMainThread; // æ˜¯å¦åœ¨ä¸»çº¿ç¨‹é‡Šæ”¾å¯¹è±¡ï¼Œé»˜è®¤ NOï¼Œæœ‰äº›å¯¹è±¡ï¼ˆä¾‹å¦‚ UIView/CALayerï¼‰åº”è¯¥åœ¨ä¸»çº¿ç¨‹é‡Šæ”¾@property BOOL releaseAsynchronously; // æ˜¯å¦å¼‚æ­¥é‡Šæ”¾å¯¹è±¡ï¼Œé»˜è®¤ YES- (BOOL)containsObjectForKey:(id)key;- (nullable id)objectForKey:(id)key;- (void)setObject:(nullable id)object forKey:(id)key;- (void)setObject:(nullable id)object forKey:(id)key withCost:(NSUInteger)cost;- (void)removeObjectForKey:(id)key;- (void)removeAllObjects;#pragma mark - Trim- (void)trimToCount:(NSUInteger)count; // ç”¨ LRU ç®—æ³•åˆ é™¤å¯¹è±¡ï¼Œç›´åˆ° totalCount &lt;= count- (void)trimToCost:(NSUInteger)cost; // ç”¨ LRU ç®—æ³•åˆ é™¤å¯¹è±¡ï¼Œç›´åˆ° totalCost &lt;= cost- (void)trimToAge:(NSTimeInterval)age; // ç”¨ LRU ç®—æ³•åˆ é™¤å¯¹è±¡ï¼Œç›´åˆ°æ‰€æœ‰åˆ°æœŸå¯¹è±¡å…¨éƒ¨è¢«åˆ é™¤@end YYMemoryCache çš„å®šä¹‰ä»£ç æ¯”è¾ƒç®€å•~ è¯¥æœ‰çš„æ³¨é‡Šæˆ‘å·²ç»åŠ åˆ°äº†ä¸Šé¢ï¼Œè¿™é‡Œ LRU ç®—æ³•çš„å®ç°æˆ‘å‡†å¤‡å•ç‹¬æ‹å‡ºæ¥æ”¾åˆ°åé¢å’Œï¼ˆ_YYLinkedMapNode ä¸ _YYLinkedMapï¼‰ä¸€èµ·è®²ã€‚æˆ‘ä»¬è¿™é‡Œåªéœ€è¦å†å…³æ³¨ä¸€ä¸‹ YYMemoryCache æ˜¯å¦‚ä½•åšåˆ°çº¿ç¨‹å®‰å…¨çš„ã€‚ YYMemoryCache æ˜¯å¦‚ä½•åšåˆ°çº¿ç¨‹å®‰å…¨çš„12345@implementation YYMemoryCache &#123; pthread_mutex_t _lock; // çº¿ç¨‹é”ï¼Œæ—¨åœ¨ä¿è¯ YYMemoryCache çº¿ç¨‹å®‰å…¨ _YYLinkedMap *_lru; // _YYLinkedMapï¼ŒYYMemoryCache é€šè¿‡å®ƒé—´æ¥æ“ä½œç¼“å­˜å¯¹è±¡ dispatch_queue_t _queue; // ä¸²è¡Œé˜Ÿåˆ—ï¼Œç”¨äº YYMemoryCache çš„ trim æ“ä½œ&#125; æ²¡é”™ï¼Œè¿™é‡Œ ibireme é€‰æ‹©ä½¿ç”¨ pthread_mutex çº¿ç¨‹é”æ¥ç¡®ä¿ YYMemoryCache çš„çº¿ç¨‹å®‰å…¨ã€‚ æœ‰è¶£çš„æ˜¯ï¼Œè¿™é‡Œ ibireme ä½¿ç”¨ pthread_mutex æ˜¯æœ‰ä¸€æ®µå°æ•…äº‹çš„ã€‚åœ¨æœ€åˆ YYMemoryCache è¿™é‡Œä½¿ç”¨çš„é”æ˜¯ OSSpinLock è‡ªæ—‹é”ï¼ˆè¯¦è§ YYCache è®¾è®¡æ€è·¯ å¤‡æ³¨-å…³äºé”ï¼‰ï¼Œåé¢æœ‰äººåœ¨ Github å‘ä½œè€…æ issue åé¦ˆ OSSpinLock ä¸å®‰å…¨ï¼Œç»è¿‡ä½œè€…çš„ç¡®è®¤ï¼ˆè¯¦è§ ä¸å†å®‰å…¨çš„ OSSpinLockï¼‰æœ€åé€‰æ‹©ç”¨ pthread_mutex æ›¿ä»£ OSSpinLockã€‚ ä¸Šé¢æ˜¯ ibireme åœ¨ç¡®è®¤ OSSpinLock ä¸å†å®‰å…¨ä¹‹åä¸ºäº†å¯»æ‰¾æ›¿ä»£æ–¹æ¡ˆåšçš„ç®€å•æ€§èƒ½æµ‹è¯•ï¼Œå¯¹æ¯”äº†ä¸€ä¸‹å‡ ç§èƒ½å¤Ÿæ›¿ä»£ OSSpinLock é”çš„æ€§èƒ½ã€‚åœ¨ ä¸å†å®‰å…¨çš„ OSSpinLock æ–‡æœ«çš„è¯„è®ºä¸­ï¼Œæˆ‘æ‰¾åˆ°äº†ä½œè€…ä½¿ç”¨ pthread_mutex çš„åŸå› ã€‚ ibireme: è‹¹æœå‘˜å·¥è¯´ libobjc é‡Œ spinlock æ˜¯ç”¨äº†ä¸€äº›ç§æœ‰æ–¹æ³• (mach_thread_switch)ï¼Œè´¡çŒ®å‡ºäº†é«˜çº¿ç¨‹çš„ä¼˜å…ˆæ¥é¿å…ä¼˜å…ˆçº§åè½¬çš„é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ç¿»äº†ä¸‹ libdispatch çš„æºç å€’æ˜¯æ²¡å‘ç°ç›¸å…³é€»è¾‘ï¼Œä¹Ÿå¯èƒ½æ˜¯æˆ‘å¿½ç•¥äº†ä»€ä¹ˆã€‚åœ¨æˆ‘çš„ä¸€äº›æµ‹è¯•ä¸­ï¼ŒOSSpinLock å’Œ dispatch_semaphore éƒ½ä¸ä¼šäº§ç”Ÿç‰¹åˆ«æ˜æ˜¾çš„æ­»é”ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿæ— æ³•ç¡®å®šç”¨ dispatch_semaphore ä»£æ›¿ OSSpinLock æ˜¯å¦æ­£ç¡®ã€‚èƒ½å¤Ÿè‚¯å®šçš„æ˜¯ï¼Œç”¨ pthread_mutex æ˜¯å®‰å…¨çš„ã€‚ _YYLinkedMapNode ä¸ _YYLinkedMapä¸Šæ–‡ä»‹ç»äº† YYMemoryCacheï¼Œå…¶å® YYMemoryCache å¹¶ä¸ç›´æ¥æ“ä½œç¼“å­˜å¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡å†…éƒ¨çš„ _YYLinkedMapNode ä¸ _YYLinkedMap æ¥é—´æ¥çš„æ“ä½œç¼“å­˜å¯¹è±¡ã€‚è¿™ä¸¤ä¸ªç±»å¯¹äºä¸Šæ–‡ä¸­æåˆ°çš„ LRU ç¼“å­˜ç®—æ³•çš„ç†è§£è‡³å…³é‡è¦ï¼Œæ‰€ä»¥æˆ‘æŠŠä»–ä»¬ä¿©å•ç‹¬æ‹å‡ºæ¥æ”¾åœ¨è¿™é‡Œè¯¦ç»†è§£è¯»ä¸€ä¸‹ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142/** _YYLinkedMap ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ã€‚ é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬ä¸åº”è¯¥ä½¿ç”¨è¿™ä¸ªç±»ã€‚ */@interface _YYLinkedMapNode : NSObject &#123; @package __unsafe_unretained _YYLinkedMapNode *_prev; // __unsafe_unretained æ˜¯ä¸ºäº†æ€§èƒ½ä¼˜åŒ–ï¼ŒèŠ‚ç‚¹è¢« _YYLinkedMap çš„ _dic å¼ºå¼•ç”¨ __unsafe_unretained _YYLinkedMapNode *_next; // __unsafe_unretained æ˜¯ä¸ºäº†æ€§èƒ½ä¼˜åŒ–ï¼ŒèŠ‚ç‚¹è¢« _YYLinkedMap çš„ _dic å¼ºå¼•ç”¨ id _key; id _value; NSUInteger _cost; // è®°å½•å¼€é”€ï¼Œå¯¹åº” YYMemoryCache æä¾›çš„ cost æ§åˆ¶ NSTimeInterval _time; // è®°å½•æ—¶é—´ï¼Œå¯¹åº” YYMemoryCache æä¾›çš„ age æ§åˆ¶&#125;@end/** YYMemoryCache å†…çš„ä¸€ä¸ªé“¾è¡¨ã€‚ _YYLinkedMap ä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ç±»ï¼Œè€Œä¸”å®ƒä¹Ÿä¸å¯¹å‚æ•°åšæ ¡éªŒã€‚ é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬ä¸åº”è¯¥ä½¿ç”¨è¿™ä¸ªç±»ã€‚ */@interface _YYLinkedMap : NSObject &#123; @package CFMutableDictionaryRef _dic; // ä¸è¦ç›´æ¥è®¾ç½®è¯¥å¯¹è±¡ NSUInteger _totalCost; NSUInteger _totalCount; _YYLinkedMapNode *_head; // MRU, æœ€å¸¸ç”¨èŠ‚ç‚¹ï¼Œä¸è¦ç›´æ¥ä¿®æ”¹å®ƒ _YYLinkedMapNode *_tail; // LRU, æœ€å°‘ç”¨èŠ‚ç‚¹ï¼Œä¸è¦ç›´æ¥ä¿®æ”¹å®ƒ BOOL _releaseOnMainThread; // å¯¹åº” YYMemoryCache çš„ releaseOnMainThread BOOL _releaseAsynchronously; // å¯¹åº” YYMemoryCache çš„ releaseAsynchronously&#125;// é“¾è¡¨æ“ä½œï¼Œçœ‹æ¥å£åç§°åº”è¯¥ä¸éœ€è¦æ³¨é‡Šå§~- (void)insertNodeAtHead:(_YYLinkedMapNode *)node;- (void)bringNodeToHead:(_YYLinkedMapNode *)node;- (void)removeNode:(_YYLinkedMapNode *)node;- (_YYLinkedMapNode *)removeTailNode;- (void)removeAll;@end ä¸ºäº†æ–¹ä¾¿å¤§å®¶é˜…è¯»ï¼Œæˆ‘æ ‡æ³¨äº†å¿…è¦çš„ä¸­æ–‡æ³¨é‡Šã€‚å…¶å®å¯¹æ•°æ®ç»“æ„ä¸ç®—æ³•ä¸é™Œç”Ÿçš„åŒå­¦åº”è¯¥ä¸€çœ¼å°±çœ‹çš„å‡ºæ¥ _YYLinkedMapNode ä¸ _YYLinkedMap è¿™ä¿©è´§çš„æœ¬è´¨ã€‚æ²¡é”™ï¼Œä¸«å°±æ˜¯åŒå‘é“¾è¡¨èŠ‚ç‚¹å’ŒåŒå‘é“¾è¡¨ã€‚ _YYLinkedMapNode ä½œä¸ºåŒå‘é“¾è¡¨èŠ‚ç‚¹ï¼Œé™¤äº†åŸºæœ¬çš„ _prevã€_nextï¼Œè¿˜æœ‰é”®å€¼ç¼“å­˜åŸºæœ¬çš„ _key ä¸ _valueï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ _YYLinkedMapNode ç†è§£ä¸º YYMemoryCache ä¸­çš„ä¸€ä¸ªç¼“å­˜å¯¹è±¡ã€‚ _YYLinkedMap ä½œä¸ºç”± _YYLinkedMapNode èŠ‚ç‚¹ç»„æˆçš„åŒå‘é“¾è¡¨ï¼Œä½¿ç”¨ CFMutableDictionaryRef _dic å­—å…¸å­˜å‚¨ _YYLinkedMapNodeã€‚è¿™æ ·åœ¨ç¡®ä¿ _YYLinkedMapNode è¢«å¼ºå¼•ç”¨çš„åŒæ—¶ï¼Œèƒ½å¤Ÿåˆ©ç”¨å­—å…¸çš„ Hash å¿«é€Ÿå®šä½ç”¨æˆ·è¦è®¿é—®çš„ç¼“å­˜å¯¹è±¡ï¼Œè¿™æ ·æ—¢ç¬¦åˆäº†é”®å€¼ç¼“å­˜çš„æ¦‚å¿µåˆçœå»äº†è‡ªå·±å®ç°çš„éº»çƒ¦ï¼ˆç¬‘ï¼‰ã€‚ å˜›~ æ€»å¾—æ¥è¯´ YYMemoryCache æ˜¯é€šè¿‡ä½¿ç”¨ _YYLinkedMap åŒå‘é“¾è¡¨æ¥æ“ä½œ _YYLinkedMapNode ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹çš„ã€‚ LRU(least-recently-used) ç®—æ³•çš„å®ç°ä¸Šæ–‡æˆ‘ä»¬è®¤æ¸…äº† _YYLinkedMap ä¸ _YYLinkedMapNode æœ¬è´¨ä¸Šå°±æ˜¯åŒå‘é“¾è¡¨å’Œé“¾è¡¨èŠ‚ç‚¹ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•è®²ä¸€ä¸‹ YYMemoryCache æ˜¯å¦‚ä½•åˆ©ç”¨åŒå‘é“¾è¡¨å®ç° LRU(least-recently-used) ç®—æ³•çš„ã€‚ ç¼“å­˜æ›¿æ¢ç­–ç•¥é¦–å…ˆ LRU æ˜¯ç¼“å­˜æ›¿æ¢ç­–ç•¥ï¼ˆCache replacement policiesï¼‰çš„ä¸€ç§ï¼Œè¿˜æœ‰å¾ˆå¤šç¼“å­˜æ›¿æ¢ç­–ç•¥è¯¸å¦‚ï¼š First In First Out (FIFO) Last In First Out (LIFO) Time aware Least Recently Used (TLRU) Most Recently Used (MRU) Pseudo-LRU (PLRU) Random Replacement (RR) Segmented LRU (SLRU) Least-Frequently Used (LFU) Least Frequent Recently Used (LFRU) LFU with Dynamic Aging (LFUDA) Low Inter-reference Recency Set (LIRS) Adaptive Replacement Cache (ARC) Clock with Adaptive Replacement (CAR) Multi Queue (MQ) caching algorithm|Multi Queue (MQ) Pannier: Container-based caching algorithm for compound objects æ˜¯ä¸æ˜¯è¢«å”¬åˆ°äº†ï¼Ÿä¸è¦æ‹…å¿ƒï¼Œæˆ‘è¿™é‡Œä¼šè¡¨è¿°çš„å°½é‡æ˜“æ‡‚ã€‚ ç¼“å­˜å‘½ä¸­ç‡ ä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šç¼“å­˜æ›¿æ¢ç­–ç•¥ï¼Œæˆ–è€…è¯´æè¿™ä¹ˆå¤šåå ‚ç©¶ç«Ÿæ˜¯ä¸ºäº†ä»€ä¹ˆå‘¢ï¼Ÿ ç­”æ¡ˆæ˜¯æé«˜ç¼“å­˜å‘½ä¸­ç‡ï¼Œé‚£ä¹ˆä½•è°“ç¼“å­˜å‘½ä¸­ç‡å‘¢ï¼Ÿ Google ä¸€ä¸‹è‡ªç„¶æ˜¯æœ‰ä¸å°‘è§£é‡Šï¼Œä¸è¿‡å¾ˆå¤šéƒ½æ˜¯ web ç›¸å…³çš„ï¼Œè€Œä¸”ä¸è¯´äººè¯ï¼ˆå¾ˆéš¾ç†è§£ï¼‰ï¼Œæˆ‘ä¸ªäººéå¸¸è®¨åŒå„ç§ä¸è¯´äººè¯çš„â€œé«˜æ·±â€æŠ½è±¡æ¦‚å¿µã€‚ è¿™é‡ŒæŠ–äº†å¥½å‡ æŠ–èƒ†æ‰æ•¢è°ˆä¸€ä¸‹æˆ‘å¯¹äºç¼“å­˜å‘½ä¸­ç‡çš„ç†è§£ï¼ˆé™äº YYCache å’Œ iOS å¼€å‘ï¼‰ã€‚ ç¼“å­˜å‘½ä¸­ = ç”¨æˆ·è¦è®¿é—®çš„ç¼“å­˜å¯¹è±¡åœ¨é«˜é€Ÿç¼“å­˜ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨é«˜é€Ÿç¼“å­˜ä¸­é€šè¿‡ Hash å°†å…¶æ‰¾åˆ°å¹¶è¿”å›ç»™ç”¨æˆ·ã€‚ ç¼“å­˜å‘½ä¸­ç‡ = ç”¨æˆ·è¦è®¿é—®çš„ç¼“å­˜å¯¹è±¡åœ¨é«˜é€Ÿç¼“å­˜ä¸­è¢«æˆ‘ä»¬è®¿é—®åˆ°çš„æ¦‚ç‡ã€‚ æ—¢ç„¶è°ˆåˆ°äº†è‡ªå·±çš„ç†è§£ï¼Œæˆ‘ç´¢æ€§è¯´ä¸ªå¤Ÿã€‚ ç¼“å­˜ä¸¢å¤± = ç”±äºé«˜é€Ÿç¼“å­˜æ•°é‡æœ‰é™ï¼ˆå æ®å†…å­˜ç­‰åŸå› ï¼‰ï¼Œæ‰€ä»¥ç”¨æˆ·è¦è®¿é—®çš„ç¼“å­˜å¯¹è±¡å¾ˆæœ‰å¯èƒ½è¢«æˆ‘ä»¬ä»æœ‰é™çš„é«˜é€Ÿç¼“å­˜ä¸­æ·˜æ±°æ‰äº†ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå°†å…¶å­˜å‚¨äºä½é€Ÿçš„ç£ç›˜ç¼“å­˜ä¸­ï¼ˆå¦‚æœç£ç›˜ç¼“å­˜è¿˜æœ‰èµ„æºçš„è¯ï¼‰ï¼Œé‚£ä¹ˆå°±è¦ä»ç£ç›˜ç¼“å­˜ä¸­è·å–è¯¥ç¼“å­˜å¯¹è±¡ä»¥è¿”å›ç»™ç”¨æˆ·ï¼Œè¿™ç§æƒ…å†µæˆ‘ç†è§£ä¸ºï¼ˆé«˜é€Ÿï¼‰ç¼“å­˜æœªå‘½ä¸­ï¼Œå³ç¼“å­˜ä¸¢å¤±ï¼ˆå¹¶ä¸æ˜¯çœŸçš„è¢«æˆ‘ä»¬ä¸¢æ‰äº†ï¼Œä½†è‚¯å®šæ˜¯è¢«æˆ‘ä»¬ä»é«˜é€Ÿç¼“å­˜æ·˜æ±°æ‰äº†ï¼‰ã€‚ ç¼“å­˜å‘½ä¸­æ˜¯ cache-hitï¼Œé‚£ä¹ˆå¦‚æœä½ ç©æ¸¸æˆï¼Œå¯ä»¥ç†è§£ä¸ºè¿™æ¬¡ hit miss äº†ï¼ˆç¬‘ï¼Œæœ‰äººæ‰¾æˆ‘å¼€é»‘å—ï¼‰ã€‚ LRUé¦–å…ˆæ¥è®²ä¸€ä¸‹ LRU çš„æ¦‚å¿µè®©å¤§å®¶æœ‰ä¸€ä¸ªåŸºæœ¬çš„è®¤è¯†ã€‚LRU(least-recently-used) ç¿»è¯‘è¿‡æ¥æ˜¯â€œæœ€è¿‘æœ€å°‘ä½¿ç”¨â€ï¼Œé¡¾åæ€ä¹‰è¿™ç§ç¼“å­˜æ›¿æ¢ç­–ç•¥æ˜¯åŸºäºç”¨æˆ·æœ€è¿‘æœ€å°‘è®¿é—®è¿‡çš„ç¼“å­˜å¯¹è±¡è€Œå»ºç«‹ã€‚ æˆ‘è®¤ä¸º LRU ç¼“å­˜æ›¿æ¢ç­–ç•¥çš„æ ¸å¿ƒæ€æƒ³åœ¨äºï¼šLRU è®¤ä¸ºç”¨æˆ·æœ€æ–°ä½¿ç”¨ï¼ˆè®¿é—®ï¼‰è¿‡çš„ç¼“å­˜å¯¹è±¡ä¸ºé«˜é¢‘ç¼“å­˜å¯¹è±¡ï¼Œå³ç”¨æˆ·å¾ˆå¯èƒ½è¿˜ä¼šå†æ¬¡ä½¿ç”¨ï¼ˆè®¿é—®ï¼‰è¯¥ç¼“å­˜å¯¹è±¡ï¼›è€Œåä¹‹ï¼Œç”¨æˆ·å¾ˆä¹…ä¹‹å‰ä½¿ç”¨ï¼ˆè®¿é—®ï¼‰è¿‡çš„ç¼“å­˜å¯¹è±¡ï¼ˆæœŸé—´ä¸€ç›´æ²¡æœ‰å†æ¬¡è®¿é—®ï¼‰ä¸ºä½é¢‘ç¼“å­˜å¯¹è±¡ï¼Œå³ç”¨æˆ·å¾ˆå¯èƒ½ä¸ä¼šå†å»ä½¿ç”¨ï¼ˆè®¿é—®ï¼‰è¯¥ç¼“å­˜å¯¹è±¡ï¼Œé€šå¸¸åœ¨èµ„æºä¸è¶³æ—¶ä¼šå…ˆå»é‡Šæ”¾ä½é¢‘ç¼“å­˜å¯¹è±¡ã€‚ _YYLinkedMapNode ä¸ _YYLinkedMap å®ç° LRUYYCache ä½œè€…é€šè¿‡ _YYLinkedMapNode ä¸ _YYLinkedMap åŒå‘é“¾è¡¨å®ç° LRU ç¼“å­˜æ›¿æ¢ç­–ç•¥çš„æ€è·¯å…¶å®å¾ˆç®€æ·æ¸…æ™°ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥çœ‹ã€‚ åŒå‘é“¾è¡¨ä¸­æœ‰å¤´ç»“ç‚¹å’Œå°¾èŠ‚ç‚¹ï¼š å¤´ç»“ç‚¹ = é“¾è¡¨ä¸­ç”¨æˆ·æœ€è¿‘ä¸€æ¬¡ä½¿ç”¨ï¼ˆè®¿é—®ï¼‰çš„ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹ï¼ŒMRUã€‚ å°¾èŠ‚ç‚¹ = é“¾è¡¨ä¸­ç”¨æˆ·å·²ç»å¾ˆä¹…æ²¡æœ‰å†æ¬¡ä½¿ç”¨ï¼ˆè®¿é—®ï¼‰çš„ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹ï¼ŒLRUã€‚ å¦‚ä½•è®©å¤´ç»“ç‚¹å’Œå°¾èŠ‚ç‚¹æŒ‡å‘æˆ‘ä»¬æƒ³æŒ‡å‘çš„ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹ï¼Ÿæˆ‘ä»¬ç»“åˆä»£ç æ¥çœ‹ï¼š åœ¨ç”¨æˆ·ä½¿ç”¨ï¼ˆè®¿é—®ï¼‰æ—¶æ›´æ–°ç¼“å­˜èŠ‚ç‚¹ä¿¡æ¯ï¼Œå¹¶å°†å…¶ç§»åŠ¨è‡³åŒå‘é“¾è¡¨å¤´ç»“ç‚¹ã€‚ 123456789101112131415- (id)objectForKey:(id)key &#123; // åˆ¤æ–­å…¥å‚ if (!key) return nil; pthread_mutex_lock(&amp;_lock); // æ‰¾åˆ°å¯¹åº”ç¼“å­˜èŠ‚ç‚¹ _YYLinkedMapNode *node = CFDictionaryGetValue(_lru-&gt;_dic, (__bridge const void *)(key)); if (node) &#123; // æ›´æ–°ç¼“å­˜èŠ‚ç‚¹æ—¶é—´ï¼Œå¹¶å°†å…¶ç§»åŠ¨è‡³åŒå‘é“¾è¡¨å¤´ç»“ç‚¹ node-&gt;_time = CACurrentMediaTime(); [_lru bringNodeToHead:node]; &#125; pthread_mutex_unlock(&amp;_lock); // è¿”å›æ‰¾åˆ°çš„ç¼“å­˜èŠ‚ç‚¹ value return node ? node-&gt;_value : nil;&#125; åœ¨ç”¨æˆ·è®¾ç½®ç¼“å­˜å¯¹è±¡æ—¶ï¼Œåˆ¤æ–­å…¥å‚ key å¯¹åº”çš„ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ï¼Ÿå­˜åœ¨åˆ™æ›´æ–°ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹å¹¶å°†èŠ‚ç‚¹ç§»åŠ¨è‡³é“¾è¡¨å¤´ç»“ç‚¹ï¼›ä¸å­˜åœ¨åˆ™æ ¹æ®å…¥å‚ç”Ÿæˆæ–°çš„ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹å¹¶æ’å…¥é“¾è¡¨è¡¨å¤´ã€‚ 12345678910111213141516171819202122232425262728- (void)setObject:(id)object forKey:(id)key withCost:(NSUInteger)cost &#123; // åˆ¤æ–­å…¥å‚ï¼Œçœç•¥ ... pthread_mutex_lock(&amp;_lock); // åˆ¤æ–­å…¥å‚ key å¯¹åº”çš„ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ _YYLinkedMapNode *node = CFDictionaryGetValue(_lru-&gt;_dic, (__bridge const void *)(key)); NSTimeInterval now = CACurrentMediaTime(); if (node) &#123; // å­˜åœ¨åˆ™æ›´æ–°ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹å¹¶å°†èŠ‚ç‚¹ç§»åŠ¨è‡³é“¾è¡¨å¤´ç»“ç‚¹ _lru-&gt;_totalCost -= node-&gt;_cost; _lru-&gt;_totalCost += cost; node-&gt;_cost = cost; node-&gt;_time = now; node-&gt;_value = object; [_lru bringNodeToHead:node]; &#125; else &#123; // ä¸å­˜åœ¨åˆ™æ ¹æ®å…¥å‚ç”Ÿæˆæ–°çš„ç¼“å­˜å¯¹è±¡èŠ‚ç‚¹å¹¶æ’å…¥é“¾è¡¨è¡¨å¤´ node = [_YYLinkedMapNode new]; node-&gt;_cost = cost; node-&gt;_time = now; node-&gt;_key = key; node-&gt;_value = object; [_lru insertNodeAtHead:node]; &#125; // åˆ¤æ–­æ’å…¥ã€æ›´æ–°èŠ‚ç‚¹ä¹‹åæ˜¯å¦è¶…è¿‡äº†é™åˆ¶ costã€countï¼Œå¦‚æœè¶…è¿‡åˆ™ trimï¼Œçœç•¥ ... pthread_mutex_unlock(&amp;_lock);&#125; åœ¨èµ„æºä¸è¶³æ—¶ï¼Œä»åŒçº¿é“¾è¡¨çš„å°¾èŠ‚ç‚¹ï¼ˆLRUï¼‰å¼€å§‹æ¸…ç†ç¼“å­˜ï¼Œé‡Šæ”¾èµ„æºã€‚ 123456789101112131415161718192021222324252627282930313233// è¿™é‡Œæ‹¿ count èµ„æºä¸¾ä¾‹ï¼Œcostã€age è‡ªå·±ä¸¾ä¸€åä¸‰- (void)_trimToCount:(NSUInteger)countLimit &#123; // åˆ¤æ–­ countLimit ä¸º 0ï¼Œåˆ™å…¨éƒ¨æ¸…ç©ºç¼“å­˜ï¼Œçœç•¥ // åˆ¤æ–­ _lru-&gt;_totalCount &lt;= countLimitï¼Œæ²¡æœ‰è¶…å‡ºèµ„æºé™åˆ¶åˆ™ä¸ä½œå¤„ç†ï¼Œçœç•¥ ... NSMutableArray *holder = [NSMutableArray new]; while (!finish) &#123; if (pthread_mutex_trylock(&amp;_lock) == 0) &#123; if (_lru-&gt;_totalCount &gt; countLimit) &#123; // ä»åŒçº¿é“¾è¡¨çš„å°¾èŠ‚ç‚¹ï¼ˆLRUï¼‰å¼€å§‹æ¸…ç†ç¼“å­˜ï¼Œé‡Šæ”¾èµ„æº _YYLinkedMapNode *node = [_lru removeTailNode]; if (node) [holder addObject:node]; &#125; else &#123; finish = YES; &#125; pthread_mutex_unlock(&amp;_lock); &#125; else &#123; // ä½¿ç”¨ usleep ä»¥å¾®ç§’ä¸ºå•ä½æŒ‚èµ·çº¿ç¨‹ï¼Œåœ¨çŸ­æ—¶é—´é—´éš”æŒ‚èµ·çº¿ç¨‹ // å¯¹æ¯” sleep ç”¨ usleep èƒ½æ›´å¥½çš„åˆ©ç”¨ CPU æ—¶é—´ usleep(10 * 1000); //10 ms &#125; &#125; // åˆ¤æ–­æ˜¯å¦éœ€è¦åœ¨ä¸»çº¿ç¨‹é‡Šæ”¾ï¼Œé‡‡å–é‡Šæ”¾ç¼“å­˜å¯¹è±¡æ“ä½œ if (holder.count) &#123; dispatch_queue_t queue = _lru-&gt;_releaseOnMainThread ? dispatch_get_main_queue() : YYMemoryCacheGetReleaseQueue(); dispatch_async(queue, ^&#123; // å¼‚æ­¥é‡Šæ”¾ï¼Œæˆ‘ä»¬å•ç‹¬æ‹å‡ºæ¥è®² [holder count]; // release in queue &#125;); &#125;&#125; å˜›~ æ˜¯ä¸æ˜¯æ„Ÿè§‰æ•²ç®€å•ï¼Ÿä¸Šé¢ä»£ç å»æ‰äº†å¯èƒ½ä¼šåˆ†æ•£å¤§å®¶æ³¨æ„åŠ›çš„ä»£ç ï¼Œæˆ‘ä»¬è¿™é‡Œä»…ä»…è®¨è®º LRU çš„å®ç°ï¼Œå…¶ä½™éƒ¨åˆ†çš„å…·ä½“å®ç°æºç ä¹Ÿéå¸¸ç®€å•ï¼Œæˆ‘è§‰å¾—æ²¡å¿…è¦è´´å‡ºæ¥å•ç‹¬è®²è§£ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±å» YYCache ä¸‹è½½æºç æŸ¥é˜…ã€‚ å¼‚æ­¥é‡Šæ”¾æŠ€å·§å…³äºä¸Šé¢çš„å¼‚æ­¥é‡Šæ”¾ç¼“å­˜å¯¹è±¡çš„ä»£ç ï¼Œæˆ‘è§‰å¾—è¿˜æ˜¯æœ‰å¿…è¦å•ç‹¬æ‹å‡ºæ¥è®²ä¸€ä¸‹çš„ï¼š 12345dispatch_queue_t queue = _lru-&gt;_releaseOnMainThread ? dispatch_get_main_queue() : YYMemoryCacheGetReleaseQueue();dispatch_async(queue, ^&#123; // å¼‚æ­¥é‡Šæ”¾ï¼Œæˆ‘ä»¬å•ç‹¬æ‹å‡ºæ¥è®² [holder count]; // release in queue&#125;); è¿™ä¸ªæŠ€å·§ ibireme åœ¨ä»–çš„å¦ä¸€ç¯‡æ–‡ç«  iOS ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§ ä¸­æœ‰æåŠï¼š Note: å¯¹è±¡çš„é”€æ¯è™½ç„¶æ¶ˆè€—èµ„æºä¸å¤šï¼Œä½†ç´¯ç§¯èµ·æ¥ä¹Ÿæ˜¯ä¸å®¹å¿½è§†çš„ã€‚é€šå¸¸å½“å®¹å™¨ç±»æŒæœ‰å¤§é‡å¯¹è±¡æ—¶ï¼Œå…¶é”€æ¯æ—¶çš„èµ„æºæ¶ˆè€—å°±éå¸¸æ˜æ˜¾ã€‚åŒæ ·çš„ï¼Œå¦‚æœå¯¹è±¡å¯ä»¥æ”¾åˆ°åå°çº¿ç¨‹å»é‡Šæ”¾ï¼Œé‚£å°±æŒªåˆ°åå°çº¿ç¨‹å»ã€‚è¿™é‡Œæœ‰ä¸ªå° Tipï¼šæŠŠå¯¹è±¡æ•è·åˆ° block ä¸­ï¼Œç„¶åæ‰”åˆ°åå°é˜Ÿåˆ—å»éšä¾¿å‘é€ä¸ªæ¶ˆæ¯ä»¥é¿å…ç¼–è¯‘å™¨è­¦å‘Šï¼Œå°±å¯ä»¥è®©å¯¹è±¡åœ¨åå°çº¿ç¨‹é”€æ¯äº†ã€‚ è€Œä¸Šé¢ä»£ç ä¸­çš„ YYMemoryCacheGetReleaseQueue è¿™ä¸ªé˜Ÿåˆ—æºç ä¸ºï¼š 1234// é™æ€å†…è” dispatch_queue_tstatic inline dispatch_queue_t YYMemoryCacheGetReleaseQueue() &#123; return dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_LOW, 0);&#125; åœ¨æºç ä¸­å¯ä»¥çœ‹åˆ° YYMemoryCacheGetReleaseQueue æ˜¯ä¸€ä¸ªä½ä¼˜å…ˆçº§ DISPATCH_QUEUE_PRIORITY_LOW é˜Ÿåˆ—ï¼ŒçŒœæµ‹è¿™æ ·è®¾è®¡çš„åŸå› æ˜¯å¯ä»¥è®© iOS åœ¨ç³»ç»Ÿç›¸å¯¹ç©ºé—²æ—¶å†æ¥å¼‚æ­¥é‡Šæ”¾ç¼“å­˜å¯¹è±¡ã€‚ YYDiskCache ç»†èŠ‚å‰–æ YYDiskCache æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ç£ç›˜ç¼“å­˜ï¼Œç”¨äºå­˜å‚¨ç”± SQLite å’Œæ–‡ä»¶ç³»ç»Ÿæ”¯æŒçš„é”®å€¼å¯¹ï¼ˆç±»ä¼¼äº NSURLCache çš„ç£ç›˜ç¼“å­˜ï¼‰ã€‚ YYDiskCache å…·æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š å®ƒä½¿ç”¨ LRU(least-recently-used) æ¥åˆ é™¤å¯¹è±¡ã€‚ æ”¯æŒæŒ‰ costï¼Œcount å’Œ age è¿›è¡Œæ§åˆ¶ã€‚ å®ƒå¯ä»¥è¢«é…ç½®ä¸ºå½“æ²¡æœ‰å¯ç”¨çš„ç£ç›˜ç©ºé—´æ—¶è‡ªåŠ¨é©±é€ç¼“å­˜å¯¹è±¡ã€‚ å®ƒå¯ä»¥è‡ªåŠ¨æŠ‰æ‹©æ¯ä¸ªç¼“å­˜å¯¹è±¡çš„å­˜å‚¨ç±»å‹ï¼ˆsqlite/fileï¼‰ä»¥ä¾¿æä¾›æ›´å¥½çš„æ€§èƒ½è¡¨ç°ã€‚ Note: æ‚¨å¯ä»¥ç¼–è¯‘æœ€æ–°ç‰ˆæœ¬çš„ sqlite å¹¶å¿½ç•¥ iOS ç³»ç»Ÿä¸­çš„ libsqlite3.dylib æ¥è·å¾— 2xã€œ4x çš„é€Ÿåº¦æå‡ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748@interface YYDiskCache : NSObject#pragma mark - Attribute@property (nullable, copy) NSString *name; // ç¼“å­˜åç§°ï¼Œé»˜è®¤ä¸º nil@property (readonly) NSString *path; // ç¼“å­˜è·¯å¾„@property (readonly) NSUInteger inlineThreshold; // é˜ˆå€¼ï¼Œå¤§äºé˜ˆå€¼åˆ™å­˜å‚¨ç±»å‹ä¸º fileï¼›å¦åˆ™å­˜å‚¨ç±»å‹ä¸º sqlite@property (nullable, copy) NSData *(^customArchiveBlock)(id object); // ç”¨æ¥æ›¿æ¢ NSKeyedArchiverï¼Œä½ å¯ä»¥ä½¿ç”¨è¯¥ä»£ç å—ä»¥æ”¯æŒæ²¡æœ‰ conform `NSCoding` åè®®çš„å¯¹è±¡@property (nullable, copy) id (^customUnarchiveBlock)(NSData *data); // ç”¨æ¥æ›¿æ¢ NSKeyedUnarchiverï¼Œä½ å¯ä»¥ä½¿ç”¨è¯¥ä»£ç å—ä»¥æ”¯æŒæ²¡æœ‰ conform `NSCoding` åè®®çš„å¯¹è±¡@property (nullable, copy) NSString *(^customFileNameBlock)(NSString *key); // å½“ä¸€ä¸ªå¯¹è±¡å°†ä»¥ file çš„å½¢å¼ä¿å­˜æ—¶ï¼Œè¯¥ä»£ç å—ç”¨æ¥ç”ŸæˆæŒ‡å®šæ–‡ä»¶åã€‚å¦‚æœä¸º nilï¼Œåˆ™é»˜è®¤ä½¿ç”¨ md5(key) ä½œä¸ºæ–‡ä»¶å#pragma mark - Limit@property NSUInteger countLimit; // ç¼“å­˜å¯¹è±¡æ•°é‡é™åˆ¶ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œè¶…è¿‡é™åˆ¶åˆ™ä¼šåœ¨åå°é€å‡ºä¸€äº›å¯¹è±¡ä»¥æ»¡è¶³é™åˆ¶@property NSUInteger costLimit; // ç¼“å­˜å¼€é”€æ•°é‡é™åˆ¶ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œè¶…è¿‡é™åˆ¶åˆ™ä¼šåœ¨åå°é€å‡ºä¸€äº›å¯¹è±¡ä»¥æ»¡è¶³é™åˆ¶@property NSTimeInterval ageLimit; // ç¼“å­˜æ—¶é—´é™åˆ¶ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œè¶…è¿‡é™åˆ¶åˆ™ä¼šåœ¨åå°é€å‡ºä¸€äº›å¯¹è±¡ä»¥æ»¡è¶³é™åˆ¶@property NSUInteger freeDiskSpaceLimit; // ç¼“å­˜åº”è¯¥ä¿ç•™çš„æœ€å°å¯ç”¨ç£ç›˜ç©ºé—´ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œè¶…è¿‡é™åˆ¶åˆ™ä¼šåœ¨åå°é€å‡ºä¸€äº›å¯¹è±¡ä»¥æ»¡è¶³é™åˆ¶@property NSTimeInterval autoTrimInterval; // ç¼“å­˜è‡ªåŠ¨æ¸…ç†æ—¶é—´é—´éš”ï¼Œé»˜è®¤ 60s@property BOOL errorLogsEnabled; // æ˜¯å¦å¼€å¯é”™è¯¯æ—¥å¿—#pragma mark - Initializer- (nullable instancetype)initWithPath:(NSString *)path inlineThreshold:(NSUInteger)threshold NS_DESIGNATED_INITIALIZER;- (BOOL)containsObjectForKey:(NSString *)key;- (nullable id&lt;NSCoding&gt;)objectForKey:(NSString *)key;- (void)setObject:(nullable id&lt;NSCoding&gt;)object forKey:(NSString *)key;- (void)removeObjectForKey:(NSString *)key;- (void)removeAllObjects; - (NSInteger)totalCount;- (NSInteger)totalCost;#pragma mark - Trim- (void)trimToCount:(NSUInteger)count;- (void)trimToCost:(NSUInteger)cost;- (void)trimToAge:(NSTimeInterval)age;#pragma mark - Extended Data+ (nullable NSData *)getExtendedDataFromObject:(id)object;+ (void)setExtendedData:(nullable NSData *)extendedData toObject:(id)object;@end YYDiskCache ç»“æ„ä¸ YYMemoryCache ç±»ä¼¼ï¼Œç”±äºå¾ˆå¤šæ¥å£éƒ½æ˜¯åŸºäºåŸºæœ¬çš„æ¥å£åšäº†æ‰©å±•æ‰€å¾—ï¼Œè¿™é‡Œè´´çš„ä»£ç çœç•¥äº†ä¸€äº›æ¥å£ã€‚ä»£ç è¿˜æ˜¯ä¸€å¦‚æ—¢å¾€çš„å¹²å‡€ç®€æ´ï¼Œç›¸ä¿¡å„ä½éƒ½èƒ½çœ‹æ‡‚ã€‚ YYDiskCache æ˜¯åŸºäº sqlite å’Œ file æ¥åšçš„ç£ç›˜ç¼“å­˜ï¼Œæˆ‘ä»¬çš„ç¼“å­˜å¯¹è±¡å¯ä»¥è‡ªç”±çš„é€‰æ‹©å­˜å‚¨ç±»å‹ï¼Œä¸‹é¢ç®€å•å¯¹æ¯”ä¸€ä¸‹ï¼š sqlite: å¯¹äºå°æ•°æ®ï¼ˆä¾‹å¦‚ NSNumberï¼‰çš„å­˜å–æ•ˆç‡æ˜æ˜¾é«˜äº fileã€‚ file: å¯¹äºè¾ƒå¤§æ•°æ®ï¼ˆä¾‹å¦‚é«˜è´¨é‡å›¾ç‰‡ï¼‰çš„å­˜å–æ•ˆç‡ä¼˜äº sqliteã€‚ æ‰€ä»¥ YYDiskCache ä½¿ç”¨ä¸¤è€…é…åˆï¼Œçµæ´»çš„å­˜å‚¨ä»¥æé«˜æ€§èƒ½ã€‚ NSMapTableNSMapTable æ˜¯ç±»ä¼¼äºå­—å…¸çš„é›†åˆï¼Œä½†å…·æœ‰æ›´å¹¿æ³›çš„å¯ç”¨å†…å­˜è¯­ä¹‰ã€‚NSMapTable æ˜¯ iOS6 ä¹‹åå¼•å…¥çš„ç±»ï¼Œå®ƒåŸºäº NSDictionary å»ºæ¨¡ï¼Œä½†æ˜¯å…·æœ‰ä»¥ä¸‹å·®å¼‚ï¼š é”®/å€¼å¯ä»¥é€‰æ‹© â€œweaklyâ€ æŒæœ‰ï¼Œä»¥ä¾¿äºåœ¨å›æ”¶å…¶ä¸­ä¸€ä¸ªå¯¹è±¡æ—¶åˆ é™¤å¯¹åº”æ¡ç›®ã€‚ å®ƒå¯ä»¥åŒ…å«ä»»æ„æŒ‡é’ˆï¼ˆå…¶å†…å®¹ä¸è¢«çº¦æŸä¸ºå¯¹è±¡ï¼‰ã€‚ æ‚¨å¯ä»¥å°† NSMapTable å®ä¾‹é…ç½®ä¸ºå¯¹ä»»æ„æŒ‡é’ˆè¿›è¡Œæ“ä½œï¼Œè€Œä¸ä»…ä»…æ˜¯å¯¹è±¡ã€‚ Note: é…ç½®æ˜ å°„è¡¨æ—¶ï¼Œè¯·æ³¨æ„ï¼Œåªæœ‰ NSMapTableOptions ä¸­åˆ—å‡ºçš„é€‰é¡¹æ‰èƒ½ä¿è¯å…¶ä½™çš„ API èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼ŒåŒ…æ‹¬å¤åˆ¶ï¼Œå½’æ¡£å’Œå¿«é€Ÿæšä¸¾ã€‚ è™½ç„¶å…¶ä»– NSPointerFunctions é€‰é¡¹ç”¨äºæŸäº›é…ç½®ï¼Œä¾‹å¦‚æŒæœ‰ä»»æ„æŒ‡é’ˆï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰é€‰é¡¹çš„ç»„åˆéƒ½æœ‰æ•ˆã€‚ä½¿ç”¨æŸäº›ç»„åˆï¼ŒNSMapTableOptions å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œï¼Œç”šè‡³å¯èƒ½æ— æ³•æ­£ç¡®åˆå§‹åŒ–ã€‚ æ›´å¤šä¿¡æ¯è¯¦è§ NSMapTable å®˜æ–¹æ–‡æ¡£ã€‚ éœ€è¦ç‰¹æ®Šè¯´æ˜çš„æ˜¯ï¼ŒYYDiskCache å†…éƒ¨æ˜¯åŸºäºä¸€ä¸ªå•ä¾‹ NSMapTable ç®¡ç†çš„ï¼Œè¿™ç‚¹æœ‰åˆ«äº YYMemoryCacheã€‚ 123456789101112131415161718192021222324252627static NSMapTable *_globalInstances; // å¼•ç”¨ç®¡ç†æ‰€æœ‰çš„ YYDiskCache å®ä¾‹static dispatch_semaphore_t _globalInstancesLock; // YYDiskCache ä½¿ç”¨ dispatch_semaphore ä¿éšœ NSMapTable çº¿ç¨‹å®‰å…¨static void _YYDiskCacheInitGlobal() &#123; static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^&#123; _globalInstancesLock = dispatch_semaphore_create(1); _globalInstances = [[NSMapTable alloc] initWithKeyOptions:NSPointerFunctionsStrongMemory valueOptions:NSPointerFunctionsWeakMemory capacity:0]; &#125;);&#125;static YYDiskCache *_YYDiskCacheGetGlobal(NSString *path) &#123; if (path.length == 0) return nil; _YYDiskCacheInitGlobal(); dispatch_semaphore_wait(_globalInstancesLock, DISPATCH_TIME_FOREVER); id cache = [_globalInstances objectForKey:path]; dispatch_semaphore_signal(_globalInstancesLock); return cache;&#125;static void _YYDiskCacheSetGlobal(YYDiskCache *cache) &#123; if (cache.path.length == 0) return; _YYDiskCacheInitGlobal(); dispatch_semaphore_wait(_globalInstancesLock, DISPATCH_TIME_FOREVER); [_globalInstances setObject:cache forKey:cache.path]; dispatch_semaphore_signal(_globalInstancesLock);&#125; æ¯å½“ä¸€ä¸ª YYDiskCache è¢«åˆå§‹åŒ–æ—¶ï¼Œå…¶å®ä¼šå…ˆåˆ° NSMapTable ä¸­è·å–å¯¹åº” path çš„ YYDiskCache å®ä¾‹ï¼Œå¦‚æœè·å–ä¸åˆ°æ‰ä¼šå»çœŸæ­£çš„åˆå§‹åŒ–ä¸€ä¸ª YYDiskCache å®ä¾‹ï¼Œå¹¶ä¸”å°†å…¶å¼•ç”¨åœ¨ NSMapTable ä¸­ï¼Œè¿™æ ·åšä¹Ÿä¼šæå‡ä¸å°‘æ€§èƒ½ã€‚ 1234567891011121314151617181920212223242526- (instancetype)initWithPath:(NSString *)path inlineThreshold:(NSUInteger)threshold &#123; // åˆ¤æ–­æ˜¯å¦å¯ä»¥æˆåŠŸåˆå§‹åŒ–ï¼Œçœç•¥ ... // å…ˆä» NSMapTable å•ä¾‹ä¸­æ ¹æ® path è·å– YYDiskCache å®ä¾‹ï¼Œå¦‚æœè·å–åˆ°å°±ç›´æ¥è¿”å›è¯¥å®ä¾‹ YYDiskCache *globalCache = _YYDiskCacheGetGlobal(path); if (globalCache) return globalCache; // æ²¡æœ‰è·å–åˆ°åˆ™åˆå§‹åŒ–ä¸€ä¸ª YYDiskCache å®ä¾‹ // è¦æƒ³åˆå§‹åŒ–ä¸€ä¸ª YYDiskCache é¦–å…ˆè¦åˆå§‹åŒ–ä¸€ä¸ª YYKVStorage YYKVStorage *kv = [[YYKVStorage alloc] initWithPath:path type:type]; if (!kv) return nil; // æ ¹æ®åˆšæ‰å¾—åˆ°çš„ kv å’Œ path å…¥å‚åˆå§‹åŒ–ä¸€ä¸ª YYDiskCache å®ä¾‹ï¼Œä»£ç å¤ªé•¿çœç•¥ ... // å¼€å¯é€’å½’æ¸…ç†ï¼Œä¼šæ ¹æ® _autoTrimInterval å¯¹ YYDiskCache trim [self _trimRecursively]; // å‘ NSMapTable å•ä¾‹æ³¨å†Œæ–°ç”Ÿæˆçš„ YYDiskCache å®ä¾‹ _YYDiskCacheSetGlobal(self); // App ç”Ÿå‘½å‘¨æœŸé€šçŸ¥ç›¸å…³ä»£ç ï¼Œçœç•¥ ... return self;&#125; æˆ‘åœ¨ YYCache è®¾è®¡æ€è·¯ ä¸­æ‰¾åˆ°äº†ä½œè€…ä½¿ç”¨ dispatch_semaphore ä½œä¸º YYDiskCache é”çš„åŸå› ï¼š dispatch_semaphore æ˜¯ä¿¡å·é‡ï¼Œä½†å½“ä¿¡å·æ€»é‡è®¾ä¸º 1 æ—¶ä¹Ÿå¯ä»¥å½“ä½œé”æ¥ã€‚åœ¨æ²¡æœ‰ç­‰å¾…æƒ…å†µå‡ºç°æ—¶ï¼Œå®ƒçš„æ€§èƒ½æ¯” pthread_mutex è¿˜è¦é«˜ï¼Œä½†ä¸€æ—¦æœ‰ç­‰å¾…æƒ…å†µå‡ºç°æ—¶ï¼Œæ€§èƒ½å°±ä¼šä¸‹é™è®¸å¤šã€‚ç›¸å¯¹äº OSSpinLock æ¥è¯´ï¼Œå®ƒçš„ä¼˜åŠ¿åœ¨äºç­‰å¾…æ—¶ä¸ä¼šæ¶ˆè€— CPU èµ„æºã€‚å¯¹ç£ç›˜ç¼“å­˜æ¥è¯´ï¼Œå®ƒæ¯”è¾ƒåˆé€‚ã€‚ YYKVStorageItem ä¸ YYKVStorageåˆšæ‰åœ¨ YYDiskCache çš„åˆå§‹åŒ–æºç ä¸­ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°ä¸€ä¸ªç±» YYKVStorageã€‚ä¸ YYMemoryCache ç›¸å¯¹åº”çš„ï¼ŒYYDiskCache ä¹Ÿä¸ä¼šç›´æ¥æ“ä½œç¼“å­˜å¯¹è±¡ï¼ˆsqlite/fileï¼‰ï¼Œè€Œæ˜¯é€šè¿‡ YYKVStorage æ¥é—´æ¥çš„æ“ä½œç¼“å­˜å¯¹è±¡ã€‚ ä»è¿™ä¸€ç‚¹ä¸Šä¸éš¾å‘ç°ï¼ŒYYKVStorage ç­‰ä»·äº YYMemoryCache ä¸­çš„åŒå‘é“¾è¡¨ _YYLinkedMapï¼Œè€Œå¯¹åº”äº _YYLinkedMap ä¸­çš„èŠ‚ç‚¹ _YYLinkedMapNodeï¼ŒYYKVStorage ä¸­ä¹Ÿæœ‰ä¸€ä¸ªç±» YYKVStorageItem å……å½“ç€ä¸ç¼“å­˜å¯¹è±¡ä¸€å¯¹ä¸€çš„è§’è‰²ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051// YYKVStorageItem æ˜¯ YYKVStorage ä¸­ç”¨æ¥å­˜å‚¨é”®å€¼å¯¹å’Œå…ƒæ•°æ®çš„ç±»// é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªç±»@interface YYKVStorageItem : NSObject@property (nonatomic, strong) NSString *key; ///&lt; key@property (nonatomic, strong) NSData *value; ///&lt; value@property (nullable, nonatomic, strong) NSString *filename; ///&lt; filename (nil if inline)@property (nonatomic) int size; ///&lt; value&#x27;s size in bytes@property (nonatomic) int modTime; ///&lt; modification unix timestamp@property (nonatomic) int accessTime; ///&lt; last access unix timestamp@property (nullable, nonatomic, strong) NSData *extendedData; ///&lt; extended data (nil if no extended data)@end/** YYKVStorage æ˜¯åŸºäº sqlite å’Œæ–‡ä»¶ç³»ç»Ÿçš„é”®å€¼å­˜å‚¨ã€‚ é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªç±»ã€‚ @warning è¿™ä¸ªç±»çš„å®ä¾‹æ˜¯ *é* çº¿ç¨‹å®‰å…¨çš„ï¼Œä½ éœ€è¦ç¡®ä¿ åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è®¿é—®è¯¥å®ä¾‹ã€‚å¦‚æœä½ çœŸçš„ éœ€è¦åœ¨å¤šçº¿ç¨‹ä¸­å¤„ç†å¤§é‡çš„æ•°æ®ï¼Œåº”è¯¥åˆ†å‰²æ•°æ® åˆ°å¤šä¸ª KVStorage å®ä¾‹ï¼ˆåˆ†ç‰‡ï¼‰ã€‚ */@interface YYKVStorage : NSObject#pragma mark - Attribute@property (nonatomic, readonly) NSString *path; /// storage è·¯å¾„@property (nonatomic, readonly) YYKVStorageType type; /// storage ç±»å‹@property (nonatomic) BOOL errorLogsEnabled; /// æ˜¯å¦å¼€å¯é”™è¯¯æ—¥å¿—#pragma mark - Initializer- (nullable instancetype)initWithPath:(NSString *)path type:(YYKVStorageType)type NS_DESIGNATED_INITIALIZER;#pragma mark - Save Items- (BOOL)saveItem:(YYKVStorageItem *)item;...#pragma mark - Remove Items- (BOOL)removeItemForKey:(NSString *)key;...#pragma mark - Get Items- (nullable YYKVStorageItem *)getItemForKey:(NSString *)key;...#pragma mark - Get Storage Status- (BOOL)itemExistsForKey:(NSString *)key;- (int)getItemsCount;- (int)getItemsSize;@end ä»£ç ç¾å“­äº†æœ‰æœ¨æœ‰ï¼ï¼Ÿè¿™ç§ä»£ç æ ¹æœ¬ä¸éœ€è¦ç¿»è¯‘ï¼Œæˆ‘è§‰å¾—ç›¸æ¯”äºé€è¡Œçš„ç¿»è¯‘ï¼Œç›´æ¥çœ‹ä»£ç æ›´èˆ’æœã€‚è¿™é‡Œæˆ‘ä»¬åªéœ€è¦çœ‹ä¸€ä¸‹ YYKVStorageType è¿™ä¸ªæšä¸¾ï¼Œä»–å†³å®šç€ YYKVStorage çš„å­˜å‚¨ç±»å‹ã€‚ YYKVStorageType12345678910111213/** å­˜å‚¨ç±»å‹ï¼ŒæŒ‡ç¤ºâ€œYYKVStorageItem.valueâ€å­˜å‚¨åœ¨å“ªé‡Œã€‚ @discussion é€šå¸¸ï¼Œå°†æ•°æ®å†™å…¥ sqlite æ¯”å¤–éƒ¨æ–‡ä»¶æ›´å¿«ï¼Œä½†æ˜¯ è¯»å–æ€§èƒ½å–å†³äºæ•°æ®å¤§å°ã€‚åœ¨æˆ‘çš„æµ‹è¯•ï¼ˆç¯å¢ƒ iPhone 6 64Gï¼‰ï¼Œ å½“æ•°æ®è¾ƒå¤§ï¼ˆè¶…è¿‡ 20KBï¼‰æ—¶ä»å¤–éƒ¨æ–‡ä»¶è¯»å–æ•°æ®æ¯” sqlite æ›´å¿«ã€‚ */typedef NS_ENUM(NSUInteger, YYKVStorageType) &#123; YYKVStorageTypeFile = 0, // value ä»¥æ–‡ä»¶çš„å½¢å¼å­˜å‚¨äºæ–‡ä»¶ç³»ç»Ÿ YYKVStorageTypeSQLite = 1, // value ä»¥äºŒè¿›åˆ¶å½¢å¼å­˜å‚¨äº sqlite YYKVStorageTypeMixed = 2, // value å°†æ ¹æ®ä½ çš„é€‰æ‹©åŸºäºä¸Šé¢ä¸¤ç§å½¢å¼æ··åˆå­˜å‚¨&#125;; åœ¨ YYKVStorageType çš„æ³¨é‡Šä¸­æ ‡è®°äº†ä½œè€…å†™ YYCache æ—¶åšå‡ºçš„æµ‹è¯•ç»“è®ºï¼Œå¤§å®¶ä¹Ÿå¯ä»¥åŸºäºè‡ªå·±çš„ç¯å¢ƒå»æµ‹è¯•éªŒè¯ä½œè€…çš„è¯´æ³•ï¼ˆè¿™ä¸€ç‚¹æ˜¯å¯ä»¥è®¨è®ºçš„ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„æµ‹è¯•æ¥è®¾ç½® YYDiskCache ä¸­çš„ inlineThreshold é˜ˆå€¼ï¼‰ã€‚ å¦‚æœæƒ³è¦äº†è§£æ›´å¤šçš„ä¿¡æ¯å¯ä»¥ç‚¹å‡» Internal Versus External BLOBs in SQLite æŸ¥é˜… SQLite å®˜æ–¹æ–‡æ¡£ã€‚ YYKVStorage æ€§èƒ½ä¼˜åŒ–ç»†èŠ‚ä¸Šæ–‡è¯´åˆ° YYKVStorage å¯ä»¥åŸºäº SQLite å’Œæ–‡ä»¶ç³»ç»Ÿåšç£ç›˜å­˜å‚¨ï¼Œè¿™é‡Œå†æä¸€äº›æˆ‘é˜…è¯»æºç å‘ç°åˆ°çš„æœ‰è¶£ç»†èŠ‚ï¼š 12345@implementation YYKVStorage &#123; ... CFMutableDictionaryRef _dbStmtCache; // ç„¦ç‚¹é›†ä¸­åœ¨è¿™é‡Œ ...&#125; å¯ä»¥çœ‹åˆ° CFMutableDictionaryRef _dbStmtCache; æ˜¯ YYKVStorage ä¸­çš„ç§æœ‰æˆå‘˜ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯å˜å­—å…¸å……å½“ç€ sqlite3_stmt ç¼“å­˜çš„è§’è‰²ã€‚ 12345678910111213141516171819- (sqlite3_stmt *)_dbPrepareStmt:(NSString *)sql &#123; if (![self _dbCheck] || sql.length == 0 || !_dbStmtCache) return NULL; // å…ˆå°è¯•ä» _dbStmtCache æ ¹æ®å…¥å‚ sql å–å‡ºå·²ç¼“å­˜ sqlite3_stmt sqlite3_stmt *stmt = (sqlite3_stmt *)CFDictionaryGetValue(_dbStmtCache, (__bridge const void *)(sql)); if (!stmt) &#123; // å¦‚æœæ²¡æœ‰ç¼“å­˜å†ä»æ–°ç”Ÿæˆä¸€ä¸ª sqlite3_stmt int result = sqlite3_prepare_v2(_db, sql.UTF8String, -1, &amp;stmt, NULL); // ç”Ÿæˆç»“æœå¼‚å¸¸åˆ™æ ¹æ®é”™è¯¯æ—¥å¿—å¼€å¯æ ‡è¯†æ‰“å°æ—¥å¿— if (result != SQLITE_OK) &#123; if (_errorLogsEnabled) NSLog(@&quot;%s line:%d sqlite stmt prepare error (%d): %s&quot;, __FUNCTION__, __LINE__, result, sqlite3_errmsg(_db)); return NULL; &#125; // ç”ŸæˆæˆåŠŸåˆ™æ”¾å…¥ _dbStmtCache ç¼“å­˜ CFDictionarySetValue(_dbStmtCache, (__bridge const void *)(sql), stmt); &#125; else &#123; sqlite3_reset(stmt); &#125; return stmt;&#125; è¿™æ ·å°±å¯ä»¥çœå»ä¸€äº›é‡å¤ç”Ÿæˆ sqlite3_stmt çš„å¼€é”€ã€‚ sqlite3_stmt: è¯¥å¯¹è±¡çš„å®ä¾‹è¡¨ç¤ºå·²ç»ç¼–è¯‘æˆäºŒè¿›åˆ¶å½¢å¼å¹¶å‡†å¤‡æ‰§è¡Œçš„å•ä¸ª SQL è¯­å¥ã€‚ æ›´å¤šå…³äº SQLite çš„ä¿¡æ¯è¯·ç‚¹å‡» SQLite å®˜æ–¹æ–‡æ¡£ æŸ¥é˜…ã€‚ ä¼˜ç§€çš„ç¼“å­˜åº”è¯¥å…·å¤‡å“ªäº›ç‰¹è´¨ å˜›~ æˆ‘ä»¬å›åˆ°æ–‡ç« æœ€åˆæåˆ°çš„é—®é¢˜ï¼Œä¼˜ç§€çš„ç¼“å­˜åº”è¯¥å…·å¤‡å“ªäº›ç‰¹è´¨ï¼Ÿ å¦‚æœè·Ÿç€æ–‡ç« ä¸€æ­¥æ­¥è¯»åˆ°è¿™é‡Œï¼Œç›¸ä¿¡å¾ˆå®¹æ˜“ä¸¾å‡ºä»¥ä¸‹å‡ ç‚¹ï¼š å†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜ çº¿ç¨‹å®‰å…¨ ç¼“å­˜æ§åˆ¶ ç¼“å­˜æ›¿æ¢ç­–ç•¥ ç¼“å­˜å‘½ä¸­ç‡ æ€§èƒ½ æˆ‘ä»¬ç®€å•çš„æ€»ç»“ä¸€ä¸‹ YYCache æºç ä¸­æ˜¯å¦‚ä½•ä½“ç°è¿™äº›ç‰¹è´¨çš„ã€‚ å†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜YYCache æ˜¯ç”±å†…å­˜ç¼“å­˜ YYMemoryCache ä¸ç£ç›˜ç¼“å­˜ YYDiskCache ç›¸äº’é…åˆç»„æˆçš„ï¼Œå†…å­˜ç¼“å­˜æä¾›å®¹é‡å°ä½†é«˜é€Ÿçš„å­˜å–åŠŸèƒ½ï¼Œç£ç›˜ç¼“å­˜æä¾›å¤§å®¹é‡ä½†ä½é€Ÿçš„æŒä¹…åŒ–å­˜å‚¨ã€‚è¿™æ ·çš„è®¾è®¡æ”¯æŒç”¨æˆ·åœ¨ç¼“å­˜ä¸åŒå¯¹è±¡æ—¶éƒ½èƒ½å¤Ÿæœ‰å¾ˆå¥½çš„ä½“éªŒã€‚ åœ¨ YYCache ä¸­ä½¿ç”¨æ¥å£è®¿é—®ç¼“å­˜å¯¹è±¡æ—¶ï¼Œä¼šå…ˆå»å°è¯•ä»å†…å­˜ç¼“å­˜ YYMemoryCache ä¸­è®¿é—®ï¼Œå¦‚æœè®¿é—®ä¸åˆ°ï¼ˆæ²¡æœ‰ä½¿ç”¨è¯¥ key ç¼“å­˜è¿‡å¯¹è±¡æˆ–è€…è¯¥å¯¹è±¡å·²ç»ä»å®¹é‡æœ‰é™çš„ YYMemoryCache ä¸­æ·˜æ±°æ‰ï¼‰æ‰ä¼šå»ä» YYDiskCache è®¿é—®ï¼Œå¦‚æœè®¿é—®åˆ°ï¼ˆè¡¨ç¤ºä¹‹å‰ç¡®å®ä½¿ç”¨è¯¥ key ç¼“å­˜è¿‡å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å·²ç»ä»å®¹é‡æœ‰é™çš„ YYMemoryCache ä¸­æ·˜æ±°æ‰æˆç«‹ï¼‰ä¼šå…ˆåœ¨ YYMemoryCache ä¸­æ›´æ–°ä¸€æ¬¡è¯¥ç¼“å­˜å¯¹è±¡çš„è®¿é—®ä¿¡æ¯ä¹‹åæ‰è¿”å›ç»™æ¥å£ã€‚ çº¿ç¨‹å®‰å…¨å¦‚æœè¯´ YYCache è¿™ä¸ªç±»æ˜¯ä¸€ä¸ªçº¯é€»è¾‘å±‚çš„ç¼“å­˜ç±»ï¼ˆæŒ‡ YYCache çš„æ¥å£å®ç°å…¨éƒ¨æ˜¯è°ƒç”¨å…¶ä»–ç±»å®Œæˆï¼‰ï¼Œé‚£ä¹ˆ YYMemoryCache ä¸ YYDiskCache è¿˜æ˜¯åšäº†ä¸€äº›äº‹æƒ…çš„ï¼ˆå¹¶æ²¡æœ‰ YYCache å½“ç”©æ‰‹æŒæŸœé‚£ä¹ˆè½»æ¾ï¼‰ï¼Œå…¶ä¸­æœ€æ˜¾è€Œæ˜“è§çš„å°±æ˜¯ YYMemoryCache ä¸ YYDiskCache ä¸º YYCache ä¿è¯äº†çº¿ç¨‹å®‰å…¨ã€‚ YYMemoryCache ä½¿ç”¨äº† pthread_mutex çº¿ç¨‹é”æ¥ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œè€Œ YYDiskCache åˆ™é€‰æ‹©äº†æ›´é€‚åˆå®ƒçš„ dispatch_semaphoreï¼Œä¸Šæ–‡å·²ç»ç»™å‡ºäº†ä½œè€…é€‰æ‹©è¿™äº›é”çš„åŸå› ã€‚ ç¼“å­˜æ§åˆ¶YYCache æä¾›äº†ä¸‰ç§æ§åˆ¶ç»´åº¦ï¼Œåˆ†åˆ«æ˜¯ï¼šcostã€countã€ageã€‚è¿™å·²ç»æ»¡è¶³äº†ç»å¤§å¤šæ•°å¼€å‘è€…çš„éœ€æ±‚ï¼Œæˆ‘ä»¬åœ¨è‡ªå·±è®¾è®¡ç¼“å­˜æ—¶ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„ä½¿ç”¨ç¯å¢ƒæä¾›åˆé€‚çš„æ§åˆ¶æ–¹å¼ã€‚ ç¼“å­˜æ›¿æ¢ç­–ç•¥åœ¨ä¸Šæ–‡è§£æ YYCache æºç çš„æ—¶å€™ï¼Œä»‹ç»äº†ç¼“å­˜æ›¿æ¢ç­–ç•¥çš„æ¦‚å¿µå¹¶ä¸”åˆ—ä¸¾äº†å¾ˆå¤šç»å…¸çš„ç­–ç•¥ã€‚YYCache ä½¿ç”¨äº†åŒå‘é“¾è¡¨ï¼ˆ_YYLinkedMapNode ä¸ _YYLinkedMapï¼‰å®ç°äº† LRU(least-recently-used) ç­–ç•¥ï¼Œæ—¨åœ¨æé«˜ YYCache çš„ç¼“å­˜å‘½ä¸­ç‡ã€‚ ç¼“å­˜å‘½ä¸­ç‡è¿™ä¸€æ¦‚å¿µæ˜¯åœ¨ä¸Šæ–‡è§£æ _YYLinkedMapNode ä¸ _YYLinkedMap å°èŠ‚ä»‹ç»çš„ï¼Œæˆ‘ä»¬åœ¨è‡ªå·±è®¾è®¡ç¼“å­˜æ—¶ä¸ä¸€å®šéè¦ä½¿ç”¨ LRU ç­–ç•¥ï¼Œå¯ä»¥æ ¹æ®æˆ‘ä»¬çš„å®é™…ä½¿ç”¨ç¯å¢ƒé€‰æ‹©æœ€é€‚åˆæˆ‘ä»¬è‡ªå·±çš„ç¼“å­˜æ›¿æ¢ç­–ç•¥ã€‚ æ€§èƒ½å…¶å®æ€§èƒ½è¿™ä¸ªä¸œè¥¿æ˜¯éšè€Œä¸è§çš„ï¼Œåˆæ˜¯åˆ°å¤„å¯è§çš„ï¼ˆç¬‘ï¼‰ã€‚å®ƒä»æˆ‘ä»¬æœ€å¼€å§‹è®¾è®¡ä¸€ä¸ªç¼“å­˜æ¶æ„æ—¶å°±è¢«å¸¦å…¥ï¼Œä¸€ç›´åˆ°æˆ‘ä»¬å…·ä½“çš„å®ç°ç»†èŠ‚ä¸­æ…¢æ…¢æˆå½¢ï¼Œæœ€åæˆä¸ºäº†æˆ‘ä»¬è®¾è®¡å‡ºæ¥çš„ç¼“å­˜ä¼˜ç§€ä¸å¦çš„å†³å®šæ€§å› ç´ ã€‚ ä¸Šæ–‡ä¸­å‰–æäº†å¤ªå¤š YYCache ä¸­å¯¹äºæ€§èƒ½æå‡çš„å®ç°ç»†èŠ‚ï¼š å¼‚æ­¥é‡Šæ”¾ç¼“å­˜å¯¹è±¡ é”çš„é€‰æ‹© ä½¿ç”¨ NSMapTable å•ä¾‹ç®¡ç†çš„ YYDiskCache YYKVStorage ä¸­çš„ _dbStmtCache ç”šè‡³ä½¿ç”¨ CoreFoundation æ¥æ¢å–å¾®ä¹å…¶å¾®çš„æ€§èƒ½æå‡ çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯æç„¶å¤§æ‚Ÿï¼Œæ€§èƒ½æ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿå°±æ˜¯è¿™æ ·å¯¹äºæ¯ä¸€ä¸ªç»†èŠ‚çš„æè‡´è¿½æ±‚ä¸€ç‚¹ä¸€æ»´ç§¯å°‘æˆå¤šæŠ å‡ºæ¥çš„ã€‚ æ€»ç»“ æ–‡ç« ç³»ç»Ÿçš„è§£è¯»äº† YYCache æºç ï¼Œç›¸ä¿¡å¯ä»¥è®©å„ä½è¯»è€…å¯¹ YYCache çš„æ•´ä½“æ¶æ„æœ‰ä¸€ä¸ªæ¸…æ™°çš„è®¤è¯†ã€‚ æ–‡ç« ç»“åˆä½œè€… YYCache è®¾è®¡æ€è·¯ ä¸­çš„å†…å®¹å¯¹ YYCache å…·ä½“åŠŸèƒ½ç‚¹å®ç°æºç åšäº†æ·±å…¥å‰–æï¼Œå†ç”¨æˆ‘è‡ªå·±çš„ç†è§£è¡¨è¿°å‡ºæ¥ï¼Œå¸Œæœ›å¯ä»¥å¯¹è¯»è€…ç†è§£ YYCache ä¸­å…·ä½“åŠŸèƒ½çš„å®ç°æä¾›å¸®åŠ©ã€‚ æ ¹æ®æˆ‘è‡ªå·±çš„æºç ç†è§£ï¼ŒæŠŠæˆ‘è®¤ä¸ºåšçš„ä¸é”™çš„æå‡æ€§èƒ½çš„æºç ç»†èŠ‚å•ç‹¬æ‹å‡ºæ¥åšå‡ºè¯¦ç»†åˆ†æã€‚ æ€»ç»“å½’çº³å‡ºâ€œä¸€ä¸ªä¼˜ç§€ç¼“å­˜éœ€è¦å…·å¤‡å“ªäº›ç‰¹è´¨ï¼Ÿâ€è¿™ä¸€é—®é¢˜çš„ç­”æ¡ˆï¼Œå¸Œæœ›å¤§å®¶åœ¨é¢è¯•ä¸­å¦‚æœè¢«é—®åŠâ€œå¦‚ä½•è®¾è®¡ä¸€ä¸ªç¼“å­˜â€è¿™ç±»é—®é¢˜æ—¶å¯ä»¥æ¸¸åˆƒæœ‰ä½™ã€‚é¢ï¼Œè‡³å°‘å¯ä»¥ä¸ºå¤§å®¶æä¾›ä¸€äº›å›ç­”æ€è·¯ï¼ŒæŠ›ç –å¼•ç‰ï¼ˆç¬‘ï¼‰ã€‚ æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜ https://lision.me/ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ ä¸ªäººåšå®¢ ä¸­æ›´æ–°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš @Lision è”ç³»æˆ‘~ å¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~"},{"title":"iOS ä¸ JS äº¤äº’å¼€å‘çŸ¥è¯†æ€»ç»“","comments":true,"permalink":"https://lision.me/ios_native_js/","text":"å‰è¨€Web é¡µé¢ä¸­çš„ JS ä¸ iOS Native å¦‚ä½•äº¤äº’æ˜¯æ¯ä¸ª iOS çŒ¿å¿…é¡»æŒæ¡çš„æŠ€èƒ½ã€‚è€Œè¯´åˆ° Native ä¸ JS äº¤äº’ï¼Œå°±ä¸å¾—ä¸æä¸€å˜´ Hybridã€‚ Hybrid çš„ç¿»è¯‘ç»“æœå¹¶ä¸æ˜¯å¾ˆæ–‡æ˜ï¼ˆæ“¦æ±—ï¼Œä¸çŸ¥é“ä¸ºå•¥å¾ˆå¤šç¿»è¯‘è½¯ä»¶ä¼šè¯‘ä¸ºâ€œæ‚ç§â€ï¼Œä½†æˆ‘æ›´å–œæ¬¢å°†å®ƒç¿»è¯‘ä¸ºâ€œæ··åˆã€æ··è¡€â€ï¼‰ï¼ŒHybrid Mobile App æˆ‘å¯¹å®ƒçš„ç†è§£ä¸ºé€šè¿‡ Web ç½‘ç»œæŠ€æœ¯ï¼ˆå¦‚ HTMLï¼ŒCSS å’Œ JavaScriptï¼‰ä¸ Native ç›¸ç»“åˆçš„æ··åˆç§»åŠ¨åº”ç”¨ç¨‹åºã€‚ é‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Hybrid å¯¹æ¯” Native æœ‰å“ªäº›ä¼˜åŠ£ï¼š å› ä¸º Hybrid çš„çµæ´»æ€§ï¼ˆæ›´æ”¹ Web é¡µé¢ä¸å¿…é‡æ–°å‘ç‰ˆï¼‰ä»¥åŠé€šç”¨æ€§ï¼ˆä¸€ä»½ H5 ç©éæ‰€æœ‰å¹³å°ï¼‰å†åŠ ä¸Šé—¨æ§›ä½ï¼ˆå‰ç«¯çŒ¿å¯ä»¥æ— ç—›ä¸Šæ‰‹å¼€æ’¸ï¼‰çš„ä¼˜åŠ¿ï¼Œæ‰€ä»¥åœ¨éæ ¸å¿ƒåŠŸèƒ½æ¨¡å—ä½¿ç”¨ Web é€šè¿‡ Hybrid çš„æ–¹å¼æ¥å®ç°å¯èƒ½ä»å„æ–¹é¢éƒ½ä¼šä¼˜äº Nativeã€‚è€Œ Native åˆ™å¯ä»¥åœ¨æ ¸å¿ƒåŠŸèƒ½å’Œè®¾å¤‡ç¡¬ä»¶çš„è°ƒç”¨ä¸Šä¸º JS æä¾›å¼ºæœ‰åŠ›çš„æ”¯æŒã€‚ ç´¢å¼• Hybrid çš„å‘å±•ç®€å² JavaScriptCore ç®€ä»‹ iOS Native ä¸ JS äº¤äº’çš„æ–¹æ³• WKWebView ä¸ JS äº¤äº’çš„ç‰¹æœ‰æ–¹æ³• JS é€šè¿‡ Native è°ƒç”¨ iOS è®¾å¤‡æ‘„åƒå¤´çš„ Demo æ€»ç»“ Hybrid çš„å‘å±•ç®€å²ä¸‹é¢ç®€è¿°ä¸€ä¸‹ Hybrid çš„å‘å±•å²ï¼š 1.H5 å‘å¸ƒ Html5 æ˜¯åœ¨ 2014 å¹´ 9 æœˆä»½æ­£å¼å‘å¸ƒçš„ï¼Œè¿™ä¸€æ¬¡çš„å‘å¸ƒåšäº†ä¸€ä¸ªæœ€å¤§çš„æ”¹å˜å°±æ˜¯â€œä»ä»¥å‰çš„ XML å­é›†å‡çº§æˆä¸ºä¸€ä¸ªç‹¬ç«‹é›†åˆâ€ã€‚ 2.H5 æ¸—å…¥ Mobile App å¼€å‘Native APP å¼€å‘ä¸­æœ‰ä¸€ä¸ª webview çš„ç»„ä»¶ï¼ˆAndroid ä¸­æ˜¯ webviewï¼ŒiOS æœ‰ UIWebviewå’Œ WKWebviewï¼‰ï¼Œè¿™ä¸ªç»„ä»¶å¯ä»¥åŠ è½½ Html æ–‡ä»¶ã€‚ åœ¨ H5 å¤§è¡Œå…¶é“ä¹‹å‰ï¼Œwebview åŠ è½½çš„ web é¡µé¢å¾ˆå•è°ƒï¼ˆå› ä¸ºåªèƒ½åŠ è½½ä¸€äº›é™æ€èµ„æºï¼‰ï¼Œè‡ªä» H5 ç«äº†ä¹‹åï¼Œå‰ç«¯çŒ¿ä»¬å¼€å‘çš„ H5 é¡µé¢åœ¨ webview ä¸­çš„è¡¨ç°ä¸ä¿—ä½¿å¾— H5 å¼€å‘æ…¢æ…¢æ¸—é€åˆ°äº† Mobile App å¼€å‘ä¸­æ¥ã€‚ 3.Hybrid ç°çŠ¶è™½ç„¶ç›®å‰å·²ç»å‡ºç°äº† RN å’Œ Weex è¿™äº›ä½¿ç”¨ JS å†™ Native App çš„æŠ€æœ¯ï¼Œä½†æ˜¯ Hybrid ä»ç„¶æ²¡æœ‰è¢«æ·˜æ±°ï¼Œå¸‚é¢ä¸Šå¤§å¤šæ•°åº”ç”¨éƒ½ä¸åŒç¨‹åº¦çš„å¼•å…¥äº† Web é¡µé¢ã€‚ JavaScriptCoreJavaScriptCore è¿™ä¸ªåº“æ˜¯ Apple åœ¨ iOS 7 ä¹‹ååŠ å…¥åˆ°æ ‡å‡†åº“çš„ï¼Œå®ƒå¯¹ iOS Native ä¸ JS åšäº¤äº’è°ƒç”¨äº§ç”Ÿäº†åˆ’æ—¶ä»£çš„å½±å“ã€‚ JavaScriptCore å¤§ä½“æ˜¯ç”± 4 ä¸ªç±»ä»¥åŠ 1 ä¸ªåè®®ç»„æˆçš„ï¼š JSContext æ˜¯ JS æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸º JS è¿è¡Œçš„ç¯å¢ƒã€‚ JSValue æ˜¯å¯¹ JavaScript å€¼çš„å¼•ç”¨ï¼Œä»»ä½• JS ä¸­çš„å€¼éƒ½å¯ä»¥è¢«åŒ…è£…ä¸ºä¸€ä¸ª JSValueã€‚ JSManagedValue æ˜¯å¯¹ JSValue çš„åŒ…è£…ï¼ŒåŠ å…¥äº†â€œconditional retainâ€ã€‚ JSVirtualMachine è¡¨ç¤º JavaScript æ‰§è¡Œçš„ç‹¬ç«‹ç¯å¢ƒã€‚ è¿˜æœ‰ JSExport åè®®ï¼š å®ç°å°† Objective-C ç±»åŠå…¶å®ä¾‹æ–¹æ³•ï¼Œç±»æ–¹æ³•å’Œå±æ€§å¯¼å‡ºä¸º JavaScript ä»£ç çš„åè®®ã€‚ è¿™é‡Œçš„ JSContextï¼ŒJSValueï¼ŒJSManagedValue ç›¸å¯¹æ¯”è¾ƒå¥½ç†è§£ï¼Œä¸‹é¢æˆ‘ä»¬æŠŠ JSVirtualMachine å•æ‹å‡ºæ¥è¯´æ˜ä¸€ä¸‹ï¼š JSVirtualMachine çš„ç”¨æ³•å’Œå…¶ä¸ JSContext çš„å…³ç³» å®˜æ–¹æ–‡æ¡£çš„ä»‹ç»ï¼š JSVirtualMachine å®ä¾‹è¡¨ç¤ºç”¨äº JavaScript æ‰§è¡Œçš„ç‹¬ç«‹ç¯å¢ƒã€‚ æ‚¨ä½¿ç”¨æ­¤ç±»æœ‰ä¸¤ä¸ªä¸»è¦ç›®çš„ï¼šæ”¯æŒå¹¶å‘ JavaScript æ‰§è¡Œï¼Œå¹¶ç®¡ç† JavaScript å’Œ Objective-C æˆ– Swift ä¹‹é—´æ¡¥æ¥çš„å¯¹è±¡çš„å†…å­˜ã€‚ å…³äº JSVirtualMachine çš„ä½¿ç”¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¸ç”¨æ‰‹åŠ¨å»åˆ›å»º JSVirtualMachineã€‚å› ä¸ºå½“æˆ‘ä»¬è·å– JSContext æ—¶ï¼Œè·å–åˆ°çš„ JSContext ä»å±äºä¸€ä¸ª JSVirtualMachineã€‚ æ¯ä¸ª JavaScript ä¸Šä¸‹æ–‡ï¼ˆJSContext å¯¹è±¡ï¼‰éƒ½å±äºä¸€ä¸ª JSVirtualMachineã€‚ æ¯ä¸ª JSVirtualMachine å¯ä»¥åŒ…å«å¤šä¸ªä¸Šä¸‹æ–‡ï¼Œå…è®¸åœ¨ä¸Šä¸‹æ–‡ä¹‹é—´ä¼ é€’å€¼ï¼ˆJSValue å¯¹è±¡ï¼‰ã€‚ ä½†æ˜¯ï¼Œæ¯ä¸ª JSVirtualMachine æ˜¯ä¸åŒçš„ï¼Œå³æˆ‘ä»¬ä¸èƒ½å°†ä¸€ä¸ª JSVirtualMachine ä¸­åˆ›å»ºçš„å€¼ä¼ é€’åˆ°å¦ä¸€ä¸ª JSVirtualMachine ä¸­çš„ä¸Šä¸‹æ–‡ã€‚ JavaScriptCore API æ˜¯çº¿ç¨‹å®‰å…¨çš„ â€”â€” ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä»»ä½•çº¿ç¨‹åˆ›å»º JSValue å¯¹è±¡æˆ–è¿è¡Œ JS è„šæœ¬ - ä½†æ˜¯ï¼Œå°è¯•ä½¿ç”¨ç›¸åŒ JSVirtualMachine çš„æ‰€æœ‰å…¶ä»–çº¿ç¨‹å°†è¢«é˜»å¡ã€‚ è¦åœ¨å¤šä¸ªçº¿ç¨‹ä¸ŠåŒæ—¶ï¼ˆå¹¶å‘ï¼‰è¿è¡Œ JavaScript è„šæœ¬ï¼Œè¯·ä¸ºæ¯ä¸ªçº¿ç¨‹ä½¿ç”¨å•ç‹¬çš„ JSVirtualMachine å®ä¾‹ã€‚ JSValue ä¸ JavaScript çš„è½¬æ¢è¡¨ OBJECTIVE-C JAVASCRIPT JSVALUE CONVERT JSVALUE CONSTRUCTOR nil undefined valueWithUndefinedInContext NSNull null valueWithNullInContext: NSString string toString NSNumber number, boolean toNumbertoBooltoDoubletoInt32toUInt32 valueWithBool:inContext:valueWithDouble:inContext:valueWithInt32:inContext:valueWithUInt32:inContext: NSDictionary Object object toDictionary valueWithNewObjectInContext: NSArray Array object toArray valueWithNewArrayInContext: NSDate Date object toDate NSBlock Function object id Wrapper object toObjecttoObjectOfClass: valueWithObject:inContext: Class Constructor object iOS Native ä¸ JS äº¤äº’å¯¹äº iOS Native ä¸ JS äº¤äº’æˆ‘ä»¬å…ˆä»è°ƒç”¨æ–¹å‘ä¸Šåˆ†ä¸ºä¸¤ç§æƒ…å†µæ¥çœ‹ï¼š JS è°ƒç”¨ Native Native è°ƒç”¨ JS JS è°ƒç”¨ Nativeå…¶å® JS è°ƒç”¨ iOS Native ä¹Ÿåˆ†ä¸ºä¸¤ç§å®ç°æ–¹å¼ï¼š å‡ Request æ–¹æ³• JavaScriptCore æ–¹æ³• å‡ Request æ–¹æ³•åŸç†ï¼šå…¶å®è¿™ç§æ–¹å¼å°±æ˜¯åˆ©ç”¨äº† webview çš„ä»£ç†æ–¹æ³•ï¼Œåœ¨ webview å¼€å§‹è¯·æ±‚çš„æ—¶å€™æˆªè·è¯·æ±‚ï¼Œåˆ¤æ–­è¯·æ±‚æ˜¯å¦ä¸ºçº¦å®šå¥½çš„å‡è¯·æ±‚ã€‚å¦‚æœæ˜¯å‡è¯·æ±‚åˆ™è¡¨ç¤ºæ˜¯ JS æƒ³è¦æŒ‰ç…§çº¦å®šè°ƒç”¨æˆ‘ä»¬çš„ Native æ–¹æ³•ï¼ŒæŒ‰ç…§çº¦å®šå»æ‰§è¡Œæˆ‘ä»¬çš„ Native ä»£ç å°±å¥½ã€‚ UIWebViewUIWebView ä»£ç†æœ‰ç”¨äºæˆªè·è¯·æ±‚çš„å‡½æ•°ï¼Œåœ¨é‡Œé¢åšåˆ¤æ–­å°±å¥½ï¼š 1234567- (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType &#123; NSURL *url = request.URL; // ä¸çº¦å®šå¥½çš„å‡½æ•°åä½œæ¯”è¾ƒ if ([[url scheme] isEqualToString:@&quot;your_func_name&quot;]) &#123; // just do it &#125;&#125; WKWebViewWKWebView æœ‰ä¸¤ä¸ªä»£ç†ï¼Œä¸€ä¸ªæ˜¯ WKNavigationDelegateï¼Œå¦ä¸€ä¸ªæ˜¯ WKUIDelegateã€‚WKUIDelegate æˆ‘ä»¬åœ¨ä¸‹é¢çš„ç« èŠ‚ä¼šè®²åˆ°ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦è®¾ç½®å¹¶å®ç°å®ƒçš„ WKNavigationDelegate æ–¹æ³•ï¼š 1234567891011- (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler &#123; NSURL *url = navigationAction.request.URL; // ä¸çº¦å®šå¥½çš„å‡½æ•°åä½œæ¯”è¾ƒ if ([[url scheme] isEqualToString:@&quot;your_func_name&quot;]) &#123; // just do it decisionHandler(WKNavigationActionPolicyCancel); return; &#125; decisionHandler(WKNavigationActionPolicyAllow);&#125; Note: decisionHandler æ˜¯å½“ä½ çš„åº”ç”¨ç¨‹åºå†³å®šæ˜¯å…è®¸è¿˜æ˜¯å–æ¶ˆå¯¼èˆªæ—¶ï¼Œè¦è°ƒç”¨çš„ä»£ç å—ã€‚ è¯¥ä»£ç å—ä½¿ç”¨å•ä¸ªå‚æ•°ï¼Œå®ƒå¿…é¡»æ˜¯æšä¸¾ç±»å‹ WKNavigationActionPolicy çš„å¸¸é‡ä¹‹ä¸€ã€‚å¦‚æœä¸è°ƒç”¨ decisionHandler ä¼šå¼•èµ· crashã€‚ è¿™é‡Œè¡¥å……ä¸€ä¸‹ JS ä»£ç ï¼š 123function callNative() &#123; loadURL(&quot;your_func_name://xxx&quot;);&#125; ç„¶åæ‹¿ä¸ª button æ ‡ç­¾ç”¨ä¸€ä¸‹å°±å¥½äº†ï¼š1&lt;button type=&quot;button&quot; onclick=&quot;callNative()&quot;&gt;Call Native!&lt;/button&gt; JavaScriptCore æ–¹æ³•iOS 7 æœ‰äº† JavaScriptCore ä¸“é—¨ç”¨æ¥åš Native ä¸ JS çš„äº¤äº’ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ webview å®ŒæˆåŠ è½½ä¹‹åè·å– JSContextï¼Œç„¶ååˆ©ç”¨ JSContext å°† JS ä¸­çš„å¯¹è±¡å¼•ç”¨è¿‡æ¥ç”¨ Native ä»£ç å¯¹å…¶ä½œå‡ºè§£é‡Šæˆ–å“åº”ï¼š 12345678910111213141516// é¦–å…ˆå¼•å…¥ JavaScriptCore åº“#import &lt;JavaScriptCore/JavaScriptCore.h&gt;// ç„¶åå† UIWebView çš„å®ŒæˆåŠ è½½çš„ä»£ç†æ–¹æ³•ä¸­- (void)webViewDidFinishLoad:(UIWebView *)webView &#123; // è·å– JS ä¸Šä¸‹æ–‡ jsContext = [webView valueForKeyPath:@&quot;documentView.webView.mainFrame.javaScriptContext&quot;]; // åšå¼•ç”¨ï¼Œå°† JS å†…çš„å…ƒç´ å¼•ç”¨è¿‡æ¥è§£é‡Šï¼Œæ¯”å¦‚æ–¹æ³•å¯ä»¥è§£é‡Šæˆ Blockï¼Œå¯¹è±¡ä¹Ÿå¯ä»¥æŒ‡å‘ OC çš„ Native å¯¹è±¡å“¦ jsContext[@&quot;iosDelegate&quot;] = self; jsContext[@&quot;yourFuncName&quot;] = ^(id parameter)&#123; // æ³¨æ„è¿™é‡Œçš„çº¿ç¨‹é»˜è®¤æ˜¯ web å¤„ç†çš„çº¿ç¨‹ï¼Œå¦‚æœæ¶‰åŠä¸»çº¿ç¨‹æ“ä½œéœ€è¦æ‰‹åŠ¨è½¬åˆ°ä¸»çº¿ç¨‹ dispatch_async(dispatch_get_main_queue(), ^&#123; // your code &#125;); &#125;&#125; è€Œ JS è¿™è¾¹ä»£ç æ›´ç®€å•äº†ï¼Œå¹²è„†å£°æ˜ä¸€ä¸ªä¸è§£é‡Šçš„å‡½æ•°ï¼ˆçº¦å®šå¥½åå­—çš„ï¼‰ï¼Œç”¨äºç»™ Native åšå¼•ç”¨ï¼š 12var parameter = xxx;yourFuncName(parameter); iOS Native è°ƒç”¨ JSiOS Native è°ƒç”¨ JS çš„å®ç°æ–¹æ³•ä¹Ÿè¢« JavaScriptCore åˆ’åˆ†å¼€æ¥ï¼š webview ç›´æ¥æ³¨å…¥ JS å¹¶æ‰§è¡Œ JavaScriptCore æ–¹æ³• webview ç›´æ¥æ³¨å…¥ JS å¹¶æ‰§è¡Œåœ¨ iOS å¹³å°ï¼Œwebview æœ‰æ³¨å…¥å¹¶æ‰§è¡Œ JS çš„ APIã€‚ UIWebViewUIWebView æœ‰ç›´æ¥æ³¨å…¥ JS çš„æ–¹æ³•ï¼š 12NSString *jsStr = [NSString stringWithFormat:@&quot;showAlert(&#x27;%@&#x27;)&quot;, @&quot;alert msg&quot;];[_webView stringByEvaluatingJavaScriptFromString:jsStr]; Note: è¿™ä¸ªæ–¹æ³•ä¼šè¿”å›è¿è¡Œ JS çš„ç»“æœï¼ˆnullable NSString *ï¼‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼å°½ç®¡æ­¤æ–¹æ³•ä¸è¢«å¼ƒç”¨ï¼Œä½†æœ€ä½³åšæ³•æ˜¯ä½¿ç”¨ WKWebView ç±»çš„ evaluateJavaScriptï¼šcompletionHandlerï¼šmethodã€‚ å®˜æ–¹æ–‡æ¡£ï¼šThe stringByEvaluatingJavaScriptFromString: method waits synchronously for JavaScript evaluation to complete. If you load web content whose JavaScript code you have not vetted, invoking this method could hang your app. Best practice is to adopt the WKWebView class and use its evaluateJavaScript:completionHandler: method instead. WKWebViewä¸åŒäº UIWebViewï¼ŒWKWebView æ³¨å…¥å¹¶æ‰§è¡Œ JS çš„æ–¹æ³•ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ã€‚å› ä¸ºè€ƒè™‘åˆ° webview åŠ è½½çš„ web content å†… JS ä»£ç ä¸ä¸€å®šç»è¿‡éªŒè¯ï¼Œå¦‚æœé˜»å¡çº¿ç¨‹å¯èƒ½ä¼šæŒ‚èµ· Appã€‚ 1234NSString *jsStr = [NSString stringWithFormat:@&quot;setLocation(&#x27;%@&#x27;)&quot;, @&quot;åŒ—äº¬å¸‚ä¸œåŸåŒºå—é”£é¼“å··çº³ç¦èƒ¡åŒxxå·&quot;];[_webview evaluateJavaScript:jsStr completionHandler:^(id _Nullable result, NSError * _Nullable error) &#123; NSLog(@&quot;%@----%@&quot;, result, error);&#125;]; Note: æ–¹æ³•ä¸ä¼šé˜»å¡çº¿ç¨‹ï¼Œè€Œä¸”å®ƒçš„å›è°ƒä»£ç å—æ€»æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œã€‚ å®˜æ–¹æ–‡æ¡£ï¼šEvaluates a JavaScript string.The method sends the result of the script evaluation (or an error) to the completion handler. The completion handler always runs on the main thread. JavaScriptCore æ–¹æ³•ä¸Šé¢ç®€å•æåˆ°è¿‡ JavaScriptCore åº“æä¾›çš„ JSValue ç±»ï¼Œè¿™é‡Œå†æä¾›ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£å¯¹ JSValue çš„ä»‹ç»ç¿»è¯‘ï¼š JSValue å®ä¾‹æ˜¯å¯¹ JavaScript å€¼çš„å¼•ç”¨ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨ JSValue ç±»æ¥è½¬æ¢ JavaScript å’Œ Objective-C æˆ– Swift ä¹‹é—´çš„åŸºæœ¬å€¼ï¼ˆå¦‚æ•°å­—å’Œå­—ç¬¦ä¸²ï¼‰ï¼Œä»¥ä¾¿åœ¨æœ¬æœºä»£ç å’Œ JavaScript ä»£ç ä¹‹é—´ä¼ é€’æ•°æ®ã€‚ ä¸è¿‡ä½ ä¹Ÿçœ‹åˆ°äº†æˆ‘è´´åœ¨ä¸Šé¢çš„ OC å’Œ JS æ•°æ®ç±»å‹è½¬æ¢è¡¨ï¼Œé‚£é‡Œé¢æ ¹æœ¬æ²¡æœ‰é™å®šä¸ºå®˜æ–¹æ–‡æ¡£æ‰€è¯´çš„åŸºæœ¬å€¼ã€‚å¦‚æœä½ ä¸ç†Ÿæ‚‰ JS çš„è¯ï¼Œæˆ‘è¿™é‡Œè§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆ JSValue ä¹Ÿå¯ä»¥æŒ‡å‘ JS ä¸­çš„å¯¹è±¡å’Œå‡½æ•°ï¼Œå› ä¸º JS è¯­è¨€ä¸åŒºåˆ†åŸºæœ¬å€¼å’Œå¯¹è±¡ä»¥åŠå‡½æ•°ï¼Œåœ¨ JS ä¸­â€œä¸‡ç‰©çš†ä¸ºå¯¹è±¡â€ã€‚ å¥½äº†ä¸‹é¢ç›´æ¥ show codeï¼š 12345678910// é¦–å…ˆå¼•å…¥ JavaScriptCore åº“#import &lt;JavaScriptCore/JavaScriptCore.h&gt;// å…ˆè·å– JS ä¸Šä¸‹æ–‡self.jsContext = [webView valueForKeyPath:@&quot;documentView.webView.mainFrame.javaScriptContext&quot;];// å¦‚æœæ¶‰åŠ UI æ“ä½œï¼Œåˆ‡å›ä¸»çº¿ç¨‹è°ƒç”¨ JS ä»£ç ä¸­çš„ YourFuncNameï¼Œé€šè¿‡æ•°ç»„@[parameter] å…¥å‚dispatch_async(dispatch_get_main_queue(), ^&#123; JSValue *jsValue = self.jsContext[@&quot;YourFuncName&quot;]; [jsValue callWithArguments:@[parameter]];&#125;); ä¸Šé¢çš„ä»£ç è°ƒç”¨äº† JS ä»£ç ä¸­ YourFuncName å‡½æ•°ï¼Œå¹¶ä¸”ç»™å‡½æ•°åŠ äº† @[parameter] ä½œä¸ºå…¥å‚ã€‚ä¸ºäº†æ–¹ä¾¿é˜…è¯»ç†è§£ï¼Œè¿™é‡Œå†è´´ä¸€ä¸‹ JS ä»£ç ï¼š 1234function YourFuncName(arguments)&#123; var result = arguments; // do what u want to do&#125; WKWebView ä¸ JS äº¤äº’çš„ç‰¹æœ‰æ–¹æ³• å…³äº WKWebView ä¸ UIWebView çš„åŒºåˆ«å°±ä¸åœ¨æœ¬æ–‡åŠ ä»¥è¯¦ç»†è¯´æ˜äº†ï¼Œæ›´å¤šä¿¡æ¯è¿˜è¯·è‡ªè¡ŒæŸ¥é˜…ã€‚è¿™é‡Œè¦è®²çš„æ˜¯ WKWebView åœ¨ä¸ JS çš„äº¤äº’æ—¶ç‰¹æœ‰çš„æ–¹æ³•ï¼š WKUIDelegate æ–¹æ³• MessageHandler æ–¹æ³• WKUIDelegate æ–¹æ³•å¯¹äº WKWebView ä¸Šæ–‡æåˆ°è¿‡ï¼Œé™¤äº† WKNavigationDelegateï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ª WKUIDelegateï¼Œè¿™ä¸ª WKUIDelegate æ˜¯åšä»€ä¹ˆç”¨çš„å‘¢ï¼Ÿ WKUIDelegate åè®®åŒ…å«ä¸€äº›å‡½æ•°ç”¨æ¥ç›‘å¬ web JS æƒ³è¦æ˜¾ç¤º alert æˆ– confirm æ—¶è§¦å‘ã€‚æˆ‘ä»¬å¦‚æœåœ¨ WKWebView ä¸­åŠ è½½ä¸€ä¸ª web å¹¶ä¸”æƒ³è¦ web JS çš„ alert æˆ– confirm æ­£å¸¸å¼¹å‡ºï¼Œå°±éœ€è¦å®ç°å¯¹åº”çš„ä»£ç†æ–¹æ³•ã€‚ Note: å¦‚æœæ²¡æœ‰å®ç°å¯¹åº”çš„ä»£ç†æ–¹æ³•ï¼Œåˆ™ webview å°†ä¼šæŒ‰ç…§é»˜è®¤æ“ä½œå»åšå‡ºè¡Œä¸ºã€‚ Alert: If you do not implement this method, the web view will behave as if the user selected the OK button. Confirm: If you do not implement this method, the web view will behave as if the user selected the Cancel button. æˆ‘ä»¬è¿™é‡Œå°±æ‹¿ alert ä¸¾ä¾‹ï¼Œç›¸ä¿¡å„ä½è¯»è€…å¯ä»¥è‡ªå·±ä¸¾ä¸€åä¸‰ã€‚ä¸‹é¢æ˜¯åœ¨ WKUIDelegate ç›‘å¬ web è¦æ˜¾ç¤º alert çš„ä»£ç†æ–¹æ³•ä¸­ç”¨ Native UIAlertController æ›¿ä»£ JS ä¸­çš„ alert æ˜¾ç¤ºçš„æ —å­ ï¼š 12345678910- (void)webView:(WKWebView *)webView runJavaScriptAlertPanelWithMessage:(NSString *)message initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(void))completionHandler &#123; // ç”¨ Native çš„ UIAlertController å¼¹çª—æ˜¾ç¤º JS å°†è¦æç¤ºçš„ä¿¡æ¯ UIAlertController *alert = [UIAlertController alertControllerWithTitle:@&quot;æé†’&quot; message:message preferredStyle:UIAlertControllerStyleAlert]; [alert addAction:[UIAlertAction actionWithTitle:@&quot;çŸ¥é“äº†&quot; style:UIAlertActionStyleCancel handler:^(UIAlertAction * _Nonnull action) &#123; // å‡½æ•°å†…å¿…é¡»è°ƒç”¨ completionHandler completionHandler(); &#125;]]; [self presentViewController:alert animated:YES completion:nil];&#125; MessageHandler æ–¹æ³•MessageHandler æ˜¯ç»§ Native æˆªè· JS å‡è¯·æ±‚åå¦ä¸€ç§ JS è°ƒç”¨ Native çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åˆ©ç”¨äº† WKWebView çš„æ–°ç‰¹æ€§å®ç°ã€‚å¯¹æ¯”æˆªè·å‡ Request çš„æ–¹æ³•æ¥è¯´ï¼ŒMessageHandler ä¼ å‚æ•°æ›´åŠ ç®€å•æ–¹ä¾¿ã€‚ MessageHandler æŒ‡ä»€ä¹ˆï¼ŸWKUserContentController ç±»æœ‰ä¸€ä¸ªæ–¹æ³•:1- (void)addScriptMessageHandler:(id &lt;WKScriptMessageHandler&gt;)scriptMessageHandler name:(NSString *)name;è¯¥æ–¹æ³•ç”¨æ¥æ·»åŠ ä¸€ä¸ªè„šæœ¬å¤„ç†å™¨ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨å†…å¯¹ JS è„šæœ¬è°ƒç”¨çš„æ–¹æ³•åšå‡ºå¤„ç†ï¼Œä»è€Œè¾¾åˆ° JS è°ƒç”¨ Native çš„ç›®çš„ã€‚ é‚£ä¹ˆ WKUserContentController ç±»å’Œ WKWebView æœ‰æ¯›å…³ç³»å‘¢ï¼Ÿ åœ¨ WKWebView çš„åˆå§‹åŒ–å‡½æ•°ä¸­æœ‰ä¸€ä¸ªå…¥å‚ configurationï¼Œå®ƒçš„ç±»å‹æ˜¯ WKWebViewConfigurationã€‚WKWebViewConfiguration ä¸­åŒ…å«ä¸€ä¸ªå±æ€§ userContentControllerï¼Œè¿™ä¸ª userContentController å°±æ˜¯ WKUserContentController ç±»å‹çš„å®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ª userContentController æ¥æ·»åŠ ä¸åŒåç§°çš„è„šæœ¬å¤„ç†å™¨ã€‚ MessageHandler çš„å‘é‚£ä¹ˆå›åˆ° - (void)addScriptMessageHandler:name: æ–¹æ³•ä¸Šé¢ï¼Œè¯¥æ–¹æ³•æ·»åŠ ä¸€ä¸ªè„šæœ¬æ¶ˆæ¯å¤„ç†å™¨ï¼ˆç¬¬ä¸€ä¸ªå…¥å‚ scriptMessageHandlerï¼‰ï¼Œå¹¶ä¸”ç»™è¿™ä¸ªå¤„ç†å™¨èµ·ä¸€ä¸ªåå­—ï¼ˆç¬¬äºŒä¸ªå…¥å‚ nameï¼‰ã€‚ä¸è¿‡è¿™ä¸ªå‡½æ•°åœ¨ä½¿ç”¨çš„æ—¶å€™æœ‰ä¸ªå‘ï¼šscriptMessageHandler å…¥å‚ä¼šè¢«å¼ºå¼•ç”¨ï¼Œé‚£ä¹ˆå¦‚æœä½ æŠŠå½“å‰ WKWebView æ‰€åœ¨çš„ UIViewController ä½œä¸ºç¬¬ä¸€ä¸ªå…¥å‚ï¼Œè¿™ä¸ª viewController è¢«ä»–è‡ªå·±æ‰€æŒæœ‰çš„ webview.configuration. userContentController æ‰€æŒæœ‰ï¼Œå°±ä¼šé€ æˆå¾ªç¯å¼•ç”¨ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡ - (void)removeScriptMessageHandlerForName: æ–¹æ³•åˆ æ‰ userContentController å¯¹ viewController çš„å¼ºå¼•ç”¨ã€‚æ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬çš„ä»£ç ä¼šåœ¨ viewWillAppear å’Œ viewWillDisappear æˆå¯¹å„¿çš„æ·»åŠ å’Œåˆ é™¤ MessageHandlerï¼š 123456789- (void)viewWillAppear:(BOOL)animated &#123; [super viewWillAppear:animated]; [self.webview.configuration.userContentController addScriptMessageHandler:self name:@&quot;YourFuncName&quot;];&#125;- (void)viewWillDisappear:(BOOL)animated &#123; [super viewWillDisappear:animated]; [self.webview.configuration.userContentController removeScriptMessageHandlerForName:@&quot;YourFuncName&quot;];&#125; WKScriptMessageHandler åè®®WKScriptMessageHandler æ˜¯è„šæœ¬ä¿¡æ¯å¤„ç†å™¨åè®®ï¼Œå¦‚æœæƒ³è®©ä¸€ä¸ªå¯¹è±¡å…·æœ‰è„šæœ¬ä¿¡æ¯å¤„ç†èƒ½åŠ›ï¼ˆæ¯”å¦‚ä¸Šæ–‡ä¸­ webview çš„æ‰€å± viewController ä¹Ÿå°±æ˜¯ä¸Šé¢ä»£ç çš„ selfï¼‰å°±å¿…é¡»ä½¿å…¶éµå¾ªè¯¥åè®®ã€‚ WKScriptMessageHandler åè®®å†…éƒ¨éå¸¸ç®€å•ï¼Œåªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å¿…é¡»è¦å®ç°è¯¥æ–¹æ³•ï¼ˆ@requiredï¼‰ï¼š 123456789// WKScriptMessageHandler åè®®æ–¹æ³•ï¼Œåœ¨æ¥æ”¶åˆ°è„šæœ¬ä¿¡æ¯æ—¶è§¦å‘- (void)userContentController:(WKUserContentController *)userContentController didReceiveScriptMessage:(WKScriptMessage *)message &#123; // message æœ‰ä¸¤ä¸ªå±æ€§ï¼šname å’Œ body // message.name å¯ä»¥ç”¨äºåŒºåˆ«è¦åšçš„å¤„ç† if ([message.name isEqualToString:@&quot;YourFuncName&quot;]) &#123; // message.body ç›¸å½“äº JS ä¼ é€’è¿‡æ¥çš„å‚æ•° NSLog(@&quot;JS call native success %@&quot;, message.body); &#125;&#125; è¡¥å…… JS çš„ä»£ç ï¼š 12// &lt;name&gt; æ¢ YourFuncNameï¼Œ&lt;messageBody&gt; æ¢ä½ è¦çš„å…¥å‚å³å¯window.webkit.messageHandlers.&lt;name&gt;.postMessage(&lt;messageBody&gt;) æå®šæ”¶å·¥ï¼ JS é€šè¿‡ Native è°ƒç”¨ iOS è®¾å¤‡æ‘„åƒå¤´çš„ Demoå¾’æ‰‹æ’¸äº†ä¸€ä¸ª Demoï¼Œå®ç°äº† JS ä¸ Native ä»£ç çš„äº¤äº’ï¼Œè¾¾åˆ°ç”¨ JS åœ¨ webview å†…è°ƒç”¨ iOS è®¾å¤‡æ‘„åƒå¤´çš„åŠŸèƒ½ã€‚Demo å†…å«æƒé™ç”³è¯·ï¼Œç”¨æˆ·æ‹’ç»æˆæƒç­‰ç»†èŠ‚ï¼ˆæŠ€æœ¯ä¸Šå°±æ˜¯ JS å’Œ Native ç›¸äº’ä¼ å€¼è°ƒç”¨ï¼‰ï¼Œè¿˜è¯·å„ä½å¤§ä½¬æŒ‡æ•™ã€‚ å‘å„ä½åŸºä½¬ä½å¤´ï¼ŒçŒ®ä¸Šæˆ‘çš„è†ç›–~ï¼ˆDemo åœ°å€ï¼‰ æ€»ç»“ è¿™ç¯‡æ–‡ç« ç®€å•çš„ä»‹ç»äº†ä¸€ä¸‹ Hybrid Mobile Appï¼ˆå…¶ä¸­è¿˜åŒ…æ‹¬ Hybrid çš„å‘å±•ç®€å²ï¼‰ã€‚ ä»‹ç»äº† JavaScriptCore çš„ç»„æˆï¼Œå¹¶ä¸”æŠŠ JSVirtualMachine ä¸ JSContext å’Œ JSValue ä¹‹é—´çš„å…³ç³»ç”¨å›¾ç‰‡çš„å½¢å¼è¡¨è¿°å‡ºæ¥ï¼ˆJSVirtualMachine åŒ…å« JSContext åŒ…å« JSValueï¼Œéƒ½æ˜¯ 1 å¯¹ n çš„å…³ç³»ï¼Œä¸”ç”±äºåŒä¸€ä¸ª JSVirtualMachine ä¸‹çš„ä»£ç ä¼šç›¸äº’é˜»å¡ï¼Œæ‰€ä»¥å¦‚æœæƒ³å¼‚æ­¥æ‰§è¡Œäº¤äº’éœ€è¦åœ¨ä¸åŒçš„çº¿ç¨‹å£°æ˜ JSVirtualMachine å¹¶å‘æ‰§è¡Œï¼‰ã€‚ ä»è°ƒç”¨æ–¹å‘çš„è§’åº¦æŠŠ JS ä¸ iOS Native ç›¸äº’è°ƒç”¨çš„æ–¹å¼æ–¹æ³•åˆ†åˆ«ç”¨ä»£ç ç¤ºä¾‹è®²è§£äº†ä¸€éã€‚ ä»‹ç»äº† WKWebView ä¸ JS äº¤äº’ç‰¹æœ‰çš„æ–¹æ³•ï¼šWKUIDelegate å’Œ MessageHandlerã€‚ æä¾›äº†ä¸€ä¸ª JS é€šè¿‡ Native è°ƒç”¨ iOS è®¾å¤‡æ‘„åƒå¤´çš„ Demoã€‚ æ–‡ç« å†™å¾—æ¯”è¾ƒç”¨å¿ƒï¼ˆæ˜¯æˆ‘ä¸ªäººçš„åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·æ³¨æ˜ https://lision.me/ï¼‰ï¼Œå¦‚æœå‘ç°é”™è¯¯ä¼šä¼˜å…ˆåœ¨æˆ‘çš„ ä¸ªäººåšå®¢ ä¸­æ›´æ–°ã€‚å¦‚æœæœ‰ä»»ä½•é—®é¢˜æ¬¢è¿åœ¨æˆ‘çš„å¾®åš @Lision è”ç³»æˆ‘~ å¸Œæœ›æˆ‘çš„æ–‡ç« å¯ä»¥ä¸ºä½ å¸¦æ¥ä»·å€¼~"}]}